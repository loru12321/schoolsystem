<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School System</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- 0. Init Scripts -->
    <script src="js/supabase-init.js"></script>

    <!-- 1. CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin="anonymous" onload="window.initSupabase()"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js" crossorigin="anonymous"></script>
    <!-- Use jsdelivr for idb-keyval to avoid unpkg 404/CORS issues -->
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/iife/index-min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer crossorigin="anonymous"></script>
    
    <!-- 2. App Scripts (Deferred) -->
    <script defer src='js/app-core-part1.js'></script>
    <script defer src='js/app-state-vars.js'></script>
    <script defer src='js/app-utils.js'></script>
    <script defer src='js/project-snapshot.js'></script>
    <script defer src='js/account-admin.js'></script>
    <script defer src='js/admin-runtime.js'></script>
    <script defer src='js/ai-chat.js'></script>
    <script defer src='js/ai-class-report.js'></script>
    <script defer src='js/ai-report-tools.js'></script>
    <script defer src='js/analysis-extensions.js'></script>
    <script defer src='js/analysis-tools.js'></script>
    <script defer src='js/app-runtime-core.js'></script>
    <script defer src='js/auth-issues.js'></script>
    <script defer src='js/batch-ai-comments.js'></script>
    <script defer src='js/cloud-manager.js'></script>
    <script defer src='js/cohort-archive.js'></script>
    <script defer src='js/correlation-analysis.js'></script>
    <script defer src='js/data-manager.js'></script>
    <script defer src='js/data-processing.js'></script>
    <script defer src='js/drill-system.js'></script>
    <script defer src='js/exam-scheduler.js'></script>
    <script defer src='js/excel-utils.js'></script>
    <script defer src='js/fb-division.js'></script>
    <script defer src='js/fb-seat-map.js'></script>
    <script defer src='js/grade-scheduler.js'></script>
    <script defer src='js/high-score.js'></script>
    <script defer src='js/inquiry-package.js'></script>
    <script defer src='js/marginal-push.js'></script>
    <script defer src='js/mutual-aid.js'></script>
    <script defer src='js/navigation.js'></script>
    <script defer src='js/packager-help.js'></script>
    <script defer src='js/poster-tools.js'></script>
    <script defer src='js/privacy-guest-mode.js'></script>
    <script defer src='js/progress-analysis.js'></script>
    <script defer src='js/report-card.js'></script>
    <script defer src='js/report-exports.js'></script>
    <script defer src='js/role-status.js'></script>
    <script defer src='js/school-profile.js'></script>
    <script defer src='js/seat-adjust.js'></script>
    <script defer src='js/seat-print-tools.js'></script>
    <script defer src='js/select-updates.js'></script>
    <script defer src='js/skin-voice.js'></script>
    <script defer src='js/spotlight-help.js'></script>
    <script defer src='js/sse-tools.js'></script>
    <script defer src='js/student-details.js'></script>
    <script defer src='js/table-render.js'></script>
    <script defer src='js/table-visuals.js'></script>
    <script defer src='js/teacher-analysis.js'></script>
    <script defer src='js/worker-source.js'></script>

    <!-- 3. Alpine.js (Last to ensure stores are registered) -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer crossorigin="anonymous"></script>
</head>
<body>


    <!-- 全局加载遮罩 -->
    <div id="global-loader" class="hidden">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">系统正在处理数据，请稍候...</div>
    </div>

    <!-- ✋ 🔴 [已移除]：删除了 mobile-lite-interface 整个容器，手机访问将直接显示下方的主界面 🔴 -->

    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:50000; display:flex; align-items:center; justify-content:center; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;">
        <div style="background:white; padding:40px; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width:100%; max-width:420px; border:1px solid #e5e7eb;">
            <div style="text-align:center; margin-bottom:30px;">
                <h1 style="color:var(--primary); font-size:24px; font-weight:800; margin-bottom:5px;">智慧教务管理系统</h1>
                <p style="color:#64748b; font-size:14px;">统一身份认证入口</p>
            </div>

            <!-- 登录表单 -->
            <div id="login-form">
                
                <!-- 1. 用户名输入框 -->
                <div class="form-group">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">
                        账号 / 姓名
                    </label>
                    <input type="text" id="login-user" placeholder="管理员账号 / 教师姓名 / 学生姓名" 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <!-- 2. 班级输入框 (改为始终显示，但在 JS 里判断逻辑) -->
                <div class="form-group" style="margin-top:15px;">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">
                        班级 <span style="color:#f59e0b; font-weight:normal; font-size:11px;">(教职工留空，家长必填如:701)</span>
                    </label>
                    <input type="text" id="login-class" placeholder="请输入班级 (仅家长/学生必填)" 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <!-- 3. 密码输入框 -->
                <div class="form-group" style="margin-top:15px;">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">密码</label>
                    <input type="password" id="login-pass" placeholder="输入密码" 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <button onclick="Auth.login()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:6px; font-size:16px; font-weight:bold; margin-top:25px; cursor:pointer; transition:0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    立即登录
                </button>
                
                <!-- 已添加 display:none 隐藏默认提示 -->
                <div style="display:none; text-align:center; margin-top:15px; font-size:12px; color:#94a3b8; line-height: 1.6;">
                    管理员默认: admin / admin123<br>
                    其他角色默认密码: 123456
                </div>
            </div>
        </div>

        <!-- 纵向成长档案 (Cohort Growth) -->
        <div id="cohort-growth" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-timeline"></i> 纵向成长档案 <span class="badge" style="background:#0ea5e9;">📈 班主任必看</span></h3>
                <p><strong>一句话目的：</strong>基于届别ID构建学生成长曲线与稳定性画像。</p>
                <p><strong>推荐顺序：</strong>完成多次考试导入后使用。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-timeline"></i> 成长轨迹与稳定性分析</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-purple" onclick="CohortGrowth.render()">🔎 生成成长档案</button>
                    <button class="btn btn-gray" onclick="CohortGrowth.exportVolatility()">📥 导出波动名单</button>
                </div>
            </div>
            <div class="info-bar">
                <span>基于届别历史考试，计算 $Z$ 分数波动率、排名百分位变化。</span>
                <span style="margin-left:auto; font-size:12px;">建议至少 4 次考试数据</span>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="card-box" style="border-left:4px solid #38bdf8; background:#f0f9ff;">
                    <div class="sub-header">🌊 Z-Score 波动率 (稳定性)</div>
                    <div class="table-wrap">
                        <table id="cohort-volatility-table">
                            <thead><tr><th>姓名</th><th>班级</th><th>考试次数</th><th>波动率(σ)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-box" style="border-left:4px solid #22c55e; background:#f0fdf4;">
                    <div class="sub-header">🚀 排名百分位成长 (首尾对比)</div>
                    <div class="table-wrap">
                        <table id="cohort-growth-table">
                            <thead><tr><th>姓名</th><th>班级</th><th>起始百分位</th><th>最新百分位</th><th>变化</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示容器 -->
    <div id="toast-container" class="toast-container"></div>

    <!-- 届别入口弹窗 -->
    <div id="mode-mask">
        <div class="mode-box">
            <h2 style="color:var(--primary); margin-bottom:15px; font-size:24px;">📂 进入届别档案</h2>
            <p style="color:#64748b;">以“入学年份”为主线建立完整成长周期，系统将自动匹配年级与核算模式</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                <input id="entry-cohort-year" type="number" min="2000" max="2100" placeholder="入学年份 (如 2022)" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; width:200px;">
                <button class="btn btn-primary" onclick="enterCohortFromMask()">进入届别</button>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#64748b;">已有届别可在顶部下拉直接切换</div>
        </div>
    </div>

    <!-- 手机端管理主界面 (默认隐藏，通过 JS 激活) -->
    <div id="mobile-manager-app">
        <!-- 1. 顶部标题栏 -->
        <div class="mob-header-bar">
            <div class="mob-header-title" id="mob-page-title">📱 教务工作台</div>
            <div onclick="Auth.logout()" style="color:#ef4444; font-size:12px; font-weight:bold; cursor: pointer;">退出</div>
        </div>

        <!-- 2. 内容区域 (通过 JS 切换显示) -->
        
        <!-- A. 首页/概览 -->
        <div id="mob-view-home" class="mob-view active">
            <div style="background: linear-gradient(135deg, #4f46e5, #818cf8); border-radius: 12px; padding: 20px; color: white; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 12px; opacity: 0.8;">当前登录</div>
                <div style="font-size: 24px; font-weight: bold; margin: 5px 0;" id="mob-user-name">老师</div>
                <div style="font-size: 12px; background: rgba(255,255,255,0.2); display: inline-block; padding: 2px 10px; border-radius: 20px;" id="mob-user-role">科任教师</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div class="mob-list-item" style="flex-direction: column; align-items: center; text-align: center; padding: 15px;" onclick="MobMgr.switchTab('students')">
                    <div class="mob-avatar" style="background: #dbeafe; color: #2563eb;"><i class="ti ti-users"></i></div>
                    <div style="font-weight: bold; margin-top: 5px;">学生管理</div>
                </div>
                <div class="mob-list-item" style="flex-direction: column; align-items: center; text-align: center; padding: 15px;" onclick="MobMgr.switchTab('analysis')">
                    <div class="mob-avatar" style="background: #fef3c7; color: #d97706;"><i class="ti ti-chart-bar"></i></div>
                    <div style="font-weight: bold; margin-top: 5px;">成绩分析</div>
                </div>
            </div>
            
            <div style="background: white; border-radius: 12px; padding: 15px;">
                <h4 style="margin-bottom: 10px; color: #334155;">📢 系统公告</h4>
                <div style="font-size: 12px; color: #64748b; line-height: 1.6;">
                    欢迎使用移动端管理系统。目前支持查看学生名单、快速查询成绩以及基础的数据分析功能。更多高级功能请登录 PC 端操作。
                </div>
            </div>
        </div>

        <!-- B. 学生列表 -->
        <div id="mob-view-students" class="mob-view">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="mob-search-input" placeholder="🔍 搜姓名/考号..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" oninput="MobMgr.renderStudentList()">
            </div>
            <div id="mob-student-list" class="mob-list-container" style="padding: 0;">
                <!-- 动态生成列表 -->
                <div style="text-align: center; color: #999; padding: 20px;">加载中...</div>
            </div>
        </div>

        <!-- C. 简报分析 -->
        <div id="mob-view-analysis" class="mob-view">
            <div class="mob-list-item" style="display: block; padding: 15px;">
                <h3 style="margin-bottom: 15px; border-left: 4px solid #4f46e5; padding-left: 8px; font-size: 16px;">📊 快速概览</h3>
                <div id="mob-analysis-content">
                    <p style="color: #999; text-align: center;">请先在 PC 端上传并处理数据...</p>
                </div>
            </div>
        </div>

        <!-- 3. 底部导航栏 -->
        <div class="mob-bottom-bar">
            <button class="mob-nav-btn active" onclick="MobMgr.switchTab('home')">
                <i class="ti ti-home"></i>
                <span>首页</span>
            </button>
            <button class="mob-nav-btn" onclick="MobMgr.switchTab('students')">
                <i class="ti ti-users"></i>
                <span>学生</span>
            </button>
            <button class="mob-nav-btn" onclick="MobMgr.switchTab('analysis')">
                <i class="ti ti-chart-pie"></i>
                <span>分析</span>
            </button>
        </div>
    </div>


    <!-- 主应用界面 -->
    <div id="watermark-layer" aria-hidden="true"></div>
    <div class="container hidden" id="app">
        <header id="main-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Logo 容器 (默认隐藏，上传后显示) -->
                <img id="custom-logo-img" src="" loading="lazy" decoding="async" style="display:none; height: 60px; width: auto; border-radius: 6px; background: rgba(255,255,255,0.95); padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" alt="校徽">
                
                <!-- 标题文字区域 -->
                <div style="flex: 1;">
                    <h1 id="app-title" style="margin:0; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">乡镇学校成绩分析与教务管理系统 <span id="mode-badge" class="badge"></span></h1>
                    <p id="app-subtitle" style="margin:5px 0 0 0; opacity: 0.9; font-size: 13px;">集成：乡镇学校横向对比 · 教师教学深度分析 · 偏科挖掘 · 考务编排</p>
                </div>

                <!-- 右上角工具栏 -->
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="cohort-selector" onchange="CohortManager.switchTo(this.value)" 
                            style="background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); padding:5px; border-radius:4px; font-size:14px; font-weight:bold; cursor:pointer; outline:none;">
                        <option value="" style="color:#333">📂 请选择届别</option>
                    </select>
                    <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white;" onclick="scrollToAnchor('upload', this)" title="前往届别管理">
                        <i class="ti ti-users-group"></i> 届别
                    </button>
                    <div id="admin-msg-btn" class="notification-btn" style="display:none;" onclick="IssueManager.openAdminPanel()">
                        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white;" title="查看申诉反馈">
                            <i class="ti ti-bell"></i>
                        </button>
                        <div id="msg-badge" class="notification-badge hidden">0</div>
                    </div>
                    <!-- 注意：此按钮默认通过 CSS #admin-panel-btn {display:none} 隐藏，只有 body[data-role="admin"] 时才显示 -->
                    <button class="btn" id="admin-panel-btn" onclick="document.getElementById('admin-modal').style.display='flex'" 
                            style="background:#b91c1c; color:white; border:1px solid rgba(255,255,255,0.4); display:none;">
                        <i class="ti ti-settings"></i> 账号管理
                    </button>
                    <button class="btn" id="btn-cloud-rollback" onclick="openCloudRollback()" title="管理员专用：打开云端快照回滚" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; display:none;">
                        <i class="ti ti-rotate"></i> 云端回滚
                    </button>
                    <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); backdrop-filter:blur(5px); color:white;" onclick="HelpSystem.startTour()" title="新手引导">
                        <i class="ti ti-help-circle"></i> 教程
                    </button>
                    <!-- [新增] 外观设置按钮 -->
                    <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); backdrop-filter:blur(5px); color:white;" onclick="openSkinModal()" title="自定义外观">
                        <i class="ti ti-palette"></i> 外观设置
                    </button>
                    
                    <!-- 深色模式切换按钮 -->
                    <button class="btn" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.2); padding: 6px 10px;" onclick="toggleDarkMode()" title="切换深色模式">
                        <i class="ti ti-moon"></i>
                    </button>
                    <!-- 全局搜索提示按钮 -->
                    <div style="color:rgba(255,255,255,0.9); font-size:12px; border:1px solid rgba(255,255,255,0.3); padding:6px 12px; border-radius:6px; cursor:pointer; background: rgba(0,0,0,0.1);" onclick="openSpotlight()">
                        <i class="ti ti-search"></i> 搜索
                    </div>
                                        
                    <button class="btn" id="btn-guest-mode" onclick="toggleGuestMode()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; font-size:12px; padding:5px 10px; margin-left:5px;" title="不保存任何数据，关闭即消失">
                        <i class="ti ti-flame"></i> 阅后即焚
                    </button>
                </div>
            </div>
        </header>

        <!-- 双层顶部导航菜单 -->
        <div class="nav-wrapper">
            <div class="nav-categories" id="navCategories"></div>
            <div class="nav-sub-items" id="navSubItems"></div>
        </div>

        <!-- 1. 数据上传 & 项目管理 -->
        <div id="upload" class="section active card-box">
            <div class="module-desc-bar" style="border-color: var(--color-data)">
                <h3><i class="ti ti-database-import"></i> 01 数据枢纽中心 <span class="badge" style="background:#16a34a;">⭐ 教务常用</span></h3>
                <p><strong>一句话目的：</strong>导入并规范化成绩数据，建立分析基础。</p>
                <p><strong>推荐顺序：</strong>第1步（导入数据）→ 第2步（生成分析）→ 第3步（导出结果）。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-file-upload"></i> 数据文件上传 
                    <span class="module-help-btn" onclick="showModuleHelp('upload')">📘 使用说明</span>
                </h2>
                <div style="margin-left: auto;">
                    <button class="btn btn-orange" onclick="runDataDoctor()">
                        <i class="ti ti-stethoscope"></i> 数据体检
                    </button>
                </div>
            </div>
            <div class="info-bar"><span>当前模式：<strong id="mode-info"></strong>。系统将自动过滤无关数据。</span></div>
            <div class="card-box" style="border-left:4px solid #7c3aed; background:#f5f3ff; margin-top:10px;">
                <div class="sec-head" style="border-bottom-color:#ddd6fe; margin-bottom:10px;">
                    <h2 style="color:#5b21b6;"><i class="ti ti-users-group"></i> 届别管理 (Cohort)</h2>
                    <div style="font-size:12px; color:#6b7280;">以“入学年份”为主轴，贯穿三年成长档案</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <input id="cohort-year" type="number" min="2000" max="2100" placeholder="入学年份 (如 2022)" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; width:180px;">
                    <button class="btn btn-purple" onclick="CohortManager.addFromUI()">➕ 新建届别</button>
                    <button class="btn btn-gray" onclick="resetCohortSelection()">↩ 重新选择届别</button>
                    <span id="cohort-status" style="font-size:12px; color:#64748b;"></span>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569;">
                    当前届别：<strong id="cohort-current-label">未选择</strong>
                </div>
            </div>
            <div class="card-box" style="border-left:4px solid #0ea5e9; background:#f0f9ff; margin-top:10px;">
                <div class="sec-head" style="border-bottom-color:#bae6fd; margin-bottom:10px;">
                    <h2 style="color:#0369a1;"><i class="ti ti-archive"></i> 考试批次 / 学期档案化</h2>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span id="exam-archive-status" style="font-size:12px; color:#64748b;">未封存</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <span style="font-size:12px; color:#475569;">届别：</span>
                    <span id="exam-cohort-label" style="font-size:12px; font-weight:bold; color:#1e3a8a;">未选择</span>
                    <select id="exam-year" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="2025-2026">2025-2026</option>
                        <option value="2026-2027">2026-2027</option>
                        <option value="2027-2028">2027-2028</option>
                    </select>
                    <select id="exam-term" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="上学期">上学期</option>
                        <option value="下学期">下学期</option>
                    </select>
                    <select id="exam-type" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="月考">月考</option>
                        <option value="期中">期中</option>
                        <option value="期末">期末</option>
                        <option value="模拟">模拟</option>
                    </select>
                    <input id="exam-date" type="date" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="exam-name" type="text" placeholder="考试名称(可选)" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; width:200px;">
                    <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#475569;">
                        <input type="checkbox" id="exam-reset-point"> 本次考试经历重新分班
                    </label>
                    <span style="font-size:12px; color:#475569;">本次年级：</span>
                    <strong id="exam-grade-label" style="font-size:12px; color:#1e3a8a;">-</strong>
                    <button class="btn btn-primary" onclick="setCurrentExamMeta()">设为当前考试</button>
                    <button class="btn btn-orange" onclick="archiveCurrentExam()">一键封存本次考试</button>
                    <button class="btn btn-gray" onclick="unlockArchive()">解除封存</button>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569;">
                    当前考试ID：<strong id="exam-key-display">未设置</strong>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    历史考试：
                    <select id="exam-history-select" style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;"></select>
                    <button class="btn btn-sm btn-gray" onclick="CohortDB.loadExamFromSelect()">切换到该考试</button>
                </div>
            </div>
            <div style="background: #f0fdf4; border: 1px dashed #86efac; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="font-weight: bold; color: #166534; display: flex; align-items: center; gap: 5px;">
                    <i class="ti ti-template"></i> 新手必读：标准模板下载
                </div>
                <div style="flex: 1; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-sm" style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;" onclick="downloadTemplate('primary')">
                        <i class="ti ti-download"></i> 小学期末模板
                    </button>
                    <button class="btn btn-sm" style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;" onclick="downloadTemplate('junior')">
                        <i class="ti ti-download"></i> 初中月考模板 (7-8年级)
                    </button>
                    <button class="btn btn-sm" style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;" onclick="downloadTemplate('grade9')">
                        <i class="ti ti-download"></i> 中考一模模板 (9年级)
                    </button>
                    <button class="btn btn-sm" style="background: white; color: #0369a1; border: 1px solid #0369a1; font-size: 12px;" onclick="downloadTemplate('teacher')">
                        <i class="ti ti-id"></i> 教师任课导入模板
                    </button>
                </div>
            </div>
            <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon"><i class="ti ti-cloud-upload"></i></div>
                <p style="font-size:18px; margin-bottom:10px; font-weight:600;">点击上传成绩 Excel 文件</p>
                <p style="color:#94a3b8;">支持多文件上传 (.xlsx, .xls)</p>
                <input type="file" id="fileInput" multiple accept=".xlsx,.xls" hidden>
            </div>
            
            <!-- [新增] 届别快照管理区域 -->
            <div class="control-panel" style="background: #eff6ff; border-color: #bfdbfe; margin-top: 15px;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 5px 0; color: var(--primary); font-size: 15px;">
                        💾 届别状态管理 <span id="auto-backup-status" style="font-size:11px; color:#64748b; font-weight:normal; margin-left:10px;"></span>
                    </h3>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">保存当前届别所有进度（含成绩、教师设置、排座、分班结果），下次可直接恢复。</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="btn-save-project" onclick="saveProjectSnapshot()">
                        <i class="ti ti-download"></i> 保存项目 (.json)
                    </button>
                    <button class="btn btn-orange" id="btn-load-project" onclick="document.getElementById('projectFileInput').click()">
                        <i class="ti ti-upload"></i> 恢复项目
                    </button>
                    <input type="file" id="projectFileInput" accept=".json" hidden onchange="loadProjectSnapshot(this)">
                    <button class="btn btn-danger" id="btn-reset-system" onclick="resetSystem()" style="background: #dc2626; color: white;">
                        <i class="ti ti-trash"></i> 清空重置
                    </button>
                </div>
            </div>

            <div class="control-panel" id="auto-snapshot-panel" style="background:#fff7ed; border-color:#fed7aa; margin-top:10px;">
                <div style="flex:1;">
                    <h3 style="margin:0 0 5px 0; color:#b45309; font-size:15px;">
                        🕘 自动快照 / 回滚
                    </h3>
                    <p style="font-size:12px; color:#64748b; margin:0;">每次保存前自动保留最近 5 版，可一键回滚。</p>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn btn-sm btn-orange" onclick="createAutoSnapshot(getCurrentSnapshotPayload())">手动生成快照</button>
                </div>
                <div id="auto-snapshot-list" style="width:100%; margin-top:8px; font-size:12px; color:#7c2d12;"></div>
            </div>

            <div class="card-box" style="border-left: 4px solid #2563eb; background: #eff6ff; margin-top: 15px;">
                <div class="sec-head" style="border-bottom-color: #bfdbfe; margin-bottom: 10px;">
                    <h2 style="color: #1e3a8a;"><i class="ti ti-id"></i> 教师任课信息配置</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-sm" style="background:white; color:#2563eb; border:1px solid #2563eb;" onclick="downloadTemplate('teacher')">
                            <i class="ti ti-download"></i> 下载模板
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('teacherFileInput').click()">
                            <i class="ti ti-file-import"></i> 导入任课表
                        </button>
                        <input type="file" id="teacherFileInput" accept=".xlsx,.xls" hidden onchange="importTeacherExcel()">
                    </div>
                </div>
                
                <div style="margin-bottom:10px; font-size:12px; color:#64748b;">
                    <i class="ti ti-info-circle"></i> 说明：请先在上方<strong>“选择本校”</strong>，系统会自动列出本校所有班级和科目。您可以手动输入教师姓名，或使用Excel导入。
                </div>
                
                <div id="teacherInputsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 20px;">
                        (请先在顶部工具栏选择“本校”以加载班级)
                    </div>
                </div>
            </div>

                    
            <div class="card-box" style="border-left: 4px solid #10b981; background: #ecfdf5; margin-top: 20px;">
                <div class="sec-head" style="border-bottom-color: #a7f3d0; margin-bottom: 10px;">
                    <h2 style="color: #047857;"><i class="ti ti-robot"></i> AI 智能助手配置 (LLM)</h2>
                </div>
                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #a7f3d0;">
                    <label style="font-weight:bold; color:#065f46; margin-right:15px;">🤖 选择 AI 引擎：</label>
                    <label style="margin-right:15px; cursor:pointer;">
                        <input type="radio" name="ai_source" value="cloud" checked onchange="toggleAISource()"> ☁️ 云端 API (DeepSeek/OpenAI)
                    </label>
                    <label style="cursor:pointer;">
                        <input type="radio" name="ai_source" value="local" onchange="toggleAISource()"> 💻 本地模型 (WebLLM/免费/需显卡)
                    </label>
                </div>

                <!-- 云端配置区 -->
                <div id="ai-config-cloud" style="display:flex; gap:15px; flex-wrap:wrap; align-items:flex-end;">
                    <div style="flex:1; min-width:200px;">
                        <label style="font-size:12px; font-weight:bold; color:#065f46;">API Key (密钥):</label>
                        <input type="password" id="llm_apikey" placeholder="sk-..." value="" style="width:100%; border-color:#34d399;">
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label style="font-size:12px; font-weight:bold; color:#065f46;">Base URL:</label>
                        <input type="text" id="llm_baseurl" placeholder="https://api.deepseek.com" value="https://api.deepseek.com" style="width:100%; border-color:#34d399;">
                    </div>
                    <div style="flex:0.5; min-width:150px;">
                        <label style="font-size:12px; font-weight:bold; color:#065f46;">Model Name:</label>
                        <input type="text" id="llm_model" placeholder="deepseek-chat" value="deepseek-chat" style="width:100%; border-color:#34d399;">
                    </div>
                    <button class="btn" style="background:#059669; color:white; height:38px;" onclick="saveLLMConfig()">
                        <i class="ti ti-device-floppy"></i> 保存配置
                    </button>
                </div>

                <!-- 本地配置区 (默认隐藏) -->
                <div id="ai-config-local" class="hidden" style="background:rgba(255,255,255,0.5); padding:10px; border-radius:6px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <select id="local_model_select" style="flex:1; border-color:#34d399;">
                            <option value="Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen2.5-1.5B (轻量/推荐)</option>
                            <option value="Llama-3-8B-Instruct-q4f32_1-MLC">Llama-3-8B (强大/需8G显存)</option>
                        </select>
                        <button class="btn btn-orange" onclick="initLocalModel()">⬇️ 下载并加载模型</button>
                    </div>
                    <div id="local-ai-status" style="font-size:12px; color:#047857;">状态：未加载 (初次使用需下载约 1GB 数据，请保持网络通畅)</div>
                    <div style="width:100%; height:6px; background:#e5e7eb; border-radius:3px; margin-top:5px; overflow:hidden;">
                        <div id="local-ai-progress" style="width:0%; height:100%; background:#10b981; transition:width 0.2s;"></div>
                    </div>
                </div>
                <div style="font-size:11px; color:#064e3b; margin-top:8px;">
                    💡 推荐使用 DeepSeek (深度求索) 或 Kimi。密钥将存储在您的浏览器本地，不会上传服务器。
                </div>
            </div>
            
            <div id="msg-box" style="margin-top:20px; font-weight:bold; color:var(--success); text-align:center; font-size:16px;"></div>
        </div>

        <!-- 2. 乡镇学校分析 -->
        <div id="analysis" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-macro)">
                <h3><i class="ti ti-world-latitude"></i> 02 镇域宏观横向评价 <span class="badge" style="background:#0ea5e9;">📊 班主任必看</span></h3>
                <p><strong>一句话目的：</strong>快速比较学校/班级整体水平与排名位置。</p>
                <p><strong>推荐顺序：</strong>导入完成后优先查看本模块，确定整体站位。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-chart-dots"></i> 乡镇学校分析 - 两率一分 
                    <span class="module-help-btn" onclick="showModuleHelp('macro')">📘 算法说明</span>
                </h2>
                <div class="control-panel" style="margin-bottom:0; padding:5px;">
                    <input type="text" id="mySchool" placeholder="输入本校名称高亮" style="width:180px;">
                    <button class="btn" onclick="renderHorizontalTable()">生成横向对比表</button>
                    <button class="btn btn-purple" onclick="toggleTableHeatmap('horizontal-table')">🎨 开启热力图</button>
                    <button class="btn btn-green" onclick="exportMacroTables()">导出全科分析表</button>
                </div>
            </div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">快速定位</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-total', this)">🏆 综合总表</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>📘 各科详情</span><i class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-subjects-container" class="side-nav-sub-container"></div>
                    <div class="side-nav-link" onclick="scrollToAnchor('horizontal-box', this)">↔️ 横向对比</div>
                </div>
                <div class="content-area">
                    <div id="anchor-total" class="anchor-target"><div class="sub-header" style="margin-top:0;"><span>🏆 <span class="label-total">全科总</span> - 综合分析表</span></div><div class="table-wrap"><table id="tb-total"><thead><tr><th>学校名称</th><th>实考人数</th><th>平均分</th><th>优秀率</th><th>及格率</th><th>平均分赋分</th><th>优秀率赋分</th><th>及格率赋分</th><th>两率一分总分</th><th>排名</th></tr></thead><tbody></tbody></table></div></div>
                    <div id="subject-tables-container" class="anchor-target" style="padding-top:20px;"></div>
                    <div id="horizontal-box" class="hidden anchor-target" style="padding-top:20px;">
                        <div class="sub-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>↔️ 横向对比一览表</span>
                            <button class="btn btn-green" onclick="exportHorizontalExcel()">导出横向Excel</button>
                        </div>
                        <div class="table-wrap" id="horizontal-table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2.1 镇域预警与亮点看板 -->
        <div id="macro-watch" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-macro)">
                <h3><i class="ti ti-alert-triangle"></i> 02A 镇域预警与亮点看板</h3>
                <p>说明：集中呈现全镇核心KPI与红黄绿预警清单，便于快速定位问题学校与标杆学校。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-dashboard"></i> 风险预警与亮点总览
                    <span class="module-help-btn" onclick="showModuleHelp('macro')">📘 规则说明</span>
                </h2>
            </div>
            <div id="macro-dashboard" class="fb-dashboard" style="margin-bottom:25px;"></div>
            <div id="traffic-light-dashboard" class="traffic-grid hidden">
                <!-- 红灯区：严重预警 -->
                <div class="traffic-col red">
                    <div class="traffic-head red">
                        <span><i class="ti ti-alert-triangle-filled"></i> 红色预警 (重点整改)</span>
                        <span id="count-red" class="badge" style="background:#b91c1c">0</span>
                    </div>
                    <div style="font-size:11px; color:#b91c1c; margin-bottom:10px; opacity:0.8;">
                        触发条件: 及格率&lt;60% 或 单科排名倒数第一
                    </div>
                    <div class="traffic-list" id="list-red"></div>
                </div>

                <!-- 黄灯区：风险提示 -->
                <div class="traffic-col yellow">
                    <div class="traffic-head yellow">
                        <span><i class="ti ti-alert-circle-filled"></i> 黄色关注 (培优提升)</span>
                        <span id="count-yellow" class="badge" style="background:#b45309">0</span>
                    </div>
                    <div style="font-size:11px; color:#b45309; margin-bottom:10px; opacity:0.8;">
                        触发条件: 优秀率&lt;15% 或 临界生密集
                    </div>
                    <div class="traffic-list" id="list-yellow"></div>
                </div>

                <!-- 绿灯区：标杆示范 -->
                <div class="traffic-col green">
                    <div class="traffic-head green">
                        <span><i class="ti ti-thumb-up-filled"></i> 绿色标杆 (经验推广)</span>
                        <span id="count-green" class="badge" style="background:#15803d">0</span>
                    </div>
                    <div style="font-size:11px; color:#15803d; margin-bottom:10px; opacity:0.8;">
                        触发条件: 优秀率&gt;30% 或 综合排名第一
                    </div>
                    <div class="traffic-list" id="list-green"></div>
                </div>
            </div>
        </div>

        <!-- 2.1 新增：高分段核算独立模块 -->
        <div id="high-score" class="section card-box">
            <div class="module-desc-bar" style="border-color: #b45309">
                <h3><i class="ti ti-trophy"></i> 9年级高分段核算</h3>
                <p>考核标准：总分≥490分。赋分公式：(本校高分率 / 全镇最高高分率) × 70。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-trophy"></i> 高分段赋分详情
                    <span class="module-help-btn" onclick="showModuleHelp('high-score')">📘 核算规则</span>
                </h2>
                <button class="btn btn-green" onclick="exportHighScoreExcel()">📊 导出Excel</button>
            </div>
            <div class="table-wrap">
                <table id="tb-high-score">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th>实考人数</th>
                            <th style="background:#fff7ed; color:#b45309;">高分人数 (≥490)</th>
                            <th style="background:#fff7ed; color:#b45309;">高分率</th>
                            <th style="background:#fff7ed; color:#b45309;">高分赋分 (满分70)</th>
                            <th>排名</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        
        <!-- 3. 后1/3核算 -->
        <div id="bottom3" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-arrow-bar-to-down"></i> 后1/3学生核算
                    <span class="module-help-btn" onclick="showModuleHelp('bottom3')">📘 剔除规则</span>
                    <span style="font-size:14px; font-weight:normal; color:#666; margin-left:5px;">(剔除率: <span id="label-exc"></span>)</span>
                </h2>
                <button class="btn" onclick="exportExcel('bottom3')">导出结果</button>
            </div>
            <div class="table-wrap"><table id="tb-bottom3"><thead><tr><th>学校名称</th><th>总人数</th><th>后1/3人数</th><th>剔除人数</th><th>有效后1/3均分</th><th>核算得分</th><th>排名</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 4. 指标生核算 -->
        <div id="indicator" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> 指标生达标核算
                    <span class="module-help-btn" onclick="showModuleHelp('indicator')">📘 计分公式</span>
                </h2>
                <div>
                    <button class="btn btn-blue" onclick="openTargetEditor()">
                        <i class="ti ti-edit"></i> 在线调整目标
                    </button>
                    <button class="btn btn-green" id="btn-indicator-calc" onclick="calcIndicators()">开始计算</button>
                    <button class="btn" onclick="exportExcel('indicator')">导出结果</button>
                </div>
            </div>
            <div class="table-wrap"><table id="tb-indicator"><thead><tr><th>学校名称</th><th>指标一(目标/达标)</th><th>得分</th><th>指标二(目标/达标)</th><th>得分</th><th>指标生总分</th><th>排名</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 5. 综合总排名 -->
        <div id="summary" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-report"></i> 综合分析报告 <span class="badge" style="background:#16a34a;">⭐ 教务常用</span>
                    <span class="module-help-btn" onclick="showModuleHelp('summary')">📘 权重说明</span>
                </h2>
                <div>
                    <button class="btn btn-green" onclick="calcSummary()">生成总排名</button>
                    <button class="btn btn-green" onclick="exportSummaryTable()">导出报告</button>
                    <button class="btn btn-orange" onclick="exportPPTReport()">
                        <i class="ti ti-presentation"></i> 导出汇报PPT
                    </button>
                   <button class="btn btn-purple" onclick="generateAIMacroReport()">
                        <i class="ti ti-robot"></i> AI 撰写质量分析 (2000字)
                    </button>
</div></div>
            <div class="table-wrap"><table id="tb-summary"><thead><tr><th>学校名称</th><th>两率一分得分</th><th>后1/3得分</th><th>指标生得分</th><th>综合总分</th><th>总排名</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 6. 本校教师分析 -->
        <div id="teacher-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-school"></i> 本校教师教学分析 <span class="badge" style="background:#0ea5e9;">📊 班主任必看</span>
                    <span class="module-help-btn" onclick="showModuleHelp('teacher')">📘 评价模型</span>
                </h2>
                <button class="btn" onclick="exportTeacherAnalysis()">导出教师分析</button>
            </div>
            <div class="info-bar">本校教师教学分析基于导入的教师信息和成绩数据，展示教师所教班级的整体表现，并与乡镇学校进行对比。</div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">功能导航</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-cards', this)">📇 教师概况卡片</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-detail', this)">📊 详细数据对比</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-pair', this)">🤝 结对子建议</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>🏅 乡镇排名</span><i class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-teacher-ranks-container" class="side-nav-sub-container"></div>
                </div>
                <div class="content-area">
                    <div id="anchor-cards" class="anchor-target">                    <!-- 使用 x-data 声明这是一个 Alpine 组件，x-show 控制显示 -->
                    <div class="teacher-cards-container" id="teacherCardsContainer" x-data>
                        
                        <!-- 空状态提示 -->
                        <div x-show="$store.teacherData.list.length === 0" style="grid-column: 1/-1; text-align:center; color:#999; padding:20px;">
                            暂无教师数据，请先在上方配置并导入。
                        </div>

                        <!-- 循环渲染卡片 -->
                        <template x-for="item in $store.teacherData.list" :key="item.id">
                            <div class="teacher-card">
                                <div class="teacher-header">
                                    <div>
                                        <div class="teacher-name" x-text="item.name + ' - ' + item.subject"></div>
                                        <div class="teacher-classes" x-text="item.classes + '班'"></div>
                                    </div>
                                    <div :class="`performance-badge ${item.badgeClass}`" x-text="item.badgeText"></div>
                                </div>
                                <div class="teacher-stats">
                                    <div class="stat-item"><div class="stat-value" x-text="item.avg"></div><div class="stat-label">平均分</div></div>
                                    <div class="stat-item"><div class="stat-value" x-text="item.excRate"></div><div class="stat-label">优秀率</div></div>
                                    <div class="stat-item"><div class="stat-value" x-text="item.passRate"></div><div class="stat-label">及格率</div></div>
                                </div>
                                <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:15px; padding:0 10px;">
                                    <span>学生: <span x-text="item.count"></span>人</span>
                                    <span>镇排: <strong style="color:var(--primary)" x-text="item.rank"></strong></span>
                                </div>
                                <!-- 点击事件直接绑定 JS 函数 -->
                                <button class="view-details-btn" @click="showTeacherDetails(item.name, item.subject)">查看详情</button>
                            </div>
                        </template>
                    </div></div>
                    <div id="anchor-detail" class="anchor-target" style="padding-top:30px;">
                        <div class="sub-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>📊 教师教学详细数据对比表</span>
                            <button class="btn btn-green" onclick="exportTeacherComparisonExcel()">导出Excel</button>
                        </div>
                        <div class="table-wrap"><table class="comparison-table" id="teacherComparisonTable"><thead><tr><th rowspan="2">教师姓名</th><th rowspan="2">学科</th><th rowspan="2">任教班级</th><th rowspan="2">人数</th><th colspan="3">平均分</th><th colspan="3">优秀率</th><th colspan="3">及格率</th><th rowspan="2">综合得分</th><th rowspan="2">校内排名</th></tr><tr><th>实际值</th><th>与级比</th><th>排名</th><th>实际值</th><th>与级比</th><th>排名</th><th>实际值</th><th>与级比</th><th>排名</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div id="anchor-pair" class="anchor-target" style="padding-top:30px;"><div id="teacher-pairing-box"><div class="sub-header">🤝 校内教师“结对子”互助建议 (基于数据分析)</div><div id="teacher-pairing-suggestions" class="pairing-container"></div></div></div>
                    <div id="teacher-township-ranking-container"></div>
                    <div style="margin-top:10px; text-align:right;"><button class="btn btn-green" onclick="exportTeacherTownshipRankExcel()">导出教师乡镇排名</button></div>
                </div>
            </div>
        </div>

        <!-- ================== 新增模块：校内绩效公平考核 (单校模式) ================== -->
        <div id="single-school-eval" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-internal)">
                <h3><i class="ti ti-scale"></i> 03 校内绩效管理与评价</h3>
                <p>说明：面向校长室。解决生源不均导致的考核不公，通过“生源增值模型”和“大班额补偿系数”，科学核算每位教师、每个班级的真实教学贡献。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-scale"></i> 校内绩效公平考核模型
                    <span class="module-help-btn" onclick="showModuleHelp('sse')">📘 100分制详解</span>
                </h2>
                <button class="btn btn-green" onclick="SSE_calculate()">🚀 开始考核计算</button>
            </div>

            <!-- 核心理念展示区 -->
            <div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); border: 1px solid #bae6fd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #0369a1; margin-bottom: 10px; font-size: 18px;"><i class="ti ti-bulb"></i> 核心理念：“不让老实人吃亏”</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">1. 不看人口看密度 (35+35分)</div>
                        <p style="font-size: 12px; color: #666;">
                            摒弃“优生人数”绝对值，改用<strong>“优秀率/及格率”</strong>。<br>
                            <span style="background: #dcfce7; padding: 1px 4px;">60人班15个优生 = 40人班10个优生</span>，得分完全一致。
                        </p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">2. 不看起点看变化 (10分)</div>
                        <p style="font-size: 12px; color: #666;">
                            引入<strong>“生源增值分”</strong>。对比上次考试排位百分比变化。<br>
                            差班从年级后20%进步到后40%，即视为高绩效，奖励<strong>“加工能力”</strong>。
                        </p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">3. 大班额补偿系数 (额外加分)</div>
                        <p style="font-size: 12px; color: #666;">
                            承认管理成本。以年级平均人数为基准。<br>
                            每多 <strong>1</strong> 名学生，总分额外补偿 <strong>0.1</strong> 分辛苦分。
                        </p>
                    </div>
                </div>
            </div>

            <!-- 控制面板 -->
            <div class="control-panel">
                <div style="flex: 1;">
                    <label><strong>选择考核学校：</strong></label>
                    <select id="sse_school_select" style="min-width: 200px; padding: 8px;">
                        <option value="">-- 请选择 --</option>
                    </select>
                </div>
                <div style="flex: 2; display: flex; gap: 15px; align-items: center; font-size: 13px;">
                    <label><input type="checkbox" id="sse_check_exc" checked> 优秀贡献(前25%)</label>
                    <label><input type="checkbox" id="sse_check_pass" checked> 及格保底(前80%)</label>
                    <label><input type="checkbox" id="sse_check_avg" checked> 均分水位</label>
                    <label><input type="checkbox" id="sse_check_prog" checked> 生源增值</label>
                </div>
                <div style="border-left: 1px solid #ccc; padding-left: 15px;">
                    <button class="btn btn-purple" onclick="SSE_export()">📥 导出考核表</button>
                </div>
            </div>

            <!-- 结果展示区 -->
            <div id="sse_result_container" class="hidden">
                <div class="sub-header">
                    <span>📊 绩效赋分排行榜</span>
                    <span style="font-size: 12px; font-weight: normal; margin-left: 10px;">
                        (基准: 优秀35 + 及格35 + 均分20 + 增值10 = 100分 + 班额补偿)
                    </span>
                </div>
                <div class="table-wrap">
                    <table id="sse_table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>班级</th>
                                <th>班主任/教师</th>
                                <th>实考人数</th>
                                <th>大班补偿分</th>
                                <th>优秀率(25%)<br><small style="color:#999">权重35</small></th>
                                <th>及格率(80%)<br><small style="color:#999">权重35</small></th>
                                <th>均分对比<br><small style="color:#999">权重20</small></th>
                                <th>生源增值<br><small style="color:#999">权重10</small></th>
                                <th style="background: #eff6ff; color: #1e3a8a;">最终考核分</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; font-size: 12px; color: #666; background: #f9fafb; padding: 10px; border-radius: 6px;">
                    <strong>ℹ️ 算法说明：</strong><br>
                    1. <strong>优秀/及格得分：</strong> (本班率 / 年级最高率) × 权重分。鼓励向最高标准看齐。<br>
                    2. <strong>均分得分：</strong> (本班均分 / 年级均分) × 权重分。<br>
                    3. <strong>生源增值：</strong> 计算全班学生排位百分比变化的平均值。正值为进步。按 (进步值 / 最大进步值) × 10 计算，退步者此项从低计分。<br>
                    4. <strong>大班补偿：</strong> (班级人数 - 年级平均人数) × 0.1。人数少于平均线不扣分。
                </div>
            </div>
        </div>

        <!-- 学科深度关联分析 -->
        <div id="correlation-analysis" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-topology-star-3"></i> 学科贡献度与关联性深度分析</h2><button class="btn btn-green" onclick="exportCorrelationExcel()">导出分析Excel</button></div>
            <div class="info-bar">探索学科间的内在联系以及各学科对总分排名的贡献度（区分度）。</div>
            <div class="control-panel">
                <label>分析范围：</label><select id="corrSchoolSelect" style="min-width:200px;"><option value="ALL">全乡镇</option></select>
                <button class="btn btn-purple" onclick="renderCorrelationAnalysis()">🚀 开始深度分析</button>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px;">
                <div class="bg-gray-50">
                    <h3 style="margin-bottom:15px; color:#333;">🔗 学科间相关性热力矩阵 (Pearson)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">数值越接近1.0(深红)，表示两科成绩越同步。</p>
                    <div class="table-wrap" style="box-shadow:none; border:none; margin-top:0;"><table class="heatmap-table" id="corrMatrixTable"><tbody></tbody></table></div>
                </div>
                <div class="bg-gray-50">
                    <h3 style="margin-bottom:15px; color:#333;">⚖️ 学科对总排名贡献度 (区分度)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">数值越高，说明该学科越能决定总排名的位次。</p>
                    <div id="contributionChartContainer"></div>
                </div>
            </div>
            <div class="bg-gray-50" style="margin-top:20px;">
                <h3 style="margin-bottom:15px; color:#333;">📉 “提分项”与“拖后腿”频率分析</h3>
                <div class="table-wrap"><table id="liftDragTable"><thead><tr><th>学科</th><th>提分主力 (单科排名前于总排)</th><th>拖分主力 (单科排名后于总排)</th><th>平衡型</th><th>净贡献 (提分-拖分)</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
        
        <!-- 临界生精准辅导任务单 -->
        <div id="marginal-push" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-target-arrow"></i> 04 精准诊断与干预</h3>
                <p>说明：面向一线科任教师。挖掘临界生（拟优秀、拟及格）、偏科生以及成绩波动剧烈的“过山车”学生，生成任务单实现精准帮扶。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> 临界生精准辅导任务单
                    <span class="module-help-btn" onclick="showModuleHelp('student-diag')">📘 筛选逻辑</span>
                </h2>
                <div>
                    <button class="btn btn-purple" onclick="printMarginalTickets()">🖨 批量打印任务单</button>
                    <button class="btn btn-green" onclick="exportMarginalTasks()">📊 导出Excel</button>
                </div>
            </div>
            
            <div class="info-bar">
                <strong>核心策略：</strong> 筛选出距离“优秀线”或“及格线”仅差 
                <span style="border-bottom:2px solid var(--primary); font-weight:bold;">N分</span> 
                的学生，生成科任教师的重点关注名单。
            </div>

            <div class="control-panel" style="background: #fffbeb; border-color: #fcd34d;">
                <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                    <div>
                        <label>选择学校：</label><br>
                        <select id="mpSchoolSelect" style="min-width:150px;" onchange="updateMpClassSelect()"><option value="">--请选择--</option></select>
                    </div>
                    <div>
                        <label>班级 (可选)：</label><br>
                        <select id="mpClassSelect" style="min-width:100px;"><option value="">全部班级</option></select>
                    </div>
                    <div>
                        <label>学科：</label><br>
                        <select id="mpSubjectSelect" style="min-width:100px;"><option value="ALL">全部学科</option></select>
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:15px;">
                        <label><strong>🎯 临界分值 (Gap)</strong>：</label><br>
                        <input type="number" id="mpGap" value="5" style="width:70px; font-weight:bold; color:red;"> 分以内
                    </div>
                    <div>
                        <label>目标类型：</label><br>
                        <select id="mpType">
                            <option value="both" selected>全部 (拟优+拟及格)</option>
                            <option value="pass">仅看 拟及格 (保底)</option>
                            <option value="exc">仅看 拟优秀 (培优)</option>
                        </select>
                    </div>
                    <div style="padding-top:16px;">
                        <button class="btn btn-primary" onclick="generateMarginalTickets()">🚀 生成辅导单</button>
                    </div>
                </div>
            </div>

            <!-- 闭环管理：转化率追踪面板 -->
            <div style="margin:15px 0; background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #bbf7d0; padding-bottom:10px; margin-bottom:10px;">
                    <h3 style="color:#166534; margin:0; font-size:15px;"><i class="ti ti-refresh"></i> 临界生转化闭环管理 (教师评价)</h3>
                    <div style="font-size:12px; color:#15803d;">
                        逻辑：保存本次生成的名单为“历史任务” -> 下次考试导入数据 -> 自动计算有多少人成功“上线”
                    </div>
                </div>
                
                <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                    <!-- 动作A: 存档 -->
                    <div style="flex:1; border-right:1px solid #bbf7d0; padding-right:15px;">
                        <div style="font-weight:bold; color:#166534; margin-bottom:5px;">第1步：当前任务存档</div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="mp_save_name" placeholder="任务名 (如:期中临界生)" style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; flex:1;">
                            <button class="btn btn-green btn-sm" onclick="MP_saveSnapshot()">💾 存档</button>
                        </div>
                    </div>

                    <!-- 动作B: 追踪 -->
                    <div style="flex:2;">
                        <div style="font-weight:bold; color:#166534; margin-bottom:5px;">第2步：转化效果追踪 (需先上传新数据)</div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select id="mp_snapshot_select" style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; min-width:150px;">
                                <option value="">-- 选择历史任务 --</option>
                            </select>
                            <button class="btn btn-orange btn-sm" onclick="MP_analyzeConversion()">📈 计算转化率</button>
                            <button class="btn btn-gray btn-sm" onclick="MP_deleteSnapshot()"><i class="ti ti-trash"></i></button>
                        </div>
                    </div>
                </div>

                <!-- 分析结果展示区 -->
                <div id="mp-conversion-result" class="hidden" style="margin-top:15px; background:white; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                    <div class="sub-header" style="margin-top:0;">📊 教师辅导效能评估 (基于转化率)</div>
                    <div class="table-wrap">
                        <table id="mp_conversion_table" style="font-size:12px;">
                            <thead>
                                <tr>
                                    <th>教师/班级</th>
                                    <th>学科</th>
                                    <th>目标类型</th>
                                    <th>追踪人数 (历史)</th>
                                    <th>本次上线人数</th>
                                    <th>转化成功率</th>
                                    <th>评价</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 任务单预览区 -->
            <div id="mp-tickets-container" class="mp-grid">
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#94a3b8;">
                    <i class="ti ti-clipboard-list" style="font-size:48px; margin-bottom:10px;"></i>
                    <p>请调整参数后点击“生成辅导单”</p>
                </div>
            </div>
        </div>

        <!-- 考后座位微调建议 -->
        <div id="seat-adjustment" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-armchair"></i> 考后“座位微调”建议</h2></div>
            <div class="info-bar">基于最近发展区理论(ZPD)与小组合作学习模式，生成促进互助的座位表。</div>
            
            <!-- [修改] 考后座位微调 - 交互优化后的约束框 -->
            <div class="constraints-box">
                <h4><i class="ti ti-alert-triangle"></i> 特殊情况约束配置 (智能标签输入)</h4>
                <div class="info-bar" style="margin:0 0 10px 0; padding:5px; font-size:11px;">💡 提示：在输入框中输入姓名，从下拉菜单中选择。数据源为当前选中的班级。</div>
                <div class="constraints-grid">
                    <div><label>😡 难管/调皮:</label><input type="hidden" id="adj_c_diff"><div id="widget_adj_diff" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="搜姓名..."><div class="suggestion-dropdown"></div></div></div>
                    <div><label>👓 视力不好 (前排):</label><input type="hidden" id="adj_c_vision"><div id="widget_adj_vision" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="搜姓名..."><div class="suggestion-dropdown"></div></div></div>
                    <div><label>❤️ 心理关注:</label><input type="hidden" id="adj_c_psy"><div id="widget_adj_psy" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="搜姓名..."><div class="suggestion-dropdown"></div></div></div>
                    <div><label>🗣️ 爱说话:</label><input type="hidden" id="adj_c_talk"><div id="widget_adj_talk" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="搜姓名..."><div class="suggestion-dropdown"></div></div></div>
                    <div style="grid-column: 1/-1"><label>⚔️ 互有矛盾/避免同桌 (生成器):</label><div class="conflict-builder"><select id="conflict_sel_a"><option value="">学生 A</option></select><span>&</span><select id="conflict_sel_b"><option value="">学生 B</option></select><button class="btn btn-gray" style="padding:2px 8px; height:28px;" onclick="addConflictPair('adj')">➕ 添加</button></div><input type="hidden" id="adj_c_conflict"><div id="widget_adj_conflict" class="tag-widget-container" style="background:#f9fafb;"><span style="font-size:11px; color:#999; padding:4px;">请使用上方选择器添加矛盾对</span></div></div>
                </div>
            </div>

            <div class="control-panel">
                <div style="flex:2; display:flex; gap:10px; flex-wrap:wrap;">
                    <div><label>学校：</label><br><select id="seatAdjSchoolSelect" style="min-width:120px;"><option value="">--请选择--</option></select></div>
                    <div><label>班级：</label><br><select id="seatAdjClassSelect" style="min-width:100px;"><option value="">--班级--</option></select></div>
                    <div><label>左右大组数 (中间过道)：</label><br><input type="number" id="seatAdjGroups" value="2" min="1" max="4" style="width:60px;" onchange="renderSeatGrid()"></div>
                    <div><label>每组列数：</label><br><input type="number" id="seatAdjCols" value="4" min="2" max="6" style="width:60px;" onchange="renderSeatGrid()"></div>
                    <div><label>分组策略：</label><br>
                        <select id="seatAdjStrategy">
                            <option value="conversion">🚀 提分转化型 (A带C, B带D)</option>
                            <option value="balanced">⚖️ 团队PK型 (4人均分平衡)</option>
                            <option value="pair">🤝 传统互助型 (强弱结对)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateSeatSuggestions()">🎲 生成共同体座次</button>
                <button class="btn btn-purple" onclick="window.print()">🖨 打印</button>
            </div>
            <div id="seat-adj-workspace" class="seat-workspace hidden" style="margin-top:20px;">
                <div class="seat-tools" style="width:200px;">
                    <h4 style="margin-bottom:10px;">策略说明</h4>
                    <div id="seat-strategy-desc" style="font-size:12px; color:#666; margin-bottom:15px; padding:10px; background:#e0f2fe; border-radius:6px;">
                        选择策略后查看详细说明...
                    </div>
                    <h4 style="margin-bottom:10px;">图例</h4>
                    <div style="font-size:12px; display:flex; flex-direction:column; gap:5px;">
                        <span style="background:#dcfce7; padding:2px 5px; border-radius:4px;">🟩 前25% (A层:优)</span>
                        <span style="background:#e0f2fe; padding:2px 5px; border-radius:4px;">🟦 25-50% (B层:良)</span>
                        <span style="background:#fef9c3; padding:2px 5px; border-radius:4px;">🟨 50-75% (C层:潜)</span>
                        <span style="background:#fee2e2; padding:2px 5px; border-radius:4px;">🟥 后25% (D层:基)</span>
                    </div>
                    <div id="seat-stats" style="margin-top:20px; font-size:12px; color:#333; font-weight:bold;"></div>
                </div>
                <div class="seat-canvas" style="min-height:500px;">
                    <div class="seat-stage">讲 台</div>
                    <div id="seat-count-display" style="margin-bottom:10px; font-weight:bold; color:#666;"></div>
                    <div id="seat-adj-container" class="seat-container" style="position:relative;"></div>
                </div>
            </div>
        </div>
        
        <!-- 学科互助分组 -->
        <div id="mutual-aid" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-friends"></i> 学科互助分组</h2><button class="btn btn-green" onclick="exportMutualAidGroups()">导出Excel</button></div>
            <div class="info-bar">
                <strong>组长(小老师)选拔标准：</strong> 
                ① 单科成绩班级前 <strong>25%</strong>；
                ② 总分成绩班级前 <strong>40%</strong> (拒绝严重偏科，确保综合辅导能力)。
            </div>
            <div class="control-panel">
                <div style="flex:1; border-right:1px solid #ccc; padding-right:10px; margin-right:10px;">
                    <label><strong>数据源：</strong></label>
                    <select id="aid_source" style="width:100%; margin-top:5px;" onchange="updateMutualAidSelects()">
                        <option value="upload">📊 上传的考试成绩 (老生)</option>
                        <option value="freshman">🚀 新生分班结果 (新生)</option>
                    </select>
                </div>
                <div style="flex:2; display:flex; gap:10px; flex-wrap:wrap;">
                    <div><label>学校：</label><br><select id="aidSchoolSelect" style="min-width:120px;"><option value="">--请选择--</option></select></div>
                    <div><label>班级：</label><br><select id="aidClassSelect" style="min-width:100px;"><option value="">--班级--</option></select></div>
                    <div><label>互助学科：</label><br><select id="aidSubjectSelect" style="min-width:100px;"><option value="total">总分(综合)</option></select></div>
                    <div><label>每组人数：</label><br><input type="number" id="aidGroupSize" value="4" min="2" max="8" style="width:60px;"></div>
                </div>
                <button class="btn btn-primary" onclick="renderMutualAidGroups()">⚡ 生成分组</button>
            </div>
            <div id="aid-groups-container" class="aid-grid">
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">
                    <i class="ti ti-users" style="font-size:48px; margin-bottom:10px;"></i>
                    <p>请选择班级和学科后点击生成</p>
                </div>
            </div>
        </div>

        <!-- 7. 班级横向对比 -->
        <div id="class-comparison" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-layout-columns"></i> 班级横向对比分析
                    <span class="module-help-btn" onclick="showModuleHelp('class-comp')">📘 全景矩阵说明</span>
                </h2>
            </div>
            <div class="info-bar">对比同一学校内各班级的各项指标，独立于教师分析。</div>
            <div class="control-panel">
                <label>选择学校：</label><select id="classCompSchoolSelect" style="min-width:200px;"><option value="">--请选择--</option></select>
                <button class="btn" onclick="renderClassComparison()">开始对比</button>
                <button class="btn btn-purple" onclick="generateClassDiagnosisReport()">
                    <i class="ti ti-brain"></i> AI 诊断班级弱项
                </button>
                <button class="btn btn-green" onclick="exportClassComparisonExcel()">导出Excel</button>
                <div style="border-left:1px solid #ccc; padding-left:10px; margin-left:10px; display:flex; gap:5px;">
                    <button class="btn btn-purple" onclick="toggleTableHeatmap('class-comp-results')">🎨 热力图</button>
                    <div style="position:relative;">
                        <button class="btn btn-gray" onclick="toggleColFilterMenu()" id="btn-col-filter">👁️ 筛选学科</button>
                        <div id="col-filter-popover" class="filter-popover">
                            <!-- JS 动态填充复选框 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">快速定位</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-class-total', this)">📊 总分对比</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>📘 单科详情</span><i class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-class-subjects" class="side-nav-sub-container"></div>
                </div>
                <div class="content-area" id="class-comp-results"></div>
            </div>
        </div>

        <!-- 8. 班情诊断 -->
        <div id="class-diagnosis" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-activity"></i> 班情诊断 (标准差/分化度分析)</h2><button class="btn btn-green" onclick="exportDiagnosisExcel()">导出诊断表</button></div>
            <div class="info-bar">通过标准差（SD）判断班级成绩是“两极分化”还是“整体均衡”。</div>
            <div class="control-panel">
                <label>学校：</label><select id="diagSchoolSelect" style="min-width:200px;"><option value="">--请选择--</option></select>
                <label style="margin-left:15px;">学科：</label><select id="diagSubjectSelect" style="min-width:100px;"><option value="total">总分</option></select>
                <label style="margin-left:15px;">间距：</label><input type="number" id="diagStep" value="10" style="width:80px;" placeholder="分">
                <button class="btn" style="margin-left:15px;" onclick="renderClassDiagnosis()">诊断分析</button>
            </div>
            <div id="diagnosis-results"><div style="text-align:center; padding:40px; color:#94a3b8;"><i class="ti ti-chart-bar" style="font-size:48px; display:block; margin-bottom:10px;"></i><p>请选择学校和学科开始诊断</p></div></div>
        </div>

        <!-- 9. 分数段统计 -->
        <div id="segment-analysis" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-chart-histogram"></i> 分数段统计分析</h2><button class="btn btn-green" onclick="renderSegmentAnalysis()">生成统计表</button><button class="btn btn-green" onclick="exportSegmentExcel()">导出Excel</button></div>
            <div class="control-panel">
                <label>统计范围：</label><select id="segSchoolSelect" style="min-width:150px;"><option value="ALL">全乡镇</option></select>
                <label style="margin-left:10px;">学科：</label><select id="segSubjectSelect" style="min-width:100px;"><option value="total">总分</option></select>
                <label style="margin-left:10px;">分段跨度：</label><input type="number" id="segStep" value="10" style="width:80px;">
            </div>
            <div style="background:white; padding:15px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:15px; height:350px; position:relative;">
                <canvas id="segmentChart"></canvas>
            </div>
            <div class="table-wrap"><table id="tb-segment"><thead></thead><tbody></tbody></table></div>
        </div>

        <!-- 10. 学生考试明细 -->
        <div id="student-details" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-student)">
                <h3><i class="ti ti-users"></i> 学生考试明细 <span class="badge" style="background:#16a34a;">⭐ 教务常用</span></h3>
                <p><strong>一句话目的：</strong>快速查看学生明细与班级成绩列表。</p>
                <p><strong>推荐顺序：</strong>总体分析后进入本模块进行班级/学生筛选。</p>
            </div>
            <div class="sec-head"><h2><i class="ti ti-users"></i> 学生考试明细</h2><button class="btn" onclick="exportStudentDetails()">导出Excel</button></div>
            <div class="control-panel">
                <label>选择本校：</label><select id="studentSchoolSelect" style="min-width:150px;"><option value="">--请选择--</option></select>
                <label style="margin-left: 10px;">选择班级：</label><select id="studentClassSelect" style="min-width:120px;"><option value="">全部</option></select>
                <button class="btn" onclick="renderStudentDetails()">筛选查询</button>
                <button class="btn btn-green" style="margin-left:auto;" onclick="generateMobileLongImage()">
                    <i class="ti ti-photo-scan"></i> 生成班级成绩长图 (手机端)
                </button>
                <button class="btn btn-orange" onclick="generateInquiryPackage()">
                    <i class="ti ti-package"></i> 生成家长查分包 (HTML)
                </button>
                <button class="btn btn-primary" style="background:#0891b2;" onclick="generateClassPPT()">
                    <i class="ti ti-presentation"></i> 生成班级分析会 PPT
                </button>
            </div>
            <div class="table-wrap"><table id="studentDetailTable"><thead><tr><th>学校</th><th>班级</th><th>姓名</th><th>考号</th><th>考场</th></tr></thead><tbody></tbody></table></div>
            <div id="mobile-share-render-area" class="mobile-share-container"></div>
        </div>

        <!-- 进退步追踪分析 (修复缺失模块) -->
        <div id="progress-analysis" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-trending-up"></i> 进退步追踪与增值评价 <span class="badge" style="background:#f59e0b;">📊 班主任必看</span></h3>
                <p><strong>一句话目的：</strong>定位学生进退步与班级增值效果。</p>
                <p><strong>推荐顺序：</strong>先上传历史成绩，再进入本模块看进步分布。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-trending-up"></i> 学生进退步追踪分析
                    <span class="module-help-btn" onclick="showModuleHelp('value-added')">📘 增值评价</span>
                </h2>
                <div style="display:flex; gap:10px;">
                    <div style="display:flex; border:1px solid #e2e8f0; border-radius:6px; overflow:hidden;">
                        <button class="btn btn-sm active" onclick="switchValueAddedView('school', this)" style="border-radius:0; background:#e0f2fe; color:#0369a1;">按学校看</button>
                        <button class="btn btn-sm" onclick="switchValueAddedView('class', this)" style="border-radius:0; background:white; color:#64748b;">按班级看</button>
                    </div>
                    <button class="btn btn-green" onclick="exportValueAddedExcel()">📊 导出增值评价表</button>
                </div>
            </div>

            <div class="info-bar">
                <span id="va-data-status">⚠️ 请先上传“上次考试”数据以激活此功能</span>
                <span style="margin-left:auto; font-size:12px;">核心算法：(入口排名 - 出口排名) = 增值名次</span>
            </div>

            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">功能视图</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-va-report', this)">📈 增值性评价报表</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-va-trend', this)">🔍 个人进退步追踪</div>
                </div>
                <div class="content-area">
                    <!-- 增值评价表 -->
                    <div id="anchor-va-report" class="anchor-target">
                        <div class="sub-header">🏫 教学效能增值评价表 (集体)</div>
                        <div class="table-wrap">
                            <table id="tb-value-added">
                                <thead>
                                    <tr>
                                        <th>单位名称</th>
                                        <th>匹配人数</th>
                                        <th>入口均位 (上次)</th>
                                        <th>出口均位 (本次)</th>
                                        <th>平均增值 (名次)</th>
                                        <th>评价</th>
                                        <th>排名</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 个人追踪 -->
                    <div id="anchor-va-trend" class="anchor-target" style="margin-top:30px;">
                        <div class="sub-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>👤 学生个人进退步详情</span>
                            <div style="font-size:12px; font-weight:normal;">
                                <label>学校：</label>
                                <!-- 🔥 关键修复点：这就是报错找不到的 ID -->
                                <select id="progressSchoolSelect" style="padding:4px; border:1px solid #ccc; border-radius:4px;" onchange="renderProgressAnalysis()">
                                    <option value="">--请选择--</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px; height:300px;">
                            <div style="background:white; border:1px solid #e2e8f0; border-radius:8px; padding:10px; position:relative;">
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">🛤️ 排名散点分布 (上浮为进，下沉为退)</h4>
                                <div style="height:calc(100% - 30px);"><canvas id="trendChart"></canvas></div>
                            </div>
                            <div style="background:white; border:1px solid #e2e8f0; border-radius:8px; padding:10px; position:relative;">
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">🌊 生源层级流动桑基图 (A/B/C/D层)</h4>
                                <div style="height:calc(100% - 30px);"><canvas id="sankeyChart"></canvas></div>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:5px; flex-wrap:wrap;">
                            <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                                <label>筛选：</label>
                                <select id="progressFilterType" style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;" onchange="applyProgressFilter()">
                                    <option value="all">全部</option>
                                    <option value="up">仅进步</option>
                                    <option value="down">仅退步</option>
                                </select>
                                <label>阈值(名次)</label>
                                <input id="progressFilterThreshold" type="number" value="20" style="width:70px; padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;" oninput="applyProgressFilter()">
                                <span style="color:#64748b;">仅显示 |变化| ≥ 阈值</span>
                                <button class="btn btn-sm btn-gray" onclick="resetProgressFilter()">重置筛选</button>
                            </div>
                            <button class="btn btn-sm btn-green" onclick="exportProgressAnalysis()">📥 导出个人明细</button>
                        </div>
                        <div class="table-wrap">
                            <table id="progressTable">
                                <thead>
                                    <tr>
                                        <th>班级</th><th>姓名</th><th>本次总分</th><th>本次校排</th><th>上次总分</th><th>上次校排</th><th>进退步</th><th>状态评价</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 11. 个性化成绩单生成器 -->
        <div id="report-generator" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-student)">
                <h3><i class="ti ti-user-heart"></i> 05 学生发展与家校沟通 <span class="badge" style="background:#0ea5e9;">📊 班主任必看</span></h3>
                <p><strong>一句话目的：</strong>生成成绩单与家长查分材料。</p>
                <p><strong>推荐顺序：</strong>完成分析后，用于班级汇报与家校沟通。</p>
            </div>
            <div class="sec-head"><h2><i class="ti ti-certificate"></i> 个性化成绩单生成器</h2></div>
            <div class="control-panel" style="background:#fff; border-color:var(--primary-light);">
                <label>选择学校：</label><select id="sel-school" style="min-width:150px;"><option>--请先上传数据--</option></select>
                <label>班级：</label><select id="sel-class" style="min-width:120px;"><option>--请先选择学校--</option></select>
            </div>
            <div class="control-panel">
                 <input type="text" id="inp-name" placeholder="查询单个学生姓名" style="width:120px;">
                 <button class="btn" onclick="doQuery()">查询单人报告</button>
                 <!-- [新增] 批量PDF入口 -->
                 <button class="btn btn-primary" style="margin-left:auto;" onclick="batchGeneratePDF()">
                    <i class="ti ti-files"></i> 批量生成全班 PDF
                </button>                 
            </div>
            <div id="single-report-result" class="hidden">
                <div style="text-align: right; margin-bottom: 10px; display:flex; justify-content:flex-end; gap:10px;">
                    <!-- [修改] 打印/PDF -->
                    <button class="btn btn-purple" onclick="printSingleReport()">
                        <i class="ti ti-printer"></i> 打印 / 另存为 PDF
                    </button>
                </div>
                <div id="report-card-capture-area" class="report-card-container"></div>
            </div>
            <div id="batch-ai-workspace" class="hidden card-box" style="margin-top:20px; border-left:4px solid #8b5cf6;">
                <div class="sec-head">
                    <h2 style="color:#6d28d9;"><i class="ti ti-sparkles"></i> 批量 AI 评语生成中心</h2>
                    <button class="btn btn-gray" onclick="document.getElementById('batch-ai-workspace').classList.add('hidden')">关闭面板</button>
                </div>
                <div class="info-bar">
                    <i class="ti ti-info-circle"></i> 系统将依据【两率一分】、排名进退步及优劣势学科，依次调用 AI 接口生成评语。建议每位学生间隔 3-5 秒以免请求超限。
                </div>
                <div style="display:flex; gap:15px; margin-bottom:15px; align-items:center;">
                    <button class="btn btn-purple" id="btn-start-batch-ai" onclick="startBatchAIComments()">🚀 开始生成 (当前选中班级)</button>
                    <button class="btn btn-danger hidden" id="btn-stop-batch-ai" onclick="stopBatchAI()">⏹ 停止生成</button>
                    <button class="btn btn-green" onclick="exportAICommentsExcel()">📥 导出评语 Excel</button>
                    <div style="font-size:12px; color:#666;">
                        间隔(秒): <input type="number" id="batch-ai-interval" value="3" style="width:50px; padding:2px;">
                    </div>
                </div>
                <!-- 进度条 -->
                <div style="background:#e2e8f0; border-radius:10px; height:20px; width:100%; margin-bottom:15px; overflow:hidden; position:relative;">
                    <div id="batch-ai-progress" style="background:#8b5cf6; width:0%; height:100%; transition:width 0.3s;"></div>
                    <div id="batch-ai-progress-text" style="position:absolute; width:100%; text-align:center; top:0; font-size:12px; line-height:20px; color:#333; font-weight:bold;">0 / 0</div>
                </div>
                <!-- 实时日志 -->
                <div class="table-wrap" style="max-height:400px; overflow-y:auto;">
                    <table id="batch-ai-table" style="font-size:12px;">
                        <thead>
                            <tr>
                                <th style="width:60px;">状态</th>
                                <th style="width:80px;">姓名</th>
                                <th style="width:60px;">排名</th>
                                <th>AI 生成评语预览</th>
                                <th style="width:60px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align:center; color:#999;">点击开始后，生成结果将显示在这里...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="sub-header" style="margin-top: 50px;">🎯 优秀和及格边缘生分析</div>
            <div class="control-panel">
                <label>选择本校：</label><select id="marginalSchoolSelect" style="min-width:200px;"><option value="">--请选择--</option></select>
                <button class="btn" onclick="analyzeMarginalStudents()">分析边缘生</button>
                <button class="btn btn-green" onclick="exportMarginalStudents()">导出Excel</button>
            </div>
            <div id="marginal-student-results"></div>
        </div>

        <div id="subject-balance" class="section card-box">
            <div class="module-desc-bar" style="border-color: #059669">
                <h3><i class="ti ti-scale"></i> 学生优劣势学科可视化透视</h3>
                <p>说明：以全镇平均分为基准，直观展示每个学生“强在哪、弱在哪”。绿色代表优势，红色代表劣势，长度代表程度。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-activity"></i> 优劣势学科透视表</h2>
                <button class="btn btn-green" onclick="SB_exportExcel()">📊 导出Excel</button>
            </div>
            
            <div class="control-panel">
                <label>选择学校：</label>
                <select id="sbSchoolSelect" style="min-width:150px;">
                    <option value="">--请选择--</option>
                </select>
                
                <label style="margin-left: 10px;">班级：</label>
                <select id="sbClassSelect" style="min-width:120px;">
                    <option value="">全部</option>
                </select>

                <label style="margin-left: 10px; border-left:1px solid #ccc; padding-left:10px;">排序依据：</label>
                <select id="sbSortBy">
                    <option value="total">按总分降序</option>
                    <option value="balance">按偏科程度(最不均衡在前)</option>
                </select>

                <button class="btn btn-primary" onclick="SB_renderTable()">🔍 开始分析</button>
            </div>

            <!-- 图例说明 -->
            <div style="font-size:12px; margin:10px 0; color:#666; display:flex; gap:15px; align-items:center;">
                <span>图例说明：</span>
                <span style="display:flex; align-items:center;"><div style="width:15px; height:8px; background:#16a34a; margin-right:5px;"></div> 优势 (高于均分)</span>
                <span style="display:flex; align-items:center;"><div style="width:15px; height:8px; background:#dc2626; margin-right:5px;"></div> 劣势 (低于均分)</span>
                <span style="color:#94a3b8;">(数值表示与全镇平均分的分差)</span>
            </div>

            <div class="table-wrap">
                <table id="sb-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">姓名</th>
                            <th style="width:60px;">总分</th>
                            <th style="width:60px;">镇排</th>
                            <th>优劣势分布图 (基准线：全镇平均分)</th>
                            <th style="width:150px;">AI 简评</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">请选择班级并点击分析</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card-box" style="border-left:4px solid #f59e0b; background:#fff7ed; margin-top:15px;">
                <div class="sec-head" style="border-bottom-color:#fed7aa; margin-bottom:10px;">
                    <h2 style="color:#9a3412;"><i class="ti ti-cluster"></i> 学科瘸腿深度聚类</h2>
                    <button class="btn btn-orange" onclick="SB_runCluster()">🔬 生成聚类与辅导策略</button>
                </div>
                <div style="font-size:12px; color:#7c2d12; margin-bottom:10px;">
                    说明：使用 K-Means 自动分类为<strong>全科均衡型 / 文强理弱型 / 理强文弱型 / 单科突围型</strong>，并给出辅导策略模板。
                </div>
                <div id="sb-cluster-results" style="font-size:12px; color:#7c2d12;"></div>
            </div>
        </div>

        <!-- 12. 偏科潜力生挖掘 -->
        <div id="potential-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-bulb"></i> 偏科潜力生挖掘
                    <span class="module-help-btn" onclick="showModuleHelp('student-diag')">📘 挖掘原理</span>
                </h2>
                <button class="btn btn-green" onclick="exportPotentialAnalysis()">导出名单</button>
            </div>
            <div class="info-bar"><span class="text-blue">核心逻辑：</span> 筛选出 <strong>总分排名靠前</strong> (如前20%)，但 <strong>单科排名严重滞后</strong> (如50%以后) 的学生。</div>
            <div class="control-panel" style="background:#fffbeb; border-color:#fcd34d;">
                <label>范围：</label><select id="potSchoolSelect" style="min-width:150px;"><option value="ALL">全乡镇</option></select>
                <label style="margin-left:15px;">总分排名前：</label><select id="potTopSelect" style="width:100px;"><option value="0.1">10%</option><option value="0.2" selected>20%</option><option value="0.3">30%</option><option value="0.5">50%</option></select>
                <label style="margin-left:15px;">单科排名后：</label><select id="potLowSelect" style="width:100px;"><option value="0.3">30%</option><option value="0.4">40%</option><option value="0.5" selected>50%</option><option value="0.6">60%</option><option value="0.8">80%</option></select>
                <button class="btn btn-orange" style="margin-left:15px;" onclick="renderPotentialAnalysis()">🔍 一键挖掘</button>
            </div>
            <div id="potential-results"><div style="text-align:center; padding:40px; color:#94a3b8;"><i class="ti ti-search" style="font-size:48px; display:block; margin-bottom:10px;"></i><p>请点击上方“一键挖掘”按钮开始分析</p></div></div>
        </div>

        <!-- 13. 新生分班 & 座位编排 -->
        <div id="freshman-simulator" class="section card-box">
           <div class="sec-head">
                <h2>
                    <i class="ti ti-arrows-split"></i> 新生均衡分班
                    <span class="module-help-btn" onclick="showModuleHelp('tools')">📘 算法逻辑</span>
                </h2>
                <div>
                    <button class="btn btn-purple" onclick="FB_saveToLocal()">💾 保存方案</button>
                    <button class="btn btn-green" onclick="FB_exportResult()">📊 导出结果</button>
                </div>
            </div>
            <div class="control-panel" style="flex-direction: column; align-items: stretch;">
                <div style="display:flex; gap:20px; flex-wrap:wrap; border-bottom:1px dashed #cbd5e1; padding-bottom:15px; margin-bottom:15px;">
                    <div class="upload-box" style="flex:1; padding:20px; min-width:250px;" onclick="document.getElementById('fbFileInput').click()">
                        <div class="upload-icon"><i class="ti ti-file-import"></i></div>
                        <div style="font-weight:bold;">点击导入新生名单 Excel</div>
                        <div style="font-size:12px; color:#64748b;">必需: 姓名,性别,总分 | 可选: 身高,视力,备注(关系)</div>
                        <input type="file" id="fbFileInput" accept=".xlsx,.xls" hidden onchange="FB_loadData(this)">
                    </div>
                    <div style="flex:2; display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:15px;">
                        <div><label class="stat-label">拟分班级数</label><input type="number" id="fb_cls_num" value="6" min="1" max="30" style="width:100%;"></div>
                        <div><label class="stat-label">班额微调</label><select id="fb_cls_size" style="width:100%;"><option value="0">自动平均</option><option value="auto">允许±2人</option></select></div>
                        <div><label class="stat-label">男女控制</label><select id="fb_rule_gender" style="width:100%;"><option value="strict">严格均衡</option><option value="loose">允许差异</option></select></div>
                        <div><label class="stat-label">难管学生</label><select id="fb_rule_diff" style="width:100%;"><option value="spread">均匀分散 (推荐)</option><option value="gather">集中管理</option></select></div>
                        <div><label class="stat-label">核心算法</label><select id="fb_algorithm" style="width:100%;"><option value="complex" selected>🧠 综合智能优化</option><option value="snake">🐍 经典蛇形分班</option></select></div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:13px; color:#b45309; background:#fffbeb; padding:5px 10px; border-radius:4px;"><i class="ti ti-alert-circle"></i> <strong>智能提示：</strong> 系统将自动解析备注列中的 "和XX同班"、"与XX分开" 等自然语言，优先级最高。</div>
                    <button class="btn btn-primary" style="padding:10px 30px; font-size:16px;" onclick="FB_runDivision()">🚀 开始智能分班</button>
                </div>
            </div>
            <div id="fb-results-area" class="hidden">
                <!-- 届别入口弹窗 -->
                <div id="mode-mask">
                    <div class="mode-box">
                        <h2 style="color:var(--primary); margin-bottom:15px; font-size:24px;">📂 进入届别档案</h2>
                        <p style="color:#64748b;">以“入学年份”为主线建立完整成长周期，系统将自动匹配年级与核算模式</p>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                            <input id="entry-cohort-year" type="number" placeholder="入学年份 (如 2022)" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; width:180px;">
                            <select id="entry-cohort-start-grade" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                                <option value="7">初中入学 (7年级)</option>
                                <option value="6">小学入学 (6年级)</option>
                            </select>
                            <button class="btn btn-primary" onclick="enterCohortFromMask()">进入届别</button>
                        </div>
                        <div style="margin-top:10px; font-size:12px; color:#64748b;">已有届别可在顶部下拉直接切换</div>
                    </div>
                </div>
                <div style="background:white; border-radius:8px; padding:15px; margin-top:20px; border:1px solid #e2e8f0;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:16px;">⚖️ 分班均衡度诊断 (箱线图)</h3>
                    <div style="height:300px; position:relative;">
                        <canvas id="balanceChart"></canvas>
                    </div>
                    <div id="balanceTableContainer" style="margin-top:20px; overflow-x:auto;"></div>
                </div>

                <div class="sub-header" style="margin-top:20px;">🏫 分班结果列表 (点击班级卡片进入座位编排)</div>
                <div class="fb-class-grid" id="fb_class_container"></div>
            </div>
            <div id="fb_seat_view" class="hidden" style="margin-top:30px; border-top:3px solid var(--primary); padding-top:20px; background:#fff;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="color:var(--primary); margin:0;"><i class="ti ti-armchair"></i> <span id="seat_class_title"></span> 座位编排</h2>
                    <button class="btn btn-gray" onclick="document.getElementById('fb_seat_view').classList.add('hidden')">❌ 关闭/返回</button>
                </div>
                <div class="seat-workspace">
                    <div class="seat-tools">
                        <h4 style="border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">🛠 教室布局</h4>
                        <div style="margin-bottom:10px;"><label>左右大组数 (中间为过道):</label><input type="number" id="seat_opt_groups" value="2" min="1" max="4" style="width:60px;" onchange="FB_renderSeatMap()"></div>
                        <div style="margin-bottom:20px;"><label>每组列数:</label><input type="number" id="seat_opt_cols" value="4" min="1" max="6" style="width:100%;" onchange="FB_renderSeatMap()"></div>
                        
                        <!-- [修改] 新生分班 - 交互优化后的约束框 -->
                        <div class="constraints-box" style="padding:10px;">
                            <h4 style="margin:0 0 10px 0;">🚧 临时干预 (智能输入)</h4>
                            <div style="font-size:12px; display:flex; flex-direction:column; gap:8px;">
                                <div><label>😡 难管:</label><input type="hidden" id="fb_c_diff"><div id="widget_fb_diff" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="输入姓名..."><div class="suggestion-dropdown"></div></div></div>
                                <div><label>👓 视力:</label><input type="hidden" id="fb_c_vision"><div id="widget_fb_vision" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="输入姓名..."><div class="suggestion-dropdown"></div></div></div>
                                <div><label>🗣️ 说话:</label><input type="hidden" id="fb_c_talk"><div id="widget_fb_talk" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="输入姓名..."><div class="suggestion-dropdown"></div></div></div>
                                <div><label>⚔️ 矛盾:</label><div class="conflict-builder"><select id="fb_conflict_sel_a" style="width:40%"><option value="">A</option></select><span>&</span><select id="fb_conflict_sel_b" style="width:40%"><option value="">B</option></select><button class="btn btn-gray" style="padding:0 5px;" onclick="addConflictPair('fb')">+</button></div><input type="hidden" id="fb_c_conflict"><div id="widget_fb_conflict" class="tag-widget-container" style="background:#f9fafb;"></div></div>
                            </div>
                        </div>

                        <!-- 1. 新增：固定搭档 (绑定) 组件 -->
                        <div class="constraints-box" style="padding:10px; margin-top:10px; background:#f0fdf4; border-color:#86efac;">
                            <h4 style="margin:0 0 10px 0; color:#166534;">🔗 强行绑定 (固定同桌)</h4>
                            <div style="font-size:12px;">
                                <div class="conflict-builder">
                                    <select id="fb_bind_sel_a" style="width:40%"><option value="">A</option></select>
                                    <span>&</span>
                                    <select id="fb_bind_sel_b" style="width:40%"><option value="">B</option></select>
                                    <button class="btn btn-green" style="padding:0 5px;" onclick="addBindPair('fb')">+</button>
                                </div>
                                <input type="hidden" id="fb_c_bind">
                                <div id="widget_fb_bind" class="tag-widget-container" style="background:#f9fafb;"></div>
                            </div>
                        </div>

                        <!-- 2. 新增：多方案管理面板 -->
                        <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:6px; padding:10px; margin-bottom:10px; display:flex; gap:10px;">
                            <button class="btn btn-gray" id="btn_undo" onclick="HistoryManager.undo()" disabled style="flex:1;">
                                <i class="ti ti-arrow-back-up"></i> 撤销
                            </button>
                            <button class="btn btn-gray" id="btn_redo" onclick="HistoryManager.redo()" disabled style="flex:1;">
                                <i class="ti ti-arrow-forward-up"></i> 重做
                            </button>
                        </div>
                        <div style="background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:10px; margin-bottom:15px; margin-top:10px;">
                            <h4 style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">💾 方案记忆</h4>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <select id="seat_scenario_select" style="flex:1; font-size:12px;" onchange="FB_loadScenario()">
                                    <option value="">-- 选择方案 --</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-primary btn-sm" style="flex:1; font-size:12px;" onclick="FB_saveScenario()">保存当前</button>
                                <button class="btn btn-danger btn-sm" style="width:30px; padding:0;" onclick="FB_deleteScenario()" title="删除选中"><i class="ti ti-trash"></i></button>
                            </div>
                        </div>

                        <div style="background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:10px; margin-bottom:15px; margin-top:10px;">
                            <button class="btn btn-gray" style="width:100%; margin-bottom:8px;" onclick="FB_toggleViewRotation()">
                                <i class="ti ti-rotate"></i> 切换讲台视角 (黑板)
                            </button>
                            <div style="font-size:12px; color:#d97706; display:flex; align-items:start; gap:5px;">
                                <i class="ti ti-mouse-2"></i>
                                <span><strong>右键点击座位</strong>可锁定/解锁。<br>锁定后，一键重排时不移动位置。</span>
                            </div>
                        </div>
                        <h4 style="border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">🧠 智能规则</h4>
                        <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
                            <label><input type="checkbox" id="rule_s_height" checked> 按身高前低后高</label><label><input type="checkbox" id="rule_s_vision" checked> 视力保护 (前3排)</label><label><input type="checkbox" id="rule_s_gender" checked> 男女同桌混排</label><label><input type="checkbox" id="rule_s_diff" checked> 难管学生“C位”监控</label><label><input type="checkbox" id="rule_s_rel" checked> 关系互斥强制分开</label>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="FB_autoSeatAlgo()">✨ 一键生成座位</button>
                        <button class="btn btn-purple" style="width:100%; margin-top:10px;" onclick="window.print()">🖨 打印座位表</button>
                    </div>
                    <div class="seat-canvas"><div class="seat-stage">讲 台 / 黑 板</div><div id="seat_map_container" class="seat-container"></div></div>
                </div>
            </div>
        </div>

        <!-- 14. 智能考场编排 -->
        <div id="exam-arranger" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-tools)">
                <h3><i class="ti ti-settings-automation"></i> 06 智慧教务事务工具</h3>
                <p>说明：解决日常繁杂教务。包含考场智能编排、自动生成桌贴、新生均衡分班、座位表智能排列（考虑视力/身高/矛盾）等功能。</p>
            </div>
            <div class="sec-head"><h2><i class="ti ti-id-badge-2"></i> 智能考场编排器</h2><div><button class="btn btn-green" onclick="EXAM_exportResult()">📊 导出考务Excel</button><button class="btn btn-orange" onclick="EXAM_generateDeskLabels()">🏷️ 批量打印桌贴</button><button class="btn btn-purple" onclick="window.print()">🖨 批量打印桌贴</button></div></div>
            <div class="control-panel" style="flex-direction: column; align-items: stretch;">
                <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                    <div class="upload-box" style="flex:1; padding:20px; min-width:250px;" onclick="document.getElementById('examFileInput').click()">
                        <div class="upload-icon"><i class="ti ti-file-certificate"></i></div>
                        <div style="font-weight:bold;">导入本次考试学生名单</div>
                        <div style="font-size:12px; color:#64748b;">自动识别姓名/班级/总分(自动按分排序)</div>
                        <input type="file" id="examFileInput" accept=".xlsx,.xls" hidden onchange="EXAM_loadData(this)">
                    </div>
                   <div style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:15px; background:#f8fafc; padding:10px; border-radius:8px;">
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div><label style="width:80px;font-weight:bold;">考号前缀：</label><input type="text" id="exam_prefix" value="202501" style="width:100px;"></div>
                    <div><label style="width:80px;font-weight:bold;">每场人数：</label><input type="number" id="exam_seats_per_room" value="30" style="width:100px;"></div>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="checkbox" id="exam_opt_separate" checked> 
                        <span style="margin-left:5px;">🔀 <b>同班互斥</b> (防作弊)</span>
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="checkbox" id="exam_opt_snake"> 
                        <span style="margin-left:5px;">🐍 <b>S型蛇形排列</b> (座位号)</span>
                    </label>
                </div>
                <button class="btn btn-primary" style="grid-column: 1/-1; margin-top:5px;" onclick="EXAM_generate()">
                    🚀 智能生成考场安排
                </button>
            </div>
                </div>
                <div id="exam-results-area" class="hidden">
                    <div class="nav-sub-items" style="margin-bottom:15px; background:#f1f5f9; border-radius:6px; border:none;">
                        <div class="nav-link active" onclick="EXAM_switchView('overview', this)">👀 考场概览</div>
                        <div class="nav-link" onclick="EXAM_switchView('setup', this)">👨‍🏫 人员配置</div>
                        <div class="nav-link" onclick="EXAM_switchView('students', this)">📋 考生查询表</div>
                        <div class="nav-link" onclick="EXAM_switchView('proctor', this)">👮 监考汇总表</div>
                    </div>
                    <div id="exam-view-overview">
                        <div class="info-bar">💡 点击考场卡片可查看该考场的详细座次表。打印时会自动分页。</div>
                        <div id="exam_room_grid" class="exam-room-grid"></div>
                    </div>
                    <div id="exam-view-students" class="hidden">
                         <div class="table-wrap"><table id="exam_student_table"><thead><tr><th>考号</th><th>姓名</th><th>班级</th><th>考场号</th><th>座号</th><th>上次成绩</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div id="exam-view-setup" class="hidden">
                        <div class="info-bar">依据【数据中心】导入的教师信息，请勾选不在考务名单的人员，并分配特殊角色。</div>
                        <div class="proctor-setup-grid">
                            <!-- 教师黑名单 -->
                            <div>
                                <span class="role-label"><i class="ti ti-user-x"></i> 1. 排除不参加监考的人员 (勾选)</span>
                                <div id="proctor-teacher-pool" class="teacher-scroll-list">
                                    <!-- 动态加载教师 -->
                                    <div style="color:#999; padding:20px; grid-column: 1/-1;">请先导入教师信息...</div>
                                </div>
                            </div>
                            <!-- 角色分配 -->
                            <div>
                                <span class="role-label"><i class="ti ti-users"></i> 2. 指定特殊岗位 (多选/按住Ctrl)</span>
                                <div class="role-group">
                                    <label class="role-label">⚖️ 纪律巡考/校级巡查</label>
                                    <select id="proctor-role-patrol" class="role-select" multiple></select>
                                </div>
                                <div class="role-group" style="border-left: 4px solid #10b981;">
                                    <label class="role-label">🧹 卫生考务/后勤保障组</label>
                                    <select id="proctor-role-affairs" class="role-select" multiple></select>
                                </div>
                                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="EXAM_assignProctors()">
                                    🚀 一键编排监考表 (2人/班)
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="exam-view-proctor" class="hidden">
                        <div class="table-wrap"><table id="exam_proctor_table" class="proctor-table"><thead><tr><th>考场</th><th>人数</th><th>起止考号</th><th>监考员签字</th><th>巡考员签字</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="grade-scheduler" class="section card-box">
            <div class="module-desc-bar" style="border-color: #7c3aed">
                <h3><i class="ti ti-calendar-time"></i> 下一年级部排课系统</h3>
                <p>说明：独立于当前成绩数据。用于新学期排课，支持自定义课时结构、合堂课、早晚自习特定规则以及教师均衡排班。</p>
            </div>
            
            <div class="sec-head">
                <h2><i class="ti ti-layout-grid"></i> 级部智能排课</h2>
                <div>
                    <button class="btn btn-purple" onclick="SCHEDULER.exportResult()">📥 导出课表(Excel)</button>
                    <button class="btn btn-orange" onclick="document.getElementById('schedulerImportFile').click()">📤 导入已有课表优化</button>
                    <button class="btn btn-gray" onclick="SCHEDULER.auditFatigue()">🧠 AI疲劳审计</button>
                    <input type="file" id="schedulerImportFile" accept=".xlsx,.xls" hidden onchange="SCHEDULER.importExisting(this)">
                </div>
            </div>

            <!-- 1. 基础配置面板 -->
            <div class="control-panel" style="display:block;">
                <h4 style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">⚙️ 课时结构配置</h4>
                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                    <div>
                        <label class="stat-label">上午节数</label>
                        <input type="number" id="sch_am_count" value="4" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">下午节数</label>
                        <input type="number" id="sch_pm_count" value="4" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">晚自习节数</label>
                        <input type="number" id="sch_eve_count" value="3" style="width:60px;">
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:15px;">
                        <label class="stat-label">单节时长(分)</label>
                        <input type="number" id="sch_dur_class" value="45" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">课间时长(分)</label>
                        <input type="number" id="sch_dur_break" value="10" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">大课间位置</label>
                        <select id="sch_big_break_pos" style="width:100px;">
                            <option value="2">第2节后</option>
                            <option value="3">第3节后</option>
                        </select>
                    </div>
                </div>

                <h4 style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">🚧 常规规则约束</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px; font-size:13px;">
                    <label><input type="checkbox" id="sch_rule_fri_eve" checked> 周五晚上不上课</label>
                    <label><input type="checkbox" id="sch_rule_fri_pm" onchange="document.getElementById('sch_fri_pm_val').disabled=!this.checked"> 周五下午仅上 <input type="number" id="sch_fri_pm_val" value="2" style="width:40px; padding:0;" disabled> 节</label>
                    <label><input type="checkbox" id="sch_rule_morning_read" checked> 添加 [07:00] 小晨读+早读</label>
                    <label><input type="checkbox" id="sch_rule_noon_write" checked> 添加 [13:30] 午间练字/午唱</label>
                    <div style="grid-column: 1/-1; background:#fff; padding:8px; border:1px solid #eee; border-radius:4px;">
                        <strong>🔗 合堂/连堂规则 (晚自习):</strong><br>
                        <select id="sch_combined_slot" style="margin-top:5px;">
                            <option value="eve_3">晚自习第3节</option>
                            <option value="eve_all">整个晚自习</option>
                        </select>
                        <span style="color:#666;"> 必须由同一老师跨班连上 (如: 1,2,3班合堂)</span>
                    </div>
                </div>
            </div>

            <!-- 2. 资源导入 -->
            <div style="display:flex; gap:20px; margin-top:20px;">
                <div class="upload-box" style="flex:1; min-height:150px; padding:20px;" onclick="document.getElementById('schTeacherFile').click()">
                    <div class="upload-icon"><i class="ti ti-users"></i></div>
                    <div style="font-weight:bold;">导入新学期教师任课表 (Excel)</div>
                    <div style="font-size:12px; color:#64748b;">
                        必需列: [教师姓名] [学科] [任教班级] [周课时量]<br>
                        (例如: 张三 | 语文 | 701,702 | 12)
                    </div>
                    <input type="file" id="schTeacherFile" accept=".xlsx,.xls" hidden onchange="SCHEDULER.loadData(this)">
                </div>
                
                <div style="flex:2; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:15px; max-height:200px; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between;">
                        <h4 style="margin:0;">📋 待排课程资源预览</h4>
                        <button class="btn btn-sm btn-green" onclick="SCHEDULER.downloadTemplate()"><i class="ti ti-download"></i> 下载任课模板</button>
                    </div>
                    <div id="sch_resource_preview" style="margin-top:10px; font-size:12px; color:#666;">
                        请先上传 Excel 文件...
                    </div>
                </div>
            </div>

            <!-- 3. 动态约束配置区 (核心修改) -->
            <div class="constraints-box" style="margin-top:20px; background:#fff; border:1px solid #e2e8f0; box-shadow:0 4px 6px rgba(0,0,0,0.02);">
                <h4 style="color:#4f46e5; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:15px;">
                    <i class="ti ti-adjustments-alt"></i> 排课规则与特殊约束 (动态配置)
                </h4>
                
                <div class="constraints-grid" style="grid-template-columns: 1fr 1fr; gap:20px;">

                    <!-- 0. 晚自习合堂/连堂规则 (替换了原来的简单下拉框) -->
                    <div style="grid-column: 1/-1; background:#fff7ed; padding:10px; border-radius:6px; border:1px solid #fdba74;">
                        <label style="font-weight:bold; color:#9a3412; margin-bottom:5px; display:block;">
                            🔗 晚自习合堂规则 (指定学科 + 教师所有班级连上)
                        </label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:5px;">
                            <span style="font-size:12px; color:#666;">将在:</span>
                            <select id="sch_comb_slot" style="width:120px; padding:4px; border:1px solid #fed7aa;">
                                <option value="eve_3">晚自习第3节</option>
                                <option value="eve_2">晚自习第2节</option>
                                <option value="eve_1">晚自习第1节</option>
                            </select>
                            
                            <span style="font-size:12px; color:#666;">允许合堂的学科:</span>
                            <select id="sch_comb_subject" style="width:100px; padding:4px; border:1px solid #fed7aa;">
                                <option value="物理">物理</option>
                                <option value="化学">化学</option>
                                <option value="生物">生物</option>
                                <option value="政治">政治</option>
                                <option value="历史">历史</option>
                                <option value="地理">地理</option>
                                <option value="语文">语文</option>
                                <option value="数学">数学</option>
                                <option value="英语">英语</option>
                            </select>
                            
                            <button class="btn btn-sm" style="background:#ea580c; color:white;" onclick="SCHEDULER.addConstraint('combined')">
                                <i class="ti ti-link"></i> 添加规则
                            </button>
                        </div>
                        <div id="sch_tags_combined" class="tag-widget-container" style="min-height:35px; background:white; border-color:#fed7aa;"></div>
                        <div style="font-size:11px; color:#c2410c; margin-top:4px;">
                            ℹ️ 逻辑：系统会自动寻找该学科教多个班的老师，尝试在周一至周五的指定时段，安排其所有班级一起上课。
                        </div>
                    </div>
                    
                    <!-- 1. 班会设置 (支持多次) -->
                    <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                        <label style="font-weight:bold; color:#333; margin-bottom:5px; display:block;">🏫 班会/固定全校活动</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="sch_meet_day" style="width:80px; padding:4px;">
                                <option value="1">周一</option><option value="2">周二</option><option value="3">周三</option><option value="4">周四</option><option value="5" selected>周五</option>
                            </select>
                            <select id="sch_meet_slot" style="flex:1; padding:4px;">
                                <option value="pm_3">下午第3节</option><option value="pm_4">下午第4节</option><option value="eve_1">晚自习第1节</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="SCHEDULER.addConstraint('meeting')">➕ 添加</button>
                        </div>
                        <!-- 动态标签容器 -->
                        <div id="sch_tags_meeting" class="tag-widget-container" style="min-height:35px; background:white;"></div>
                    </div>

                    <!-- 2. 教师禁排 (开会/请假) -->
                    <div style="background:#fffbeb; padding:10px; border-radius:6px; border:1px solid #fcd34d;">
                        <label style="font-weight:bold; color:#b45309; margin-bottom:5px; display:block;">🚫 教师禁排/开会 (不排课)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="sch_busy_day" style="width:70px; padding:4px;">
                                <option value="1">周一</option><option value="5">周五</option><option value="3">周三</option>
                            </select>
                            <input type="text" id="sch_busy_slots" placeholder="节次(如: 1,2 或 am_1)" style="width:100px; padding:4px;">
                            <input type="text" id="sch_busy_name" placeholder="教师姓名" style="flex:1; padding:4px;">
                            <button class="btn btn-sm btn-orange" onclick="SCHEDULER.addConstraint('busy')">➕ 添加</button>
                        </div>
                        <div id="sch_tags_busy" class="tag-widget-container" style="min-height:35px; background:white;"></div>
                    </div>

                    <!-- 3. 教研活动/半天无课 -->
                    <div style="grid-column: 1/-1; background:#f0fdf4; padding:10px; border-radius:6px; border:1px solid #86efac;">
                        <label style="font-weight:bold; color:#166534; margin-bottom:5px; display:block;">🗓️ 教研组活动 / 半天无课 (批量锁死)</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:5px;">
                            <select id="sch_act_day" style="width:80px; padding:4px;">
                                <option value="3">周三</option><option value="1">周一</option><option value="2">周二</option><option value="4">周四</option><option value="5">周五</option>
                            </select>
                            <select id="sch_act_range" style="width:120px; padding:4px;">
                                <option value="pm_all">整个下午</option>
                                <option value="am_all">整个上午</option>
                                <option value="custom">指定节次→</option>
                            </select>
                            <input type="text" id="sch_act_custom_slots" placeholder="如: 6,7,8" style="width:80px; padding:4px; display:none;">
                            
                            <span>对象:</span>
                            <select id="sch_act_subject" style="width:100px; padding:4px;">
                                <option value="ALL">全级部(无课)</option>
                                <option value="语文">语文组</option><option value="数学">数学组</option><option value="英语">英语组</option>
                                <option value="物理">物理组</option><option value="化学">化学组</option><option value="政治">政治组</option>
                            </select>
                            <button class="btn btn-sm btn-green" onclick="SCHEDULER.addConstraint('activity')">➕ 添加活动</button>
                        </div>
                        <div id="sch_tags_activity" class="tag-widget-container" style="min-height:35px; background:white;"></div>
                    </div>
                </div>
                
                <div style="font-size:11px; color:#666; margin-top:5px; padding-left:5px;">
                    💡 提示：教师禁排支持输入 "上午"、"下午" 或具体数字 "1,2"；全级部无课会自动跳过排课。
                </div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn btn-primary" style="padding:12px 30px; font-size:16px;" onclick="SCHEDULER.run()">
                    🚀 开始智能排课
                </button>
            </div>

            <!-- 4. 结果展示 -->
            <div id="sch_result_area" class="hidden" style="margin-top:20px;">
                <div class="sub-header">📅 排课结果预览 (点击单元格可微调)</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="sch_view_mode" onchange="SCHEDULER.renderTable()">
                        <option value="class">按班级查看</option>
                        <option value="teacher">按教师查看</option>
                    </select>
                    <select id="sch_view_target" onchange="SCHEDULER.renderTable()">
                        <!-- 动态填充班级或教师名 -->
                    </select>
                </div>
                <div class="table-wrap">
                    <table id="sch_table" style="text-align:center; font-size:12px;">
                        <!-- JS 渲染 -->
                    </table>
                </div>
            </div>

            <!-- 5. AI 疲劳审计 -->
            <div id="sch_audit_area" class="hidden" style="margin-top:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px;">
                <div class="sub-header">🧠 排课疲劳审计结果</div>
                <div id="sch_audit_summary" style="font-size:12px; color:#64748b; margin-bottom:6px;"></div>
                <div id="sch_audit_list" class="tag-widget-container" style="min-height:40px; background:white;"></div>
            </div>
        </div>

        <div id="poster-generator" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-photo-star"></i> 喜报/红榜生成器</h2>
                <div class="control-panel" style="margin-bottom:0; padding:5px; border:none; background:none;">
                    <button class="btn btn-purple" onclick="downloadPoster()">⬇️ 保存图片</button>
                </div>
            </div>
            
            <div class="poster-workspace">
                <!-- 左侧：控制器 -->
                <div class="poster-controls">
                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">🎨 1. 选择主题</h4>
                    <div class="thumb-select">
                        <div class="thumb-btn active" onclick="setPosterTheme('red', this)">🧧 大红喜报</div>
                        <div class="thumb-btn" onclick="setPosterTheme('blue', this)">📘 清爽蓝调</div>
                        <div class="thumb-btn" onclick="setPosterTheme('tech', this)">🤖 赛博科技</div>
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">📊 2. 数据来源</h4>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">学校：</label>
                        <select id="posterSchoolSelect" style="width:100%; margin-bottom:5px;" onchange="updatePosterClassSelect()">
                            <option value="">--请选择--</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">班级 (可选)：</label>
                        <select id="posterClassSelect" style="width:100%; margin-bottom:5px;">
                            <option value="">全校排名</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">榜单类型：</label>
                        <select id="posterSubjectSelect" style="width:100%; margin-bottom:5px;">
                            <option value="total">🏆 总分光荣榜</option>
                            <!-- JS动态填充科目 -->
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">上榜人数：</label>
                        <input type="number" id="posterCount" value="10" min="1" max="50" style="width:100%;">
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">📝 3. 文案定制</h4>
                    <div style="margin-bottom:5px;"><input type="text" id="posterTitleInput" value="光荣榜" placeholder="大标题" style="width:100%;"></div>
                    <div style="margin-bottom:10px;"><input type="text" id="posterSubInput" value="本次期末考试优秀名单" placeholder="副标题" style="width:100%;"></div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="renderPoster()">🔄 生成/刷新预览</button>
                </div>

                <!-- 右侧：预览画布 -->
                <div class="poster-preview-area">
                    <div id="poster-canvas" class="poster-canvas theme-red">
                        <div class="p-header">
                            <h1 class="p-title" contenteditable="true">光荣榜</h1>
                            <div class="p-sub" contenteditable="true">2024-2025学年 第一学期期末考试</div>
                        </div>
                        <div class="p-list" id="poster-list-container">
                            <!-- 列表项将在这里生成 -->
                            <div style="text-align:center; padding-top:100px; opacity:0.7;">
                                请在左侧选择数据并点击生成
                            </div>
                        </div>
                        <div class="p-footer" contenteditable="true">
                            星光不问赶路人 · 时光不负有心人<br>
                            xx中学教务处 宣
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div id="ai-chat-widget" style="position:fixed; bottom:30px; right:30px; z-index:9999; font-family:sans-serif;">
    <!-- 1. 悬浮球 -->
    <div id="ai-chat-fab" onclick="toggleAIChat()" 
         style="width:60px; height:60px; background:linear-gradient(135deg, #6366f1, #4f46e5); border-radius:50%; box-shadow:0 10px 25px -5px rgba(79, 70, 229, 0.5); cursor:pointer; display:flex; align-items:center; justify-content:center; color:white; font-size:30px; transition:transform 0.2s;">
        <i class="ti ti-message-chatbot"></i>
    </div>

    <!-- 2. 对话窗口 -->
    <div id="ai-chat-box" class="hidden" 
         style="position:absolute; bottom:80px; right:0; width:400px; height:550px; background:white; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); display:flex; flex-direction:column; overflow:hidden; border:1px solid #e2e8f0;">
        
        <!-- 标题栏 -->
        <div style="padding:15px; background:#4f46e5; color:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:bold;"><i class="ti ti-sparkles"></i> 智能数据助理</div>
            <div style="font-size:12px; opacity:0.8;">基于本地数据</div>
        </div>

        <!-- 消息区域 -->
        <div id="ai-chat-messages" style="flex:1; padding:15px; overflow-y:auto; background:#f8fafc; display:flex; flex-direction:column; gap:10px;">
            <div class="ai-msg-bubble system">
                👋 你好！我是你的数据助理。<br>你可以这样问我：
                <ul style="padding-left:20px; margin:5px 0; font-size:12px;">
                    <li>“列出七年级总分前10名的学生”</li>
                    <li>“找出数学不及格但总分排名前100的学生”</li>
                    <li>“筛选出英语比数学高20分以上的偏科生”</li>
                    <li>“查找进步超过50名的潜力生”</li>
                </ul>
            </div>
        </div>

        <!-- 输入区域 -->
        <div style="padding:15px; background:white; border-top:1px solid #e2e8f0;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="ai-chat-input" placeholder="输入查询指令..." 
                       style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px; outline:none;"
                       onkeydown="if(event.key==='Enter') sendAIChat()">
                <button onclick="sendAIChat()" 
                        style="background:#4f46e5; color:white; border:none; padding:0 15px; border-radius:8px; cursor:pointer;">
                    <i class="ti ti-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>



    <!-- 语音控制入口 -->
    <div id="voice-fab" class="voice-fab" onclick="VoiceControl.toggle()" title="点击开启语音控制">
        <i class="ti ti-microphone"></i>
    </div>

    <!-- 全屏语音 HUD -->
    <div id="voice-hud" class="voice-hud" onclick="VoiceControl.stop()">
        <div class="voice-wave">
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
        </div>
        <div id="voice-status" class="voice-text-main">正在聆听...</div>
        <div id="voice-result" class="voice-text-sub">请说出指令，例如：“打开全科总表”</div>
        
        <div class="voice-cmd-list">
            <div class="voice-cmd-item"><span class="voice-cmd-key">"看总榜"</span> 跳转综合排名</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"看教师"</span> 教师分析</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"查某某"</span> 搜索学生</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"全屏模式"</span> 隐藏菜单</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"退出语音"</span> 关闭语音</div>
        </div>
        <div style="margin-top: 30px; font-size: 12px; color: #64748b;">(点击任意处关闭)</div>
    </div>

    <div id="drill-modal" class="modal" style="display: none; z-index: 12000;">
        <!-- 修改点：style 中宽度改为 95%，max-width 改为 1200px，高度改为 90vh -->
        <div class="modal-content" style="width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="drill-back-btn" class="btn btn-sm btn-gray hidden" onclick="DrillSystem.goBack()">
                        <i class="ti ti-arrow-left"></i> 返回
                    </button>
                    <h3 id="drill-title" style="margin:0; color:var(--primary); font-size:18px;">数据详情</h3>
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <!-- 新增导出按钮 -->
                    <button id="drill-export-btn" class="btn btn-sm btn-green" onclick="DrillSystem.exportExcel()">
                        <i class="ti ti-file-export"></i> 导出为Excel
                    </button>
                    <button onclick="document.getElementById('drill-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div id="drill-content" style="flex:1; overflow-y:auto;"></div>
            
            <!-- 底部统计 -->
            <div id="drill-footer" style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; font-size:12px; color:#666; text-align:right;"></div>
        </div>
    </div>

    <div id="target-editor-modal" class="modal" style="display: none; z-index: 11500;">
        <div class="modal-content" style="width: 90%; max-width: 1000px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;">🎯 设定各校指标目标</h3>
                <button onclick="document.getElementById('target-editor-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="info-bar" style="margin-bottom:10px;">
                💡 提示：此处修改将直接更新内存数据，记得点击“开始计算”刷新结果。
            </div>

            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="target-editor-table">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th style="background:#e0f2fe;">指标一目标 (人)</th>
                            <th style="background:#fff7ed;">指标二目标 (人)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-gray" onclick="document.getElementById('target-editor-modal').style.display='none'">取消</button>
                <button class="btn btn-primary" onclick="saveTargetEditor()">💾 保存并重算</button>
            </div>
        </div>
    </div>

    
    <!-- 批量打印隐藏容器 -->
    <div id="batch-print-container" style="display:none;"></div>
    <div id="desk-labels-print-area"></div>
    <!-- 全局快捷搜索弹窗 -->
    <div id="spotlight-mask" class="spotlight-mask" onclick="closeSpotlight(event)">
        <div class="spotlight-box" onclick="event.stopPropagation()">
            <div class="spotlight-input-wrap">
                <i class="ti ti-search" style="font-size:24px; color:var(--primary); margin-right:10px;"></i>
                <input type="text" id="spotlight-input" class="spotlight-input" placeholder="输入姓名、学校或班级..." oninput="doSpotlightSearch()">
            </div>
            <div id="spotlight-results" class="spotlight-results"></div>
            <div class="spotlight-hint">输入关键字搜索，点击结果可直接跳转至该生分析报告</div>
        </div>
    </div>
    <!-- 教师详情模态框 -->
    <div class="modal" id="teacherModal" style="display: none;">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h3 id="modalTeacherName" style="color:var(--primary);">教师姓名</h3><button id="closeModal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div class="bg-gray-50"><h4 style="margin-bottom:15px; color:#333;">教学概况</h4><div style="display:flex; justify-content:space-around;"><div class="stat-item"><div class="stat-value" id="modalAvgScore">0.00</div><div class="stat-label">平均分</div></div><div class="stat-item"><div class="stat-value" id="modalExcellentRate">0%</div><div class="stat-label">优秀率</div></div><div class="stat-item"><div class="stat-value" id="modalPassRate">0%</div><div class="stat-label">及格率</div></div></div></div>
                <div class="bg-gray-50"><h4 style="margin-bottom:15px; color:#333;">对比分析</h4><div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;"><span>平均分对比</span><span id="modalAvgComparison">0%</span></div><div style="height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden;"><div id="modalAvgProgress" style="width:0; height:100%; transition:1s;"></div></div></div></div>
            </div>
            <table class="subject-table" id="modalSubjectTable"><thead><tr><th>学科</th><th>平均分</th><th>对比</th><th>优秀率</th><th>对比</th><th>及格率</th><th>对比</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div class="modal" id="mobileShareModal" style="display: none; z-index: 10001;">
        <div class="modal-content" style="max-width: 450px; text-align: center; background: #333;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:white; font-size:16px;">📱 长按/右键保存图片</h3>
                <button onclick="document.getElementById('mobileShareModal').style.display='none'" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="mobile-img-result" style="max-height: 80vh; overflow-y: auto; border:1px solid #555;">
                <!-- 图片将生成在这里 -->
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" onclick="downloadMobileImage()">⬇️ 下载图片</button>
            </div>
        </div>
    </div>
    <!-- 同名同姓/转班 手动映射确认框 -->
    <div class="modal" id="mappingModal" style="display: none; z-index: 10002;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="color:#d97706; font-size:18px;">⚠️ 检测到疑似同名/转班学生</h3>
                <p style="font-size:13px; color:#666; margin-top:5px;">
                    系统发现以下学生在“上次考试”中有同名记录，但班级不一致（可能转班了）。<br>
                    请手动确认对应关系，以便精确计算进退步。
                </p>
            </div>
            
            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="mappingTable" style="width:100%; font-size:13px;">
                    <thead>
                        <tr>
                            <th style="background:#fef3c7;">当前学生 (本次)</th>
                            <th style="background:#fef3c7;">选择对应的上次记录</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-gray" onclick="document.getElementById('mappingModal').style.display='none'">取消分析</button>
                <button class="btn btn-primary" onclick="confirmMappingsAndRun()">✅ 确认匹配并继续</button>
            </div>
        </div>
    </div>
    <!-- 电子奖状模态框 -->
    <div id="cert-modal" class="modal" style="display: none; z-index: 10005;">
        <div class="modal-content" style="max-width: 550px; text-align: center; background: #fff; padding: 10px;">
            <!-- 这里是奖状的可视化区域 -->
            <div id="cert-capture-area" style="padding: 40px; background: #fffaf0; border: 12px double #b45309; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(180,83,9,0.05);">
                <!-- 背景装饰：由于是单文件，我们用 CSS 画一个简易防伪印章效果 -->
                <div style="position: absolute; bottom: 30px; right: 40px; width: 100px; height: 100px; border: 3px solid rgba(220,38,38,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(220,38,38,0.2); font-weight: bold; transform: rotate(-15deg); pointer-events: none; font-size: 14px;">教务处核准</div>
                
                <h1 style="color: #b45309; font-size: 42px; margin-bottom: 5px; font-family: 'STKaiti', '楷体', serif;">荣誉证书</h1>
                <div style="width: 150px; height: 3px; background: #b45309; margin: 0 auto 25px;"></div>
                
                <p style="font-size: 22px; margin-top: 20px; text-align: left; line-height: 2;">
                    <strong id="cert-name" style="border-bottom: 2px solid #333; padding: 0 15px; color: #1e293b;">张三</strong> 同学：
                </p>
                <p style="text-align: left; text-indent: 2.5em; line-height: 2; font-size: 18px; color: #374151;">
                    在本次 <span id="cert-exam-name" style="font-weight: bold; color: #2563eb;">期末考试</span> 中，凭借坚持不懈的努力和出色的表现，获得了
                    <strong id="cert-honor" style="color: #dc2626; font-size: 24px;">“进步之星”</strong>
                    光荣称号，特发此证，以资鼓励！
                </p>
                <div style="margin-top: 50px; text-align: right; padding-right: 20px;">
                    <p style="font-weight: bold; font-size: 18px; color: #1e293b;" id="cert-school-footer">XX中学教务处</p>
                    <p id="cert-date" style="color: #64748b;">2024年12月</p>
                </div>
            </div>
            
            <!-- 底部操作按钮 -->
            <div style="margin-top: 20px; display: flex; gap: 15px; padding: 10px;">
                <button class="btn btn-orange" style="flex:1; font-size: 16px; height: 45px;" onclick="downloadCertificate()">
                    <i class="ti ti-download"></i> 保存奖状为高清图片
                </button>
                <button class="btn btn-gray" style="width: 100px;" onclick="document.getElementById('cert-modal').style.display='none'">关闭</button>
            </div>
        </div>
    </div>
    <div id="school-profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="sp-title" style="margin:0; color:var(--primary); font-size:20px;">🏫 学校画像</h3>
                <button onclick="document.getElementById('school-profile-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="school-modal-grid">
                <!-- 左侧：雷达图 -->
                <div style="background:#f8fafc; border-radius:8px; padding:10px; border:1px solid #e2e8f0; height:300px; position:relative;">
                    <h4 style="text-align:center; font-size:13px; color:#64748b; margin-bottom:5px;">学科均衡度诊断 (vs 全镇均值)</h4>
                    <div style="height:260px; width:100%;"><canvas id="schoolRadarChart"></canvas></div>
                </div>
                
                <!-- 右侧：数据概览 -->
                <div>
                    <h4 style="margin-bottom:10px; border-left:4px solid var(--primary); padding-left:8px;">📊 核心指标</h4>
                    <div class="fb-dashboard" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">综合排名</div>
                            <div class="fb-val text-red" id="sp-rank">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">考核总分</div>
                            <div class="fb-val text-blue" id="sp-score">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">平均分赋分</div>
                            <div class="fb-val" id="sp-s1">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">三率赋分</div>
                            <div class="fb-val" id="sp-s2">-</div>
                        </div>
                    </div>
                    
                    <div class="info-bar" style="font-size:12px;">
                        💡 <strong>诊断建议：</strong><br>
                        <span id="sp-diagnosis">点击学校查看分析...</span>
                    </div>
                </div>
            </div>

            <!-- 分数段分布图 (双轴) -->
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #e2e8f0;">
                <h4 style="margin-bottom:10px; color:#333; font-size:14px; display:flex; justify-content:space-between;">
                    <span>📉 分数段结构对比 (本校 vs 全镇)</span>
                    <span style="font-weight:normal; font-size:12px; color:#666;">柱状=本校占比 | 折线=全镇均值</span>
                </h4>
                <div style="height:180px; width:100%; position:relative;">
                    <canvas id="schoolDistChart"></canvas>
                </div>
            </div>

            <div class="school-modal-actions">
                <span style="font-size:12px; color:#999; margin-right:auto; align-self:center;">跳转后将自动筛选该校数据</span>
                <button class="btn btn-purple" onclick="jumpToModule('class-comparison')"><i class="ti ti-layout-columns"></i> 班级对比</button>
                <button class="btn btn-blue" onclick="jumpToModule('teacher-analysis')"><i class="ti ti-school"></i> 教师评价</button>
                <button class="btn btn-green" onclick="jumpToModule('student-details')"><i class="ti ti-users"></i> 学生名单</button>
            </div>
        </div>
    </div>
    <!-- 外观设置模态框 -->
    <div id="skin-modal" class="modal" style="display: none; z-index: 11000;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:var(--primary);"><i class="ti ti-palette"></i> 系统外观定制</h3>
                <button onclick="document.getElementById('skin-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 1. 主题色设置 -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">1. 选择主色调</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <!-- 预设颜色 -->
                    <div onclick="setThemeColor('#4f46e5')" style="width:30px; height:30px; background:#4f46e5; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="默认紫"></div>
                    <div onclick="setThemeColor('#2563eb')" style="width:30px; height:30px; background:#2563eb; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="科技蓝"></div>
                    <div onclick="setThemeColor('#059669')" style="width:30px; height:30px; background:#059669; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="护眼绿"></div>
                    <div onclick="setThemeColor('#dc2626')" style="width:30px; height:30px; background:#dc2626; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="中国红"></div>
                    <div onclick="setThemeColor('#b45309')" style="width:30px; height:30px; background:#b45309; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="尊贵金"></div>
                    <div onclick="setThemeColor('#0f172a')" style="width:30px; height:30px; background:#0f172a; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="深邃黑"></div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="color" id="custom-color-input" onchange="setThemeColor(this.value)" style="width:50px; height:30px; padding:0; border:none;">
                    <span style="font-size:12px; color:#666;">自定义颜色 (点击色块选择)</span>
                </div>
            </div>

            <!-- 2. Logo 设置 -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">2. 定制校徽/Logo</h4>
                <div class="upload-box" style="padding:15px; border:1px dashed #ccc; min-height:auto;" onclick="document.getElementById('logoInput').click()">
                    <div style="color:var(--primary); font-size:20px;"><i class="ti ti-photo-up"></i> 点击上传 Logo 图片</div>
                    <p style="font-size:12px; color:#999; margin:5px 0;">建议使用透明背景 PNG，高度60px左右<br>图片将保存在本地浏览器中</p>
                    <input type="file" id="logoInput" accept="image/*" hidden onchange="handleLogoUpload(this)">
                </div>
                <button class="btn btn-gray btn-sm" onclick="clearLogo()" style="margin-top:5px;">🗑️ 清除 Logo</button>
            </div>

            <!-- 3. 标题设置 -->
            <div style="margin-bottom: 10px;">
                <h4 style="margin-bottom:10px; color:#333;">3. 系统名称</h4>
                <input type="text" id="custom-title-input" placeholder="默认为：乡镇学校成绩分析..." style="width:100%; margin-bottom:5px;" oninput="updateTitlePreview(this.value)">
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="saveSkinSettings()">💾 保存并应用</button>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="modal" style="display: none; z-index: 60000;">
        <div class="modal-content" style="max-width: 600px;"> <!-- 稍微调宽一点 -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="color:#b91c1c; margin:0;"><i class="ti ti-shield-lock"></i> 账号管理</h3>
                <!-- 新增：查看日志按钮 -->
                <button onclick="Logger.view()" style="font-size:12px; background:#fff; border:1px solid #ccc; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                    <i class="ti ti-history"></i> 操作日志
                </button>
            </div>
            <button onclick="document.getElementById('admin-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
            
            <div class="info-bar" style="margin-bottom:20px;">
                此处功能将基于您在【数据中心】上传的 Excel 数据批量生成账号。<br>
                所有生成账号的默认初始密码均为 <strong>123456</strong>。
            </div>

            <div style="display:grid; gap:15px;">
                <!-- 功能区 1 -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <h4 style="margin-bottom:10px; color:#334155;">1. 批量生成/重置账号</h4>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px; font-weight:bold; color:#64748b; display:block; margin-bottom:5px;">
                            请选择要生成的学校 (多选):
                        </label>
                        <div id="admin-gen-school-list" style="max-height:100px; overflow-y:auto; background:white; border:1px solid #cbd5e1; border-radius:4px; padding:5px; font-size:12px;">
                            <div style="color:#999; text-align:center; padding:10px;">暂无数据，请先上传成绩</div>
                        </div>
                        <div style="text-align:right; margin-top:2px;">
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(true)" style="font-size:11px; color:var(--primary);">全选</a> / 
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(false)" style="font-size:11px; color:var(--primary);">清空</a>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="Auth.generateAccounts()" style="width:100%;">
                        <i class="ti ti-user-plus"></i> 一键生成所有账号 (教师+家长)
                    </button>
                    <button class="btn btn-green" onclick="Auth.exportAccounts()" style="width:100%; background:#059669; color:white;">
                        <i class="ti ti-file-export"></i> 导出账号密码表 (Excel)
                    </button>
<!-- 新增：批量同步云端按钮 -->
                <button class="btn btn-blue" onclick="Auth.syncBatchToCloud()" style="width:100%; background:#2563eb; color:white; margin-top:5px;">
                    <i class="ti ti-cloud-upload"></i> 一键同步所有账号到云端 (Database)
                </button>
                <p style="font-size:11px; color:#64748b; margin-top:2px; text-align:center;">
                    将本地生成的账号批量写入 Supabase 数据库，以便用户登录。
                </p>
<!-- 新增：清空云端按钮 -->
                <div style="margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                    <button class="btn btn-danger" onclick="Auth.deleteCloudAccounts()" style="width:100%; background:#dc2626; color:white;">
                        <i class="ti ti-trash-x"></i> ⚠️ 清空云端所有普通账号
                    </button>
                    <p style="font-size:11px; color:#ef4444; margin-top:2px; text-align:center;">
                        警告：将删除云端所有家长和教师账号（保留管理员）。
                    </p>
                </div>
                    <hr style="margin: 15px 0; border:0; border-top:1px dashed #ccc;">
                    <h4 style="margin-bottom:10px; color:#7c3aed;">🚀 发送给家长</h4>
                    <button class="btn btn-purple" onclick="Packager.exportDistributableHTML()" style="width:100%; background:#7c3aed; color:white; font-weight:bold;">
                        <i class="ti ti-package"></i> 生成可分发网页 (含数据)
                    </button>
                    <p style="font-size:11px; color:#7c3aed; margin-top:5px; background:#f3e8ff; padding:5px; border-radius:4px;">
                        生成一个内置了成绩和账号的新HTML文件。请把这个新文件发到家长群。
                    </p>
                    <p style="font-size:12px; color:#666; margin-top:5px;">
                        教师账号 = 教师姓名 (默认密码 yssy2016)<br> <!-- 🟢 修改点：更新显示文本 -->
                        家长账号 = 学生姓名 (默认密码 123456)
                    </p>
                </div>

                <!-- 功能区 2: 云端账号管理 (修正版) -->
            <div style="background:#fff; padding:15px; border:1px solid #cbd5e1; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                
                <!-- 👇👇👇 🟢 修改：增加了班主任、级部主任选项，以及右侧的 Excel 工具栏 🟢 👇👇👇 -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                     <h4 style="margin:0; color:#0369a1;"><i class="ti ti-cloud-upload"></i> 2. 添加/管理云端账号</h4>
                     <div style="display:flex; gap:5px;">
                        <button class="btn btn-sm btn-green" onclick="AccountExcel.downloadTemplate()" title="下载导入模板">
                            <i class="ti ti-download"></i> 模板
                        </button>
                        <button class="btn btn-sm btn-orange" onclick="document.getElementById('accExcelInput').click()" title="上传Excel批量导入">
                            <i class="ti ti-file-import"></i> 导入
                        </button>
                        <input type="file" id="accExcelInput" accept=".xlsx,.xls" hidden onchange="AccountExcel.upload(this)">
                     </div>
                </div>

                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="manual-role" style="padding:8px; border:1px solid #ccc; width:30%; font-size:12px;" onchange="toggleAdminManualInput()">
                        <option value="teacher">👨‍🏫 科任教师</option>
                        <option value="class_teacher">📋 班主任</option>
                        <option value="grade_director">🚀 级部主任</option>
                        <option value="director">🎓 教务主任</option>
                        <option value="parent">👨‍👩‍👧 家长</option>
                        <option value="admin">🔑 管理员</option>
                    </select>
                    <!-- 级部输入框 (默认隐藏) -->
                    <input type="text" id="manual-grade" placeholder="级部(如:7)" style="padding:8px; border:1px solid #ccc; width:20%; display:none;">
                    
                    <input type="text" id="manual-school" placeholder="所属学校 (必填)" style="padding:8px; border:1px solid #ccc; width:25%;">
                    <input type="text" id="manual-name" placeholder="账号/姓名" style="padding:8px; border:1px solid #ccc; flex:1;">
                </div>

                <!-- 班级输入框 (默认隐藏，仅家长需要) -->
                <div id="manual-class-wrap" style="margin-bottom:10px; display:none;">
                    <input type="text" id="manual-class" placeholder="输入班级 (如: 701，家长必填)" style="width:100%; padding:8px; border:1px solid #ccc;">
                </div>

                <div style="display:flex; gap:10px;">
                    <input type="text" id="manual-pass" value="123456" placeholder="密码" style="padding:8px; border-radius:4px; border:1px solid #ccc; width:60%;">
                    <!-- 这里的 onclick 必须指向 Auth.addCloudAccount -->
                    <button class="btn btn-primary" onclick="Auth.addCloudAccount()" style="flex:1;">添加/更新</button>
                </div>
                <p style="font-size:12px; color:#999; margin-top:5px;">提示：直接写入云端数据库。账号必须唯一。</p>
            </div>

            
                
                <!-- 功能区 3 -->
                <div style="background:#fff; padding:15px; border:1px solid #eee; border-radius:8px;">
                    <h4 style="margin-bottom:10px; color:#333;">3. 修改管理员密码</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-admin-pass" placeholder="输入新密码" style="padding:8px; flex:1; border:1px solid #cbd5e1; border-radius:4px;">
                        <button class="btn btn-gray" onclick="changeAdminPass()">确认修改</button>
                    </div>
                </div>
                <div style="background:#f0fdf4; padding:15px; border:1px solid #86efac; border-radius:8px; margin-top:5px;">
                    <h4 style="margin-bottom:10px; color:#166534;"><i class="ti ti-cloud-download"></i> 4. 导出云端所有账号 (完整备份)</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <p style="font-size:12px; color:#15803d; margin:0; flex:1;">
                            此功能直接从云端数据库下载，包含<strong>批量生成</strong>、<strong>手动添加</strong>及<strong>Excel导入</strong>的所有账号。<br>
                            包含：角色、学校、班级、账号、密码。
                        </p>
                        <button class="btn btn-green" onclick="Auth.exportAllCloudAccounts()" style="background:#16a34a; color:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            <i class="ti ti-download"></i> 下载全量账号表
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 简单的修改密码脚本 (内联 - 云端同步版) -->

 
<!-- 用户个人修改密码逻辑 (通用 - 完整修复版) -->


<!-- 核心逻辑脚本 -->
<script>
window.onerror = function (msg, url, lineNo, columnNo, error) {
    // 忽略第三方插件的非关键错误
    if (msg.includes('Script error')) return false;
    
    console.error('全局错误捕获:', error);
    
    // 如果 SweetAlert2 已加载，用它提示
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon: 'error',
            title: '程序遇到意外错误',
            html: `<div style="text-align:left; font-size:12px; color:#666;">
                    <strong>错误信息:</strong> ${msg}<br>
                    <strong>位置:</strong> Line ${lineNo}<br><br>
                    建议操作：<br>1. 刷新页面重试<br>2. 检查上传的 Excel 是否格式正确<br>3. 点击下方按钮尝试清空缓存
                   </div>`,
            showCancelButton: true,
            confirmButtonText: '刷新页面',
            cancelButtonText: '清空缓存并刷新',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33'
        }).then((result) => {
            if (result.isDismissed) { // 用户点击了“清空缓存”
                idbKeyval.del('autosave_backup').then(() => location.reload());
            } else {
                location.reload();
            }
        });
        return true; // 阻止默认的控制台报错
    }
    return false;
};
    // Alpine.js 数据仓库初始化
    document.addEventListener('alpine:init', () => {
        Alpine.store('teacherData', {
            list: [], // 存放扁平化的教师数据
            
            // 更新数据的逻辑 (供旧代码调用)
            update(statsObj, rankingObj) {
                const arr = [];
                // 将复杂的嵌套对象转换为数组，方便前端循环
                if (statsObj && Object.keys(statsObj).length > 0) {
                    Object.keys(statsObj).sort().forEach(teacher => {
                        Object.keys(statsObj[teacher]).sort((a,b)=>a.localeCompare(b)).forEach(subject => {
                            const data = statsObj[teacher][subject];
                            // 计算评级样式
                            let badgeClass = 'performance-poor', badgeText = '需改进';
                            const avg = parseFloat(data.avg), exc = data.excellentRate*100, pass = data.passRate*100;
                            if (avg>=85 && exc>=30 && pass>=90) { badgeClass='performance-excellent'; badgeText='优秀'; }
                            else if (avg>=80 && exc>=25 && pass>=85) { badgeClass='performance-good'; badgeText='良好'; }
                            else if (avg>=75 && exc>=20 && pass>=80) { badgeClass='performance-average'; badgeText='中等'; }

                            // 获取排名
                            const rank = (rankingObj && rankingObj[teacher] && rankingObj[teacher][subject]) 
                                         ? rankingObj[teacher][subject].rank : '-';

                            arr.push({
                                id: `${teacher}-${subject}`, // 唯一键
                                name: teacher,
                                subject: subject,
                                classes: data.classes,
                                avg: data.avg,
                                excRate: (data.excellentRate * 100).toFixed(1) + '%',
                                passRate: (data.passRate * 100).toFixed(1) + '%',
                                count: data.studentCount,
                                rank: rank,
                                badgeClass: badgeClass,
                                badgeText: badgeText
                            });
                        });
                    });
                }
                this.list = arr;
            }
        });
    });
    // 深色模式切换逻辑
     function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme-dark', isDark);
        // 定义颜色变量
        const textColor = isDark ? '#cbd5e1' : '#666';
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

        // 更新 Chart.js 全局默认配置
        if (window.Chart) {
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
        }

        // 刷新页面上已存在的特定图表实例
        // 注意：这里列出了你代码中定义过的所有图表实例变量
        const charts = [
            window.radarChartInstance, 
            window.historyChartInstance, 
            window.varianceChartInstance, 
            window.segmentChartInstance, 
            window.balanceChartInstance,
            window.schoolRadarInstance,
            window.schoolDistInstance,
            window.sankeyChartInstance, // 桑基图
            window.trendChartInstance   // 散点图
        ];

        charts.forEach(chart => {
            if (chart) {
                // 更新图表配置
                chart.options.scales.x && (chart.options.scales.x.grid.color = gridColor);
                chart.options.scales.y && (chart.options.scales.y.grid.color = gridColor);
                
                // 特殊处理雷达图
                if (chart.config.type === 'radar') {
                    chart.options.scales.r.grid.color = gridColor;
                    chart.options.scales.r.pointLabels.color = textColor;
                }
                
                chart.update(); // 重绘
            }
        });
        
        // 提示用户
        if(window.UI) UI.toast(isDark ? "🌙 已切换深色模式" : "☀️ 已切换浅色模式");
    }

    function openSpotlight() {
        document.getElementById('spotlight-mask').style.display = 'flex';
        document.getElementById('spotlight-input').focus();
    }

    function closeSpotlight() {
        document.getElementById('spotlight-mask').style.display = 'none';
    }

    function jumpToStudent(name, school, cls) {
        closeSpotlight();
        switchTab('report-generator');
        const schSel = document.getElementById('sel-school');
        schSel.value = school;
        updateClassSelect(); // 触发更新班级下拉框
        setTimeout(() => {
            document.getElementById('sel-class').value = cls;
            document.getElementById('inp-name').value = name;
            doQuery();
        }, 100);
    }

    function showCertificate(name, honorType) {
        document.getElementById('cert-name').innerText = name;
        document.getElementById('cert-honor').innerText = honorType;
        document.getElementById('cert-exam-name').innerText = CONFIG.name || "本次考试";
        document.getElementById('cert-school-footer').innerText = MY_SCHOOL || "教务处";
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString();
        document.getElementById('cert-modal').style.display = 'flex';
    }

    async function downloadCertificate() {
        const area = document.getElementById('cert-capture-area');
        const canvas = await html2canvas(area, { scale: 2 });
        const link = document.createElement('a');
        link.download = `奖状_${document.getElementById('cert-name').innerText}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
    const UI = {
        // 1. 加载动画控制
        loading: (show, text = '系统正在处理数据...') => {
            const loader = document.getElementById('global-loader');
            const txt = document.getElementById('loader-text');
            if (show) {
                if(txt) txt.innerText = text;
                loader.classList.remove('hidden');
            } else {
                setTimeout(() => loader.classList.add('hidden'), 200); // 稍微延迟防止闪烁
            }
        },
        // 2. 消息提示控制
        toast: (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            let icon = 'ℹ️';
            if(type === 'success' || msg.includes('成功') || msg.includes('✅')) { type = 'success'; icon = '✅'; }
            if(type === 'error' || msg.includes('失败') || msg.includes('错误') || msg.includes('❌')) { type = 'error'; icon = '❌'; }
            div.className = `toast-msg toast-${type}`;
            div.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateY(-20px)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }
    };

    // 🔐 权限与账号管理系统核心
    const Auth = {
        currentUser: null,
        
        // 模拟数据库 (实际存储在 localStorage 'SYS_USERS')
        db: JSON.parse(localStorage.getItem('SYS_USERS')) || {
            admin: { pass: 'admin123' }, 
            teachers: [],
            parents: []
        },

        // 初始化：检查会话状态
        init: function() {
            const session = sessionStorage.getItem('CURRENT_USER');
            if(session) {
                this.currentUser = JSON.parse(session);
                this.applyRoleView();
                document.getElementById('login-overlay').style.display = 'none';
                
                // 如果是家长，恢复视图
                if(this.currentUser.role === 'parent' && typeof RAW_DATA !== 'undefined' && RAW_DATA.length > 0) {
                    this.renderParentView();
                } 
                // 🟢 补充：如果是其他角色，恢复主视图 (防止刷新后空白)
                else if (this.currentUser.role !== 'parent') {
                    document.getElementById('app').classList.remove('hidden');
                    if(typeof renderNavigation === 'function') renderNavigation();
                }
            }
        },

        /* 👇👇👇 ✋ 🟢 [此处开始替换] 重写 login 函数 (登录后立即刷新主界面) 🟢 ✋ 👇👇👇 */
        
        // 🟢 核心登录逻辑：改为查 Supabase 数据库 (已修复 406 报错 + 增加班级强校验)
    login: async function() {
        const user = document.getElementById('login-user').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        // 获取输入的班级 (去除空格)
        const inputClass = document.getElementById('login-class').value.trim();
        
        if(!user || !pass) return UI.toast('请输入账号和密码', 'error');

        UI.loading(true, "正在验证身份...");

        try {
            // 1. 查询数据库 (使用新变量 sbClient)
            // 🔴 改动点：使用 .maybeSingle() 代替 .single()
            const { data, error } = await sbClient
                .from('system_users')
                .select('*')
                .eq('username', user)
                .eq('password', pass) // 简单明文匹配
                .maybeSingle(); 

            UI.loading(false);

            // 2. 检查是否有系统级错误
            if (error) {
                console.error("Database Login Error:", error);
                return alert("系统连接错误：" + error.message);
            }

            // 3. 检查是否找到了用户
            if (!data) {
                return alert("❌ 登录失败！\n\n可能原因：\n1. 账号或密码错误\n2. 管理员尚未将账号【同步到云端】");
            }

            /* 👇👇👇 🟢 新增代码：家长角色强制校验班级 🟢 👇👇👇 */
            if (data.role === 'parent') {
                if (!inputClass) {
                    return alert("❌ 登录失败：家长/学生必须输入【班级】才能登录。");
                }
                
                // 对比输入的班级和数据库存的班级 (去除空格后比较，防止 '701 ' 和 '701' 不匹配)
                // data.class_name 是数据库里的列名
                const dbClass = (data.class_name || "").toString().replace(/\s+/g, "");
                const userClass = inputClass.toString().replace(/\s+/g, "");

                if (dbClass !== userClass) {
                    return alert(`❌ 班级不匹配！\n\n您输入的班级：${inputClass}\n系统记录的班级：${data.class_name || '未录入'}\n\n请核对后重试。`);
                }
            }
            /* 👆👆👆 🟢 结束 🟢 👆👆👆 */

            // 4. 登录成功，构建用户对象
            const matchedUser = {
                name: data.username,
                role: data.role,
                school: data.school,
                class: data.class_name // 数据库字段名
            };

            this.currentUser = matchedUser;
            sessionStorage.setItem('CURRENT_USER', JSON.stringify(matchedUser));
            sessionStorage.setItem('CURRENT_ROLE', matchedUser.role); 
setTimeout(() => {
    loadCloudData();
}, 200);

            // 界面切换
            this.applyRoleView();
            updateAdminOnlyButtons();
            updateWatermark();

            // === 🛡️ 安全检查：强制修改默认密码 ===
            // 默认密码定义：教师是 yssy2016，其他人是 123456
            const isDefaultPass = (matchedUser.role === 'teacher' && pass === 'yssy2016') || pass === '123456';
            
            if (isDefaultPass) {
                document.getElementById('login-overlay').style.display = 'none'; // 先关掉登录框
                
                // 弹出提示
                alert("⚠️ 安全警告：\n检测到您正在使用默认密码！\n为了保障账号安全，首次登录必须修改密码。");
                
                // 打开修改密码弹窗 (传入 true 表示强制模式)
                setTimeout(() => openUserPasswordModal(true), 500);
                return; // ⛔ 终止后续加载，直到密码修改完成
            }
            // === 🛡️ 安全检查结束 ===
            document.getElementById('login-overlay').style.display = 'none';
            
            if(window.UI) UI.toast(`登录成功！欢迎 ${matchedUser.name}`, 'success');

            // 5. 【关键】拉取云端数据
            UI.loading(true, "正在同步最新成绩数据...");
            await loadCloudData();
            UI.loading(false);

            // 6. 分流跳转与权限初始化
            if(matchedUser.role === 'parent') {
                // === 家长模式 ===
                this.renderParentView();
            } else {
                // === 教职工模式 (管理员/主任/教师/班主任/级部主任) ===
                document.getElementById('app').classList.remove('hidden');
                
                // 初始化导航和表格
                if(typeof renderNavigation === 'function') renderNavigation();
                if(typeof updateSchoolSelect === 'function') updateSchoolSelect();
                if(typeof renderTables === 'function') renderTables();

                // 7. 届别自动记忆/选择
                if (typeof CohortManager !== 'undefined') {
                    CohortManager.init();
                    applyUserCohortPreference();
                }

                // 👇👇👇 🟢 新增：角色专属初始化逻辑 🟢 👇👇👇
                
                // A. 如果有学校绑定 (除管理员外通常都有)
                if (matchedUser.school) {
                    // 自动设置本校全局变量
                    window.MY_SCHOOL = matchedUser.school; 
                    
                    // 尝试更新界面上的“选择本校”下拉框
                    const sel = document.getElementById('mySchoolSelect');
                    if(sel) { 
                        sel.value = matchedUser.school; 
                        // 触发一次 change 事件以更新相关下拉框 (如班级列表)
                        sel.dispatchEvent(new Event('change')); 
                    }
                }

                // B. 角色权限细分处理
                if (matchedUser.role === 'teacher') {
                    // 普通教师：后续将在 renderStudentDetails 中过滤只能看自己教的课
                    UI.toast(`欢迎您，${matchedUser.name}老师`, "success");
                } 
                else if (matchedUser.role === 'class_teacher') {
                    // 班主任：后续将在 renderStudentDetails 中过滤只能看本班
                    UI.toast(`欢迎您，${matchedUser.class}班班主任`, "success");
                    
                    // 尝试自动定位到“学生档案查询”模块的班级筛选
                    setTimeout(() => {
                        const clsSel = document.getElementById('studentClassSelect');
                        if(clsSel) {
                            clsSel.value = matchedUser.class;
                            clsSel.dispatchEvent(new Event('change')); // 触发筛选
                        }
                    }, 500);
                }
                else if (matchedUser.role === 'grade_director') {
                    // 级部主任：
                    // 1. 拥有修改成绩权限 (在 updateStudentScore 中控制)
                    // 2. 能接收消息 (需显示铃铛按钮)
                    // 3. 只能看本级部 (在 renderStudentDetails 中控制)
                    
                    UI.toast(`欢迎您，${matchedUser.class}年级主任`, "success");
                    
                    // 开启消息轮询 (复用管理员的逻辑)
                    const msgBtn = document.getElementById('admin-msg-btn');
                    if(msgBtn) msgBtn.style.display = 'block'; // 显示铃铛
                    
                    if (typeof IssueManager !== 'undefined') {
                        IssueManager.checkIssues(); // 立即查一次
                        // 每30秒轮询一次新消息
                        setInterval(() => IssueManager.checkIssues(), 30000);
                    }
                }
                /* 👆👆👆 🟢 结束 🟢 👆👆👆 */
            }

        } catch (err) {
            UI.loading(false);
            console.error(err);
            alert("登录异常中断：" + err.message);
        }
    },

        // 登出
        logout: function() {
            sessionStorage.removeItem('CURRENT_USER');
            location.reload(); // 刷新页面最彻底，清除所有临时状态
        },

        // 应用视图权限 (配合 CSS data-role 属性)
        applyRoleView: function() {
            if(!this.currentUser) return;
            const role = this.currentUser.role;
            document.body.dataset.role = role;

            const msgBtn = document.getElementById('admin-msg-btn');
            if (msgBtn) {
                // 🟢 修改：允许 管理员、教务主任、级部主任、班主任 看到铃铛
                // 只有这些角色有资格处理申诉或查看通知
                if (role === 'admin' || role === 'director' || role === 'grade_director' || role === 'class_teacher') {
                    msgBtn.style.display = 'block';
                    
                    // 启动消息轮询 (每30秒查一次，检查 IssueManager 是否已加载)
                    if (typeof IssueManager !== 'undefined') {
                        IssueManager.checkIssues();
                        // 清除旧定时器防止重复
                        if (window.msgInterval) clearInterval(window.msgInterval);
                        window.msgInterval = setInterval(() => IssueManager.checkIssues(), 30000);
                    }
                } else {
                    msgBtn.style.display = 'none';
                }
            }

            // 添加或更新悬浮个人中心条 (包含修改密码)
        let btn = document.getElementById('logout-btn');
        
        if(!btn) {
            btn = document.createElement('div');
            btn.id = 'logout-btn';
            // 增加一点样式调整，让它更像一个工具条
            btn.style.display = 'flex';
            btn.style.gap = '10px';
            btn.style.alignItems = 'center';
            document.body.appendChild(btn);
        }

        // 渲染两个按钮：修改密码 | 退出
        btn.innerHTML = `
            <span onclick="openUserPasswordModal()" style="cursor:pointer; border-right:1px solid rgba(255,255,255,0.3); padding-right:10px; display:flex; align-items:center; gap:4px;" title="修改密码">
                <i class="ti ti-key"></i> 密码
            </span>
            <span onclick="Auth.logout()" style="cursor:pointer; display:flex; align-items:center; gap:4px;" title="退出登录">
                <i class="ti ti-logout"></i> ${this.currentUser.name}
            </span>
        `;
        
        // 注意：这里移除了 btn.onclick，因为点击事件直接写在 span 里的 HTML 中了
// 🟢 [新增] 动态添加“账号管理”入口按钮 (针对有权用户)
            // 1. 获取当前用户角色
            const currentRole = this.currentUser.role;
            const allowedRoles = ['admin', 'director', 'grade_director', 'class_teacher'];
            
            // 2. 查找 header 里的工具栏容器 (通常是 header 的最后一个子元素的最后一个 div)
            // 根据 CSS 结构: header > div(flex) > div(toolbar)
            const toolbar = document.querySelector('header > div > div:last-child');
            
            // 3. 先移除旧按钮(防止重复添加)
            const oldBtn = document.getElementById('header-acc-mgr-btn');
            if(oldBtn) oldBtn.remove();

            // 4. 如果有权限且容器存在，插入按钮
            if (toolbar && allowedRoles.includes(currentRole)) {
                const mgrBtn = document.createElement('button');
                mgrBtn.id = 'header-acc-mgr-btn';
                mgrBtn.className = 'btn';
                // 样式微调：半透明背景，白色文字
                mgrBtn.style.cssText = 'background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; margin-right:5px; font-size:12px; padding:6px 12px; display:inline-flex; align-items:center; gap:5px;';
                mgrBtn.innerHTML = '<i class="ti ti-user-cog"></i> 账号';
                mgrBtn.title = "管理账号 / 重置密码";
                
                // 绑定点击事件：打开账号管理弹窗
                mgrBtn.onclick = () => AccountManager.open();
                
                // 5. 将按钮插入到工具栏的最前面 (作为第一个按钮显示)
                // 也可以改为 insertBefore 到特定按钮前，这里放最前比较显眼
                if (toolbar.firstChild) {
                    toolbar.insertBefore(mgrBtn, toolbar.firstChild);
                } else {
                    toolbar.appendChild(mgrBtn);
                }
            }
            // 🟢 [修正]：将以下代码移入 applyRoleView 函数内部，接在上面的代码后面

            // 🟢 [新增] 动态添加“数据管理”入口 (仅限 管理员/教务主任)
            const dataRoles = ['admin', 'director'];
            
            // 先移除旧按钮(防止重复)
            const oldDataBtn = document.getElementById('header-data-mgr-btn');
            if(oldDataBtn) oldDataBtn.remove();

            // 如果有权限且容器存在
            // 注意：这里的 role 和 toolbar 变量继承自 applyRoleView 函数顶部的定义
            if (toolbar && dataRoles.includes(role)) {
                const dataBtn = document.createElement('button');
                dataBtn.id = 'header-data-mgr-btn';
                dataBtn.className = 'btn';
                // 样式：紫色背景，区别于账号管理
                dataBtn.style.cssText = 'background:rgba(124, 58, 237, 0.4); border:1px solid rgba(255,255,255,0.4); color:white; margin-right:5px; font-size:12px; padding:6px 12px; display:inline-flex; align-items:center; gap:5px;';
                dataBtn.innerHTML = '<i class="ti ti-database-edit"></i> 数据';
                dataBtn.title = "管理原始成绩和教师设置";
                
                // 绑定点击事件
                dataBtn.onclick = () => DataManager.open();
                
                // 插入到工具栏最前面 (作为最高频功能，排在账号按钮前面)
                if (toolbar.firstChild) {
                    toolbar.insertBefore(dataBtn, toolbar.firstChild);
                } else {
                    toolbar.appendChild(dataBtn);
                }
            }
            
    },

        // 👨‍👩‍👧 渲染家长专属视图 (完全隔离)
        renderParentView: function() {
            // 1. 彻底隐藏主界面及所有干扰元素 (防止透视)
            const app = document.getElementById('app');
            const header = document.querySelector('header');
            const nav = document.querySelector('.nav-wrapper');
            const overlay = document.getElementById('login-overlay');
            const loader = document.getElementById('global-loader');

            if(app) app.style.display = 'none'; // 关键：隐藏主应用
            if(header) header.style.display = 'none';
            if(nav) nav.style.display = 'none';
            if(overlay) overlay.style.display = 'none';
            if(loader) loader.classList.add('hidden');

            // 2. 创建或重置家长容器
            let container = document.getElementById('parent-view-container');
            if(!container) {
                container = document.createElement('div');
                container.id = 'parent-view-container';
                document.body.appendChild(container);
            }
            
            // 确保容器可见
            container.style.display = 'block';

            // 3. 移动端视口适配 (防止表格太宽看不全)
            let viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes');
            }

            // A. 立即渲染骨架屏 (Skeleton Screen)
            container.innerHTML = `
                <div class="sk-card skeleton"><div class="sk-header"></div></div>
                <div class="sk-card skeleton"><div class="sk-block" style="width:80%"></div></div>
                <div style="display:flex; gap:10px;">
                    <div class="sk-card skeleton" style="flex:1;"><div class="sk-chart"></div></div>
                    <div class="sk-card skeleton" style="flex:1;"><div class="sk-chart"></div></div>
                </div>
            `;

            // 延时加载数据，给骨架屏一点展示时间
            setTimeout(() => {
                if(!RAW_DATA || RAW_DATA.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:50px; color:#666;">
                        <i class="ti ti-database-off" style="font-size:48px; margin-bottom:10px; display:block;"></i>
                        数据加载中...<br><small>请稍候 (如长时间无反应请刷新)</small>
                    </div>`;
                    return;
                }

                // 精确查找：姓名 + 班级
                const stu = RAW_DATA.find(s => s.name === this.currentUser.name && s.class === this.currentUser.class);
                
                if(!stu) {
                    container.innerHTML = `<div style="text-align:center; padding:50px; color:red;">
                        ❌ 未找到学生【${this.currentUser.name}】（${this.currentUser.class}班）的数据。<br>
                        请联系班主任确认名单是否已上传。
                    </div>`;
                    return;
                }

                // 渲染报表 HTML
                let reportHtml = renderSingleReportCardHTML(stu, 'H5');
                
                // 去除不必要的按钮和输入框
                reportHtml = reportHtml.replace(/<button.*AI 深度生成.*<\/button>/, '');
                const teacherName = TEACHER_MAP[stu.class+'_班主任'] || '班主任';
                reportHtml = reportHtml.replace(/<input.*id="inp-teacher-name".*?>/, `<span style="font-weight:bold">${teacherName}</span>`);

                                // 安全处理：防止姓名或班级中有引号导致 JS 报错
                const safeName = stu.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeClass = stu.class.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeSchool = stu.school.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                // 追加底部功能栏 (申诉 & 退出)
                reportHtml += `
                    <div style="text-align:center; margin-top:30px; padding-bottom:80px; border-top:1px dashed #e5e7eb; padding-top:20px;">
                        <p style="font-size:14px; color:#64748b; margin-bottom:15px;">数据有疑问？</p>
                        
                        <!-- 核心修复：使用转义后的变量 -->
                        <button class="btn" style="background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; font-size:16px; padding:10px 20px; margin-bottom:20px;" 
                                onclick="IssueManager.openSubmitModal('${safeName}', '${safeClass}', '${safeSchool}')">
                            <i class="ti ti-alert-circle"></i> 申请成绩核查
                        </button>
                        
                        <br>
                        <button onclick="Auth.logout()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; font-size:14px; cursor:pointer;">
                            退出登录
                        </button>
                    </div>
                `;

                container.innerHTML = reportHtml;

                // 渲染图表 (Canvas)
                setTimeout(() => {
                    try {
                        if(typeof renderRadarChart === 'function') renderRadarChart(stu);                        
                        if(typeof renderVarianceChart === 'function') renderVarianceChart(stu);
                    } catch(e) { console.error("图表渲染失败:", e); }
                }, 200);

            }, 500); 
        },

        // 辅助：渲染生成账号时的学校列表
        renderSchoolCheckboxes: function() {
            const container = document.getElementById('admin-gen-school-list');
            if(!container) return; // 如果找不到容器（比如非管理员），直接返回，不报错
            
            if(typeof SCHOOLS === 'undefined' || Object.keys(SCHOOLS).length === 0) {
                container.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">暂无数据，请先上传成绩</div>';
                return;
            }

            let html = '';
            Object.keys(SCHOOLS).forEach(sch => {
                html += `
                    <label style="display:flex; align-items:center; margin-bottom:3px; cursor:pointer;">
                        <input type="checkbox" class="gen-school-check" value="${sch}" checked>
                        <span style="margin-left:5px;">${sch}</span>
                    </label>
                `;
            });
            container.innerHTML = html;
        },

        // 辅助：全选/反选
        toggleAllSchools: function(check) {
            document.querySelectorAll('.gen-school-check').forEach(el => el.checked = check);
        },

        // 🛠️ 管理员工具：批量生成账号 (支持指定学校增量更新)
        generateAccounts: function() {
            if(!RAW_DATA.length) return alert("请先在【数据中心】上传成绩数据");
            
            // 1. 获取界面上勾选的学校
            const checkboxes = document.querySelectorAll('.gen-school-check:checked');
            const selectedSchools = Array.from(checkboxes).map(cb => cb.value);

            if(selectedSchools.length === 0) {
                return alert("请至少勾选一所学校！\n(如果列表为空，请先上传数据)");
            }
            
            if(!confirm(`⚠️ 确定要为选中的 [${selectedSchools.length}] 所学校生成账号吗？\n\n1. 仅生成/更新选中学校的学生和老师账号。\n2. 未选中学校的现有账号将【保留】。\n3. 默认初始密码均为 123456。`)) return;

            let countParentNew = 0;
            let countParentUpd = 0;
            let countTeacherNew = 0;

            // --- A. 生成家长账号 (增量更新) ---
            // 策略：遍历数据，如果该学生属于选中学校，则更新/添加；否则不动。
            
            // 筛选出属于选中學校的学生
            const targetStudents = RAW_DATA.filter(s => selectedSchools.includes(s.school));
            
            targetStudents.forEach(s => {
                // 检查是否已存在账号 (唯一键：姓名+班级)
                const existIdx = this.db.parents.findIndex(p => p.name === s.name && p.class === s.class);
                
                const newAccount = {
                    name: s.name,
                    class: s.class,
                    pass: '123456' // 默认密码
                };

                if (existIdx >= 0) {
                    // 已存在，强制重置密码为默认 (也可选择不重置，看需求)
                    this.db.parents[existIdx] = newAccount; 
                    countParentUpd++;
                } else {
                    // 不存在，添加
                    this.db.parents.push(newAccount);
                    countParentNew++;
                }
            });

            // --- B. 生成教师账号 (增量更新) ---
            // 策略：先找到选中学校涉及的所有班级，再反查 TEACHER_MAP 里的老师
            const targetClasses = new Set();
            targetStudents.forEach(s => targetClasses.add(s.class));
            
            // 收集涉及到的老师名字 (去重)
            let targetTeachers = new Set();
            if(Object.keys(TEACHER_MAP).length > 0) {
                Object.keys(TEACHER_MAP).forEach(key => {
                    // key 格式通常为 "701_语文" 或 "701_班主任"
                    const [cls, sub] = key.split('_');
                    // 如果这个班级属于选中的学校
                    if (targetClasses.has(cls)) {
                        targetTeachers.add(TEACHER_MAP[key]);
                    }
                });
            } else {
                console.warn("未配置教师任课表，仅能生成家长账号");
            }

            targetTeachers.forEach(tName => {
                // 检查是否存在
                const existIdx = this.db.teachers.findIndex(t => t.name === tName);
                const newAccount = {
                    name: tName,
                    pass: 'yssy2016', // 🟢 修改点：将 '123456' 改为 'yssy2016'
                    grade: 'all'
                };

                if (existIdx >= 0) {
                    // 教师账号通常跨年级，如果已存在，一般不重置密码，或者也重置
                    this.db.teachers[existIdx].pass = 'yssy2016'; // 🟢 修改点：将 '123456' 改为 'yssy2016'
                } else {
                    this.db.teachers.push(newAccount);
                    countTeacherNew++;
                }
            });

            // 4. 保存结果到本地存储
            localStorage.setItem('SYS_USERS', JSON.stringify(this.db));
            
            let msg = `✅ 操作完成！\n\n`;
            msg += `覆盖学校：${selectedSchools.join(', ')}\n`;
            msg += `家长账号：新增 ${countParentNew} / 重置 ${countParentUpd}\n`;
            msg += `教师账号：新增 ${countTeacherNew} / 涉及 ${targetTeachers.size}\n`;
            msg += `\n(提示：未选中学校的旧账号已自动保留)`;
            
            // 🚫 已注释掉成功后的弹窗，避免干扰
            // alert(msg);
            
            // 仅在右下角显示轻提示
            if(window.UI) UI.toast("✅ 账号生成操作完成", "success");
        },


         // 🛠️ 管理员工具：导出账号明细 (新功能)
        exportAccounts: function() {
            if(!this.db.teachers.length && !this.db.parents.length) {
                return alert("当前没有生成任何普通账号，请先点击“一键生成”。");
            }

            // 1. 获取界面上勾选的学校
            const checkboxes = document.querySelectorAll('.gen-school-check:checked');
            const selectedSchools = Array.from(checkboxes).map(cb => cb.value);
            
            // 判断是否启用了筛选 (如果有勾选，且勾选数量小于总学校数，则视为筛选)
            // 逻辑优化：只要有勾选，就只导出勾选的；如果一个都没勾(或全没勾)，则导出全部
            const isFiltering = selectedSchools.length > 0;

            const wb = XLSX.utils.book_new();
            // 表头增加一列 "所属学校 (仅导出时计算)"
            const data = [['角色', '用户名/姓名', '登录班级 (家长必填)', '密码', '所属学校/备注']];

            // --- A. 写入管理员/主任 (始终导出，不受筛选影响) ---
            data.push(['管理员', 'admin', '-', this.db.admin.pass, '最高权限']);
            const dirPass = this.db.director ? this.db.director.pass : 'admin123';
            data.push(['教务主任', 'director', '-', dirPass, '查看除账号外所有信息']);

            // --- 准备筛选辅助数据 ---
            let validClasses = new Set();   // 选中学校包含的所有班级
            
            if (isFiltering) {
                // 遍历 RAW_DATA 构建白名单，比每次 find 快
                RAW_DATA.forEach(s => {
                    if (selectedSchools.includes(s.school)) {
                        validClasses.add(s.class);
                    }
                });
            }

            // --- B. 写入教师信息 ---
            let teacherCount = 0;
            this.db.teachers.forEach(t => {
                let shouldExport = true;
                if (isFiltering) {
                    // 检查该老师是否任教于选中的学校 (通过班级反查)
                    let isRelevant = false;
                    // 遍历 TEACHER_MAP 查找该老师教的班级
                    for (const [key, tName] of Object.entries(TEACHER_MAP)) {
                        if (tName === t.name) {
                            const [cls, sub] = key.split('_');
                            if (validClasses.has(cls)) {
                                isRelevant = true;
                                break;
                            }
                        }
                    }
                    shouldExport = isRelevant;
                }

                if (shouldExport) {
                    data.push(['教师', t.name, '-', t.pass, isFiltering ? '关联选中学校' : '']);
                    teacherCount++;
                }
            });

            // --- C. 写入家长信息 ---
            let parentCount = 0;
            this.db.parents.forEach(p => {
                let shouldExport = true;
                let schoolName = '';

                // 尝试找回学校名以便填写在备注里 (账号库里没存学校，需要回查 RAW_DATA)
                const stuRecord = RAW_DATA.find(r => r.name === p.name && r.class === p.class);
                if (stuRecord) schoolName = stuRecord.school;

                if (isFiltering) {
                    // 只有当学生属于选中学校时才导出
                    if (stuRecord && selectedSchools.includes(stuRecord.school)) {
                        shouldExport = true;
                    } else {
                        shouldExport = false;
                    }
                }

                if (shouldExport) {
                    data.push(['家长', p.name, p.class, p.pass, schoolName || '未知/已删除']);
                    parentCount++;
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:10}, {wch:20}, {wch:15}, {wch:15}, {wch:25}];
            
            let fileName = `账号清单_${new Date().toLocaleDateString()}.xlsx`;
            if (isFiltering) {
                // 如果只选了一个学校，文件名带上学校名
                if (selectedSchools.length === 1) fileName = `${selectedSchools[0]}_账号清单.xlsx`;
                else fileName = `特定学校账号清单(共${selectedSchools.length}校).xlsx`;
            }

            XLSX.utils.book_append_sheet(wb, ws, "账号列表");
            XLSX.writeFile(wb, fileName);
            
            // 🚫 已注释掉导出成功后的弹窗
            /*
            if (isFiltering) {
                alert(`✅ 已导出选定范围的账号：\n教师: ${teacherCount} 人\n家长: ${parentCount} 人`);
            }
            */
        },
  
// 🟢 [新增] 向云端数据库添加账号
        
        // 🟢 [修改] 适配级部主任和班主任的手动添加
        addCloudAccount: async function() {
            const role = document.getElementById('manual-role').value;
            const username = document.getElementById('manual-name').value.trim();
            const password = document.getElementById('manual-pass').value.trim();
            const school = document.getElementById('manual-school').value.trim();
            
            // 获取各个输入框的元素
            const classInput = document.getElementById('manual-class');
            const gradeInput = document.getElementById('manual-grade');

            // 根据角色获取 "class_name" 字段应该存什么
            let className = "";
            
            if (role === 'parent' || role === 'class_teacher') {
                // 必须检查元素是否存在
                if(classInput) className = classInput.value.trim(); 
            } 
            else if (role === 'grade_director') {
                // 必须检查元素是否存在
                if(gradeInput) className = gradeInput.value.trim(); 
            }
            // 普通教师给一个默认值，防止数据库非空报错
            else if (role === 'teacher') {
                className = "教师"; 
            }

            // --- 校验逻辑 ---
            // 1. 账号密码必填
            if (!username || !password) return alert("❌ 请填写账号和密码");
            
            // 2. 学校必填 (除了管理员)
            if (role !== 'admin' && !school) return alert("❌ 请填写所属学校");

            // 3. 班级/年级必填校验
            if ((role === 'parent' || role === 'class_teacher') && !className) {
                return alert("❌ 请填写【班级】(例如: 701)");
            }
            if (role === 'grade_director' && !className) {
                return alert("❌ 请填写【级部/年级】(例如: 7)");
            }

            UI.loading(true, "正在写入数据库...");

            const newUserData = {
                username: username,
                password: password,
                role: role,
                school: role === 'admin' ? '系统' : school, // 管理员默认学校
                class_name: className // 这是一个复用字段：对家长/班主任是班级，对级部主任是年级
            };

            // 执行插入 (使用 upsert 以便支持“更新”操作，即覆盖旧账号)
            const { error } = await sbClient
                .from('system_users')
                .upsert(newUserData, { onConflict: 'username' });

            UI.loading(false);

            if (error) {
                console.error(error);
                alert("❌ 操作失败：" + error.message);
            } else {
                UI.toast(`✅ 账号 [${username}] 已添加/更新成功！`, "success");
                // 清空姓名输入框，方便继续添加
                document.getElementById('manual-name').value = '';
                // 如果是家长，不清空班级，方便连续添加同班学生
                if(role !== 'parent') {
                     if(classInput) classInput.value = '';
                     if(gradeInput) gradeInput.value = '';
                }
            }
        },
// 🛠️ 管理员工具：批量同步本地生成的账号到云端 (V4 智能容错版)
        // 特性：自动去重 + 失败自动降级为单条上传 + 精确报错
        syncBatchToCloud: async function() {
            if (!sbClient) return alert("❌ 云端数据库连接失败。");

            const parents = this.db.parents || [];
            const teachers = this.db.teachers || [];
            
            if (parents.length === 0 && teachers.length === 0) {
                return alert("⚠️ 本地账号为空！请先点击【👤 一键生成所有账号】。");
            }

            if (!confirm(`⚠️ 准备同步账号到云端：\n\n👨‍👩‍👧 家长：${parents.length}\n👨‍🏫 教师：${teachers.length}\n\n确定覆盖云端数据吗？`)) return;

            UI.loading(true, "正在清洗并去重数据...");

            // 1. 构建映射表与去重容器
            const uniqueMap = new Map(); // key: username, value: dataObj
            const globalDefaultSchool = window.MY_SCHOOL || "默认学校";
            
            // 辅助：查找学校
            const getSchool = (name, cls) => {
                // 尝试从 RAW_DATA 查找准确学校
                if(typeof RAW_DATA !== 'undefined') {
                    const s = RAW_DATA.find(r => r.name === name && r.class == cls);
                    if(s) return s.school;
                }
                return globalDefaultSchool;
            };

            // 辅助：强力清洗字符串 (去空格、去特殊符)
            const cleanStr = (str) => String(str || "").trim().replace(/\s+/g, "");

            // --- A. 处理家长数据 ---
            parents.forEach(p => {
                const user = cleanStr(p.name);
                if(!user) return;
                
                uniqueMap.set(user, {
                    username: user,
                    password: cleanStr(p.pass) || "123456",
                    role: 'parent',
                    school: getSchool(p.name, p.class),
                    class_name: cleanStr(p.class) // 班级
                });
            });

            // --- B. 处理教师数据 (优先级高，覆盖同名家长) ---
            // 预处理教师学校映射
            const teaSchMap = {};
            if(typeof TEACHER_MAP !== 'undefined') {
                Object.entries(TEACHER_MAP).forEach(([k, v]) => {
                    const cls = k.split('_')[0];
                    // 简易反查：遍历学校找班级
                    if(typeof SCHOOLS !== 'undefined') {
                        for(let sName in SCHOOLS) {
                            if(SCHOOLS[sName].students.some(s => s.class == cls)) {
                                teaSchMap[v] = sName; break;
                            }
                        }
                    }
                });
            }

            teachers.forEach(t => {
                const user = cleanStr(t.name);
                if(!user) return;

                uniqueMap.set(user, { // 写入 Map，自动覆盖同名 Key
                    username: user,
                    password: cleanStr(t.pass) || "123456",
                    role: 'teacher',
                    school: teaSchMap[t.name] || globalDefaultSchool,
                    class_name: '教师'
                });
            });

            const batchData = Array.from(uniqueMap.values());
            console.log(`[同步准备] 原始:${parents.length+teachers.length} -> 去重后:${batchData.length}`);

            // --- C. 智能分批上传 ---
            const BATCH_SIZE = 10; // 保守批次大小
            let successCount = 0;
            let failCount = 0;
            let errorDetails = [];

            // 定义单条重试函数
            const uploadOneByOne = async (items) => {
                let ok = 0;
                for(let item of items) {
                    const { error } = await sbClient.from('system_users').upsert(item, { onConflict: 'username' });
                    if(error) {
                        console.warn(`❌ 单条写入失败 [${item.username}]:`, error.message);
                        failCount++;
                        errorDetails.push(`${item.username}: ${error.message}`);
                    } else {
                        ok++;
                        successCount++;
                    }
                }
                return ok;
            };

            try {
                for (let i = 0; i < batchData.length; i += BATCH_SIZE) {
                    const chunk = batchData.slice(i, i + BATCH_SIZE);
                    
                    // 1. 尝试批量写入
                    const { error } = await sbClient.from('system_users').upsert(chunk, { onConflict: 'username' });

                    const pct = Math.round(((i + chunk.length) / batchData.length) * 100);
                    
                    if (error) {
                        console.warn(`⚠️ 批次 ${Math.ceil(i/BATCH_SIZE)+1} 报错 (HTTP 500/409)，自动降级为单条上传模式...`);
                        // 2. 批量失败，自动降级为单条循环
                        await uploadOneByOne(chunk);
                    } else {
                        successCount += chunk.length;
                    }
                    
                    UI.loading(true, `☁️ 同步中... ${pct}% (成功:${successCount} / 失败:${failCount})`);
                    // 稍微延时防止数据库压力过大
                    if(failCount > 50) throw new Error("错误过多，中止上传"); // 熔断机制
                    await new Promise(r => setTimeout(r, 50));
                }

                UI.loading(false);

                if (failCount > 0) {
                    console.error("失败详情:", errorDetails);
                    alert(`⚠️ 同步完成，但有 ${failCount} 个账号失败！\n\n✅ 成功：${successCount}\n❌ 失败：${failCount}\n\n可能原因：账号包含非法字符或数据库字段超长。\n按 F12 查看控制台可看具体失败名单。`);
                } else {
                    UI.toast(`✅ 完美同步！共 ${successCount} 个账号已上线`, "success");
                    if(window.Logger) Logger.log('同步账号', `同步了 ${successCount} 个账号`);
                }

            } catch (e) {
                UI.loading(false);
                console.error(e);
                alert("❌ 同步中断：" + e.message);
            }
        },

// 🛠️ 管理员工具：批量删除云端账号 (保留管理员)
    deleteCloudAccounts: async function() {
        if (!sbClient) return alert("❌ 云端数据库连接失败。");

        // 1. 第一重确认
        if (!confirm("⚠️【高风险操作】⚠️\n\n您确定要清空云端数据库中的所有【家长】和【教师】账号吗？\n\n注意：\n1. 此操作不可撤销！\n2. 管理员账号会被保留，不会被删除。\n3. 删除后用户将无法登录，直到您再次同步。")) {
            return;
        }

        // 2. 第二重确认 (防止误触)
        const input = prompt("🔴 请输入 '确认删除' 四个字以执行清空操作：");
        if (input !== "确认删除") {
            return alert("操作已取消。");
        }

        UI.loading(true, "正在清理云端账号库...");

        try {
            // 执行删除操作
            // 逻辑：删除所有 role 不等于 'admin' 和 'director' 的用户
            const { error, count } = await sbClient
                .from('system_users')
                .delete({ count: 'exact' }) // 请求返回删除的数量
                .neq('role', 'admin')       // 保护管理员
                .neq('role', 'director');   // 保护教务主任

            UI.loading(false);

            if (error) {
                throw error;
            }

            alert(`✅ 清理完成！\n共删除了 ${count !== null ? count : '若干'} 个云端账号。\n\n现在您可以重新生成并同步新名单了。`);

// 🛡️ [日志埋点] 记录清空账号操作
        Logger.log('清空账号', `管理员执行了清空云端普通账号操作 (影响:${count}人)`);

        } catch (e) {
            UI.loading(false);
            console.error(e);
            alert("❌ 删除失败：" + e.message);
        }
    },
 
        exportAllCloudAccounts: async function() {
            if (!sbClient) return alert("❌ 云端数据库未连接，无法导出。");
            
            if (!confirm("⚠️ 准备从云端下载所有账号数据。\n\n这将包含数据库中存储的：\n1. 管理员\n2. 教师/班主任/主任\n3. 家长/学生\n\n确定要导出吗？")) return;

            UI.loading(true, "正在从云端拉取所有账号...");

            try {
                // 1. 从 Supabase 获取所有用户 (限制10000条，一般够用，不够需分页)
                const { data, error } = await sbClient
                    .from('system_users')
                    .select('*')
                    .order('school', { ascending: true }) // 按学校排序
                    .order('role', { ascending: true });  // 再按角色排序
                    
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    throw new Error("云端数据库为空，没有账号可导出。");
                }

                // 2. 准备 Excel 数据
                const headers = ['角色', '学校', '班级/范围', '账号/姓名', '密码 (如可见)'];
                const excelData = [headers];

                // 角色名称映射字典
                const roleMap = {
                    'admin': '👑 管理员',
                    'director': '🎓 教务主任',
                    'grade_director': '🚀 级部主任',
                    'class_teacher': '📋 班主任',
                    'teacher': '👨‍🏫 科任教师',
                    'parent': '👨‍👩‍👧 家长/学生'
                };

                data.forEach(u => {
                    const roleName = roleMap[u.role] || u.role;
                    excelData.push([
                        roleName,
                        u.school || '-',       // 学校
                        u.class_name || '-',   // 班级
                        u.username,            // 账号
                        u.password             // 密码
                    ]);
                });

                // 3. 生成并下载 Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // 设置列宽 (美观)
                ws['!cols'] = [{wch:15}, {wch:20}, {wch:15}, {wch:20}, {wch:15}];
                
                XLSX.utils.book_append_sheet(wb, ws, "云端全量账号");
                
                const fileName = `云端全量账号备份_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                UI.loading(false);
                UI.toast(`✅ 导出成功！共 ${data.length} 条数据`, "success");

            } catch (err) {
                UI.loading(false);
                console.error(err);
                alert("❌ 导出失败: " + err.message);
            }
        },
     
        // 🛠️ 管理员工具：清除账号
        clearAccounts: function() {
            if(!confirm("⚠️ 确定清空所有教师和家长账号吗？\n(管理员密码不会被清除)")) return;
            this.db.teachers = [];
            this.db.parents = [];
            localStorage.setItem('SYS_USERS', JSON.stringify(this.db));
            alert("✅ 所有普通账号已清空");
        }
    };

    const IssueManager = {
        isHistoryMode: false, // 状态标记：是否处于历史记录模式

        // 1. 打开家长申诉弹窗
        openSubmitModal: function(name, cls, school) {
            document.getElementById('issue-student-name').value = name;
            document.getElementById('issue-student-class').value = cls;
            document.getElementById('issue-student-school').value = school;
            // 清空旧内容
            const descArea = document.getElementById('issue-desc');
            descArea.value = '';
            descArea.style.borderColor = '#d1d5db'; // 重置边框颜色
            
            // 动态插入语音按钮 (如果还没加过)
            if (!document.getElementById('btn-voice-input-issue')) {
                const label = descArea.previousElementSibling; // 找到 Label
                const voiceBtn = document.createElement('span');
                voiceBtn.id = 'btn-voice-input-issue';
                voiceBtn.innerHTML = '🎤 语音输入';
                voiceBtn.style.cssText = 'float:right; font-size:12px; color:var(--primary); cursor:pointer; margin-right:5px;';
                voiceBtn.onclick = function() {
                    // 调用简单的 Web Speech API
                    if (!('webkitSpeechRecognition' in window)) return alert("您的浏览器不支持语音输入");
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = 'zh-CN';
                    recognition.start();
                    voiceBtn.innerText = '🔴 正在聆听...';
                    recognition.onresult = function(event) {
                        descArea.value += event.results[0][0].transcript;
                        voiceBtn.innerText = '🎤 语音输入';
                    };
                    recognition.onerror = function() {
                        alert("语音识别失败，请手动输入");
                        voiceBtn.innerText = '🎤 语音输入';
                    };
                };
                label.appendChild(voiceBtn);
            }
            document.getElementById('issue-submit-modal').style.display = 'flex';
        },

        // 2. 提交申诉 (家长端)
        submit: async function() {
            if (!sbClient) return alert("❌ 云端服务未连接，无法提交。");

            const name = document.getElementById('issue-student-name').value;
            const cls = document.getElementById('issue-student-class').value;
            const school = document.getElementById('issue-student-school').value;
            const type = document.getElementById('issue-type').value;
            const desc = document.getElementById('issue-desc').value.trim();
            const contact = document.getElementById('issue-contact').value.trim();

            // 实时验证：描述必填
            if (!desc) {
                const descArea = document.getElementById('issue-desc');
                descArea.style.borderColor = '#ef4444'; // 变红
                descArea.focus();
                
                // 使用 SweetAlert2 (如果有) 或 Toast 提示
                if(window.Swal) {
                    Swal.fire({
                        icon: 'warning',
                        title: '请填写说明',
                        text: '为了老师能准确核实，请详细描述您遇到的问题。',
                        timer: 2000
                    });
                } else {
                    alert("请填写具体情况说明");
                }
                return;
            }

            UI.loading(true, "正在提交申请...");

            const { error } = await sbClient
                .from('issues')
                .insert([{
                    student_name: name,
                    student_class: cls,
                    school: school,
                    issue_type: type,
                    description: desc,
                    contact_info: contact,
                    status: 'pending' // 默认为待处理
                }]);

            UI.loading(false);

            if (error) {
                alert("提交失败：" + error.message);
            } else {
                alert("✅ 申请已提交！\n教务处将尽快核查，请留意后续通知或老师反馈。");
                document.getElementById('issue-submit-modal').style.display = 'none';
                document.getElementById('issue-desc').value = '';
            }
        },

        // 3. 检查待处理消息 (红点轮询 - 核心权限逻辑)
        checkIssues: async function() {
            if (!sbClient) return;
            const user = typeof Auth !== 'undefined' ? Auth.currentUser : null;
            if (!user) return;

            // 基础条件是 status = pending
            let query = sbClient
                .from('issues')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');

            // 🟢 [新增] 权限过滤：确保红点数量只统计自己管辖范围内的
            if (user.role === 'grade_director') {
                // 级部主任：看本年级 (模糊匹配 "7%")
                if (user.class) query = query.ilike('student_class', `${user.class}%`);
            } else if (user.role === 'class_teacher') {
                // 🟢 班主任：只看本班 (精确匹配 "701")
                if (user.class) query = query.eq('student_class', user.class);
            } else if (user.role === 'director') {
                // 教务主任：看本校
                if (user.school) query = query.eq('school', user.school);
            }

            const { count, error } = await query;

            if (!error) {
                const badge = document.getElementById('msg-badge');
                if (badge) {
                    if (count > 0) {
                        badge.innerText = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }
        },

        // 4. 打开管理员处理面板
        openAdminPanel: async function() {
            this.isHistoryMode = false; // 默认进入看正常列表
            this.updateUIState();
            const modal = document.getElementById('admin-issue-modal');
            modal.style.display = 'flex';
            this.loadIssues();
        },

        // 切换 历史记录 / 正常视图
        toggleHistoryView: function() {
            this.isHistoryMode = !this.isHistoryMode;
            this.updateUIState();
            this.loadIssues(); // 重新加载数据
        },

        // 更新界面按钮状态
        updateUIState: function() {
            const titleEl = document.getElementById('issue-modal-title');
            const btnHistory = document.getElementById('btn-issue-history');
            const normalActions = document.getElementById('issue-normal-actions');
            const historyActions = document.getElementById('issue-history-actions');
            const tipBar = document.getElementById('issue-tip-bar');
            
            // 重置全选状态
            if(document.getElementById('issue-check-all')) document.getElementById('issue-check-all').checked = false;
            if(document.getElementById('issue-history-check-all')) document.getElementById('issue-history-check-all').checked = false;

            if (this.isHistoryMode) {
                titleEl.innerHTML = '<i class="ti ti-trash"></i> 删除历史记录 (回收站)';
                titleEl.style.color = '#666';
                btnHistory.innerHTML = '<i class="ti ti-arrow-back-up"></i> 返回列表';
                btnHistory.className = 'btn btn-sm btn-primary';
                normalActions.style.display = 'none';
                historyActions.style.display = 'flex';
                tipBar.style.display = 'none';
            } else {
                titleEl.innerHTML = '<i class="ti ti-bell"></i> 申诉反馈中心';
                titleEl.style.color = 'var(--primary)';
                btnHistory.innerHTML = '<i class="ti ti-history"></i> 查看删除记录';
                btnHistory.className = 'btn btn-sm btn-gray';
                normalActions.style.display = 'flex';
                historyActions.style.display = 'none';
                tipBar.style.display = 'block';
            }
        },

        // 全选/反选
        toggleSelectAll: function(source) {
            const checkboxes = document.querySelectorAll('.issue-item-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
        },

        // 获取选中的ID
        getCheckedIds: function() {
            const checkboxes = document.querySelectorAll('.issue-item-check:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        },

        // 5. 加载申诉列表 (列表渲染 - 核心权限逻辑)
        loadIssues: async function() {
            const listEl = document.getElementById('admin-issue-list');
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">⏳ 加载中...</div>';

            const user = typeof Auth !== 'undefined' ? Auth.currentUser : null;
            
            // 构建查询
            let query = sbClient
                .from('issues')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(100);

            // 状态过滤 (正常 vs 历史)
            if (this.isHistoryMode) {
                query = query.eq('status', 'deleted');
            } else {
                query = query.neq('status', 'deleted');
            }

            // 🟢 [新增] 权限过滤 (确保只能看到自己管辖的班级)
            if (user && user.role === 'grade_director') {
                if (user.class) query = query.ilike('student_class', `${user.class}%`);
            } else if (user && user.role === 'class_teacher') {
                // 🟢 班主任过滤：强制匹配 student_class == 班级名
                if (user.class) query = query.eq('student_class', user.class);
            } else if (user && user.role === 'director') {
                if (user.school) query = query.eq('school', user.school);
            }

            const { data, error } = await query;

            if (error) {
                listEl.innerHTML = `<div style="color:red; text-align:center;">加载失败: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">📭 暂无相关记录</div>';
                return;
            }

            let html = '';
            data.forEach(item => {
                const time = new Date(item.created_at).toLocaleString();
                const isPending = item.status === 'pending';
                const isDeleted = item.status === 'deleted';
                
                let statusBadge = '';
                let actionBtn = '';

                if (isDeleted) {
                    statusBadge = `<span class="badge" style="background:#9ca3af; color:white;">已删除</span>`;
                    actionBtn = `<span style="font-size:12px; color:#999;">已删除</span>`;
                } else {
                    statusBadge = isPending 
                        ? `<span class="badge" style="background:#ef4444; color:white;">待处理</span>` 
                        : `<span class="badge" style="background:#10b981; color:white;">已解决</span>`;
                    
                    actionBtn = isPending 
                        ? `<button class="btn btn-sm btn-primary" onclick="IssueManager.resolve(${item.id})">✅ 标记已阅/解决</button>` 
                        : `<span style="font-size:12px; color:#ccc;">已归档</span>`;
                }

                html += `
                    <div style="background:white; border:1px solid #e2e8f0; border-left:4px solid ${isPending?'#ef4444':(isDeleted?'#9ca3af':'#10b981')}; border-radius:8px; padding:15px; margin-bottom:10px; display:flex; gap:10px;">
                        <div style="display:flex; align-items:center;">
                            <input type="checkbox" class="issue-item-check" value="${item.id}" style="transform:scale(1.2); cursor:pointer;">
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <div style="font-weight:bold; color:#333;">
                                    ${item.school} · ${item.student_class} · ${item.student_name}
                                </div>
                                <div style="font-size:12px; color:#64748b;">${time}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; font-size:13px;">
                                <span style="background:#f3f4f6; padding:2px 6px; border-radius:4px;">${item.issue_type}</span>
                                ${statusBadge}
                            </div>
                            <div style="background:#f8fafc; padding:10px; border-radius:4px; font-size:14px; color:#475569; margin-bottom:10px;">
                                ${item.description}
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-size:12px; color:#0369a1;">📞 联系: ${item.contact_info || '无'}</div>
                                <div>${actionBtn}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        },

        // 6. 单条处理
        resolve: async function(id) {
            if (!confirm("确认已核实并处理该问题了吗？\n标记为已解决后，该条目将不再显示红点。")) return;
            const { error } = await sbClient.from('issues').update({ status: 'resolved' }).eq('id', id);
            if (error) alert("操作失败：" + error.message);
            else { this.loadIssues(); this.checkIssues(); }
        },

        // 7. 🟢 [新功能] 批量软删除 (移入历史)
        batchSoftDelete: async function() {
            const ids = this.getCheckedIds();
            if (ids.length === 0) return UI.toast("请至少选择一项", "error");
            if (!confirm(`确定要删除选中的 ${ids.length} 条记录吗？\n(删除后可在“历史记录”中找回)`)) return;

            UI.loading(true, "正在移除...");
            // 将状态改为 deleted
            const { error } = await sbClient.from('issues').update({ status: 'deleted' }).in('id', ids);
            UI.loading(false);

            if (error) alert("删除失败: " + error.message);
            else {
                UI.toast(`已删除 ${ids.length} 条记录`, 'success');
                this.loadIssues(); // 重新加载，已删除的条目会消失
                this.checkIssues(); // 刷新红点
                document.getElementById('issue-check-all').checked = false;
            }
        },

        // 8. 🟢 [新功能] 批量还原
        batchRestore: async function() {
            const ids = this.getCheckedIds();
            if (ids.length === 0) return UI.toast("请至少选择一项", "error");
            
            UI.loading(true, "正在还原...");
            // 还原为 resolved (已读)，比较安全
            const { error } = await sbClient.from('issues').update({ status: 'resolved' }).in('id', ids);
            UI.loading(false);

            if (error) alert("还原失败: " + error.message);
            else {
                UI.toast(`已还原 ${ids.length} 条记录`, 'success');
                this.loadIssues(); // 重新加载，还原的条目会从历史列表中消失
                document.getElementById('issue-history-check-all').checked = false;
            }
        },

        // 9. 🟢 [新功能] 批量彻底删除 (物理删除)
        batchHardDelete: async function() {
            const ids = this.getCheckedIds();
            if (ids.length === 0) return UI.toast("请至少选择一项", "error");
            
            // 双重确认，防止误删
            if (!confirm(`⚠️ 高能预警 ⚠️\n\n确定要【彻底删除】选中的 ${ids.length} 条记录吗？\n此操作不可恢复！`)) return;

            UI.loading(true, "正在彻底粉碎数据...");
            const { error } = await sbClient.from('issues').delete().in('id', ids);
            UI.loading(false);

            if (error) alert("删除失败: " + error.message);
            else {
                UI.toast(`彻底删除了 ${ids.length} 条记录`, 'success');
                this.loadIssues(); // 重新加载，数据将永久消失
                document.getElementById('issue-history-check-all').checked = false;
            }
        }
    };

    // 📦 系统打包工具
    const Packager = {
        // 生成包含数据的独立 HTML 文件
        exportDistributableHTML: function() {
            // 1. 检查数据
            if (!RAW_DATA.length) return alert("当前无成绩数据，无法生成分发版。");
            if (!Auth.db.parents.length && !Auth.db.teachers.length) return alert("当前无账号信息，请先在账号管理中生成账号。");

            if (!confirm("⚠️ 准备生成【分发版网页】...\n\n此文件将包含：\n1. 所有学生成绩数据\n2. 所有生成的账号密码\n\n请将生成的 .html 文件发送给家长/老师。\n他们无需上传Excel，直接输入账号即可登录。\n\n确定继续吗？")) return;

            UI.loading(true, "正在打包全量数据...");

            setTimeout(() => {
                try {
                    // 2. 准备要注入的数据包
                    const dataPackage = {
                        timestamp: new Date().getTime(),
                        // 核心业务数据
                        RAW_DATA: RAW_DATA,
                        SCHOOLS: SCHOOLS, // 包含统计结果，避免重新计算
                        SUBJECTS: SUBJECTS,
                        THRESHOLDS: THRESHOLDS,
                        TEACHER_MAP: TEACHER_MAP,
                        MY_SCHOOL: MY_SCHOOL,
                        CONFIG: CONFIG,
                        // 核心权限数据
                        AUTH_DB: Auth.db, 
                        // 其他配置
                        LLM_CONFIG: LLM_CONFIG
                    };

                    // 3. 获取当前页面的完整源代码
                    let htmlContent = document.documentElement.outerHTML;

                   // A. 强制显示登录遮罩，隐藏主界面
                    htmlContent = htmlContent.replace(
                        /id="login-overlay"\s+style="([^"]*)"/, 
                        'id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:50000; display:flex; align-items:center; justify-content:center; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;"'
                    );
                    
                    // 强制隐藏主容器
                    if (htmlContent.includes('id="app" class="container"')) {
                         htmlContent = htmlContent.replace('id="app" class="container"', 'id="app" class="container hidden"');
                    } else {
                        htmlContent = htmlContent.replace('id="app"', 'id="app" class="hidden"');
                    }

                    // B. 【修复弹窗问题】强制隐藏管理员模态框
                    htmlContent = htmlContent.replace(
                        /id="admin-modal"\s+class="modal"\s+style="([^"]*)"/,
                        'id="admin-modal" class="modal" style="display: none; z-index: 60000;"'
                    );

                    // C. 【修复右上角名字问题】移除已存在的退出按钮
                    htmlContent = htmlContent.replace(/<div id="logout-btn".*?<\/div>/, '');

                    // D. 隐藏管理员入口按钮
                    htmlContent = htmlContent.replace('id="admin-panel-btn" onclick', 'id="admin-panel-btn" style="display:none" onclick');

                    // E. 🔥【关键修复】强制隐藏全局加载遮罩 (修复一直转圈的问题) 🔥
                    // 使用正则替换，强制给 global-loader 加上 hidden 类，并去掉可能存在的内联 style
                    htmlContent = htmlContent.replace(
                        /<div id="global-loader"[\s\S]*?>/, 
                        '<div id="global-loader" class="hidden">'
                    );

                    // 4. 构建注入脚本 (将数据对象转为 JSON 字符串)
                    // 为了防止 XSS 或闭合标签错误，进行简单的转义
                    const jsonStr = JSON.stringify(dataPackage).replace(/<\/script>/g, '<\\/script>');
                    const injectionCode = `window.EMBEDDED_DB = ${jsonStr};`;

                    // 5. 替换插槽内容
                    // 寻找第一步中预留的 window.EMBEDDED_DB = null;
                    const targetStr = "window.EMBEDDED_DB = null;";
                    
                    if (!htmlContent.includes(targetStr)) {
                        throw new Error("模板插槽未找到，请检查 HTML 头部是否添加了 id='embedded-data-script'");
                    }

                    // 执行替换
                    const newHtml = htmlContent.replace(targetStr, injectionCode);

                    // 6. 下载新文件
                    const blob = new Blob([newHtml], { type: "text/html;charset=utf-8" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    // 文件名带上时间，方便区分
                    link.download = `查分系统_分发版_${new Date().toLocaleDateString().replace(/\//g,'-')}.html`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    UI.loading(false);
                    alert("✅ 分发版已生成！\n\n请将下载的 .html 文件发送给家长。\n家长打开该文件后，可直接用账号登录。");

                } catch (e) {
                    console.error(e);
                    UI.loading(false);
                    alert("打包失败: " + e.message);
                }
            }, 500);
        }
    };

    const HelpSystem = {
        // 定义各模块的帮助内容
        content: {
            'upload': {
                title: '📁 数据上传规范',
                html: `
                    <div style="text-align:left; line-height:1.6;">
                        <p><strong>1. Excel 格式要求：</strong></p>
                        <ul>
                            <li>第一行必须是表头（如：姓名、班级、语文、数学...）。</li>
                            <li>必须包含<strong>姓名</strong>列。</li>
                            <li>如果有多个学校，请使用不同的 Sheet 页，<strong>Sheet名称即为学校名</strong>。</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>2. 常见问题：</strong></p>
                        <ul>
                            <li>缺考/作弊：可填 "0" 或 "缺考"（系统按0分处理）。</li>
                            <li>列名识别：系统支持“语文/语/Chinese”等多种别名自动识别。</li>
                        </ul>
                    </div>
                `,
                icon: 'info'
            },
            'macro': {
                title: '📊 两率一分算法说明',
                html: `
                    <div style="text-align:left;">
                        <p><strong>核心公式：</strong></p>
                        <p>总分 = (均分赋分) + (优率赋分) + (及格赋分)</p>
                        <hr style="margin:10px 0; border:0; border-top:1px dashed #eee;">
                        <p><strong>默认权重配置：</strong></p>
                        <ul>
                            <li><strong>6-8年级：</strong> 均分60 + 优率70 + 及格70 = 满分200</li>
                            <li><strong>9年级：</strong> 均分40 + 优率80 + 及格40 = 满分160</li>
                        </ul>
                        <p style="font-size:12px; color:#666; margin-top:5px;">* 指标计算基准：以全镇最高值为满分进行归一化折算。</p>
                    </div>
                `
            },
            'teacher': {
                title: '👨‍🏫 教师评价模型',
                html: `
                    <div style="text-align:left;">
                        <p>系统通过以下维度评价教师教学质量：</p>
                        <ol>
                            <li><strong>三率指标：</strong> 优秀率、及格率、低分率。</li>
                            <li><strong>贡献值：</strong> (班级均分 - 年级均分)。</li>
                            <li><strong>乡镇排名：</strong> 该教师所教班级在全镇同科目的排名。</li>
                        </ol>
                        <div class="info-bar" style="margin-top:10px; font-size:12px;">
                            💡 提示：请先在【数据上传】页面下方配置好“教师任课表”才能看到此分析。
                        </div>
                    </div>
                `
            }
        },

        // 显示单点帮助
        show: function(key) {
            if(this.content[key]) {
                Swal.fire({
                    title: this.content[key].title,
                    html: this.content[key].html,
                    icon: 'question',
                    confirmButtonText: '明白了',
                    confirmButtonColor: '#4f46e5'
                });
            }
        },

        // 启动新手引导之旅 (Wizard)
        startTour: function() {
            const steps = [
                {
                    title: '👋 欢迎使用智能教务系统',
                    html: '只需 3 步完成一次完整流程：<strong>导入 → 分析 → 导出</strong>。',
                    imageUrl: 'https://cdn-icons-png.flaticon.com/512/4205/4205622.png',
                    imageWidth: 100,
                    confirmButtonText: '下一步: 导入数据'
                },
                {
                    title: '1️⃣ 导入',
                    html: '进入<strong>【数据枢纽】</strong>上传 Excel。<br><small style="color:#666">系统自动识别学校、班级与学科。</small>',
                    icon: 'info',
                    confirmButtonText: '下一步: 分析'
                },
                {
                    title: '2️⃣ 分析',
                    html: '进入<strong>【校际联考分析】</strong>查看横向排名，<br>进入<strong>【班级教学管理】</strong>看教师贡献度。',
                    icon: 'success',
                    confirmButtonText: '下一步: 导出'
                },
                {
                    title: '3️⃣ 导出',
                    html: '进入<strong>【综合分析报告】</strong>或<strong>【成绩单/家长查分】</strong>一键导出。',
                    icon: 'success',
                    confirmButtonText: '开始使用！'
                }
            ];

            // 使用 SweetAlert2 的队列功能
            let currentStep = 0;
            const showStep = (index) => {
                if (index >= steps.length) return;
                Swal.fire({
                    ...steps[index],
                    showCancelButton: index < steps.length - 1,
                    cancelButtonText: '跳过教程',
                    confirmButtonColor: '#4f46e5',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        showStep(index + 1);
                    }
                });
            };
            showStep(0);
        },

        // 检查是否首次访问
        checkFirstRun: function() {
            if (!localStorage.getItem('hasSeenV3Tour')) {
                setTimeout(() => {
                    this.startTour();
                    localStorage.setItem('hasSeenV3Tour', 'true');
                }, 1000); // 延迟1秒显示，等待页面渲染
            }
        }
    };

    // 1. Worker 脚本源码 (后台线程逻辑)
    const WORKER_SOURCE = `
    self.onmessage = function(e) {
        const { cmd, data } = e.data;
        if (cmd === 'PROCESS_ALL') {
            const { RAW_DATA, SUBJECTS, CONFIG, THRESHOLDS } = data;
            // 接收轻量版 SCHOOLS (无循环引用)
            let SCHOOLS = data.SCHOOLS_LITE; 

            try {
                // --- A. 重建索引 ---
                const schoolMap = {};
                Object.keys(SCHOOLS).forEach(k => {
                    schoolMap[k] = { ...SCHOOLS[k], students: [] };
                });
                // 重新归类学生
                RAW_DATA.forEach(s => {
                    if (schoolMap[s.school]) schoolMap[s.school].students.push(s);
                });

                // --- B. 计算统计指标 (原 processData 逻辑) ---
                Object.values(schoolMap).forEach(sch => {
                    [...SUBJECTS, 'total'].forEach(k => {
                        const vals = sch.students.map(s => k==='total'?s.total:s.scores[k]).filter(v=>v!==undefined);
                        if(!vals.length) { sch.metrics[k] = { count:0, avg:0, excRate:0, passRate:0 }; return; }
                        const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
                        const excN = vals.filter(v=>v>=THRESHOLDS[k].exc).length;
                        const passN = vals.filter(v=>v>=THRESHOLDS[k].pass).length;
                        sch.metrics[k] = { count: vals.length, avg: avg, excRate: excN / vals.length, passRate: passN / vals.length };
                    });
                    
                    // 后1/3计算
                    const totalN = sch.students.length; 
                    const bottomN = Math.ceil(totalN / 3); 
                    const excN = Math.ceil(bottomN * CONFIG.excRate);
                    const sorted = [...sch.students].sort((a,b)=>b.total - a.total);
                    const bottomGroup = sorted.slice(-bottomN);
                    const validGroup = bottomGroup.slice(0, Math.max(0, bottomGroup.length - excN));
                    const bAvg = validGroup.length ? validGroup.reduce((a,b)=>a+b.total,0)/validGroup.length : 0;
                    sch.bottom3 = { totalN, bottomN, excN, avg: bAvg };
                });

               // === 新增功能：计算全镇各科标准差 & 学生 T 分 (T-Score) ===
                
                // 1. 计算全镇各科的统计指标 (均分 & 标准差)
                const globalStats = {};
                SUBJECTS.forEach(sub => {
                    const scores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                    if (scores.length > 1) {
                        const sum = scores.reduce((a, b) => a + b, 0);
                        const avg = sum / scores.length;
                        const variance = scores.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / scores.length;
                        const sd = Math.sqrt(variance);
                        globalStats[sub] = { avg, sd };
                    }
                });

                // 2. 定义 9 年级核心五科 (用于锁定标准分总分计算范围)
                const isGrade9Mode = CONFIG.name && CONFIG.name.includes('9');
                const grade9CoreSubjects = ['语文', '数学', '英语', '物理', '化学'];

                // 3. 为每个学生计算 T 分
                RAW_DATA.forEach(stu => {
                    stu.tScores = {}; // 存储单科 T 分
                    stu.totalTScore = 0; // T 分总和
                    
                    SUBJECTS.forEach(sub => {
                        const val = stu.scores[sub];
                        const stats = globalStats[sub];
                        
                        // 必须确保 stats 存在，且标准差大于极小值防止除零
                        if (typeof val === 'number' && stats && stats.sd > 0.00001) {
                            // T分公式：50 + 10 * Z
                            const z = (val - stats.avg) / stats.sd;
                            let t = 50 + 10 * z;
                            
                            // 边界保护：限制 T 分在 0-100 之间，防止极端离群值破坏总分
                            t = Math.max(0, Math.min(100, t));
                            
                            // A. 记录单科 T 分 (所有科目都记录，方便查看单科强弱)
                            stu.tScores[sub] = parseFloat(t.toFixed(1));

                            // B. 计算标准分总和 (根据年级模式筛选)
                            if (isGrade9Mode) {
                                // ★ 9年级模式：只累加 语数英物化
                                if (grade9CoreSubjects.includes(sub)) {
                                    stu.totalTScore += t;
                                }
                            } else {
                                // ★ 6-8年级模式：累加所有科目
                                stu.totalTScore += t;
                            }
                        } else {
                            stu.tScores[sub] = 0; 
                        }
                    });
                    
                    stu.totalTScore = parseFloat(stu.totalTScore.toFixed(1));
                });

                // --- C. 计算排名 (原 calculateStudentRanks 部分) ---
                const calcRank = (list, keyGetter, rankSetter) => {
                    list.sort((a, b) => keyGetter(b) - keyGetter(a));
                    list.forEach((item, i) => {
                        let rank = i + 1;
                        if (i > 0 && Math.abs(keyGetter(item) - keyGetter(list[i-1])) < 0.0001) {
                            rank = list[i-1]._tempRank;
                        }
                        item._tempRank = rank;
                        rankSetter(item, rank);
                    });
                };

                // 全镇排名
                SUBJECTS.forEach(sub => {
                    const validStus = RAW_DATA.filter(s => s.scores[sub] !== undefined);
                    calcRank(validStus, s => s.scores[sub], (s, r) => { if(!s.ranks) s.ranks={}; if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].township = r; });
                });
                calcRank(RAW_DATA, s => s.total, (s, r) => { if(!s.ranks) s.ranks={}; if(!s.ranks.total) s.ranks.total={}; s.ranks.total.township = r; });

                // 校内排名
                Object.values(schoolMap).forEach(sch => {
                    calcRank(sch.students, s => s.total, (s, r) => s.ranks.total.school = r);
                    SUBJECTS.forEach(sub => {
                        const subStus = sch.students.filter(s => s.scores[sub] !== undefined);
                        calcRank(subStus, s => s.scores[sub], (s, r) => s.ranks[sub].school = r);
                    });
                });

               // --- D. 学校综合排名 (原 calculateRankings) ---
                const doSchoolRank = (sub, key) => {
                    const list = Object.values(schoolMap).filter(s => s.metrics[sub]);
                    list.sort((a,b) => b.metrics[sub][key] - a.metrics[sub][key]);
                    list.forEach((s, i) => {
                        if(!s.rankings) s.rankings = {}; if(!s.rankings[sub]) s.rankings[sub] = {};
                        if(i>0 && Math.abs(s.metrics[sub][key] - list[i-1].metrics[sub][key]) < 0.0001) s.rankings[sub][key] = list[i-1].rankings[sub][key]; 
                        else s.rankings[sub][key] = i + 1;
                    });
                };
                [...SUBJECTS, 'total'].forEach(sub => { doSchoolRank(sub, 'avg'); doSchoolRank(sub, 'excRate'); doSchoolRank(sub, 'passRate'); });
                
                // 计算综合得分的最大值基准
                let max = { avg:0, exc:0, pass:0 };
                Object.values(schoolMap).forEach(s => { if(s.metrics.total) { max.avg = Math.max(max.avg, s.metrics.total.avg); max.exc = Math.max(max.exc, s.metrics.total.excRate); max.pass = Math.max(max.pass, s.metrics.total.passRate); } });

                // === 🔥 1. 新增：9年级高分段统计 (>=490分) ===
                let maxHighRatio = 0;
                // 判断是否为9年级模式
                const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
                
                if (isGrade9) {
                    Object.values(schoolMap).forEach(s => {
                        // 计算高分人数 (总分 >= 490)
                        const highCount = s.students.filter(stu => stu.total >= 490).length;
                        const totalCount = s.metrics.total ? s.metrics.total.count : 1;
                        const ratio = totalCount > 0 ? (highCount / totalCount) : 0;
                        
                        s.highScoreStats = {
                            count: highCount,
                            ratio: ratio,
                            score: 0 // 稍后计算
                        };
                        
                        if (ratio > maxHighRatio) maxHighRatio = ratio;
                    });
                }

                // === 🔥 2. 计算各项赋分 (含9年级特殊权重) ===
                Object.values(schoolMap).forEach(s => {
                    if(s.metrics.total) {
                        const m = s.metrics.total;
                        // 定义默认权重 (6-8年级)
                        let wAvg = 60, wExc = 70, wPass = 70;
                        
                        // 🟢 如果是 9年级模式，修改权重 (均分40 + 优秀80 + 及格40)
                        if (isGrade9) {
                            wAvg = 40; 
                            wExc = 80; 
                            wPass = 40; 
                        }

                        // 分别计算三项赋分
                        const valAvg = (max.avg ? m.avg/max.avg * wAvg : 0);
                        const valExc = (max.exc ? m.excRate/max.exc * wExc : 0);
                        const valPass = (max.pass ? m.passRate/max.pass * wPass : 0);
                        
                        // 保存到对象中供前端显示
                        m.ratedAvg = valAvg;
                        m.ratedExc = valExc;
                        m.ratedPass = valPass;
                        
                        // 计算两率一分基准总分
                        s.score2Rate = valAvg + valExc + valPass;

                        // === 🔥 3. 如果是9年级，计算高分赋分 ===
                        if (isGrade9 && s.highScoreStats) {
                            // 赋分公式：(本校比例 / 最高比例) * 70
                            const highScore = maxHighRatio > 0 ? (s.highScoreStats.ratio / maxHighRatio * 70) : 0;
                            s.highScoreStats.score = highScore;
                            
                            // ⚠️ 注意：目前高分赋分仅做展示，暂未叠加到 score2Rate (总排名分) 中。
                            // 如果需要叠加进总排名，请取消下一行的注释：
                            // s.score2Rate += highScore; 
                        }

                    } else { 
                        s.score2Rate = 0; 
                        // 防止空对象报错
                        if(isGrade9) s.highScoreStats = { count:0, ratio:0, score:0 };
                    }
                });

                // 排序 (按两率一分总分降序)
                // 修复：确保 list 包含所有学校，不进行任何 slice 截断
                const list = Object.values(schoolMap).sort((a,b) => {
                    const scoreA = a.score2Rate || 0;
                    const scoreB = b.score2Rate || 0;
                    return scoreB - scoreA; 
                });
                
                // 重新赋予排名索引
                list.forEach((s, i) => {
                    s.rank2Rate = i + 1;
                });
                
                // 后1/3排序
                let maxBAvg = 0; 
                list.forEach(s => maxBAvg = Math.max(maxBAvg, s.bottom3.avg || 0));
                
                list.forEach(s => {
                    s.scoreBottom = maxBAvg ? (s.bottom3.avg / maxBAvg * 40) : 0;
                });
                
                // 按后1/3得分排序
                list.sort((a,b) => (b.scoreBottom || 0) - (a.scoreBottom || 0))
                    .forEach((s,i) => s.rankBottom = i + 1);

                // 返回结果：我们要把 RAW_DATA (含ranks) 和 SCHOOLS (含metrics/rankings) 发回去
                const SCHOOLS_RESULT = {};
                Object.keys(schoolMap).forEach(k => {
                    const { students, ...rest } = schoolMap[k];
                    SCHOOLS_RESULT[k] = rest;
                });

                self.postMessage({ status: 'ok', RAW_DATA, SCHOOLS: SCHOOLS_RESULT });

            } catch(err) {
                self.postMessage({ status: 'error', msg: err.message });
            }
        }
    };`;

    // 2. Worker 管理器
    const WorkerAPI = {
        worker: null,
        init() {
            if (this.worker) return;
            const blob = new Blob([WORKER_SOURCE], { type: 'application/javascript' });
            this.worker = new Worker(URL.createObjectURL(blob));
        },
        run(data) {
            this.init();
            return new Promise((resolve, reject) => {
                this.worker.onmessage = (e) => {
                    if (e.data.status === 'ok') resolve(e.data);
                    else reject(e.data.msg);
                };
                this.worker.onerror = (e) => reject(e.message);
                
                // 为了传输效率，剥离 SCHOOLS 中的 students 引用
                const schoolsLite = {};
                Object.keys(data.SCHOOLS).forEach(k => {
                    const { students, ...rest } = data.SCHOOLS[k];
                    schoolsLite[k] = rest;
                });

                this.worker.postMessage({ 
                    cmd: 'PROCESS_ALL', 
                    data: { ...data, SCHOOLS_LITE: schoolsLite } 
                });
            });
        }
    };

    // 【魔法】劫持原生 alert，你旧代码里的 alert 都会自动变漂亮
    // 升级版：使用 SweetAlert2 替代原生弹窗
    window.alert = function(msg, icon = 'info') {
        if(typeof Swal !== 'undefined') {
            Swal.fire({
                text: msg,
                icon: (msg.includes('成功') || msg.includes('✅')) ? 'success' : ((msg.includes('失败') || msg.includes('错误')) ? 'error' : 'info'),
                confirmButtonColor: '#4f46e5',
                timer: 2000,
                timerProgressBar: true
            });
        } else {
            // 降级处理
            UI.toast(msg);
        }
    };

    // 👇👇👇 ✋ 🔴 [修复重点开始]：调整代码顺序，防止递归死循环 🔴 ✋ 👇👇👇

    // 🟢 [修正步骤 1]：必须在重写之前，先备份浏览器原生的 confirm 函数！
    // 之前代码把这行放在了后面，导致备份的是“新函数自己”，从而引发死循环。
    if(!window.originalConfirm) window.originalConfirm = window.confirm;

    // 🟢 [修正步骤 2]：然后再重写 window.confirm
    // (这是为了让 window.confirm = async function 变成异步，虽然这里暂时还是同步调用)
    window.confirm = function(msg) {
        // 注意：原生的 confirm 是同步阻塞的，SweetAlert2 是异步 Promise。
        // 这里只是为了覆盖默认行为，实际代码中需要把 if(confirm(...)) 改为 await 模式
        // 为了兼容旧代码，这里暂时保留原生 confirm 作为同步阻塞，
        // 但建议在关键操作（如删除）中显式调用 Swal.fire
        
        // 这里的 window.originalConfirm 现在指向的是真正的原生函数，不会死循环了
        return window.originalConfirm ? window.originalConfirm(msg) : true; 
    };

    // 备份原生 confirm 以防万一 (这段旧有的冗余代码可以保留，也可以删掉，上面的步骤1已经处理了)
    if(!window.originalConfirm) window.originalConfirm = window.confirm;

    // 👆👆👆 ✋ 🟢 [修复重点结束] 🟢 ✋ 👆👆👆

// 🛡️ [升级版] 系统操作日志记录器 (支持回收站)
const Logger = {
    isHistoryMode: false,

    // 1. 写入日志 (保持不变)
    log: async function(action, details) {
        if (!sbClient) return;
        let operator = "未知/系统";
        try {
            const userStr = sessionStorage.getItem('CURRENT_USER');
            if (userStr) {
                const user = JSON.parse(userStr);
                operator = `${user.name} (${user.role})`;
            }
        } catch(e) {}

        try {
            await sbClient.from('system_logs').insert([{
                operator: operator,
                action: action,
                details: details,
                status: 'normal' // 默认状态
            }]);
            console.log(`[Log] ${action}: ${details}`);
        } catch (e) {
            console.error("写日志失败:", e);
        }
    },

    // 2. 打开查看面板 (UI升级)
    view: function() {
        this.isHistoryMode = false;
        this.updateUIState();
        document.getElementById('admin-log-modal').style.display = 'flex';
        this.loadLogs();
    },

    // 3. 切换视图
    toggleHistoryView: function() {
        this.isHistoryMode = !this.isHistoryMode;
        this.updateUIState();
        this.loadLogs();
    },

    // 4. 更新UI状态
    updateUIState: function() {
        const titleEl = document.getElementById('log-modal-title');
        const btnHistory = document.getElementById('btn-log-history');
        const normalActions = document.getElementById('log-normal-actions');
        const historyActions = document.getElementById('log-history-actions');
        
        // 重置全选
        if(document.getElementById('log-check-all')) document.getElementById('log-check-all').checked = false;
        if(document.getElementById('log-history-check-all')) document.getElementById('log-history-check-all').checked = false;

        if (this.isHistoryMode) {
            titleEl.innerHTML = '<i class="ti ti-trash"></i> 日志回收站';
            titleEl.style.color = '#666';
            btnHistory.innerHTML = '<i class="ti ti-arrow-back-up"></i> 返回日志列表';
            btnHistory.className = 'btn btn-sm btn-primary';
            normalActions.style.display = 'none';
            historyActions.style.display = 'flex';
        } else {
            titleEl.innerHTML = '<i class="ti ti-history"></i> 系统操作日志';
            titleEl.style.color = '#333';
            btnHistory.innerHTML = '<i class="ti ti-recycle"></i> 日志回收站';
            btnHistory.className = 'btn btn-sm btn-gray';
            normalActions.style.display = 'flex';
            historyActions.style.display = 'none';
        }
    },

    // 5. 加载日志数据
    loadLogs: async function() {
        const listEl = document.getElementById('admin-log-list');
        listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">⏳ 加载中...</div>';

        let query = sbClient
            .from('system_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(100);

        // 状态过滤
        if (this.isHistoryMode) {
            query = query.eq('status', 'deleted');
        } else {
            // 兼容旧数据：status 不等于 deleted，或者 status 为 null
            query = query.or('status.eq.normal,status.is.null'); 
        }

        const { data, error } = await query;

        if (error) return listEl.innerHTML = `<div style="color:red; padding:20px;">加载失败: ${error.message}</div>`;
        if (!data || data.length === 0) return listEl.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">📭 暂无记录</div>`;

        // 渲染表格
        let html = `
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead style="position:sticky; top:0; background:#f3f4f6; z-index:1;">
                    <tr style="border-bottom:1px solid #ddd; color:#64748b;">
                        <th style="width:40px; padding:10px; text-align:center;">选</th>
                        <th style="width:140px; padding:10px; text-align:left;">时间</th>
                        <th style="width:120px; padding:10px; text-align:left;">操作人</th>
                        <th style="width:100px; padding:10px; text-align:left;">动作</th>
                        <th style="padding:10px; text-align:left;">详情</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach(log => {
            const time = new Date(log.created_at).toLocaleString();
            let color = "#333";
            if(log.action.includes("删除")) color = "#dc2626";
            if(log.action.includes("修改")) color = "#d97706";
            if(log.action.includes("同步")) color = "#2563eb";

            html += `
                <tr style="border-bottom:1px solid #eee; background:white;">
                    <td style="text-align:center;">
                        <input type="checkbox" class="log-item-check" value="${log.id}">
                    </td>
                    <td style="padding:8px 10px; color:#666;">${time}</td>
                    <td style="padding:8px 10px; font-weight:bold;">${log.operator || '-'}</td>
                    <td style="padding:8px 10px; color:${color}; font-weight:bold;">${log.action}</td>
                    <td style="padding:8px 10px; color:#444;">${log.details}</td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        listEl.innerHTML = html;
    },

    // --- 批量操作逻辑 ---

    toggleSelectAll: function(source) {
        document.querySelectorAll('.log-item-check').forEach(cb => cb.checked = source.checked);
    },

    getCheckedIds: function() {
        return Array.from(document.querySelectorAll('.log-item-check:checked')).map(cb => cb.value);
    },

    // 批量软删除
    batchSoftDelete: async function() {
        const ids = this.getCheckedIds();
        if (ids.length === 0) return UI.toast("请至少选择一项", "error");
        
        UI.loading(true, "正在删除...");
        const { error } = await sbClient.from('system_logs').update({ status: 'deleted' }).in('id', ids);
        UI.loading(false);

        if (error) alert("删除失败: " + error.message);
        else {
            UI.toast(`已删除 ${ids.length} 条日志`, "success");
            this.loadLogs();
            if(document.getElementById('log-check-all')) document.getElementById('log-check-all').checked = false;
        }
    },

    // 批量还原
    batchRestore: async function() {
        const ids = this.getCheckedIds();
        if (ids.length === 0) return UI.toast("请至少选择一项", "error");

        UI.loading(true, "正在还原...");
        const { error } = await sbClient.from('system_logs').update({ status: 'normal' }).in('id', ids);
        UI.loading(false);

        if (error) alert("还原失败: " + error.message);
        else {
            UI.toast(`已还原 ${ids.length} 条日志`, "success");
            this.loadLogs();
            if(document.getElementById('log-history-check-all')) document.getElementById('log-history-check-all').checked = false;
        }
    },

    // 批量彻底删除
    batchHardDelete: async function() {
        const ids = this.getCheckedIds();
        if (ids.length === 0) return UI.toast("请至少选择一项", "error");
        if (!confirm(`⚠️ 确定要【彻底销毁】这 ${ids.length} 条日志吗？\n此操作不可恢复！`)) return;

        UI.loading(true, "正在粉碎...");
        const { error, count } = await sbClient.from('system_logs').delete({ count: 'exact' }).in('id', ids);
        UI.loading(false);

        if (error) {
            alert("删除失败: " + error.message);
        } else if (count === 0) {
            alert("⚠️ 删除失败：权限不足！请在 Supabase 开启 system_logs 的 DELETE 权限。");
        } else {
            UI.toast(`彻底删除了 ${count} 条日志`, "success");
            this.loadLogs();
            if(document.getElementById('log-history-check-all')) document.getElementById('log-history-check-all').checked = false;
        }
    }
};

// 🔐 [新增] 多角色账号管理控制器 (管理员/主任/班主任)
const AccountManager = {
    // 1. 打开管理面板
    open: function() {
        const user = Auth.currentUser;
        if (!user) return alert("请先登录");

        // 权限检查列表
        const allowedRoles = ['admin', 'director', 'grade_director', 'class_teacher'];
        if (!allowedRoles.includes(user.role)) {
            return alert("⛔ 权限不足：只有管理员、主任或班主任可以使用此功能。");
        }

        // 根据角色设置提示文案
        const hintEl = document.getElementById('acc-permission-hint');
        let hintText = "";
        
        if (user.role === 'admin') hintText = "👑 管理员权限：可管理系统中【所有】账号。";
        else if (user.role === 'director') hintText = "🎓 教务主任权限：可管理本校【所有】账号。";
        else if (user.role === 'grade_director') hintText = `🚀 级部主任权限：可管理 ${user.class}年级 的【家长】及本校【教师】。`;
        else if (user.role === 'class_teacher') hintText = `📋 班主任权限：仅可管理 ${user.class}班 的【家长】账号。`;

        hintEl.innerHTML = `<i class="ti ti-shield-lock"></i> ${hintText}`;
        
        // 重置界面
        document.getElementById('acc-result-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">请输入关键字搜索</td></tr>';
        document.getElementById('acc-search-input').value = "";
        
        // 显示弹窗
        document.getElementById('account-manager-modal').style.display = 'flex';
        document.getElementById('acc-search-input').focus();
    },

    // 2. 执行搜索 (核心权限逻辑)
    search: async function() {
        const keyword = document.getElementById('acc-search-input').value.trim();
        if (!keyword) return UI.toast("请输入搜索关键字", "warning");

        const user = Auth.currentUser;
        if (!user) return;

        UI.loading(true, "正在搜索账号...");

        // --- A. 构建基础查询 ---
        let query = sbClient
            .from('system_users')
            .select('*')
            .ilike('username', `%${keyword}%`) // 模糊匹配用户名
            .limit(50); // 限制返回条数，防止数据量过大

        // --- B. 数据库级初步过滤 (Role-Based Filter) ---
        
        // 1. 管理员 (admin): 无限制，查所有
        if (user.role === 'admin') {
            // No filter
        }
        
        // 2. 教务主任 (director): 限制本校
        else if (user.role === 'director') {
            query = query.eq('school', user.school);
        }

        // 3. 级部主任 (grade_director): 限制本校 (后续在内存中细分)
        else if (user.role === 'grade_director') {
            query = query.eq('school', user.school);
        }

        // 4. 班主任 (class_teacher): 限制本校 + 本班 + 仅家长
        else if (user.role === 'class_teacher') {
            query = query
                .eq('school', user.school)
                .eq('class_name', user.class) // user.class 如 "701"
                .eq('role', 'parent'); // 只能管家长
        }

        // 执行查询
        const { data, error } = await query;
        
        UI.loading(false);

        if (error) {
            return alert("查询失败: " + error.message);
        }

        // --- C. 内存级二次过滤 (处理复杂逻辑) ---
        let filteredData = data;

        // 级部主任特殊逻辑：可以管【教师】 OR 【本年级家长】
        if (user.role === 'grade_director') {
            const gradePrefix = String(user.class); // 如 "7"
            filteredData = data.filter(u => {
                // 允许管理本校所有教师
                if (u.role === 'teacher') return true; 
                // 允许管理本年级家长 (班级以 "7" 开头)
                if (u.role === 'parent' && String(u.class_name).startsWith(gradePrefix)) return true; 
                // 其他情况 (如别的年级家长、管理员账号) 过滤掉
                return false;
            });
        }

        this.renderTable(filteredData);
    },

    // 3. 渲染结果表格 (已添加“修改信息”按钮)
        renderTable: function(list) {
            const tbody = document.querySelector('#acc-result-table tbody');
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">未找到匹配的账号 (或无权管理)</td></tr>';
                return;
            }
    
            const roleMap = { 'admin':'👑 管理员', 'director':'🎓 教务主任', 'grade_director':'🚀 级部主任', 'class_teacher':'📋 班主任', 'teacher':'👨‍🏫 教师', 'parent':'👨‍👩‍👧 家长' };
            const myRole = Auth.currentUser ? Auth.currentUser.role : 'guest';
    
            let html = '';
            list.forEach(u => {
                const roleName = roleMap[u.role] || u.role;
                
                let canEdit = false;
    
                // 权限判定逻辑 (保持原有严谨性)
                if (myRole === 'admin') {
                    canEdit = (u.role !== 'admin' || u.username === Auth.currentUser.name); // 可以改自己，不能改别的admin
                } else if (myRole === 'director') {
                    canEdit = (u.role !== 'admin' && u.role !== 'director');
                } else {
                    canEdit = (u.role === 'parent' || u.role === 'teacher');
                }
                
                // 按钮样式
                const btnClass = canEdit ? 'btn-primary' : 'btn-gray';
                const cursorStyle = canEdit ? '' : 'cursor:not-allowed; opacity:0.6;';
                const disableAttr = canEdit ? '' : 'disabled';

                // 转义处理，防止单引号破坏 HTML 结构
                const safeUser = u.username.replace(/'/g, "\\'");
                const safeRole = u.role;
                const safeClass = (u.class_name || '').replace(/'/g, "\\'");
    
                html += `
                    <tr>
                        <td style="font-weight:bold;">${u.username}</td>
                        <td><span class="badge" style="background:#e0f2fe; color:#0369a1;">${roleName}</span></td>
                        <td>${u.class_name || '-'}</td>
                        <td style="font-family:monospace; color:#666;">${u.password}</td>
                        <td>
                            <!-- 🟢 新增：修改信息按钮 -->
                            <button class="btn btn-sm btn-purple" ${disableAttr} style="padding:2px 6px; font-size:12px; margin-right:5px; ${cursorStyle}" 
                                    onclick="AccountManager.editAttributes('${safeUser}', '${safeRole}', '${safeClass}')">
                                <i class="ti ti-edit"></i> 修改
                            </button>
                            <!-- 原有：改密按钮 -->
                            <button class="btn btn-sm ${btnClass}" ${disableAttr} style="padding:2px 6px; font-size:12px; ${cursorStyle}" 
                                    onclick="AccountManager.resetPassword('${safeUser}')">
                                <i class="ti ti-key"></i> 改密
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        },


        // 3.5 编辑用户属性 (角色 & 班级)
        editAttributes: async function(username, currentRole, currentClass) {
            // 构建角色下拉选项
            const roleOptions = [
                {val: 'teacher', txt: '👨‍🏫 科任教师 (默认)'},
                {val: 'class_teacher', txt: '📋 班主任 (需填班级)'},
                {val: 'grade_director', txt: '🚀 级部主任 (需填年级)'},
                {val: 'parent', txt: '👨‍👩‍👧 家长/学生 (需填班级)'},
                {val: 'director', txt: '🎓 教务主任'},
                {val: 'admin', txt: '👑 管理员'}
            ].map(opt => `<option value="${opt.val}" ${opt.val === currentRole ? 'selected' : ''}>${opt.txt}</option>`).join('');

            // 弹出 SweetAlert2 表单
            const { value: formValues } = await Swal.fire({
                title: `修改账号信息：${username}`,
                html: `
                    <div style="text-align:left; font-size:14px;">
                        <label style="display:block; margin-bottom:5px; font-weight:bold;">角色权限</label>
                        <select id="swal-edit-role" class="swal2-input" style="margin:0 0 15px 0; width:100%; font-size:14px;">
                            ${roleOptions}
                        </select>
                        
                        <label style="display:block; margin-bottom:5px; font-weight:bold;">
                            班级 / 范围 <small style="color:#666; font-weight:normal;">(教师留空, 家长填班级, 主任填年级)</small>
                        </label>
                        <input id="swal-edit-class" class="swal2-input" value="${currentClass}" placeholder="例如: 901 或 9" style="margin:0; width:100%; font-size:14px;">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '保存修改',
                cancelButtonText: '取消',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        role: document.getElementById('swal-edit-role').value,
                        class_name: document.getElementById('swal-edit-class').value.trim()
                    }
                }
            });

            if (!formValues) return; // 用户取消

            // 简单校验
            if ((formValues.role === 'parent' || formValues.role === 'class_teacher') && !formValues.class_name) {
                return Swal.fire('错误', '修改为家长或班主任时，【班级】不能为空！', 'error');
            }

            UI.loading(true, "正在更新云端数据...");

            // 提交到 Supabase
            const { error } = await sbClient
                .from('system_users')
                .update({ 
                    role: formValues.role,
                    class_name: formValues.class_name 
                })
                .eq('username', username);

            UI.loading(false);

            if (error) {
                alert("❌ 更新失败: " + error.message);
            } else {
                UI.toast(`✅ 账号 [${username}] 信息已更新`, "success");
                // 刷新列表
                this.search(); 
                
                // 记录日志
                if(window.Logger) Logger.log('修改账号信息', `修改了 ${username} 的角色为 ${formValues.role}, 范围为 ${formValues.class_name}`);
            }
        },

    // 4. 重置/修改密码
    resetPassword: async function(username) {
        const newPass = prompt(`🔐 正在修改账号 [${username}] 的密码\n\n请输入新密码 (留空则取消):`);
        if (newPass === null) return;
        if (!newPass.trim()) return alert("密码不能为空");
        const ok = confirm(`⚠️ 确认将账号 [${username}] 的密码修改为：\n${newPass}\n\n此操作将立即生效。是否继续？`);
        if (!ok) return;

        UI.loading(true, "正在更新密码...");

        // 调用 Supabase 更新
        const { error } = await sbClient
            .from('system_users')
            .update({ password: newPass.trim() })
            .eq('username', username);

        UI.loading(false);

        if (error) {
            alert("❌ 修改失败: " + error.message);
        } else {
            UI.toast(`✅ 账号 [${username}] 密码已修改为 ${newPass}`, "success");
            
            // 刷新列表显示新密码
            this.search();
            
            // 记录到操作日志 (如果有 Logger 模块)
            if(window.Logger) Logger.log('修改密码', `修改了用户 ${username} 的密码`);
        }
    }
};

// 📊 [新增] 数据综合管理器 (学生/教师/档案/参数/目标)
const DataManager = {
    currentTab: 'student', // student | teacher | archive | params | targets
    pagination: { page: 1, size: 50, total: 0 },
    
    // 1. 打开面板
    open: function() {
        const user = Auth.currentUser;
        if (!user) return alert("请先登录");
        if (user.role !== 'admin' && user.role !== 'director') {
            return alert("⛔ 权限不足：只有管理员或教务主任可操作底层数据。");
        }
        
        document.getElementById('data-manager-modal').style.display = 'flex';
        this.switchTab('student');
    },

    // 2. 切换标签页 (修复版：支持所有管理模块)
    switchTab: function(tab) {
        this.currentTab = tab;
        this.pagination.page = 1;
        const searchInput = document.getElementById('dm-search-input');
        if(searchInput) searchInput.value = ''; 
        
        // 样式切换
        document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
        
        let tabId = 'tab-data-stu';
        if(tab === 'teacher') tabId = 'tab-data-tea';
        if(tab === 'archive') tabId = 'tab-data-arch';
        if(tab === 'params') tabId = 'tab-data-params';
        if(tab === 'targets') tabId = 'tab-data-targets';
        if(tab === 'sql') tabId = 'tab-data-sql';
        if(tab === 'cloud') tabId = 'tab-data-cloud';
        if(tab === 'history') tabId = 'tab-data-history';

        const el = document.getElementById(tabId);
        if(el) el.classList.add('active');
        
        // --- 区域显隐控制 ---
        
        // 学生表
        const stuTable = document.getElementById('dm-student-table');
        if(stuTable) stuTable.style.display = tab === 'student' ? 'table' : 'none';
        
        // 教师区域 (新版容器)
        const teaArea = document.getElementById('dm-teacher-area');
        if(teaArea) teaArea.style.display = tab === 'teacher' ? 'block' : 'none';
        
        // 隐藏旧版直接引用的教师表 (防止冲突)
        const oldTeaTable = document.getElementById('dm-teacher-table');
        if(oldTeaTable && !teaArea) oldTeaTable.style.display = tab === 'teacher' ? 'table' : 'none';

        // 其他区域
        const archArea = document.getElementById('dm-archive-area');
        if(archArea) archArea.style.display = tab === 'archive' ? 'block' : 'none';
        
        const paramArea = document.getElementById('dm-params-area');
        if(paramArea) paramArea.style.display = tab === 'params' ? 'block' : 'none';
        
        const targetArea = document.getElementById('dm-targets-area');
        if(targetArea) targetArea.style.display = tab === 'targets' ? 'block' : 'none';
        
        const sqlArea = document.getElementById('dm-sql-area');
        if(sqlArea) sqlArea.style.display = tab === 'sql' ? 'flex' : 'none';

        const cloudArea = document.getElementById('dm-cloud-area');
        if(cloudArea) cloudArea.style.display = tab === 'cloud' ? 'flex' : 'none';

        const histArea = document.getElementById('dm-history-area');
        if(histArea) histArea.style.display = tab === 'history' ? 'flex' : 'none';
        
        // 如果切到云端管理，立即加载列表
        if(tab === 'cloud') this.renderCloudBackups();
        if(tab === 'sql') this.renderSQLHistory();

        // 搜索栏和分页栏逻辑 (教师页现在有独立筛选，不再使用顶部通用搜索)
        const showSearch = (tab === 'student'); 
        const searchBar = document.getElementById('dm-search-bar');
        const pageBar = document.getElementById('dm-pagination');
        if(searchBar) searchBar.style.display = showSearch ? 'flex' : 'none';
        if(pageBar) pageBar.style.display = showSearch ? 'flex' : 'none';

        // 初始化教师页面的学校下拉框
        if (tab === 'teacher') {
            // 强制重新初始化届别元数据，防止因数据延迟导致的渲染失败
            if (!window.CURRENT_COHORT_META && window.CURRENT_COHORT_ID) {
                try {
                    const storedMeta = localStorage.getItem('CURRENT_COHORT_META');
                    if (storedMeta) window.CURRENT_COHORT_META = JSON.parse(storedMeta);
                    else window.CURRENT_COHORT_META = { id: window.CURRENT_COHORT_ID, year: String(window.CURRENT_COHORT_ID).replace(/\D/g,'') };
                } catch(e) {}
            }

            this.updateTeacherSchoolSelect();
            this.renderTeacherTermSelect();
            
            // 🟢 [修复]：选中学期并自动同步云端数据
            setTimeout(() => {
                const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
                if(termId) {
                    const sel = document.getElementById('dm-teacher-term-select');
                    if(sel) sel.value = termId;
                    // switchTeacherTerm 内部已经包含云端同步逻辑
                    DataManager.switchTeacherTerm(termId);
                }
            }, 50);
        }

        // 👇👇👇 🟢 [同步修复]：切换到参数页时，强制刷新数据显示 🟢 👇👇👇
        if (tab === 'params') {
            this.renderParams();
        }

        this.renderCurrentTab();
    },

    // --- 模块 A: 云端数据管理 (重构版) ---
    renderCloudBackups: async function() {
        if (!sbClient) return;
        const tbody = document.querySelector('#dm-cloud-table tbody');
        const summaryEl = document.getElementById('dm-cloud-summary');
        
        // 初始化加载状态
        if(tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">⏳ 正在读取云端数据库...</td></tr>';
        if(summaryEl) {
            summaryEl.style.display = 'block';
            summaryEl.innerHTML = '⏳ 正在分析数据...';
        }

        try {
            // 1. 获取数据列表 (只取元数据，不取你可以让载荷过大的 content)
            const { data, error } = await sbClient
                .from('system_data')
                .select('key, created_at, updated_at, content') // content 用于计算大小
                .order('updated_at', { ascending: false });

            if (error) throw error;

            if (!data || data.length === 0) {
                if(tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#64748b;">☁️ 云端数据库为空</td></tr>';
                if(summaryEl) summaryEl.innerHTML = '📌 暂无存档记录';
                return;
            }

            // 2. 统计信息
            const totalSize = data.reduce((acc, item) => acc + (item.content ? item.content.length : 0), 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            if(summaryEl) {
                summaryEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>📌 云端共 <b>${data.length}</b> 个存档 | 总占用: <b>${totalSizeMB} MB</b></span>
                        <span style="font-size:11px; color:#94a3b8;">只显示最近更新的记录</span>
                    </div>
                `;
            }

            // 3. 渲染列表
            const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY');
            let rows = '';
            
            data.forEach(item => {
                const isCurrent = (item.key === currentKey);
                const sizeKB = (item.content ? item.content.length / 1024 : 0).toFixed(1);
                const time = new Date(item.updated_at || item.created_at).toLocaleString();
                
                // 解析Key结构：2022级_9年级_2025-2026_上学期_期中_全镇联考
                // 如果不符合结构，则直接显示Key
                let displayName = item.key;
                let tags = '';
                
                const parts = item.key.split('_');
                if (parts.length >= 5) {
                    displayName = `<b>${parts[0]} ${parts[1]}</b><br><span style="color:#64748b; font-size:11px;">${parts[2]} ${parts[3]} ${parts[5]||''}</span>`;
                    tags = `<span class="badge" style="background:${parts[4]==='期末'?'#ef4444':'#3b82f6'}; color:white; padding:2px 6px; border-radius:4px; font-size:10px;">${parts[4]}</span>`;
                }

                rows += `
                    <tr style="${isCurrent ? 'background:#f0fdf4;' : ''}">
                        <td>
                            <div style="display:flex; align-items:center; gap:8px;">
                                ${isCurrent ? '<i class="ti ti-current-location" style="color:#16a34a;" title="当前项目"></i>' : ''}
                                <div>${displayName}</div>
                                ${tags}
                            </div>
                        </td>
                        <td style="font-size:12px; color:#64748b;">${time}</td>
                        <td style="font-size:12px;">${sizeKB} KB</td>
                        <td>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-sm btn-primary" onclick="DataManager.loadCloudBackup('${item.key}')" title="读取此存档">
                                    <i class="ti ti-download"></i> 读取
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="DataManager.deleteCloudBackup('${item.key}')" title="永久删除">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            if(tbody) tbody.innerHTML = rows;

        } catch (err) {
            console.error(err);
            if(tbody) tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#ef4444;">❌ 加载失败: ${err.message}</td></tr>`;
        }
    },

    // 加载指定的云端存档
    loadCloudBackup: async function(key) {
        if (!confirm(`⚠️ 确定要切换到存档 [${key}] 吗？\n当前未保存的工作将会丢失。`)) return;
        
        // 临时修改 Current Key，然后调用 CloudManager.load
        localStorage.setItem('CURRENT_PROJECT_KEY', key);
        await CloudManager.load();
        
        // 刷新列表状态
        this.renderCloudBackups();
    },

    deleteCloudBackup: async function(key) {
        if (!confirm(`🧨 危险操作！\n\n确定要永久删除 [${key}] 吗？\n删除后无法恢复！`)) return;
        
        UI.loading(true, `正在删除 ${key}...`);
        try {
            const { error } = await sbClient
                .from('system_data')
                .delete()
                .eq('key', key);
            
            if (error) throw error;
            
            UI.toast('✅ 删除成功', 'success');
            this.renderCloudBackups();
        } catch (e) {
            alert('删除失败: ' + e.message);
        } finally {
            UI.loading(false);
        }
    },



    // --- 模块 B: 历史数据上传 (Sheet名=学校名, 班级+姓名=Key) ---
    handleHistoryUpload: function(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                
                let parsedHistory = [];
                let calcModeMsg = ""; 
                
                // 1. 遍历所有 Sheet
                wb.SheetNames.forEach(sheetName => {
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                    if (json.length === 0) return;

                    const sample = json[0];
                    const keyName = Object.keys(sample).find(k => k.includes('姓名') || k.toLowerCase() === 'name');
                    const keyClass = Object.keys(sample).find(k => k.includes('班') || k.toLowerCase().includes('class'));
                    const keyScore = Object.keys(sample).find(k => k.includes('总分') || k.includes('得分') || k.includes('Total'));
                    
                    const subjectKeywords = ['语文','数学','英语','物理','化学','政治','历史','地理','生物','科学','道法'];
                    const subjectColMap = {}; 
                    
                    Object.keys(sample).forEach(header => {
                        const cleanHeader = header.trim();
                        if (cleanHeader.includes('排') || cleanHeader.includes('赋')) return;
                        const matchedSub = subjectKeywords.find(k => cleanHeader.includes(k));
                        if (matchedSub) {
                            subjectColMap[matchedSub] = header; 
                            if (!SUBJECTS.includes(matchedSub)) SUBJECTS.push(matchedSub);
                        }
                    });
                    SUBJECTS.sort(sortSubjects);

                    // 确定计算策略
                    const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
                    let targetSubjects = isGrade9 ? ['语文', '数学', '英语', '物理', '化学'] : Object.keys(subjectColMap);
                    if (isGrade9) calcModeMsg = "9年级模式"; else calcModeMsg = "全科模式";

                    let schoolStudents = [];

                    json.forEach((row, idx) => {
                        let name = keyName ? row[keyName] : "";
                        if (!name || String(name).trim() === '') name = `${sheetName}_考生_${idx + 1}`;
                        let className = (keyClass && row[keyClass]) ? normalizeClass(row[keyClass]) : "默认班级";
                        
                        let totalScore = 0;
                        let scoresObj = {}; 

                        // 解析单科
                        Object.keys(subjectColMap).forEach(sub => {
                            const colName = subjectColMap[sub];
                            if (row[colName] !== undefined) {
                                const val = parseFloat(row[colName]);
                                if (!isNaN(val)) scoresObj[sub] = val;
                            }
                        });

                        // 计算总分
                        if (keyScore && row[keyScore] !== undefined) {
                            totalScore = parseFloat(row[keyScore]);
                        } else {
                            let sum = 0; let hasValidSub = false;
                            targetSubjects.forEach(sub => {
                                if (scoresObj[sub] !== undefined) { sum += scoresObj[sub]; hasValidSub = true; }
                            });
                            if (hasValidSub) totalScore = parseFloat(sum.toFixed(2));
                        }

                        schoolStudents.push({
                            name: String(name).trim(),
                            class: className,
                            school: sheetName,
                            total: totalScore || 0,
                            scores: scoresObj,
                            ranks: {} // 初始化排名对象
                        });
                    });
                    parsedHistory = parsedHistory.concat(schoolStudents);
                });

                if (parsedHistory.length === 0) throw new Error("未解析到有效数据");

                // ==========================================
                // 🔥 核心升级：计算历史数据的【总分】及【所有单科】排名 🔥
                // ==========================================
                
                // 辅助函数：通用排名计算
                const calcRank = (list, scoreGetter, rankSetter) => {
                    list.sort((a,b) => scoreGetter(b) - scoreGetter(a));
                    list.forEach((s, i) => rankSetter(s, i + 1));
                };

                // 1. 全镇范围 (总分 + 单科)
                calcRank(parsedHistory, s => s.total, (s, r) => { if(!s.ranks.total) s.ranks.total={}; s.townRank = r; s.ranks.total.township = r; });
                
                SUBJECTS.forEach(sub => {
                    // 过滤出有该科成绩的学生
                    const validList = parsedHistory.filter(s => s.scores[sub] !== undefined);
                    calcRank(validList, s => s.scores[sub], (s, r) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].township = r; });
                });

                // 2. 学校范围 (总分 + 单科)
                const schools = {};
                parsedHistory.forEach(s => { if(!schools[s.school]) schools[s.school]=[]; schools[s.school].push(s); });
                
                Object.values(schools).forEach(group => {
                    calcRank(group, s => s.total, (s, r) => { s.schoolRank = r; s.ranks.total.school = r; });
                    SUBJECTS.forEach(sub => {
                        const validList = group.filter(s => s.scores[sub] !== undefined);
                        calcRank(validList, s => s.scores[sub], (s, r) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].school = r; });
                    });
                });

                // 3. 班级范围 (总分 + 单科)
                const classes = {};
                parsedHistory.forEach(s => { const k = s.school+"_"+s.class; if(!classes[k]) classes[k]=[]; classes[k].push(s); });

                Object.values(classes).forEach(group => {
                    calcRank(group, s => s.total, (s, r) => { s.classRank = r; s.ranks.total.class = r; });
                    SUBJECTS.forEach(sub => {
                        const validList = group.filter(s => s.scores[sub] !== undefined);
                        calcRank(validList, s => s.scores[sub], (s, r) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].class = r; });
                    });
                });
                // ==========================================

                window.PREV_DATA = parsedHistory; 
                
                // 更新 UI
                const statusEl = document.getElementById('dm-history-status');
                statusEl.innerHTML = `✅ 已加载 ${parsedHistory.length} 条 | ${calcModeMsg}`;
                statusEl.style.color = "#16a34a";
                
                DataManager.renderHistoryPreview();
                if (typeof performSilentMatching === 'function') performSilentMatching();
                if(typeof saveCloudData === 'function') saveCloudData();

                alert(`历史数据导入成功！\n共 ${parsedHistory.length} 人。\n✅ 已自动计算历史总分及单科的三级排名(班/校/镇)。`);
                input.value = ''; 

            } catch (err) {
                console.error(err);
                alert("解析失败: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },
    

    renderHistoryPreview: function() {
        const tbody = document.querySelector('#dm-history-preview-table tbody');
        if (!window.PREV_DATA || window.PREV_DATA.length === 0) return;

        // 判断是否单校
        const schools = new Set(window.PREV_DATA.map(s => s.school));
        const isSingleSchool = schools.size === 1;

        let html = '';
        // 只展示前 50 条预览
        window.PREV_DATA.slice(0, 50).forEach(s => {
            const townRankDisplay = isSingleSchool ? '<span style="color:#ccc">-</span>' : s.townRank;
            html += `
                <tr>
                    <td>${s.school}</td>
                    <td>${s.class}</td>
                    <td>${s.name.includes('无名氏') ? '<span style="color:#999;font-style:italic;">'+s.name+'</span>' : '<strong>'+s.name+'</strong>'}</td>
                    <td style="font-weight:bold; color:#1e3a8a;">${s.total}</td>
                    <td>${s.schoolRank}</td>
                    <td>${townRankDisplay}</td>
                </tr>
            `;
        });
        
        if (window.PREV_DATA.length > 50) {
            html += `<tr><td colspan="6" style="text-align:center; color:#666;">... 共 ${window.PREV_DATA.length} 条记录 ...</td></tr>`;
        }
        
        tbody.innerHTML = html;
        
        // 动态隐藏/显示表头
        const townTh = document.querySelector('#dm-history-preview-table th:last-child');
        if (townTh) {
            if (isSingleSchool) {
                townTh.innerHTML = '<span style="color:#ccc; text-decoration:line-through">全镇排名</span><br><small>(单校已隐藏)</small>';
            } else {
                townTh.innerText = '全镇排名';
            }
        }
    },

    // 3. 渲染调度器
    renderCurrentTab: function() {
        const input = document.getElementById('dm-search-input');
        const keyword = input ? input.value.trim().toLowerCase() : '';
        
        if (this.currentTab === 'student') {
            this.renderStudents(keyword);
        } else if (this.currentTab === 'teacher') {
            this.renderTeachers(); // 教师页独立渲染
        } else if (this.currentTab === 'archive') {
            this.renderArchives();
        } else if (this.currentTab === 'params') {
            this.renderParams();
        } else if (this.currentTab === 'targets') {
            this.renderTargets();
        }        
    },

    // 4. 学生列表渲染 (优化版：使用 DocumentFragment 和字符串拼接优化性能)
    renderStudents: function(keyword) {
        if (!window.RAW_DATA) return;

        // 性能优化：仅在有搜索词时进行过滤
        let list = keyword 
            ? RAW_DATA.filter(s => 
                (s.name && s.name.toLowerCase().includes(keyword)) || 
                (String(s.id) && String(s.id).includes(keyword)) || 
                (s.class && s.class.includes(keyword)) || 
                (s.school && s.school.includes(keyword))
              ).map((item, index) => ({ ...item, _originalIndex: RAW_DATA.indexOf(item) }))
            : RAW_DATA.map((item, index) => ({ ...item, _originalIndex: index }));
        
        this.pagination.total = list.length;
        const totalPages = Math.ceil(this.pagination.total / this.pagination.size) || 1;
        
        if (this.pagination.page > totalPages) this.pagination.page = totalPages;
        if (this.pagination.page < 1) this.pagination.page = 1;
        
        const start = (this.pagination.page - 1) * this.pagination.size;
        const pageData = list.slice(start, start + this.pagination.size);
        
        const tbody = document.querySelector('#dm-student-table tbody');
        if (!tbody) return;

        if (pageData.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">无数据</td></tr>'; 
        } else {
            // 使用数组 join 拼接字符串，比 += 性能更好
            const rows = pageData.map(s => `
                <tr>
                    <td>${s.school}</td>
                    <td>${s.class}</td>
                    <td style="font-weight:bold;">${s.name}</td>
                    <td>${s.id}</td>
                    <td>${s.total}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="DataManager.editStudent(${s._originalIndex})" style="padding:2px 6px; font-size:11px;">编辑</button> 
                        <button class="btn btn-sm btn-danger" onclick="DataManager.deleteStudent(${s._originalIndex})" style="padding:2px 6px; background:#dc2626; font-size:11px;">删除</button>
                    </td>
                </tr>`);
            tbody.innerHTML = rows.join('');
        }
        this.updatePaginationUI(totalPages);
    },

    // 5. 分页 UI 更新
    updatePaginationUI: function(totalPages) {
        const el = document.getElementById('dm-page-info');
        if(el) el.innerText = `${this.pagination.page} / ${totalPages}`;
    },

    changePage: function(delta) {
        this.pagination.page += delta;
        this.renderCurrentTab();
    },

    // --- 教师管理核心逻辑 ---

    // 🟢 [修复]：动态渲染学期下拉框 (智能届别模式)
    renderTeacherTermSelect: function() {
        const sel = document.getElementById('dm-teacher-term-select');
        if (!sel) return;
        
        let years = [];
        let startYear = null;

        // 1. 优先从内存元数据读取
        if (window.CURRENT_COHORT_META && window.CURRENT_COHORT_META.year) {
            startYear = parseInt(window.CURRENT_COHORT_META.year, 10);
        }

        // 2. 再从本地存储读取
        if (!startYear) {
            try {
                const metaStr = localStorage.getItem('CURRENT_COHORT_META');
                if (metaStr) {
                    const meta = JSON.parse(metaStr);
                    if (meta && meta.year) startYear = parseInt(meta.year, 10);
                }
            } catch (e) {}
        }

        // 3. 再从届别ID推断
        if (!startYear) {
            const id = window.CURRENT_COHORT_ID || localStorage.getItem('CURRENT_COHORT_ID');
            const match = id ? String(id).match(/(\d{4})/) : null;
            if (match) startYear = parseInt(match[1], 10);
        }

        // 4. 最后从界面标签文本兜底
        if (!startYear) {
            const label = document.getElementById('cohort-current-label')?.innerText || '';
            const match = label.match(/(\d{4})/);
            if (match) startYear = parseInt(match[1], 10);
        }

        // 2. 生成学年列表
        if (startYear) {
            // 届别模式：生成 6年级(入学) 到 9年级(毕业) 的4个学年
            // Year 0 (6级): startYear
            // Year 3 (9级): startYear + 3
            for (let i = 0; i < 4; i++) {
                years.push(startYear + i);
            }
        } else {
            // 兜底模式：当前年份 前后推导
            const currentYear = new Date().getFullYear();
            years = [currentYear - 2, currentYear - 1, currentYear, currentYear + 1];
        }

        let options = '';
        years.forEach(year => {
            const yearStr = `${year}-${year+1}`; // e.g., 2022-2023
            
            // 计算年级标签
            let gradeLabel = '';
            if (startYear) {
                const gradeNum = 6 + (year - startYear);
                gradeLabel = ` [${gradeNum}年级]`;
            }

            ['上学期','下学期'].forEach(term => {
                const termId = `${yearStr}_${term}`; 
                options += `<option value="${termId}">${yearStr} ${term}${gradeLabel}</option>`;
            });
        });

        sel.innerHTML = options;
        
        // 3. 智能选中逻辑
        const uiMeta = getExamMetaFromUI();
        const savedTerm = localStorage.getItem('CURRENT_TERM_ID');

        // 数据清洗：检查当前 value 是否在 options 里
        const setAndValidate = (val) => {
            sel.value = val;
            return sel.value === val; // 验证是否选中成功
        };

        let isSet = false;
        if (uiMeta.year && uiMeta.term) {
            // 优先选中顶部工具栏的设置
            isSet = setAndValidate(`${uiMeta.year}_${uiMeta.term}`);
        } 
        
        if (!isSet && savedTerm) {
            // 其次选中上次保存的
            isSet = setAndValidate(savedTerm);
        }

        // 如果都没选中（比如切换了届别，年份变了），默认选中最后一项（最高年级）
        if (!sel.value && sel.options.length > 0) {
            sel.value = sel.options[sel.options.length - 1].value;
        }
    },

    // 🟢 [修复]：修正 updateTeacherSchoolSelect 缺失问题
    updateTeacherSchoolSelect: function() {
        const sel = document.getElementById('dm-teacher-school-select');
        if (!sel) return;
        
        const currentVal = sel.value;
        // 如果有上传数据，则从 TEACHER_MAP 中扫描学校
        // 否则显示 global SCHOOLS
        let schools = new Set();
        
        if (typeof SCHOOLS !== 'undefined') {
            Object.keys(SCHOOLS).forEach(s => schools.add(s));
        }

        sel.innerHTML = '<option value="">-- 显示全部 --</option>';
        [...schools].sort().forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });
        
        if (currentVal && schools.has(currentVal)) sel.value = currentVal;
    },

    switchTeacherTerm: function(termId) {
        if(!termId) return;
        localStorage.setItem('CURRENT_TERM_ID', termId);
        // 这里可以增加重新从云端拉取该学期任课表的逻辑
        // CloudManager.loadTeachers(); 暂不自动拉取，让用户手动点同步按钮
    },

    // 自动将上传的任课数据同步到 CloudManager 的学期档案
    handleTeacherUpload: function(input) {
        const file = input.files[0];
        if (!file) return;
        const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
        if (!termId) return alert('请先设置当前考试/学期');

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const sheetName = wb.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                
                if (json.length === 0) {
                    alert("表格为空或格式不正确");
                    return;
                }

                let count = 0;
                json.forEach(row => {
                    const className = normalizeClass(row['班级'] || row['class'] || row['Class']);
                    const subject = row['学科'] || row['subject'] || row['科目'];
                    const teacher = row['教师'] || row['teacher'] || row['教师姓名'] || row['姓名'];

                    if (className && subject && teacher) {
                        TEACHER_MAP[`${className}_${subject}`] = teacher;
                        count++;
                    }
                });

                DataManager.syncTeacherHistory();
                DataManager.renderTeachers();

                // 🔥 自动存档到云端学期库
                if (window.CloudManager && CloudManager.saveTeachers) {
                    CloudManager.saveTeachers();
                }

                alert(`✅ 成功导入 ${count} 条任课信息！\n已自动同步至云端学期档案，供同类考试共用。`);
                input.value = ''; 

            } catch (err) {
                console.error(err);
                alert("解析失败：" + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },

    renderTeacherTermSelect: function() {
        const sel = document.getElementById('dm-teacher-term-select');
        if (!sel) return;

        const getEntryYear = () => {
            let y = null;

            if (window.CURRENT_COHORT_META && window.CURRENT_COHORT_META.year) {
                y = parseInt(window.CURRENT_COHORT_META.year, 10);
            }

            if (!y) {
                try {
                    const metaStr = localStorage.getItem('CURRENT_COHORT_META');
                    if (metaStr) {
                        const meta = JSON.parse(metaStr);
                        if (meta && meta.year) y = parseInt(meta.year, 10);
                    }
                } catch (e) {}
            }

            if (!y) {
                const id = window.CURRENT_COHORT_ID || localStorage.getItem('CURRENT_COHORT_ID');
                const match = id ? String(id).match(/(\d{4})/) : null;
                if (match) y = parseInt(match[1], 10);
            }

            if (!y) {
                const label = document.getElementById('cohort-current-label')?.innerText || '';
                const match = label.match(/(\d{4})/);
                if (match) y = parseInt(match[1], 10);
            }

            if (!y) {
                try {
                    const list = JSON.parse(localStorage.getItem(COHORT_STORAGE_KEY) || '[]');
                    const currentId = window.CURRENT_COHORT_ID || localStorage.getItem('CURRENT_COHORT_ID');
                    const found = list.find(c => String(c.id) === String(currentId));
                    if (found && found.year) y = parseInt(found.year, 10);
                    if (!y && list.length) y = parseInt(list[0].year, 10);
                } catch (e) {}
            }

            return y;
        };

        let years = [];
        const startYear = getEntryYear();

        if (startYear) {
            for (let i = 0; i < 4; i++) years.push(startYear + i);
        } else {
            const currentYear = new Date().getFullYear();
            years = [currentYear - 2, currentYear - 1, currentYear, currentYear + 1];
        }

        let options = '';
        years.forEach(year => {
            const yearStr = `${year}-${year + 1}`;
            let gradeLabel = '';
            if (startYear) {
                const gradeNum = 6 + (year - startYear);
                gradeLabel = ` [${gradeNum}年级]`;
            }
            ['上学期', '下学期'].forEach(term => {
                const termId = `${yearStr}_${term}`;
                options += `<option value="${termId}">${yearStr} ${term}${gradeLabel}</option>`;
            });
        });

        sel.innerHTML = options || '<option value="">暂无学期</option>';

        const uiMeta = getExamMetaFromUI();
        const saved = localStorage.getItem('CURRENT_TERM_ID');
        const prefer = uiMeta.year && uiMeta.term ? `${uiMeta.year}_${uiMeta.term}` : saved;
        if (prefer) sel.value = prefer;
        if (!sel.value && sel.options.length) sel.value = sel.options[0].value;
    },

    switchTeacherTerm: function(termId) {
        if (!termId) return;
        localStorage.setItem('CURRENT_TERM_ID', termId);
        
        // 🟢 [修复]：切换学期时，先尝试从本地历史读取
        const db = CohortDB.ensure();
        const history = db.teachingHistory || {};
        const hasLocal = history[termId] && Object.keys(history[termId]).length > 0;
        
        if (hasLocal) {
            // 有本地数据，直接使用
            TEACHER_MAP = JSON.parse(JSON.stringify(history[termId]));
            this.renderTeachers();
            console.log(`✅ 已从本地历史加载学期 ${termId} 的任课表`);
        } else {
            // 🟢 [修复]：本地无数据，自动尝试从云端拉取
            console.log(`⚠️ 本地无学期 ${termId} 的任课数据，尝试从云端同步...`);
            TEACHER_MAP = {};
            this.renderTeachers(); // 先渲染空表
            
            // 异步从云端加载
            if (window.CloudManager && CloudManager.loadTeachers) {
                CloudManager.loadTeachers().catch(err => {
                    console.warn('云端加载失败:', err);
                });
            }
        }
    },

    syncTeacherHistory: function() {
        const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
        if (!termId) return;
        const db = CohortDB.ensure();
        db.teachingHistory = db.teachingHistory || {};
        db.teachingHistory[termId] = JSON.parse(JSON.stringify(TEACHER_MAP));
    },

    handleTeacherUpload: function(input) {
        const file = input.files[0];
        if (!file) return;
        
        // 🟢 [修复] 检查 XLSX 库是否加载
        if (typeof XLSX === 'undefined') {
            alert('❌ Excel解析库未加载，请刷新页面后重试');
            return;
        }
        
        const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
        if (!termId) return alert('请先设置当前考试/学期');

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const sheetName = wb.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                
                if (json.length === 0) {
                    alert("表格为空或格式不正确");
                    return;
                }

                let count = 0;
                json.forEach(row => {
                    const className = normalizeClass(row['班级'] || row['class'] || row['Class']);
                    const subject = row['学科'] || row['subject'] || row['科目'];
                    const teacher = row['教师'] || row['teacher'] || row['教师姓名'] || row['姓名'];

                    if (className && subject && teacher) {
                        TEACHER_MAP[`${className}_${subject}`] = teacher;
                        count++;
                    }
                });

                DataManager.syncTeacherHistory();
                DataManager.renderTeachers();
                
                // 🟢 [修复] 导入成功后自动同步到云端
                if (window.CloudManager && CloudManager.saveTeachers) {
                    CloudManager.saveTeachers().then(() => {
                        if (window.UI) UI.toast(`✅ 已导入 ${count} 条任课信息并同步到云端`, "success");
                    }).catch(err => {
                        console.error('云端同步失败:', err);
                        alert(`✅ 成功导入 ${count} 条任课信息！\n\n⚠️ 但云端同步失败，请手动点击右上角【保存修改并同步云端】按钮。`);
                    });
                } else {
                    alert(`✅ 成功导入 ${count} 条任课信息！`);
                }
                input.value = ''; 

            } catch (err) {
                console.error('Excel解析错误:', err);
                alert("❌ 解析失败：" + err.message + "\n\n请确保：\n1. Excel文件格式正确\n2. 包含'班级'、'学科'、'教师'列\n3. 数据格式符合要求");
            }
        };
        reader.onerror = function() {
            alert('❌ 文件读取失败，请重试');
        };
        reader.readAsArrayBuffer(file);
    },

    renderTeachers: function() {
        const tbody = document.querySelector('#dm-teacher-table tbody');
        if(!tbody) return;
        tbody.innerHTML = '';

        const sel = document.getElementById('dm-teacher-school-select');
        const selectedSchool = sel ? sel.value : "";

        // 若学期下拉仍未渲染，进行兜底刷新
        const termSel = document.getElementById('dm-teacher-term-select');
        if (termSel && termSel.options && termSel.options.length <= 1) {
            const txt = termSel.options[0]?.textContent || '';
            if (txt.includes('暂无学期')) {
                this.renderTeacherTermSelect();
            }
        }
        
        let list = Object.entries(TEACHER_MAP).map(([key, name]) => {
            const parts = key.split('_');
            const clsName = parts[0];
            const subject = parts.length > 1 ? parts[1] : '(未知)';
            
            let schoolName = "未知/未上传";
            if (typeof SCHOOLS !== 'undefined') {
                for (const [schName, schData] of Object.entries(SCHOOLS)) {
                    if (schData.students && schData.students.some(s => s.class == clsName)) {
                        schoolName = schName;
                        break;
                    }
                }
            }
            return { key, class: clsName, subject, name, school: schoolName };
        });

        // 逻辑：统计列表中出现频率最高的学校，自动将其设为 MY_SCHOOL
        if (list.length > 0) {
            const schoolCounts = {};
            list.forEach(t => {
                if (t.school && !t.school.includes("未知")) {
                    schoolCounts[t.school] = (schoolCounts[t.school] || 0) + 1;
                }
            });

            // 找出数量最多的学校
            let maxCount = 0;
            let autoDetectedSchool = "";
            for (const [sch, count] of Object.entries(schoolCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    autoDetectedSchool = sch;
                }
            }

            // 如果找到了有效学校，且当前未设置或不一致，则强制自动同步
            if (autoDetectedSchool && window.MY_SCHOOL !== autoDetectedSchool) {
                window.MY_SCHOOL = autoDetectedSchool;
                console.log(`🤖 系统已自动将本校锁定为：${autoDetectedSchool}`);
                
                // 同步更新主界面的下拉框 UI
                const mainSelect = document.getElementById('mySchoolSelect');
                if (mainSelect) {
                    mainSelect.value = autoDetectedSchool;
                    // 稍微延时触发变更事件，确保数据加载完成
                    setTimeout(() => {
                        // 仅更新内存，不频繁触发 renderTables 以免卡顿，但在关闭模态框时会生效
                    }, 100);
                }
                
                // 提示用户
                if(window.UI && list.length > 5) { // 只有数据量足够时才提示
                    // UI.toast(`已自动识别本校为：${autoDetectedSchool}`, "success");
                }
            }
        }

        if (selectedSchool) {
            list = list.filter(t => t.school === selectedSchool);
        }

        list.sort((a,b) => {
            if (a.school !== b.school) return a.school.localeCompare(b.school);
            if (a.class !== b.class) return a.class.localeCompare(b.class, undefined, {numeric:true});
            return a.subject.localeCompare(b.subject);
        });

        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">暂无任课数据 (或未匹配到该校班级)</td></tr>';
        } else {
            const displayList = list.slice(0, 500); 
            
            displayList.forEach(t => {
                const schoolStyle = t.school.includes("未知") ? "color:#94a3b8; font-style:italic;" : "color:#475569;";
                tbody.innerHTML += `
                    <tr>
                        <td style="${schoolStyle}">${t.school}</td>
                        <td style="font-weight:bold;">${t.class}</td>
                        <td><span class="badge" style="background:#f1f5f9; color:#475569;">${t.subject}</span></td>
                        <td style="font-weight:bold; color:#1e293b;">${t.name}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="DataManager.editTeacher('${t.key}', '${t.name}')" style="padding:2px 6px; font-size:11px;">修改</button> 
                            <button class="btn btn-sm btn-danger" onclick="DataManager.deleteTeacher('${t.key}')" style="padding:2px 6px; background:#dc2626; font-size:11px;">删除</button>
                        </td>
                    </tr>`;
            });
            
            if (list.length > 500) {
                tbody.innerHTML += `<tr><td colspan="5" style="text-align:center; color:#999; padding:5px;">... 数据过多，仅显示前 500 条 ...</td></tr>`;
            }
        }
    },

    // --- 数据操作辅助函数 ---

    deleteStudent: function(index) { 
        const s = RAW_DATA[index]; 
        if(!s) return; 
        if(!confirm(`⚠️ 确定要永久删除学生【${s.school} ${s.class}班 ${s.name}】吗？`)) return; 
        RAW_DATA.splice(index, 1); 
        this.renderCurrentTab(); 
        UI.toast("已暂存删除 (请点击保存)", "info"); 
    },

    editStudent: function(index) { 
        const s = RAW_DATA[index]; 
        Swal.fire({ 
            title: '编辑学生信息', 
            html: `<div style="text-align:left; font-size:14px; line-height:2.5;">
                <label style="width:50px; display:inline-block;">姓名:</label> <input id="swal-name" class="swal2-input" value="${s.name}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">班级:</label> <input id="swal-class" class="swal2-input" value="${s.class}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">考号:</label> <input id="swal-id" class="swal2-input" value="${s.id}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">学校:</label> <input id="swal-school" class="swal2-input" value="${s.school}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">状态:</label>
                <select id="swal-status" class="swal2-input" style="width:200px; height:30px; margin:0;">
                    <option value="active">正常</option>
                    <option value="transfer_in">转入</option>
                    <option value="transfer_out">转出</option>
                    <option value="leave">休学/借读</option>
                </select>
            </div>`, 
            showCancelButton: true, 
            confirmButtonText: '暂存修改', 
            didOpen: () => {
                const st = document.getElementById('swal-status');
                const saved = (s.status || (COHORT_DB?.students?.[s.uuid]?.status)) || 'active';
                if (st) st.value = saved;
            },
            preConfirm: () => ({ 
                name: document.getElementById('swal-name').value.trim(), 
                class: document.getElementById('swal-class').value.trim(), 
                id: document.getElementById('swal-id').value.trim(), 
                school: document.getElementById('swal-school').value.trim(),
                status: document.getElementById('swal-status').value
            }) 
        }).then((result) => { 
            if (result.isConfirmed) { 
                const n = result.value; 
                if(!n.name || !n.class) return; 
                Object.assign(s, n); 
                if (s.uuid && COHORT_DB && COHORT_DB.students && COHORT_DB.students[s.uuid]) {
                    COHORT_DB.students[s.uuid].status = n.status || 'active';
                }
                this.renderCurrentTab(); 
                UI.toast("已修改 (请点击保存)", "success"); 
            } 
        }); 
    },

    editTeacher: function(key, oldName) { 
        const newName = prompt(`修改 [${key.replace('_',' ')}] 的任课教师：`, oldName); 
        if (newName && newName.trim()) { 
            TEACHER_MAP[key] = newName.trim(); 
            this.syncTeacherHistory();
            this.renderTeachers(); 
            UI.toast("已修改 (需点击保存)", "info"); 
        } 
    },

    deleteTeacher: function(key) { 
        if(!confirm(`确定移除【${key.replace('_',' ')}】的任课信息吗？`)) return; 
        delete TEACHER_MAP[key]; 
        this.syncTeacherHistory();
        this.renderTeachers(); 
        UI.toast("已移除 (需点击保存)", "info"); 
    },

    addTeacher: function() { 
        Swal.fire({ 
            title: '新增任课', 
            html: `<div style="text-align:left; font-size:14px; line-height:2.5;">
                <label style="width:60px;">班级:</label> <input id="add-cls" class="swal2-input" placeholder="如: 701" style="width:180px; height:30px;"><br>
                <label style="width:60px;">学科:</label> <input id="add-sub" class="swal2-input" placeholder="如: 语文" style="width:180px; height:30px;"><br>
                <label style="width:60px;">教师:</label> <input id="add-name" class="swal2-input" placeholder="姓名" style="width:180px; height:30px;">
            </div>`, 
            confirmButtonText: '添加', showCancelButton: true, 
            preConfirm: () => ({ 
                cls: document.getElementById('add-cls').value.trim(), 
                sub: document.getElementById('add-sub').value.trim(), 
                name: document.getElementById('add-name').value.trim() 
            }) 
        }).then((result) => { 
            if (result.isConfirmed) { 
                const d = result.value; 
                if(!d.cls || !d.sub || !d.name) return alert("请填写完整"); 
                TEACHER_MAP[`${d.cls}_${d.sub}`] = d.name; 
                this.syncTeacherHistory();
                this.renderTeachers(); 
                UI.toast("添加成功 (需点击保存)", "success"); 
            } 
        }); 
    },

    // --- 档案管理 ---

    renderArchives: function() {
        const examStats = {}; 
        if (typeof HISTORY_ARCHIVE !== 'undefined') {
            Object.keys(HISTORY_ARCHIVE).forEach(uid => {
                const records = HISTORY_ARCHIVE[uid];
                records.forEach(r => { if (!examStats[r.exam]) examStats[r.exam] = 0; examStats[r.exam]++; });
            });
        }
        const tbody = document.getElementById('dm-history-tbody');
        if(!tbody) return;

        if (Object.keys(examStats).length === 0) { 
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px; color:#999;">暂无历史轨迹数据</td></tr>'; 
        } else {
            let html = '';
            Object.keys(examStats).forEach(examName => {
                html += `<tr><td style="font-weight:bold;">${examName}</td><td>${examStats[examName]} 条记录</td><td><button class="btn btn-sm btn-primary" onclick="DataManager.renameHistoryExam('${examName}')" style="padding:2px 6px;">重命名</button> <button class="btn btn-sm btn-danger" onclick="DataManager.deleteHistoryExam('${examName}')" style="padding:2px 6px; background:#dc2626;">删除</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }
        if (this.currentTab === 'archive') { this.loadCloudSnapshots(); }
    },

    deleteHistoryExam: function(examName) { 
        if (!confirm(`⚠️ 确定要删除【${examName}】吗？`)) return; 
        Object.keys(HISTORY_ARCHIVE).forEach(key => { 
            HISTORY_ARCHIVE[key] = HISTORY_ARCHIVE[key].filter(r => r.exam !== examName); 
            if (HISTORY_ARCHIVE[key].length === 0) delete HISTORY_ARCHIVE[key]; 
        }); 
        this.renderArchives(); 
        UI.toast("已删除", "success"); 
    },

    renameHistoryExam: function(oldName) { 
        const newName = prompt("重命名为：", oldName); 
        if (!newName) return; 
        Object.values(HISTORY_ARCHIVE).forEach(records => { 
            records.forEach(r => { if (r.exam === oldName) r.exam = newName; }); 
        }); 
        this.renderArchives(); 
    },

    loadCloudSnapshots: async function() { 
        if (!sbClient) return; 
        const tbody = document.getElementById('dm-cloud-tbody'); 
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="3">⏳ 加载中...</td></tr>'; 
        const { data } = await sbClient.from('system_data').select('key, created_at').order('created_at', { ascending: false }); 
        if (!data || !data.length) { 
            tbody.innerHTML = '<tr><td colspan="3">无备份</td></tr>'; return; 
        } 
        tbody.innerHTML = data.map(i => `<tr><td>${i.key}</td><td>${new Date(i.created_at).toLocaleString()}</td><td><button class="btn btn-sm btn-danger" onclick="DataManager.deleteCloudSnapshot('${i.key}')">删除</button></td></tr>`).join(''); 
    },

    deleteCloudSnapshot: async function(key) { 
        if(!confirm("确定删除？")) return; 
        await sbClient.from('system_data').delete().eq('key', key); 
        this.loadCloudSnapshots(); 
    },

    // 👇👇👇 🟢 [同步修复]：参数管理渲染逻辑优化 🟢 👇👇👇
    renderParams: function() {
        if (!isIndicatorPromptAllowed()) {
            const area = document.getElementById('dm-params-area');
            if (area) area.style.display = 'none';
            return;
        }
        // 1. 确保全局变量结构存在
        if (!window.SYS_VARS) window.SYS_VARS = { indicator: { ind1: '', ind2: '' }, targets: {} };
        if (!window.SYS_VARS.indicator) window.SYS_VARS.indicator = { ind1: '', ind2: '' };

        // 2. 优先从全局变量读取
        let i1 = window.SYS_VARS.indicator.ind1;
        let i2 = window.SYS_VARS.indicator.ind2;

        // 3. 兜底：如果全局变量为空，尝试从主界面 DOM 获取（防止主界面有值但这里没显示）
        const mainInput1 = document.getElementById('ind1');
        const mainInput2 = document.getElementById('ind2');
        
        if (!i1 && mainInput1) i1 = mainInput1.value;
        if (!i2 && mainInput2) i2 = mainInput2.value;
        
        // 4. 将值填入弹窗的输入框
        const el1 = document.getElementById('dm_ind1_input');
        const el2 = document.getElementById('dm_ind2_input');
        
        if(el1) {
            el1.value = i1 || '';
            // 绑定实时更新
            el1.oninput = function() { 
                if(!window.SYS_VARS.indicator) window.SYS_VARS.indicator = {};
                window.SYS_VARS.indicator.ind1 = this.value; 
            };
        }
        if(el2) {
            el2.value = i2 || '';
            el2.oninput = function() { 
                if(!window.SYS_VARS.indicator) window.SYS_VARS.indicator = {};
                window.SYS_VARS.indicator.ind2 = this.value; 
            };
        }
    },

    saveParamsLocally: function() {
        if (!isIndicatorAllowed()) return;
        // 1. 防御性初始化
        if (!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
        
        // 2. 获取管理面板弹窗内的值
        const v1 = document.getElementById('dm_ind1_input').value;
        const v2 = document.getElementById('dm_ind2_input').value;
        
        // 3. 更新内存全局变量
        window.SYS_VARS.indicator = { ind1: v1, ind2: v2 };
        
        // 4. 同步更新主界面的输入框 (确保 processData 运行时能读到)
        const main1 = document.getElementById('ind1');
        const main2 = document.getElementById('ind2');
        if(main1) main1.value = v1;
        if(main2) main2.value = v2;

        // 5. 🔥 核心新增：立即触发云端同步 🔥
        if(typeof saveCloudData === 'function') {
            // 使用 toast 提示正在保存，体验更好
            UI.toast('💾 正在同步参数至云端...', 'info');
            saveCloudData().then(() => {
                UI.toast('✅ 参数已保存并同步云端', 'success');
                
                // 可选：参数变动后，通常需要重算指标生数据
                // if(confirm("参数已更新，是否立即重新计算指标生数据？")) {
                //     calcIndicators();
                // }
            });
        } else {
            UI.toast('✅ 参数已暂存到内存 (未连接云端)', 'success');
        }
    },

    // --- 目标人数管理 (增强版) ---
    renderTargets: function() {
        const tbody = document.getElementById('dm-targets-tbody');
        if(!tbody) return;
        
        // 确保全局变量存在
        if(typeof window.TARGETS === 'undefined') window.TARGETS = {};
        
        const list = Object.keys(window.TARGETS).sort();
        
        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">暂无数据，请先点击上方按钮导入 Excel</td></tr>';
            return;
        }

        let html = '';
        list.forEach(sch => {
            const t = window.TARGETS[sch];
            html += `<tr><td style="font-weight:bold;">${sch}</td><td>${t.t1}</td><td>${t.t2}</td><td><button class="btn btn-sm btn-primary" onclick="DataManager.editTarget('${sch}')" style="padding:2px 6px;">修改</button> <button class="btn btn-sm btn-danger" onclick="DataManager.deleteTarget('${sch}')" style="padding:2px 6px;">删除</button></td></tr>`;
        });
        tbody.innerHTML = html;
    },

    handleTargetUpload: function(input) {
        if (isArchiveLocked()) return alert("⛔ 当前考试已封存，禁止导入目标人数");
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (json.length === 0) return alert("空表格");

                let successCount = 0;
                let errorCount = 0;
                let dupCount = 0;
                const seen = new Set();
                const errors = [];

                json.forEach((row, idx) => {
                    const rowNo = idx + 2;
                    const name = row['学校名称'] || row['学校'];
                    const t1Key = Object.keys(row).find(k => k.includes('指标一') || k.includes('目标一'));
                    const t2Key = Object.keys(row).find(k => k.includes('指标二') || k.includes('目标二'));

                    if (!name) {
                        errorCount++;
                        errors.push(`第 ${rowNo} 行：学校名称为空`);
                        return;
                    }
                    if (seen.has(name)) {
                        dupCount++;
                    }
                    seen.add(name);

                    const t1 = parseInt(row[t1Key] || row['指标一目标人数'] || 0);
                    const t2 = parseInt(row[t2Key] || row['指标二目标人数'] || 0);

                    if (isNaN(t1) || isNaN(t2)) {
                        errorCount++;
                        errors.push(`第 ${rowNo} 行：目标人数非数字 (${name})`);
                        return;
                    }

                    window.TARGETS[name] = { t1, t2 };
                    successCount++;
                });

                DataManager.renderTargets();

                if(typeof saveCloudData === 'function') {
                    saveCloudData();
                    if (window.UI) UI.toast("✅ 目标数据已自动同步云端", "success");
                }

                const msg = `✅ 导入完成：成功 ${successCount} 条，重复 ${dupCount} 条，错误 ${errorCount} 条。`;
                if (errors.length > 0 && typeof Swal !== 'undefined') {
                    Swal.fire('导入结果', `<div style="text-align:left; font-size:12px;">${msg}<br><br>${errors.slice(0, 8).join('<br>')}${errors.length > 8 ? '<br>...': ''}</div>`, errorCount > 0 ? 'warning' : 'success');
                } else {
                    alert(msg);
                }
                input.value = '';
            } catch (err) { alert("失败：" + err.message); }
        };
        reader.readAsArrayBuffer(file);
    },

    editTarget: function(schoolName) {
        const t = window.TARGETS[schoolName] || { t1: 0, t2: 0 };
        Swal.fire({
            title: `编辑目标 - ${schoolName}`,
            html: `<div style="text-align:left;line-height:2.5;"><label>指标一:</label><input id="swal-t1" type="number" class="swal2-input" value="${t.t1}" style="width:100px;height:30px;"><br><label>指标二:</label><input id="swal-t2" type="number" class="swal2-input" value="${t.t2}" style="width:100px;height:30px;"></div>`,
            showCancelButton: true,
            confirmButtonText: '确定',
            preConfirm: () => ({ t1: parseInt(document.getElementById('swal-t1').value)||0, t2: parseInt(document.getElementById('swal-t2').value)||0 })
        }).then((result) => {
            if (result.isConfirmed) {
                window.TARGETS[schoolName] = result.value;
                this.renderTargets();
            }
        });
    },

    deleteTarget: function(schoolName) {
        if(!confirm("确定删除？")) return;
        delete window.TARGETS[schoolName];
        this.renderTargets();
    },

    // 7. 保存并同步 (核心修复)
    saveAndSync: async function() {
        if (isArchiveLocked()) return alert("⛔ 当前考试已封存，仅支持只读查看");
        if (!confirm("⚠️ 确定要应用所有修改并同步到云端吗？\n\n1. 系统将重算排名\n2. 目标/参数将被保存")) return;
        
        UI.loading(true, "正在保存...");
        
        try {
            // 1. 确保参数已同步到全局
            this.saveParamsLocally();
            this.syncTeacherHistory();
            if (!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
            window.SYS_VARS.targets = window.TARGETS || {};
            
            // 2. 重新计算数据 (会读取 ind1, ind2)
            if (window.RAW_DATA && window.RAW_DATA.length) {
                try {
                    await processData(); 
                    renderTables();
                } catch (e) {
                    console.warn('重算失败，仍将同步云端：', e);
                }
            }
            
            // 3. 上传到云端
            await saveCloudData();
            
            UI.loading(false);
            Swal.fire('成功', '数据已更新并同步至云端！', 'success');
        } catch (e) {
            UI.loading(false);
            alert("保存失败: " + e.message);
        }
    }, // 👈 注意这里有一个逗号，连接下面的新函数

    // 👇👇👇 🟢 [修改点 4.2]：在此处粘贴 SQL 执行核心逻辑 🟢 👇👇👇
    
    // 缓存查询结果
    sqlResultCache: [],
    sqlHistoryKey: 'SQL_HISTORY',
    sqlHistoryLimit: 12,

    // 获取历史
    getSQLHistory: function() {
        try {
            return JSON.parse(localStorage.getItem(this.sqlHistoryKey) || '[]');
        } catch(e) {
            return [];
        }
    },

    // 保存历史
    setSQLHistory: function(list) {
        try {
            localStorage.setItem(this.sqlHistoryKey, JSON.stringify(list));
        } catch(e) {}
    },

    // 添加最近查询
    addRecentSQL: function(sql) {
        if (!sql) return;
        let list = this.getSQLHistory();
        list = list.filter(item => item.sql !== sql);
        list.unshift({ name: '最近查询', sql, ts: Date.now(), pinned: false });
        if (list.length > this.sqlHistoryLimit) list = list.slice(0, this.sqlHistoryLimit);
        this.setSQLHistory(list);
    },

    // 渲染历史下拉
    renderSQLHistory: function() {
        const sel = document.getElementById('dm-sql-history-select');
        if (!sel) return;
        const list = this.getSQLHistory();
        let options = '<option value="">🕘 最近/收藏</option>';
        list.forEach((item, idx) => {
            const label = item.pinned ? `⭐ ${item.name}` : `🕘 ${item.sql.slice(0, 28)}${item.sql.length > 28 ? '...' : ''}`;
            options += `<option value="${idx}">${label}</option>`;
        });
        sel.innerHTML = options;
    },

    // 应用历史
    applySQLHistory: function(idx) {
        if (idx === '') return;
        const list = this.getSQLHistory();
        const item = list[Number(idx)];
        if (item && item.sql) {
            document.getElementById('dm-sql-input').value = item.sql;
        }
    },

    // 保存收藏
    saveNamedSQL: function() {
        const sql = document.getElementById('dm-sql-input').value.trim();
        if (!sql) return alert('请先输入 SQL');
        const nameInput = document.getElementById('dm-sql-history-name');
        const name = (nameInput && nameInput.value.trim()) || `收藏 ${new Date().toLocaleString()}`;
        let list = this.getSQLHistory();
        list = list.filter(item => item.sql !== sql);
        list.unshift({ name, sql, ts: Date.now(), pinned: true });
        if (list.length > this.sqlHistoryLimit) list = list.slice(0, this.sqlHistoryLimit);
        this.setSQLHistory(list);
        if (nameInput) nameInput.value = '';
        this.renderSQLHistory();
        if (window.UI) UI.toast('✅ 已保存收藏', 'success');
    },

    // 清空历史
    clearSQLHistory: function() {
        if (!confirm('确定清空SQL历史吗？')) return;
        localStorage.removeItem(this.sqlHistoryKey);
        this.renderSQLHistory();
    },

    // 预设 SQL 语句
    setQuickSQL: function(type) {
        let sql = "";
        switch(type) {
            case 'base': 
                sql = "SELECT school, class, name, total FROM students ORDER BY total DESC LIMIT 10"; 
                break;
            case 'count': 
                sql = "SELECT school, COUNT(*) as cnt, AVG(total) as avg_score FROM students GROUP BY school ORDER BY avg_score DESC"; 
                break;
            case 'avg': 
                sql = "SELECT class, AVG(语文) as chinese_avg FROM students GROUP BY class ORDER BY chinese_avg DESC"; 
                break;
            case 'failed': 
                sql = "SELECT class, name, 数学 FROM students WHERE 数学 < 90 ORDER BY 数学 ASC"; // 假设满分150
                break;
            case 'teacher':
                // 联合查询示例
                sql = "SELECT s.class, s.name, s.英语, t.teacher FROM students s JOIN teachers t ON s.class = t.class AND t.subject = '英语' WHERE t.teacher LIKE '张%' LIMIT 20";
                break;
        }
        document.getElementById('dm-sql-input').value = sql;
    },

    // 准备数据源
    prepareSQLData: function() {
        // 1. 准备 students 表 (RAW_DATA 已经是数组，可以直接用，但为了方便查询把 scores 展开)
        const studentsTable = window.RAW_DATA.map(s => {
            // 浅拷贝基础信息
            let row = { school: s.school, class: s.class, name: s.name, id: s.id, total: s.total };
            // 展开科目分数 (例如 s.scores.语文 -> row.语文)
            if(s.scores) {
                Object.keys(s.scores).forEach(sub => row[sub] = s.scores[sub]);
            }
            return row;
        });

        // 2. 准备 teachers 表 (将 TEACHER_MAP 转换为数组)
        // TEACHER_MAP 结构是Key-Value，需转为 [{class:'701', subject:'语文', teacher:'张三'}]
        const teachersTable = [];
        if(window.TEACHER_MAP) {
            Object.keys(window.TEACHER_MAP).forEach(key => {
                const [cls, sub] = key.split('_');
                teachersTable.push({ class: cls, subject: sub, teacher: window.TEACHER_MAP[key] });
            });
        }

        return { students: studentsTable, teachers: teachersTable };
    },

    runSQL: function() {
        const sql = document.getElementById('dm-sql-input').value.trim();
        const msgEl = document.getElementById('sql-status-msg');
        const thead = document.querySelector('#dm-sql-table thead');
        const tbody = document.querySelector('#dm-sql-table tbody');
        
        msgEl.innerText = "";
        thead.innerHTML = "";
        tbody.innerHTML = "";

        if(!sql) return;

        try {
            // 1. 准备数据
            const db = this.prepareSQLData();
            
            // 2. 执行查询 (Alasql 支持直接传入数据对象作为表)
            alasql("CREATE TABLE students");
            alasql("SELECT * INTO students FROM ?", [db.students]);
            
            alasql("CREATE TABLE teachers");
            alasql("SELECT * INTO teachers FROM ?", [db.teachers]);

            // 执行用户输入的 SQL
            const res = alasql(sql);
            
            this.sqlResultCache = res; // 存起来供导出

            // 3. 渲染结果
            if (!res || res.length === 0) {
                tbody.innerHTML = '<tr><td style="padding:20px; text-align:center; color:#666;">查询结果为空</td></tr>';
                return;
            }

            // 动态生成表头
            const columns = Object.keys(res[0]);
            let headerHtml = "<tr>";
            columns.forEach(col => headerHtml += `<th style="background:#f1f5f9; padding:8px;">${col}</th>`);
            headerHtml += "</tr>";
            thead.innerHTML = headerHtml;

            // 生成内容 (限制显示前 500 条防止卡顿)
            let bodyHtml = "";
            res.slice(0, 500).forEach(row => {
                bodyHtml += "<tr>";
                columns.forEach(col => {
                    let val = row[col];
                    // 简单的格式化小数
                    if (typeof val === 'number' && val % 1 !== 0) val = val.toFixed(2);
                    bodyHtml += `<td>${val}</td>`;
                });
                bodyHtml += "</tr>";
            });
            
            if (res.length > 500) {
                bodyHtml += `<tr><td colspan="${columns.length}" style="text-align:center; color:#999;">(结果过多，仅显示前 500 条，请导出 Excel 查看全部)</td></tr>`;
            }

            tbody.innerHTML = bodyHtml;

            // 记录最近查询
            this.addRecentSQL(sql);
            this.renderSQLHistory();
            
            // 清理内存表
            alasql("DROP TABLE students");
            alasql("DROP TABLE teachers");

        } catch (e) {
            console.error(e);
            msgEl.innerText = "❌ SQL 错误: " + e.message;
            // 确保清理
            try { alasql("DROP TABLE IF EXISTS students"); alasql("DROP TABLE IF EXISTS teachers"); } catch(ex){}
        }
    },

    exportSQLResult: function() {
        if (!this.sqlResultCache || this.sqlResultCache.length === 0) return alert("当前没有查询结果可导出");
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(this.sqlResultCache);
        XLSX.utils.book_append_sheet(wb, ws, "SQL查询结果");
        XLSX.writeFile(wb, "自定义查询结果.xlsx");
    }
}; // 👈 这里是 DataManager 对象的结束，后面不能有 HTML 代码！

    // 🟣 Talk to Data：自然语言查数
    async function talkToData() {
        const inputEl = document.getElementById('dm-nlq-input');
        const statusEl = document.getElementById('dm-nlq-status');
        if (!inputEl || !statusEl) return;
        const question = inputEl.value.trim();
        if (!question) return alert('请输入查询需求');
        statusEl.innerText = 'AI 解析中...';

        try {
            const schema = buildNLQSchema();
            const prompt = buildNLQPrompt(question, schema);
            const aiText = await callUnifiedAI(prompt);
            const sql = extractSQLFromAI(aiText);

            if (!isSafeSQL(sql)) {
                statusEl.innerText = '⚠️ 生成SQL不安全或不完整，请修改后再执行';
                return;
            }

            document.getElementById('dm-sql-input').value = sql;
            DataManager.runSQL();
            statusEl.innerText = '✅ 已生成SQL并执行';
        } catch (e) {
            console.error(e);
            statusEl.innerText = '❌ 解析失败，请重试';
            if (window.UI) UI.toast('AI 解析失败，请重试', 'error');
        }
    }

    function buildNLQSchema() {
        const db = DataManager.prepareSQLData();
        const studentsCols = db.students && db.students.length ? Object.keys(db.students[0]) : [];
        const teachersCols = db.teachers && db.teachers.length ? Object.keys(db.teachers[0]) : ['class', 'subject', 'teacher'];
        return {
            tables: {
                students: studentsCols,
                teachers: teachersCols
            },
            notes: 'students含成绩字段，teachers为任课表，可JOIN students.class=teachers.class'
        };
    }

    function buildNLQPrompt(question, schema) {
        return `你是校务数据分析师。请把用户的自然语言查询转换为可执行的 AlaSQL SELECT 语句。
要求：
1) 只允许 SELECT 查询；不要使用 INSERT/UPDATE/DELETE/CREATE/DROP。
2) 表只有 students 和 teachers。
3) 优先输出明确字段，不要 SELECT *。
4) 输出仅包含 SQL，不要解释，不要 Markdown。

【表结构】\n${JSON.stringify(schema)}\n
【用户问题】\n${question}\n`;
    }

    function extractSQLFromAI(text) {
        if (!text) return '';
        let sql = text.trim();
        const codeMatch = sql.match(/```(?:sql)?\s*([\s\S]*?)```/i);
        if (codeMatch) sql = codeMatch[1].trim();
        const selectIdx = sql.toUpperCase().indexOf('SELECT');
        if (selectIdx > 0) sql = sql.slice(selectIdx);
        sql = sql.replace(/;\s*$/g, '').trim();
        return sql;
    }

    function isSafeSQL(sql) {
        if (!sql) return false;
        const s = sql.trim();
        if (!/^select\b/i.test(s)) return false;
        if (/(update|delete|insert|drop|alter|truncate|create|replace|merge|grant|revoke)\b/i.test(s)) return false;
        return true;
    }

    // 🟢 [优化版] 数据持久化工具：支持 Supabase 云端同步 + IndexedDB 本地缓存
    const DB = {
        // 保存数据：同时保存到云端和本地缓存
        save: async (key, value) => {
            // 1. 优先保存到本地 IndexedDB (极速)
            try {
                if (window.idbKeyval) {
                    await idbKeyval.set(`cache_${key}`, value);
                    console.log(`💾 本地缓存已更新: ${key}`);
                }
            } catch (e) { console.warn("本地缓存失败:", e); }

            // 2. 异步同步到云端
            if (!sbClient) return; 
            try {
                const jsonStr = JSON.stringify(value);
                const compressedStr = "LZ|" + LZString.compressToUTF16(jsonStr);
                
                const { error } = await sbClient
                    .from('system_data') 
                    .upsert({ key: key, content: compressedStr }, { onConflict: 'key' });

                if (error) {
                    console.error("云端备份失败:", error);
                } else {
                    const statusEl = document.getElementById('auto-backup-status');
                    if (statusEl) statusEl.innerHTML = `<span style="color:#16a34a;">☁️ 云端已同步</span>`;
                }
            } catch (e) {
                console.error("云端同步出错:", e);
            }
        },

        // 读取数据：优先本地缓存，后台静默更新
        get: async (key) => {
            let localData = null;
            // 1. 尝试从本地 IndexedDB 读取 (秒开)
            try {
                if (window.idbKeyval) {
                    localData = await idbKeyval.get(`cache_${key}`);
                    if (localData) {
                        console.log(`🚀 从本地缓存加载成功: ${key}`);
                        // 触发异步云端校验（可选，此处为了性能先返回本地）
                        DB.syncFromCloud(key); 
                        return localData;
                    }
                }
            } catch (e) { console.warn("读取本地缓存失败:", e); }

            // 2. 本地无数据，从云端读取
            return await DB.syncFromCloud(key);
        },

        // 从云端强制同步并更新本地
        syncFromCloud: async (key) => {
            if (!sbClient) return null;
            try {
                const { data, error } = await sbClient
                    .from('system_data')
                    .select('content')
                    .eq('key', key)
                    .maybeSingle();

                if (error) throw error;

                if (data && data.content) {
                    let db = data.content;
                    if (typeof db === 'string' && db.startsWith("LZ|")) {
                        if (typeof LZString === 'undefined') {
                            throw new Error('LZString 未加载，无法解压云端内容');
                        }
                        const decompressed = LZString.decompressFromUTF16(db.substring(3));
                        db = JSON.parse(decompressed);
                    } else if (typeof db === 'string') {
                        db = JSON.parse(db);
                    }

                    // 更新本地缓存
                    if (window.idbKeyval) await idbKeyval.set(`cache_${key}`, db);
                    return db;
                }
            } catch (e) {
                console.error("云端同步失败:", e);
            }
            return null;
        },

        // 清除数据
        clear: async (key) => {
            if (!sbClient) return;
            try {
                await sbClient.from('system_data').delete().eq('key', key);
            } catch(e) {
                console.error("清除数据失败", e);
            }
        }
    };

    // 🔄 切换届别 (安全修复版)
    async function switchCohort(cohortId) {
        if (!cohortId) return;
        const cohortKey = getCohortKey(cohortId);
        const current = localStorage.getItem('CURRENT_PROJECT_KEY') || '';
        if (current === cohortKey) return;

        if(!confirm("⚠️ 正在切换届别档案...\n\n切换前请确保当前工作已保存（数据会自动保存），否则未同步的修改可能丢失。\n\n确定切换吗？")) {
            const selector = document.getElementById('cohort-selector');
            if(selector) selector.value = localStorage.getItem('CURRENT_COHORT_ID') || '';
            return;
        }

        UI.loading(true, "正在从云端拉取 [" + cohortKey + "] 的数据...");
        
        // 1. 记录当前选择的届别
        localStorage.setItem('CURRENT_PROJECT_KEY', cohortKey);
        localStorage.setItem('CURRENT_COHORT_ID', cohortId);
        const label = CURRENT_COHORT_META ? formatCohortLabel(CURRENT_COHORT_META) : `${cohortId}级`;
        const currentLabel = document.getElementById('cohort-current-label');
        if (currentLabel) currentLabel.innerText = label;
        const examCohortLabel = document.getElementById('exam-cohort-label');
        if (examCohortLabel) examCohortLabel.innerText = label;

        // 2. 从云端拉取新届别的数据
        const data = await DB.get(cohortKey);

        if (data) {
            // 3. 恢复数据
            COHORT_DB = data.COHORT_DB || null;
            CURRENT_COHORT_ID = data.CURRENT_COHORT_ID || cohortId;
            CURRENT_COHORT_META = data.CURRENT_COHORT_META || CURRENT_COHORT_META;
            CURRENT_EXAM_ID = data.CURRENT_EXAM_ID || '';

            // 优先使用届别考试快照
            if (COHORT_DB && COHORT_DB.currentExamId && CohortDB.applyExamToWorkspace(COHORT_DB.currentExamId)) {
                // 已加载当前考试快照
            } else {
                RAW_DATA = data.RAW_DATA || [];
                SCHOOLS = data.SCHOOLS || {};
                SUBJECTS = data.SUBJECTS || [];
                THRESHOLDS = data.THRESHOLDS || {};
                TEACHER_MAP = data.TEACHER_MAP || {};
                CONFIG = data.CONFIG || {};
            }
            
            // ★★★ 关键：恢复账号数据 ★★★
            if(data.AUTH_DB) {
                Auth.db = data.AUTH_DB;
                localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
                console.log("✅ 账号已切换为 [" + projectKey + "] 的版本");
            }
            
            // ★★★ 关键：恢复指标参数输入框 (安全检查版) ★★★
            if(data.INDICATOR_PARAMS) {
                const i1 = document.getElementById('ind1');
                const i2 = document.getElementById('ind2');
                // 🟢 修复：先检查元素是否存在，再赋值
                if(i1) i1.value = data.INDICATOR_PARAMS.ind1 || '';
                if(i2) i2.value = data.INDICATOR_PARAMS.ind2 || '';
                
                // 同时更新内存
                if(!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
                window.SYS_VARS.indicator = data.INDICATOR_PARAMS;
            }

            // 恢复其他变量
            if(data.TARGETS) { 
                TARGETS = data.TARGETS;
                if(!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
                window.SYS_VARS.targets = data.TARGETS;
            }
            if(data.PREV_DATA) PREV_DATA = data.PREV_DATA;
            if(data.HISTORY_ARCHIVE) HISTORY_ARCHIVE = data.HISTORY_ARCHIVE;
            if(data.FB_CLASSES) FB_CLASSES = data.FB_CLASSES;
            
            // 4. 刷新界面
            updateSchoolSelect();
            updateMySchoolSelect();
            renderTables();
            
            // 如果有配置名，刷新导航
            const badge = document.getElementById('mode-badge');
            if(badge && CONFIG.name) badge.innerText = CONFIG.name;
            renderNavigation();
            document.getElementById('mode-mask').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');

            CohortDB.renderExamList();
            
            UI.toast(`✅ 已切换到 [${cohortKey}]，数据加载完毕`, "success");
        } else {
            // 4. 如果云端没这个届别的数据（新档案）
            RAW_DATA = [];
            SCHOOLS = {};
            SUBJECTS = [];
            THRESHOLDS = {};
            COHORT_DB = {
                cohortId,
                cohortMeta: CURRENT_COHORT_META || null,
                students: {},
                teachingHistory: {},
                exams: {},
                currentExamId: '',
                resetPoints: []
            };
            
            Auth.db = { admin: { pass: 'admin123' }, teachers: [], parents: [] }; 
            localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
            
            // 清空指标输入框 (安全检查版)
            const i1 = document.getElementById('ind1');
            const i2 = document.getElementById('ind2');
            // 🟢 修复：先检查元素是否存在，再清空
            if(i1) i1.value = '';
            if(i2) i2.value = '';

            updateSchoolSelect();
            renderTables();
            const grade = computeCohortGrade(CURRENT_COHORT_META, getExamMetaFromUI());
            applyModeByGrade(grade);
            document.getElementById('mode-mask').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');

            CohortDB.renderExamList();
            
            UI.toast(`✨ 已切换到 [${cohortKey}] (新存档)，请开始上传数据`, "info");
        }
        
        UI.loading(false);
    }

    // 兼容旧入口
    window.switchProject = switchCohort;


    // 4. 启动时自动检查恢复 (程序入口)
    window.addEventListener('load', async () => {
        
        // ✋ 🔴 [已移除]：删除了 MobApp.init() 的拦截逻辑，确保手机端也继续执行后续的完整初始化流程 🔴

        // 0. 初始化届别选择器状态
        if (typeof CohortManager !== 'undefined') {
            CohortManager.init();
        }
        const selector = document.getElementById('cohort-selector');
        if(selector) selector.value = localStorage.getItem('CURRENT_COHORT_ID') || '';

        // 1. 初始化鉴权 (最先执行)
        if (typeof Auth !== 'undefined') {
            Auth.init();
        }

        // 2. 教程检查
        if(typeof HelpSystem !== 'undefined') {
            HelpSystem.checkFirstRun();
        }
        
        // (setInterval 代码在第一步已经修改过，这里不再重复展示，保持第一步的代码即可)

        // 🟢 分支一：这是分发版 (有内置数据) -> 加载内置数据
        if (window.EMBEDDED_DB) {
            console.log("检测到内置数据包，正在装载...");
            const loader = document.getElementById('global-loader');
            if(loader) loader.classList.add('hidden');
            sessionStorage.removeItem('CURRENT_USER'); 
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('app').classList.add('hidden');
            const db = window.EMBEDDED_DB;
            
            // 恢复内存
            RAW_DATA = db.RAW_DATA || [];
            SCHOOLS = db.SCHOOLS || {};
            SUBJECTS = db.SUBJECTS || [];
            THRESHOLDS = db.THRESHOLDS || {};
            TEACHER_MAP = db.TEACHER_MAP || {};
            MY_SCHOOL = db.MY_SCHOOL || "";
            CONFIG = db.CONFIG || {};
            
            // 恢复账号 (分发版核心)
            if (db.AUTH_DB) {
                localStorage.setItem('SYS_USERS', JSON.stringify(db.AUTH_DB));
                if (typeof Auth !== 'undefined') Auth.db = db.AUTH_DB;
            }
            
            // 恢复指标参数
            if(db.INDICATOR_PARAMS) {
                setTimeout(() => {
                    const i1 = document.getElementById('ind1');
                    const i2 = document.getElementById('ind2');
                    if(i1) i1.value = db.INDICATOR_PARAMS.ind1 || '';
                    if(i2) i2.value = db.INDICATOR_PARAMS.ind2 || '';
                }, 100);
            }
            if(db.TARGETS) window.TARGETS = db.TARGETS;

            // 刷新
            updateSchoolSelect();
            updateMySchoolSelect();
            renderTables();
            document.getElementById('mode-mask').style.display = 'none';
            if(CONFIG.name) renderNavigation();

            UI.toast("✅ 数据已自动加载 (分发版模式)", "success");
        } 
        
        // 🟠 分支二：这是管理员原版 -> 从云端/本地加载
        else {
            // 🔥 关键：读取当前选中的项目 Key
            const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup';
            const backup = await DB.get(currentKey);
            const isForceRestore = localStorage.getItem('SYS_FORCE_RESTORE'); 

            // 定义统一的恢复函数
            const performRestore = async () => {
                Perf.runAsync(async () => {
                    // 恢复基础数据
                    RAW_DATA = backup.RAW_DATA || [];
                    SCHOOLS = backup.SCHOOLS || {};
                    SUBJECTS = backup.SUBJECTS || [];
                    THRESHOLDS = backup.THRESHOLDS || {};
                    TEACHER_MAP = backup.TEACHER_MAP || {};
                    MY_SCHOOL = backup.MY_SCHOOL || "";
                    if(backup.CONFIG) CONFIG = backup.CONFIG;
                    
                    // ★★★ 恢复账号 ★★★
                    if (backup.AUTH_DB) {
                        Auth.db = backup.AUTH_DB;
                        localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
                        console.log("✅ 账号信息已同步");
                    }

                    // ★★★ 恢复指标参数 (修复版) ★★★
                    if(backup.INDICATOR_PARAMS) {
                        // 1. 核心修复：必须更新全局内存变量！
                        // 这样当你打开管理面板时，switchTab 才能读取到正确的值
                        if (!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
                        window.SYS_VARS.indicator = backup.INDICATOR_PARAMS;

                        // 2. 尝试回填到 DOM (使用正确的新 ID: dm_ind..._input)
                        // 使用 setTimeout 确保模态框DOM已就绪
                        setTimeout(() => {
                            const dm1 = document.getElementById('dm_ind1_input');
                            const dm2 = document.getElementById('dm_ind2_input');
                                                        
                            if(dm1) dm1.value = backup.INDICATOR_PARAMS.ind1 || '';
                            if(dm2) dm2.value = backup.INDICATOR_PARAMS.ind2 || '';
                                                        
                        }, 500);

                        console.log("✅ [自动恢复] 指标参数已加载到内存:", window.SYS_VARS.indicator);
                    }
                    if(backup.TARGETS) TARGETS = backup.TARGETS;
                    
                    // 恢复其他
                    if(backup.PREV_DATA) PREV_DATA = backup.PREV_DATA;
                    if(backup.HISTORY_ARCHIVE) HISTORY_ARCHIVE = backup.HISTORY_ARCHIVE;
                    
                    // 刷新界面
                    document.getElementById('mode-mask').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    
                    if(CONFIG.name) {
                        document.getElementById('mode-badge').innerText = CONFIG.name;
                        document.getElementById('mode-info').innerText = `${CONFIG.name}模式`;
                        renderNavigation();
                    }
                    
                    updateSchoolSelect(); 
                    updateMySchoolSelect();
                    // 👈 修复位置：添加 null 检查，防止元素不存在时报错
                    const mySchoolSelect = document.getElementById('mySchoolSelect');
                    if(MY_SCHOOL && mySchoolSelect) mySchoolSelect.value = MY_SCHOOL;
                    
                    renderTables();
                    if(MY_SCHOOL) generateTeacherInputs();

                    UI.toast(`✅ 已加载项目：[${currentKey}]`, 'success');
                }, "正在加载数据...");
            };

            if (isForceRestore === 'true' && backup && backup.RAW_DATA) {
                localStorage.removeItem('SYS_FORCE_RESTORE'); 
                await performRestore(); 
            } 
            else if (backup && backup.RAW_DATA && backup.RAW_DATA.length > 0 && RAW_DATA.length === 0) {
                // 如果发现有缓存，且非首次空加载
                await performRestore();
            } 
            else {
                // 无数据，显示初始模式选择
                document.getElementById('mode-mask').style.display = 'flex';
            }
        }
    });


    // 性能优化工具
    const Perf = {
        // 异步任务包装器：解决点击按钮后界面“假死”的问题
        runAsync: (fn, loadingText) => {
            UI.loading(true, loadingText);
            // 利用 setTimeout 将任务推到下一帧，让 UI 先渲染出 Loading
            setTimeout(async () => {
                try {
                    await fn();
                } catch (e) {
                    console.error(e);
                    UI.toast("发生错误: " + e.message, 'error');
                } finally {
                    UI.loading(false);
                }
            }, 50);
        },
        // 高性能列表渲染：解决 += HTML 导致的卡顿
        renderList: (data, templateFn) => {
            if(!data || !data.length) return '';
            return data.map(templateFn).join('');
        }
    };
    // ================= 全局变量 =================
    let CONFIG = { 
        name: '6-8年级', 
        label: '全科总', 
        excRate: 0.05, 
        totalSubs: 'auto', 
        analysisSubs: 'auto', 
        showQuery: true 
    };
    let RAW_DATA = [], SCHOOLS = {}, SUBJECTS = [], THRESHOLDS = {}, TARGETS = {};
    let TEACHER_MAP = {}, MY_SCHOOL = "", TEACHER_STATS = {}; 
    let COHORT_DB = null;
    let CURRENT_COHORT_ID = '';
    let CURRENT_COHORT_META = null;
    let CURRENT_EXAM_ID = '';
    window.switchMobileTab = function(tabName) {
        const app = document.getElementById('mobile-app');
        // 兼容 Alpine V3 的写法
        if (app && window.Alpine) {
            Alpine.$data(app).activeTab = tabName;
        } else {
            console.error("Alpine 未加载或元素不存在");
        }
    };
    let TEACHER_TOWNSHIP_RANKINGS = {}; MARGINAL_STUDENTS = {}; 
    let POTENTIAL_STUDENTS_CACHE = []; TOWNSHIP_RANKING_DATA = {}; 
    let radarChartInstance = null; 
    let segmentChartInstance = null; // 新增：分数段直方图实例
    let trendChartInstance = null; // 进退步趋势图实例
    let TEACHER_STAMP_BASE64 = "";
    // 存储结构: { "学校_姓名": [ {exam:"初一上", rank:100}, {exam:"初一下", rank:50} ... ] }
    let HISTORY_ARCHIVE = {}; 
    let ROLLER_COASTER_STUDENTS = []; // 存储波动剧烈的学生名单
    let historyChartInstance = null;
    let LLM_CONFIG = {
        apiKey: localStorage.getItem('LLM_API_KEY') || '',
        baseURL: localStorage.getItem('LLM_BASE_URL') || 'https://api.deepseek.com',
        model: localStorage.getItem('LLM_MODEL') || 'deepseek-chat',
        systemPrompt: "你是一位经验丰富、语调温和的初中班主任。请根据学生数据写评语，多鼓励，指出具体优缺点。",
        source: 'cloud' // 新增字段：cloud | local
    };

    // 1. 本地引擎状态管理
    let LOCAL_ENGINE = null;
    let IS_LOCAL_LOADING = false;

    // 2. 切换 AI 来源 (UI 交互)
    function toggleAISource() {
        const source = document.querySelector('input[name="ai_source"]:checked').value;
        LLM_CONFIG.source = source;
        if(source === 'cloud') {
            document.getElementById('ai-config-cloud').classList.remove('hidden');
            document.getElementById('ai-config-local').classList.add('hidden');
        } else {
            document.getElementById('ai-config-cloud').classList.add('hidden');
            document.getElementById('ai-config-local').classList.remove('hidden');
            // 检查浏览器是否支持 WebGPU
            if (!navigator.gpu) {
                document.getElementById('local-ai-status').innerHTML = '<span style="color:red">❌ 您的浏览器不支持 WebGPU，无法使用本地 AI。请尝试升级 Chrome/Edge 浏览器。</span>';
            }
        }
    }

    // 3. 初始化本地模型 (WebLLM 核心)
    async function initLocalModel() {
        if(IS_LOCAL_LOADING) return;
        if(!window.webllm) return alert("WebLLM 库尚未加载完成，请检查网络或刷新页面");
    
        // 尝试等待模块加载（如果是异步导入）
        if (!window.webllm) {
            try {
                // 动态再次导入尝试，确保模块就绪
                const loadedModule = await import("https://esm.run/@mlc-ai/web-llm");
                window.webllm = loadedModule;
            } catch (e) {
                console.error("WebLLM module load failed:", e);
                return alert("WebLLM AI 引擎加载失败。请检查网络连接（需要访问 jsdelivr CDN）。");
            }
        }
    
        const modelId = document.getElementById('local_model_select').value;
        IS_LOCAL_LOADING = true;
        
        const statusEl = document.getElementById('local-ai-status');
        const progressEl = document.getElementById('local-ai-progress');
        const btn = document.querySelector('button[onclick="initLocalModel()"]');
        
        btn.disabled = true;
        btn.innerHTML = '⏳ 加载中...';

        try {
            // 定义加载进度回调
            const initProgressCallback = (report) => {
                console.log(report); // 控制台调试
                statusEl.innerText = report.text; // 显示具体阶段
                // 解析进度 (WebLLM返回 0.0 ~ 1.0)
                const pct = Math.round(report.progress * 100);
                progressEl.style.width = `${pct}%`;
            };

            // 如果已有引擎实例，先卸载释放显存
            if (LOCAL_ENGINE) { await LOCAL_ENGINE.unload(); }

            // 创建引擎实例
            LOCAL_ENGINE = new window.webllm.MLCEngine();
            
            // 开始加载模型
            await LOCAL_ENGINE.reload(modelId, { initProgressCallback });
            
            statusEl.innerHTML = '✅ 模型加载完毕！现在可以断网使用了。';
            progressEl.style.background = '#16a34a';
            UI.toast('本地 AI 引擎就绪', 'success');
        } catch (err) {
            console.error(err);
            statusEl.innerHTML = `<span style="color:red">❌ 加载失败: ${err.message}</span>`;
            alert("本地模型加载失败。\n可能原因：显存不足、网络中断或浏览器不支持 WebGPU。\n建议切换回云端 API 模式。");
        } finally {
            IS_LOCAL_LOADING = false;
            btn.disabled = false;
            btn.innerHTML = '⬇️ 重新加载';
        }
    }

    // 4. 统一 AI 调用接口 (自动路由)
    async function callUnifiedAI(prompt, onChunk) {
        // --- 分支 A: 本地模型 ---
        if (LLM_CONFIG.source === 'local') {
            if (!LOCAL_ENGINE) return alert("请先在【数据枢纽 -> AI配置】中加载本地模型！");
            
            try {
                const completion = await LOCAL_ENGINE.chat.completions.create({
                    messages: [{ role: "user", content: prompt }],
                    stream: true, // 强制流式输出
                });

                let fullText = "";
                for await (const chunk of completion) {
                    const delta = chunk.choices[0].delta.content;
                    if (delta) {
                        fullText += delta;
                        if (onChunk) onChunk(delta);
                    }
                }
                return fullText;
            } catch (err) {
                console.error("Local AI Error", err);
                throw new Error("本地推理出错: " + err.message);
            }
        } 
        // --- 分支 B: 云端 API ---
        else {
            return new Promise((resolve, reject) => {
                let fullResponse = "";
                // 复用之前的 callLLM 逻辑，但包裹在 Promise 中
                callLLM(prompt, 
                    (chunk) => { // onChunk
                        fullResponse += chunk;
                        if (onChunk) onChunk(chunk);
                    }, 
                    (finalText) => { // onFinish
                        if(finalText.includes("(请求失败)")) reject(new Error("API请求失败"));
                        else resolve(finalText);
                    }
                );
            });
        }
    }

    // 5. [新功能] 班级弱项深度诊断报告
    async function generateClassDiagnosisReport() {
        const sch = document.getElementById('classCompSchoolSelect').value;
        if (!sch || !SCHOOLS[sch]) return alert("请先在左侧选择学校，并点击【开始对比】生成数据基础。");
        
        // A. 准备数据上下文
        const schoolData = SCHOOLS[sch];
        const classNames = [...new Set(schoolData.students.map(s => s.class))].sort();
        
        // 构建提示词 (Prompt Engineering)
        let prompt = `你是一位拥有20年经验的资深教务主任。请根据以下 ${sch} 的班级成绩数据，撰写一份深度的“班级弱项诊断与提升方案”。
        
【全校基准数据】：
- 全校均分: ${schoolData.metrics.total.avg.toFixed(1)}
- 全校优秀率: ${(schoolData.metrics.total.excRate*100).toFixed(1)}%

【各班级详细表现】：
`;
        classNames.forEach(cls => {
            const stus = schoolData.students.filter(s => s.class === cls);
            const n = stus.length;
            const avg = stus.reduce((a,b)=>a+b.total,0)/n;
            const exc = stus.filter(s=>s.total>=THRESHOLDS.total.exc).length/n;
            
            // 寻找该班的最差学科 (与年级均分差距最大)
            let worstSub = {name:'', diff: 999};
            SUBJECTS.forEach(sub => {
                const subScores = stus.map(s=>s.scores[sub]).filter(v=>v!==undefined);
                if(subScores.length === 0) return;
                const subAvg = subScores.reduce((a,b)=>a+b,0)/subScores.length;
                const gradeSubAvg = schoolData.metrics[sub].avg;
                const diff = subAvg - gradeSubAvg; // 负数表示落后
                if(diff < worstSub.diff) { worstSub = {name:sub, diff:diff}; }
            });

            prompt += `- ${cls}班(${n}人): 总分均分${avg.toFixed(1)} (与年级差 ${(avg - schoolData.metrics.total.avg).toFixed(1)}), 优秀率${(exc*100).toFixed(1)}%。最明显的短板学科是【${worstSub.name}】(低于年级均分 ${Math.abs(worstSub.diff).toFixed(1)} 分)。\n`;
        });

        prompt += `
\n请输出一份诊断报告，包含以下部分（请使用Markdown格式）：
1. **年级整体学情综述**：简要评价校内两极分化情况。
2. **重点关注班级**：指出1-2个均分落后或学科短板最严重的班级，语气要客观严厉。
3. **学科攻坚建议**：针对出现的共性弱势学科（或某班的特别弱项），给出具体的教学干预措施（如集体备课、分层作业、培优辅差等）。
4. **给班主任的管理建议**：如何调动班级学风。

要求：条理清晰，语气专业，字数 400-500 字。不要罗列数字，直接给出定性分析和可执行的建议。`;

        // B. 创建/显示弹窗
        const modalId = 'ai-class-report-modal';
        let modal = document.getElementById(modalId);
        if(!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:800px; display:flex; flex-direction:column; max-height:85vh;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <h3 style="color:var(--primary)"><i class="ti ti-brain"></i> AI 班级诊断报告</h3>
                        <button onclick="document.getElementById('${modalId}').style.display='none'" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
                    </div>
                    <div id="ai-class-report-content" style="background:#f8fafc; padding:20px; border-radius:8px; line-height:1.6; flex:1; overflow-y:auto; white-space:pre-wrap; font-family: sans-serif;">🤔 正在通过 ${LLM_CONFIG.source==='local'?'本地显卡':'云端 API'} 进行深度分析，请稍候...</div>
                    <div style="margin-top:15px; text-align:right; padding-top:10px; border-top:1px solid #eee;">
                        <button class="btn btn-gray" onclick="document.getElementById('${modalId}').style.display='none'">关闭</button>
                        <button class="btn btn-blue" onclick="navigator.clipboard.writeText(document.getElementById('ai-class-report-content').innerText); alert('已复制')">📋 复制报告</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        
        const contentBox = document.getElementById('ai-class-report-content');
        contentBox.innerHTML = '<div style="text-align:center; padding:30px;"><span class="loader-spinner" style="width:30px;height:30px;display:inline-block;vertical-align:middle;"></span><br><br>正在思考中...<br><span style="font-size:12px;color:#666">引擎: ' + (LLM_CONFIG.source==='local'?'WebLLM (本地)':'Cloud API') + '</span></div>';

        // C. 执行调用
        try {
            let fullText = "";
            await callUnifiedAI(prompt, (chunk) => {
                if (fullText === "") contentBox.innerHTML = ""; // 收到第一个字时清除loading
                fullText += chunk;
                contentBox.innerHTML = fullText; // 实时打字机效果
                contentBox.scrollTop = contentBox.scrollHeight; // 自动滚动到底部
            });
        } catch (e) {
            contentBox.innerHTML = `<div style="color:red; text-align:center; padding:20px;">
                <h3>🚫 分析失败</h3>
                <p>${e.message}</p>
                <p style="font-size:12px; color:#666;">如果是本地模式，请确保模型已加载且显存充足。</p>
            </div>`;
        }
    }    let CURRENT_REPORT_STUDENT = null; // 暂存当前正在查询的学生对象
    let BATCH_AI_CACHE = {}; // 存储批量生成的评语 key: "学校_班级_姓名"
    let IS_BATCH_AI_RUNNING = false; // 控制批量任务状态
    // ✋ 性能优化：定义学生明细表的分页状态
    let STD_PAGINATION = {
        page: 1,       // 当前页码
        size: 100,     // 每页显示条数 (调整此数值平衡性能与信息量)
        data: []       // 缓存当前筛选后的完整数据，避免翻页时重复筛选
    };
    
    let PREV_DATA = []; // 进退步分析专用
    let PROGRESS_CACHE = []; 
    let MANUAL_ID_MAPPINGS = {}; // 存储用户手动确认的同名映射关系 key: "Current_Class_Name" -> val: "Prev_Class_Name"
    let balanceChartInstance = null;
    let AID_GROUPS_CACHE = []; 
    let MP_DATA_CACHE = []; // 临界生数据缓存
    let MP_SNAPSHOTS = JSON.parse(localStorage.getItem('MP_SNAPSHOTS') || '{}'); // 持久化存储临界生快照
    let CURRENT_CONTEXT_STUDENTS = []; // 标签组件用
    
    // 考务与分班相关变量
    let FB_STUDENTS = []; let FB_CLASSES = []; let FB_CUR_CLASS_IDX = -1; let FB_SIMULATED_DATA = {};
    let EXAM_DATA = []; let EXAM_ROOMS = [];

    let FB_SCHEMES_CACHE = []; // 存储生成的多种方案

    const SUBJECT_ORDER = ['语文', '数学', '英语', '物理', '化学', '政治', '历史', '地理', '生物'];

    // [修改] 导航配置与逻辑 (方案二：功能场景导向版)
    // 说明：按“管数据 -> 比学校 -> 评班级 -> 抓学生 -> 用工具”的逻辑排列
    const NAV_STRUCTURE = {
        'data': { 
            title: '📂 数据管理', 
            color: '#334155', // 深灰 Slate
            items: [
                { id: 'upload', icon: 'ti-database-import', text: '数据上传与设置' }
            ] 
        },
        'town': { 
            title: '🏆 校际联考分析', 
            color: '#b45309', // 金色 Amber (代表荣誉与排名)
            items: [
                { id: 'summary', icon: 'ti-report', text: '综合评价总榜' }, // 领导最爱看，放第一
                { id: 'analysis', icon: 'ti-chart-pie', text: '两率一分(横向)' }, 
                { id: 'macro-watch', icon: 'ti-alert-triangle', text: '预警与亮点看板' },
                { id: 'high-score', icon: 'ti-trophy', text: '高分段/尖子生' }, 
                { id: 'indicator', icon: 'ti-target', text: '指标生达标核算' },
                { id: 'bottom3', icon: 'ti-arrow-bar-to-down', text: '低分率/后1/3核算' }
            ] 
        },
        'class': { 
            title: '🏫 班级教学管理', 
            color: '#dc2626', // 红色 Red (代表绩效与考核)
            items: [
                { id: 'teacher-analysis', icon: 'ti-school', text: '教师教学质量画像' }, 
                { id: 'single-school-eval', icon: 'ti-scale', text: '绩效公平考核模型' },
                { id: 'class-comparison', icon: 'ti-layout-columns', text: '班级横向对比' },
                { id: 'class-diagnosis', icon: 'ti-activity', text: '班级分化诊断(SD)' }
            ] 
        },
        'student': { 
            title: '🔎 学情深度诊断', 
            color: '#059669', // 绿色 Emerald (代表生长与诊治)
            items: [
                { id: 'student-details', icon: 'ti-list-details', text: '学生档案查询' },                 
                { id: 'subject-balance', icon: 'ti-scale', text: '⚖️ 优劣势学科透视' },
                { id: 'marginal-push', icon: 'ti-target-arrow', text: '🎯 临界生精准干预' }, 
                { id: 'progress-analysis', icon: 'ti-trending-up', text: '进退步/增值评价' },
                { id: 'cohort-growth', icon: 'ti-timeline', text: '📈 纵向成长档案' },
                { id: 'potential-analysis', icon: 'ti-bulb', text: '偏科潜力挖掘' },
                { id: 'segment-analysis', icon: 'ti-chart-histogram', text: '分数段统计' },
                { id: 'correlation-analysis', icon: 'ti-topology-star-3', text: '学科关联度分析' },                
                { id: 'report-generator', icon: 'ti-certificate', text: '成绩单/家长查分' }
            ] 
        },
        'tools': { 
            title: '🛠️ 教务考务工具', 
            color: '#7c3aed', // 紫色 Violet (代表工具箱)
            items: [
                { id: 'exam-arranger', icon: 'ti-id-badge-2', text: '智能考场编排' }, 
                { id: 'freshman-simulator', icon: 'ti-arrows-split', text: '新生均衡分班' },
                { id: 'grade-scheduler', icon: 'ti-calendar-time', text: '级部智能排课' },
                { id: 'seat-adjustment', icon: 'ti-armchair', text: '考后排座/互助组' },
                { id: 'mutual-aid', icon: 'ti-friends', text: '学科小老师分组' },
                { id: 'poster-generator', icon: 'ti-photo-star', text: '喜报红榜生成' }
            ] 
        }
    };

    let currentCategory = 'data';

    function renderNavigation() {
        const catContainer = document.getElementById('navCategories');
        const subContainer = document.getElementById('navSubItems');
        catContainer.innerHTML = '';

        // 如果 Auth 未初始化或未登录，默认为 guest
        const role = (typeof Auth !== 'undefined' && Auth.currentUser) ? Auth.currentUser.role : 'guest';
        
        // 1. 定义受限人群 (科任教师, 班主任, 级部主任)
        const restrictedRoles = ['teacher', 'class_teacher', 'grade_director'];
        const isRestricted = restrictedRoles.includes(role);

        // 2. 强制重定向：如果当前所在的大类是被禁止的，强制切换到“校际联考分析”('town')
        // (防止用户刷新页面后停留在被隐藏的模块)
        if (isRestricted && (currentCategory === 'data' || currentCategory === 'tools')) {
            currentCategory = 'town';
            // 同时应用新颜色的主题 (金色)
            document.documentElement.style.setProperty('--primary', NAV_STRUCTURE['town'].color);
        }

        Object.keys(NAV_STRUCTURE).forEach(key => {
            const cat = NAV_STRUCTURE[key];

            // 3. 核心屏蔽逻辑：如果是受限角色，跳过 'data' 和 'tools' 的渲染
            if (isRestricted) {
                if (key === 'data' || key === 'tools') return;
            }

            // --- 原有渲染逻辑保持不变 ---
            const div = document.createElement('div');
            div.className = `nav-cat-item ${key === currentCategory ? 'active' : ''}`;
            div.innerHTML = `${cat.title}`;
            
            div.onclick = () => {
                currentCategory = key;
                document.documentElement.style.setProperty('--primary', cat.color);
                renderNavigation();
                
                if (cat.items.length > 0) {
                    // 自动跳转到该类目下的第一个功能
                    switchTab(cat.items[0].id);
                }
            };
            catContainer.appendChild(div);
        });

        subContainer.innerHTML = '';
        if (!NAV_STRUCTURE[currentCategory]) currentCategory = 'town';
        const subItems = NAV_STRUCTURE[currentCategory].items;
        subItems.forEach(item => {
            
            // 1. 教师权限控制
            if (role === 'teacher') {
                // 屏蔽：绩效考核(涉及工资)、考务编排(教务权)、新生分班(教务权)
                const blockedModules = ['single-school-eval', 'exam-arranger', 'freshman-simulator'];
                if(blockedModules.includes(item.id)) return; 
            }

            // 2. 家长权限控制 (虽然 CSS 已经隐藏了 header，这里做双重保险)
            if (role === 'parent') return; 

            // 3. 教务主任权限 (通常拥有所有业务权限，除了账号管理，账号管理已在 Header 按钮处控制)
            
            if (item.id === 'report-generator' && !CONFIG.showQuery) return;
            const a = document.createElement('a');
            a.className = `nav-link`;
            if(document.getElementById(item.id).classList.contains('active')) a.classList.add('active');
            a.innerHTML = `<i class="ti ${item.icon}"></i> ${item.text}`;
            a.onclick = () => switchTab(item.id);
            subContainer.appendChild(a);
        });
    }

    function switchCategory(key) { currentCategory = key; renderNavigation(); }

    // ================= 侧边栏与通用工具 =================
    function scrollToAnchor(id, element) {
        const target = document.getElementById(id);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (element && element.closest) {
                const parent = element.closest('.side-nav');
                if(parent) {
                    parent.querySelectorAll('.side-nav-link').forEach(el => el.classList.remove('active'));
                    parent.querySelectorAll('.side-nav-sub-link').forEach(el => el.classList.remove('active')); 
                }
                if (element.classList) element.classList.add('active');
            }
        }
    }

    function toggleSubNav(element) {
        const container = element.nextElementSibling;
        if (container && container.classList.contains('side-nav-sub-container')) {
            container.classList.toggle('show');
            element.classList.toggle('expanded');
        }
    }

    function scrollToSubAnchor(id, element) {
        const target = document.getElementById(id);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            const sideNav = element.closest('.side-nav');
            if(sideNav) {
                sideNav.querySelectorAll('.side-nav-link').forEach(el => el.classList.remove('active'));
                sideNav.querySelectorAll('.side-nav-sub-link').forEach(el => el.classList.remove('active'));
                const parentContainer = element.closest('.side-nav-sub-container');
                if(parentContainer && parentContainer.previousElementSibling) parentContainer.previousElementSibling.classList.add('active');
            }
            element.classList.add('active');
        }
    }

    function safeGet(obj, path, defaultValue = '-') { return path.split('.').reduce((acc, key) => acc && acc[key], obj) || defaultValue; }
    function getSubjectOrderIndex(sub) { const idx = SUBJECT_ORDER.indexOf(sub); return idx === -1 ? 999 : idx; }
    function sortSubjects(a, b) { const idxA = getSubjectOrderIndex(a); const idxB = getSubjectOrderIndex(b); if (idxA !== idxB) return idxA - idxB; return a.localeCompare(b); }

    // ================= 辅助函数：Excel 格式化 =================
    function getExcelPercent(val) {
        if (typeof val !== 'number' || isNaN(val)) return '-';
        return { t: 'n', v: val, z: '0.00%' };
    }
    function getExcelNum(val, decimals = 2) {
        if (typeof val !== 'number' || isNaN(val)) return '-';
        return { t: 'n', v: parseFloat(val.toFixed(decimals)) };
    }

    // 定义一套专业的样式配置
    const XLS_STYLES = {
        // 表头样式
        HEADER: {
            font: { bold: true, sz: 12, color: { rgb: "333333" }, name: "Microsoft YaHei" },
            fill: { fgColor: { rgb: "E5E7EB" } }, // 浅灰背景
            border: { top: {style:'thin'}, bottom: {style:'medium'}, left: {style:'thin'}, right: {style:'thin'} },
            alignment: { horizontal: "center", vertical: "center", wrapText: true }
        },
        // 普通单元格
        CELL: {
            font: { sz: 11, name: "Arial" },
            border: { top: {style:'thin', color: {rgb:"E5E7EB"}}, bottom: {style:'thin', color: {rgb:"E5E7EB"}}, left: {style:'thin', color: {rgb:"E5E7EB"}}, right: {style:'thin', color: {rgb:"E5E7EB"}} },
            alignment: { horizontal: "center", vertical: "center" }
        },
        // 排名高亮 (前三名)
        RANK_TOP: {
            font: { bold: true, color: { rgb: "DC2626" } } // 红色
        },
        // 优秀 (绿色)
        SCORE_GOOD: {
            font: { color: { rgb: "16A34A" }, bold: true }
        },
        // 不及格 (红色)
        SCORE_BAD: {
            font: { color: { rgb: "DC2626" } }
        }
    };

    /**
     * 一键美化 Worksheet 对象
     * @param {Object} ws SheetJS 的 worksheet 对象
     * @param {Array} headers 表头数组（用于判断列类型）
     */
    function decorateExcelSheet(ws, headers = []) {
        if(!ws['!ref']) return;
        
        const range = XLSX.utils.decode_range(ws['!ref']);
        const colWidths = [];

        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({ c: C, r: R });
                if (!ws[cellRef]) continue;

                const cell = ws[cellRef];
                const headerName = headers[C] || ""; // 获取当前列的表头名
                
                // 1. 基础样式应用
                let style = JSON.parse(JSON.stringify(R === 0 ? XLS_STYLES.HEADER : XLS_STYLES.CELL));
                
                // 2. 表头特殊处理
                if (R === 0) {
                    // 如果是“总分”或“排名”，加深背景
                    if (String(cell.v).includes("总分") || String(cell.v).includes("排名")) {
                        style.fill.fgColor = { rgb: "D1FAE5" }; // 浅绿
                    }
                } 
                // 3. 数据行智能处理
                else {
                    // 🦓 斑马纹 (偶数行微灰)
                    if (R % 2 === 0) style.fill = { fgColor: { rgb: "F9FAFB" } };

                    // 🏆 排序列处理
                    if (headerName.includes("排名") || headerName.includes("名次")) {
                        if (cell.v === 1 || cell.v === 2 || cell.v === 3) {
                            Object.assign(style.font, XLS_STYLES.RANK_TOP.font);
                            style.fill = { fgColor: { rgb: "FEF3C7" } }; // 浅黄底
                        }
                    }
                    
                    // 📉 分数/率 处理
                    if (typeof cell.v === 'number') {
                        // 及格率/优秀率 < 60% 标红 (如果是百分比数值 0.6)
                        if (headerName.includes("率") && cell.v < 0.6) {
                            Object.assign(style.font, XLS_STYLES.SCORE_BAD.font);
                        }
                        // 分数 < 60 标红 (假设满分100以上)
                        if ((headerName.includes("分") || headerName.includes("绩")) && cell.v < 60 && cell.v > 0) {
                            Object.assign(style.font, XLS_STYLES.SCORE_BAD.font);
                        }
                    }
                    
                    // 文本对齐优化：姓名、学校左对齐
                    if (headerName.includes("姓名") || headerName.includes("学校") || headerName.includes("班级")) {
                        style.alignment.horizontal = "left";
                        // 增加一点缩进
                        style.alignment.indent = 1;
                    }
                }

                // 应用样式
                cell.s = style;

                // 4. 计算列宽 (简单估算)
                const valLen = (cell.v ? String(cell.v).length : 0) * 1.5;
                colWidths[C] = Math.max(colWidths[C] || 5, valLen > 50 ? 50 : valLen); // 限制最大宽度
            }
        }

        // 应用列宽
        ws['!cols'] = colWidths.map(w => ({ wch: w + 2 })); // 加一点padding
        
        // 冻结首行
        ws['!freeze'] = { xSplit: 0, ySplit: 1 };
    }

    // --- 隐私/演示模式逻辑 ---
    
    function togglePrivacyMode() {
        const btn = document.getElementById('btn-privacy-toggle');
        const indicator = document.getElementById('privacy-indicator');
        
        if (!IS_PRIVACY_ON) {
            // === 开启隐私模式 ===
            if (RAW_DATA.length === 0) return alert("请先上传数据后再开启演示模式。");
            
            if (!confirm("🛡️ 即将进入【隐私演示模式】：\n\n1. 所有学生姓名将变为代码 (如 S-001)\n2. 所有教师姓名将变为代码 (如 T-01)\n3. 适合投屏汇报或截图分享\n\n点击确定继续。")) return;

            // 1. 备份原始数据 (Deep Copy)
            DATA_BACKUP_PRIVACY = {
                RAW_DATA: JSON.parse(JSON.stringify(RAW_DATA)),
                TEACHER_MAP: JSON.parse(JSON.stringify(TEACHER_MAP)),
                // 也要备份历史数据，否则进退步分析会乱
                PREV_DATA: JSON.parse(JSON.stringify(PREV_DATA))
            };

            // 2. 执行脱敏 (Masking)
            // 建立映射表保证同名同ID
            const stuMap = new Map(); 
            let stuCounter = 1;
            
            // 脱敏 RAW_DATA
            RAW_DATA.forEach(s => {
                const key = s.name; // 简单按姓名映射，如果有重名会映射成同一个代码，符合演示逻辑
                if (!stuMap.has(key)) {
                    stuMap.set(key, `S-${String(stuCounter++).padStart(3, '0')}`);
                }
                s.name = stuMap.get(key);
            });

            // 脱敏 PREV_DATA (如果有)
            if (PREV_DATA.length > 0) {
                PREV_DATA.forEach(p => {
                    const key = p.name;
                    // 如果是上次有但本次没有的学生，给新号；如果有，用旧号
                    if (!stuMap.has(key)) {
                         stuMap.set(key, `S-${String(stuCounter++).padStart(3, '0')}`);
                    }
                    p.name = stuMap.get(key);
                });
            }

            // 脱敏 TEACHER_MAP
            const teacherMap = new Map();
            let teaCounter = 1;
            Object.keys(TEACHER_MAP).forEach(k => {
                const realName = TEACHER_MAP[k];
                if (!teacherMap.has(realName)) {
                    teacherMap.set(realName, `T-${String(teaCounter++).padStart(2, '0')}`);
                }
                TEACHER_MAP[k] = teacherMap.get(realName);
            });

            // 3. 标记状态并刷新
            IS_PRIVACY_ON = true;
            btn.innerHTML = '<i class="ti ti-eye"></i> 退出隐私模式';
            btn.style.background = "#dc2626"; // 红色按钮提示退出
            indicator.style.display = "block";
            document.body.classList.add('privacy-mode-active'); // 可用于CSS扩展

        } else {
            // === 关闭隐私模式 (还原) ===
            if (DATA_BACKUP_PRIVACY) {
                RAW_DATA = DATA_BACKUP_PRIVACY.RAW_DATA;
                TEACHER_MAP = DATA_BACKUP_PRIVACY.TEACHER_MAP;
                PREV_DATA = DATA_BACKUP_PRIVACY.PREV_DATA;
                DATA_BACKUP_PRIVACY = null;
            }

            IS_PRIVACY_ON = false;
            btn.innerHTML = '<i class="ti ti-eye-off"></i> 开启隐私模式';
            btn.style.background = "rgba(255,255,255,0.2)";
            indicator.style.display = "none";
            document.body.classList.remove('privacy-mode-active');
        }

        // 4. 全局重算与重绘
        // 因为 SCHOOLS, TEACHER_STATS 等都是基于 RAW_DATA 计算的，必须重置
        SCHOOLS = {}; 
        TEACHER_STATS = {}; 
        TEACHER_TOWNSHIP_RANKINGS = {};
        
        // 重新运行数据处理流程
        processData(); 
        calculateRankings(); 
        
        // 如果当前在教师分析页，重算教师数据
        if (Object.keys(TEACHER_MAP).length > 0 && MY_SCHOOL) {
            analyzeTeachers(); 
        }

        // 刷新所有表格视图
        renderTables();
        
        // 刷新特定的视图（如果当前正停留在这些Tab）
        // 比如教师卡片
        if (!document.getElementById('teacherCardsContainer').innerHTML.includes('暂无')) {
            renderTeacherCards();
            renderTeacherComparisonTable();
            renderTeacherTownshipRanking();
        }
        // 比如进退步
        if (document.getElementById('progress-analysis').classList.contains('active')) {
             if (PREV_DATA.length > 0) renderProgressAnalysis();
        }

        alert(IS_PRIVACY_ON ? "✅ 隐私模式已开启：姓名已脱敏，可进行汇报演示。" : "✅ 隐私模式已退出：数据已还原。");
    }

    window.IS_GUEST_MODE = false; // 全局标记

    function toggleGuestMode() {
        const btn = document.getElementById('btn-guest-mode');
        
        if (!window.IS_GUEST_MODE) {
            // === 准备开启 ===
            Swal.fire({
                title: '🔥 开启“阅后即焚”模式？',
                html: `
                    <div style="text-align:left; font-size:14px; color:#555;">
                        <p>此模式适用于公用电脑或临时处理数据。</p>
                        <ul style="color:#b91c1c; font-weight:bold;">
                            <li>1. 立即清空现有的自动存档。</li>
                            <li>2. 停止一切自动备份功能。</li>
                            <li>3. 关闭页面或刷新后，所有数据将永久丢失。</li>
                        </ul>
                        <p>确定要进入此模式吗？</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#64748b',
                confirmButtonText: '确定开启 (清除旧缓存)',
                cancelButtonText: '取消'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // 1. 立即清除缓存
                    await DB.clear('autosave_backup');
                    
                    // 2. 清除 LocalStorage 中的非配置类数据
                    localStorage.removeItem('FB_DATA_BACKUP');
                    localStorage.removeItem('MP_SNAPSHOTS');
                    
                    // 3. 改变状态
                    window.IS_GUEST_MODE = true;
                    
                    // 4. UI 变化
                    btn.innerHTML = '<i class="ti ti-flame-off"></i> 退出并清空';
                    btn.style.background = "#dc2626";
                    btn.style.borderColor = "#b91c1c";
                    
                    // 5. 页面增加水印或标识
                    document.body.style.borderTop = "5px solid #dc2626";
                    const statusEl = document.getElementById('auto-backup-status');
                    if(statusEl) statusEl.innerHTML = `<span style="color:#dc2626; font-weight:bold;">🔥 阅后即焚模式：数据不落地</span>`;

                    UI.toast("🔥 已开启阅后即焚：旧缓存已清理，新数据将不再保存。", "success");
                }
            });

        } else {
            // === 准备关闭 (其实就是重置) ===
            Swal.fire({
                title: '退出阅后即焚',
                text: "退出将刷新页面并重置系统。当前屏幕上的数据将会丢失。",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '退出并刷新',
                confirmButtonColor: '#4f46e5'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload(); // 直接刷新，回归初始状态
                }
            });
        }
    }
    
    // 拦截手动保存操作 (双重保险)
    const originalSaveSnapshot = saveProjectSnapshot; // 备份原函数
    saveProjectSnapshot = function() {
        if (window.IS_GUEST_MODE) {
            Swal.fire({
                title: '⚠️ 模式限制',
                text: '当前处于“阅后即焚”模式，禁止保存项目快照到本地硬盘。请先退出此模式。',
                icon: 'error',
                confirmButtonColor: '#dc2626'
            });
            return;
        }
        originalSaveSnapshot();
    };

    // ================= 初始化 =================
   function initSystem(type) {
        document.getElementById('mode-mask').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        if (type === '6-8') CONFIG = { name: '6-8年级', label: '全科总', excRate: 0.05, totalSubs: 'auto', analysisSubs: 'auto', showQuery: true };
        else CONFIG = { name: '9年级', label: '五科总', excRate: 0.06, totalSubs: ['语文','数学','英语','物理','化学'], analysisSubs: ['语文','数学','英语','物理','化学','政治'], showQuery: true };
        document.getElementById('mode-badge').innerText = CONFIG.name;
        document.getElementById('mode-info').innerText = `${CONFIG.name}模式 (总分: ${CONFIG.label}, 后1/3剔除: ${CONFIG.excRate*100}%)`;
        document.querySelectorAll('.label-total').forEach(e => e.innerText = CONFIG.label);
        document.getElementById('label-exc').innerText = (CONFIG.excRate*100) + '%';
        renderNavigation();
    }

    // [优化] switchTab: 增加动态副标题更新，提升上下文感知
    function switchTab(id) {
        // 1. 切换内容区域显示
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // 2. 定位所属大类
        let foundCategory = null;
        let currentItemName = '';
        
        Object.keys(NAV_STRUCTURE).forEach(catKey => { 
            const item = NAV_STRUCTURE[catKey].items.find(i => i.id === id);
            if(item) {
                foundCategory = catKey;
                currentItemName = item.text;
            }
        });

        // 3. 如果大类变化，刷新一级导航和全局颜色
        if(foundCategory && foundCategory !== currentCategory) {
            currentCategory = foundCategory;
            // 立即应用新颜色的主题
            const newColor = NAV_STRUCTURE[currentCategory].color;
            document.documentElement.style.setProperty('--primary', newColor);
            
            // 重新渲染导航以更新高亮
            renderNavigation();
        } else {
            // 如果大类没变，仅更新二级菜单的高亮状态 (性能优化，不重绘整个导航)
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // 找到含有对应 onclick 的链接添加 active
            const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(el => el.onclick.toString().includes(id));
            if(activeLink) activeLink.classList.add('active');
        }

        // 4. [新增] 动态更新 Header 副标题 (面包屑效果)
        const catTitle = NAV_STRUCTURE[currentCategory].title; // e.g. "🏆 校际联考"
        const subTitleEl = document.getElementById('app-subtitle');
        if(subTitleEl) {
            subTitleEl.innerHTML = `<span style="opacity:0.7">${catTitle}</span> <i class="ti ti-chevron-right" style="font-size:10px;"></i> <strong>${currentItemName}</strong>`;
            subTitleEl.style.animation = 'none';
            subTitleEl.offsetHeight; /* trigger reflow */
            subTitleEl.style.animation = 'fadeIn 0.5s';
        }

        // [新增] 5. 自动同步当前页面的“说明条”颜色 (视觉统一)
        // 找到当前激活的 section
        const activeSection = document.getElementById(id);
        if(activeSection) {
            // 找到内部的 module-desc-bar
            const descBar = activeSection.querySelector('.module-desc-bar');
            if(descBar) {
                // 强制应用当前大类的颜色
                descBar.style.borderLeftColor = NAV_STRUCTURE[currentCategory].color;
                // 可选：同时让标题颜色也跟随变化
                const descTitle = descBar.querySelector('h3');
                if(descTitle) descTitle.style.color = '#333'; // 保持深色或设为 NAV_STRUCTURE[currentCategory].color
            }
        }
        
        // 6. 模块特定初始化逻辑 (保持原有逻辑不变)
        if (id === 'student-details') updateStudentSchoolSelect();
        if (id === 'high-score') renderHighScoreTable(); 
        if (id === 'teacher-analysis') {
            
            // 1. 核心修复：如果本校变量为空，立即根据数据进行暴力推断
            if (!MY_SCHOOL && typeof SCHOOLS !== 'undefined' && Object.keys(SCHOOLS).length > 0) {
                
                // 策略A: 如果全镇只有一所学校（单校版），直接锁定
                const schoolNames = Object.keys(SCHOOLS);
                if (schoolNames.length === 1) {
                    MY_SCHOOL = schoolNames[0];
                } 
                // 策略B: 如果有多所学校，根据任课表反推“最可能的学校”
                else if (typeof TEACHER_MAP !== 'undefined' && Object.keys(TEACHER_MAP).length > 0) {
                    const schoolCounts = {};
                    
                    // 遍历任课表中的每一个“班级_科目”键
                    Object.keys(TEACHER_MAP).forEach(key => {
                        const cls = key.split('_')[0]; // 提取班级名，如 "9.1"
                        
                        // 在所有学校中搜寻：谁拥有这个班级？
                        for (const sName of schoolNames) {
                            const hasClass = SCHOOLS[sName].students.some(s => s.class == cls);
                            if (hasClass) {
                                // 找到归属，给该学校投一票
                                schoolCounts[sName] = (schoolCounts[sName] || 0) + 1;
                                break; 
                            }
                        }
                    });

                    // 票数最高的学校即为本校
                    let max = 0;
                    let winner = "";
                    for(const [s, c] of Object.entries(schoolCounts)) {
                        if(c > max) { max = c; winner = s; }
                    }
                    
                    if (winner) {
                        MY_SCHOOL = winner;
                        console.log("🤖 [智能修复] 系统已自动根据任课表锁定本校为:", MY_SCHOOL);
                    }
                }
                
                // 如果推断成功，自动同步 UI 下拉框，让用户无感
                if (MY_SCHOOL) {
                    const sel = document.getElementById('mySchoolSelect');
                    if (sel) sel.value = MY_SCHOOL;
                }
            }

            // 2. 执行分析 (现在 MY_SCHOOL 应该已经被自动填好了)
            if (MY_SCHOOL && Object.keys(TEACHER_MAP).length > 0) {
                analyzeTeachers(); 
                renderTeacherComparisonTable(); 
                renderTeacherTownshipRanking();
            } else {
                // 3. 如果还是失败（通常是因为还没上传学生成绩，只有教师名单是无法分析的）
                const compTable = document.getElementById('teacherComparisonTable');
                if(compTable) {
                    compTable.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#999;">
                            <div style="font-size:48px; margin-bottom:10px;">🏫❓</div>
                            <p style="font-size:16px; font-weight:bold; color:#333;">无法自动识别“本校”</p>
                            <div style="background:#f9fafb; padding:10px 20px; border-radius:6px; display:inline-block; text-align:left; margin-top:10px; font-size:13px; color:#666; line-height:1.8;">
                                <strong>可能原因：</strong><br>
                                1. 您仅导入了教师配置，但尚未上传<strong>【学生成绩】</strong>数据。<br>
                                <span style="color:#d97706">(系统需要结合学生名单才能确认班级归属)</span><br>
                                2. 任课表中的班级名 (如 9.1) 与成绩表中的班级名 (如 901) 不一致。<br>
                            </div>
                        </div>`;
                }
                document.getElementById('teacher-township-ranking-container').innerHTML = '';
            }
        }
        if (id === 'exam-arranger') {
            EXAM_initProctorUI(); 
        }
        if (id === 'report-generator') { updateMarginalSchoolSelect(); updateClassSelect(); }
        if (id === 'segment-analysis') updateSegmentSelects();
        if (id === 'class-comparison') updateClassCompSchoolSelect();
        if (id === 'potential-analysis') updatePotentialSchoolSelect();
        if (id === 'class-diagnosis') updateDiagnosisSelects();
        if (id === 'correlation-analysis') updateCorrelationSchoolSelect();
        if (id === 'seat-adjustment') updateSeatAdjSelects();
        if (id === 'subject-balance') updateSubjectBalanceSelects();
        if (id === 'progress-analysis') {
            
            // 1. 智能推断本校 (逻辑保持不变)
            if (!MY_SCHOOL && typeof TEACHER_MAP !== 'undefined' && Object.keys(TEACHER_MAP).length > 0 && typeof SCHOOLS !== 'undefined') {
                const schoolCounts = {};
                const schoolNames = Object.keys(SCHOOLS);
                Object.keys(TEACHER_MAP).forEach(key => {
                    const cls = key.split('_')[0]; 
                    for (const sName of schoolNames) {
                        if (SCHOOLS[sName].students.some(s => s.class == cls)) {
                            schoolCounts[sName] = (schoolCounts[sName] || 0) + 1;
                            break; 
                        }
                    }
                });
                let max = 0; let winner = "";
                for(const [s, c] of Object.entries(schoolCounts)) { if(c > max) { max = c; winner = s; } }
                if (winner) { MY_SCHOOL = winner; }
            }

            // 2. 初始化下拉框
            updateProgressSchoolSelect();
            const progSel = document.getElementById('progressSchoolSelect');
            if (MY_SCHOOL && progSel) progSel.value = MY_SCHOOL;

            // 3. 🔥 核心修复：检查内存数据并激活 🔥
            const statusEl = document.getElementById('va-data-status');
            
            // 只要 PREV_DATA 有长度，就说明云端或本地已加载
            if (window.PREV_DATA && window.PREV_DATA.length > 0) {
                // 成功状态
                if(statusEl) {
                    statusEl.innerHTML = `✅ 数据就绪 (已加载 ${window.PREV_DATA.length} 条历史记录)`;
                    statusEl.style.color = "#16a34a";
                    statusEl.style.fontWeight = "bold";
                }
                
                // 如果还没有生成缓存(PROGRESS_CACHE)，立即执行静默匹配
                if (!window.PROGRESS_CACHE || window.PROGRESS_CACHE.length === 0) {
                    if (typeof performSilentMatching === 'function') performSilentMatching();
                }
                
                // 渲染报表
                if (typeof renderValueAddedReport === 'function') renderValueAddedReport(true);
                
                // 如果选中了学校，渲染个人追踪
                if (progSel && progSel.value && typeof renderProgressAnalysis === 'function') {
                    renderProgressAnalysis(); 
                }
            } else {
                // 失败状态
                if(statusEl) {
                    statusEl.innerHTML = `❌ 缺上次考试数据 (请到“数据 -> 历史数据对比”上传)`;
                    statusEl.style.color = "#dc2626";
                }
            }
        }
        if (id === 'mutual-aid') updateMutualAidSelects();
        if (id === 'poster-generator') updatePosterSelects();
        if (id === 'marginal-push') updateMpSchoolSelect();
        // 如果是单校绩效模块，触发一次下拉框更新
        if (id === 'single-school-eval') updateSSESchoolSelect();
    }

    const DrillSystem = {
        history: [], // 导航历史栈
        currentData: null, // 当前暂存数据
        exportData: null, // 🟢 新增：专门用于导出的数据缓存

        // 1. 打开入口
        open: function(title, studentList, scoreLabel = "总分") {
            this.history = []; // 清空历史
            this.currentData = { title, list: studentList, scoreLabel };
            
            // 🟢 缓存导出数据：如果是普通名单，直接缓存学生列表
            this.exportData = { type: 'list', data: studentList, fileName: title };
            
            // 🟢 显示导出按钮 (防止之前被隐藏)
            const btn = document.getElementById('drill-export-btn');
            if(btn) btn.classList.remove('hidden');

            document.getElementById('drill-modal').style.display = 'flex';
            this.renderClassView();
        },

        // 🟢 新增：通用导出功能
        exportExcel: function() {
            if (!this.exportData || !this.exportData.data) return alert("当前无数据可导出");
            
            const wb = XLSX.utils.book_new();
            let ws = null;
            const filename = (this.exportData.fileName || "导出数据") + ".xlsx";

            if (this.exportData.type === 'gap') {
                // 🅰️ 导出临界生/潜力生分析数据 (特殊表头)
                const headers = ['班级', '姓名', '当前总分', '距目标分差', '建议补救/潜力学科', '该科与年级均分差'];
                const data = [headers];
                this.exportData.data.forEach(item => {
                    // 去除HTML标签 (提取纯文本)
                    const cleanSub = item.worstSub.replace(/<[^>]+>/g, ""); 
                    data.push([
                        item.class, 
                        item.name, 
                        item.total, 
                        item.scoreGap.toFixed(1), 
                        cleanSub, 
                        item.worstDiff
                    ]);
                });
                ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:10}, {wch:10}, {wch:10}, {wch:12}, {wch:30}, {wch:15}];

            } else {
                // 🅱️ 导出普通学生名单 (如点击"达标人数"时)
                const headers = ['班级', '姓名', '考号', '总分', '全镇排名'];
                const data = [headers];
                this.exportData.data.forEach(s => {
                    data.push([
                        s.class, 
                        s.name, 
                        s.id, 
                        s.total, 
                        safeGet(s, 'ranks.total.township', '-')
                    ]);
                });
                ws = XLSX.utils.aoa_to_sheet(data);
            }

            XLSX.utils.book_append_sheet(wb, ws, "导出数据");
            XLSX.writeFile(wb, filename);
        },

        // 2. 渲染班级视图
        renderClassView: function() {
            const { title, list, scoreLabel } = this.currentData;
            document.getElementById('drill-title').innerText = title;
            document.getElementById('drill-back-btn').classList.add('hidden');

            // 按班级分组
            const classMap = {};
            list.forEach(s => {
                if (!classMap[s.class]) classMap[s.class] = [];
                classMap[s.class].push(s);
            });

            // 排序班级
            const classes = Object.keys(classMap).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));

            let html = `<div class="drill-class-grid">`;
            classes.forEach(cls => {
                const count = classMap[cls].length;
                html += `
                    <div class="drill-class-card" onclick="DrillSystem.renderStudentView('${cls}')">
                        <div class="drill-label">${cls}</div>
                        <div class="drill-val">${count} 人</div>
                        <div class="drill-label" style="font-size:10px;">点击查看名单 &gt;</div>
                    </div>`;
            });
            html += `</div>`;

            if(list.length === 0) html = '<div style="text-align:center; padding:30px; color:#999;">暂无相关学生数据</div>';

            document.getElementById('drill-content').innerHTML = html;
            document.getElementById('drill-footer').innerText = `合计: ${list.length} 人`;
        },

        // 3. 渲染学生名单视图
        renderStudentView: function(className) {
            const { list, scoreLabel } = this.currentData;
            this.history.push('class_view');
            
            document.getElementById('drill-title').innerText = `${className} - 名单`;
            document.getElementById('drill-back-btn').classList.remove('hidden');

            const students = list.filter(s => s.class === className).sort((a,b) => b.total - a.total);

            let html = `<div class="drill-stu-list">`;
            students.forEach(s => {
                html += `
                    <div class="drill-stu-tag">
                        <span style="cursor:pointer;" onclick="jumpToStudent('${s.name}', '${s.school}', '${s.class}'); document.getElementById('drill-modal').style.display='none';">${s.name}</span>
                        <span class="drill-stu-score">${s.total}</span>
                    </div>`;
            });
            html += `</div>`;
            
            document.getElementById('drill-content').innerHTML = html;
        },

        // 4. 返回上一级
        goBack: function() {
            if (this.history.length > 0) {
                this.history.pop();
                this.renderClassView();
            }
        }
    };

    // 辅助：各模块的点击处理器
    function handleIndicatorClick(schoolName, type) {
        if (!SCHOOLS[schoolName]) return;
        
        // 获取当前设定的划线
        const r1 = parseInt(document.getElementById('ind1').value);
        const r2 = parseInt(document.getElementById('ind2').value);
        if (!r1 || !r2) return alert("请先设置指标参数");

        const allScores = RAW_DATA.map(s => s.total).sort((a,b)=>b-a);
        const line = type === 'ind1' ? (allScores[r1-1] || 0) : (allScores[r2-1] || 0);
        const title = `${schoolName} - ${type==='ind1'?'指标一':'指标二'}达标名单 (线≥${line})`;

        // 筛选学生
        const students = SCHOOLS[schoolName].students.filter(s => s.total >= line);
        
        DrillSystem.open(title, students);
    }

    function handleHighClick(schoolName) {
        if (!SCHOOLS[schoolName]) return;
        // 9年级默认490，或者这里可以做成动态的
        const line = 490; 
        const students = SCHOOLS[schoolName].students.filter(s => s.total >= line);
        DrillSystem.open(`${schoolName} - 高分段(≥${line})名单`, students);
    }

    function handleExcludedClick(schoolName) {
        if (!SCHOOLS[schoolName]) return;
        const s = SCHOOLS[schoolName];
        // 重新计算剔除逻辑
        const sorted = [...s.students].sort((a,b) => a.total - b.total); // 升序
        const excN = s.bottom3 ? s.bottom3.excN : 0;
        
        // 取最低分的 N 个
        const students = sorted.slice(0, excN).sort((a,b) => b.total - a.total); // 展示时按分降序好看点
        
        DrillSystem.open(`${schoolName} - 后1/3核算剔除名单 (共${excN}人)`, students);
    }

    // === 渲染高分段表格 ===
    function renderHighScoreTable() {
        const tbody = document.querySelector('#tb-high-score tbody');
        tbody.innerHTML = '';
        
        if (!CONFIG.name || !CONFIG.name.includes('9')) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">🚫 当前非 9 年级模式，无高分段核算数据。</td></tr>';
            return;
        }
        if (Object.keys(SCHOOLS).length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">请先上传数据</td></tr>';
            return;
        }

        // 1. 提取所有学校数据
        const list = Object.values(SCHOOLS).map(s => {
            const hs = s.highScoreStats || { count: 0, ratio: 0, score: 0 };
            return {
                name: s.name,
                count: s.metrics.total ? s.metrics.total.count : 0,
                hsCount: hs.count,
                hsRatio: hs.ratio,
                score: hs.score
            };
        });

        // 2. 排序：按高分赋分降序
        list.sort((a,b) => b.score - a.score);

        // 3. 渲染所有行 (没有 slice)
        let html = '';
        list.forEach((d, i) => {
            const isMySchool = d.name === MY_SCHOOL;
            html += `<tr class="${isMySchool?'bg-highlight':''}">
                <td>${d.name}</td>
                <td>${d.count}</td>
                <td style="font-weight:bold;">
                    <!-- 添加点击事件 -->
                    <span class="clickable-num" onclick="handleHighClick('${d.name}')" title="点击查看高分学生名单">
                        ${d.hsCount}
                    </span>
                </td>
                <td>${(d.hsRatio * 100).toFixed(2)}%</td>
                <td class="text-red" style="font-size:1.1em; font-weight:bold;">${d.score.toFixed(2)}</td>
                ${getRankHTML(i + 1)}
            </tr>`;
        });
        tbody.innerHTML = html;
        
        // 更新 UI 提示
        console.log(`已渲染 ${list.length} 所学校的高分数据`);
    }

    // === 导出高分段 Excel ===
    function exportHighScoreExcel() {
        if (!Object.keys(SCHOOLS).length) return alert("无数据");
        if (!CONFIG.name.includes('9')) return alert("非9年级模式无此数据");

        const wb = XLSX.utils.book_new();
        const headers = ["学校名称", "实考人数", "高分人数(≥490)", "高分率", "高分赋分(70)", "排名"];
        const wsData = [headers];

        const list = Object.values(SCHOOLS).map(s => {
            const hs = s.highScoreStats || { count: 0, ratio: 0, score: 0 };
            return {
                name: s.name,
                count: s.metrics.total ? s.metrics.total.count : 0,
                hsCount: hs.count,
                hsRatio: hs.ratio,
                score: hs.score
            };
        }).sort((a,b) => b.score - a.score);

        list.forEach((d, i) => {
            wsData.push([
                d.name,
                d.count,
                d.hsCount,
                getExcelPercent(d.hsRatio),
                getExcelNum(d.score),
                i + 1
            ]);
        });

        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "高分段核算");
        XLSX.writeFile(wb, `高分段核算_${CONFIG.name}.xlsx`);
    }

    // ================= 数据处理 =================
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (isArchiveLocked()) return alert("⛔ 当前考试已封存，禁止上传新数据");
        if (!CURRENT_COHORT_ID) return alert("请先选择或新建届别");
        if (!CURRENT_EXAM_ID) {
            setCurrentExamMeta();
            if (!CURRENT_EXAM_ID) return;
        }
        const files = e.target.files; 
        if(!files.length) return;

        // 使用 Perf.runAsync 包裹，实现加载动画 + 防卡死
        Perf.runAsync(async () => {
            // 重置数据
            RAW_DATA = []; SCHOOLS = {}; SUBJECTS = []; TEACHER_MAP = {}; TEACHER_STATS = {}; 
            TEACHER_TOWNSHIP_RANKINGS = {}; MARGINAL_STUDENTS = {}; POTENTIAL_STUDENTS_CACHE = []; TOWNSHIP_RANKING_DATA = {}; MY_SCHOOL = "";
            document.getElementById('teacherCardsContainer').innerHTML = ''; 
            document.getElementById('teacherComparisonTable').querySelector('tbody').innerHTML = '';
            document.getElementById('teacher-township-ranking-container').innerHTML = ''; 
            document.getElementById('studentDetailTable').querySelector('tbody').innerHTML = '';
            document.getElementById('marginal-student-results').innerHTML = '';
            
            // 耗时操作
            for(let f of files) await readExcel(f);
            SUBJECTS.sort(sortSubjects);
            await processData(); // 这是一个耗时操作

            // 🟣 Cohort：写入考试快照并执行智能匹配
            await CohortDB.syncCurrentExam();
            
            // 🟢 [新增] 处理完数据后，立即同步到云端 (仅管理员有效)
            // 注意：因为是异步，我们在后台默默保存，不阻塞界面显示
            saveCloudData().then(() => {
                console.log("自动备份完成");
            }).catch(e => console.error("自动备份失败", e));
            renderTables();            
            // 更新所有下拉框
            updateSchoolSelect(); updateMySchoolSelect(); updateStudentSchoolSelect(); updateMarginalSchoolSelect(); 
            updateClassSelect(); updateSegmentSelects(); updateClassCompSchoolSelect(); updatePotentialSchoolSelect(); 
            updateDiagnosisSelects(); updateCorrelationSchoolSelect(); updateSeatAdjSelects(); updateProgressSchoolSelect(); 
            updateMutualAidSelects(); updateMpSchoolSelect(); 

            document.getElementById('msg-box').innerText = `✅ 成功导入 ${Object.keys(SCHOOLS).length} 所学校，共 ${RAW_DATA.length} 名学生`;
            UI.toast(`✅ 导入成功！包含 ${RAW_DATA.length} 条数据`, 'success');
        }, "正在解析 Excel 并计算排名...");
    });

        async function readExcel(file) {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, {type:'array'});
        wb.SheetNames.forEach(sname => {
            if(sname.includes('二模本校') || sname.includes('各班各科') || sname.includes('横向对比')) return;
            const json = XLSX.utils.sheet_to_json(wb.Sheets[sname], {header:1});
            if(json.length < 2) return;
            parseRows(json, sname);
        });
    }

    // =========== 🔥 修改重点：parseRows 全自动版 (含缺考录入) ===========
    // 逻辑说明：
    // 1. 只要Excel里有姓名，就录入系统，作为【在籍人数】的基数。
    // 2. 只有当学生有有效分数时，标记 hasValidScore=true，作为【实考人数】的基数。
    function parseRows(rows, defaultSchool) {
        const headers = rows[0].map(h => String(h).trim());
        
        // 1. 初始化索引映射
        const idxMap = { name: -1, id: -1, school: -1, class: -1, examRoom: -1, scores: {} };

        // 2. 别名匹配
        const aliasMap = {
            name: ['姓名', '学生姓名', '学生', 'Name', '考生姓名'],
            id: ['考号', '学号', '准考证号', 'ID', '考生号'],
            // school: 忽略表内学校列，强制使用Sheet名
            class: ['班级', '班', '班次', 'Class', '行政班'],
            examRoom: ['考场', '考室', 'Room', '考试地点']
        };
        
        // 增加容错：常见的学科名称
        const subjectMap = { '语文':'语文', '数学':'数学', '英语':'英语', '物理':'物理', '化学':'化学', '政治':'政治', '道法':'政治', '道德与法治':'政治', '历史':'历史', '地理':'地理', '生物':'生物', '科学':'科学' };
        const excludeKeywords = ['排', '次', '级', 'Rank', '赋分', '标准分', 'T分', '折算', '等级', '优劣'];

        // 3. 扫描表头
        headers.forEach((h, i) => {
            const hTrim = h.replace(/\s+/g, '');
            for (const [key, aliases] of Object.entries(aliasMap)) {
                if (aliases.some(alias => hTrim.includes(alias))) idxMap[key] = i;
            }
            for (const [key, standardName] of Object.entries(subjectMap)) {
                if(h.includes(key) && !excludeKeywords.some(ex => h.includes(ex))) {
                    if(!idxMap.scores[standardName]) idxMap.scores[standardName] = [];
                    idxMap.scores[standardName].push(i);
                    if(!SUBJECTS.includes(standardName)) SUBJECTS.push(standardName);
                }
            }
        });

        if(CONFIG.analysisSubs && CONFIG.analysisSubs !== 'auto') {
            SUBJECTS = SUBJECTS.filter(s => CONFIG.analysisSubs.includes(s));
        }
        const subsForTotal = CONFIG.totalSubs === 'auto' ? SUBJECTS : CONFIG.totalSubs;

        // 1. 全角转半角工具 (针对分数录入错误)
        const toHalfWidth = (str) => {
            if (typeof str !== 'string') return str;
            return str.replace(/[\uff01-\uff5e]/g, (ch) => String.fromCharCode(ch.charCodeAt(0) - 0xfee0))
                      .replace(/\u3000/g, ' ');
        };

        // 2. 姓名清洗工具 (去除空格、不可见字符)
        const cleanNameStr = (str) => {
            if (!str) return "";
            return String(str).replace(/\s+/g, '').replace(/[\u200b-\u200f\uFEFF]/g, '');
        };

        // 4. 遍历数据 (核心修改区)
        for(let i=1; i<rows.length; i++) {
            const r = rows[i]; 
            if(!r || !r.length) continue;

            // --- 修改点 A: 姓名处理 ---
            // 如果找不到姓名列，或者单元格为空，自动生成 "匿名考生_行号"
            let rawName = idxMap.name !== -1 ? (r[idxMap.name] || "") : "";
            let nameStr = cleanNameStr(rawName);

            if (!nameStr || nameStr === '-' || nameStr === '0' || nameStr === '0.0' || nameStr === '姓名') {
                nameStr = `考生${String(i).padStart(3, '0')}`;
            }

            // --- 修改点 B: 班级处理 ---
            // 如果找不到班级列，默认为 "未分班"
            let classStr = "未分班";
            if (idxMap.class !== -1 && r[idxMap.class]) {
                classStr = normalizeClass(r[idxMap.class]);
            }

            const stu = { 
                name: nameStr, 
                id: idxMap.id !== -1 ? r[idxMap.id] : '-', 
                
                // 强制使用Sheet名作为学校
                school: defaultSchool, 
                class: classStr, 
                
                examRoom: idxMap.examRoom !== -1 ? r[idxMap.examRoom] : '-', 
                scores: {}, 
                total: 0,
                hasValidScore: false 
            };
            
            // 数据读取逻辑
            let hasAnyScore = false;
            SUBJECTS.forEach(sub => {
                const colIndices = idxMap.scores[sub];
                if(colIndices && colIndices.length > 0) {
                    let subSum = 0;
                    let validSub = false;
                    colIndices.forEach(idx => {
                        let rawVal = r[idx];
                        // 如果是字符串，先尝试转半角
                        if (typeof rawVal === 'string') {
                            rawVal = toHalfWidth(rawVal).trim();
                        }
                        let val = parseFloat(rawVal);

                        // 如果解析结果不是数字，进行智能清洗
                        if (isNaN(val)) {
                            const strVal = String(rawVal || "").trim().toUpperCase(); // 转大写去空格
                            
                            // 定义由于特殊原因导致的“0分”关键词
                            // 缺考(ABS/Q/缺), 作弊(CHE/违纪), 病假(BJ), 缓考 等
                            const zeroKeywords = ["缺", "ABS", "作弊", "违纪", "病假", "缓考", "取消", "零分", "Q", "CHE"];
                            
                            // 如果包含上述关键词，强制视为 0 分 (参与排名)
                            if (zeroKeywords.some(key => strVal.includes(key))) {
                                val = 0;
                            } 
                            // 否则，该数据依然为 NaN，后续逻辑会自动“排除” (不参与均分计算)
                        }
                        if(!isNaN(val)) { subSum += val; validSub = true; }
                    });
                    if(validSub) {
                        stu.scores[sub] = parseFloat(subSum.toFixed(2));
                        stu.hasValidScore = true;
                        hasAnyScore = true;
                        if (subsForTotal.includes(sub)) stu.total += subSum;
                    }
                }
            });

            // 如果这一行完全没有成绩，并且名字也是自动生成的，大概率是空行，跳过
            if (!hasAnyScore && nameStr.startsWith("考生")) continue;

            stu.total = parseFloat(stu.total.toFixed(2));
            RAW_DATA.push(stu);
            
            if(!SCHOOLS[stu.school]) SCHOOLS[stu.school] = { name: stu.school, students: [], metrics: {}, rankings: {} };
            SCHOOLS[stu.school].students.push(stu);
        }
    }



    function normalizeClass(classStr) {
        if (!classStr) return '';
        let normalized = String(classStr).replace(/班/g, '').replace(/\s/g, '');
        if (normalized.includes('.')) return normalized;
        else if (/^\d+$/.test(normalized)) {
            const grade = String(getActiveGrade() || '6');
            return `${grade}.${normalized}`;
        } else if (/^[6789]\d+$/.test(normalized)) { const grade = normalized.charAt(0); const classNum = normalized.substring(1); return `${grade}.${classNum}`; }
        return classStr;
    }
    
    async function processData() {
        // 1. 预处理
        // 🟢 [修改开始]：引入单校模式判断与阈值计算优化
                
        // 重新构建临时的 SCHOOLS 键列表以检测数量
        const schoolSet = new Set(RAW_DATA.map(s => s.school));
        const isSingleSchool = schoolSet.size === 1;

        // 获取用户输入的指标参数 (用于单校模式下的精确划线)
        // 确保 window.SYS_VARS 已初始化
        const input1 = parseFloat(window.SYS_VARS?.indicator?.ind1) || 0;
        const input2 = parseFloat(window.SYS_VARS?.indicator?.ind2) || 0;

        const keys = [...SUBJECTS, 'total'];
        keys.forEach(k => {
            const vals = RAW_DATA.map(s => k==='total'?s.total:s.scores[k]).filter(v=>v!==undefined).sort((a,b)=>b-a);
            
            if(vals.length) {
                // 如果是单校模式，且是总分，且用户输入了有效的名次指标
                if (isSingleSchool && k === 'total' && input1 > 0 && input2 > 0) {
                    // 🏫 单校模式特殊逻辑：
                    // 使用用户输入的“年级名次”来反推分数线，这在单校月考中比百分比更稳定
                    const idx1 = Math.min(Math.floor(input1), vals.length) - 1;
                    const idx2 = Math.min(Math.floor(input2), vals.length) - 1;
                    
                    THRESHOLDS[k] = { 
                        exc: vals[Math.max(0, idx1)] || 0, 
                        pass: vals[Math.max(0, idx2)] || 0 
                    };
                    console.log(`[单校模式] 总分划线锁定: 优=${THRESHOLDS[k].exc} (Top${input1}), 良=${THRESHOLDS[k].pass} (Top${input2})`);
                } else {
                    // 🌍 多校联考模式 / 单科默认逻辑：按固定比例
                    // 9年级 15%，其他 20%
                    const excRatio = (CONFIG.name && CONFIG.name.includes('9')) ? 0.15 : 0.2;
                    // 单校模式下，如果没有手动指定，单科依然沿用百分比，但可以考虑后续增加单科手动设置
                    THRESHOLDS[k] = { 
                        exc: vals[Math.floor(vals.length * excRatio)] || 0, 
                        pass: vals[Math.floor(vals.length * 0.5)] || 0 
                    };
                }
            }
        });

        // 2. 呼叫 Worker
        const result = await WorkerAPI.run({ RAW_DATA, SUBJECTS, CONFIG, THRESHOLDS, SCHOOLS });
        
        // 3. 接收结果 (RAW_DATA 是全新的，带有排名的数组)
        RAW_DATA = result.RAW_DATA; 

        // 4. 【关键修复】重建 SCHOOLS 与新 RAW_DATA 的关联
        // Worker 返回了全新的 RAW_DATA，必须把这些新对象重新塞回 SCHOOLS 的 students 数组里
        // 否则 SCHOOLS 里存的还是旧对象(无排名)，导致"本校"查询失效
        
        // A. 先清空所有学校的学生列表
        Object.keys(SCHOOLS).forEach(k => { 
            if(SCHOOLS[k]) SCHOOLS[k].students = []; 
        });
        
        // B. 重新分配新学生对象
        RAW_DATA.forEach(stu => {
            if (!SCHOOLS[stu.school]) {
                // 防止有漏网之鱼
                SCHOOLS[stu.school] = { name: stu.school, students: [], metrics: {}, rankings: {} };
            }
            SCHOOLS[stu.school].students.push(stu);
        });

        // 5. 更新统计指标 (metrics)
        const newSchools = result.SCHOOLS;
        Object.keys(newSchools).forEach(k => {
            if (SCHOOLS[k]) {
                const { students, ...metricsData } = newSchools[k]; 
                // 只合并统计数据，不动刚才重新生成的 students 数组
                Object.assign(SCHOOLS[k], metricsData);
            }
        });

        // 6. 补全班级排名
        calculateClassRanksOnly(); 
    
        if (typeof fuseInstance !== 'undefined') fuseInstance = null; // 强制重建索引
    
        if (isSingleSchool) {
            console.log("🏫 检测到单校数据，自动切换 UI 为年级模式...");
            
            // 1. 隐藏横向对比入口 (自己跟自己没法比)
            const analysisMod = document.getElementById('analysis');
            if(analysisMod) analysisMod.style.display = 'none';

            // 2. 修改表头文字 (延迟执行确保 DOM 已渲染)
            // 将 "全镇"、"镇排" 替换为 "年级"、"级排"，消除歧义
            setTimeout(() => {
                document.querySelectorAll('th').forEach(th => {
                    if(th.innerText.includes('镇排')) th.innerHTML = th.innerHTML.replace('镇排', '级排');
                    if(th.innerText.includes('全镇')) th.innerHTML = th.innerHTML.replace('全镇', '年级');
                });
            }, 500);
        } else {
            const analysisMod = document.getElementById('analysis');
            if(analysisMod) analysisMod.style.display = 'block';
        }

        try {
            console.log("🔄 正在自动执行衍生计算...");
            
            // 1. 自动计算指标生 (依赖 RAW_DATA 和 TARGETS)
            // 即使没有设置划线，运行一下也不会报错，只是得分为0
            if (typeof calcIndicators === 'function' && isIndicatorCalcAllowed()) {
                calcIndicators(true); // 传入 true 表示静默模式(可选，视函数实现而定)
            }

            // 2. 自动计算综合总榜 (依赖前一步计算出的 scoreInd)
            if (typeof calcSummary === 'function') {
                calcSummary(true);    // 传入 true 表示静默模式
            }

        } catch (e) {
            console.warn("⚠️ 自动计算衍生指标时遇到非致命错误:", e);
        }

        // 7. 自动保存
        if(typeof DB !== 'undefined') {
            // ✋ 🔴 [修复开始]：不要写死 'autosave_backup'，而是获取当前选中的项目 KEY
            // 如果获取不到，才兜底使用 'autosave_backup'
            const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup';
            
            DB.save(currentKey, { 
                timestamp: Date.now(), 
                RAW_DATA, SCHOOLS, SUBJECTS, THRESHOLDS, TEACHER_MAP, CONFIG, MY_SCHOOL 
            });
            console.log(`✅ 数据已自动保存至: ${currentKey}`);
            // 👆 🟢 [修复结束]
        }
    }

    // 辅助：仅计算班级排名
    function calculateClassRanksOnly() {
        const classes = {}; 
        RAW_DATA.forEach(s => { if (!classes[s.class]) classes[s.class] = []; classes[s.class].push(s); });
        
        Object.values(classes).forEach(group => {
            // 总分
            group.sort((a,b)=>b.total - a.total);
            group.forEach((s,i) => { if(!s.ranks) s.ranks={}; if(!s.ranks.total) s.ranks.total={}; s.ranks.total.class = i+1; });
            // 单科
            SUBJECTS.forEach(sub => {
                const subGroup = group.filter(s => s.scores[sub] !== undefined).sort((a,b)=>b.scores[sub]-a.scores[sub]);
                subGroup.forEach((s,i) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].class = i+1; });
            });
        });
    }
    
    function calculateStudentRanks() {
        return;SUBJECTS.forEach(subject => {
            const subjectStudents = RAW_DATA.filter(s => s.scores[subject] !== undefined).sort((a, b) => b.scores[subject] - a.scores[subject]);
            subjectStudents.forEach((student, index) => {
                if (!student.ranks) student.ranks = {}; if (!student.ranks[subject]) student.ranks[subject] = {};
                if (index > 0 && student.scores[subject] === subjectStudents[index - 1].scores[subject]) student.ranks[subject].township = subjectStudents[index - 1].ranks[subject].township;
                else student.ranks[subject].township = index + 1;
            });
            Object.values(SCHOOLS).forEach(school => {
                const schStus = school.students.filter(s => s.scores[subject] !== undefined).sort((a,b) => b.scores[subject] - a.scores[subject]);
                schStus.forEach((s, i) => { if (!s.ranks[subject]) s.ranks[subject] = {}; if (i > 0 && s.scores[subject] === schStus[i - 1].scores[subject]) s.ranks[subject].school = schStus[i - 1].ranks[subject].school; else s.ranks[subject].school = i + 1; });
            });
            const classes = {}; RAW_DATA.forEach(student => { if (!classes[student.class]) classes[student.class] = []; classes[student.class].push(student); });
            Object.values(classes).forEach(classStudents => {
                const classSubjectStudents = classStudents.filter(s => s.scores[subject] !== undefined).sort((a, b) => b.scores[subject] - a.scores[subject]);
                classSubjectStudents.forEach((student, index) => { if (index > 0 && student.scores[subject] === classSubjectStudents[index - 1].scores[subject]) student.ranks[subject].class = classSubjectStudents[index - 1].ranks[subject].class; else student.ranks[subject].class = index + 1; });
            });
        });
        const totalStudents = RAW_DATA.filter(s => s.total !== undefined).sort((a, b) => b.total - a.total);
        totalStudents.forEach((student, index) => {
            if (!student.ranks) student.ranks = {}; if (!student.ranks.total) student.ranks.total = {};
            if (index > 0 && Math.abs(student.total - totalStudents[index - 1].total) < 0.0001) student.ranks.total.township = totalStudents[index - 1].ranks.total.township; else student.ranks.total.township = index + 1;
        });
         Object.values(SCHOOLS).forEach(school => {
            const schStus = school.students.sort((a,b) => b.total - a.total);
            schStus.forEach((s, i) => { if (i > 0 && Math.abs(s.total - schStus[i - 1].total) < 0.0001) s.ranks.total.school = schStus[i - 1].ranks.total.school; else s.ranks.total.school = i + 1; });
        });
        const classes = {}; RAW_DATA.forEach(student => { if (!classes[student.class]) classes[student.class] = []; classes[student.class].push(student); });
        Object.values(classes).forEach(classStudents => {
            const classTotalStudents = classStudents.sort((a, b) => b.total - a.total);
            classTotalStudents.forEach((student, index) => { if (index > 0 && Math.abs(student.total - classTotalStudents[index - 1].total) < 0.0001) student.ranks.total.class = classTotalStudents[index - 1].ranks.total.class; else student.ranks.total.class = index + 1; });
        });
    }

    function calculateRankings() {
        return;const doRank = (subject, key) => {
            const list = Object.values(SCHOOLS).filter(s => s.metrics[subject]);
            list.sort((a,b) => b.metrics[subject][key] - a.metrics[subject][key]);
            list.forEach((s, i) => {
                if(!s.rankings[subject]) s.rankings[subject] = {};
                if(i>0 && Math.abs(s.metrics[subject][key] - list[i-1].metrics[subject][key]) < 0.0001) s.rankings[subject][key] = list[i-1].rankings[subject][key]; else s.rankings[subject][key] = i + 1;
            });
        };
        [...SUBJECTS, 'total'].forEach(sub => { doRank(sub, 'avg'); doRank(sub, 'excRate'); doRank(sub, 'passRate'); });
        const max = { avg:0, exc:0, pass:0 };
        Object.values(SCHOOLS).forEach(s => { if(s.metrics.total) { max.avg = Math.max(max.avg, s.metrics.total.avg); max.exc = Math.max(max.exc, s.metrics.total.excRate); max.pass = Math.max(max.pass, s.metrics.total.passRate); } });
        Object.values(SCHOOLS).forEach(s => {
            if(s.metrics.total) {
                const m = s.metrics.total; const ratedAvg = max.avg > 0 ? (m.avg / max.avg * 60) : 0; const ratedExc = max.exc > 0 ? (m.excRate / max.exc * 70) : 0; const ratedPass = max.pass > 0 ? (m.passRate / max.pass * 70) : 0;
                m.ratedAvg = ratedAvg; m.ratedExc = ratedExc; m.ratedPass = ratedPass; s.score2Rate = ratedAvg + ratedExc + ratedPass;
            } else { s.score2Rate = 0; }
        });
        const list = Object.values(SCHOOLS); list.sort((a,b)=>b.score2Rate - a.score2Rate); list.forEach((s,i)=>s.rank2Rate = i+1);
        let maxBAvg = 0; list.forEach(s => maxBAvg = Math.max(maxBAvg, s.bottom3.avg));
        list.forEach(s => s.scoreBottom = maxBAvg ? (s.bottom3.avg/maxBAvg*40) : 0); list.sort((a,b)=>b.scoreBottom - a.scoreBottom).forEach((s,i)=>s.rankBottom = i+1);
    }

    function getRankHTML(rank, type = 'school') { let cls = 'rank-cell'; if(rank===1) cls += ' r-1'; if(rank===2) cls += ' r-2'; if(rank===3) cls += ' r-3'; return `<td class="${cls}">${rank}</td>`; }
    // 核心逻辑：如果是数字，保留2位小数展示；如果是无效值，显示 '-'
    // 注意：这只改变显示，不改变 underlying calculation (底层计算)
    function formatVal(val) {
        if (typeof val !== 'number' || isNaN(val)) return '-';
        // toFixed(2) 会四舍五入并转为字符串，如 89.567 -> "89.57", 90 -> "90.00"
        return val.toFixed(2);
    }
    function formatRankDisplay(value, rank, type = 'school', isPercent = false) { const displayValue = isPercent ? (value * 100).toFixed(2) + '%' : value.toFixed(2); return `${displayValue} <span style="font-size:0.9em; color:#94a3b8">(${rank})</span>`; }

    function renderTables() {
        const tbTotal = document.querySelector('#tb-total tbody'); 
        
        // --- 📊 新增：数据统计看板逻辑 开始 ---
        // 如果数据存在，且页面上有 KPI 容器 (我们可以动态插入一个)
        if(Object.keys(SCHOOLS).length > 0) {
            // 计算全镇数据
            const totalStudents = RAW_DATA.length;
            const totalSchools = Object.keys(SCHOOLS).length;
            const allScores = RAW_DATA.map(s => s.total);
            const globalAvg = (allScores.reduce((a,b)=>a+b,0) / totalStudents).toFixed(1);
            const maxScore = Math.max(...allScores);

            // 在看板模块中渲染KPI
            let dashboard = document.getElementById('macro-dashboard');
            if(!dashboard) {
                dashboard = document.createElement('div');
                dashboard.id = 'macro-dashboard';
                dashboard.className = 'fb-dashboard';
                dashboard.style.marginBottom = '25px';
                const watchSection = document.getElementById('macro-watch');
                if(watchSection) watchSection.appendChild(dashboard);
            }

            // 渲染卡片内容
            dashboard.innerHTML = `
                <div class="fb-card">
                    <div class="fb-lbl">参考总人数</div>
                    <div class="fb-val text-blue">${totalStudents}</div>
                    <div class="fb-lbl">覆盖 ${totalSchools} 所学校</div>
                </div>
                <div class="fb-card">
                    <div class="fb-lbl">全镇平均分</div>
                    <div class="fb-val text-green">${globalAvg}</div>
                    <div class="fb-lbl">总分基准线</div>
                </div>
                <div class="fb-card">
                    <div class="fb-lbl">最高分 (状元)</div>
                    <div class="fb-val text-orange">${maxScore}</div>
                    <div class="fb-lbl">分差 ${(maxScore - Math.min(...allScores))} 分</div>
                </div>
                <div class="fb-card">
                    <div class="fb-lbl">数据状态</div>
                    <div class="fb-val" style="font-size:18px; color:#64748b; margin-top:5px;">${CONFIG.name}</div>
                    <div class="fb-lbl">已剔除后 ${ (CONFIG.excRate*100) }%</div>
                </div>
            `;
        }
        // --- 📊 新增：数据统计看板逻辑 结束 ---

        const theadTotal = document.querySelector('#tb-total thead tr');
        
        // 1. 获取所有学校列表 (移除任何排序过滤，先拿原始数据)
        let list = Object.values(SCHOOLS);
        
        // --- 🔍 诊断代码开始 ---
        // 只有当点击“生成横向对比表”或页面加载时，如果学校数量少于预期(比如13)，可以在控制台看到
        console.log(`系统共识别到 ${list.length} 所学校：`, list.map(s => s.name));
        
        // 在表头显示醒目的数量
        const countInfo = `<span style="background:#ef4444; color:white; padding:2px 6px; border-radius:4px; font-size:11px;">共识别 ${list.length} 所</span>`;
        // --- 🔍 诊断代码结束 ---

        theadTotal.innerHTML = `
            <th>学校名称 ${countInfo}</th><th>实考人数</th><th>平均分</th><th>优秀率</th><th>及格率</th>
            <th>平均分赋分</th><th>优秀率赋分</th><th>及格率赋分</th>
            <th>两率一分总分</th><th>排名</th>
        `;
        
        // 2. 排序
        list.sort((a,b) => (a.rank2Rate || 9999) - (b.rank2Rate || 9999));
        
        // 3. 渲染
        let html = '';
        list.forEach(s => {
            const m = s.metrics.total || {}; 
            const rA = m.ratedAvg || 0; 
            const rE = m.ratedExc || 0; 
            const rP = m.ratedPass || 0; 
            const isMySchool = s.name === MY_SCHOOL;
            
            // 计算数据条百分比 (假设满分按全镇最高均分算，或者固定值如100/120)
            const maxAvg = list[0].metrics.total?.avg || 100; // 取第一名均分作为基准
            const barPercent = m.avg ? (m.avg / maxAvg * 100).toFixed(1) : 0;

            html += `<tr class="${isMySchool?'bg-highlight':''}">
                <td data-label="学校" class="clickable-school" onclick="showSchoolProfile('${s.name}')" title="点击查看学校学科诊断">
                    ${s.name} <i class="ti ti-chart-radar" style="font-size:12px; opacity:0.5;"></i>
                </td>
                <td data-label="人数">${m.count||0}</td>
                
                <!-- 注入样式变量 --percent -->
                <td data-label="平均分" class="data-bar-bg" style="--percent: ${barPercent}%">
                    ${formatRankDisplay(m.avg||0, s.rankings.total?.avg || 0)}
                </td>
                
                <td data-label="优秀率">${formatRankDisplay(m.excRate||0, s.rankings.total?.excRate || 0, 'school', true)}</td>
                <td data-label="及格率">${formatRankDisplay(m.passRate||0, s.rankings.total?.passRate || 0, 'school', true)}</td>
                <td data-label="均分赋分">${rA.toFixed(2)}</td>
                <td data-label="优率赋分">${rE.toFixed(2)}</td>
                <td data-label="及格赋分">${rP.toFixed(2)}</td>
                <td data-label="总分" class="text-red" style="font-size:1.1em; font-weight:bold;">${(s.score2Rate||0).toFixed(2)}</td>
                ${getRankHTML(s.rank2Rate)}
            </tr>`;
        });
        tbTotal.innerHTML = html;

        // ... (下接各科渲染逻辑，保持不变) ...
        const subContainer = document.getElementById('subject-tables-container');         const sideNavSubjects = document.getElementById('side-nav-subjects-container'); 
        subContainer.innerHTML = ''; 
        sideNavSubjects.innerHTML = '';
        
        SUBJECTS.forEach(sub => {
            const thresh = THRESHOLDS[sub]; 
            const box = document.createElement('div'); 
            const anchorId = `anchor-subject-${sub}`; 
            box.id = anchorId; 
            box.className = 'anchor-target'; 
            box.style.paddingTop = '20px';
            box.innerHTML = `<div class="sub-header"><span>📘 ${sub}</span><span style="font-weight:normal; font-size:12px; opacity:0.8;">优秀线≥${(thresh?.exc || 0).toFixed(1)}, 及格线≥${(thresh?.pass || 0).toFixed(1)}</span></div><div class="table-wrap"><table><thead><tr><th>学校名称</th><th>实考人数</th><th>平均分</th><th>优秀率</th><th>及格率</th></tr></thead><tbody></tbody></table></div>`;
            const tbody = box.querySelector('tbody'); 
            const subList = Object.values(SCHOOLS).filter(s=>s.metrics[sub]).sort((a,b)=>(a.rankings[sub].avg - b.rankings[sub].avg)); 
            let htmlSub = '';
            subList.forEach(s => { const m = s.metrics[sub]; const r = s.rankings[sub]; const isMySchool = s.name === MY_SCHOOL; htmlSub += `<tr class="${isMySchool?'bg-highlight':''}"><td>${s.name}</td><td>${m.count}</td><td>${formatRankDisplay(m.avg, r.avg)}</td><td>${formatRankDisplay(m.excRate, r.excRate, 'school', true)}</td><td>${formatRankDisplay(m.passRate, r.passRate, 'school', true)}</td></tr>`; });
            tbody.innerHTML = htmlSub; subContainer.appendChild(box); const navLink = document.createElement('a'); navLink.className = 'side-nav-sub-link'; navLink.innerText = sub; navLink.onclick = () => scrollToSubAnchor(anchorId, navLink); sideNavSubjects.appendChild(navLink);
        });

        const tbBottom = document.querySelector('#tb-bottom3 tbody'); let htmlBottom = ''; 
        let bottomList = Object.values(SCHOOLS).sort((a,b)=> (a.rankBottom || 9999) - (b.rankBottom || 9999));
        bottomList.forEach(s => { 
            const isMySchool = s.name === MY_SCHOOL; 
            htmlBottom += `
            <tr class="${isMySchool?'bg-highlight':''}">
                <td>${s.name}</td>
                <td>${s.bottom3.totalN}</td>
                <td>${s.bottom3.bottomN}</td>
                <td>
                    <span class="clickable-num" onclick="handleExcludedClick('${s.name}')" title="点击查看被剔除的低分学生">
                        ${s.bottom3.excN}
                    </span>
                </td>
                <td>${s.bottom3.avg.toFixed(2)}</td>
                <td class="text-red">${s.scoreBottom.toFixed(2)}</td>
                ${getRankHTML(s.rankBottom)}
            </tr>`; 
        });
        tbBottom.innerHTML = htmlBottom;
        renderTrafficLightDashboard();
    }

    function renderTrafficLightDashboard() {
        const container = document.getElementById('traffic-light-dashboard');
        const listRed = document.getElementById('list-red');
        const listYellow = document.getElementById('list-yellow');
        const listGreen = document.getElementById('list-green');
        
        if(Object.keys(SCHOOLS).length === 0) {
            container.classList.add('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        listRed.innerHTML = ''; listYellow.innerHTML = ''; listGreen.innerHTML = '';
        
        let cntRed = 0, cntYellow = 0, cntGreen = 0;

        // 遍历所有学校和所有科目进行“体检”
        Object.values(SCHOOLS).forEach(s => {
            [...SUBJECTS, 'total'].forEach(sub => {
                const m = s.metrics[sub];
                if(!m) return;
                
                const subName = sub === 'total' ? CONFIG.label : sub;
                const excP = m.excRate * 100;
                const passP = m.passRate * 100;
                const rank = s.rankings[sub]?.avg || 999;
                const totalSchools = Object.keys(SCHOOLS).length;

                // 1. 🔴 红色预警条件：及格率 < 60% 或 排名垫底
                if (passP < 60 || rank === totalSchools) {
                    const reason = passP < 60 ? `及格率过低 (${passP.toFixed(1)}%)` : `全镇排名倒数第一`;
                    const html = `
                        <div class="traffic-item" onclick="jumpToDetail('${s.name}', '${sub}')">
                            <div class="t-school">${s.name} <span class="t-badge bg-red-light">${subName}</span></div>
                            <div class="t-sub">
                                <span>${reason}</span>
                                <span style="font-weight:bold;">📉 Avg: ${m.avg.toFixed(1)}</span>
                            </div>
                        </div>`;
                    listRed.innerHTML += html;
                    cntRed++;
                }
                // 2. 🟢 绿色标杆条件：优秀率 > 30% 或 排名第一
                else if (excP > 30 || rank === 1) {
                    const reason = rank === 1 ? `全镇排名第一` : `优秀率突出 (${excP.toFixed(1)}%)`;
                    const html = `
                        <div class="traffic-item" onclick="jumpToDetail('${s.name}', '${sub}')">
                            <div class="t-school">${s.name} <span class="t-badge bg-green-light">${subName}</span></div>
                            <div class="t-sub">
                                <span>${reason}</span>
                                <span style="font-weight:bold;">🏆 No.${rank}</span>
                            </div>
                        </div>`;
                    listGreen.innerHTML += html;
                    cntGreen++;
                }
                // 3. 🟡 黄色关注条件：优秀率 < 15% (即缺乏尖子生) 且没被归入红灯
                else if (excP < 15) {
                    const html = `
                        <div class="traffic-item" onclick="jumpToDetail('${s.name}', '${sub}')">
                            <div class="t-school">${s.name} <span class="t-badge bg-yellow-light">${subName}</span></div>
                            <div class="t-sub">
                                <span>尖子生匮乏 (优率${excP.toFixed(1)}%)</span>
                                <span>排: ${rank}</span>
                            </div>
                        </div>`;
                    listYellow.innerHTML += html;
                    cntYellow++;
                }
            });
        });

        // 更新计数徽章
        document.getElementById('count-red').innerText = cntRed;
        document.getElementById('count-yellow').innerText = cntYellow;
        document.getElementById('count-green').innerText = cntGreen;
        
        // 空状态处理
        if(cntRed===0) listRed.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">🎉 平安无事，暂无严重警告</div>';
        if(cntYellow===0) listYellow.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">无风险预警</div>';
        if(cntGreen===0) listGreen.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">暂无突出标杆，继续加油</div>';
    }

    // 辅助跳转函数：点击卡片定位到对应表格
    function jumpToDetail(school, subject) {
        // 如果是总分，跳到总表
        if (subject === 'total') {
            document.getElementById('anchor-total').scrollIntoView({behavior: "smooth", block: "center"});
        } else {
            // 如果是单科，跳到单科表
            const anchor = document.getElementById(`anchor-subject-${subject}`);
            if(anchor) {
                // 展开侧边栏（如果有的话）
                const navLink = document.querySelector(`.side-nav-sub-link[onclick*="${subject}"]`);
                if(navLink) {
                    // 模拟点击展开父级菜单
                    const parent = navLink.closest('.side-nav-sub-container');
                    if(parent) parent.classList.add('show');
                }
                anchor.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
        
        // 高亮行闪烁效果
        setTimeout(() => {
            // 简单查找包含学校名的行（不仅限于精确匹配，为了简化）
            // 实际应用中可能需要更精确的ID定位，但这里通过文字匹配即可
            // 提示用户
            UI.toast(`已定位到：${school} - ${subject}`, 'info');
        }, 500);
    }

    // ================= 教师配置与分析 =================
    function updateSchoolSelect() {
        const sel = document.getElementById('sel-school');
        sel.innerHTML = '<option>--请选择学校--</option>';
        Object.keys(SCHOOLS).forEach(n => sel.innerHTML += `<option>${n}</option>`);
        sel.addEventListener('change', updateClassSelect);
    }

    function updateMySchoolSelect() {
        // 🟢 1. 【核心修复】无条件优先刷新管理员面板的学校列表
        // 无论界面上有没有 "mySchoolSelect" 下拉框，只要数据处理完了，就必须通知账号管理器
        if(typeof Auth !== 'undefined') {
            Auth.renderSchoolCheckboxes();
        }

        // 🟢 2. 然后再处理下拉框逻辑 (如果 ID 存在的话)
        const select = document.getElementById('mySchoolSelect');
    
        // 如果找不到下拉框，仅仅停止处理下拉框，不要影响上面的账号列表刷新
        if (!select) return; 
        
        // 下面是原有的下拉框填充逻辑
        select.innerHTML = '<option value="">--请选择本校--</option>';
        Object.keys(SCHOOLS).forEach(school => { 
            select.innerHTML += `<option value="${school}">${school}</option>`; 
        });
        
        // 当学校数据更新时，顺便刷新管理员面板里的“学校复选框列表” (此处旧代码已在上面第一步执行了，这里不需要重复)
        
        select.addEventListener('change', function() { 
            MY_SCHOOL = this.value; 
            if (MY_SCHOOL) generateTeacherInputs(); 
            renderTables(); 
        });
    }

    function updateClassSelect() {
        const schoolSelect = document.getElementById('sel-school'); const classSelect = document.getElementById('sel-class');
        classSelect.innerHTML = '<option>--请先选择学校--</option>';
        if (schoolSelect.value && SCHOOLS[schoolSelect.value]) { const classes = [...new Set(SCHOOLS[schoolSelect.value].students.map(s => s.class))].sort(); classes.forEach(cls => classSelect.innerHTML += `<option>${cls}</option>`); }
    }

    function updateStudentSchoolSelect() {
        const select = document.getElementById('studentSchoolSelect'); 
        const classSelect = document.getElementById('studentClassSelect');
        select.innerHTML = '<option value="">--请选择本校--</option>'; 
        classSelect.innerHTML = '<option value="">全部班级</option>';
        
        Object.keys(SCHOOLS).forEach(school => { select.innerHTML += `<option value="${school}">${school}</option>`; });
        
        select.addEventListener('change', function() { 
            const selectedSchool = this.value; 
            classSelect.innerHTML = '<option value="">全部班级</option>'; 
            if(selectedSchool && SCHOOLS[selectedSchool]) { 
                const classes = [...new Set(SCHOOLS[selectedSchool].students.map(s => s.class))].sort(); 
                classes.forEach(c => classSelect.innerHTML += `<option value="${c}">${c}</option>`); 
            }
            // ✋ 性能优化关键：切换学校时，重置分页并立即渲染
            renderStudentDetails(true); 
        });

        // 🟢 新增：班级切换也触发重置
        classSelect.addEventListener('change', function() {
            renderStudentDetails(true);
        });
    }
    
    function updateMarginalSchoolSelect() {
        const select = document.getElementById('marginalSchoolSelect');
        select.innerHTML = '<option value="">--请选择本校--</option>';
        Object.keys(SCHOOLS).forEach(school => select.innerHTML += `<option value="${school}">${school}</option>`);
    }

    function generateTeacherInputs() {
        if (!MY_SCHOOL) { alert('请先选择本校'); return; }
        const container = document.getElementById('teacherInputsContainer'); container.innerHTML = '';
        const mySchoolData = SCHOOLS[MY_SCHOOL]; if (!mySchoolData) return;
        const classes = [...new Set(mySchoolData.students.map(s => s.class))].sort((a, b) => { const [gradeA, classA] = a.split('.').map(Number); const [gradeB, classB] = b.split('.').map(Number); if (gradeA !== gradeB) return gradeA - gradeB; return classA - classB; });
        classes.forEach(cls => {
            SUBJECTS.forEach(sub => { const key = `${cls}_${sub}`; const currentTeacher = TEACHER_MAP[key] || ''; const inputDiv = document.createElement('div'); inputDiv.innerHTML = `<label style="font-size:12px;color:#666;">${cls}班 ${sub}</label><input type="text" class="teacher-input" data-key="${key}" value="${currentTeacher}" placeholder="姓名" style="width:100%;margin-top:2px;">`; container.appendChild(inputDiv); });
        });
        container.querySelectorAll('.teacher-input').forEach(input => { input.addEventListener('input', function() { const key = this.dataset.key; const value = this.value.trim(); if (value) TEACHER_MAP[key] = value; else delete TEACHER_MAP[key];             // 防抖保存：输入停止 1 秒后保存，避免频繁写入
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup';
                
                DB.save(currentKey, {
                    timestamp: Date.now(),
                    RAW_DATA: RAW_DATA,
                    SCHOOLS: SCHOOLS,
                    SUBJECTS: SUBJECTS,
                    THRESHOLDS: THRESHOLDS,
                    TEACHER_MAP: TEACHER_MAP, // 重点保存这个
                    TEACHER_STATS: TEACHER_STATS,
                    FB_CLASSES: FB_CLASSES,
                    CONFIG: CONFIG,
                    MY_SCHOOL: MY_SCHOOL
                });
            }, 1000);}); });
    }

    function importTeacherExcel() {
        if (isArchiveLocked()) return alert("⛔ 当前考试已封存，禁止导入任课表");
        const fileInput = document.getElementById('teacherFileInput');
        if (!fileInput.files.length) { alert('请选择教师信息Excel文件'); return; }
        const file = fileInput.files[0]; const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                jsonData.forEach(row => { const className = normalizeClass(row['班级'] || row['class']); const subject = row['学科'] || row['subject']; const teacher = row['教师'] || row['teacher'] || row['教师姓名']; if (className && subject && teacher) TEACHER_MAP[`${className}_${subject}`] = teacher; });
                generateTeacherInputs(); 
                saveCloudData().then(() => {
                    if(window.UI) UI.toast("✅ 教师数据已同步至云端", "success");
                });
alert(`成功导入 ${Object.keys(TEACHER_MAP).length} 条教师信息`);
            } catch (error) { alert('导入失败：' + error.message); }
        };
        reader.readAsArrayBuffer(file);
    }

    // [核心修改] 教师四维评价计算逻辑 (含贡献值、增值、低分率)
    function analyzeTeachers() {
        if (!MY_SCHOOL) { alert('请先选择本校'); return; }
        TEACHER_STATS = {}; 
        const mySchoolData = SCHOOLS[MY_SCHOOL]; 
        if (!mySchoolData) return;

        // 1. 预计算年级基准
        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const scores = mySchoolData.students.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            if (scores.length > 0) {
                const sum = scores.reduce((a,b)=>a+b, 0);
                const avg = sum / scores.length;
                const variance = scores.reduce((a,b) => a + Math.pow(b - avg, 2), 0) / scores.length;
                
                gradeStats[sub] = {
                    avg: avg,
                    sd: Math.sqrt(variance),
                    exc: THRESHOLDS[sub]?.exc || 0,
                    pass: THRESHOLDS[sub]?.pass || 0,
                    low: (THRESHOLDS[sub]?.pass || 60) * 0.6 
                };
            }
        });

        // 2. 归集教师数据
        Object.entries(TEACHER_MAP).forEach(([key, teacherName]) => {
            const [className, subject] = key.split('_'); 
            if(!SUBJECTS.includes(subject)) return;
            
            if (!TEACHER_STATS[teacherName]) TEACHER_STATS[teacherName] = {}; 
            if (!TEACHER_STATS[teacherName][subject]) { 
                TEACHER_STATS[teacherName][subject] = { 
                    classes: [], students: []
                }; 
            }
            
            const teacherStudents = mySchoolData.students.filter(s => s.class === className && s.scores[subject] !== undefined);
            TEACHER_STATS[teacherName][subject].classes.push(className); 
            TEACHER_STATS[teacherName][subject].students.push(...teacherStudents);
        });

        // 3. 计算多维指标 (已移除增值项)
        Object.keys(TEACHER_STATS).forEach(teacher => {
            Object.keys(TEACHER_STATS[teacher]).forEach(subject => {
                const data = TEACHER_STATS[teacher][subject]; 
                const students = data.students;
                const gs = gradeStats[subject] || { avg:0, low:0 };

                if (students.length > 0) {
                    // 基础指标
                    data.totalScore = students.reduce((sum, s) => sum + s.scores[subject], 0); 
                    data.avg = (data.totalScore / students.length).toFixed(2);
                    data.studentCount = students.length;
                    data.classes = [...new Set(data.classes)].sort().join(',');

                    // 三率
                    data.excellentCount = students.filter(s => s.scores[subject] >= gs.exc).length; 
                    data.passCount = students.filter(s => s.scores[subject] >= gs.pass).length;
                    data.lowCount = students.filter(s => s.scores[subject] < gs.low).length;

                    data.excellentRate = (data.excellentCount / students.length); 
                    data.passRate = (data.passCount / students.length); 
                    data.lowRate = (data.lowCount / students.length);

                    // 贡献值
                    data.contribution = (parseFloat(data.avg) - gs.avg).toFixed(2);

                    // ★ 综合绩效分 (移除增值分，提高优良率权重)
                    // 新算法：基准30 + 贡献值 + 优率(30) + 及格(30) - 低分惩罚
                    let score = 30; 
                    score += parseFloat(data.contribution); 
                    score += (data.excellentRate * 30); // 权重由25提至30
                    score += (data.passRate * 30);      // 权重由25提至30
                    score -= (data.lowRate * 20); 

                    data.finalScore = score.toFixed(1);

                } else { 
                    Object.assign(data, { 
                        avg: "0.00", excellentRate: 0, passRate: 0, lowRate: 0, 
                        contribution: 0, finalScore: 0, classes: "无成绩" 
                    });
                }
            });
        });
        
        calculateTeacherTownshipRanking(); 
        renderTeacherCards(); 
        renderTeacherComparisonTable(); 
        generateTeacherPairing(); 
    }

    function generateTeacherPairing() {
        const container = document.getElementById('teacher-pairing-suggestions'); container.innerHTML = '';
        if(!MY_SCHOOL || !SCHOOLS[MY_SCHOOL]) return;
        const schoolMetrics = SCHOOLS[MY_SCHOOL].metrics; let pairs = [];
        SUBJECTS.forEach(sub => {
            const baseline = schoolMetrics[sub]; if(!baseline) return;
            const teachers = []; Object.keys(TEACHER_STATS).forEach(tName => { if(TEACHER_STATS[tName][sub]) { teachers.push({name: tName, data: TEACHER_STATS[tName][sub]}); } });
            if(teachers.length < 2) return;
            const typeA = teachers.filter(t => t.data.passRate > baseline.passRate && t.data.excellentRate < baseline.excRate);
            const typeB = teachers.filter(t => t.data.excellentRate > baseline.excRate && t.data.passRate < baseline.passRate);
            typeA.forEach(a => { typeB.forEach(b => { const id = [a.name, b.name].sort().join('-'); if(!pairs.find(p => p.id === id + sub)) { pairs.push({ id: id + sub, subject: sub, teacher1: a, teacher2: b }); } }); });
        });
        if(pairs.length === 0) { container.innerHTML = '<div style="text-align:center; color:#999; grid-column:1/-1;">暂无明显的互补型结对建议，说明各位老师发展较为均衡或差异不大。</div>'; return; }
        pairs.forEach(p => {
            const card = document.createElement('div'); card.className = 'pairing-card';
            card.innerHTML = `<div class="pairing-side"><div class="pairing-role">基础扎实型</div><div class="pairing-name">${p.teacher1.name}</div><div class="pairing-skill">✅ 及格率高 (${(p.teacher1.data.passRate*100).toFixed(1)}%)</div><div class="pairing-need">🔻 需提升优秀率</div></div><div class="pairing-arrow"><div style="text-align:center;"><i class="ti ti-arrows-left-right"></i><div class="pairing-tag">${p.subject}</div></div></div><div class="pairing-side" style="text-align:right;"><div class="pairing-role">培优拔尖型</div><div class="pairing-name">${p.teacher2.name}</div><div class="pairing-skill">✅ 优秀率高 (${(p.teacher2.data.excellentRate*100).toFixed(1)}%)</div><div class="pairing-need">🔻 需提升及格率</div></div>`; container.appendChild(card);
        });
    }

    function calculateTeacherTownshipRanking() {
        TEACHER_TOWNSHIP_RANKINGS = {}; TOWNSHIP_RANKING_DATA = {}; 
        SUBJECTS.forEach(subject => {
            let rankingData = [];
            Object.keys(TEACHER_STATS).forEach(teacher => {
                if (TEACHER_STATS[teacher][subject]) { const data = TEACHER_STATS[teacher][subject]; rankingData.push({ name: teacher, type: 'teacher', subject: subject, avg: parseFloat(data.avg) || 0, excellentRate: data.excellentRate || 0, passRate: data.passRate || 0, studentCount: data.studentCount }); }
            });
            Object.keys(SCHOOLS).forEach(school => {
                if (school !== MY_SCHOOL && SCHOOLS[school].metrics[subject]) { const metrics = SCHOOLS[school].metrics[subject]; rankingData.push({ name: school, type: 'school', subject: subject, avg: parseFloat(metrics.avg) || 0, excellentRate: metrics.excRate || 0, passRate: metrics.passRate || 0, studentCount: metrics.count }); }
            });
            rankingData.sort((a, b) => b.avg - a.avg); rankingData.forEach((item, index) => item.rankAvg = index + 1);
            rankingData.sort((a, b) => b.excellentRate - a.excellentRate); rankingData.forEach((item, index) => item.rankExc = index + 1);
            rankingData.sort((a, b) => b.passRate - a.passRate); rankingData.forEach((item, index) => item.rankPass = index + 1);
            rankingData.sort((a, b) => b.avg - a.avg);
            rankingData.forEach(item => { if (item.type === 'teacher') { if (!TEACHER_TOWNSHIP_RANKINGS[item.name]) TEACHER_TOWNSHIP_RANKINGS[item.name] = {}; TEACHER_TOWNSHIP_RANKINGS[item.name][subject] = { avg: item.avg, rankAvg: item.rankAvg, excellentRate: item.excellentRate, rankExc: item.rankExc, passRate: item.passRate, rankPass: item.rankPass, rank: item.rankAvg }; } });
            TOWNSHIP_RANKING_DATA[subject] = rankingData;
        });
    }

    function renderTeacherCards() {
        // 以前这里需要写几十行 HTML 拼接逻辑，现在只需要一行：
        // 把全局数据同步到 Alpine Store，界面会自动变！
        Alpine.store('teacherData').update(TEACHER_STATS, TEACHER_TOWNSHIP_RANKINGS);
    }

    function calculatePerformanceLevel(teacherData) {
        const avg = parseFloat(teacherData.avg), excellentRate = teacherData.excellentRate * 100, passRate = teacherData.passRate * 100;
        if (avg >= 85 && excellentRate >= 30 && passRate >= 90) return { class: 'performance-excellent', text: '优秀' };
        else if (avg >= 80 && excellentRate >= 25 && passRate >= 85) return { class: 'performance-good', text: '良好' };
        else if (avg >= 75 && excellentRate >= 20 && passRate >= 80) return { class: 'performance-average', text: '中等' };
        else return { class: 'performance-poor', text: '需改进' };
    }

   // [修改] 渲染教师详细对比表 (增加贡献值、增值、低分率等列)
    function renderTeacherComparisonTable() {
        const container = document.getElementById('teacherComparisonTable');
        if (Object.keys(TEACHER_STATS).length === 0) { 
            container.innerHTML = '<p style="text-align: center; color: #666;">暂无教师统计数据</p>'; return; 
        }

        // 1. 准备数据
        const subjectTeachers = {};
        Object.keys(TEACHER_STATS).forEach(teacher => {
            Object.keys(TEACHER_STATS[teacher]).forEach(subject => {
                if (!subjectTeachers[subject]) subjectTeachers[subject] = [];
                subjectTeachers[subject].push({ 
                    teacher, 
                    data: TEACHER_STATS[teacher][subject] 
                });
            });
        });

        // 2. 构建 HTML (已移除增值列)
        let tableHtml = `
        <thead>
            <tr>
                <th rowspan="2">教师</th>
                <th rowspan="2">班级</th>
                <th rowspan="2">人数</th>
                <th colspan="2" style="background:#e0f2fe; color:#0369a1;">教学实绩</th>
                <th colspan="3" style="background:#dcfce7; color:#166534;">三率指标</th>
                <th style="background:#fef9c3; color:#b45309;">考核</th>
            </tr>
            <tr>
                <th>均分</th>
                <th>贡献值</th>
                <th>优秀率</th>
                <th>及格率</th>
                <th>低分率</th>
                <th title="综合绩效分">绩效分</th>
            </tr>
        </thead>
        <tbody>`;

        const existingSubjects = Object.keys(subjectTeachers).sort(sortSubjects);
        
        existingSubjects.forEach(subject => {
            tableHtml += `<tr style="background:#f1f5f9; font-weight:bold; color:#64748b;"><td colspan="9" style="text-align:left; padding-left:15px;">📘 ${subject}</td></tr>`;
            const arr = subjectTeachers[subject].sort((a,b) => b.data.finalScore - a.data.finalScore);

            arr.forEach((item, idx) => {
                const d = item.data;
                const contribClass = d.contribution >= 0 ? 'text-green' : 'text-red';
                const contribSign = d.contribution >= 0 ? '+' : '';
                const lowStyle = d.lowRate > 0.1 ? 'color:red; font-weight:bold;' : 'color:#333;';

                tableHtml += `
                <tr>
                    <td><strong>${item.teacher}</strong></td>
                    <td>${d.classes}</td>
                    <td>${d.studentCount}</td>
                    
                    <td style="font-weight:bold;">${d.avg}</td>
                    <td class="${contribClass}" style="font-weight:bold;">${contribSign}${d.contribution}</td>
                    
                    <td>${(d.excellentRate * 100).toFixed(1)}%</td>
                    <td>${(d.passRate * 100).toFixed(1)}%</td>
                    <td style="${lowStyle}">${(d.lowRate * 100).toFixed(1)}%</td>
                    
                    <td style="background:#fffbeb; font-weight:bold; color:#b45309; font-size:1.1em;">${d.finalScore}</td>
                </tr>`;
            });
        });

        tableHtml += `</tbody>`;
        container.innerHTML = `<table class="comparison-table">${tableHtml}</table>`;
    }


    function renderTeacherTownshipRanking() {
        const container = document.getElementById('teacher-township-ranking-container');
        const sideNavTeacherRanks = document.getElementById('side-nav-teacher-ranks-container'); sideNavTeacherRanks.innerHTML = '';
        if (!TOWNSHIP_RANKING_DATA || Object.keys(TOWNSHIP_RANKING_DATA).length === 0) { container.innerHTML = '<p style="text-align: center; color: #666;">暂无教师乡镇排名数据</p>'; return; }
        const townshipAverages = {};
        SUBJECTS.forEach(subject => {
            let totalAvg = 0, totalExc = 0, totalPass = 0, count = 0;
            Object.keys(SCHOOLS).forEach(school => { if (school !== MY_SCHOOL && SCHOOLS[school].metrics[subject]) { const metrics = SCHOOLS[school].metrics[subject]; totalAvg += metrics.avg; totalExc += metrics.excRate; totalPass += metrics.passRate; count++; } });
            if (count > 0) townshipAverages[subject] = { avg: totalAvg / count, excRate: totalExc / count, passRate: totalPass / count };
        });
        let htmlAll = '';
        SUBJECTS.forEach(subject => {
            const rankingData = TOWNSHIP_RANKING_DATA[subject]; if (!rankingData || rankingData.length === 0) return;
            const townshipAvg = townshipAverages[subject] || { avg: 0, excRate: 0, passRate: 0 }; let tbodyHtml = '';
            rankingData.forEach((item) => {
                const avgComparison = townshipAvg.avg ? ((item.avg - townshipAvg.avg) / townshipAvg.avg * 100).toFixed(2) : 0; const excComparison = townshipAvg.excRate ? ((item.excellentRate - townshipAvg.excRate) / townshipAvg.excRate * 100).toFixed(2) : 0; const passComparison = townshipAvg.passRate ? ((item.passRate - townshipAvg.passRate) / townshipAvg.passRate * 100).toFixed(2) : 0; const typeClass = item.type === 'teacher' ? 'text-blue' : ''; const typeText = item.type === 'teacher' ? '教师' : '学校';
                tbodyHtml += `<tr><td class="${typeClass}">${item.name}</td><td>${typeText}</td><td>${formatRankDisplay(item.avg, item.rankAvg, 'teacher')}</td><td class="${avgComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${avgComparison >= 0 ? '+' : ''}${avgComparison}%</td><td>${item.rankAvg}</td><td>${formatRankDisplay(item.excellentRate, item.rankExc, 'teacher', true)}</td><td class="${excComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${excComparison >= 0 ? '+' : ''}${excComparison}%</td><td>${item.rankExc}</td><td>${formatRankDisplay(item.passRate, item.rankPass, 'teacher', true)}</td><td class="${passComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${passComparison >= 0 ? '+' : ''}${passComparison}%</td><td>${item.rankPass}</td></tr>`;
            });
            const anchorId = `rank-anchor-${subject}`; htmlAll += `<div id="${anchorId}" class="anchor-target" style="padding-top:20px;"><div class="sub-header">🏅 ${subject} 教师乡镇排名 <span style="font-size:12px; font-weight:normal; margin-left:10px;">(含外校整体数据)</span></div><div class="table-wrap"><table class="comparison-table"><thead><tr><th>教师/学校</th><th>类型</th><th>平均分</th><th>与镇均比</th><th>镇排</th><th>优秀率</th><th>与镇均比</th><th>镇排</th><th>及格率</th><th>与镇均比</th><th>镇排</th></tr></thead><tbody>${tbodyHtml}</tbody></table></div></div>`;
            const navLink = document.createElement('a'); navLink.className = 'side-nav-sub-link'; navLink.innerText = subject; navLink.onclick = () => scrollToSubAnchor(anchorId, navLink); sideNavTeacherRanks.appendChild(navLink);
        });
        container.innerHTML = htmlAll;
    }

    function showTeacherDetails(teacher, subject) {
        const data = TEACHER_STATS[teacher][subject]; if (!data) return;
        document.getElementById('modalTeacherName').textContent = `${teacher} - ${subject} 教学详情`;
        document.getElementById('modalAvgScore').textContent = data.avg; document.getElementById('modalExcellentRate').textContent = (data.excellentRate * 100).toFixed(2) + '%'; document.getElementById('modalPassRate').textContent = (data.passRate * 100).toFixed(2) + '%';
        const subjectAvg = THRESHOLDS[subject] ? (THRESHOLDS[subject].exc + THRESHOLDS[subject].pass) / 2 : 0; const avgComparison = subjectAvg ? ((parseFloat(data.avg) - subjectAvg) / subjectAvg * 100).toFixed(1) : 0;
        document.getElementById('modalAvgComparison').textContent = (avgComparison >= 0 ? '+' : '') + avgComparison + '%';
        const avgProgress = Math.min(Math.max(50 + (avgComparison / 2), 0), 100);
        document.getElementById('modalAvgProgress').style.width = avgProgress + '%'; document.getElementById('modalAvgProgress').className = avgComparison >= 0 ? 'progress-good' : 'progress-poor'; document.getElementById('modalAvgProgress').style.backgroundColor = avgComparison >= 0 ? '#22c55e' : '#ef4444';
        const tableBody = document.querySelector('#modalSubjectTable tbody');
        tableBody.innerHTML = `<tr><td>${subject}</td><td>${data.avg}</td><td class="${avgComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${avgComparison >= 0 ? '+' : ''}${avgComparison}%</td><td>${(data.excellentRate * 100).toFixed(2)}%</td><td>-</td><td>${(data.passRate * 100).toFixed(2)}%</td><td>-</td></tr>`;
        document.getElementById('teacherModal').style.display = 'flex';
    }

    document.getElementById('closeModal').addEventListener('click', () => document.getElementById('teacherModal').style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === document.getElementById('teacherModal')) document.getElementById('teacherModal').style.display = 'none'; });

    // ================= 关联分析逻辑 =================
    function updateCorrelationSchoolSelect() {
        const sel = document.getElementById('corrSchoolSelect'); const old = sel.value;
        sel.innerHTML = '<option value="ALL">全乡镇 (All)</option>';
        Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        if(old) sel.value = old;
    }

    function calculatePearson(x, y) {
        let n = x.length; if (n === 0) return 0;
        let sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0, sum_y2 = 0;
        for (let i = 0; i < n; i++) { sum_x += x[i]; sum_y += y[i]; sum_xy += x[i] * y[i]; sum_x2 += x[i] * x[i]; sum_y2 += y[i] * y[i]; }
        let numerator = (n * sum_xy) - (sum_x * sum_y); let denominator = Math.sqrt((n * sum_x2 - sum_x * sum_x) * (n * sum_y2 - sum_y * sum_y));
        return (denominator === 0) ? 0 : numerator / denominator;
    }

    function renderCorrelationAnalysis() {
        const scope = document.getElementById('corrSchoolSelect').value;
        const students = (scope === 'ALL') ? RAW_DATA : (SCHOOLS[scope]?.students || []);
        if(students.length < 5) return alert('样本数据太少，无法进行有效分析');

        const matrixBody = document.querySelector('#corrMatrixTable tbody');
        let mHtml = '<tr><th></th>'; SUBJECTS.forEach(s => mHtml += `<th>${s}</th>`); mHtml += '</tr>';
        SUBJECTS.forEach(rowSub => {
            mHtml += `<tr><th>${rowSub}</th>`;
            SUBJECTS.forEach(colSub => {
                if (rowSub === colSub) { mHtml += '<td style="background:#eee;">-</td>'; } else {
                    const common = students.filter(s => s.scores[rowSub] !== undefined && s.scores[colSub] !== undefined);
                    const r = calculatePearson(common.map(s => s.scores[rowSub]), common.map(s => s.scores[colSub]));
                    let bg = '#fff'; if(r > 0) bg = `rgba(220, 38, 38, ${r * 0.8})`; else bg = `rgba(37, 99, 235, ${Math.abs(r) * 0.8})`;
                    let color = Math.abs(r) > 0.5 ? '#fff' : '#333';
                    mHtml += `<td class="heatmap-cell" style="background:${bg}; color:${color}" title="${rowSub} vs ${colSub} 相关系数: ${r.toFixed(3)}">${r.toFixed(2)}</td>`;
                }
            });
            mHtml += '</tr>';
        });
        matrixBody.innerHTML = mHtml;

        const contribData = SUBJECTS.map(sub => {
            const common = students.filter(s => s.scores[sub] !== undefined);
            const r = calculatePearson(common.map(s => s.scores[sub]), common.map(s => s.total));
            return { sub, r };
        }).sort((a, b) => b.r - a.r);

        const chartContainer = document.getElementById('contributionChartContainer');
        chartContainer.innerHTML = '';
        contribData.forEach(item => {
            const w = Math.max(0, item.r * 100);
            chartContainer.innerHTML += `<div style="display:flex; align-items:center; margin-bottom:5px;"><span style="width:40px; font-size:12px; font-weight:bold;">${item.sub}</span><div style="flex:1; background:#f1f5f9; border-radius:4px; margin-left:10px; height:20px;"><div class="contribution-bar" style="width:${w}%; background:${item.r>0.8?'#16a34a':(item.r>0.6?'#2563eb':'#ca8a04')}">${item.r.toFixed(3)}</div></div></div>`;
        });

        const liftDragBody = document.querySelector('#liftDragTable tbody'); let ldHtml = '';
        SUBJECTS.forEach(sub => {
            let lift = 0, drag = 0, balance = 0; let validCount = 0;
            students.forEach(s => {
                const tRank = safeGet(s, 'ranks.total.township', 0); const sRank = safeGet(s, `ranks.${sub}.township`, 0);
                if(!tRank || !sRank) return;
                validCount++; const threshold = students.length * 0.1; 
                if (sRank < tRank - threshold) lift++; else if (sRank > tRank + threshold) drag++; else balance++;
            });
            if(validCount > 0) {
                const net = lift - drag;
                ldHtml += `<tr><td>${sub}</td><td class="text-green">${lift} 人 (${(lift/validCount*100).toFixed(0)}%)</td><td class="text-red">${drag} 人 (${(drag/validCount*100).toFixed(0)}%)</td><td>${balance} 人</td><td style="font-weight:bold; color:${net>0?'green':'red'}">${net>0?'+':''}${net}</td></tr>`;
            }
        });
        liftDragBody.innerHTML = ldHtml;
    }

    // ================= 进退步分析逻辑 =================
    function updateProgressSchoolSelect() {
        const sel = document.getElementById('progressSchoolSelect');
        sel.innerHTML = '<option value="">--请选择本校--</option>';
        Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
    }

    // ============================================================
    //  智能版上次成绩加载函数 (自动适配 9年级五科模式 vs 其他年级全科模式)
    // ============================================================
    function loadPreviousData(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                
                if(json.length < 2) throw new Error("表格数据太少");

                const headers = json[0].map(h => String(h).trim());
                let idxName = -1, idxSchool = -1, idxTotal = -1, idxClass = -1;
                
                // 1. 识别基础列
                headers.forEach((h, i) => { 
                    if(h.includes('姓名')) idxName = i; 
                    if(h.includes('学校')) idxSchool = i; 
                    if(h.includes('班级') || h.toLowerCase() === 'class') idxClass = i; 
                    if(h.includes('总分') || h.includes('Total') || h === '得分') idxTotal = i; 
                });

                // 🔥🔥 [核心修改点开始]：智能判断要累加哪些科目 🔥🔥
                let subjectIndices = [];
                let calcModeInfo = "全科累加";

                // 如果表格里没有“总分”列，我们需要自己算
                if (idxTotal === -1) {
                    let targetSubjects = [];
                    
                    // 读取全局配置 CONFIG，判断当前是 9年级模式 还是 6-8年级模式
                    if (CONFIG && Array.isArray(CONFIG.totalSubs)) {
                        // 👉 9年级模式：只寻找 ['语文','数学','英语','物理','化学']
                        targetSubjects = CONFIG.totalSubs; 
                        calcModeInfo = "9年级五科";
                    } else {
                        // 👉 其他模式：寻找所有常见科目
                        targetSubjects = ['语文','数学','英语','物理','化学','政治','历史','地理','生物','科学','道法'];
                    }

                    // 遍历表头，记录符合要求的列索引
                    headers.forEach((h, i) => {
                        if (targetSubjects.some(sub => h.includes(sub))) {
                            subjectIndices.push(i);
                        }
                    });
                }
                // 🔥🔥 [核心修改点结束] 🔥🔥

                if(idxName === -1) { alert('上传失败：无法识别“姓名”列。'); return; }
                
                // 3. 开始解析数据
                PREV_DATA = [];
                for(let i=1; i<json.length; i++) {
                    const r = json[i]; 
                    if(!r[idxName]) continue;
                    
                    const school = idxSchool !== -1 ? r[idxSchool] : '默认学校'; 
                    const className = idxClass !== -1 ? normalizeClass(r[idxClass]) : ''; 
                    
                    let score = 0;
                    
                    // 策略A: 优先信赖Excel自带的总分
                    if (idxTotal !== -1) {
                        score = parseFloat(r[idxTotal]);
                    } 
                    // 策略B: 自动求和 (受控于上面的 9年级 逻辑)
                    else if (subjectIndices.length > 0) {
                        let tempSum = 0;
                        let hasVal = false;
                        subjectIndices.forEach(idx => {
                            const val = parseFloat(r[idx]);
                            if (!isNaN(val)) {
                                tempSum += val;
                                hasVal = true;
                            }
                        });
                        if (hasVal) score = tempSum;
                        else score = NaN; 
                    } else {
                        alert('上传失败：未找到总分列，也未匹配到当前模式所需的学科列。');
                        return;
                    }

                    if(!isNaN(score)) { 
                        PREV_DATA.push({ name: r[idxName], school: school, class: className, total: score }); 
                    }
                }
                
                if(PREV_DATA.length === 0) { alert('未读取到有效数据'); return; }

                // 4. 重新计算排名
                PREV_DATA.sort((a,b) => b.total - a.total);
                PREV_DATA.forEach((s, i) => { 
                    if(i > 0 && Math.abs(s.total - PREV_DATA[i-1].total) < 0.001) { 
                        s.rank = PREV_DATA[i-1].rank; 
                    } else { 
                        s.rank = i + 1; 
                    } 
                });
                
                let msg = `✅ 上次考试数据加载成功！共 ${PREV_DATA.length} 条。`;
                if(idxTotal === -1) msg += `\n(注：未提供总分，已按【${calcModeInfo}】模式自动累加 ${subjectIndices.length} 科成绩)`;
                
                alert(msg);
                
                // 刷新可能存在的状态提示
                const statusDiv = document.getElementById('va-data-status');
                if (statusDiv) statusDiv.innerHTML = '✅ 数据就绪 (已更新)';

            } catch(err) {
                console.error(err);
                alert("解析出错：" + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
     // --- 进退步分析 (含同名/转班智能拦截) ---
    
    // 1. 入口函数：先检查歧义
    function renderProgressAnalysis() {
        if(!RAW_DATA.length) return alert("请先上传【本次考试】数据");
        if(!PREV_DATA.length) return alert("请先上传【上次考试】数据");
        
        const schoolName = document.getElementById('progressSchoolSelect').value;
        if(!schoolName) return alert("请选择要分析的学校");
        
        const currentStudents = SCHOOLS[schoolName].students;
        const ambiguousCases = []; // 存储需要用户确认的情况

        // 预扫描
        currentStudents.forEach(curr => {
            // 1. 尝试严格匹配 (姓名+班级+学校)
            const strictMatch = PREV_DATA.find(p => p.name === curr.name && p.school === curr.school && p.class === curr.class);
            
            // 2. 如果严格匹配失败，但在上次数据里能找到“同名同校”的人 (说明可能转班了，或者只是同名)
            if (!strictMatch) {
                // 找出所有同名同校的候选人
                const candidates = PREV_DATA.filter(p => p.name === curr.name && p.school === curr.school);
                
                if (candidates.length > 0) {
                    // 检查是否已经手动映射过
                    const mapKey = `${curr.school}_${curr.class}_${curr.name}`;
                    if (!MANUAL_ID_MAPPINGS[mapKey]) {
                        ambiguousCases.push({
                            curr: curr,
                            candidates: candidates
                        });
                    }
                }
            }
        });

        // 决策：如果有歧义，弹窗；否则直接计算
        if (ambiguousCases.length > 0) {
            showMappingModal(ambiguousCases);
        } else {
            performProgressCalculation(); // 直接计算
        }
    }

    // 2. 显示映射弹窗
    function showMappingModal(cases) {
        const modal = document.getElementById('mappingModal');
        const tbody = document.querySelector('#mappingModal tbody');
        tbody.innerHTML = '';

        cases.forEach((item, idx) => {
            const curr = item.curr;
            let optionsHtml = `<option value="">-- 请选择对应的上次记录 --</option>`;
            // 默认选项：如果只有一个候选人，为了方便，默认选中它？还是强制让用户选？
            // 建议：强制选，或者提供一个"不匹配(视为新生)"选项
            item.candidates.forEach(cand => {
                optionsHtml += `<option value="${cand.class}">上次在：${cand.class} (排名:${cand.rank})</option>`;
            });
            optionsHtml += `<option value="__IGNORE__">❌ 不是同一个人 (视为新生)</option>`;

            const row = `
                <tr data-school="${curr.school}" data-class="${curr.class}" data-name="${curr.name}">
                    <td style="padding:10px;">
                        <div style="font-weight:bold;">${curr.name}</div>
                        <div style="font-size:12px; color:#666;">本次：${curr.class}</div>
                    </td>
                    <td style="padding:10px;">
                        <select class="mapping-select" style="width:100%; padding:5px; border:1px solid #d97706; border-radius:4px;">
                            ${optionsHtml}
                        </select>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        modal.style.display = 'flex';
    }

    // 3. 用户点击确认后
    function confirmMappingsAndRun() {
        const rows = document.querySelectorAll('#mappingModal tbody tr');
        let allSelected = true;

        rows.forEach(row => {
            const select = row.querySelector('select');
            const val = select.value;
            if (!val) {
                allSelected = false;
                select.style.border = "2px solid red";
            } else {
                // 保存映射关系
                const s = row.dataset.school;
                const c = row.dataset.class;
                const n = row.dataset.name;
                const key = `${s}_${c}_${n}`; // 唯一键
                MANUAL_ID_MAPPINGS[key] = val; // value 是上次的班级名，或者 __IGNORE__
            }
        });

        if (!allSelected) return alert("请为所有疑似学生选择对应关系（如果是新生，请选“不是同一个人”）");

        document.getElementById('mappingModal').style.display = 'none';
        performProgressCalculation(); // 继续计算
    }

    // 4. 真正的计算逻辑 (拆分出来的)
    // 🟢 [修改]：完全重写此函数，支持“校内排名”重算对比，解决单校月考 vs 全镇联考的对比难题
    function performProgressCalculation() {
        const schoolName = document.getElementById('progressSchoolSelect').value;
        
        if (!schoolName || !SCHOOLS[schoolName]) return alert("请选择学校");

        const currentStudents = SCHOOLS[schoolName].students; 
        PROGRESS_CACHE = [];
        const cleanName = (n) => String(n).replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');

        // ==========================================
        // 🚀 核心改进：构建“上次考试”的【校内排名】索引
        // 解决痛点：本次是单校(分母小)，上次是全镇(分母大)，直接比排名不科学。
        // 方案：把上次全镇数据里的本校学生拎出来，重新排个座次，用“上次校排”vs“本次校排”。
        // ==========================================
        
        // 1. 从上次全镇数据中，筛选出属于该校的学生
        let prevSchoolSubset = PREV_DATA.filter(p => p.school === schoolName);

        // 备用方案：如果上次数据没填学校，或者学校名写的不一样，尝试用本次名单反查
        if (prevSchoolSubset.length < currentStudents.length * 0.5) { 
            console.log("智能修正：上次数据中学校名称可能不匹配，启用【名单反查模式】...");
            const currentNames = new Set(currentStudents.map(s => cleanName(s.name)));
            prevSchoolSubset = PREV_DATA.filter(p => currentNames.has(cleanName(p.name)));
        }

        // 2. 对上次的本校子集进行重新排序 (按分数降序)
        prevSchoolSubset.sort((a,b) => b.total - a.total);

        // 3. 建立映射表: 姓名 -> 上次校内排名
        const prevLocalRankMap = {};
        prevSchoolSubset.forEach((p, index) => {
            // 处理同分同名次逻辑
            let rank = index + 1;
            if (index > 0 && Math.abs(p.total - prevSchoolSubset[index-1].total) < 0.01) {
                // 继承上一名
                rank = prevLocalRankMap[cleanName(prevSchoolSubset[index-1].name) + "_rank"]; 
            }
            
            prevLocalRankMap[cleanName(p.name)] = {
                localRank: rank,      // 💡 影子排名：上次在校内的名次
                townRank: p.rank,     // 原始排名：上次在全镇的名次
                total: p.total
            };
            // 辅助键防止覆盖
            prevLocalRankMap[cleanName(p.name) + "_rank"] = rank; 
        });

        console.log(`[进退步分析] 已重构上次校内排名，基数: ${prevSchoolSubset.length} 人`);

        // ==========================================
        // 开始对比
        // ==========================================

        currentStudents.forEach(curr => {
            const currNameClean = cleanName(curr.name);
            
            // 尝试获取用户手动映射 (处理同名/转班)
            const mapKey = `${curr.school}_${curr.class}_${curr.name}`;
            const mappedPrevClass = MANUAL_ID_MAPPINGS[mapKey];

            // 获取该生在上次考试中的信息
            let prevInfo = prevLocalRankMap[currNameClean];

            // 简单过滤：如果指定了映射但不是忽略，或者没指定但找到了
            if (mappedPrevClass === '__IGNORE__') prevInfo = null;

            if(prevInfo) {
                // 💡 核心对比：本次校排 vs 上次校排
                // curr.ranks.total.school 是系统在 processData 里算好的本次校内排名
                const currLocalRank = safeGet(curr, 'ranks.total.school', 0);
                const prevLocalRank = prevInfo.localRank;

                // 只有当两者都有效时才计算
                if (currLocalRank > 0 && prevLocalRank > 0) {
                    const change = prevLocalRank - currLocalRank; // 正数为进步 (名次变小)
                    
                    let status = ""; 
                    if(change > 0) status = `<span class="trend-up"><i class="ti ti-arrow-up trend-icon"></i>校排进 ${change} 名</span>`; 
                    else if(change < 0) status = `<span class="trend-down"><i class="ti ti-arrow-down trend-icon"></i>校排退 ${Math.abs(change)} 名</span>`; 
                    else status = `<span style="color:#666;">🔵 排名持平</span>`;
                    
                    // 增加提示：如果是单校模式，特别标注这是校内对比
                    const note = `<div style="font-size:10px; color:#999;">(上次校排: ${prevLocalRank})</div>`;

                    PROGRESS_CACHE.push({ 
                        class: curr.class, 
                        name: curr.name, 
                        currTotal: curr.total, 
                        currRank: currLocalRank, // 显示校内排名
                        prevTotal: prevInfo.total, 
                        prevRank: prevLocalRank, // 显示重算后的上次校内排名
                        change: change, 
                        statusHTML: status + note
                    });
                }
            }
        });

        // 保存全量缓存并应用筛选
        window.PROGRESS_CACHE_FULL = PROGRESS_CACHE.slice();
        applyProgressFilter();
    }

    // 进退步筛选与表格渲染
    function applyProgressFilter() {
        const typeEl = document.getElementById('progressFilterType');
        const thresholdEl = document.getElementById('progressFilterThreshold');
        const type = typeEl ? typeEl.value : 'all';
        const threshold = thresholdEl ? parseInt(thresholdEl.value || '0') : 0;

        let list = (window.PROGRESS_CACHE_FULL || []).slice();
        list = list.filter(r => Math.abs(r.change) >= threshold);
        if (type === 'up') list = list.filter(r => r.change > 0);
        if (type === 'down') list = list.filter(r => r.change < 0);

        // 更新全局用于图表
        PROGRESS_CACHE = list;
        renderProgressTable(list);

        if (list.length > 0) {
            renderTrendChart();
            renderSankeyDiagram();
        }
    }

    function resetProgressFilter() {
        const typeEl = document.getElementById('progressFilterType');
        const thresholdEl = document.getElementById('progressFilterThreshold');
        if (typeEl) typeEl.value = 'all';
        if (thresholdEl) thresholdEl.value = 20;
        applyProgressFilter();
    }

    function renderProgressTable(list) {
        const tbody = document.querySelector('#progressTable tbody'); 
        const thead = document.querySelector('#progressTable thead tr');
        if (!tbody || !thead) return;

        thead.innerHTML = `<th>班级</th><th>姓名</th><th>本次总分</th><th>本次校排</th><th>上次总分</th><th>上次校排(重算)</th><th>进退步</th><th>状态评价</th>`;

        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">暂无符合筛选条件的学生</td></tr>';
            return;
        }

        list.sort((a,b) => b.change - a.change);
        let html = '';
        list.forEach(row => {
            const rewardBtn = row.change > 30 
                ? `<button class="btn btn-orange" style="padding:2px 8px; font-size:11px;" onclick="showCertificate('${row.name}', '进步之星')">🏅 颁奖</button>` 
                : (row.currRank <= 10 ? `<button class="btn btn-purple" style="padding:2px 8px; font-size:11px;" onclick="showCertificate('${row.name}', '学习标兵')">🏆 颁奖</button>` : '');

            html += `<tr>
                <td>${row.class}</td>
                <td><strong>${row.name}</strong></td>
                <td>${row.currTotal}</td>
                <td style="font-weight:bold;">${row.currRank}</td>
                <td style="color:#999">${row.prevTotal}</td>
                <td style="color:#999">${row.prevRank}</td>
                <td style="font-weight:bold; ${row.change>0?'color:var(--success)':'color:var(--danger)'}">${row.change>0?'+':''}${row.change}</td>
                <td>${row.statusHTML} ${rewardBtn}</td>
            </tr>`;  
        });
        tbody.innerHTML = html;
    }

    // 辅助：重绘图表 (把原来的图表逻辑封装在这里)
    function renderTrendChart() {
        const ctx = document.getElementById('trendChart');
        if (trendChartInstance) trendChartInstance.destroy();

        const improved = [], regressed = [], stable = [];
        PROGRESS_CACHE.forEach(p => {
            const point = { x: p.prevRank, y: p.currRank, name: p.name, cls: p.class, change: p.change };
            if (p.change > 0) improved.push(point);
            else if (p.change < 0) regressed.push(point);
            else stable.push(point);
        });
        const maxRank = Math.max(...PROGRESS_CACHE.map(p => Math.max(p.prevRank, p.currRank))) + 10;

        trendChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: '进步', data: improved, backgroundColor: 'rgba(22, 163, 74, 0.6)', borderColor: 'rgba(22, 163, 74, 1)' },
                    { label: '退步', data: regressed, backgroundColor: 'rgba(220, 38, 38, 0.6)', borderColor: 'rgba(220, 38, 38, 1)' },
                    { label: '持平', data: stable, backgroundColor: 'rgba(71, 85, 105, 0.4)' },
                    { label: '基准线', data: [{x: 0, y: 0}, {x: maxRank, y: maxRank}], showLine: true, borderColor: '#94a3b8', borderDash: [5, 5], pointRadius: 0, fill: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { tooltip: { callbacks: { label: (ctx) => { const p = ctx.raw; return p.name ? `${p.cls} ${p.name}: ${p.x} -> ${p.y} (${p.change>0?'+':''}${p.change})` : ''; } } } },
                scales: { x: { title:{display:true, text:'上次排名'}, min:0, max:maxRank }, y: { title:{display:true, text:'本次排名'}, min:0, max:maxRank, reverse:true } }
            }
        });
    }

    let sankeyChartInstance = null;

    function renderSankeyDiagram() {
        const ctx = document.getElementById('sankeyChart');
        if (!ctx) return;
        if (sankeyChartInstance) sankeyChartInstance.destroy();

        if (PROGRESS_CACHE.length === 0) return;

        // 1. 准备基数
        const totalStudents = RAW_DATA.length; // 本次全镇总人数
        const prevTotalStudents = PREV_DATA.length; // 上次全镇总人数

        // 2. 聚合流动数据
        const flows = {};
        
        PROGRESS_CACHE.forEach(p => {
            // 计算上次层级 (按全镇百分比)
            const prevPct = p.prevRank / prevTotalStudents;
            let fromTier = '上次 ';
            if (prevPct <= 0.25) fromTier += 'A (优)';
            else if (prevPct <= 0.50) fromTier += 'B (良)';
            else if (prevPct <= 0.75) fromTier += 'C (中)';
            else fromTier += 'D (潜)';

            // 计算本次层级
            const currPct = p.currRank / totalStudents;
            let toTier = '本次 ';
            if (currPct <= 0.25) toTier += 'A (优)';
            else if (currPct <= 0.50) toTier += 'B (良)';
            else if (currPct <= 0.75) toTier += 'C (中)';
            else toTier += 'D (潜)';

            const key = `${fromTier}||${toTier}`;
            if (!flows[key]) flows[key] = 0;
            flows[key]++;
        });

        // 3. 转换为 Chart.js Sankey 数据格式
        const dataPoints = Object.keys(flows).map(key => {
            const [from, to] = key.split('||');
            return { from, to, flow: flows[key] };
        });

        // 4. 颜色映射逻辑
        const getColor = (from, to) => {
            const f = from.charAt(3); // 取字符 A, B, C, D
            const t = to.charAt(3);
            const map = {'A':0, 'B':1, 'C':2, 'D':3};
            const fi = map[f];
            const ti = map[t];

            if (fi === ti) return '#94a3b8'; // 灰色：保持
            if (ti < fi) return '#16a34a';  // 绿色：进步 (A是0，变小了就是进步)
            return '#dc2626';             // 红色：退步
        };

        sankeyChartInstance = new Chart(ctx, {
            type: 'sankey',
            data: {
                datasets: [{
                    label: '生源流动',
                    data: dataPoints,
                    colorFrom: (c) => getColor(c.dataset.data[c.dataIndex].from, c.dataset.data[c.dataIndex].to),
                    colorTo: (c) => getColor(c.dataset.data[c.dataIndex].from, c.dataset.data[c.dataIndex].to),
                    colorMode: 'gradient', // 渐变色
                    labels: { font: { size: 12, weight: 'bold' }, color: 'black' },
                    nodeWidth: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = context.raw;
                                return `${item.from} -> ${item.to}: ${item.flow}人`;
                            }
                        }
                    }
                }
            }
        });
    }

    function toggleAIChat() {
        const box = document.getElementById('ai-chat-box');
        box.classList.toggle('hidden');
        if(!box.classList.contains('hidden')) document.getElementById('ai-chat-input').focus();
    }

    function addChatBubble(html, type) {
        const container = document.getElementById('ai-chat-messages');
        const div = document.createElement('div');
        div.className = `ai-msg-bubble ${type}`;
        div.innerHTML = html;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // 1. 准备数据上下文 (合并 成绩 + 进退步 + 排名)
    function prepareDataForAI() {
        if (!RAW_DATA.length) return [];
        // 建立进退步索引
        const progressMap = {};
        if (PROGRESS_CACHE && PROGRESS_CACHE.length) {
            PROGRESS_CACHE.forEach(p => {
                progressMap[p.name + '_' + p.class] = p.change; // 正数=进步
            });
        }

        return RAW_DATA.map(s => {
            return {
                name: s.name,
                school: s.school,
                class: s.class,
                total: s.total,
                scores: s.scores, // {语文:90, 数学:80...}
                townRank: safeGet(s, 'ranks.total.township', 9999),
                classRank: safeGet(s, 'ranks.total.class', 999),
                progress: progressMap[s.name + '_' + s.class] || 0 // 进退步
            };
        });
    }

    async function sendAIChat() {
        const input = document.getElementById('ai-chat-input');
        const query = input.value.trim();
        if (!query) return;
        
        if (!LLM_CONFIG.apiKey) {
            addChatBubble("⚠️ 请先在【数据中心】配置 AI API Key 才能使用智能查询。", "system");
            return;
        }

        addChatBubble(query, "user");
        input.value = '';
        addChatBubble("🤖 正在分析数据...", "system");

        // 2. 构建 Prompt：告诉 AI 数据结构，让它写代码
        const dataContext = prepareDataForAI();
        if (dataContext.length === 0) {
            addChatBubble("❌ 当前暂无数据，请先上传成绩。", "system");
            return;
        }

        const subjectsStr = SUBJECTS.join(',');
        const prompt = `
        你是一个数据查询生成器。
        【数据结构】
        变量名: data
        类型: Array<Student>
        Student结构: {
            name: String,
            school: String,
            class: String, // 例如 "701", "802"
            total: Number, // 总分
            scores: { "${subjectsStr}": Number }, // 各科成绩
            townRank: Number, // 全镇排名 (越小越好)
            progress: Number // 进退步 (正数=进步, 负数=退步, 0=无数据)
        }
        
        【任务】
        根据用户问题："${query}"
        编写一段 JavaScript 代码，从 \`data\` 数组中筛选并排序，返回结果数组。
        
        【要求】
        1. 仅返回代码，不要Markdown标记，不要解释。
        2. 代码必须以 \`return data.filter(...).sort(...).slice(0, N)\` 的形式结束。
        3. 如果用户问“不及格”，默认指分数 < 60%满分（假设满分100则<60，满分120则<72）。你可自行设定阈值或简单按 < 60 处理。
        4. 结果最多返回 20 条。
        5. 只能使用 JS 标准数组方法 (filter, sort, slice, map)。
        `;

        try {
            // 3. 调用 LLM
            let jsCode = "";
            await new Promise((resolve) => {
                callLLM(prompt, null, (fullText) => { jsCode = fullText; resolve(); });
            });

            // 清洗代码 (去掉 ```javascript 等)
            jsCode = jsCode.replace(/```javascript/g, '').replace(/```/g, '').trim();
            console.log("AI Generated Code:", jsCode);

            // 4. 沙箱执行代码
            const result = executeAICode(jsCode, dataContext);
            
            // 5. 渲染结果
            renderAIChatResult(result, query);

        } catch (err) {
            console.error(err);
            addChatBubble(`❌ 查询失败: ${err.message}`, "system");
        }
    }

    function executeAICode(code, data) {
        try {
            // 使用 new Function 创建一个安全的执行环境
            // 传入 data 变量
            const func = new Function('data', code);
            const res = func(data);
            if (!Array.isArray(res)) throw new Error("AI 生成的代码未返回数组");
            return res;
        } catch (e) {
            throw new Error("代码执行错误: " + e.message);
        }
    }

    function renderAIChatResult(list, query) {
        const lastMsg = document.querySelector('#ai-chat-messages .ai-msg-bubble.system:last-child');
        
        if (!list || list.length === 0) {
            lastMsg.innerHTML = `🔍 查询 "${query}"<br>结果：未找到符合条件的学生。`;
            return;
        }

        let tableHtml = `<div style="margin-bottom:5px; font-weight:bold;">✅ 找到 ${list.length} 条结果:</div>
        <div class="table-wrap" style="max-height:200px; overflow-y:auto; box-shadow:none; margin:0;">
        <table class="ai-chat-table">
            <thead><tr><th>班级</th><th>姓名</th><th>总分</th><th>详情</th></tr></thead>
            <tbody>`;
        
        list.forEach(s => {
            // 智能展示详情：如果查询提到了某科，就显示某科成绩；提到了进步，显示进步
            let detail = `排:${s.townRank}`;
            if (query.includes("进步") || query.includes("退步")) {
                const p = s.progress > 0 ? `+${s.progress}` : s.progress;
                detail = `<span style="color:${s.progress>0?'green':'red'}">变${p}</span>`;
            } else {
                // 简单的尝试找一下偏科或者单科
                SUBJECTS.forEach(sub => {
                    if (query.includes(sub)) detail = `${sub}:${s.scores[sub]}`;
                });
            }

            tableHtml += `<tr>
                <td>${s.class}</td>
                <td>${s.name}</td>
                <td>${s.total}</td>
                <td>${detail}</td>
            </tr>`;
        });
        tableHtml += `</tbody></table></div>`;
        
        lastMsg.innerHTML = tableHtml;
    }

    function exportProgressAnalysis() {
        if(!PROGRESS_CACHE.length) return alert("暂无分析结果，请先进行分析");
        const wb = XLSX.utils.book_new(); const data = [['班级', '姓名', '本次总分', '本次镇排', '上次总分', '上次镇排', '名次变化(正进负退)']];
        PROGRESS_CACHE.forEach(r => { data.push([r.class, r.name, r.currTotal, r.currRank, r.prevTotal, r.prevRank, r.change]); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "进退步分析"); XLSX.writeFile(wb, "学生进退步追踪分析表.xlsx");
    }

    // 全局状态管理
    let STD_STATE = {
        page: 1,
        size: 100,
        sortCol: null,     // 当前排序列
        sortDir: 'desc',   // desc 或 asc
        activeFilters: {}, // 存储筛选状态: { 'school': new Set(['实验中学', '二中']), '语文': ... }
        cacheData: []      // 最终展示的数据
    };

    // 1. 主渲染函数
    function renderStudentDetails(reset = true) {
        // 隐藏可能存在的筛选菜单
        closeAllMenus();

        if (reset) {
            STD_STATE.page = 1;
            let data = [...RAW_DATA]; // 从原始数据副本开始

            // --- A. 权限过滤 (保持不变) ---
            if (typeof Auth !== 'undefined' && Auth.currentUser) {
                 const user = Auth.currentUser;
                 if (user.role !== 'admin' && user.role !== 'director' && user.school) {
                     data = data.filter(s => s.school === user.school);
                 }
                 if (user.role === 'class_teacher') {
                     // 班主任只能看本班或任教班级 (简化逻辑，详细逻辑见原代码)
                     data = data.filter(s => s.class == user.class);
                 }
            }

            // --- B. 顶部下拉框过滤 (依然保留，作为一级筛选) ---
            const selectedSchool = document.getElementById('studentSchoolSelect')?.value; 
            const selectedClass = document.getElementById('studentClassSelect')?.value;
            
            if (selectedSchool && !selectedSchool.includes('请选择')) {
                data = data.filter(s => s.school === selectedSchool);
                if (selectedClass && selectedClass !== '全部') {
                    data = data.filter(s => s.class === selectedClass);
                }
            }

            // --- C. Excel 列筛选 (核心逻辑) ---
            // 遍历所有已激活的筛选器
            Object.keys(STD_STATE.activeFilters).forEach(colKey => {
                const allowedValues = STD_STATE.activeFilters[colKey]; // Set 对象
                if (!allowedValues || allowedValues.size === 0) return; 

                data = data.filter(s => {
                    let val = getCellValue(s, colKey);
                    // 将值统一转为字符串进行比对
                    return allowedValues.has(String(val));
                });
            });

            // --- D. 排序 ---
            if (STD_STATE.sortCol) {
                const key = STD_STATE.sortCol;
                const dir = STD_STATE.sortDir === 'asc' ? 1 : -1;
                
                data.sort((a, b) => {
                    let valA = getCellValue(a, key);
                    let valB = getCellValue(b, key);
                    
                    // 处理空值
                    if (valA === '-' || valA === undefined) valA = -9999;
                    if (valB === '-' || valB === undefined) valB = -9999;

                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return (valA - valB) * dir;
                    }
                    return String(valA).localeCompare(String(valB), 'zh-CN', {numeric: true}) * dir;
                });
            } else {
                // 默认按总分降序
                data.sort((a, b) => b.total - a.total);
            }

            STD_STATE.cacheData = data;
        }

        // --- E. 分页与渲染 ---
        const totalItems = STD_STATE.cacheData.length;
        const totalPages = Math.ceil(totalItems / STD_STATE.size) || 1;
        if (STD_STATE.page > totalPages) STD_STATE.page = totalPages;
        if (STD_STATE.page < 1) STD_STATE.page = 1;

        const startIdx = (STD_STATE.page - 1) * STD_STATE.size;
        const endIdx = startIdx + STD_STATE.size;
        const displayList = STD_STATE.cacheData.slice(startIdx, endIdx);

        const thead = document.querySelector('#studentDetailTable thead tr'); 
        const tbody = document.querySelector('#studentDetailTable tbody');

        // 生成表头 (带漏斗图标)
        let headerHTML = '';
        
        // 辅助：生成表头单元格
        const buildTh = (label, colKey, width='auto') => {
            // 判断该列是否有激活的筛选
            const isFiltered = STD_STATE.activeFilters[colKey] && STD_STATE.activeFilters[colKey].size > 0;
            // 判断该列是否正在排序
            const isSorted = STD_STATE.sortCol === colKey;
            const sortIcon = isSorted ? (STD_STATE.sortDir === 'asc' ? '↑' : '↓') : '';
            
            const activeClass = (isFiltered || isSorted) ? 'active' : '';
            
            return `
                <th style="min-width:${width}">
                    <div class="excel-header" onclick="toggleExcelMenu('${colKey}', event)">
                        <div class="header-text">${label} <span style="color:#2563eb">${sortIcon}</span></div>
                        <div class="filter-icon-btn ${activeClass}">
                            <i class="ti ti-filter"></i>
                        </div>
                        <!-- 下拉菜单容器，点击时动态填充 -->
                        <div id="menu-${colKey}" class="excel-filter-menu" onclick="event.stopPropagation()"></div>
                    </div>
                </th>
            `;
        };

        headerHTML += buildTh('学校', 'school', '120px');
        headerHTML += buildTh('班级', 'class', '80px');
        headerHTML += buildTh('姓名', 'name', '100px');
        headerHTML += buildTh('考号', 'id', '100px');
        headerHTML += buildTh('考场', 'examRoom', '80px');
        headerHTML += buildTh('T分', 'totalTScore', '60px');

                // 动态判断当前数据是否只有一所学校
        const isSingleSchool = Object.keys(SCHOOLS).length === 1;
        const townHeaderStyle = isSingleSchool ? 'display:none;' : ''; // 如果单校，隐藏列

        SUBJECTS.forEach(sub => {
            headerHTML += buildTh(sub, sub, '80px');
            // 校内排名始终显示，全镇排名按需隐藏
            headerHTML += `<th>T</th><th>校</th><th>班</th><th style="${townHeaderStyle}">镇</th>`; 
        });

        const totalLabel = CONFIG.name === '9年级' ? '五科总分' : '总分';
        headerHTML += buildTh(totalLabel, 'total', '80px');
        headerHTML += `<th>校</th><th>班</th><th style="${townHeaderStyle}">镇</th>`;

        thead.innerHTML = headerHTML;

        // 生成数据行
        let rowsHTML = displayList.map(student => {
            const nameLink = `<a href="javascript:void(0)" onclick="jumpToStudent('${student.name}', '${student.school}', '${student.class}')" style="color:var(--primary); font-weight:800;">${student.name}</a>`;
            
            let row = `<tr>
                <td>${student.school}</td>
                <td>${student.class}</td>
                <td>${nameLink}</td>
                <td>${student.id}</td>
                <td>${student.examRoom || '-'}</td>
                <td style="color:#b45309; font-weight:bold;">${student.totalTScore || '-'}</td>`;

            SUBJECTS.forEach(sub => {
                const score = student.scores[sub] !== undefined ? student.scores[sub] : '-';
                const t = student.tScores ? (student.tScores[sub] || '-') : '-';
                
                // 修改功能链接
                const clickAttr = `onclick="updateStudentScore('${student.name}', '${student.class}', '${sub}', ${score})"`;
                
                row += `<td ${clickAttr} style="cursor:pointer;" title="点击修改">${score}</td>
                        <td class="text-gray">${t}</td>
                        <td class="text-gray">${safeGet(student, `ranks.${sub}.school`, '-')}</td>
                        <td class="text-gray">${safeGet(student, `ranks.${sub}.class`, '-')}</td>
                        <td class="text-gray" style="${townHeaderStyle}">${safeGet(student, `ranks.${sub}.township`, '-')}</td>`;
            });

            row += `<td style="color:#2563eb; font-weight:bold;">${student.total}</td>
                    <td>${safeGet(student, 'ranks.total.school', '-')}</td>
                    <td>${safeGet(student, 'ranks.total.class', '-')}</td>
                    <td>${safeGet(student, 'ranks.total.township', '-')}</td>
                </tr>`;
            return row;
        }).join('');

        // 分页条
        const paginationHTML = `
            <tr style="background:#f8fafc; font-weight:bold; position:sticky; bottom:0; z-index:150; border-top:2px solid #cbd5e1;">
                <td colspan="100" style="text-align:center; padding:8px;">
                    <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                        <span style="font-size:12px; color:#666;">共 ${totalItems} 条 · ${STD_STATE.page}/${totalPages} 页</span>
                        <button class="btn btn-sm" onclick="changeStdPage(-1)" ${STD_STATE.page===1?'disabled':''}>◀</button>
                        <button class="btn btn-sm" onclick="changeStdPage(1)" ${STD_STATE.page===totalPages?'disabled':''}>▶</button>
                    </div>
                </td>
            </tr>`;

        if(totalItems === 0) tbody.innerHTML = `<tr><td colspan="100" style="text-align:center; padding:30px; color:#999;">无数据</td></tr>`;
        else tbody.innerHTML = rowsHTML + paginationHTML;
    }

    // 辅助：获取单元格值
    function getCellValue(student, colKey) {
        if (colKey === 'total') return student.total;
        if (colKey === 'totalTScore') return student.totalTScore;
        if (['school','class','name','id','examRoom'].includes(colKey)) return student[colKey];
        return student.scores[colKey] !== undefined ? student.scores[colKey] : '-';
    }

    // 2. 切换显示 Excel 菜单
    function toggleExcelMenu(colKey, event) {
        // 阻止冒泡
        event.stopPropagation();
        
        const menuId = `menu-${colKey}`;
        const menu = document.getElementById(menuId);
        
        // 如果该菜单已打开，则关闭
        if (menu.classList.contains('show')) {
            menu.classList.remove('show');
            return;
        }

        // 关闭其他所有菜单
        closeAllMenus();

        // 填充菜单内容
        buildFilterMenuContent(colKey, menu);
        
        // 显示
        menu.classList.add('show');
    }

    // 3. 构建菜单内容 (核心：提取唯一值)
    function buildFilterMenuContent(colKey, container) {
        // 简单策略：从当前显示的 cacheData 中提取唯一值
        const uniqueValues = new Set();
        STD_STATE.cacheData.forEach(s => {
            let val = getCellValue(s, colKey);
            uniqueValues.add(String(val));
        });

        // 转为数组并排序
        const sortedValues = Array.from(uniqueValues).sort((a,b) => {
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
            return a.localeCompare(b, 'zh-CN', {numeric:true});
        });

        // 检查哪些被选中了
        const currentSet = STD_STATE.activeFilters[colKey]; 
        const isAllChecked = !currentSet; 
        
        let listHtml = '';
        sortedValues.forEach(v => {
            const checked = isAllChecked || currentSet.has(v) ? 'checked' : '';
            listHtml += `
                <label class="menu-item">
                    <input type="checkbox" value="${v}" ${checked} class="filter-cb-${colKey}"> ${v}
                </label>`;
        });

        container.innerHTML = `
            <div class="menu-actions">
                <button class="btn btn-sm btn-gray" style="width:100%" onclick="applySort('${colKey}', 'asc')">⬆️ 升序排列</button>
                <button class="btn btn-sm btn-gray" style="width:100%" onclick="applySort('${colKey}', 'desc')">⬇️ 降序排列</button>
                <input type="text" class="menu-search" placeholder="搜索..." oninput="filterCheckboxList(this)">
            </div>
            <div class="menu-list">
                <label class="menu-item" style="font-weight:bold; border-bottom:1px solid #eee;">
                    <input type="checkbox" id="cb-all-${colKey}" ${isAllChecked?'checked':''} onchange="toggleAllCheckboxes('${colKey}', this)"> (全选)
                </label>
                ${listHtml}
            </div>
            <div class="menu-footer">
                <button class="btn btn-sm btn-primary" onclick="confirmFilter('${colKey}')">确定</button>
                <button class="btn btn-sm btn-gray" onclick="clearFilter('${colKey}')">重置</button>
            </div>
        `;
    }

    // 4. 菜单内部交互函数
    window.applySort = function(colKey, dir) {
        STD_STATE.sortCol = colKey;
        STD_STATE.sortDir = dir;
        renderStudentDetails(true); // 重绘
    };

    window.filterCheckboxList = function(input) {
        const text = input.value.toLowerCase();
        const list = input.closest('.menu-actions').nextElementSibling;
        const items = list.querySelectorAll('.menu-item');
        // 跳过第一个(全选)
        for (let i = 1; i < items.length; i++) {
            const itemText = items[i].innerText.toLowerCase();
            items[i].style.display = itemText.includes(text) ? 'flex' : 'none';
        }
    };

    window.toggleAllCheckboxes = function(colKey, source) {
        const cbs = document.querySelectorAll(`.filter-cb-${colKey}`);
        cbs.forEach(cb => {
            if(cb.parentElement.style.display !== 'none') {
                cb.checked = source.checked;
            }
        });
    };

    window.confirmFilter = function(colKey) {
        const cbs = document.querySelectorAll(`.filter-cb-${colKey}:checked`);
        const allCbs = document.querySelectorAll(`.filter-cb-${colKey}`);
        
        if (cbs.length === allCbs.length) {
            delete STD_STATE.activeFilters[colKey];
        } else {
            const selectedValues = new Set();
            cbs.forEach(cb => selectedValues.add(cb.value));
            STD_STATE.activeFilters[colKey] = selectedValues;
        }
        
        renderStudentDetails(true);
    };

    window.clearFilter = function(colKey) {
        delete STD_STATE.activeFilters[colKey];
        renderStudentDetails(true);
    };

    function closeAllMenus() {
        document.querySelectorAll('.excel-filter-menu').forEach(el => el.classList.remove('show'));
    }

    // 点击空白关闭菜单
    document.addEventListener('click', closeAllMenus);

    // 辅助：翻页
    window.changeStdPage = function(delta) {
        STD_STATE.page += delta;
        renderStudentDetails(false); 
        document.querySelector('#student-details .table-wrap').scrollTop = 0;
    };


    function exportStudentDetails() {
        if (!RAW_DATA.length) { alert('请先上传数据'); return; }
        
        const selectedSchool = document.getElementById('studentSchoolSelect').value; 
        const selectedClass = document.getElementById('studentClassSelect').value;
        
        // 1. 判断是否为单校模式 (只有1所学校)
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;

        const wb = XLSX.utils.book_new(); 
        
        // 2. 动态构建表头
        const headers = ['学校', '班级', '姓名', '考号', '考场', '标准分总和(T分)'];
        
        SUBJECTS.forEach(subject => {
            headers.push(`${subject} 分数`, `${subject} T分`, `${subject} 校排`, `${subject} 班排`);
            // 🟢 如果不是单校，才加镇排
            if (!isSingleSchool) headers.push(`${subject} 镇排`);
        });

        if (CONFIG.name === '9年级') {
            headers.push('五科总分', '五科校排', '五科班排');
            if (!isSingleSchool) headers.push('五科镇排');
        } else {
            headers.push('总分', '总分校排', '总分班排');
            if (!isSingleSchool) headers.push('总分镇排');
        }
        
        const data = [headers]; 
        
        let studentsToShow = [...RAW_DATA]; 
        if(selectedSchool && !selectedSchool.includes('请选择')) { 
            studentsToShow = studentsToShow.filter(s => s.school === selectedSchool); 
            if(selectedClass && selectedClass !== '全部') studentsToShow = studentsToShow.filter(s => s.class === selectedClass); 
        } 
        studentsToShow.sort((a, b) => b.total - a.total);
        
        // 3. 填充数据行 (需与表头逻辑严格对应)
        studentsToShow.forEach(student => {
            const row = [student.school, student.class, student.name, student.id, student.examRoom, student.totalTScore || 0]; 
            
            SUBJECTS.forEach(subject => {
                const tVal = student.tScores && student.tScores[subject] ? student.tScores[subject] : '-';
                
                row.push(
                    student.scores[subject] || '-', 
                    tVal, 
                    safeGet(student, `ranks.${subject}.school`, '-'), 
                    safeGet(student, `ranks.${subject}.class`, '-')
                );
                // 🟢 如果不是单校，才加镇排数据
                if (!isSingleSchool) {
                    row.push(safeGet(student, `ranks.${subject}.township`, '-'));
                }
            });

            row.push(
                student.total, 
                safeGet(student, 'ranks.total.school', '-'), 
                safeGet(student, 'ranks.total.class', '-')
            );
            // 🟢 如果不是单校，才加镇排数据
            if (!isSingleSchool) {
                row.push(safeGet(student, 'ranks.total.township', '-'));
            }

            data.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // 调用装饰函数美化 Excel
        decorateExcelSheet(ws, headers);
        
        XLSX.utils.book_append_sheet(wb, ws, '学生考试明细'); 
        XLSX.writeFile(wb, '学生考试明细.xlsx');
    }

// 🟢 [新增] 核心功能：管理员/级部主任修改成绩并同步云端
    async function updateStudentScore(name, cls, subject, oldScore) {
        /* 👇👇👇 🟢 修改：权限校验逻辑 (支持级部主任) 🟢 👇👇👇 */
        // 1. 权限与身份校验
        const user = typeof Auth !== 'undefined' ? Auth.currentUser : null;
        if (!user) return alert("请先登录系统");

        const role = user.role;
        
        // 允许: 管理员(admin) 和 级部主任(grade_director)
        if (role !== 'admin' && role !== 'grade_director') {
            return alert("⛔ 权限不足：只有【管理员】或【级部主任】可以修改原始成绩。\n\n(科任教师或班主任如需修改，请联系上级或重新上传Excel)");
        }

        // 级部主任特有检查：只能修改本年级的班级
        if (role === 'grade_director') {
            // 数据库中 class_name 存的是级部名称(如 "7" 或 "七")
            const myGrade = String(user.class || "").trim(); 
            const targetClass = String(cls).trim();

            // 简单逻辑：班级名必须以级部名开头 (例如 "7" 匹配 "701", "705")
            // 如果级部是中文 "七"，而班级是 "701"，可能需要更复杂的映射，这里假设输入一致
            if (!myGrade || !targetClass.startsWith(myGrade)) {
                return alert(`⛔ 越权操作拦截！\n\n您是【${myGrade}年级】主任，无权修改【${targetClass}班】的成绩。`);
            }
        }
        /* 👆👆👆 🟢 结束 🟢 👆👆👆 */

        // 2. 弹出输入框
        const newScoreStr = prompt(`📝 正在修改成绩\n\n学生：${cls}班 ${name}\n科目：${subject}\n\n当前分数：${oldScore}\n请输入新分数：`, oldScore);
        
        // 用户点击取消
        if (newScoreStr === null) return; 
        
        const newScore = parseFloat(newScoreStr);
        if (isNaN(newScore)) return alert("❌ 输入错误：请输入有效的数字！");
        if (newScore === oldScore) return; // 分数没变，不做处理

        // 3. 在内存数据中查找并更新
        // 使用 姓名 + 班级 + 学校 组合键进行精确查找
        const student = RAW_DATA.find(s => s.name === name && s.class === cls && s.school === (window.MY_SCHOOL || s.school));
        
        if (!student) {
            return alert("❌ 错误：未在内存中找到该学生数据，请尝试刷新页面。");
        }

        // 更新单科成绩
        student.scores[subject] = newScore;
        
        // 4. 重新计算该学生的总分
        // 逻辑：判断当前模式（9年级五科模式 vs 全科模式）
        let newTotal = 0;
        let subjectsToCount = [];

        if (CONFIG && CONFIG.name && CONFIG.name.includes('9')) {
            // 9年级模式：只累加语数英物化
            subjectsToCount = ['语文', '数学', '英语', '物理', '化学'];
        } else {
            // 其他模式：CONFIG.totalSubs 如果是 'auto' 则累加所有科目
            subjectsToCount = (CONFIG.totalSubs === 'auto') ? SUBJECTS : CONFIG.totalSubs;
        }
        
        // 执行累加
        subjectsToCount.forEach(sub => {
            const val = student.scores[sub];
            if (typeof val === 'number') {
                newTotal += val;
            }
        });
        
        student.total = parseFloat(newTotal.toFixed(2)); // 保持2位小数

        // 5. 全局重算 (触发 Worker 重新排名、计算两率一分)
        UI.loading(true, "正在重新排名并同步云端...");
        
        try {
            await processData(); // 等待 Worker 计算完成
            
            // 6. 保存到 Supabase 云端 (关键步骤)
            await saveCloudData();
            
            // 7. 刷新界面
            renderStudentDetails(false); // 刷新列表，false表示不重置页码
            renderTables(); // 刷新宏观分析表
            
            UI.loading(false);
            UI.toast(`✅ 修改成功！\n${name} 的 ${subject} 已更新为 ${newScore}\n总分更新为 ${student.total}`, "success");
 
            // 🛡️ [日志埋点] 记录成绩修改操作
            Logger.log('修改成绩', `${cls}班 ${name} - ${subject}: ${oldScore} -> ${newScore} (总分:${student.total}) [操作人:${user.name}]`);
           
        } catch (err) {
            UI.loading(false);
            console.error(err);
            alert("❌ 保存失败：" + err.message);
        }
    }
    function generateMobileLongImage() {
        const sch = document.getElementById('studentSchoolSelect').value;
        const cls = document.getElementById('studentClassSelect').value;
        if (!sch || !cls || cls === '全部' || sch.includes('请选择')) return alert("请先选择具体的【学校】和【班级】！");

        const students = RAW_DATA.filter(s => s.school === sch && s.class === cls);
        if (students.length === 0) return alert("该班级无数据");
        
        // 1. 数据准备
        students.sort((a, b) => b.total - a.total);
        const avg = students.reduce((a, b) => a + b.total, 0) / students.length;
        const max = students[0].total;
        
        // 2. 渲染容器
        const container = document.getElementById('mobile-share-render-area');
        const dateStr = new Date().toLocaleDateString();
        
        // 只展示前 15 名，避免图片过长，或者全部展示（视需求而定，这里展示前15+底部提示）
        const displayLimit = 15;
        let topListHtml = '';
        
        students.slice(0, displayLimit).forEach((s, i) => {
            let rankClass = 'background:#f1f5f9; color:#64748b;'; // 默认普通排名
            let rankIcon = i + 1;
            
            // 前三名特殊样式
            if (i === 0) { rankClass = 'background:#fee2e2; color:#dc2626; border:1px solid #fecaca;'; rankIcon = '🥇'; } 
            else if (i === 1) { rankClass = 'background:#ffedd5; color:#c2410c; border:1px solid #fed7aa;'; rankIcon = '🥈'; } 
            else if (i === 2) { rankClass = 'background:#fef9c3; color:#b45309; border:1px solid #fde047;'; rankIcon = '🥉'; }

            topListHtml += `
                <div class="m-list-row" style="display:flex; justify-content:space-between; padding:12px 10px; border-bottom:1px dashed #eee; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; ${rankClass}">${rankIcon}</span>
                        <span style="font-weight:bold; font-size:15px; color:#333;">${s.name}</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:800; color:#2563eb; font-size:16px;">${s.total}</div>
                        <div style="font-size:10px; color:#94a3b8;">镇排: ${safeGet(s, 'ranks.total.township', '-')}</div>
                    </div>
                </div>`;
        });

        // 如果人数超过展示限制，加个提示
        if (students.length > displayLimit) {
            topListHtml += `<div style="text-align:center; padding:10px; color:#94a3b8; font-size:12px;">... 后续 ${students.length - displayLimit} 名学生略 ...</div>`;
        }

        // 3. 构建 HTML (内联样式确保 html2canvas 渲染准确)
        container.innerHTML = `
            <div style="background:white; padding-bottom:20px;">
                <!-- 头部海报区 -->
                <div style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 30px 30px; margin-bottom: 20px; position:relative; overflow:hidden;">
                    <!-- 装饰背景圆 -->
                    <div style="position:absolute; top:-20px; left:-20px; width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:50%;"></div>
                    <div style="position:absolute; bottom:-10px; right:-10px; width:80px; height:80px; background:rgba(255,255,255,0.1); border-radius:50%;"></div>
                    
                    <div style="font-size: 12px; opacity: 0.9; letter-spacing: 2px; margin-bottom: 5px; text-transform:uppercase;">Academic Report</div>
                    <div style="font-size: 24px; font-weight: 800; margin-bottom: 5px; text-shadow:0 2px 4px rgba(0,0,0,0.2);">${sch} · ${cls}</div>
                    <div style="font-size: 14px; opacity: 0.9; background:rgba(255,255,255,0.2); display:inline-block; padding:4px 12px; border-radius:20px;">
                        ${CONFIG.name} 成绩快报
                    </div>
                </div>
                
                <!-- 核心指标卡 -->
                <div style="margin: 0 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; margin-bottom: 20px;">
                    <div style="background:#f8fafc; padding:15px 5px; border-radius:12px; border:1px solid #e2e8f0;">
                        <div style="font-size:20px; font-weight:800; color:#334155;">${students.length}</div>
                        <div style="font-size:10px; color:#64748b; margin-top:2px;">参考人数</div>
                    </div>
                    <div style="background:#f0f9ff; padding:15px 5px; border-radius:12px; border:1px solid #bae6fd;">
                        <div style="font-size:20px; font-weight:800; color:#0284c7;">${avg.toFixed(1)}</div>
                        <div style="font-size:10px; color:#0369a1; margin-top:2px;">班级均分</div>
                    </div>
                    <div style="background:#fffbeb; padding:15px 5px; border-radius:12px; border:1px solid #fde68a;">
                        <div style="font-size:20px; font-weight:800; color:#d97706;">${max}</div>
                        <div style="font-size:10px; color:#b45309; margin-top:2px;">最高分</div>
                    </div>
                </div>

                <!-- 榜单列表 -->
                <div style="margin: 0 15px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; overflow: hidden;">
                    <div style="background:#f8fafc; padding:12px 15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; color:#333; display:flex; align-items:center; gap:5px;">
                            <span style="color:#eab308;">🏆</span> 光荣榜 (Top ${displayLimit})
                        </span>
                        <span style="font-size:10px; color:#94a3b8;">按总分排序</span>
                    </div>
                    <div style="padding: 0 10px;">
                        ${topListHtml}
                    </div>
                </div>

                <!-- 底部落款 -->
                <div style="text-align: center; margin-top: 30px; color: #cbd5e1; font-size: 10px; line-height: 1.5;">
                    <div style="margin-bottom:5px;">📅 生成日期: ${dateStr}</div>
                    <div>本数据由 [智能教务分析系统] 自动生成</div>
                    <div>仅供班级内部学情分析使用</div>
                </div>
            </div>
        `;

        // 4. 调用 html2canvas
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="ti ti-loader"></i> 生成中...';
        btn.disabled = true;

        setTimeout(() => {
            html2canvas(container, { 
                scale: 2, // 2倍高清
                useCORS: true, 
                backgroundColor: '#f3f4f6' // 背景色
            }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const resultBox = document.getElementById('mobile-img-result');
                // 限制高度，允许滚动查看
                resultBox.innerHTML = `<img src="${imgData}" style="width:100%; display:block; border-radius:8px;">`;
                
                document.getElementById('mobileShareModal').style.display = 'flex';
                
                // 恢复按钮
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                alert("生成失败: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }, 300); // 稍微延时等待 DOM 渲染
    }

    // 辅助：获取进步之星 HTML
    function getProgressStarsHtml(school, className) {
        if (!PROGRESS_CACHE || PROGRESS_CACHE.length === 0) return "暂无进退步数据 (需在'进退步追踪'模块分析)";
        
        // 筛选本班进步最大的前5名
        const stars = PROGRESS_CACHE.filter(p => p.class === className && p.change > 0)
                                    .sort((a, b) => b.change - a.change)
                                    .slice(0, 5);
        
        if (stars.length === 0) return "本次无明显进步记录";
        
        return stars.map(s => 
            `<span style="display:inline-block; margin:3px; padding:2px 6px; background:#dcfce7; color:#166534; border-radius:10px;">
                ${s.name} ↑${s.change}
             </span>`
        ).join("");
    }

    function downloadMobileImage() {
        const img = document.querySelector('#mobile-img-result img');
        if (img) {
            const link = document.createElement('a');
            link.download = `班级成绩长图_${new Date().getTime()}.png`;
            link.href = img.src;
            link.click();
        }
    }

    function analyzeMarginalStudents() {
        const selectedSchool = document.getElementById('marginalSchoolSelect').value; if (!selectedSchool) { alert('请选择本校'); return; }
        const mySchoolStudents = RAW_DATA.filter(student => student.school === selectedSchool); if (mySchoolStudents.length === 0) { alert('该学校没有学生数据'); return; }
        MARGINAL_STUDENTS = {}; const classes = {}; mySchoolStudents.forEach(student => { if (!classes[student.class]) classes[student.class] = []; classes[student.class].push(student); });
        Object.keys(classes).forEach(className => {
            const classStudents = classes[className];
            SUBJECTS.forEach(subject => {
                const excThreshold = THRESHOLDS[subject]?.exc || 0; const passThreshold = THRESHOLDS[subject]?.pass || 0;
                const excellentMarginal = classStudents.filter(student => { const score = student.scores[subject]; return score !== undefined && score < excThreshold && score >= excThreshold * 0.9; });
                const passMarginal = classStudents.filter(student => { const score = student.scores[subject]; return score !== undefined && score < passThreshold && score >= passThreshold * 0.8; });
                if (!MARGINAL_STUDENTS[className]) MARGINAL_STUDENTS[className] = {}; MARGINAL_STUDENTS[className][subject] = { excellentMarginal, passMarginal };
            });
        });
        renderMarginalStudents(selectedSchool);
    }

    function renderMarginalStudents(schoolName) {
        const container = document.getElementById('marginal-student-results'); container.innerHTML = '';
        Object.keys(MARGINAL_STUDENTS).sort().forEach(className => {
            let html = `<div class="sub-header">${className}班 - 边缘生分析</div><div class="table-wrap"><table><thead><tr><th>学科</th><th>优秀边缘生</th><th>及格边缘生</th></tr></thead><tbody>`;
            SUBJECTS.forEach(subject => {
                const subjectData = MARGINAL_STUDENTS[className][subject]; if (!subjectData) return;
                const formatList = (list, thresh) => list.length ? list.map(s => `<strong>${s.name}</strong> <span style="font-size:12px;color:#666">(${s.scores[subject]},差${(thresh-s.scores[subject]).toFixed(1)})</span>`).join('， ') : '无';
                html += `<tr><td>${subject}</td><td style="background:#f0fdf4;">${formatList(subjectData.excellentMarginal, THRESHOLDS[subject].exc)}</td><td style="background:#fffbeb;">${formatList(subjectData.passMarginal, THRESHOLDS[subject].pass)}</td></tr>`;
            });
            html += '</tbody></table></div>'; container.innerHTML += html;
        });
    }

    function exportMarginalStudents() {
        if (Object.keys(MARGINAL_STUDENTS).length === 0) { alert('请先进行边缘生分析'); return; }
        const wb = XLSX.utils.book_new(); const headers = ['班级', '学科', '类型', '学生姓名', '分数', '与标准线差距']; const data = [headers];
        Object.keys(MARGINAL_STUDENTS).sort().forEach(className => {
            Object.keys(MARGINAL_STUDENTS[className]).forEach(subject => {
                const subjectData = MARGINAL_STUDENTS[className][subject];
                subjectData.excellentMarginal.forEach(student => data.push([className, subject, '优秀边缘生', student.name, student.scores[subject].toFixed(1), (THRESHOLDS[subject].exc - student.scores[subject]).toFixed(1)]));
                subjectData.passMarginal.forEach(student => data.push([className, subject, '及格边缘生', student.name, student.scores[subject].toFixed(1), (THRESHOLDS[subject].pass - student.scores[subject]).toFixed(1)]));
            });
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), '边缘生分析'); XLSX.writeFile(wb, '边缘生分析.xlsx');
    }

    function renderHorizontalTable() {
        const mySchoolName = document.getElementById('mySchool').value;
        let html = '<table class="comparison-table"><thead><tr><th>统计项目/科目</th>'; let mySchoolIndex = -1;
        const schoolNames = Object.keys(SCHOOLS);
        schoolNames.forEach((school, index) => { if(school === mySchoolName) mySchoolIndex = index; const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<th class="${highlightClass}">${school}</th>`; });
        html += '</tr></thead><tbody>';
        SUBJECTS.forEach(subject => {
            html += `<tr><td>${subject}平均分</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics[subject] ? formatRankDisplay(SCHOOLS[school].metrics[subject].avg, SCHOOLS[school].rankings[subject]?.avg || 0) : '-'}</td>`; });
            html += `</tr><tr><td>${subject}优秀率</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics[subject] ? formatRankDisplay(SCHOOLS[school].metrics[subject].excRate, SCHOOLS[school].rankings[subject]?.excRate || 0, 'school', true) : '-'}</td>`; });
            html += `</tr><tr><td>${subject}及格率</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics[subject] ? formatRankDisplay(SCHOOLS[school].metrics[subject].passRate, SCHOOLS[school].rankings[subject]?.passRate || 0, 'school', true) : '-'}</td>`; });
            html += '</tr>';
        });
        html += `<tr><td>${CONFIG.label}平均分</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics.total ? formatRankDisplay(SCHOOLS[school].metrics.total.avg, SCHOOLS[school].rankings.total?.avg || 0) : '-'}</td>`; });
        html += `<tr><td>${CONFIG.label}优秀率</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics.total ? formatRankDisplay(SCHOOLS[school].metrics.total.excRate, SCHOOLS[school].rankings.total?.excRate || 0, 'school', true) : '-'}</td>`; });
        html += `<tr><td>${CONFIG.label}及格率</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics.total ? formatRankDisplay(SCHOOLS[school].metrics.total.passRate, SCHOOLS[school].rankings.total?.passRate || 0, 'school', true) : '-'}</td>`; });
        html += '</tr></tbody></table>';
        document.getElementById('horizontal-table').innerHTML = html; document.getElementById('horizontal-box').classList.remove('hidden');
    }

    // ================= 增强版：横向对比Excel导出 =================
    function exportHorizontalExcel() {
        const mySchoolName = document.getElementById('mySchool').value.trim();
        const schoolNames = Object.keys(SCHOOLS);
        if (schoolNames.length === 0) return alert("暂无数据可导出");

        const wb = XLSX.utils.book_new();
        const wsData = []; 
        const merges = []; 
        let rowIndex = 0;  

        const borderStyle = { top: { style: "thin", color: { rgb: "E2E8F0" } }, bottom: { style: "thin", color: { rgb: "E2E8F0" } }, left: { style: "thin", color: { rgb: "E2E8F0" } }, right: { style: "thin", color: { rgb: "E2E8F0" } } };
        const styleHeader = { font: { bold: true, color: { rgb: "333333" }, sz: 11 }, fill: { fgColor: { rgb: "F3F4F6" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
        const styleSubjectBar = { font: { bold: true, color: { rgb: "1E40AF" }, sz: 12 }, fill: { fgColor: { rgb: "DBEAFE" } }, alignment: { horizontal: "left", vertical: "center" }, border: { top: { style: "medium", color: { rgb: "3B82F6" } }, bottom: { style: "thin" } } };
        const styleNormal = { alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
        const styleHighlight = { fill: { fgColor: { rgb: "FEF9C3" } }, font: { bold: true, color: { rgb: "B45309" } }, alignment: { horizontal: "center", vertical: "center" }, border: { ...borderStyle, left: { style: "medium", color: { rgb: "FACC15" } }, right: { style: "medium", color: { rgb: "FACC15" } } } };
        const styleRankRow = { font: { color: { rgb: "94A3B8" }, sz: 9 }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
        const styleHighlightRank = Object.assign({}, styleHighlight, { font: { color: { rgb: "B45309" }, sz: 9 } });

        const headerRow = [{ v: "统计项目 / 学校", t: 's', s: styleHeader }];
        let mySchoolIndex = -1;

        schoolNames.forEach((name, index) => {
            const isMySchool = (name === mySchoolName);
            if (isMySchool) mySchoolIndex = index;
            headerRow.push({ v: name, t: 's', s: isMySchool ? styleHighlight : styleHeader });
        });
        wsData.push(headerRow);
        rowIndex++; 

        const createCell = (val, type, format, isRankRow, colIndex) => {
            const isMyCol = (colIndex === mySchoolIndex);
            let style = isRankRow ? styleRankRow : styleNormal;
            if (isMyCol) style = isRankRow ? styleHighlightRank : styleHighlight;
            if (val === '-' || val === undefined || val === null) { return { v: '-', t: 's', s: style }; }
            return { v: val, t: type, z: format, s: style };
        };

        const allItems = [...SUBJECTS, 'total']; 
        const totalCols = schoolNames.length + 1;

        allItems.forEach(sub => {
            const label = sub === 'total' ? CONFIG.label : sub;
            const sepRowData = [];
            for(let c=0; c<totalCols; c++) { sepRowData.push({ v: c===0 ? `📘 ${label} 数据分析` : "", t: 's', s: styleSubjectBar }); }
            wsData.push(sepRowData);
            merges.push({ s: { r: rowIndex, c: 0 }, e: { r: rowIndex, c: totalCols - 1 } });
            rowIndex++; 

            const labelStyle = (color) => ({ font: { color: { rgb: color }, bold:true }, fill: { fgColor: { rgb: "F9FAFB" } }, border: borderStyle });
            const rowAvg = [{ v: "平均分", t: 's', s: labelStyle("2563EB") }]; const rowAvgR = [{ v: "   ↳ 排名", t: 's', s: styleRankRow }];
            const rowExc = [{ v: "优秀率", t: 's', s: labelStyle("16A34A") }]; const rowExcR = [{ v: "   ↳ 排名", t: 's', s: styleRankRow }];
            const rowPass = [{ v: "及格率", t: 's', s: labelStyle("D97706") }]; const rowPassR = [{ v: "   ↳ 排名", t: 's', s: styleRankRow }];

            schoolNames.forEach((school, idx) => {
                const metrics = SCHOOLS[school].metrics[sub]; const rankings = SCHOOLS[school].rankings[sub] || {};
                if (metrics) {
                    rowAvg.push(createCell(parseFloat(metrics.avg.toFixed(2)), 'n', '0.00', false, idx));
                    rowAvgR.push(createCell(rankings.avg, 'n', '0', true, idx));
                    rowExc.push(createCell(metrics.excRate, 'n', '0.00%', false, idx));
                    rowExcR.push(createCell(rankings.excRate, 'n', '0', true, idx));
                    rowPass.push(createCell(metrics.passRate, 'n', '0.00%', false, idx));
                    rowPassR.push(createCell(rankings.passRate, 'n', '0', true, idx));
                } else {
                    [rowAvg, rowAvgR, rowExc, rowExcR, rowPass, rowPassR].forEach(r => r.push(createCell('-', 's', null, false, idx)));
                }
            });
            wsData.push(rowAvg, rowAvgR, rowExc, rowExcR, rowPass, rowPassR);
            rowIndex += 6; 
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!merges'] = merges;
        const cols = [{ wch: 20 }]; schoolNames.forEach(() => cols.push({ wch: 11 })); ws['!cols'] = cols;
        ws['!freeze'] = { xSplit: 1, ySplit: 1 };

        XLSX.utils.book_append_sheet(wb, ws, "横向对比分析");
        XLSX.writeFile(wb, `乡镇学校横向对比表_${mySchoolName || '全镇'}.xlsx`);
    }

    function exportMacroTables() {
        if (!Object.keys(SCHOOLS).length) return alert("请先上传数据");
        
        const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
        const wb = XLSX.utils.book_new();
        
        // 1. 构建动态表头
        let headerRow = ["学校名称", "实考人数", "平均分", "优秀率", "及格率"];
        if (isGrade9) {
            headerRow.push("高分人数(≥490)", "高分率", "高分赋分");
        }
        headerRow.push("赋分-均分", "赋分-优率", "赋分-及格", "两率一分总分", "排名");

        const summaryData = [headerRow];
        const list = Object.values(SCHOOLS).sort((a,b)=>a.rank2Rate - b.rank2Rate);
        
        // 2. 构建数据行
        list.forEach(s => {
            const m = s.metrics.total || {};
            let row = [
                s.name, 
                m.count || 0, 
                getExcelNum(m.avg), 
                getExcelPercent(m.excRate), 
                getExcelPercent(m.passRate)
            ];

            // 插入高分数据
            if (isGrade9) {
                const hs = s.highScoreStats || { count: 0, ratio: 0, score: 0 };
                row.push(hs.count, getExcelPercent(hs.ratio), getExcelNum(hs.score));
            }

            // 插入原有赋分数据
            row.push(
                getExcelNum(m.ratedAvg), 
                getExcelNum(m.ratedExc), 
                getExcelNum(m.ratedPass), 
                getExcelNum(s.score2Rate), 
                s.rank2Rate
            );
            
            summaryData.push(row);
        });

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        // 调用装饰函数，传入 Worksheet 和 表头数组
        decorateExcelSheet(wsSummary, headerRow); 
        XLSX.utils.book_append_sheet(wb, wsSummary, "综合总表");
        
       // 遍历所有学科导出详情
        SUBJECTS.forEach(sub => {
            // 1. 先显式定义表头数组 (之前报错是因为这行可能被漏掉或写在了数组里)
            const subHeaders = ["学校名称", "实考人数", "平均分", "优秀率", "及格率", "均分排名", "优率排名", "及格排名"];
            
            // 2. 使用定义的表头初始化数据数组
            const subData = [subHeaders]; 
            
            const subList = Object.values(SCHOOLS).filter(s=>s.metrics[sub]).sort((a,b)=>(a.rankings[sub].avg - b.rankings[sub].avg));
            
            subList.forEach(s => { 
                const m = s.metrics[sub]; 
                const r = s.rankings[sub]; 
                subData.push([
                    s.name, 
                    m.count, 
                    getExcelNum(m.avg), 
                    getExcelPercent(m.excRate), 
                    getExcelPercent(m.passRate), 
                    r.avg, 
                    r.excRate, 
                    r.passRate
                ]); 
            });
            
            const wsSub = XLSX.utils.aoa_to_sheet(subData);
            
            // 3. 应用样式 (现在 subHeaders 已经有定义了，不会报错)
            decorateExcelSheet(wsSub, subHeaders);
            
            XLSX.utils.book_append_sheet(wb, wsSub, sub);
        });
        
        XLSX.writeFile(wb, `乡镇宏观分析_${CONFIG.name}.xlsx`);
    }

    // --- 增值性评价逻辑 ---

    let VA_VIEW_MODE = 'school'; // school | class

    function switchValueAddedView(mode, btn) {
        VA_VIEW_MODE = mode;
        
        // 1. 切换按钮自身的激活状态 (视觉反馈)
        // 找到同一组的所有按钮 (它们都在同一个父容器里)
        const siblings = btn.parentNode.querySelectorAll('.btn');
        siblings.forEach(b => {
            b.classList.remove('active');
            // 恢复默认样式 (白底灰字)
            b.style.backgroundColor = 'white';
            b.style.color = '#64748b';
        });
        
        // 设置当前按钮为激活样式 (蓝底白字)
        btn.classList.add('active');
        btn.style.backgroundColor = '#e0f2fe';
        btn.style.color = '#0369a1';
        // 重新渲染表格
        renderValueAddedReport(true);
    }

    function renderValueAddedReport(isSwitching = false) {
        // 1. 检查数据源
        if (!PROGRESS_CACHE || PROGRESS_CACHE.length === 0) {
            // 尝试自动检查是否已有数据
            if (PREV_DATA.length > 0 && RAW_DATA.length > 0) {
                 // 如果有数据但没生成缓存，提示用户去那个模块点一下，或者这里自动调用（为了安全起见，提示用户）
                 document.getElementById('va-data-status').innerHTML = '⚠️ 已有数据，正在后台计算...';
                 // 自动执行一次匹配逻辑 (借用 renderProgressAnalysis 的逻辑，但不画图)
                 // 这里为了简化，我们直接基于 PREV_DATA 和 RAW_DATA 现场算一遍核心数据
                 performSilentMatching();
            } else {
                 if(!isSwitching) alert("❌ 无法生成：请先在【进退步追踪】模块上传“上次考试”数据！");
                 document.getElementById('va-data-status').innerHTML = '❌ 缺上次考试数据';
                 return;
            }
        }
        document.getElementById('va-data-status').innerHTML = '✅ 数据就绪';

        // 2. 聚合数据
        const stats = {};
        
        PROGRESS_CACHE.forEach(p => {
            // 确定分组键：是按学校还是按班级
            let key = "";
            let name = "";
            if (VA_VIEW_MODE === 'school') {
                // 根据当前学生找学校名
                // PROGRESS_CACHE 里可能没有存 school 字段，需要回溯 RAW_DATA 找，或者我们在 performSilentMatching 里补全
                const stuObj = RAW_DATA.find(r => r.name === p.name && r.class === p.class); 
                if (stuObj) key = stuObj.school;
                else key = "未知学校";
                name = key;
            } else {
                key = p.class; // 班级
                // 尝试附加学校名以防班级重名
                const stuObj = RAW_DATA.find(r => r.name === p.name && r.class === p.class);
                if (stuObj) name = `${stuObj.school} ${p.class}`;
                else name = p.class;
            }

            if (!stats[name]) {
                stats[name] = { name: name, count: 0, sumPrev: 0, sumCurr: 0 };
            }
            stats[name].count++;
            stats[name].sumPrev += p.prevRank;
            stats[name].sumCurr += p.currRank;
        });

        // 3. 计算增值指标
        const reportData = Object.values(stats).map(item => {
            const avgPrev = item.sumPrev / item.count;
            const avgCurr = item.sumCurr / item.count;
            const valueAdded = avgPrev - avgCurr; // 正数表示排名向前移动（变小）
            return {
                name: item.name,
                count: item.count,
                entryAvg: avgPrev,
                exitAvg: avgCurr,
                valueAdded: valueAdded
            };
        });

        // 4. 排序 (按增值从高到低)
        reportData.sort((a, b) => b.valueAdded - a.valueAdded);
        reportData.forEach((d, i) => d.rank = i + 1);

        // 5. 渲染表格
        const tbody = document.querySelector('#tb-value-added tbody');
        let html = '';
        reportData.forEach(d => {
            const vaFixed = d.valueAdded.toFixed(1);
            let colorClass = d.valueAdded > 0 ? 'text-green' : (d.valueAdded < 0 ? 'text-red' : '');
            let sign = d.valueAdded > 0 ? '+' : '';
            
            // 评价标签
            let evalTag = '';
            if (d.valueAdded >= 50) evalTag = '<span class="badge" style="background:#16a34a">🚀 卓越增值</span>';
            else if (d.valueAdded >= 10) evalTag = '<span class="badge" style="background:#2563eb">📈 有效提升</span>';
            else if (d.valueAdded <= -50) evalTag = '<span class="badge" style="background:#dc2626">📉 严重滑坡</span>';
            else evalTag = '<span class="badge" style="background:#94a3b8">➖ 保持稳定</span>';

            html += `
                <tr>
                    <td style="font-weight:bold;">${d.name}</td>
                    <td>${d.count}</td>
                    <td style="color:#666;">${d.entryAvg.toFixed(1)}</td>
                    <td style="color:#333;">${d.exitAvg.toFixed(1)}</td>
                    <td style="font-size:16px; font-weight:bold;" class="${colorClass}">${sign}${vaFixed}</td>
                    <td>${evalTag}</td>
                    <td class="rank-cell ${d.rank<=3 ? 'r-'+d.rank : ''}">${d.rank}</td>
                </tr>
            `;
        });
        
        if (reportData.length === 0) html = '<tr><td colspan="7" style="text-align:center;">暂无匹配数据</td></tr>';
        tbody.innerHTML = html;
        
        // 缓存供导出用
        window.LAST_VA_DATA = reportData;
    }

    // 后台静默匹配 (如果用户没点进退步分析，这里补做一次匹配)
    function performSilentMatching() {
        if (!PREV_DATA.length || !RAW_DATA.length) return;
        PROGRESS_CACHE = [];
        // 简单的姓名匹配逻辑
        RAW_DATA.forEach(curr => {
            // 尝试匹配：优先全名+学校，其次全名
            let prev = PREV_DATA.find(p => p.name === curr.name && p.school === curr.school);
            if (!prev) prev = PREV_DATA.find(p => p.name === curr.name); // 宽松匹配
            
            if (prev) {
                const currRank = safeGet(curr, 'ranks.total.township', 0);
                // 只有当两者都有有效排名时才算
                if (currRank > 0 && prev.rank > 0) {
                    PROGRESS_CACHE.push({
                        school: curr.school, // 补全学校信息
                        class: curr.class,
                        name: curr.name,
                        currRank: currRank,
                        prevRank: prev.rank,
                        change: prev.rank - currRank
                    });
                }
            }
        });
    }

    function exportValueAddedExcel() {
        if (!window.LAST_VA_DATA || window.LAST_VA_DATA.length === 0) return alert("请先生成报表");
        
        const wb = XLSX.utils.book_new();
        const data = [['单位名称', '匹配人数', '入口均位(上次排名)', '出口均位(本次排名)', '平均增值(名次)', '增值排名']];
        
        window.LAST_VA_DATA.forEach(d => {
            data.push([d.name, d.count, d.entryAvg.toFixed(2), d.exitAvg.toFixed(2), d.valueAdded.toFixed(2), d.rank]);
        });

        // 列宽设置
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = [{wch:20}, {wch:10}, {wch:15}, {wch:15}, {wch:15}, {wch:10}];
        
        XLSX.utils.book_append_sheet(wb, ws, "增值性评价表");
        XLSX.writeFile(wb, `增值性评价报表_${VA_VIEW_MODE === 'school' ? '学校' : '班级'}.xlsx`);
    }

    function exportSummaryTable() {
        if(!Object.keys(SCHOOLS).length) return alert("无数据");
        
        const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
        
        // 1. 准备数据
        const list = Object.values(SCHOOLS).map(s => {
            const s1 = s.score2Rate || 0;
            const s2 = s.scoreBottom || 0;
            const s3 = s.scoreInd || 0;
            // 获取高分赋分
            const s4 = (isGrade9 && s.highScoreStats) ? (s.highScoreStats.score || 0) : 0;
            // 计算包含高分赋分的总分
            const total = s1 + s2 + s3 + s4;
            
            return { name: s.name, s1, s2, s3, s4, total };
        });
        
        // 2. 排序
        list.sort((a,b) => b.total - a.total).forEach((d,i) => d.rank = i+1);
        
        const wb = XLSX.utils.book_new();
        
        // 3. 构建表头
        const headers = ["学校名称", "两率一分得分", "后1/3得分", "指标生得分"];
        if (isGrade9) headers.push("高分段赋分(70)");
        headers.push("综合总分", "总排名");
        
        const wsData = [headers];
        
        // 4. 填充数据
        list.forEach(d => { 
            const row = [
                d.name, 
                getExcelNum(d.s1), 
                getExcelNum(d.s2), 
                getExcelNum(d.s3)
            ];
            
            // 如果是9年级，插入高分赋分列数据
            if (isGrade9) row.push(getExcelNum(d.s4));
            
            row.push(getExcelNum(d.total), d.rank);
            
            wsData.push(row); 
        });
        
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "综合分析报告");
        XLSX.writeFile(wb, `综合分析报告_${CONFIG.name}.xlsx`);
    }

async function exportPPTReport() {
        if (!Object.keys(SCHOOLS).length || !Object.values(SCHOOLS)[0].score2Rate) {
            alert("请先上传数据并点击【生成总排名】按钮，确保所有指标已计算。"); return;
        }
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9'; pptx.author = '成绩分析系统'; pptx.title = `${CONFIG.name} 成绩分析报告`;
        const COLORS = { primary: "2563EB", light: "EFF6FF", header: "1E293B", text: "333333" };

        // 母版
        pptx.defineSlideMaster({
            title: 'MASTER_SLIDE', background: { color: "FFFFFF" },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.15, fill: COLORS.primary } },
                { text: { text: "内部资料 · 仅供教研", x: 0.5, y: 7.2, w: 3, h: 0.3, fontSize: 10, color: "94A3B8" } },
                { text: { text: "生成日期: " + new Date().toLocaleDateString(), x: 10.5, y: 7.2, w: 2.5, h: 0.3, fontSize: 10, color: "94A3B8", align: 'right' } }
            ], slideNumber: { x: 12.8, y: 7.2, fontSize: 10, color: "94A3B8" }
        });

        // 1. 封面
        let slide = pptx.addSlide(); slide.background = { color: COLORS.light };
        slide.addText(`${CONFIG.name} 教学质量分析报告`, { x: 1, y: 2.5, w: "80%", h: 1, fontSize: 36, bold: true, color: COLORS.primary, align: 'center', fontFace: "微软雅黑" });
        slide.addText(`数据范围：${Object.keys(SCHOOLS).length} 所学校 | ${RAW_DATA.length} 名学生`, { x: 1, y: 3.5, w: "80%", h: 0.5, fontSize: 18, color: COLORS.header, align: 'center' });
        slide.addText("教务处 / 自动生成", { x: 1, y: 6, w: "80%", h: 0.5, fontSize: 14, color: "64748b", align: 'center' });

        // 2. 总排名表
        slide = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
        slide.addText("🏆 综合考核总排名", { x: 0.5, y: 0.5, fontSize: 20, bold: true, color: COLORS.primary });
        const summaryList = Object.values(SCHOOLS).sort((a,b) => (a.rank2Rate||999) - (b.rank2Rate||999));
        const headers = [
            { text: "排名", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "学校", options: { fill: COLORS.primary, color: "FFFFFF", bold: true } },
            { text: "参考人数", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "综合均分", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "优秀率", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "及格率", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "总考核分", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } }
        ];
        const rows = [headers];
        summaryList.forEach((s, i) => {
            const m = s.metrics.total || {}; const bg = (i % 2 !== 0) ? "F8FAFC" : "FFFFFF"; const rankColor = i < 3 ? "DC2626" : "333333";
            rows.push([
                { text: i + 1, options: { fill: bg, color: rankColor, bold: i < 3, align: 'center' } },
                { text: s.name, options: { fill: bg, color: "333333", bold: true } },
                { text: m.count || 0, options: { fill: bg, align: 'center' } },
                { text: m.avg ? m.avg.toFixed(2) : '-', options: { fill: bg, align: 'center' } },
                { text: m.excRate ? (m.excRate * 100).toFixed(2) + '%' : '-', options: { fill: bg, align: 'center' } },
                { text: m.passRate ? (m.passRate * 100).toFixed(2) + '%' : '-', options: { fill: bg, align: 'center' } },
                { text: (s.score2Rate || 0).toFixed(2), options: { fill: bg, color: "B45309", bold: true, align: 'center' } }
            ]);
        });
        slide.addTable(rows, { x: 0.5, y: 1.2, w: 12.3, fontSize: 11, border: { pt: 1, color: "E2E8F0" } });

        // 3. 全科对比图
        slide = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
        slide.addText("📊 全镇各校平均分对比", { x: 0.5, y: 0.5, fontSize: 20, bold: true, color: COLORS.primary });
        slide.addChart(pptx.ChartType.bar, [{ name: "平均分", labels: summaryList.map(s => s.name), values: summaryList.map(s => s.metrics.total ? Number(s.metrics.total.avg.toFixed(2)) : 0) }], { x: 0.5, y: 1.2, w: 12.3, h: 5.5, barDir: 'col', barGapWidthPct: 50, chartColors: [COLORS.primary], dataLabelFormatCode: "0.0", dataLabelPosition: "outEnd", showValue: true, showLegend: false });

        // 4. 各科循环
        SUBJECTS.forEach(sub => {
            const subSlide = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
            subSlide.addText(`📘 学科分析：${sub}`, { x: 0.5, y: 0.5, fontSize: 20, bold: true, color: COLORS.primary });
            const subData = Object.values(SCHOOLS).filter(s => s.metrics[sub]).sort((a, b) => b.metrics[sub].avg - a.metrics[sub].avg);
            if(subData.length === 0) return;
            // 表格
            const subHeaders = [{ text: "排名", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "学校", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "均分", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "优率%", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "及格%", options: { fill: "E0F2FE", color: "0369A1", bold: true } }];
            const subRows = [subHeaders];
            subData.forEach((s, i) => { const m = s.metrics[sub]; subRows.push([i + 1, s.name, m.avg.toFixed(1), (m.excRate * 100).toFixed(1), (m.passRate * 100).toFixed(1)]); });
            subSlide.addTable(subRows, { x: 0.5, y: 1.2, w: 6, fontSize: 10, rowH: 0.4, border: { color: "CBD5E1" } });
            // 图表
            subSlide.addChart(pptx.ChartType.bar, [{ name: "均分", labels: subData.map(s => s.name), values: subData.map(s => s.metrics[sub].avg) }], { x: 7, y: 1.2, w: 5.8, h: 5, barDir: 'bar', chartColors: ["16A34A"], showValue: true, dataLabelPosition: "outEnd", showLegend: false, title: { text: `${sub} - 校际排名`, fontSize: 12 } });
            // 诊断
            const top = subData[0], bot = subData[subData.length - 1];
            subSlide.addText(`诊断：${sub}最高分 ${top.name}(${top.metrics[sub].avg.toFixed(1)})，最低分 ${bot.name}，极差 ${(top.metrics[sub].avg - bot.metrics[sub].avg).toFixed(1)}分。`, { x: 0.5, y: 6.5, w: 12, h: 0.5, fontSize: 11, color: "666666", italic: true, fill: "F1F5F9" });
        });

        pptx.writeFile({ fileName: `${CONFIG.name}_成绩汇报_${new Date().toISOString().slice(0,10)}.pptx` });
    }

    function exportTeacherComparisonExcel() {
        if (Object.keys(TEACHER_STATS).length === 0) return alert("请先进行教师分析");
        const gradeAverages = {}; SUBJECTS.forEach(subject => { if (SCHOOLS[MY_SCHOOL] && SCHOOLS[MY_SCHOOL].metrics[subject]) { gradeAverages[subject] = SCHOOLS[MY_SCHOOL].metrics[subject]; } });
        const wb = XLSX.utils.book_new();
        const wsData = [["教师姓名", "学科", "任教班级", "人数", "平均分(实际)", "与级比", "校排", "优秀率(实际)", "与级比", "校排", "及格率(实际)", "与级比", "校排", "综合得分", "综合排名"]];
        const subjectTeachers = {};
        Object.keys(TEACHER_STATS).forEach(teacher => {
            Object.keys(TEACHER_STATS[teacher]).forEach(subject => {
                if (!subjectTeachers[subject]) subjectTeachers[subject] = [];
                const data = TEACHER_STATS[teacher][subject]; const gradeAvg = gradeAverages[subject] || { avg: 0, excRate: 0, passRate: 0 };
                const avgComparison = gradeAvg.avg ? ((parseFloat(data.avg) - gradeAvg.avg) / gradeAvg.avg) : 0; 
                const excComparison = gradeAvg.excRate ? ((data.excellentRate - gradeAvg.excRate) / gradeAvg.excRate) : 0;
                const passComparison = gradeAvg.passRate ? ((data.passRate - gradeAvg.passRate) / gradeAvg.passRate) : 0;
                subjectTeachers[subject].push({ teacher, data, avgComparison, excComparison, passComparison });
            });
        });
        Object.keys(subjectTeachers).sort(sortSubjects).forEach(subject => {
            const arr = subjectTeachers[subject];
            const setRank = (key, rankKey) => { arr.sort((a,b)=> parseFloat(b.data[key]) - parseFloat(a.data[key])).forEach((item,i)=>item[rankKey]=i+1); };
            setRank('avg','avgRank'); setRank('excellentRate','excRank'); setRank('passRate','passRank');
            arr.forEach(item => { item.compositeScore = ((1-(item.avgRank-1)/arr.length)*50 + (1-(item.excRank-1)/arr.length)*30 + (1-(item.passRank-1)/arr.length)*20); });
            arr.sort((a, b) => b.compositeScore - a.compositeScore).forEach((item, index) => { item.compositeRank = index + 1; });
            arr.forEach(item => {
                const data = item.data;
                wsData.push([item.teacher, subject, data.classes, data.studentCount, getExcelNum(parseFloat(data.avg)), getExcelPercent(item.avgComparison), item.avgRank, getExcelPercent(data.excellentRate), getExcelPercent(item.excComparison), item.excRank, getExcelPercent(data.passRate), getExcelPercent(item.passComparison), item.passRank, getExcelNum(item.compositeScore), item.compositeRank]);
            });
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "教师详细对比");
        XLSX.writeFile(wb, "教师详细数据对比表.xlsx");
    }

    function exportTeacherTownshipRankExcel() {
        if(!Object.keys(TOWNSHIP_RANKING_DATA).length) return alert("无排名数据");
        const wb = XLSX.utils.book_new();
        SUBJECTS.forEach(sub => {
            const data = TOWNSHIP_RANKING_DATA[sub];
            if(!data) return;
            const wsData = [["教师/学校", "类型", "平均分", "镇排", "优秀率", "镇排", "及格率", "镇排"]];
            data.forEach(item => { wsData.push([item.name, item.type === 'teacher' ? '教师' : '学校', getExcelNum(item.avg), item.rankAvg, getExcelPercent(item.excellentRate), item.rankExc, getExcelPercent(item.passRate), item.rankPass]); });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), sub);
        });
        XLSX.writeFile(wb, "教师乡镇排名.xlsx");
    }

    // ================= 报告查询逻辑（打印增强） =================
    function doQuery() {
        const name = document.getElementById('inp-name').value; 
        const sch = document.getElementById('sel-school').value; 
        const cls = document.getElementById('sel-class').value;
        
        let stu = SCHOOLS[sch]?.students.find(s => s.name === name && (cls === '--请先选择学校--' || s.class === cls));
        if(!stu) return alert("未找到该学生");
        CURRENT_REPORT_STUDENT = stu;
        
        document.getElementById('single-report-result').classList.remove('hidden'); 
        const container = document.getElementById('report-card-capture-area');
        
        // 强制使用 'A4' 模式进行渲染，这样打印出来的效果最好
        container.innerHTML = renderSingleReportCardHTML(stu, 'A4');
        
        setTimeout(() => { renderRadarChart(stu); renderVarianceChart(stu);}, 100); 
        analyzeStrengthsAndWeaknesses(stu);
    }

    function updateMutualAidSelects() {
        const source = document.getElementById('aid_source').value;
        const schSel = document.getElementById('aidSchoolSelect'); 
        const clsSel = document.getElementById('aidClassSelect');
        const subSel = document.getElementById('aidSubjectSelect');
        schSel.innerHTML = ''; clsSel.innerHTML = '<option value="">--班级--</option>'; subSel.innerHTML = '';
        if (source === 'freshman') {
            schSel.disabled = true; schSel.innerHTML = '<option value="SIM">🚀 新生模拟数据</option>';
            subSel.innerHTML = '<option value="total">入学总分</option>'; subSel.disabled = true;
            if (Object.keys(FB_SIMULATED_DATA).length > 0) { Object.keys(FB_SIMULATED_DATA).sort().forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`); } else { clsSel.innerHTML = '<option value="">(暂无数据)</option>'; }
        } else {
            schSel.disabled = false; schSel.innerHTML = '<option value="">--请选择学校--</option>'; 
            Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`);
            schSel.onchange = () => { clsSel.innerHTML = '<option value="">--班级--</option>'; if(schSel.value && SCHOOLS[schSel.value]) { const classes = [...new Set(SCHOOLS[schSel.value].students.map(s => s.class))].sort(); classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`); } };
            subSel.disabled = false; subSel.innerHTML = '<option value="total">总分(综合)</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
        }
    }

    function renderMutualAidGroups() {
        const source = document.getElementById('aid_source').value;
        const sch = document.getElementById('aidSchoolSelect').value; 
        const cls = document.getElementById('aidClassSelect').value;
        const sub = document.getElementById('aidSubjectSelect').value;
        const groupSize = parseInt(document.getElementById('aidGroupSize').value) || 4;
        let students = [];
        if (source === 'freshman') {
            if(!cls || !FB_SIMULATED_DATA[cls]) return alert("无分班数据");
            students = FB_SIMULATED_DATA[cls].map(s => ({...s, class: cls, total: s.score, scores: {total: s.score}, ranks: {total: {class: 0}}}));
        } else {
            if(!sch || !cls) return alert("请选择学校和班级");
            students = JSON.parse(JSON.stringify(SCHOOLS[sch].students.filter(s => s.class === cls)));
        }
        if(students.length < groupSize) return alert("班级人数不足以分组");
        const getScore = (s) => (sub === 'total' ? s.total : (s.scores[sub] || 0));
        students.sort((a, b) => getScore(b) - getScore(a));
        students.forEach((s, i) => s._subRankPct = (i + 1) / students.length);
        let totalSorted = [...students].sort((a, b) => b.total - a.total);
        totalSorted.forEach((s, i) => { let target = students.find(x => x.name === s.name); if(target) target._totalRankPct = (i + 1) / students.length; });
        let mentors = students.filter(s => s._subRankPct <= 0.25 && s._totalRankPct <= 0.40);
        if (mentors.length < (students.length / groupSize) * 0.5) { mentors = students.filter(s => s._subRankPct <= 0.25 && s._totalRankPct <= 0.50); }
        const targetGroupCount = Math.ceil(students.length / groupSize);
        if (mentors.length < targetGroupCount) { mentors = students.slice(0, targetGroupCount); }
        mentors = mentors.slice(0, targetGroupCount);
        let remaining = students.filter(s => !mentors.includes(s));
        let groups = mentors.map((m, i) => ({ id: i + 1, leader: m, members: [] }));
        remaining.sort((a, b) => getScore(b) - getScore(a));
        let direction = 1; let gIdx = 0;
        while(remaining.length > 0) {
            let student = remaining.shift(); groups[gIdx].members.push(student);
            gIdx += direction;
            if (gIdx >= groups.length) { gIdx = groups.length - 1; direction = -1; } else if (gIdx < 0) { gIdx = 0; direction = 1; }
        }
        AID_GROUPS_CACHE = groups;
        renderAidGroupsHTML(groups, sub);
    }

    function renderAidGroupsHTML(groups, sub) {
        const container = document.getElementById('aid-groups-container'); container.innerHTML = '';
        groups.forEach(g => {
            const allScores = [g.leader, ...g.members].map(s => sub==='total'?s.total:(s.scores[sub]||0)); const avg = allScores.reduce((a,b)=>a+b,0) / allScores.length;
            let membersHtml = '';
            g.members.forEach(m => {
                const score = sub==='total'?m.total:(m.scores[sub]||0); let tag = ''; if (m._subRankPct > 0.8) tag = `<span class="aid-tag tag-weak">需帮扶</span>`;
                membersHtml += `<div class="aid-role-row aid-member"><div class="aid-avatar">${m.name[0]}</div><div class="aid-info"><div class="aid-name">${m.name} ${tag}</div><div class="aid-score">${sub}: ${score}</div></div></div>`;
            });
            const leaderScore = sub==='total'?g.leader.total:(g.leader.scores[sub]||0);
            const card = document.createElement('div'); card.className = 'aid-card';
            card.innerHTML = `<div class="aid-header"><span>第 ${g.id} 组</span><span style="font-weight:normal; color:#666;">均分: ${avg.toFixed(1)}</span></div><div class="aid-body"><div class="aid-role-row aid-leader"><div class="aid-avatar">组</div><div class="aid-info"><div class="aid-name">${g.leader.name} <span class="aid-tag tag-strong">组长</span></div><div class="aid-score">${sub}: ${leaderScore}</div></div></div>${membersHtml}</div>`; container.appendChild(card);
        });
    }

    function exportMutualAidGroups() {
        if(AID_GROUPS_CACHE.length === 0) return alert("请先生成分组");
        const wb = XLSX.utils.book_new(); const data = [['组号', '角色', '姓名', '参考分数']];
        AID_GROUPS_CACHE.forEach(g => {
            const sub = document.getElementById('aidSubjectSelect').value; const getS = (s) => sub==='total'?s.total:(s.scores[sub]||0);
            data.push([g.id, '组长', g.leader.name, getS(g.leader)]);
            g.members.forEach(m => { data.push([g.id, '组员', m.name, getS(m)]); });
            data.push(['', '', '', '']);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "学科互助分组"); XLSX.writeFile(wb, "互助分组名单.xlsx");
    }

    function generateAIComment(student) {
        const style = 'encouraging'; 
        const teacherName = '老师'; // 默认称呼
        const totalRank = safeGet(student, 'ranks.total.township', 99999); const totalStudents = RAW_DATA.length || 1; const percentile = totalRank / totalStudents;
        let progress = 0; if(PROGRESS_CACHE.length > 0) { const progRecord = PROGRESS_CACHE.find(p => p.name === student.name && p.class === student.class); if(progRecord) progress = progRecord.change; }
        let bestSub = { name: '', rank: 99999 }; let worstSub = { name: '', rank: 0 };
        SUBJECTS.forEach(sub => { const r = safeGet(student, `ranks.${sub}.township`, 0); if(r > 0) { if(r < bestSub.rank) bestSub = { name: sub, rank: r }; if(r > worstSub.rank) worstSub = { name: sub, rank: r }; } });
        const isPartial = (worstSub.rank - bestSub.rank) > (totalStudents * 0.4);
        const phrases = {
            opening: { top: [`${student.name}同学，你一直是班级的领头羊。`, `你优秀的成绩证明了你的努力和天赋。`], mid: [`${student.name}同学，你是一个潜力巨大的学生。`, `你的成绩保持在班级中游，基础比较扎实。`], low: [`${student.name}同学，老师看到了你身上的闪光点。`, `虽然目前的成绩不尽如人意，但只要不放弃，总有希望。`] },
            progress: { up: [`本次考试你进步了${progress}名，这是你辛勤付出的回报！`, `欣喜地看到你的排名在稳步上升，继续保持！`], down: [`本次排名有所下滑，我们需要一起找找原因。`, `最近是不是有些分心？成绩出现了一点波动。`], flat: [`你的成绩非常稳定，保持这种状态很难得。`] },
            subjects: { partial: [`你的${bestSub.name}非常有优势，但${worstSub.name}稍微拖了后腿，如果能平衡一下，总分会更高。`, `要警惕偏科现象，${worstSub.name}学科需要投入更多精力。`], balanced: [`各科发展比较均衡，没有明显的短板，这是你的核心竞争力。`, `全面发展是你最大的优势，请继续保持这种良好的学习节奏。`] },
            advice: { encouraging: [`相信自己，你一定行！${teacherName}老师会一直支持你。`, `期待在下次光荣榜上看到更耀眼的你！`] }
        };
        let parts = []; let tier = 'mid'; if(percentile <= 0.15) tier = 'top'; else if(percentile >= 0.75) tier = 'low';
        parts.push(phrases.opening[tier][Math.floor(Math.random() * phrases.opening[tier].length)]);
        if(Math.abs(progress) >= 10) { let pType = progress > 0 ? 'up' : 'down'; parts.push(phrases.progress[pType][Math.floor(Math.random() * phrases.progress[pType].length)]); } else { if(Math.random() > 0.5) parts.push(phrases.progress.flat[Math.floor(Math.random() * phrases.progress.flat.length)]); }
        if(isPartial) { parts.push(phrases.subjects.partial[Math.floor(Math.random() * phrases.subjects.partial.length)]); } else { parts.push(phrases.subjects.balanced[Math.floor(Math.random() * phrases.subjects.balanced.length)]); }
        parts.push(phrases.advice[style][Math.floor(Math.random() * phrases.advice[style].length)]);
        return parts.join("");
    }

    function findPreviousRecord(student) {
        // 1. 基础检查
        if (!window.PREV_DATA || window.PREV_DATA.length === 0) {
            console.warn("历史数据(PREV_DATA)为空，无法进行对比。请先上传历史成绩。");
            return null;
        }

        // 2. 标准化工具函数 (清洗数据)
        const cleanStr = (str) => String(str || "").trim().replace(/\s+/g, ""); // 去空格
        const normalizeClass = (cls) => {
            let s = String(cls || "").trim();
            // 移除 "班", "级", "(", ")", ".", "-", "grade", "class"
            return s.replace(/[班级\(\)\.\-gradeclass]/gi, "");
        };

        const targetName = cleanStr(student.name);
        const targetClass = normalizeClass(student.class);
        const targetSchool = student.school;

        // 3. 在历史库中查找
        const match = window.PREV_DATA.find(p => {
            // A. 校内模式：必须匹配学校 (如果历史数据有学校字段)
            if (p.school && targetSchool && p.school !== targetSchool) return false;

            // B. 姓名匹配 (严格匹配清洗后的姓名)
            if (cleanStr(p.name) !== targetName) return false;

            // C. 班级智能匹配 (核心修复点)
            // 将 "7.1", "701", "7年级1班" 都清洗为 "71" 或 "701" 进行比对
            const histClass = normalizeClass(p.class);
            
            // 规则1: 完全相等
            if (histClass === targetClass) return true;
            
            // 规则2: 处理 "0" 的差异 (例如 71 vs 701)
            // 如果两个班级号都包含数字，且去掉0后相等，视为匹配 (存在风险，但在同一年级内通常安全)
            const numC1 = histClass.replace(/0/g, '');
            const numC2 = targetClass.replace(/0/g, '');
            if (numC1 === numC2 && numC1.length > 0) return true;

            return false;
        });

        if (!match) {
            // 调试日志：如果你发现某人没匹配上，按F12看控制台会显示原因
            // console.log(`未找到历史记录: ${student.name} (班级:${targetClass})`);
        } else {
            // console.log(`匹配成功: ${student.name} -> 上次分: ${match.total}`);
        }

        return match;
    }

    // 🟢 [新增]：生成进退步胶囊标签 (Windows 风格)
    function getTrendBadge(current, previous, type = 'score') {
        if (previous === undefined || previous === null || previous === '-' || previous === '') return '';
        
        // 确保数值类型
        const currVal = parseFloat(current);
        const prevVal = parseFloat(previous);
        if (isNaN(currVal) || isNaN(prevVal)) return '';

        const diff = currVal - prevVal;
        if (Math.abs(diff) < 0.01) return `<span style="color:#94a3b8; font-size:11px; margin-left:4px; font-weight:normal;">(持平)</span>`;

        let color = '';
        let icon = '';
        let bg = '';
        
        if (type === 'score') {
            // 分数：正数=进步(绿), 负数=退步(红/橙)
            if (diff > 0) { color = '#15803d'; bg = '#dcfce7'; icon = '▲'; } 
            else { color = '#b91c1c'; bg = '#fee2e2'; icon = '▼'; }
        } else {
            // 排名：负数=进步(名次变小), 正数=退步(名次变大)
            if (diff < 0) { color = '#15803d'; bg = '#dcfce7'; icon = '▲'; } // 排名上升
            else { color = '#b91c1c'; bg = '#fee2e2'; icon = '▼'; }          // 排名下降
        }

        const absDiff = Math.abs(diff);
        // Windows 11 风格圆角胶囊
        return `<span style="display:inline-flex; align-items:center; background:${bg}; color:${color}; padding:1px 6px; border-radius:10px; font-size:11px; font-weight:bold; margin-left:5px; vertical-align:middle;">
            ${icon} ${type==='score' ? absDiff.toFixed(1) : absDiff}
        </span>`;
    }
    
    // 1. 综合渲染入口：根据设备类型自动选择模板
    function renderSingleReportCardHTML(stu, mode) {
        // 1. 安卓 Canvas 兼容性兜底 (部分低版本安卓 WebView 无法渲染 Chart.js)
        // 如果是安卓且屏幕小，且没有 window.Chart 对象(极少数情况)，强制回退到 PC 版 HTML 表格
        const ua = navigator.userAgent.toLowerCase();
        const isAndroid = ua.includes('android');
        const isProblemAndroid = isAndroid && window.innerWidth <= 768 && !window.Chart;

        if (isProblemAndroid) {
            console.warn('⚠️ Android Canvas 异常，强制切换 PC 模式');
            // 递归调用自己，传入 'PC' 模式以跳过下方的 Mobile 判断
            return renderSingleReportCardHTML(stu, 'PC');
        }

        // 2. 判断是否为手机端 (或显式请求 IG 模式)
        const isMobile = window.innerWidth <= 768; 
        
        if (isMobile || mode === 'IG') {
            // A. 获取 HTML 字符串
            const html = renderInstagramCard(stu);
            
            // B. 关键：设置延时回调，在 HTML 插入 DOM 后绘制 Canvas 图表
            // 必须使用 setTimeout，否则此时 canvas 元素还不存在于页面上
            setTimeout(() => {
                if (typeof renderIGCharts === 'function') {
                    renderIGCharts(stu);
                }
            }, 50);

            // C. 返回 HTML 字符串
            return html;
        }

        // --- 否则：渲染原有的 PC 端 Fluent Design 风格 (A4打印版) ---
        const totalStudentsCount = RAW_DATA.length; 
        const genDate = new Date().toLocaleDateString(); 
        
        // 获取对比数据
        const prevStu = findPreviousRecord(stu); 
        
        // 排名数据准备
        const curTownRank = safeGet(stu, 'ranks.total.township', '-');
        const prevTownRank = prevStu ? (prevStu.townRank || '-') : '-';
        const curClassRank = safeGet(stu, 'ranks.total.class', '-');
        const prevClassRank = prevStu ? (prevStu.classRank || '-') : '-';
        const curSchoolRank = safeGet(stu, 'ranks.total.school', '-');
        const prevSchoolRank = prevStu ? (prevStu.schoolRank || '-') : '-';

        // 单校判断
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;
        const townColStyle = isSingleSchool ? 'display:none !important;' : '';

        // 构建表格行
        let tableRows = '';

        // A. 9年级五科总分行 (逻辑保持不变)
        if (CONFIG.name === '9年级') { 
            let fiveTotal = 0, count = 0; 
            ['语文', '数学', '英语', '物理', '化学'].forEach(sub => { 
                if (stu.scores[sub] !== undefined) { fiveTotal += stu.scores[sub]; count++; }
            }); 
            if (count > 0) { 
                tableRows += `<tr style="background:rgba(248,250,252,0.5);">
                    <td style="font-weight:bold; color:#475569;">🏁 核心五科</td>
                    <td style="font-weight:bold; color:#2563eb;">${fiveTotal.toFixed(1)}</td>
                    <td>-</td><td>-</td><td style="${townColStyle}">-</td>
                </tr>`; 
            } 
        }

        // B. 总分行
        const prevTotal = prevStu ? prevStu.total : '-';
        const trendTotal = getTrendBadge(stu.total, prevTotal, 'score');
        const trendClass = getTrendBadge(curClassRank, prevClassRank, 'rank');
        const trendSchool = getTrendBadge(curSchoolRank, prevSchoolRank, 'rank');
        const trendTown = getTrendBadge(curTownRank, prevTownRank, 'rank');

        tableRows += `<tr style="background:rgba(239,246,255,0.7); backdrop-filter:blur(4px); border-bottom:2px solid #fff;">
            <td style="font-weight:bold; color:#1e3a8a;">🏆 ${CONFIG.label}</td>
            <td style="font-weight:800; font-size:16px; color:#1e40af;">${stu.total.toFixed(2)} ${trendTotal}</td>
            <td style="font-weight:bold; color:#334155;">${curClassRank} ${trendClass}</td>
            <td style="font-weight:bold; color:#334155;">${curSchoolRank} ${trendSchool}</td>
            <td style="${townColStyle} font-weight:bold; color:#334155;">${curTownRank} ${trendTown}</td>
        </tr>`;

        // C. 单科行
        const uniqueSubjects = [...new Set(SUBJECTS)];
        uniqueSubjects.forEach(sub => {
            if (stu.scores[sub] !== undefined) {
                const prevSubScore = (prevStu && prevStu.scores) ? prevStu.scores[sub] : '-';
                const subTrend = getTrendBadge(stu.scores[sub], prevSubScore, 'score');
                
                let prevRanks = {};
                if (prevStu && prevStu.ranks && prevStu.ranks[sub]) prevRanks = prevStu.ranks[sub];
                
                const curCR = safeGet(stu, `ranks.${sub}.class`, '-');
                const tC = getTrendBadge(curCR, prevRanks.class || '-', 'rank');
                const curSR = safeGet(stu, `ranks.${sub}.school`, '-');
                const tS = getTrendBadge(curSR, prevRanks.school || '-', 'rank');
                const curTR = safeGet(stu, `ranks.${sub}.township`, '-');
                const tT = getTrendBadge(curTR, prevRanks.township || '-', 'rank');
                
                tableRows += `<tr style="transition:0.2s;" onmouseover="this.style.background='rgba(241,245,249,0.5)'" onmouseout="this.style.background='transparent'">
                    <td style="font-weight:600; color:#475569;">${sub}</td>
                    <td style="font-weight:bold; color:#334155;">${stu.scores[sub]} ${subTrend}</td>
                    <td style="color:#64748b;">${curCR} ${tC}</td>
                    <td style="color:#64748b;">${curSR} ${tS}</td>
                    <td style="color:#64748b; ${townColStyle}">${curTR} ${tT}</td>
                </tr>`;
            }
        });

        const fluentStyle = `
            
        `;

        return `
        ${fluentStyle}
        <div class="report-header" style="border-bottom:none; margin-bottom:10px; text-align:center;">
            <h3 style="font-family:'Microsoft YaHei', sans-serif; font-weight:800; color:#1e293b; letter-spacing:1px; margin:0;">${stu.school} 学生学业发展报告</h3>
            <p style="color:#94a3b8; font-size:12px; margin-top:5px;">生成日期: ${genDate}</p>
        </div>
        <div class="fluent-card" style="padding:15px 25px; background:linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; align-items:baseline; gap:15px;">
                    <span style="font-size:24px; font-weight:800; color:#1e3a8a;">${stu.name}</span>
                    <span style="font-size:14px; color:#475569; background:#fff; padding:2px 8px; border-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">${stu.class}</span>
                </div>
                <div style="font-size:13px; color:#64748b; font-family:monospace;">考号: ${stu.id}</div>
            </div>
        </div>
        <div class="fluent-card" style="padding:0; overflow:hidden;">
            <table class="fluent-table" id="tb-query">
                <thead><tr><th style="text-align:left; padding-left:20px;">科目</th><th>成绩 (对比)</th><th>班排</th><th>校排</th><th style="${townColStyle}">全镇排名</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
        <div style="display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
            <div class="fluent-card" style="flex:1; min-width:300px; margin-bottom:0; display:flex; flex-direction:column;">
                <div class="fluent-header"><i class="ti ti-radar" style="color:#2563eb;"></i><span class="fluent-title">综合素质评价 (百分位)</span></div>
                <div style="flex:1; position:relative; min-height:220px;"><canvas id="radarChart"></canvas></div>
            </div>            
            <div class="fluent-card" style="flex:1; min-width:300px; margin-bottom:0; display:flex; flex-direction:column;">
                <div class="fluent-header"><i class="ti ti-scale" style="color:#059669;"></i><span class="fluent-title">学科均衡度诊断 (Z-Score)</span></div>
                <div style="flex:1; position:relative; min-height:220px;"><canvas id="varianceChart"></canvas></div>
            </div> 
        </div>
        <div style="text-align:center; font-size:11px; color:#cbd5e1; margin-top:20px;">系统自动生成 · 仅供家校沟通参考</div>`;
    }

    // 2. 🟢 新增：生成 Instagram 风格卡片的函数 (Mobile Only)
    function renderInstagramCard(stu) {
        const genDate = new Date().toLocaleDateString();
        const totalStudents = RAW_DATA.length;
        const rank = safeGet(stu, 'ranks.total.township', '-');
        const pct = (typeof rank === 'number') ? ((1 - rank/totalStudents)*100).toFixed(0) : '-';
        const avatarLetter = stu.name.charAt(0); // 头像取首字
        
        // 判断是否为单校模式
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;
        const scopeText = isSingleSchool ? "全校" : "全镇";

        let statusTag = '';
        if (pct >= 90) statusTag = '🌟 卓越之星';
        else if (pct >= 75) statusTag = '🔥 进步飞速';
        else statusTag = '📚 持续努力';

        // 3. 构建单科评论行
        let commentsHtml = '';
        SUBJECTS.forEach(sub => {
            if (stu.scores[sub] !== undefined) {
                const score = stu.scores[sub];
                
                // 修改点 1：获取校内排名 (即年级排名/级排) 而不是班级排名 (.class)
                const subRank = safeGet(stu, `ranks.${sub}.school`, '-');
                
                commentsHtml += `
                    <div class="insta-comment-row">
                        <div>
                            <span class="insta-comm-user">${sub}</span>
                            <span class="insta-comm-text">成绩单</span>
                        </div>
                        <div>
                            <span class="insta-comm-score">${score}</span>
                            <!-- 修改点 2：显示文字改为 级排 -->
                            <span class="insta-comm-rank">级排#${subRank}</span>
                        </div>
                    </div>
                `;
            }
        });

// 新增：雷达图和均衡度图表的 Canvas 容器
        // 注意：这里只是占位，具体的图表将在 renderIGCharts 函数中绘制
        const chartsHtml = `
            <div style="margin-top: 20px; padding: 0 14px;">
                <!-- 雷达图容器 -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; margin-bottom: 15px;">
                    <div style="font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 10px; border-left: 4px solid #2563eb; padding-left: 8px;">
                        📊 学科能力雷达图
                    </div>
                    <div style="height: 250px; position: relative;">
                        <canvas id="igRadarChart"></canvas>
                    </div>
                </div>

                <!-- 均衡度容器 -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0;">
                    <div style="font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 10px; border-left: 4px solid #059669; padding-left: 8px;">
                        ⚖️ 学科均衡度诊断
                    </div>
                    <div style="height: 200px; position: relative;">
                        <canvas id="igVarianceChart"></canvas>
                    </div>
                    <div style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 5px;">
                        注：向右(绿)为优势学科，向左(红)为薄弱学科
                    </div>
                </div>
            </div>
        `;

        // 1. 定义一个内部函数，用于计算 Z-Score 并对科目进行分层 (强/中/弱)
        // 目的：为后续的“一句话诊断”、“优势清单”、“家长建议”提供数据支撑
        const getSubjectLevels = () => {
            let strong = [], weak = [], mid = [], zScores = [];

            SUBJECTS.forEach(sub => {
                if (stu.scores[sub] !== undefined) {
                    // A. 获取该科全镇数据 (用于计算标准分)
                    const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                    if (allScores.length < 2) return;

                    // B. 计算均值与标准差 (Standard Deviation)
                    const avg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                    const variance = allScores.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / allScores.length;
                    const sd = Math.sqrt(variance) || 1; // 防止除以0

                    // C. 计算标准分 Z-Score (反映该生在全体考生中的相对位置)
                    const z = (stu.scores[sub] - avg) / sd;
                    zScores.push(z);

                    // D. 分类 (阈值 0.8，约等于前20%和后20%)
                    const item = `${sub}`; // 仅存科目名
                    if (z >= 0.8) strong.push(item);      // 强科
                    else if (z <= -0.8) weak.push(item);  // 弱科
                    else mid.push(item);                  // 中等
                }
            });

            // 计算极差 (Range)，用于判断整体结构是“均衡”还是“偏科”
            const maxZ = zScores.length ? Math.max(...zScores) : 0;
            const minZ = zScores.length ? Math.min(...zScores) : 0;
            const range = maxZ - minZ;

            return { strong, weak, mid, range };
        };

        // 2. 执行计算，获取分层结果
        const levels = getSubjectLevels();

        // 3. 生成【模块④】一句话诊断文案
        const getDiagnosisText = (range) => {
            if (range >= 2.5) {
                // 极差大：严重偏科
                return {
                    tag: '⚠️ 严重偏科',
                    color: '#b91c1c', bg: '#fee2e2',
                    text: '不同学科成绩差异极大，存在明显优势科目与薄弱科目，需要针对性调整学习重心，补齐短板。'
                };
            } else if (range >= 1.2) {
                // 极差中：相对均衡
                return {
                    tag: '⚖️ 相对均衡',
                    color: '#0369a1', bg: '#e0f2fe',
                    text: '各学科成绩整体较为均衡，个别学科略有波动，保持稳定发挥是关键。'
                };
            } else {
                // 极差小：结构优秀
                return {
                    tag: '🌟 结构优秀',
                    color: '#15803d', bg: '#dcfce7',
                    text: '各学科发展极其均衡，无明显短板，心理素质稳定，是冲刺更高目标的理想状态。'
                };
            }
        };

        const diag = getDiagnosisText(levels.range);

        // --- 生成【模块④】HTML：一句话诊断 ---
        const igDiagnosisHtml = `
            <div style="margin: 15px 14px 0 14px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-weight:bold; color:#334155; font-size:14px;">🧠 学情结构诊断</span>
                    <span style="font-size:12px; background:${diag.bg}; color:${diag.color}; padding:2px 8px; border-radius:12px; font-weight:bold;">
                        ${diag.tag}
                    </span>
                </div>
                <div style="font-size:13px; color:#64748b; line-height:1.5;">
                    ${diag.text}
                </div>
            </div>
        `;

        // --- 生成【模块⑤】HTML：优势/短板折叠清单 ---
        // 辅助函数：生成列表项
        const renderListItems = (arr, emptyText) => {
            if (!arr || arr.length === 0) return `<div style="font-size:12px; color:#ccc; padding:5px;">${emptyText}</div>`;
            return arr.map(sub => 
                `<span style="display:inline-block; background:#f1f5f9; color:#334155; font-size:12px; padding:4px 10px; border-radius:4px; margin:0 5px 5px 0;">${sub}</span>`
            ).join('');
        };

        const igSubjectListHtml = `
            <div style="margin: 15px 14px 0 14px;">
                <!-- 优势科目 -->
                <details open style="margin-bottom:10px; background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
                    <summary style="padding:10px 15px; font-size:13px; font-weight:bold; color:#333; cursor:pointer; background:#f8fafc; list-style:none; display:flex; align-items:center;">
                        <span style="margin-right:8px;">☀️</span> 优势学科 (Z≥0.8)
                        <span style="margin-left:auto; font-size:10px; color:#999;">${levels.strong.length}科</span>
                    </summary>
                    <div style="padding:15px;">
                        ${renderListItems(levels.strong, '暂无明显优势学科，继续加油')}
                    </div>
                </details>

                <!-- 薄弱科目 -->
                <details ${levels.weak.length > 0 ? 'open' : ''} style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
                    <summary style="padding:10px 15px; font-size:13px; font-weight:bold; color:#333; cursor:pointer; background:#fff1f2; list-style:none; display:flex; align-items:center;">
                        <span style="margin-right:8px;">🌧️</span> 需关注学科 (Z≤-0.8)
                        <span style="margin-left:auto; font-size:10px; color:#dc2626;">${levels.weak.length}科</span>
                    </summary>
                    <div style="padding:15px;">
                        ${renderListItems(levels.weak, '暂无明显短板，保持均衡')}
                    </div>
                </details>
            </div>
        `;

        // --- 生成【模块⑥】HTML：家长执行建议 ---
        const getParentAdvice = () => {
            const adv = [];
            // 策略1：有弱科
            if (levels.weak.length > 0) {
                const subStr = levels.weak.join('、');
                adv.push(`🎯 <strong>精准攻坚：</strong>针对 ${subStr}，建议每天安排 15 分钟回归课本基础概念，不盲目刷题。`);
            }
            // 策略2：有强科
            if (levels.strong.length > 0) {
                const subStr = levels.strong.join('、');
                adv.push(`🛡️ <strong>保持自信：</strong>${subStr} 是孩子的信心来源，请多给予具体表扬，稳住优势。`);
            }
            // 策略3：全是中间 (均衡)
            if (levels.strong.length === 0 && levels.weak.length === 0) {
                adv.push(`🚀 <strong>寻找突破：</strong>目前成绩非常稳定。建议选定一门孩子最感兴趣的学科，尝试增加 5% 的投入，培养成优势学科。`);
            }
            // 通用建议
            adv.push(`📅 <strong>习惯养成：</strong>检查孩子是否养成了“先复习，后作业”的习惯。`);
            
            return adv.map(t => `<li style="margin-bottom:8px; line-height:1.5;">${t}</li>`).join('');
        };

        const igAdviceHtml = `
            <div style="margin: 15px 14px 20px 14px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px;">
                <div style="font-size:13px; font-weight:bold; color:#b45309; margin-bottom:10px; display:flex; align-items:center;">
                    <i class="ti ti-bulb" style="margin-right:5px; font-size:16px;"></i> 家长行动指南
                </div>
                <ul style="padding-left:15px; margin:0; font-size:12px; color:#78350f;">
                    ${getParentAdvice()}
                </ul>
            </div>
        `;

        // 模拟图表区域 (使用CSS渐变背景代替 Canvas，确保渲染稳定)
        const visualAreaHtml = `
            <div class="insta-visual-area">
                <div style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); border-radius:8px; color:white; padding:40px 0;">
                    <div style="font-size:16px; opacity:0.9; text-transform:uppercase; letter-spacing:2px;">Total Score</div>
                    <div style="font-size:64px; font-weight:800; text-shadow:0 4px 10px rgba(0,0,0,0.2);">${stu.total}</div>
                    <div style="margin-top:10px; font-size:18px; font-weight:bold; background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px;">
                        全校排名: ${safeGet(stu, 'ranks.total.school', '-')}
                    </div>
                    <div style="margin-top:20px; font-size:12px; opacity:0.8;">击败了${scopeText} ${pct}% 的考生</div>
                </div>
            </div>
        `;

        return `
            <div class="insta-view-container" style="background:#fafafa; padding-top:20px;">
                <div class="insta-card">
                    <!-- Header -->
                    <div class="insta-header">
                        <div class="insta-avatar-ring"><div class="insta-avatar">${avatarLetter}</div></div>
                        <div class="insta-user-info">
                            <div class="insta-username">${stu.name} <i class="ti ti-discount-check-filled insta-verified"></i></div>
                            <div class="insta-location">${stu.school} · ${stu.class}</div>
                        </div>
                        <i class="ti ti-dots"></i>
                    </div>
                    
                    <!-- 1. 核心总分大卡片 (Visual Area - 旧模块) -->
                    ${visualAreaHtml}
                    
                    <!-- Actions (点赞栏 - 旧模块) -->
                    <div class="insta-actions">
                        <div class="insta-action-left">
                            <i class="ti ti-heart insta-icon liked"></i>
                            <i class="ti ti-message-circle-2 insta-icon"></i>
                            <i class="ti ti-send insta-icon"></i>
                        </div>
                        <i class="ti ti-bookmark insta-icon"></i>
                    </div>
                    
                    <!-- Likes -->
                    <div class="insta-likes">${(Math.random()*100 + 50).toFixed(0)} likes</div>
                    
                    <!-- Caption (文案 - 旧模块) -->
                    <div class="insta-caption">
                        <span class="insta-caption-name">${CONFIG.name}教务处</span>
                        本次考试成绩已出炉！${statusTag}，请查收您的学习报告。
                        <span class="insta-tags">#期末考试 #${stu.school} #学习报告</span>
                    </div>

                    <!-- 2. 🟢 新增：模块④ 学情结构一句话诊断 -->
                    ${typeof igDiagnosisHtml !== 'undefined' ? igDiagnosisHtml : ''}

                    <!-- 3. 🟢 新增：模块⑤ 优势/短板学科折叠清单 -->
                    ${typeof igSubjectListHtml !== 'undefined' ? igSubjectListHtml : ''}

                    <!-- 4. 🟢 新增：图表容器 (雷达图/均衡度 - 之前定义的 chartsHtml) -->
                    ${chartsHtml}

                    <!-- 5. 单科成绩列表 (旧模块) -->
                    <div class="insta-comments" style="margin-top:15px;">
                        <div style="color:#8e8e8e; margin-bottom:5px; font-size:12px; font-weight:bold;">📄 单科成绩详情</div>
                        ${commentsHtml}
                    </div>

                    <!-- 6. 🟢 新增：模块⑥ 家长执行建议 -->
                    ${typeof igAdviceHtml !== 'undefined' ? igAdviceHtml : ''}

                    <!-- Timestamp -->
                    <div class="insta-timestamp">${genDate}</div>
                </div>
                
                <div style="text-align:center; padding:20px; color:#999; font-size:12px;">
                    <p>已显示全部数据</p>
                    <button class="btn btn-sm btn-gray" onclick="Auth.logout()">退出登录</button>
                </div>
            </div>
        `;
    } 

    // 3. 🟢 新增：专门用于渲染 IG 风格卡片内 Canvas 的函数 (手机端图表核心逻辑)
    function renderIGCharts(stu) {
        // 使用 setTimeout 确保 DOM 元素已经插入页面
        setTimeout(() => {
            // === 绘制雷达图 ===
            const radarCtx = document.getElementById('igRadarChart');
            if (radarCtx) {
                // 防止重复渲染，先销毁旧实例
                if (window.igRadarInstance) window.igRadarInstance.destroy();

                const labels = [];
                const data = [];

                SUBJECTS.forEach(sub => {
                    if (stu.scores[sub] !== undefined) {
                        labels.push(sub);
                        
                        // 计算百分位
                        const all = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number').sort((a, b) => b - a);
                        const rank = all.indexOf(stu.scores[sub]) + 1;
                        // (1 - 排名/总数) * 100
                        data.push(((1 - rank / all.length) * 100).toFixed(1));
                    }
                });

                window.igRadarInstance = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '能力值',
                            data: data,
                            backgroundColor: 'rgba(37, 99, 235, 0.2)', // 蓝色填充
                            borderColor: '#2563eb',
                            pointBackgroundColor: '#2563eb',
                            pointBorderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 100,
                                ticks: { display: false }, // 隐藏刻度
                                pointLabels: { 
                                    font: { size: 11, weight: 'bold' },
                                    color: '#333'
                                },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // === 绘制均衡度图 (Z-Score) ===
            const varCtx = document.getElementById('igVarianceChart');
            if (varCtx) {
                if (window.igVarianceInstance) window.igVarianceInstance.destroy();

                const labels = [];
                const zData = [];
                const colors = [];

                // 简单的标准差计算函数
                const calcStats = (arr) => {
                    const n = arr.length;
                    if (n === 0) return { mean: 0, sd: 1 };
                    const mean = arr.reduce((a, b) => a + b, 0) / n;
                    const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
                    return { mean, sd: Math.sqrt(variance) };
                };

                SUBJECTS.forEach(sub => {
                    if (stu.scores[sub] !== undefined) {
                        const allArr = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                        const stats = calcStats(allArr);
                        
                        let z = 0;
                        if (stats.sd > 0) z = (stu.scores[sub] - stats.mean) / stats.sd;
                        
                        labels.push(sub);
                        zData.push(z);
                        // 正数绿色，负数红色
                        colors.push(z >= 0 ? '#16a34a' : '#dc2626');
                    }
                });

                window.igVarianceInstance = new Chart(varCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '标准分 (Z-Score)',
                            data: zData,
                            backgroundColor: colors,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // 横向柱状图
                        scales: {
                            x: { 
                                grid: { display: true, color: '#f1f5f9' },
                                title: { display: true, text: '← 弱势 | 强势 →', font: {size: 10}, color:'#94a3b8' }
                            },
                            y: { 
                                grid: { display: false } 
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

        }, 150); // 延时 150ms 确保 HTML 渲染完毕
    }

    // 3. 🟢 新增：手机端管理器逻辑对象 (MobMgr)
    const MobMgr = {
        currentTab: 'home',

        // 1. 初始化手机管理界面
        init: function() {
            // 隐藏 PC 端的大容器及导航
            document.getElementById('app').classList.add('hidden');
            const header = document.querySelector('header');
            if(header) header.style.display = 'none';
            const nav = document.querySelector('.nav-wrapper');
            if(nav) nav.style.display = 'none';
            
            // 显示手机端容器
            const mobApp = document.getElementById('mobile-manager-app');
            mobApp.style.display = 'block';
            
            // 填充用户信息
            const user = Auth.currentUser;
            if(user) {
                document.getElementById('mob-user-name').innerText = user.name;
                const roleMap = { 'admin':'管理员', 'teacher':'教师', 'class_teacher':'班主任', 'grade_director':'级部主任', 'director':'教务主任' };
                document.getElementById('mob-user-role').innerText = roleMap[user.role] || user.role;
            }

            this.switchTab('home');
        },

        // 2. 切换 Tab
        switchTab: function(tabId) {
            this.currentTab = tabId;
            
            // 隐藏所有 view
            document.querySelectorAll('.mob-view').forEach(el => el.classList.remove('active'));
            // 显示目标 view
            const targetView = document.getElementById(`mob-view-${tabId}`);
            if(targetView) targetView.classList.add('active');
            
            // 更新底部导航高亮
            document.querySelectorAll('.mob-nav-btn').forEach(btn => btn.classList.remove('active'));
            // 匹配 onclick 字符串来激活按钮
            const activeBtn = Array.from(document.querySelectorAll('.mob-nav-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(activeBtn) activeBtn.classList.add('active');

            // 触发特定页面的渲染逻辑
            if(tabId === 'students') this.renderStudentList();
            if(tabId === 'analysis') this.renderAnalysis();
        },

        // 3. 渲染学生列表 (支持搜索)
        renderStudentList: function() {
            const container = document.getElementById('mob-student-list');
            const keyword = document.getElementById('mob-search-input').value.toLowerCase();
            const user = Auth.currentUser;
            
            let list = RAW_DATA;
            
            // 权限过滤
            if(user) {
                if(user.school) list = list.filter(s => s.school === user.school);
                if(user.role === 'class_teacher' && user.class) {
                    list = list.filter(s => s.class === user.class);
                }
            }

            if(keyword) {
                list = list.filter(s => s.name.toLowerCase().includes(keyword) || String(s.id).includes(keyword));
            }

            // 限制显示数量，防止手机 DOM 过多卡顿
            const displayList = list.slice(0, 50);
            
            if(displayList.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">无匹配学生<br><small>请尝试搜索姓名</small></div>';
                return;
            }

            let html = '';
            displayList.forEach(s => {
                // 根据总分给个颜色区分
                const badgeColor = s.total >= 500 ? '#16a34a' : (s.total >= 360 ? '#2563eb' : '#d97706');
                html += `
                    <div class="mob-list-item" onclick="MobMgr.showStudentDetail('${s.name}')">
                        <div class="mob-avatar">${s.name[0]}</div>
                        <div class="mob-info">
                            <div class="mob-name">${s.name}</div>
                            <div class="mob-detail">${s.class} | 考号:${s.id}</div>
                        </div>
                        <div class="mob-score-badge" style="color:${badgeColor}">${s.total}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        },

        // 4. 显示学生详情 (复用 IG 风格卡片 + 全屏模态)
        showStudentDetail: function(name) {
            // 简单查找 (实际应考虑同名问题，这里优先取第一个)
            const stu = RAW_DATA.find(s => s.name === name);
            if(!stu) return;
            
            const html = renderInstagramCard(stu);
            
            // 创建临时全屏容器
            let modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0'; modal.style.left = '0';
            modal.style.width = '100%'; modal.style.height = '100%';
            modal.style.background = '#fafafa';
            modal.style.zIndex = '20000';
            modal.style.overflowY = 'auto';
            // 动画
            modal.style.animation = 'fadeIn 0.2s ease-out';
            
            modal.innerHTML = `
                <div style="position:fixed; top:0; width:100%; padding:10px; background:white; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; z-index:20001;">
                    <div style="font-weight:bold; color:#333;">学生详情</div>
                    <button onclick="this.closest('div').parentElement.remove()" style="padding:6px 15px; background:#f3f4f6; border:none; border-radius:4px; font-weight:bold; color:#333;">关闭</button>
                </div>
                <div style="padding-top:60px; padding-bottom:40px;">${html}</div>
            `;
            document.body.appendChild(modal);
        },

        // 5. 渲染简单分析 (总览)
        renderAnalysis: function() {
            const container = document.getElementById('mob-analysis-content');
            
            let list = RAW_DATA;
            const user = Auth.currentUser;
            if(user && user.school) {
                list = list.filter(s => s.school === user.school);
            }
            
            if(!list.length) {
                container.innerHTML = '<div style="padding:20px;text-align:center;">暂无数据</div>'; return;
            }
            
            const total = list.length;
            const allTotal = list.map(s=>s.total).reduce((a,b)=>a+b,0);
            const avg = (allTotal / total).toFixed(1);
            
            let html = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
                    <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                        <div style="font-size:24px; font-weight:bold; color:#333;">${total}</div>
                        <div style="font-size:12px; color:#64748b;">本校人数</div>
                    </div>
                    <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd;">
                        <div style="font-size:24px; font-weight:bold; color:#2563eb;">${avg}</div>
                        <div style="font-size:12px; color:#0369a1;">年级均分</div>
                    </div>
                </div>
                <div style="margin-top:20px; text-align:center; font-size:12px; color:#999;">
                    <i class="ti ti-device-desktop"></i><br>更多复杂分析（如进退步、班级对比）<br>请登录电脑端查看
                </div>
            `;
            container.innerHTML = html;
        }
    };

    // 4. Hook: 拦截 Auth.applyRoleView，实现手机端自动跳转
    // 必须确保在 Auth 对象定义之后执行此代码 (通常放在脚本末尾即可)
    const originalApplyRoleView = Auth.applyRoleView;
    Auth.applyRoleView = function() {
        const isMobile = window.innerWidth <= 768;
        const role = this.currentUser.role;

        // A. 家长角色：始终进入专属的 Parent View (会自动调用 renderInstagramCard)
        if (role === 'parent') {
            this.renderParentView();
            return;
        }

        // B. 教师/管理员 + 手机端：进入 Mobile Manager App
        if (role !== 'parent' && isMobile) {
            MobMgr.init();
            return; // 阻断后续 PC 逻辑
        }

        // C. 其他情况 (PC端)：执行原有逻辑
        originalApplyRoleView.call(this);
    };




    function printSingleReport() {
        const reportContent = document.getElementById('report-card-capture-area');
        if (!reportContent || reportContent.innerHTML.trim() === "") return alert("请先查询生成报告");
        const printContainer = document.createElement('div'); printContainer.id = 'temp-print-wrapper';
        const originalCanvas = reportContent.querySelector('canvas');
        let canvasImg = ''; if (originalCanvas) { canvasImg = `<img src="${originalCanvas.toDataURL()}" style="width:100%; height:100%; object-fit:contain;">`; }
        printContainer.innerHTML = reportContent.innerHTML;
        if (originalCanvas) { const tempCanvasContainer = printContainer.querySelector('.chart-wrapper'); if(tempCanvasContainer) tempCanvasContainer.innerHTML = canvasImg; }
        printContainer.className = 'exam-print-page'; document.body.appendChild(printContainer);
        const style = document.createElement('style'); style.id = 'temp-print-style';
        style.innerHTML = `@media print { body > *:not(#temp-print-wrapper) { display: none !important; } #temp-print-wrapper { display: block !important; width: 100%; position: absolute; top: 0; left: 0; } .report-card-container { box-shadow: none; border: 1px solid #ccc; } -webkit-print-color-adjust: exact; print-color-adjust: exact; }`;
        document.head.appendChild(style); window.print();
        setTimeout(() => { document.body.removeChild(printContainer); document.head.removeChild(style); }, 500);
    }

    function batchGeneratePDF() {
        const sch = document.getElementById('sel-school').value; const cls = document.getElementById('sel-class').value;
        if (!sch || sch === '--请先选择学校--' || !cls || cls === '--请先选择学校--') { return alert("请先选择学校和班级！"); }
        const students = SCHOOLS[sch].students.filter(s => s.class === cls); if (students.length === 0) { return alert("该班级没有学生数据"); }
        students.sort((a, b) => b.total - a.total);
        if(!confirm(`即将生成 ${students.length} 份 A4 报告。\n\n系统将调用浏览器打印功能，请在打印预览页选择：\n1. 目标打印机：另存为 PDF\n2. 更多设置 -> 勾选“背景图形”\n\n确定继续吗？`)) return;
        const container = document.getElementById('batch-print-container'); container.innerHTML = ''; let batchHtml = '';
        students.forEach(stu => { 
            let reportHtml = renderSingleReportCardHTML(stu, 'A4');
            reportHtml = reportHtml.replace(/<div class="chart-wrapper"[\s\S]*?<\/div>/, '<div style="height:50px; text-align:center; color:#999; line-height:50px; border:1px dashed #eee; margin:10px 0;">(批量打印模式暂不显示雷达图)</div>');
            batchHtml += `<div style="page-break-after: always; padding: 20px; height: 100vh;">${reportHtml}</div>`; 
        });
        container.innerHTML = batchHtml; container.style.display = 'block';
        const style = document.createElement('style'); style.id = 'batch-print-style';
        style.innerHTML = `@media print { body > *:not(#batch-print-container) { display: none !important; } #batch-print-container { display: block !important; } .report-card-container { box-shadow: none !important; border: 2px solid #333 !important; } -webkit-print-color-adjust: exact; print-color-adjust: exact; }`;
        document.head.appendChild(style);
        setTimeout(() => { window.print(); setTimeout(() => { container.style.display = 'none'; container.innerHTML = ''; document.head.removeChild(style); }, 2000); }, 500);
    }
   // 辅助：将 Blob/File 转为 Base64 并自动存入缓存
       async function loadHistoricalArchives(input) {
        const files = input.files; 
        if (!files.length) return;
        
        let loadedCount = 0;
        
        // 遍历所有上传的文件
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const examName = file.name.replace('.xlsx', '').replace('.xls', ''); // 用文件名作为考试名
            
            await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet); // 读取为对象数组
                    
                    // 自动识别列名
                    if (json.length > 0) {
                        const sample = json[0];
                        // 寻找关键列：姓名、学校、总分/排名
                        const keyName = Object.keys(sample).find(k => k.includes('姓名') || k.toLowerCase() === 'name');
                        const keySchool = Object.keys(sample).find(k => k.includes('学校') || k.toLowerCase() === 'school');
                        // 优先找排名列，如果没有则找总分列后续自动算排名(简化起见这里假设有总分)
                        const keyRank = Object.keys(sample).find(k => k.includes('排名') || k.includes('名次') || k.includes('Rank'));
                        const keyScore = Object.keys(sample).find(k => k.includes('总分') || k.includes('Total') || k === '得分');

                        if (keyName && (keyRank || keyScore)) {
                            // 如果只有分数没有排名，先进行一次简单的排序计算
                            if (!keyRank && keyScore) {
                                json.sort((a, b) => (b[keyScore]||0) - (a[keyScore]||0));
                                json.forEach((row, idx) => row._tempRank = idx + 1);
                            }

                            json.forEach(row => {
                                const name = row[keyName];
                                const school = keySchool ? row[keySchool] : '默认学校'; // 如果没有学校列，视为单校
                                const rank = keyRank ? parseInt(row[keyRank]) : row._tempRank;
                                
                                // 尝试在行数据中找“班级”
                                let className = "";
                                const keyClass = Object.keys(row).find(k => k.includes('班') || k.toLowerCase().includes('class'));
                                if (keyClass) className = normalizeClass(row[keyClass]);

                                if (name && rank) {
                                    // 唯一标识加入班级：学校_班级_姓名 (例如: 实验中学_701_张三)
                                    // 这样 701的张三 和 702的张三 就会拥有两份不同的档案
                                    const uid = school + "_" + className + "_" + name; 
                                    if (!HISTORY_ARCHIVE[uid]) HISTORY_ARCHIVE[uid] = [];
                                    
                                    // 避免重复添加同一场考试
                                    if (!HISTORY_ARCHIVE[uid].find(x => x.exam === examName)) {
                                        HISTORY_ARCHIVE[uid].push({ exam: examName, rank: rank });
                                    }
                                }
                            });
                            loadedCount++;
                        }
                    }
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 计算稳定性并标记过山车学生
        analyzeStability();
        
        document.getElementById('history-status').innerText = `✅ 已建立 ${Object.keys(HISTORY_ARCHIVE).length} 份学生档案，包含 ${loadedCount} 次历史考试。`;
        input.value = ''; // 清空以允许重复上传
    }

    function analyzeStability() {
        ROLLER_COASTER_STUDENTS = [];
        Object.keys(HISTORY_ARCHIVE).forEach(uid => {
            const records = HISTORY_ARCHIVE[uid];
            if (records.length < 3) return; // 至少3次考试才算波动

            const ranks = records.map(r => r.rank);
            const n = ranks.length;
            const mean = ranks.reduce((a, b) => a + b, 0) / n;
            // 计算标准差 (Standard Deviation)
            const variance = ranks.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            const sd = Math.sqrt(variance);

            // 阈值设定：如果标准差超过 50 (意味着平均每次排名波动幅度很大)，标记为过山车
            // *也可以根据全镇人数动态调整，这里先设固定值或全校人数的10%
            if (sd > 50) {
                ROLLER_COASTER_STUDENTS.push(uid);
            }
        });
        console.log("检测到波动剧烈学生数:", ROLLER_COASTER_STUDENTS.length);
    }
    // 1. 保存配置
    function saveLLMConfig() {
        const key = document.getElementById('llm_apikey').value;
        const url = document.getElementById('llm_baseurl').value;
        const model = document.getElementById('llm_model').value;
        
        if (!key) return alert("API Key 不能为空");
        
        localStorage.setItem('LLM_API_KEY', key);
        localStorage.setItem('LLM_BASE_URL', url);
        localStorage.setItem('LLM_MODEL', model);
        
        LLM_CONFIG.apiKey = key;
        LLM_CONFIG.baseURL = url;
        LLM_CONFIG.model = model;
        
        alert("✅ AI 配置已保存！");
    }

    // 页面加载时填充配置框
    window.addEventListener('load', () => {
        if(LLM_CONFIG.apiKey) document.getElementById('llm_apikey').value = LLM_CONFIG.apiKey;
        document.getElementById('llm_baseurl').value = LLM_CONFIG.baseURL;
        document.getElementById('llm_model').value = LLM_CONFIG.model;
    });

    // 2. 通用 LLM 请求函数
    async function callLLM(prompt, onChunk, onFinish) {
        if (!LLM_CONFIG.apiKey) return alert("请先在【数据中心】设置 AI API Key");
        
        try {
            const response = await fetch(`${LLM_CONFIG.baseURL}/v1/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${LLM_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: LLM_CONFIG.model,
                    messages: [
                        { role: "system", content: LLM_CONFIG.systemPrompt },
                        { role: "user", content: prompt }
                    ],
                    stream: true // 开启流式输出
                })
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                // 处理 SSE 数据流 (data: {...})
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const content = json.choices[0].delta.content || "";
                            fullText += content;
                            if (onChunk) onChunk(content);
                        } catch (e) { }
                    }
                }
            }
            if (onFinish) onFinish(fullText);

        } catch (error) {
            console.error(error);
            alert("AI 请求失败: " + error.message);
            if (onFinish) onFinish(" (请求失败)");
        }
    }

    // 3. 生成单个学生评语
    function callAIForComment() {
        const stu = CURRENT_REPORT_STUDENT;
        if (!stu) return alert("请先查询一名学生");
        
        const box = document.getElementById('ai-comment-box');
        // 增加一个 Loading 动画效果
        box.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <span class="loader-spinner" style="width:20px;height:20px;display:inline-block;vertical-align:middle;"></span>
                <span style="color:#4f46e5; font-weight:bold; margin-left:10px;">AI 正在根据全镇数据深度分析 ${stu.name} 的学情...</span>
            </div>`;
        
        // 使用上面定义的增强版 Prompt 构建器
        const prompt = buildStudentPrompt(stu);

        let isFirstChunk = true;
        
        callLLM(prompt, (chunk) => {
            if (isFirstChunk) {
                box.innerHTML = ""; // 清除 Loading
                // 增加 Markdown 样式的简单处理容器
                box.style.fontFamily = '"Segoe UI", system-ui, sans-serif';
                box.style.whiteSpace = 'pre-wrap'; 
                isFirstChunk = false;
            }
            
            // 简单的流式追加
            box.innerText += chunk;
            
        }, (fullText) => {
            // (可选) 生成结束后，可以对文本进行简单的 Markdown 高亮处理
            // 这里为了简单，我们把 [小标题] 加粗
            const formatted = fullText
                .replace(/\[(.*?)\]/g, '<br><strong style="color:#b45309; background:#fff7ed; padding:2px 5px; border-radius:4px;">$1</strong>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // 处理 Markdown 加粗
            
            box.innerHTML = formatted;
        });
    }

    // 4. 生成年级质量分析报告 (长文) - 智能增强版 (本校 VS 乡镇)
    // 功能：专注于本校与全镇对比，提供分层级、分科目的深度诊断与实操建议
    function generateAIMacroReport() {
        if (!Object.keys(SCHOOLS).length) return alert("无数据");
        
        // 1. 强制检查本校设置 (关键逻辑：没有本校就无法做对比)
        if (!MY_SCHOOL || !SCHOOLS[MY_SCHOOL]) {
            return alert("⚠️ 无法生成针对性报告！\n\n请先在页面顶部的【选择本校】下拉框中选中您的学校，系统才能进行“本校 vs 他校”的深度对比分析。");
        }

        // 创建模态框显示报告
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="width:95%; max-width:1600px; height:90vh; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <h3>🤖 AI 深度质量诊断: ${MY_SCHOOL} (对比分析版)</h3>
                    <button onclick="this.closest('.modal').remove()" style="border:none; bg:none; cursor:pointer; font-size:20px;">&times;</button>
                </div>
                <div id="ai-report-content" style="flex:1; overflow-y:auto; padding:20px; white-space:pre-wrap; line-height:1.8; font-family:serif; font-size:16px;">
                    正在调取 ${MY_SCHOOL} 与全镇其他 ${Object.keys(SCHOOLS).length - 1} 所学校的对比数据...
                    <br>正在分析学科短板与提分空间...
                    <br>正在生成针对 ${CONFIG.name} 的备考建议...
                    <br><br>
                    <span class="loader-spinner" style="width:20px;height:20px;display:inline-block;"></span> AI 正在奋笔疾书，请稍候 (约30秒)...
                </div>
                <div style="border-top:1px solid #eee; padding-top:10px; text-align:right;">
                    <button class="btn btn-blue" onclick="copyReport()">📋 复制全文</button>
                    <button class="btn btn-primary" onclick="exportToWord()" style="background:#2b579a; margin-left:10px;">
                        <i class="ti ti-file-word"></i> 导出为 Word
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // --- A. 数据准备 (Data Context) ---
        const myData = SCHOOLS[MY_SCHOOL];
        const totalSchools = Object.keys(SCHOOLS).length;
        const myRank = myData.rank2Rate || '-';
        
        // 计算全镇基准数据
        let subjectComparison = []; // 存储单科对比详情

        // 遍历所有科目进行对比
        SUBJECTS.forEach(sub => {
            if (!myData.metrics[sub]) return;
            
            // 全镇该科数据收集
            const allSchoolsMetrics = Object.values(SCHOOLS).map(s => s.metrics[sub]).filter(m => m);
            const townSubAvg = allSchoolsMetrics.reduce((a,b) => a + b.avg, 0) / allSchoolsMetrics.length;
            const maxSubAvg = Math.max(...allSchoolsMetrics.map(m => m.avg)); // 第一名均分
            
            // 本校数据
            const mySub = myData.metrics[sub];
            const diff = mySub.avg - townSubAvg; // 与全镇平均差
            const diffMax = mySub.avg - maxSubAvg; // 与第一名差
            const rank = myData.rankings[sub]?.avg || '-';

            subjectComparison.push({
                subject: sub,
                myAvg: mySub.avg.toFixed(1),
                townAvg: townSubAvg.toFixed(1),
                diff: diff.toFixed(1), // 与均值差
                diffMax: diffMax.toFixed(1), // 与第一名差
                rank: rank,
                excRate: (mySub.excRate * 100).toFixed(1) + '%',
                passRate: (mySub.passRate * 100).toFixed(1) + '%'
            });
        });

        // 区分优势与劣势学科 (简单算法：排名前30%为优，后40%为劣)
        const strongSubjects = subjectComparison.filter(s => s.rank <= Math.ceil(totalSchools * 0.3)).map(s => s.subject).join('、');
        const weakSubjects = subjectComparison.filter(s => s.rank > Math.ceil(totalSchools * 0.6)).map(s => s.subject).join('、');

        // 构建上下文文本，喂给 AI
        const contextText = `
        【基本信息】
        年级模式：${CONFIG.name} (特别注意：如果是9年级则面临中考，如果是7/8年级则处于基础阶段)
        本校：${MY_SCHOOL}
        全镇学校数：${totalSchools}
        本校综合排名：第 ${myRank} 名
        本校综合得分：${myData.score2Rate ? myData.score2Rate.toFixed(2) : '-'}

        【学科详细对比数据】(正数代表高于全镇均分，负数代表低于)：
        ${subjectComparison.map(s => `- ${s.subject}: 均分${s.myAvg} (与全镇差${s.diff}, 与第一名差${s.diffMax}), 排名${s.rank}, 优率${s.excRate}, 及格率${s.passRate}`).join('\n')}
        
        【初步诊断】
        优势学科：${strongSubjects || '无明显优势'}
        薄弱学科：${weakSubjects || '无明显短板'}
        `;

       // --- B. 构建 Prompt (要求 AI 返回 JSON 格式) ---
        const prompt = `
        你是一位资深教育数据分析师。请基于以下 **${MY_SCHOOL}** 的考试数据，进行深度诊断。

        【数据上下文】：
        ${contextText}

        【输出指令】：
        请严格按照以下 **JSON** 格式返回分析结果，不要包含任何 Markdown 标记（如 \`\`\`json），也不要包含任何开场白或结束语，直接返回 JSON 对象：
        {
            "summary": "一句话考情综述（例如：整体稳中有进，但优生断层严重，需警惕两极分化）",
            "score": 85, 
            "highlights": ["亮点1：XX学科均分超全镇平均5分", "亮点2：及格率稳步提升"], 
            "warnings": ["预警1：903班数学出现严重滑坡", "预警2：全校前100名人数偏少"], 
            "strategies": [
                { "title": "学科攻坚", "action": "针对英语薄弱问题，建议早读增加20分钟单词听写..." },
                { "title": "培优辅差", "action": "建立临界生档案，实行导师制..." },
                { "title": "课堂常规", "action": "严抓晚自习纪律，提高作业完成率..." }
            ],
            "slogan": "一句鼓舞人心的短句（10字以内）"
        }
        `;

        const contentDiv = document.getElementById('ai-report-content');
        // 初始化 Loading 界面
        contentDiv.innerHTML = `
            <div style="text-align:center; padding:50px;">
                <div class="loader-spinner" style="width:40px;height:40px;margin:0 auto 15px;display:block;"></div>
                <div style="font-size:16px; color:#4f46e5; font-weight:bold;">🤖 AI 正在进行多维度推理...</div>
                <div style="font-size:12px; color:#64748b; margin-top:5px;">正在对比全镇数据 / 计算学科差异 / 生成提分策略</div>
            </div>`;
        
        // 调用 AI 接口 (使用累积模式处理 JSON)
        let jsonBuffer = "";
        
        callLLM(prompt, (chunk) => {
            // 流式接收数据，暂不渲染，只存入 buffer
            jsonBuffer += chunk;
        }, (fullText) => {
            // 生成结束，开始解析与渲染
            try {
                // 1. 清洗数据：去除可能存在的 Markdown 代码块标记
                const cleanJson = jsonBuffer.replace(/```json/g, '').replace(/```/g, '').trim();
                
                // 2. 解析 JSON
                const data = JSON.parse(cleanJson);
                
                // 3. 渲染漂亮的 UI
                contentDiv.innerHTML = `
                    <div style="padding:10px;">
                        <!-- 头部评分 -->
                        <div style="text-align:center; margin-bottom:30px; border-bottom:1px dashed #eee; padding-bottom:20px;">
                            <h2 style="color:#1e293b; margin:0 0 10px 0; font-size:24px;">${data.summary}</h2>
                            <div style="display:inline-flex; align-items:center; background:#fefce8; border:1px solid #facc15; padding:5px 15px; border-radius:20px;">
                                <span style="color:#854d0e; font-size:12px;">AI 综合健康指数：</span>
                                <span style="font-size:28px; font-weight:800; color:#d97706; margin-left:8px;">${data.score}</span>
                            </div>
                        </div>

                        <!-- 红绿榜对比 -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px;">
                            <div style="background:#f0fdf4; padding:20px; border-radius:12px; border:1px solid #bbf7d0;">
                                <h4 style="color:#166534; margin:0 0 10px 0; display:flex; align-items:center;">
                                    <i class="ti ti-thumb-up" style="margin-right:5px;"></i> 亮点与优势
                                </h4>
                                <ul style="padding-left:20px; color:#14532d; font-size:14px; margin:0; line-height:1.6;">
                                    ${data.highlights.map(h => `<li>${h}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background:#fef2f2; padding:20px; border-radius:12px; border:1px solid #fecaca;">
                                <h4 style="color:#991b1b; margin:0 0 10px 0; display:flex; align-items:center;">
                                    <i class="ti ti-alert-triangle" style="margin-right:5px;"></i> 风险与预警
                                </h4>
                                <ul style="padding-left:20px; color:#7f1d1d; font-size:14px; margin:0; line-height:1.6;">
                                    ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- 策略清单 -->
                        <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                            <h4 style="color:#334155; margin:0 0 15px 0; border-left:4px solid var(--primary); padding-left:10px;">
                                🚀 提质增效行动方案
                            </h4>
                            <div style="display:flex; flex-direction:column; gap:15px;">
                                ${data.strategies.map((s, i) => `
                                    <div style="display:flex; align-items:flex-start; gap:12px;">
                                        <div style="background:#eff6ff; color:#1d4ed8; width:28px; height:28px; border-radius:6px; text-align:center; line-height:28px; font-weight:bold; flex-shrink:0;">${i+1}</div>
                                        <div>
                                            <div style="font-weight:bold; color:#1e293b; font-size:15px;">${s.title}</div>
                                            <div style="font-size:14px; color:#475569; margin-top:4px; line-height:1.5;">${s.action}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- 底部口号 -->
                        <div style="margin-top:30px; text-align:center;">
                            <span style="background:#f1f5f9; color:#64748b; padding:8px 20px; border-radius:50px; font-style:italic; font-size:14px;">
                                “ ${data.slogan} ”
                            </span>
                        </div>
                    </div>
                `;
            } catch (e) {
                // 如果 AI 返回的不是合法 JSON，回退显示原始文本
                console.error("AI JSON 解析失败", e);
                contentDiv.innerHTML = `
                    <div style="padding:20px; color:#333;">
                        <h3 style="color:#d97706;">⚠️ 解析模式降级</h3>
                        <p style="font-size:12px; color:#666;">AI 未返回标准 JSON 格式，已切换为纯文本显示。</p>
                        <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                        <pre style="white-space:pre-wrap; font-family:sans-serif; line-height:1.6;">${jsonBuffer}</pre>
                    </div>
                `;
            }
        });
    }
    
    function copyReport() {
        const text = document.getElementById('ai-report-content').innerText;
        navigator.clipboard.writeText(text).then(() => alert("已复制到剪贴板"));
    }
    function exportToWord() {
        const content = document.getElementById('ai-report-content').innerText;
        // 使用我们之前封装的 UI.toast 替代 alert，如果还没加 UI 模块，这里依然可以用 alert
        if (!content || content.includes("正在汇总")) return (window.UI ? UI.toast : alert)("请等待报告生成完毕后再导出");

        const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel } = docx;

        // 1. 解析文本：简单按换行符分割
        const lines = content.split('\n').filter(line => line.trim() !== '');
        const docChildren = [];

        // 1.1 添加大标题
        docChildren.push(
            new Paragraph({
                text: `${CONFIG.name} 教学质量分析报告`,
                heading: HeadingLevel.TITLE,
                alignment: AlignmentType.CENTER,
                spacing: { after: 300 } 
            })
        );

        // 1.2 添加生成日期
        docChildren.push(
            new Paragraph({
                children: [
                    new TextRun({
                        text: `生成日期：${new Date().toLocaleDateString()}`,
                        italics: true,
                        color: "666666",
                        size: 20 // 10pt
                    })
                ],
                alignment: AlignmentType.CENTER,
                spacing: { after: 500 }
            })
        );

        // 1.3 智能识别正文段落结构
        lines.forEach(line => {
            const trimmed = line.trim();
            
            // 简单的标题识别逻辑：以 "一、" "1." 等开头，或者包含 "【"
            const isHeading = /^[一二三四五六七八九十]、/.test(trimmed) || 
                              /^\d+\./.test(trimmed) || 
                              /^【.*】$/.test(trimmed);

            if (isHeading) {
                // 小标题格式：加粗，字号稍大，段前段后间距
                docChildren.push(
                    new Paragraph({
                        children: [ new TextRun({ text: trimmed, bold: true, size: 28 }) ], // 14pt
                        spacing: { before: 400, after: 200 }
                    })
                );
            } else {
                // 普通正文：首行缩进 2 字符，1.5倍行距
                docChildren.push(
                    new Paragraph({
                        children: [ new TextRun({ text: trimmed, size: 24 }) ], // 12pt
                        indent: { firstLine: 480 }, 
                        spacing: { line: 360 } 
                    })
                );
            }
        });

        // 1.4 底部落款
        docChildren.push(
            new Paragraph({
                children: [ new TextRun({ text: "（本报告由智能教务系统自动生成）", color: "999999", size: 18 }) ],
                alignment: AlignmentType.CENTER,
                spacing: { before: 800 }
            })
        );

        // 2. 创建文档对象
        const doc = new Document({
            sections: [{ properties: {}, children: docChildren }],
        });

        // 3. 生成并下载
        Packer.toBlob(doc).then((blob) => {
            const fileName = `${CONFIG.name}_质量分析报告_${new Date().getTime()}.docx`;
            saveAs(blob, fileName);
            if(window.UI) UI.toast(`✅ 已导出 Word 文档：${fileName}`, "success");
        }).catch(err => {
            console.error(err);
            alert("导出 Word 失败：" + err.message);
        });
    }
    function loadTeacherStamp(input) {
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = function(e) { TEACHER_STAMP_BASE64 = e.target.result; alert("签名/章图片已导入"); }; reader.readAsDataURL(file);
    }
    function renderHistoryChart(student) {
        const ctx = document.getElementById('historyChart'); 
        if(!ctx) return;
        if (historyChartInstance) historyChartInstance.destroy();

        // 1. 尝试从历史档案中获取数据
        const uid = student.school + "_" + student.name;
        // 深度拷贝一份，以免修改原数据
        let history = HISTORY_ARCHIVE[uid] ? JSON.parse(JSON.stringify(HISTORY_ARCHIVE[uid])) : [];
        
        // 2. 将“本次”考试数据加入趋势图
        const currentRank = safeGet(student, 'ranks.total.township', 0);
        if(currentRank) {
            history.push({ exam: '本次期末', rank: currentRank });
        }

        // 如果完全没有数据
        if(history.length === 0) {
            // 画一个空图或者显示文字
            return;
        }

        // --- A. 简单线性回归预测 (Simple Linear Regression) ---
        let prediction = null;
        
        // 只有当历史数据 >= 3 次时才进行预测，否则样本太少不准确
        if (history.length >= 3) { 
            const n = history.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            
            // X轴为时间序列索引 (0, 1, 2...), Y轴为排名
            history.forEach((h, i) => {
                sumX += i;
                sumY += h.rank;
                sumXY += i * h.rank;
                sumXX += i * i;
            });

            // 计算斜率 (Slope) 和 截距 (Intercept)
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // 预测下一次 (索引为 n)
            const nextRank = Math.round(slope * n + intercept);
            
            // 限制预测值合理范围 (排名不能小于1)
            const predictedRank = Math.max(1, nextRank);
            
            // 判断趋势方向
            const trend = slope < 0 ? '📈 持续进步' : (slope > 0 ? '📉 有下滑风险' : '➡️ 保持稳定');
            
            prediction = { 
                rank: predictedRank, 
                label: "下期预测",
                trendText: trend
            };
        }

        // --- B. 准备图表数据 ---
        const labels = history.map(h => h.exam);
        const data = history.map(h => h.rank);
        
        // 定义点的颜色和大小 (真实数据用蓝色)
        const pointColors = data.map(() => '#2563eb'); 
        const pointRadii = data.map(() => 5);

        // 如果有预测数据，追加到数组末尾
        if (prediction) {
            labels.push(prediction.label);
            data.push(prediction.rank);
            // 预测点用橙色，且稍微大一点
            pointColors.push('#f59e0b'); 
            pointRadii.push(6); 
        }

        // --- C. 绘制图表 ---
        // 判断是否为波动生 (原有逻辑)
        const isUnstable = ROLLER_COASTER_STUDENTS.includes(uid);
        
        historyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '全镇排名 (越低越好)',
                    data: data,
                    // 样式配置
                    backgroundColor: isUnstable ? 'rgba(220, 38, 38, 0.1)' : 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: pointColors, // 使用动态颜色数组
                    pointRadius: pointRadii,       // 使用动态大小数组
                    fill: true,
                    tension: 0.3,
                    
                    // 关键：利用 segment 配置实现虚线连接预测点
                    segment: {
                        borderDash: ctx => {
                            // 如果是连接到最后一点(且有预测)，则设为虚线 [5, 5]
                            if (prediction && ctx.p1DataIndex === data.length - 1) return [6, 4];
                            return undefined; // 实线
                        },
                        borderColor: ctx => {
                            // 预测线段用橙色
                            if (prediction && ctx.p1DataIndex === data.length - 1) return '#f59e0b';
                            // 波动生用红色，普通生用蓝色
                            return isUnstable ? '#dc2626' : '#2563eb';
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (prediction && context.dataIndex === data.length - 1) {
                                    return label + context.raw + " (AI预测值)";
                                }
                                return label + context.raw;
                            }
                        }
                    },
                    // 动态标题显示预测结果
                    title: { 
                        display: true, 
                        text: prediction 
                            ? `历史走势 | 🤖 预测下次: 第 ${prediction.rank} 名 (${prediction.trendText})`
                            : (isUnstable ? '⚠️ 排名波动剧烈，需关注' : '历史排名走势'),
                        color: (prediction && prediction.trendText.includes('风险')) || isUnstable ? '#dc2626' : '#333',
                        font: { size: 13 }
                    }
                },
                scales: {
                    y: {
                        reverse: true, // 排名反转，越靠上越好
                        title: { display: true, text: '名次' },
                        suggestedMin: 1 // 保证Y轴不为负
                    }
                }
            }
        });
    }

    function renderRadarChart(student) {
        const ctx = document.getElementById('radarChart'); if(!ctx) return;
        if (radarChartInstance) { radarChartInstance.destroy(); }

        const labels = []; 
        const currentData = [];
        const prevData = []; 

        const prevStu = findPreviousRecord(student);

        SUBJECTS.forEach(sub => {
            if(student.scores[sub] !== undefined) {
                labels.push(sub); 
                
                // 本次百分位
                const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => v !== undefined).sort((a, b) => b - a); 
                const rank = allScores.indexOf(student.scores[sub]) + 1; 
                const total = allScores.length; 
                const percentile = ((1 - (rank / total)) * 100).toFixed(1); 
                currentData.push(percentile);

                // 上次百分位
                let prevPercentile = null;
                if (prevStu && prevStu.scores && prevStu.scores[sub] !== undefined && window.PREV_DATA) {
                    const prevAllScores = window.PREV_DATA
                        .map(s => s.scores ? s.scores[sub] : undefined)
                        .filter(v => typeof v === 'number')
                        .sort((a, b) => b - a);
                    
                    if (prevAllScores.length > 0) {
                        const prevRank = prevAllScores.indexOf(prevStu.scores[sub]) + 1;
                        const prevTotal = prevAllScores.length;
                        prevPercentile = ((1 - (prevRank / prevTotal)) * 100).toFixed(1);
                    }
                }
                prevData.push(prevPercentile);
            }
        });

        const datasets = [{ 
            label: '本次', 
            data: currentData, 
            fill: true, 
            backgroundColor: 'rgba(37, 99, 235, 0.2)', // 蓝色填充
            borderColor: '#2563eb', // 蓝色实线
            pointBackgroundColor: '#2563eb',
            pointBorderColor: '#fff',
            pointRadius: 4,
            order: 1
        }];

        // 如果有有效历史数据，添加橙色虚线
        if (prevData.some(d => d !== null)) {
             datasets.push({
                label: '上次',
                data: prevData,
                fill: false, // 不填充，避免颜色混杂
                borderDash: [6, 4], // 明显的虚线
                // 👇 改为醒目的橙色
                borderColor: '#f97316', 
                pointBackgroundColor: '#fff', 
                pointBorderColor: '#f97316',
                pointRadius: 4,
                pointStyle: 'rectRot', // 点形状改为菱形，区分更明显
                order: 0 // 置于底层
             });
        }

        radarChartInstance = new Chart(ctx, { 
            type: 'radar', 
            data: { labels: labels, datasets: datasets }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    r: { 
                        min: 0, max: 100, 
                        ticks: { display: false }, 
                        pointLabels: { font: { size: 12, family: 'Microsoft YaHei', weight: 'bold' }, color: '#475569' },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        angleLines: { color: 'rgba(0,0,0,0.05)' }
                    } 
                }, 
                plugins: { 
                    legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 15 } } 
                } 
            } 
        });
    }

    let varianceChartInstance = null;
    
    function renderVarianceChart(student) {
        const ctx = document.getElementById('varianceChart'); 
        if(!ctx) return;
        if (varianceChartInstance) varianceChartInstance.destroy();

        const labels = [];
        const zScoresCurr = [];
        const zScoresPrev = []; 
        const bgColors = [];

        const prevStu = findPreviousRecord(student);

        const calcStats = (arr) => {
            const n = arr.length;
            if (n === 0) return { mean: 0, sd: 1 };
            const mean = arr.reduce((a, b) => a + b, 0) / n;
            const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            return { mean, sd: Math.sqrt(variance) };
        };

        SUBJECTS.forEach(sub => {
            if(student.scores[sub] !== undefined) {
                // 本次 Z-Score
                const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const stats = calcStats(allScores);
                let z = 0;
                if (stats.sd > 0) z = (student.scores[sub] - stats.mean) / stats.sd;
                
                labels.push(sub);
                zScoresCurr.push(z);

                // 颜色判定
                if (z >= 0.8) bgColors.push('#16a34a');      // 强 (绿)
                else if (z <= -0.8) bgColors.push('#dc2626'); // 弱 (红)
                else bgColors.push('#3b82f6');                // 中 (蓝)

                // 上次 Z-Score
                let prevZ = null;
                if (prevStu && prevStu.scores && prevStu.scores[sub] !== undefined && window.PREV_DATA) {
                    const prevAllScores = window.PREV_DATA
                        .map(s => s.scores ? s.scores[sub] : undefined)
                        .filter(v => typeof v === 'number');
                    const prevStats = calcStats(prevAllScores);
                    if (prevStats.sd > 0) {
                        prevZ = (prevStu.scores[sub] - prevStats.mean) / prevStats.sd;
                    }
                }
                zScoresPrev.push(prevZ); 
            }
        });

        const datasets = [{
            label: '本次',
            data: zScoresCurr,
            backgroundColor: bgColors,
            borderRadius: 3,
            barPercentage: 0.5,
            categoryPercentage: 0.8,
            order: 1
        }];

        // 如果有历史数据，添加橙色半透明柱
        if (zScoresPrev.some(d => d !== null)) {
            datasets.push({
                label: '上次',
                data: zScoresPrev,
                // 👇 改为醒目的橙色 (半透明填充 + 实线边框)
                backgroundColor: 'rgba(249, 115, 22, 0.4)', // Orange
                borderColor: '#f97316',
                borderWidth: 1,
                borderRadius: 3,
                barPercentage: 0.5,
                categoryPercentage: 0.8,
                order: 2 // 稍微错开或重叠均可，bar图表默认是并列
            });
        }

        varianceChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // 横向柱状图
                plugins: {
                    legend: { display: true, position: 'bottom' }, 
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label} Z-Score: ${ctx.raw ? ctx.raw.toFixed(2) : '-'}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { 
                            color: (ctx) => ctx.tick.value === 0 ? '#475569' : '#f1f5f9', 
                            lineWidth: (ctx) => ctx.tick.value === 0 ? 1.5 : 1 
                        },
                        suggestedMin: -2.5,
                        suggestedMax: 2.5,
                        ticks: { display: false } 
                    },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    function analyzeStrengthsAndWeaknesses(student) {
        const strengthsContainer = document.getElementById('strengths-container'); const weaknessesContainer = document.getElementById('weaknesses-container'); const suggestionsContainer = document.getElementById('suggestions-container');
        if(!strengthsContainer || !weaknessesContainer || !suggestionsContainer) return;
        const allTotals = RAW_DATA.map(s => s.total).sort((a, b) => b - a); const totalPercentile = (allTotals.indexOf(student.total) + 1) / allTotals.length;
        const strengths = [], weaknesses = [];
        SUBJECTS.forEach(subject => {
            if (student.scores[subject] !== undefined) {
                const allScores = RAW_DATA.map(s => s.scores[subject]).filter(v => v !== undefined).sort((a, b) => b - a); const percentile = (allScores.indexOf(student.scores[subject]) + 1) / allScores.length; if (percentile < totalPercentile - 0.2) strengths.push({ subject, percentile, score: student.scores[subject] }); else if (percentile > totalPercentile + 0.2) weaknesses.push({ subject, percentile, score: student.scores[subject] });
            }
        });
        strengthsContainer.innerHTML = strengths.length ? strengths.map(s => `<span>${s.subject} <small>(${s.score})</small></span>`).join('、') : '无明显优势学科'; weaknessesContainer.innerHTML = weaknesses.length ? weaknesses.map(w => `<span>${w.subject} <small>(${w.score})</small></span>`).join('、') : '无明显劣势学科';
        let suggestions = weaknesses.length ? `<p>建议重点关注：${weaknesses.map(w=>w.subject).join('、')}，制定针对性复习计划。</p>` : '<p>各科发展均衡，请继续保持当前的良好状态。</p>'; suggestionsContainer.innerHTML = suggestions;
    }

    function getIndicatorContext() {
        let meta = null;
        try { meta = JSON.parse(localStorage.getItem('ARCHIVE_META') || 'null'); } catch(e) {}
        if (!meta) meta = getExamMetaFromUI();
        const grade = String(meta?.grade || computeCohortGrade(CURRENT_COHORT_META, meta) || '');
        const type = meta?.type || '';
        return { grade, type, meta };
    }

    function isIndicatorPromptAllowed() {
        const ctx = getIndicatorContext();
        return ctx.grade === '9';
    }

    function isIndicatorCalcAllowed() {
        const ctx = getIndicatorContext();
        return ctx.grade === '9' && (ctx.type === '期中' || ctx.type === '期末');
    }

    function updateIndicatorUIState() {
        const promptAllowed = isIndicatorPromptAllowed();
        const calcAllowed = isIndicatorCalcAllowed();
        const btn = document.getElementById('btn-indicator-calc');
        if (btn) btn.disabled = !promptAllowed;
        const paramsArea = document.getElementById('dm-params-area');
        if (paramsArea) paramsArea.style.display = promptAllowed ? 'block' : 'none';
        const i1 = document.getElementById('dm_ind1_input');
        const i2 = document.getElementById('dm_ind2_input');
        if (i1) i1.disabled = !promptAllowed;
        if (i2) i2.disabled = !promptAllowed;
        const tip = document.getElementById('dm-params-tip');
        if (tip) tip.style.display = calcAllowed ? 'none' : (promptAllowed ? 'block' : 'none');
    }

    function calcIndicators() {
        if (!isIndicatorPromptAllowed()) return;
        // 1. 优先读取全局变量 SYS_VARS (这是最可靠的数据源)
        // 如果全局变量是空的，尝试读取管理面板里的输入框 (dm_ind...)
        let val1 = window.SYS_VARS?.indicator?.ind1;
        let val2 = window.SYS_VARS?.indicator?.ind2;

        if (!val1) val1 = document.getElementById('dm_ind1_input')?.value;
        if (!val2) val2 = document.getElementById('dm_ind2_input')?.value;

        const r1 = parseInt(val1);
        const r2 = parseInt(val2);
        
        // 2. 检查：如果参数未设置，自动打开管理面板并跳转到【年级指标参数】页
        if(!r1 || !r2) {
            if(confirm("❌ 检测到【划线名次】尚未设置！\n\n是否立即打开「教务数据综合控制台」进行设置？")) {
                DataManager.open(); // 打开弹窗
                DataManager.switchTab('params'); // 自动切换到参数设置Tab
            }
            return;
        }

        if (!isIndicatorCalcAllowed()) return;

        // 3. 检查：如果目标人数未导入，自动打开管理面板并跳转到【目标人数管理】页
        // window.TARGETS 是在 loadCloudData 或 DataManager 中加载的
        if(!window.TARGETS || Object.keys(window.TARGETS).length === 0) {
            if(confirm("❌ 检测到【目标人数】尚未导入！\n\n是否立即打开「教务数据综合控制台」进行导入？")) {
                DataManager.open(); // 打开弹窗
                DataManager.switchTab('targets'); // 自动切换到目标管理Tab
            }
            return;
        }

        // 1. 确定全镇划线分数
        // 9年级模式下 s.total 即为五科总分
        const allScores = RAW_DATA.map(s => s.total).sort((a,b)=>b-a); 
        const line1 = allScores[r1-1] || 0; 
        const line2 = allScores[r2-1] || 0;

        // 2. 第一轮遍历：计算达标人数、基础分、超额数
        let calcData = [];
        let maxExcess1 = 0; // 指标一最大超额数
        let maxExcess2 = 0; // 指标二最大超额数

        Object.values(SCHOOLS).forEach(s => {
            const scores = s.students.map(stu => stu.total);
            const reach1 = scores.filter(v => v >= line1).length; // 实际达标1
            const reach2 = scores.filter(v => v >= line2).length; // 实际达标2
            
            const t = window.TARGETS[s.name] || {t1: 10000, t2: 10000}; // 防止除以0
            
            // --- 指标一计算 ---
            // 基础分 (满分30)
            let base1 = 0;
            if (reach1 >= t.t1) base1 = 30;
            else base1 = (t.t1 > 0) ? (reach1 / t.t1 * 30) : 0;
            
            // 超额数
            const excess1 = Math.max(0, reach1 - t.t1);
            if (excess1 > maxExcess1) maxExcess1 = excess1;

            // --- 指标二计算 ---
            // 基础分 (满分30)
            let base2 = 0;
            if (reach2 >= t.t2) base2 = 30;
            else base2 = (t.t2 > 0) ? (reach2 / t.t2 * 30) : 0;

            // 超额数
            const excess2 = Math.max(0, reach2 - t.t2);
            if (excess2 > maxExcess2) maxExcess2 = excess2;

            calcData.push({
                name: s.name,
                t1: t.t1, r1: reach1, base1: base1, excess1: excess1,
                t2: t.t2, r2: reach2, base2: base2, excess2: excess2
            });
        });

        // 3. 第二轮遍历：计算附加分、总分并排序
        calcData.forEach(d => {
            // 附加分公式：(某校超额 / 最大超额) * 5
            d.bonus1 = (maxExcess1 > 0) ? (d.excess1 / maxExcess1 * 5) : 0;
            d.score1 = d.base1 + d.bonus1;

            d.bonus2 = (maxExcess2 > 0) ? (d.excess2 / maxExcess2 * 5) : 0;
            d.score2 = d.base2 + d.bonus2;

            d.finalScore = d.score1 + d.score2;
            
            // 同步到全局对象供综合排名使用
            if(SCHOOLS[d.name]) SCHOOLS[d.name].scoreInd = d.finalScore;
        });

        // 排序
        calcData.sort((a,b) => b.finalScore - a.finalScore).forEach((d, i) => d.rank = i + 1);

        // 4. 渲染表格 (表头增加基础分/附加分列)
        const thead = document.querySelector('#tb-indicator thead');
        thead.innerHTML = `
            <tr>
                <th rowspan="2">学校</th>
                <th colspan="4" style="background:#e0f2fe; color:#0369a1;">指标一 (参考分:${line1})</th>
                <th colspan="4" style="background:#fff7ed; color:#b45309;">指标二 (参考分:${line2})</th>
                <th rowspan="2">指标总分</th>
                <th rowspan="2">排名</th>
            </tr>
            <tr>
                <th>目标/达标</th><th>基础分</th><th>附加分</th><th>小计</th>
                <th>目标/达标</th><th>基础分</th><th>附加分</th><th>小计</th>
            </tr>
        `;

        let html = ''; 
        calcData.forEach(d => { 
            const isMySchool = d.name === MY_SCHOOL; 
            html += `
            <tr class="${isMySchool?'bg-highlight':''}">
                <td style="font-weight:bold;">${d.name}</td>
                
                <!-- 指标一 -->
                <td>
                    <!-- 👇 新增点击事件：点击目标人数，分析如何达标 -->
                    <span class="clickable-num" style="color:#d97706; border-bottom:1px dashed #d97706;" 
                          onclick="analyzeTargetGap('${d.name}', 'ind1', ${line1})" 
                          title="点击分析：哪些学生差一点就达标？补哪科？">
                        ${d.t1}
                    </span> / 
                    <strong class="clickable-num" onclick="handleIndicatorClick('${d.name}', 'ind1')">${d.r1}</strong>
                </td>
                <td>${d.base1.toFixed(2)}</td>
                <td style="color:${d.bonus1>0?'green':'#ccc'}; font-weight:bold;">${d.bonus1>0?'+':''}${d.bonus1.toFixed(2)}</td>
                <td style="background:#f0f9ff; font-weight:bold;">${d.score1.toFixed(2)}</td>
                
                <!-- 指标二 -->
                <td>
                    
                    <span class="clickable-num" style="color:#d97706; border-bottom:1px dashed #d97706;" 
                          onclick="analyzeTargetGap('${d.name}', 'ind2', ${line2})" 
                          title="点击分析：哪些学生差一点就达标？补哪科？">
                        ${d.t2}
                    </span> / 
                    <strong class="clickable-num" onclick="handleIndicatorClick('${d.name}', 'ind2')">${d.r2}</strong>
                </td>
                <td>${d.base2.toFixed(2)}</td>
                <td style="color:${d.bonus2>0?'green':'#ccc'}; font-weight:bold;">${d.bonus2>0?'+':''}${d.bonus2.toFixed(2)}</td>
                <td style="background:#fffaf0; font-weight:bold;">${d.score2.toFixed(2)}</td>
                
                <!-- 总分 -->
                <td class="text-red" style="font-size:1.1em; font-weight:bold;">${d.finalScore.toFixed(2)}</td>
                ${getRankHTML(d.rank)}
            </tr>`; 
        });
        document.querySelector('#tb-indicator tbody').innerHTML = html;
        
        UI.toast("✅ 指标生核算完成 (含附加分)", "success");
    }

    function analyzeTargetGap(schoolName, type, lineScore) {
        if (!SCHOOLS[schoolName]) return;
        const schoolData = SCHOOLS[schoolName];
        
        // 1. 获取该校的目标人数设定
        // 注意：TARGETS 是全局变量，存储了导入的目标配置
        const targetConfig = TARGETS[schoolName] || { t1: 0, t2: 0 };
        const targetCount = type === 'ind1' ? parseInt(targetConfig.t1) : parseInt(targetConfig.t2);
        
        if (!targetCount) return alert(`未找到 ${schoolName} 的目标设定，请先导入目标人数Excel。`);

        // 2. 将学生分为“已达标”和“未达标”两组
        // 按总分降序排列，保证未达标组的第一个就是离线最近的
        const allStudents = [...schoolData.students].sort((a,b) => b.total - a.total);
        const reached = allStudents.filter(s => s.total >= lineScore);
        const below = allStudents.filter(s => s.total < lineScore);

        // 3. 计算需要抓取的人数 (策略：补齐缺口 + 适当富余以便培优)
        const currentCount = reached.length;
        const gap = targetCount - currentCount; // 缺口人数
        
        // 设置“缓冲量”：比如为了保险起见，多抓取目标数的 10% 或至少 5 人
        const buffer = Math.ceil(targetCount * 0.1) || 5; 
        
        let countToFetch = 0;
        let strategyText = "";

        if (gap > 0) {
            // 情况A: 尚未达标 -> 抓取 (缺口 + 缓冲) 人
            countToFetch = gap + buffer;
            strategyText = `当前差 <strong style="color:red">${gap}</strong> 人达标。已为您筛选最接近目标的 <strong>${countToFetch}</strong> 名潜力生（含 ${buffer} 名保险备份）。`;
        } else {
            // 情况B: 已经达标 -> 依然推荐 (缓冲) 人，用于巩固防守
            countToFetch = buffer;
            strategyText = `当前已达标 (超 ${Math.abs(gap)} 人)。建议继续关注线下前 <strong>${countToFetch}</strong> 名学生，防止上线生波动下滑。`;
        }

        // 4. 截取名单
        let candidates = below.slice(0, countToFetch);

        if (candidates.length === 0) {
            return alert("线下没有更多学生可供挖掘了。");
        }

        // 5. 计算全镇各科均分 (作为诊断弱科的基准)
        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            gradeStats[sub] = allScores.reduce((a,b)=>a+b,0) / (allScores.length||1);
        });

        // 6. 深度分析每一位候选人 (计算差距 + 找弱科)
        candidates = candidates.map(s => {
            // A. 计算差距
            const scoreGap = lineScore - s.total;
            
           // 1. 确定计分科目范围 (避免政治等不计入总分的科目被错误推荐)
            // 逻辑：如果是9年级模式，CONFIG.totalSubs 只有[语,数,英,物,化]
            let validSubjects = SUBJECTS;
            if (CONFIG && Array.isArray(CONFIG.totalSubs)) {
                validSubjects = CONFIG.totalSubs;
            }

            // 2. 辅助函数：获取带老师姓名的学科名 (例如: "物理(张师)")
            const getSubWithTeacher = (sub) => {
                // 键名格式参考 generateTeacherInputs 函数: "班级_学科"
                const teacherKey = `${s.class}_${sub}`;
                let teacher = TEACHER_MAP[teacherKey];
                if (teacher) {
                    // 只取姓氏以节省空间，如 "张老师" -> "张"
                    const surname = teacher.charAt(0); 
                    return `${sub}<small style="color:#666; font-size:0.9em;">(${surname}师)</small>`;
                }
                return sub;
            };

            // 3. 遍历计算所有有效科目的分差
            let allDiffs = [];  // 存储所有科目差值 (用于挖掘潜力)
            let hardWeakness = []; // 存储明显弱项 (低于均分5分)

            validSubjects.forEach(sub => {
                if (s.scores[sub] !== undefined) {
                    // 核心算法：学生分数 - 年级均分 (正数=优势，负数=劣势)
                    const diff = s.scores[sub] - gradeStats[sub]; 
                    const item = { name: sub, diff: diff };
                    
                    allDiffs.push(item);
                    
                    // 阈值判定：低于均分 5 分算“硬伤”，需要优先补救
                    if (diff < -5) {
                        hardWeakness.push(item);
                    }
                }
            });

            // 按差值升序排序 (数值越小/越负，排在越前面，代表越需要补)
            allDiffs.sort((a, b) => a.diff - b.diff);
            hardWeakness.sort((a, b) => a.diff - b.diff);

            let worstSubName = "";
            let worstSubDiff = "";

            // 4. 决策逻辑：是补短板，还是挖潜力？
            if (hardWeakness.length > 0) {
                // 🛑 情况A：有明显弱科 (有科目低于均分5分) -> 显示最差的 2 科
                const targets = hardWeakness.slice(0, 2);
                
                worstSubName = targets.map(t => getSubWithTeacher(t.name)).join("、");
                worstSubDiff = targets.map(t => t.diff.toFixed(1)).join(" / ");
            } else {
                // 💡 情况B：无明显弱科 (各科都还行，但总分未达标) -> 强制挖掘相对最弱的 2 科作为潜力点
                const targets = allDiffs.slice(0, 2);
                
                if (targets.length > 0) {
                    // 加个 "潜力:" 前缀提示班主任这是相对弱项，不是绝对差
                    worstSubName = "<span style='font-size:10px; color:#666; border:1px solid #ccc; padding:0 2px; border-radius:2px; margin-right:2px;'>潜力</span>" + 
                                   targets.map(t => getSubWithTeacher(t.name)).join("、");
                    
                    // 显示分差 (正数加+号，提示老师其实这科可能已经高于均分了，只是在个人维度里算短板)
                    worstSubDiff = targets.map(t => (t.diff > 0 ? '+' : '') + t.diff.toFixed(1)).join(" / ");
                } else {
                    worstSubName = "数据不足";
                    worstSubDiff = "-";
                }
            }

            return {
                name: s.name,
                class: s.class,
                total: s.total,
                scoreGap: scoreGap, // 距离目标的总分差距
                worstSub: worstSubName, // 建议学科 (已带老师名)
                worstDiff: worstSubDiff // 与年级均分差
            };
        });

        // 7. 构建弹窗内容
        const typeName = type === 'ind1' ? '指标一' : '指标二';
        const title = `${schoolName} - ${typeName} 冲刺名单 (目标:${targetCount}人)`;
        
        let html = `
            <div class="info-bar">
                <div>🎯 <strong>划线分数：${lineScore} 分</strong></div>
                <div style="margin-top:4px;">📊 现状：已达标 ${currentCount} 人 / 目标 ${targetCount} 人。</div>
                <div style="margin-top:4px; color:#0369a1;">💡 策略：${strategyText}</div>
            </div>
            <div class="table-wrap">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>班级</th>
                            <th>姓名</th>
                            <th>当前总分</th>
                            <th>距划线差</th>
                            <th style="background:#fee2e2; color:#b91c1c;">🆘 建议补救学科</th>
                            <th>与年级均分差</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        candidates.forEach(c => {
            // 样式逻辑
            const isBalanced = c.worstSub.includes("潜力"); // 匹配"潜力"关键字
            const subStyle = isBalanced ? "color:#64748b; font-size:12px;" : "color:#b91c1c; font-weight:bold;";
            const diffStyle = isBalanced ? "color:#64748b;" : "color:#b91c1c; font-weight:bold;";
            
            // 🟢 计算进度百分比 (用于画进度条)
            // 比如 目标490，考了485 -> 进度 98.9%
            const percent = Math.min(100, (c.total / lineScore) * 100).toFixed(1);
            
            // 🟢 进度条颜色：越接近目标越红(警示/冲刺)，或者用绿色表示健康度？
            // 这里用黄色到绿色的渐变概念：>98% 用橙色(只差一口气)，<95% 用蓝色
            const barColor = percent >= 98 ? '#f59e0b' : '#3b82f6';

            html += `
                <tr>
                    <td style="vertical-align:middle;">${c.class}</td>
                    <td style="vertical-align:middle;">
                        <div style="font-weight:bold; font-size:14px;">${c.name}</div>
                    </td>
                    
                    <!-- 🟢 改造：当前总分 + 可视化进度条 -->
                    <td style="vertical-align:middle;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end; font-size:12px; margin-bottom:2px;">
                            <span style="font-weight:800; font-size:15px; color:#333;">${c.total}</span>
                            <span style="color:#94a3b8; transform:scale(0.9);">目标:${lineScore}</span>
                        </div>
                        <div style="width:100%; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;" title="达成率: ${percent}%">
                            <div style="width:${percent}%; height:100%; background:${barColor}; border-radius:3px;"></div>
                        </div>
                    </td>

                    <td style="vertical-align:middle;">
                        <span class="badge" style="background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe; font-size:12px;">
                            -${c.scoreGap.toFixed(1)}
                        </span>
                    </td>
                    
                    <td style="vertical-align:middle; ${subStyle}">
                        ${c.worstSub}
                    </td>
                    
                    <td style="vertical-align:middle; ${diffStyle}">
                        ${c.worstDiff}
                    </td>
                </tr>
            `;
        });

        html += `</tbody></table></div>`;

        // 8. 调用通用弹窗显示
        document.getElementById('drill-title').innerText = title;
        document.getElementById('drill-back-btn').classList.add('hidden');
        document.getElementById('drill-content').innerHTML = html;
        
        // 底部统计：按班级汇总潜力生人数，方便主任平衡各班指标
        // 简单的 reduce 统计
        const classCount = {};
        candidates.forEach(c => { classCount[c.class] = (classCount[c.class] || 0) + 1; });
        const classSummary = Object.entries(classCount)
            .map(([cls, cnt]) => `${cls}班:${cnt}人`)
            .join('， ');

        document.getElementById('drill-footer').innerText = `各班潜力生分布：${classSummary} (请平衡各班指标压力)`;
        
        // 🟢 关键：将计算好的 candidates 数组传给 DrillSystem，并标记类型为 'gap'
        DrillSystem.exportData = {
            type: 'gap',
            fileName: title, // 使用弹窗标题作为文件名
            data: candidates
        };
        
        // 🟢 确保导出按钮显示
        const exportBtn = document.getElementById('drill-export-btn');
        if(exportBtn) exportBtn.classList.remove('hidden');

        document.getElementById('drill-modal').style.display = 'flex';
    }

   function calcSummary(isSilent = false) {
        const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
        
        // 1. 汇总各项得分 (Object.values(SCHOOLS) 包含所有学校)
        const list = Object.values(SCHOOLS).map(s => {
            const s1 = s.score2Rate || 0;  // 两率一分
            const s2 = s.scoreBottom || 0; // 后1/3
            const s3 = s.scoreInd || 0;    // 指标生
            
            let s4 = 0; // 高分段赋分
            if (isGrade9 && s.highScoreStats) {
                s4 = s.highScoreStats.score || 0;
            }

            const total = s1 + s2 + s3 + s4;
            return { name: s.name, s1, s2, s3, s4, total };
        });

        // 2. 排序 (按综合总分降序)
        list.sort((a,b) => b.total - a.total).forEach((d,i) => d.rank = i+1);

        // 3. 动态生成表头
        const thead = document.querySelector('#tb-summary thead');
        let theadHtml = `<tr><th>学校名称</th><th>两率一分得分</th><th>后1/3得分</th><th>指标生得分</th>`;
        if (isGrade9) theadHtml += `<th style="color:#b45309; background:#fff7ed;">高分段赋分(70)</th>`;
        theadHtml += `<th>综合总分</th><th>总排名</th></tr>`;
        thead.innerHTML = theadHtml;

        // 4. 生成表格内容 (遍历所有，无截断)
        let html = ''; 
        list.forEach(d => { 
            const isMySchool = d.name === MY_SCHOOL; 
            let highScoreCell = '';
            if (isGrade9) highScoreCell = `<td style="color:#b45309; background:#fff7ed; font-weight:bold;">${d.s4.toFixed(2)}</td>`;

            html += `<tr class="${isMySchool?'bg-highlight':''}">
                <td>${d.name}</td>
                <td>${d.s1.toFixed(2)}</td>
                <td>${d.s2.toFixed(2)}</td>
                <td>${d.s3.toFixed(2)}</td>
                ${highScoreCell}
                <td class="text-red" style="font-size:16px; font-weight:bold;">${d.total.toFixed(2)}</td>
                ${getRankHTML(d.rank)}
            </tr>`;
        });
        document.querySelector('#tb-summary tbody').innerHTML = html;
               
        console.log(`综合排名已生成，共 ${list.length} 所学校`);
    }

    async function exportPPTReport() {
        // --- 0. 基础数据校验 ---
        if (Object.keys(SCHOOLS).length === 0) { 
            alert("暂无数据，无法生成汇报。"); 
            return; 
        }
        var checkSchool = Object.values(SCHOOLS)[0];
        if (!checkSchool.score2Rate) { 
            alert("请先点击【生成总排名】按钮，计算完各项指标后再导出。"); 
            return; 
        }

        // --- 1. PPT 初始化 ---
        var pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9'; 
        pptx.title = CONFIG.name + " 质量分析汇报";
        
        // 颜色定义
        var colorMain = "1E3A8A";    // 深蓝
        var colorSub = "3B82F6";     // 亮蓝
        var colorAccent = "D97706";  // 金色
        var colorBg = "F8FAFC";      // 浅灰背景
        var colorDanger = "DC2626";  // 红色
        var colorSuccess = "166534"; // 绿色

        // --- 2. 母版定义 ---
        pptx.defineSlideMaster({
            title: 'EXEC_REPORT',
            background: { color: colorBg },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.6, fill: colorMain } },
                { text: { text: CONFIG.name + " 教学质量监测", x: 0.3, y: 0.15, w: 5, h: 0.3, fontSize: 14, color: "FFFFFF", bold: true } },
                { line: { x: 0.5, y: 6.8, w: 9.0, h: 0, line: { color: "CBD5E1", width: 1 } } },
                { text: { text: "内部教研数据 · 请勿外传", x: 0.5, y: 6.9, w: 4, h: 0.3, fontSize: 9, color: "94A3B8" } }
            ],
            slideNumber: { x: 9.5, y: 6.9, fontSize: 9, color: "94A3B8" } // 右下角页码
        });

        // 辅助函数：将长表格数据分页
        // rows: 表格数据数组（包含表头）
        // maxRowsPerPage: 每页最大行数（含表头）
        function splitTableToSlides(rows, maxRowsPerPage, titleText) {
            var header = rows[0];
            var dataRows = rows.slice(1);
            var chunks = [];
            // 第一页能放 maxRowsPerPage - 1 行数据
            var i = 0;
            while (i < dataRows.length) {
                chunks.push(dataRows.slice(i, i + maxRowsPerPage - 1));
                i += (maxRowsPerPage - 1);
            }
            
            chunks.forEach(function(chunk, index) {
                var slide = pptx.addSlide({ masterName: 'EXEC_REPORT' });
                var pageTitle = titleText + (chunks.length > 1 ? " (" + (index + 1) + "/" + chunks.length + ")" : "");
                slide.addText(pageTitle, { x: 0.5, y: 0.8, fontSize: 18, bold: true, color: colorMain });
                
                // 组合表头和当前页数据
                var currentTable = [header].concat(chunk);
                // 渲染表格
                slide.addTable(currentTable, { 
                    x: 0.5, y: 1.3, w: 9.0, // 宽度调整适应 16:9
                    fontSize: 9, rowH: 0.35, // 字体缩小，行高缩小
                    border: { color: "E2E8F0", pt:0, pb:0 },
                    autoPage: false // 手动分页
                });
            });
        }

        // --- 3. 封面页 ---
        var slide1 = pptx.addSlide();
        slide1.background = { color: "FFFFFF" };
        slide1.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: "100%", h: 2.5, fill: colorMain });
        slide1.addText("教学质量分析汇报", { x: 0.5, y: 1.2, w: "90%", h: 1, fontSize: 44, bold: true, color: "FFFFFF", fontFace: "黑体" });
        slide1.addText(CONFIG.name + " · " + new Date().getFullYear() + "年", { x: 0.5, y: 0.8, fontSize: 18, color: "93C5FD" });
        
        slide1.addText("汇报概要", { x: 0.5, y: 3.5, fontSize: 14, color: colorMain, bold: true });
        slide1.addShape(pptx.ShapeType.line, { x: 0.5, y: 3.8, w: 0.5, h: 0, line: {color: colorAccent, width: 2} });
        var summaryText = "本次考试共覆盖 " + Object.keys(SCHOOLS).length + " 所学校，参考学生 " + RAW_DATA.length + " 人。\n" +
                          "分析维度包含：两率一分、后1/3转化、指标生完成度及学科均衡性诊断。";
        slide1.addText(summaryText, { x: 0.5, y: 4.0, w: 8, h: 1.5, fontSize: 12, color: "64748B", lineSpacing: 18 });

        // --- 4. 领导看板页 ---
        var slide2 = pptx.addSlide({ masterName: 'EXEC_REPORT' });
        slide2.addText("核心指标看板", { x: 0.5, y: 0.8, fontSize: 20, bold: true, color: colorMain });
        
        var allScores = RAW_DATA.map(function(s) { return s.total; });
        var totalSum = allScores.reduce(function(a, b) { return a + b; }, 0);
        var townAvg = totalSum / allScores.length;
        var townMax = Math.max.apply(null, allScores);
        var sortedSchools = Object.values(SCHOOLS).sort(function(a, b) { return (a.rank2Rate || 999) - (b.rank2Rate || 999); });
        var topSchool = sortedSchools[0];

        // 调整卡片布局以适应更多学校（稍微紧凑一点）
        // 卡片1: 人数
        slide2.addShape(pptx.ShapeType.roundRect, { x: 0.5, y: 1.5, w: 2.0, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(RAW_DATA.length, { x: 0.5, y: 1.7, w: 2.0, h: 0.6, fontSize: 24, bold: true, color: colorMain, align: 'center' });
        slide2.addText("参考人数", { x: 0.5, y: 2.3, w: 2.0, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // 卡片2: 学校数
        slide2.addShape(pptx.ShapeType.roundRect, { x: 2.8, y: 1.5, w: 2.0, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(Object.keys(SCHOOLS).length, { x: 2.8, y: 1.7, w: 2.0, h: 0.6, fontSize: 24, bold: true, color: colorSub, align: 'center' });
        slide2.addText("学校总数", { x: 2.8, y: 2.3, w: 2.0, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // 卡片3: 均分
        slide2.addShape(pptx.ShapeType.roundRect, { x: 5.1, y: 1.5, w: 2.0, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(townAvg.toFixed(1), { x: 5.1, y: 1.7, w: 2.0, h: 0.6, fontSize: 24, bold: true, color: colorSub, align: 'center' });
        slide2.addText("全镇均分", { x: 5.1, y: 2.3, w: 2.0, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // 卡片4: 榜首 (稍微加宽)
        slide2.addShape(pptx.ShapeType.roundRect, { x: 7.4, y: 1.5, w: 2.2, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(topSchool.name.substring(0,6), { x: 7.4, y: 1.7, w: 2.2, h: 0.6, fontSize: 18, bold: true, color: colorAccent, align: 'center' });
        slide2.addText("综合NO.1", { x: 7.4, y: 2.3, w: 2.2, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // 图表：改为显示所有学校
        slide2.addText("🏆 综合考核得分排名", { x: 0.5, y: 3.5, fontSize: 14, bold: true, color: "1E293B" });
        
        // 移除 slice(0,10)，显示所有学校
        var chartSchools = sortedSchools; 
        
        var chartLabels = chartSchools.map(function(s) { return s.name; });
        var chartValues = chartSchools.map(function(s) { return ((s.score2Rate||0) + (s.scoreBottom||0) + (s.scoreInd||0) + ((s.highScoreStats?s.highScoreStats.score:0)||0)).toFixed(1); });

        slide2.addChart(pptx.ChartType.bar, [{
            name: "考核总分", labels: chartLabels, values: chartValues
        }], {
            x: 0.5, y: 4.0, w: 9.0, h: 3.0, 
            barDir: 'col', chartColors: [colorMain], barGapWidthPct: 40,
            dataLabelPosition: "outEnd", showValue: true, showLegend: false,
            valAxisHidden: true, gridLineNone: true,
            // 动态调整字体大小：学校越多字体越小，防止重叠
            catAxisLabelFontSize: chartSchools.length > 15 ? 7 : 9 
        });

        // --- 5. 第三页：综合总表 (自动分页) ---
        var headers = [
            { text: "排名", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 0.6 } },
            { text: "学校", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'left', w: 1.8 } },
            { text: "人数", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 0.8 } },
            { text: "两率一分", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } },
            { text: "后1/3得分", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } },
            { text: "指标生得分", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } },
            { text: "综合总分", options: { fill: colorAccent, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } }
        ];

        var tableRows = [headers];
        sortedSchools.forEach(function(s, i) {
            var isTop3 = i < 3;
            var bgColor = (i % 2 === 0) ? "FFFFFF" : "F1F5F9";
            var boldOpts = isTop3 ? { bold: true, color: colorDanger } : { color: "1E293B" };
            var totalScore = (s.score2Rate||0) + (s.scoreBottom||0) + (s.scoreInd||0);

            tableRows.push([
                { text: i + 1, options: { fill: bgColor, align: 'center', bold: boldOpts.bold, color: boldOpts.color } },
                { text: s.name, options: { fill: bgColor, align: 'left', bold: boldOpts.bold, color: boldOpts.color } },
                { text: s.metrics.total ? s.metrics.total.count : 0, options: { fill: bgColor, align: 'center', color: "64748B" } },
                { text: (s.score2Rate || 0).toFixed(1), options: { fill: bgColor, align: 'center' } },
                { text: (s.scoreBottom || 0).toFixed(1), options: { fill: bgColor, align: 'center' } },
                { text: (s.scoreInd || 0).toFixed(1), options: { fill: bgColor, align: 'center' } },
                { text: totalScore.toFixed(2), options: { fill: bgColor, align: 'center', bold: true, color: colorMain } }
            ]);
        });
        
        // 调用分页函数：每页最多 12 行 (含表头)
        splitTableToSlides(tableRows, 12, "综合考核总表");

        // --- 6. 循环生成学科页 (分页表格 + 分页图表) ---
        SUBJECTS.forEach(function(sub) {
            // 获取该学科数据并排序
            var subData = Object.values(SCHOOLS).filter(function(s) { return s.metrics[sub] !== undefined; })
                .sort(function(a, b) { return b.metrics[sub].avg - a.metrics[sub].avg; });

            if(subData.length === 0) return;

            // 6.1 生成学科表格页 (可能有多页)
            var subHeaders = [
                { text: "排名", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 0.6 } },
                { text: "学校", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'left', w: 1.8 } },
                { text: "均分", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 1.0 } },
                { text: "优秀率", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 1.0 } },
                { text: "及格率", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 1.0 } }
            ];
            
            var subRows = [subHeaders];
            subData.forEach(function(s, i) {
                var m = s.metrics[sub];
                subRows.push([
                    i + 1, 
                    s.name, 
                    m.avg.toFixed(1), 
                    (m.excRate * 100).toFixed(1) + "%",
                    (m.passRate * 100).toFixed(1) + "%"
                ]);
            });
            // 每页 12 行表格
            splitTableToSlides(subRows, 12, "📘 " + sub + " · 数据详情");

            // 6.2 生成学科图表页 (一页展示前10，如果超多再加页，这里为了PPT简洁，只展示一页概览图表)
            var subChartSlide = pptx.addSlide({ masterName: 'EXEC_REPORT' });
            subChartSlide.addText("📘 " + sub + " · 校际横向对比", { x: 0.5, y: 0.8, fontSize: 18, bold: true, color: colorMain });

            // 图表数据 (如果超过14个学校，X轴字体自动缩小)
            var chartNames = subData.map(function(s) { return s.name; });
            var chartAvgs = subData.map(function(s) { return s.metrics[sub].avg; });
            
            // 计算极差用于诊断
            var topSc = subData[0];
            var botSc = subData[subData.length - 1];
            var gap = (topSc.metrics[sub].avg - botSc.metrics[sub].avg).toFixed(1);
            var gapColor = parseFloat(gap) > 10 ? colorDanger : colorSuccess;

            // 绘制横向条形图
            subChartSlide.addChart(pptx.ChartType.bar, [{
                name: "平均分", labels: chartNames, values: chartAvgs
            }], {
                x: 0.5, y: 1.3, w: 9.0, h: 4.5, // 占满宽度
                barDir: 'col', // 改为纵向柱状图，能放下更多学校
                chartColors: [colorSub],
                dataLabelPosition: "outEnd", showValue: true, showLegend: false,
                catAxisLabelFontSize: chartNames.length > 10 ? 8 : 10, // 自适应字体
                title: { text: "校际均分排名", fontSize: 11, color: "64748B" }
            });

            // 底部诊断
            subChartSlide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 6.0, w: 9.0, h: 0.8, fill: "FFFBEB", line: { color: "FCD34D", width: 1 } });
            subChartSlide.addText("💡 智能诊断结论：", { x: 0.6, y: 6.1, fontSize: 10, bold: true, color: colorAccent });
            subChartSlide.addText([
                { text: "本学科第一名为 ", options: { color: "475569" } },
                { text: topSc.name, options: { bold: true, color: colorMain } },
                { text: "，最后一名为 " + botSc.name + "。校际极差达 ", options: { color: "475569" } },
                { text: gap + "分", options: { bold: true, color: gapColor } },
                { text: "。建议关注后进学校的 " + sub + " 学科教学整改。", options: { color: "475569" } }
            ], { x: 0.6, y: 6.4, w: 8.5, h: 0.4, fontSize: 10 });
        });

        // --- 7. 导出 ---
        var dateStr = new Date().toISOString().slice(0,10);
        pptx.writeFile({ fileName: CONFIG.name + "_汇报材料_" + dateStr + ".pptx" });
    }
    function exportTeacherAnalysis() {
        if (!MY_SCHOOL || Object.keys(TEACHER_STATS).length === 0) { alert('请先选择本校并配置教师信息'); return; }
        analyzeTeachers();
        alert('教师分析数据已准备就绪，请查看"本校教师分析"标签页');
    }

    function updateSegmentSelects() {
        const schSel = document.getElementById('segSchoolSelect'); const subSel = document.getElementById('segSubjectSelect'); const oldSch = schSel.value;
        schSel.innerHTML = '<option value="ALL">全乡镇</option>'; Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSch && (oldSch === 'ALL' || SCHOOLS[oldSch])) schSel.value = oldSch;
        const oldSub = subSel.value; subSel.innerHTML = '<option value="total">总分</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSub) subSel.value = oldSub;
    }

    function renderSegmentAnalysis() {
        const school = document.getElementById('segSchoolSelect').value; 
        const subject = document.getElementById('segSubjectSelect').value; 
        const step = parseInt(document.getElementById('segStep').value) || 10;
        
        let students = school === 'ALL' ? RAW_DATA : (SCHOOLS[school] ? SCHOOLS[school].students : []);
       const validStudents = students.filter(s => {
            const v = subject === 'total' ? s.total : s.scores[subject];
            return typeof v === 'number';
        }).map(s => ({
            ...s, // 浅拷贝学生信息
            _filterScore: subject === 'total' ? s.total : s.scores[subject] 
        }));

        const scores = validStudents.map(s => s._filterScore); // 兼容旧逻辑的 scores 数组用于计算 max/total
        
        if(!scores.length) { alert('没有找到相关成绩数据'); return; }
        
        const maxScore = Math.ceil(Math.max(...scores)); 
        const topCeil = Math.ceil(maxScore / step) * step;
        
        let html = `<thead><tr><th>分数段</th><th>人数</th><th>累计人数</th><th>比例</th><th>累计比例</th></tr></thead><tbody>`; 
        let cumulative = 0, total = scores.length;
        
        // 🟢 准备图表数据容器
        const rowsData = []; // 临时存储数据以便后续给图表使用

        // 从高到低遍历生成表格
        for(let high = topCeil; high > 0; high -= step) {
            const low = high - step; 
            const isTopBucket = high === topCeil; 
            const bucketList = validStudents.filter(s => {
                const val = s._filterScore;
                return val >= low && (isTopBucket ? val <= high : val < high);
            });
            const count = bucketList.length;
            
            // 优化：去掉两头均为0的空行，但保留中间的0以体现断层
            if(count === 0 && cumulative === 0) continue; 
            
            cumulative += count; 
            
            const label = `${low}-${high}`;
            
            html += `<tr><td>${label} 分</td><td>${count}</td><td>${cumulative}</td><td>${(count/total*100).toFixed(2)}%</td><td>${(cumulative/total*100).toFixed(2)}%</td></tr>`;
            
            // 收集图表数据 (使用 unshift 存入头部，保证图表是从低分到高分排列，符合直方图习惯)
            rowsData.unshift({ 
                label: label, 
                count: count,
                studentList: bucketList // 👈 关键：保存该分数段的学生名单
            });
        }
        
        document.getElementById('tb-segment').innerHTML = html + `</tbody>`;

        // 🟢 绘制图表核心逻辑
        const ctx = document.getElementById('segmentChart');
        if (ctx) {
            // 如果已有图表实例，先销毁，防止重影
            if (segmentChartInstance) segmentChartInstance.destroy();
            
            segmentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rowsData.map(d => d.label),
                    datasets: [{
                        label: '人数分布',
                        data: rowsData.map(d => d.count),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // 蓝色柱体
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.9, // 让柱子宽一点，更有直方图的感觉
                        categoryPercentage: 0.9,
                        order: 2
                    }, {
                        // 增加一条平滑曲线 (趋势线)
                        type: 'line',
                        label: '分布趋势',
                        data: rowsData.map(d => d.count),
                        borderColor: '#f59e0b', // 橙色线条
                        borderWidth: 2,
                        tension: 0.4, // 平滑曲线
                        pointRadius: 0,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (!elements || elements.length === 0) return;
                        
                        // 获取被点击的数据点索引
                        const index = elements[0].index;
                        const dataItem = rowsData[index];
                        
                        if (dataItem && dataItem.count > 0) {
                            // 调用 DrillSystem (钻取系统) 显示该分数段的学生名单
                            // 标题如：全镇 语文 分数段详情 (110-120)
                            const title = `${school === 'ALL' ? '全镇' : school} ${subject} 分数段详情 (${dataItem.label})`;
                            DrillSystem.open(title, dataItem.studentList);
                        } else {
                            UI.toast('该分数段暂无学生', 'info');
                        }
                    },
                    onHover: (event, chartElement) => {
                        // 鼠标悬停时变成小手图标，提示可点击
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    plugins: {
                        legend: { display: true },
                        title: { 
                            display: true, 
                            text: `${school === 'ALL' ? '全镇' : school} ${subject} 成绩分布直方图 (💡点击柱子可查看名单)`,
                            font: { size: 16 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: '人数' } 
                        },
                        x: {
                            title: { display: true, text: '分数段 (低 → 高)' }
                        }
                    }
                }
            });
        }
    }

    function exportSegmentExcel() {
        const table = document.getElementById('tb-segment');
        if(!table || !table.rows.length) return alert("请先生成统计表");
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, "分数段统计.xlsx");
    }

    function updateClassCompSchoolSelect() {
        const sel = document.getElementById('classCompSchoolSelect'); sel.innerHTML = '<option value="">--请选择学校--</option>'; Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
    }

    function renderClassComparison() {
        const schoolName = document.getElementById('classCompSchoolSelect').value; if(!schoolName || !SCHOOLS[schoolName]) { alert('请选择有效学校'); return; }
        const sch = SCHOOLS[schoolName]; const classes = {}; sch.students.forEach(s => { if(!classes[s.class]) classes[s.class] = []; classes[s.class].push(s); });
        const classList = Object.keys(classes).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        const classSubjectRanks = {}; // 存储结构: { "701班": { "语文": 1, "数学": 5 } }
        SUBJECTS.forEach(sub => {
            const subStats = classList.map(c => {
                const scores = classes[c].map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const avg = scores.length > 0 ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
                return { name: c, avg };
            });
            subStats.sort((a, b) => b.avg - a.avg);
            subStats.forEach((stat, index) => {
                if(!classSubjectRanks[stat.name]) classSubjectRanks[stat.name] = {};
                classSubjectRanks[stat.name][sub] = index + 1;
            });
        });
        const container = document.getElementById('class-comp-results'); const sideNavClassSubjects = document.getElementById('side-nav-class-subjects'); container.innerHTML = ''; sideNavClassSubjects.innerHTML = ''; 
        let html = '';
        // 1. 准备矩阵数据
        // classSubjectRanks 结构: { "701班": { "语文": 1, "数学": 5 } }
        // classList 是所有班级名的数组
        
        let matrixHtml = `
            <div class="anchor-target" id="anchor-matrix">
                <div class="sub-header" style="background:linear-gradient(to right, #fdf4ff, transparent); border-left-color:#d946ef; color:#86198f;">
                    🧩 班级学科均衡性全景矩阵 (数字为校内排名)
                </div>
                <div class="table-wrap">
                    <table class="comparison-table" style="text-align:center;">
                        <thead>
                            <tr>
                                <th style="width:80px; background:#faf5ff;">班级</th>
                                <!-- 动态生成学科表头 -->
                                ${SUBJECTS.map(s => `<th>${s}</th>`).join('')}
                                <th style="border-left:2px solid #eee;">综合</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        // 1. 判断当前是否为 9 年级模式
        const isGrade9Mode = CONFIG.name && CONFIG.name.includes('9');

        classList.forEach(cls => {
            const ranks = classSubjectRanks[cls] || {};
            // 计算该班所有学科排名的平均值 (衡量整体实力)
            let rankSum = 0;
            let validCount = 0;
            
            let rowCells = SUBJECTS.map(sub => {
                const r = ranks[sub] || '-';
                if (typeof r === 'number') {
                    
                    // 🟢 核心修改：如果是 9 年级模式且科目是政治，则不计入综合分
                    let shouldCount = true;
                    if (isGrade9Mode && (sub === '政治' || sub === '道法' || sub === '道德与法治')) {
                        shouldCount = false; 
                    }

                    if (shouldCount) {
                        rankSum += r;
                        validCount++;
                    }
                    
                    // 样式逻辑：前3名绿，后3名红 (假设班级数>5)
                    let style = "";
                    if (classList.length >= 5) {
                        if (r <= 3) style = "color:#16a34a; font-weight:bold; background:#dcfce7;";
                        else if (r > classList.length - 3) style = "color:#dc2626; font-weight:bold; background:#fee2e2;";
                    } else {
                        // 班级少时，第1名绿，最后1名红
                        if (r === 1) style = "color:#16a34a; font-weight:bold; background:#dcfce7;";
                        else if (r === classList.length) style = "color:#dc2626; font-weight:bold; background:#fee2e2;";
                    }
                    return `<td style="${style}">${r}</td>`;
                }
                return `<td style="color:#ccc;">-</td>`;
            }).join('');

            // 计算平均排名 (排除政治后的)
            const avgRank = validCount > 0 ? (rankSum / validCount).toFixed(1) : '-';

            matrixHtml += `
                <tr>
                    <td style="font-weight:bold; background:#faf5ff;">${cls}</td>
                    ${rowCells}
                    <td style="border-left:2px solid #eee; font-weight:bold;">${avgRank}</td>
                </tr>
            `;
        });

        matrixHtml += `</tbody></table></div>
            <div style="font-size:12px; color:#666; margin-top:5px; margin-bottom:20px; padding:5px;">
                💡 <strong>读图指南：</strong> 
                <span style="background:#dcfce7; color:#16a34a; padding:0 4px;">绿色</span> 代表该科进入前3名 (优势)，
                <span style="background:#fee2e2; color:#dc2626; padding:0 4px;">红色</span> 代表该科处于后3名 (短板)。
                横向看班级偏科情况，纵向看学科整体水平。
            </div>
        </div>`;

        // 将矩阵添加到总 HTML 的最前面
        html += matrixHtml;
        const rankIt = (arr, key) => { const sorted = [...arr].sort((a,b) => b[key] - a[key]); arr.forEach(item => item[key+'Rank'] = sorted.indexOf(item) + 1); };
        const allStudents = sch.students;
        const gradeTotalScores = allStudents.map(s => s.total); const gradeTotalLen = gradeTotalScores.length || 1; const gradeTotalAvg = gradeTotalScores.reduce((a,b)=>a+b,0) / gradeTotalLen; const gradeTotalExc = gradeTotalScores.filter(v => v >= (THRESHOLDS.total?.exc||0)).length / gradeTotalLen; const gradeTotalPass = gradeTotalScores.filter(v => v >= (THRESHOLDS.total?.pass||0)).length / gradeTotalLen;
        const anchorTotal = 'anchor-class-total';
        html += `<div id="${anchorTotal}" class="anchor-target"><div class="sub-header">📊 ${CONFIG.label}</div><div class="table-wrap"><table class="comparison-table"><thead><tr><th>班级</th><th>人数</th><th>平均分</th><th>校排</th><th>优秀率</th><th>及格率</th><th style="background:#fff7ed; color:#c2410c; min-width:150px;">🏗️ 木桶效应诊断 (学科均衡性)</th></tr></thead><tbody>`;
        const totalStats = classList.map(c => {
            const scores = classes[c].map(s => s.total); const len = scores.length || 1; const avg = scores.reduce((a,b)=>a+b,0)/len; const exc = scores.filter(v => v >= (THRESHOLDS.total?.exc||0)).length / len; const pass = scores.filter(v => v >= (THRESHOLDS.total?.pass||0)).length / len;
            const avgDiff = gradeTotalAvg ? (avg - gradeTotalAvg)/gradeTotalAvg : 0; const excDiff = gradeTotalExc ? (exc - gradeTotalExc)/gradeTotalExc : 0; const passDiff = gradeTotalPass ? (pass - gradeTotalPass)/gradeTotalPass : 0;
            return { name: c, count: scores.length, avg, exc, pass, avgDiff, excDiff, passDiff };
        });
        rankIt(totalStats, 'avg'); rankIt(totalStats, 'exc'); rankIt(totalStats, 'pass');
        totalStats.forEach(stat => {let diagnosisHtml = '';
            const totalRank = stat.avgRank; // 班级总分排名
            
            SUBJECTS.forEach(sub => {
                const subRank = classSubjectRanks[stat.name][sub];
                // 逻辑：如果单科排名比总排名落后 2 名以上，视为“短板”；领先 2 名以上视为“优势”
                if (subRank >= totalRank + 2) {
                    diagnosisHtml += `<span class="plank-badge plank-drag" title="${sub}排名(${subRank})显著低于总分排名(${totalRank})">🔻${sub}</span>`;
                } else if (subRank <= totalRank - 2) {
                    diagnosisHtml += `<span class="plank-badge plank-lift" title="${sub}排名(${subRank})显著高于总分排名(${totalRank})">▲${sub}</span>`;
                }
            });
            if(!diagnosisHtml) diagnosisHtml = '<span style="color:#94a3b8; font-size:11px;">各科均衡</span>';html += `<tr>
                <td><strong>${stat.name}</strong></td>
                <td>${stat.count}</td>
                <td>${stat.avg.toFixed(2)}</td>
                <td>${getRankHTML(stat.avgRank)}</td>
                <td>${(stat.exc*100).toFixed(1)}%</td>
                <td>${(stat.pass*100).toFixed(1)}%</td>
                <td style="text-align:left; background:#fffaf5;">${diagnosisHtml}</td>
            </tr>`;  });
        html += `</tbody></table></div></div>`;
        SUBJECTS.forEach(sub => {
            const gradeSubScores = allStudents.map(s => s.scores[sub]).filter(v => typeof v === 'number'); const gradeSubLen = gradeSubScores.length || 1; const gradeSubAvg = gradeSubScores.reduce((a,b)=>a+b,0) / gradeSubLen; const gradeSubExc = gradeSubScores.filter(v => v >= THRESHOLDS[sub].exc).length / gradeSubLen; const gradeSubPass = gradeSubScores.filter(v => v >= THRESHOLDS[sub].pass).length / gradeSubLen;
            const anchorSub = `anchor-class-${sub}`;
            html += `<div id="${anchorSub}" class="anchor-target" style="padding-top:20px;"><div class="sub-header">📘 ${sub}</div><div class="table-wrap"><table class="comparison-table"><thead><tr><th>班级</th><th>人数</th><th>平均分</th><th>与级比</th><th>校排</th><th>优秀率</th><th>与级比</th><th>校排</th><th>及格率</th><th>与级比</th><th>校排</th></tr></thead><tbody>`;
            const subStats = classList.map(c => {
                const scores = classes[c].map(s => s.scores[sub]).filter(v => typeof v === 'number'); const len = scores.length || 1; const avg = len > 0 ? scores.reduce((a,b)=>a+b,0)/len : 0; const exc = len > 0 ? scores.filter(v => v >= THRESHOLDS[sub].exc).length / len : 0; const pass = len > 0 ? scores.filter(v => v >= THRESHOLDS[sub].pass).length / len : 0;
                const avgDiff = (gradeSubAvg && avg) ? (avg - gradeSubAvg)/gradeSubAvg : 0; const excDiff = (gradeSubExc && exc) ? (exc - gradeSubExc)/gradeSubExc : 0; const passDiff = (gradeSubPass && pass) ? (pass - gradeSubPass)/gradeSubPass : 0;
                return { name: c, count: scores.length, avg, exc, pass, avgDiff, excDiff, passDiff };
            });
            rankIt(subStats, 'avg'); rankIt(subStats, 'exc'); rankIt(subStats, 'pass');
            subStats.forEach(stat => { html += `<tr><td>${stat.name}</td><td>${stat.count}</td><td>${stat.avg.toFixed(2)}</td><td class="${stat.avgDiff>=0?'positive-percent':'negative-percent'}">${stat.avgDiff>=0?'+':''}${(stat.avgDiff*100).toFixed(2)}%</td><td>${stat.avgRank}</td><td>${(stat.exc*100).toFixed(2)}%</td><td class="${stat.excDiff>=0?'positive-percent':'negative-percent'}">${stat.excDiff>=0?'+':''}${(stat.excDiff*100).toFixed(2)}%</td><td>${stat.excRank}</td><td>${(stat.pass*100).toFixed(2)}%</td><td class="${stat.passDiff>=0?'positive-percent':'negative-percent'}">${stat.passDiff>=0?'+':''}${(stat.passDiff*100).toFixed(2)}%</td><td>${stat.passRank}</td></tr>`; });
            html += `</tbody></table></div></div>`;
            const navLink = document.createElement('a'); navLink.className = 'side-nav-sub-link'; navLink.innerText = sub; navLink.onclick = () => scrollToSubAnchor(anchorSub, navLink); sideNavClassSubjects.appendChild(navLink);
        });
        container.innerHTML = html;
    }

    function exportClassComparisonExcel() {
        const schoolName = document.getElementById('classCompSchoolSelect').value;
        if(!schoolName || !SCHOOLS[schoolName]) return alert("请先进行对比分析");
        const sch = SCHOOLS[schoolName];
        const classes = {}; sch.students.forEach(s => { if(!classes[s.class]) classes[s.class] = []; classes[s.class].push(s); });
        const classList = Object.keys(classes).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        
        const wb = XLSX.utils.book_new();
        const rankIt = (arr, key) => { const sorted = [...arr].sort((a,b) => b[key] - a[key]); arr.forEach(item => item[key+'Rank'] = sorted.indexOf(item) + 1); };

        const allStudents = sch.students;
        const gAvg = allStudents.reduce((a,b)=>a+b.total,0) / allStudents.length;
        const gExc = allStudents.filter(v => v.total >= (THRESHOLDS.total?.exc||0)).length / allStudents.length;
        const gPass = allStudents.filter(v => v.total >= (THRESHOLDS.total?.pass||0)).length / allStudents.length;

        const totalStats = classList.map(c => {
            const scores = classes[c].map(s => s.total); const len = scores.length;
            const avg = scores.reduce((a,b)=>a+b,0)/len; 
            const exc = scores.filter(v => v >= (THRESHOLDS.total?.exc||0)).length / len; 
            const pass = scores.filter(v => v >= (THRESHOLDS.total?.pass||0)).length / len;
            return { name: c, count: len, avg, exc, pass, 
                     avgDiff: gAvg ? (avg-gAvg)/gAvg : 0, 
                     excDiff: gExc ? (exc-gExc)/gExc : 0, 
                     passDiff: gPass ? (pass-gPass)/gPass : 0 };
        });
        rankIt(totalStats, 'avg'); rankIt(totalStats, 'exc'); rankIt(totalStats, 'pass');

        const wsTotalData = [["班级", "人数", "平均分", "与级比", "校排", "优秀率", "与级比", "校排", "及格率", "与级比", "校排"]];
        totalStats.forEach(s => {
            wsData = [s.name, s.count, getExcelNum(s.avg), getExcelPercent(s.avgDiff), s.avgRank, getExcelPercent(s.exc), getExcelPercent(s.excDiff), s.excRank, getExcelPercent(s.pass), getExcelPercent(s.passDiff), s.passRank];
            wsTotalData.push(wsData);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsTotalData), CONFIG.label);

        SUBJECTS.forEach(sub => {
            const gScores = allStudents.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            const subAvg = gScores.length ? gScores.reduce((a,b)=>a+b,0)/gScores.length : 0;
            const subExc = gScores.length ? gScores.filter(v => v >= THRESHOLDS[sub].exc).length / gScores.length : 0;
            const subPass = gScores.length ? gScores.filter(v => v >= THRESHOLDS[sub].pass).length / gScores.length : 0;

            const subStats = classList.map(c => {
                const scores = classes[c].map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const len = scores.length || 1; 
                const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/len : 0;
                const exc = scores.length ? scores.filter(v => v >= THRESHOLDS[sub].exc).length / len : 0;
                const pass = scores.length ? scores.filter(v => v >= THRESHOLDS[sub].pass).length / len : 0;
                return { name: c, count: scores.length, avg, exc, pass,
                         avgDiff: subAvg ? (avg-subAvg)/subAvg : 0,
                         excDiff: subExc ? (exc-subExc)/subExc : 0,
                         passDiff: subPass ? (pass-subPass)/subPass : 0 };
            });
            rankIt(subStats, 'avg'); rankIt(subStats, 'exc'); rankIt(subStats, 'pass');

            const wsSubData = [["班级", "人数", "平均分", "与级比", "校排", "优秀率", "与级比", "校排", "及格率", "与级比", "校排"]];
            subStats.forEach(s => {
                wsData = [s.name, s.count, getExcelNum(s.avg), getExcelPercent(s.avgDiff), s.avgRank, getExcelPercent(s.exc), getExcelPercent(s.excDiff), s.excRank, getExcelPercent(s.pass), getExcelPercent(s.passDiff), s.passRank];
                wsSubData.push(wsData);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsSubData), sub);
        });
        XLSX.writeFile(wb, "班级横向对比分析.xlsx");
    }

    // 1. 初始化下拉框
    function updateSubjectBalanceSelects() {
        const schSel = document.getElementById('sbSchoolSelect');
        const clsSel = document.getElementById('sbClassSelect');
        
        schSel.innerHTML = '<option value="">--请选择学校--</option>';
        Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`);
        
        // 联动更新班级
        schSel.onchange = () => {
            clsSel.innerHTML = '<option value="">全部</option>';
            if(schSel.value && SCHOOLS[schSel.value]) {
                const classes = [...new Set(SCHOOLS[schSel.value].students.map(s => s.class))].sort();
                classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`);
            }
        };
    }

    let SB_CACHE_DATA = []; // 缓存用于导出

    // 2. 渲染主表格
    function SB_renderTable() {
        const sch = document.getElementById('sbSchoolSelect').value;
        const cls = document.getElementById('sbClassSelect').value;
        const sortType = document.getElementById('sbSortBy').value;

        if(!sch) return alert("请先选择学校");

        // A. 筛选学生
        let students = SCHOOLS[sch].students;
        if(cls && cls !== '全部') students = students.filter(s => s.class === cls);

        // B. 计算全镇各科均分 (作为基准线)
        const gradeStats = SB_getGradeStats();

        // C. 处理每个学生的数据
        const renderList = students.map(s => {
            const items = [];
            let maxDiff = -999;
            let minDiff = 999;

            SUBJECTS.forEach(sub => {
                if(s.scores[sub] === undefined) return;
                const diff = s.scores[sub] - gradeStats[sub]; // 差值
                items.push({ sub, score: s.scores[sub], diff });
                
                if(diff > maxDiff) maxDiff = diff;
                if(diff < minDiff) minDiff = diff;
            });

            // 按差值排序：优势在前，劣势在后
            items.sort((a,b) => b.diff - a.diff);

            // 计算偏科指数 (极差)
            const balanceScore = maxDiff - minDiff;

            return {
                name: s.name,
                class: s.class,
                total: s.total,
                rank: safeGet(s, 'ranks.total.township', '-'),
                items,
                balanceScore
            };
        });

        // D. 排序
        if(sortType === 'total') {
            renderList.sort((a,b) => b.total - a.total);
        } else {
            renderList.sort((a,b) => b.balanceScore - a.balanceScore); // 越不均衡排越前
        }
        
        SB_CACHE_DATA = renderList; // 存入缓存

        // E. 生成 HTML
        const tbody = document.querySelector('#sb-table tbody');
        let html = '';

        renderList.forEach(row => {
            // 构建可视化条
            // 我们只展示最强的2科和最弱的2科，避免太长，或者展示全部但缩小
            // 为了“一看就懂”，我们展示全部，但用 Flex 布局一行显示
            
            let barsHtml = `<div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">`;
            
            row.items.forEach(item => {
                const isStrong = item.diff >= 0;
                const color = isStrong ? '#16a34a' : '#dc2626';
                const bg = isStrong ? '#dcfce7' : '#fee2e2';
                const icon = isStrong ? '📈' : '📉';
                
                // 仅当差值绝对值大于 5 分时才显著展示，否则作为“平”
                const absDiff = Math.abs(item.diff);
                const barWidth = Math.min(absDiff * 2, 50); // 限制最大宽度
                
                // 小孩易读的胶囊样式
                barsHtml += `
                    <div style="display:flex; flex-direction:column; align-items:center; width:50px;">
                        <div style="font-size:10px; font-weight:bold; color:#333;">${item.sub}</div>
                        <div style="display:flex; align-items:flex-end; height:40px; justify-content:center; width:100%;">
                            <div style="
                                width: 12px; 
                                height: ${Math.max(barWidth, 2)}px; 
                                background-color: ${color}; 
                                border-radius: 2px;
                                opacity: ${absDiff < 2 ? 0.3 : 1};
                            " title="分数: ${item.score} (比平均${item.diff>0?'+':''}${item.diff.toFixed(1)})"></div>
                        </div>
                        <div style="font-size:10px; color:${color}; font-weight:bold;">
                            ${item.diff > 0 ? '+' : ''}${item.diff.toFixed(0)}
                        </div>
                    </div>
                `;
            });
            barsHtml += `</div>`;

            // 生成简评
            const strongSub = row.items[0];
            const weakSub = row.items[row.items.length - 1];
            let comment = "";
            if (row.balanceScore < 15) comment = `<span class="badge" style="background:#3b82f6">⚖️ 非常均衡</span>`;
            else {
                comment = `<div style="font-size:12px; line-height:1.4;">
                    <div>👍 强: <strong>${strongSub.sub}</strong> (+${strongSub.diff.toFixed(0)})</div>
                    <div style="color:#dc2626;">🆘 弱: <strong>${weakSub.sub}</strong> (${weakSub.diff.toFixed(0)})</div>
                </div>`;
            }

            html += `
                <tr>
                    <td>
                        <div style="font-weight:bold;">${row.name}</div>
                        <div style="font-size:10px; color:#999;">${row.class}</div>
                    </td>
                    <td style="font-weight:bold; font-size:14px;">${row.total}</td>
                    <td>${row.rank}</td>
                    <td style="padding:10px 5px;">${barsHtml}</td>
                    <td>${comment}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        if(renderList.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">无数据</td></tr>';
    }

    function SB_getGradeStats() {
        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            const avg = allScores.length ? allScores.reduce((a,b)=>a+b,0)/allScores.length : 0;
            gradeStats[sub] = avg;
        });
        return gradeStats;
    }

    function SB_runCluster() {
        const sch = document.getElementById('sbSchoolSelect').value;
        const cls = document.getElementById('sbClassSelect').value;
        if (!sch) return alert("请先选择学校");

        let students = SCHOOLS[sch].students;
        if (cls && cls !== '全部') students = students.filter(s => s.class === cls);
        if (!students.length) return alert("无可用学生数据");

        const gradeStats = SB_getGradeStats();
        const humanities = ['语文','英语','政治','历史','地理'];
        const sciences = ['数学','物理','化学','生物','科学'];

        const vectors = [];
        const meta = [];

        students.forEach(s => {
            const diffs = [];
            SUBJECTS.forEach(sub => {
                const v = s.scores[sub];
                if (typeof v === 'number') diffs.push({ sub, diff: v - (gradeStats[sub] || 0) });
            });
            if (diffs.length === 0) return;

            const hList = diffs.filter(d => humanities.includes(d.sub));
            const sList = diffs.filter(d => sciences.includes(d.sub));
            const hAvg = hList.length ? hList.reduce((a,b)=>a+b.diff,0)/hList.length : 0;
            const sAvg = sList.length ? sList.reduce((a,b)=>a+b.diff,0)/sList.length : 0;
            const maxAbs = Math.max(...diffs.map(d => Math.abs(d.diff)));
            const balance = Math.max(...diffs.map(d => d.diff)) - Math.min(...diffs.map(d => d.diff));

            vectors.push([hAvg, sAvg, maxAbs, balance]);
            meta.push({ name: s.name, class: s.class, hAvg, sAvg, maxAbs, balance });
        });

        const { labels, centroids } = kmeans(vectors, 4, 12);
        const clusterMap = {};
        labels.forEach((c, i) => {
            if (!clusterMap[c]) clusterMap[c] = [];
            clusterMap[c].push(meta[i]);
        });

        // 给每个簇命名
        const clusterLabels = {};
        centroids.forEach((centroid, idx) => {
            const [hAvg, sAvg, maxAbs, balance] = centroid;
            let tag = '全科均衡型';
            if (balance < 8 && Math.abs(hAvg - sAvg) < 6) tag = '全科均衡型';
            else if (hAvg - sAvg > 6) tag = '文强理弱型';
            else if (sAvg - hAvg > 6) tag = '理强文弱型';
            else if (maxAbs > 12 || balance > 18) tag = '单科突围型';
            clusterLabels[idx] = tag;
        });

        SB_renderClusterResults(clusterMap, clusterLabels);
    }

    function SB_renderClusterResults(clusterMap, clusterLabels) {
        const container = document.getElementById('sb-cluster-results');
        if (!container) return;

        const strategy = {
            '全科均衡型': '策略：保持节奏，适度强化拔高题；每周1次综合训练，避免短板出现。',
            '文强理弱型': '策略：补数学/物理基础概念与题型套路，每天固定15-20分钟理科训练。',
            '理强文弱型': '策略：语文/英语以“阅读+词汇+写作”三板斧推进，重点提升语感与表达。',
            '单科突围型': '策略：保优势学科的同时补齐最弱科，制定“主攻+补弱”双轨计划。'
        };

        let html = '';
        Object.keys(clusterMap).forEach(k => {
            const label = clusterLabels[k] || '未命名';
            const list = clusterMap[k] || [];
            html += `<div style="margin-bottom:12px; padding:10px; border:1px dashed #fed7aa; border-radius:8px; background:#fff;">
                <div style="font-weight:bold; color:#9a3412;">${label}（${list.length}人）</div>
                <div style="margin:6px 0; color:#7c2d12;">${strategy[label] || ''}</div>
                <div style="font-size:11px; color:#64748b;">示例名单：${list.slice(0, 8).map(s => `${s.name}(${s.class})`).join('、')}${list.length>8?' …':''}</div>
            </div>`;
        });
        container.innerHTML = html || '暂无聚类结果';
    }

    // 简单 K-Means 实现
    function kmeans(data, k = 4, maxIter = 10) {
        if (!data.length) return { labels: [], centroids: [] };
        const dim = data[0].length;
        const centroids = [];
        const used = new Set();
        while (centroids.length < k && used.size < data.length) {
            const idx = Math.floor(Math.random() * data.length);
            if (!used.has(idx)) { used.add(idx); centroids.push([...data[idx]]); }
        }
        const labels = new Array(data.length).fill(0);

        for (let iter = 0; iter < maxIter; iter++) {
            // assignment
            for (let i = 0; i < data.length; i++) {
                let best = 0, bestDist = Infinity;
                for (let c = 0; c < centroids.length; c++) {
                    const dist = euclid(data[i], centroids[c]);
                    if (dist < bestDist) { bestDist = dist; best = c; }
                }
                labels[i] = best;
            }
            // update
            const sums = Array.from({ length: centroids.length }, () => new Array(dim).fill(0));
            const counts = new Array(centroids.length).fill(0);
            for (let i = 0; i < data.length; i++) {
                const c = labels[i];
                counts[c]++;
                for (let d = 0; d < dim; d++) sums[c][d] += data[i][d];
            }
            for (let c = 0; c < centroids.length; c++) {
                if (counts[c] === 0) continue;
                for (let d = 0; d < dim; d++) centroids[c][d] = sums[c][d] / counts[c];
            }
        }
        return { labels, centroids };
    }

    function euclid(a, b) {
        let s = 0;
        for (let i = 0; i < a.length; i++) s += Math.pow(a[i] - b[i], 2);
        return Math.sqrt(s);
    }

    // 3. 导出 Excel
    function SB_exportExcel() {
        if(!SB_CACHE_DATA.length) return alert("请先生成分析数据");
        
        const wb = XLSX.utils.book_new();
        const headers = ["班级", "姓名", "总分", "全镇排名", "最强学科", "最强分差", "最弱学科", "最弱分差"];
        
        // 动态添加所有学科列
        SUBJECTS.forEach(s => headers.push(`${s}分差`));
        
        const data = [headers];
        
        SB_CACHE_DATA.forEach(r => {
            const strong = r.items[0];
            const weak = r.items[r.items.length-1];
            
            const row = [
                r.class, r.name, r.total, r.rank,
                strong.sub, `+${strong.diff.toFixed(1)}`,
                weak.sub, weak.diff.toFixed(1)
            ];
            
            // 填充各科分差
            SUBJECTS.forEach(s => {
                const item = r.items.find(i => i.sub === s);
                row.push(item ? item.diff.toFixed(1) : '-');
            });
            
            data.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "学生优劣势分析");
        XLSX.writeFile(wb, `优劣势学科分析_${document.getElementById('sbSchoolSelect').value}.xlsx`);
    }

    function updatePotentialSchoolSelect() {
        const sel = document.getElementById('potSchoolSelect'); 
        const old = sel.value; 
        
        sel.innerHTML = '<option value="ALL">全乡镇</option>'; 
        
        // 修复：确保 value 属性被引号包裹，防止学校名中有空格导致截断
        Object.keys(SCHOOLS).forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });
        
        // 恢复之前的选择
        if(old && (old==='ALL' || SCHOOLS[old])) sel.value = old;
    }

    function renderPotentialAnalysis() {
        if(!RAW_DATA.length) return alert('请先上传数据');
        const scope = document.getElementById('potSchoolSelect').value; 
        const topRatio = parseFloat(document.getElementById('potTopSelect').value); 
        
        let candidates = []; 
        let scopeStudents = (scope === 'ALL') ? RAW_DATA : (SCHOOLS[scope]?.students || []);
        
        // 1. 筛选总分优生
        const totalCount = RAW_DATA.length;
        const topRankThreshold = Math.floor(totalCount * topRatio);
        
        // 2. 遍历优生，计算偏科指数
        scopeStudents.forEach(stu => {
            const tRank = safeGet(stu, 'ranks.total.township', 99999); 
            if (tRank === '-' || tRank > topRankThreshold) return;

            // 获取该生的总分 T值 (如果没有计算过，用排名百分比估算)
            // 之前的 processData 已经计算了 stu.totalTScore 和 stu.tScores
            
            // 如果只有排名数据，回退到 Rank Gap 模式
            // 如果有 T 分数据，使用 T 分差 (更科学)
            const useAdvancedMetrics = (stu.tScores && stu.totalTScore);
            
            SUBJECTS.forEach(sub => {
                const subRank = safeGet(stu, `ranks.${sub}.township`, 0);
                if (!subRank) return;

                let isPotential = false;
                let gapVal = 0;
                let gapLabel = '';

                if (useAdvancedMetrics) {
                    // 业务逻辑深化：使用 T 分差
                    // 假设各科 T 分均值为 50。如果某科 T 分 < 40 (低于均值1个标准差)，且总 T 分较高
                    // 或者：该科 T 分 比 自身平均 T 分 低 10 分以上
                    const subT = stu.tScores[sub];
                    // 估算学生自身的平均水平 (总T分 / 科目数)
                    const validSubCount = Object.values(stu.tScores).filter(v=>v>0).length || 1;
                    const selfAvgT = stu.totalTScore / validSubCount; 
                    
                    // 判定：该科比自己平均水平低 8 分以上，且该科绝对值 < 45 (稍微偏弱)
                    if ((selfAvgT - subT) > 8) {
                        isPotential = true;
                        gapVal = (selfAvgT - subT).toFixed(1);
                        gapLabel = `T分偏离 -${gapVal}`;
                    }
                } else {
                    // 回退逻辑：排名落差法
                    // 如果单科排名比总排名 落后 30% 的总人数
                    const gap = subRank - tRank;
                    if (gap > (totalCount * 0.3)) {
                        isPotential = true;
                        gapVal = gap;
                        gapLabel = `名次落差 ${gap}`;
                    }
                }

                if (isPotential) {
                    candidates.push({ 
                        school: stu.school, class: stu.class, name: stu.name, 
                        totalScore: stu.total, totalRank: tRank, 
                        subject: sub, subScore: stu.scores[sub], subRank: subRank, 
                        gap: gapLabel, // 显示文本
                        sortVal: parseFloat(gapVal) // 用于排序
                    }); 
                }
            });
        });

        // 按偏科严重程度排序
        candidates.sort((a,b) => b.sortVal - a.sortVal); 
        POTENTIAL_STUDENTS_CACHE = candidates;

        let html = `<div class="info-bar">
            <strong>💡 分析模型升级：</strong> 
            系统已自动启用 <b>${candidates.length > 0 && candidates[0].gap.includes('T分') ? 'Z-Score标准分偏离模型' : '名次落差模型'}</b>。
            <br>筛选范围：总分前 ${(topRatio*100).toFixed(0)}% 的学生中，单科显著“拖后腿”的潜力股。
        </div>
        <div class="table-wrap"><table><thead><tr><th>学校</th><th>班级</th><th>姓名</th><th>总分排名</th><th>跛脚学科</th><th>学科分数</th><th>学科排名</th><th>偏科指数</th></tr></thead><tbody>`;
        
        if(candidates.length === 0) {
            html += `<tr><td colspan="8" style="padding:30px; text-align:center;">🎉 恭喜！在前 ${(topRatio*100)}% 学生中未发现严重偏科现象。</td></tr>`; 
        } else {
            candidates.forEach(c => {
                html += `<tr>
                    <td>${c.school}</td>
                    <td>${c.class}</td>
                    <td><strong>${c.name}</strong></td>
                    <td class="text-green">${c.totalRank}</td>
                    <td style="color:var(--primary); font-weight:bold;">${c.subject}</td>
                    <td>${formatVal(c.subScore)}</td>
                    <td class="text-red">${c.subRank}</td>
                    <td style="color:red; font-weight:bold;">📉 ${c.gap}</td>
                </tr>`;
            });
        }
        document.getElementById('potential-results').innerHTML = html + `</tbody></table></div>`;
    }

    function exportPotentialAnalysis() {
        if(!POTENTIAL_STUDENTS_CACHE.length) { alert('请先生成数据或结果为空'); return; }
        const wb = XLSX.utils.book_new(); const data = [['学校', '班级', '姓名', '总分', '总分全镇排名', '跛脚学科', '学科分数', '学科全镇排名', '名次落差']];
        POTENTIAL_STUDENTS_CACHE.forEach(c => data.push([c.school, c.class, c.name, c.totalScore, c.totalRank, c.subject, c.subScore, c.subRank, c.gap]));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "偏科生名单"); XLSX.writeFile(wb, "偏科潜力生挖掘名单.xlsx");
    }

    function updateDiagnosisSelects() {
        const schSel = document.getElementById('diagSchoolSelect'); const subSel = document.getElementById('diagSubjectSelect'); const oldSch = schSel.value; schSel.innerHTML = '<option value="">--请选择学校--</option>'; Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSch && SCHOOLS[oldSch]) schSel.value = oldSch;
        const oldSub = subSel.value; subSel.innerHTML = '<option value="total">总分</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSub) subSel.value = oldSub;
    }

    function renderClassDiagnosis() {
        const schoolName = document.getElementById('diagSchoolSelect').value; const subject = document.getElementById('diagSubjectSelect').value; const step = parseInt(document.getElementById('diagStep').value) || 10;
        if(!schoolName || !SCHOOLS[schoolName]) return alert('请选择学校');
        const sch = SCHOOLS[schoolName]; const classData = {}; sch.students.forEach(s => { if(!classData[s.class]) classData[s.class] = []; const val = (subject === 'total') ? s.total : s.scores[subject]; if(typeof val === 'number') classData[s.class].push(val); });
        const classes = Object.keys(classData).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
        let maxScoreAll = 0;
        const stats = classes.map(cls => {
            const scores = classData[cls]; const count = scores.length; const avg = count ? scores.reduce((a,b)=>a+b,0)/count : 0; const variance = count > 1 ? scores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / count : 0; if(count) maxScoreAll = Math.max(maxScoreAll, ...scores);
            return { cls, count, avg, sd: Math.sqrt(variance), scores };
        });
        const allScores = stats.flatMap(s => s.scores); const gradeAvg = allScores.length ? allScores.reduce((a,b)=>a+b,0)/allScores.length : 0; const gradeVariance = allScores.length ? allScores.reduce((sum, score) => sum + Math.pow(score - gradeAvg, 2), 0) / allScores.length : 0; const gradeSD = Math.sqrt(gradeVariance);
        const maxBinCount = Math.max(...stats.map(s => { const bins = {}; s.scores.forEach(v => { const bin = Math.floor(v/step); bins[bin] = (bins[bin]||0)+1; }); return Math.max(...Object.values(bins)) || 1; }));
        let html = `<div class="info-bar" style="margin-bottom:10px;"><span style="font-weight:bold;">参考基准：</span> 全校平均分 ${gradeAvg.toFixed(1)}，全校标准差 (SD) <span style="font-weight:bold;">${gradeSD.toFixed(2)}</span></div><div class="table-wrap" id="diagnosisTable"><table><thead><tr><th>班级</th><th>人数</th><th>平均分</th><th>标准差(SD)</th><th>诊断结论</th><th>成绩分布 (区间: ${step}分)</th></tr></thead><tbody>`;
        stats.forEach(st => {
            let diagHtml = ''; const ratio = gradeSD ? st.sd / gradeSD : 1; if (ratio > 1.1) diagHtml = `<span class="diagnosis-tag diagnosis-bad">两极分化 (需抓两头)</span>`; else if (ratio < 0.9) diagHtml = `<span class="diagnosis-tag diagnosis-flat">高度集中 (需整体拔高)</span>`; else diagHtml = `<span class="diagnosis-tag diagnosis-good">分布正常</span>`;
            const minVal = st.scores.length ? Math.min(...st.scores) : 0; const maxVal = st.scores.length ? Math.max(...st.scores) : 0; const minBin = Math.floor(minVal/step); const maxBin = Math.floor(maxVal/step); const bins = new Array(maxBin - minBin + 1).fill(0);
            st.scores.forEach(v => { const b = Math.floor(v/step) - minBin; if(b>=0 && b<bins.length) bins[b]++; });
            let barsHtml = `<div class="dist-bar-container">`; bins.forEach(count => { const h = Math.max((count / maxBinCount) * 100, 5); barsHtml += `<div class="dist-bar" style="height:${h}%;" title="人数: ${count}" data-count="${count}"></div>`; }); barsHtml += `</div><div style="font-size:10px; color:#999; text-align:center;">${minBin*step} - ${(maxBin+1)*step}分</div>`;
            html += `<tr><td>${st.cls}</td><td>${st.count}</td><td>${st.avg.toFixed(2)}</td><td style="font-family:monospace;font-weight:bold;">${st.sd.toFixed(2)}</td><td>${diagHtml}</td><td style="min-width:150px;">${barsHtml}</td></tr>`;
        });
        document.getElementById('diagnosis-results').innerHTML = html + `</tbody></table></div>`;
    }
    
    function exportDiagnosisExcel() {
        const table = document.querySelector('#diagnosisTable table'); if(!table) return alert("请先生成诊断表");
        const wb = XLSX.utils.book_new(); const wsData = [["班级", "人数", "平均分", "标准差(SD)", "诊断结论"]];
        const rows = table.querySelectorAll('tbody tr'); rows.forEach(r => { const cols = r.querySelectorAll('td'); wsData.push([cols[0].innerText, parseInt(cols[1].innerText), parseFloat(cols[3].innerText), cols[4].innerText]); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "班情诊断"); XLSX.writeFile(wb, "班情诊断分析.xlsx");
    }

    function exportCorrelationExcel() {
        const matrixTable = document.getElementById('corrMatrixTable'); const liftDragTable = document.getElementById('liftDragTable');
        if(!matrixTable || matrixTable.rows.length === 0) return alert("请先生成分析结果");
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(matrixTable), "相关性矩阵"); XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(liftDragTable), "提分与拖分分析"); XLSX.writeFile(wb, "学科关联深度分析.xlsx");
    }

   function exportExcel(type) {
        if (!RAW_DATA.length) { alert('请先上传数据'); return; }
        
        // 1. 导出后1/3 (逻辑不变)
        if (type === 'bottom3') {
            const table = document.getElementById('tb-bottom3'); 
            const wb = XLSX.utils.book_new(); 
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, "核算结果"); 
            XLSX.writeFile(wb, '后1_3核算结果.xlsx');
            return;
        }

        // 2. 导出指标生 (逻辑更新：从界面表格获取太麻烦，直接重算一遍或者从DOM解析)
        // 为了准确性，我们这里解析刚才生成的表格 DOM，这样所见即所得
        if (type === 'indicator') {
            const table = document.getElementById('tb-indicator');
            if(table.rows.length < 3) return alert("请先点击【开始计算】");

            const wb = XLSX.utils.book_new();
            
            // 自定义表头数据，因为DOM表头是双层的，直接转换可能格式不好看
            const wsData = [];
            //这一行是合并后的逻辑表头
            wsData.push(["学校", 
                         "指标一目标", "指标一达标", "指标一基础分", "指标一附加分", "指标一小计",
                         "指标二目标", "指标二达标", "指标二基础分", "指标二附加分", "指标二小计",
                         "指标总分", "排名"]);

            // 遍历 tbody 获取数据
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const tds = tr.querySelectorAll('td');
                // 解析 "目标/达标" 这种格式
                const parseTargetReach = (str) => {
                    const parts = str.split('/');
                    return { t: parts[0].trim(), r: parts[1].trim() };
                };

                const ind1 = parseTargetReach(tds[1].innerText);
                const ind2 = parseTargetReach(tds[5].innerText);

                wsData.push([
                    tds[0].innerText, // 学校
                    ind1.t, ind1.r, tds[2].innerText, tds[3].innerText, tds[4].innerText, // 指标一
                    ind2.t, ind2.r, tds[6].innerText, tds[7].innerText, tds[8].innerText, // 指标二
                    tds[9].innerText, // 总分
                    tds[10].innerText // 排名
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "指标生核算详细");
            XLSX.writeFile(wb, '指标生核算结果(含附加分).xlsx');
        }
    }
    function downloadTemplate(type) {
        const wb = XLSX.utils.book_new();
        let headers = [];
        let sampleData = [];
        let filename = "模板.xlsx";
        let sheetName = "成绩表";

        switch(type) {
            case 'primary':
                headers = ["学校", "班级", "姓名", "考号", "语文", "数学", "英语"];
                sampleData = [
                    ["实验小学", "601", "张三", "2024001", 95, 98, 92],
                    ["实验小学", "601", "李四", "2024002", 88, 90, 85]
                ];
                filename = "小学期末考试_标准模板.xlsx";
                break;
            case 'junior':
                headers = ["学校", "班级", "姓名", "考号", "语文", "数学", "英语", "物理", "历史", "地理", "生物", "政治"];
                sampleData = [
                    ["镇中", "801", "王五", "2024101", 105, 110, 108, 85, 90, 88, 92, 80],
                    ["镇中", "801", "赵六", "2024102", 98, 102, 95, 78, 85, 80, 88, 75]
                ];
                filename = "初中月考_标准模板.xlsx";
                break;
            case 'grade9':
                headers = ["学校", "班级", "姓名", "考号", "语文", "数学", "英语", "物理", "化学", "政治", "历史", "体育"];
                sampleData = [
                    ["一中", "901", "孙七", "2024901", 112, 115, 110, 68, 48, 55, 58, 40],
                    ["一中", "901", "周八", "2024902", 105, 108, 102, 60, 42, 50, 52, 38]
                ];
                filename = "中考一模_标准模板.xlsx";
                break;
            case 'teacher':
                headers = ["班级", "学科", "教师姓名"];
                sampleData = [
                    ["701", "语文", "张老师"],
                    ["701", "数学", "李老师"],
                    ["702", "语文", "张老师"],
                    ["702", "数学", "王老师"]
                ];
                filename = "教师任课信息_导入模板.xlsx";
                sheetName = "任课表";
                break;
        }

        const wsData = [headers, ...sampleData];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // 设置列宽，让模板稍微好看点
        ws['!cols'] = headers.map(() => ({ wch: 15 }));

        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, filename);
        
        if(window.UI) UI.toast(`✅ 已下载：${filename}`, "success");
    }    
    // ================== 新生分班 & 座位编排 ==================
    function FB_loadData(input) {
        const file = input.files[0]; if(!file) return; const reader= new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, {type: 'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(!json.length) throw new Error("Excel没有数据");
                FB_STUDENTS = json.map((r, i) => {
                    const remarks = String(r['备注']||r['说明']||""); const sameMatch = remarks.match(/(?:和|与|跟)([\u4e00-\u9fa5\w]+)(?:同班|一起|一班)/); const diffMatch = remarks.match(/(?:和|与|跟)([\u4e00-\u9fa5\w]+)(?:分开|不同班|不在一起)/);
                    return { _id: i, name: r['姓名'] || '未知', gender: (r['性别'] === '男' || r['Gender'] === 'M') ? 'M' : 'F', score: parseFloat(r['总分'] || r['语数英'] || 0), height: parseFloat(r['身高'] || 160), vision: parseFloat(r['视力'] || r['左眼'] || 5.0), isDiff: (String(r['难管']||"").includes('是') || remarks.includes('难管') || remarks.includes('调皮')), remarks: remarks, constraints: { same: sameMatch ? [sameMatch[1]] : [], diff: diffMatch ? [diffMatch[1]] : [] }, classIdx: -1 };
                });
                alert(`✅ 导入成功！共 ${FB_STUDENTS.length} 人。`); document.getElementById('fb-results-area').classList.add('hidden'); 
            } catch(err) { alert("读取失败：" + err.message); }
        }; reader.readAsArrayBuffer(file);
    }

    function calculateQuartiles(sortedData) {
        const q2 = calculateMedian(sortedData); const midIndex = Math.floor(sortedData.length / 2); const lowerHalf = sortedData.slice(0, midIndex); const upperHalf = sortedData.slice((sortedData.length % 2 === 0) ? midIndex : midIndex + 1); const q1 = calculateMedian(lowerHalf); const q3 = calculateMedian(upperHalf); return { q1, q2, q3 };
    }
    function calculateMedian(sortedData) { const mid = Math.floor(sortedData.length / 2); return sortedData.length % 2 !== 0 ? sortedData[mid] : (sortedData[mid - 1] + sortedData[mid]) / 2; }
    function calculateSD(data) { const n = data.length; if (n === 0) return 0; const mean = data.reduce((a, b) => a + b, 0) / n; const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n; return Math.sqrt(variance); }

     // 1. 主入口：运行分班
    function FB_runDivision() {
        if(!FB_STUDENTS.length) return alert("请先导入数据");
        
        // 获取参数
        const k = parseInt(document.getElementById('fb_cls_num').value) || 6; 
        const algo = document.getElementById('fb_algorithm').value;
        const btn = document.querySelector('button[onclick="FB_runDivision()"]');
        
        // UI 反馈
        btn.innerHTML = '⏳ 正在运算多套方案...';
        btn.disabled = true;

        // 使用 setTimeout 让 UI 有机会渲染 Loading 状态
        setTimeout(() => {
            FB_SCHEMES_CACHE = [];
            
            // 如果是蛇形分班，因为是固定的，只生成 1 套
            // 如果是智能优化，生成 3 套供选择
            const runs = (algo === 'snake') ? 1 : 3;

            for(let i = 0; i < runs; i++) {
                const classes = FB_generateSingleScheme(k, algo);
                // 计算该方案的评分 (极差)
                const avgs = classes.map(c => c.stats.avg);
                const range = Math.max(...avgs) - Math.min(...avgs);
                const sd = calculateSD(avgs);
                
                FB_SCHEMES_CACHE.push({
                    id: i,
                    name: runs === 1 ? '标准方案' : `方案 ${String.fromCharCode(65+i)}`, // 方案A, 方案B...
                    data: classes,
                    range: range,
                    sd: sd,
                    desc: `均分极差 ${range.toFixed(2)}`
                });
            }

            // 恢复按钮
            btn.innerHTML = '🚀 开始智能分班';
            btn.disabled = false;

            // 渲染方案选择器
            FB_renderSchemeSelector();
            
            // 默认应用均分极差最小（最均衡）的方案
            const bestScheme = FB_SCHEMES_CACHE.sort((a,b) => a.range - b.range)[0];
            FB_applyScheme(bestScheme.id);
            
            // 显示区域
            document.getElementById('fb-results-area').classList.remove('hidden');
            if(runs > 1) {
                document.getElementById('fb-scheme-panel').classList.remove('hidden');
            } else {
                document.getElementById('fb-scheme-panel').classList.add('hidden');
            }

        }, 100);
    }

    // 2. 核心算法：生成单次方案 (提取出来的纯逻辑)
    function FB_generateSingleScheme(k, algo) {
        // 初始化空班级
        let classes = Array.from({length: k}, (_, i) => ({ id: i, name: (i+1)+"班", students: [], stats: {} }));
        let pool = JSON.parse(JSON.stringify(FB_STUDENTS)); // 深拷贝，防止污染
        
        // 预处理：按分数排序
        pool.sort((a,b) => b.score - a.score);

        if(algo === 'snake') {
            // --- 蛇形分班 ---
            pool.forEach((s, i) => { 
                const round = Math.floor(i / k); 
                const target = (round % 2 === 0) ? (i % k) : (k - 1 - (i % k)); 
                classes[target].students.push(s); 
                s.classIdx = target; 
            });
        } else {
            // --- 智能优化分班 (基于模拟退火思想的简化版) ---
            // A. 初步蛇形分配作为基准
            pool.forEach((s, i) => { 
                const target = (Math.floor(i/k) % 2 === 0) ? (i % k) : (k - 1 - (i % k)); 
                classes[target].students.push(s); 
                s.classIdx = target; 
            });

            // B. 随机交换优化
            const iterations = 8000; // 增加迭代次数以获得不同结果
            const globalAvg = pool.reduce((a,b)=>a+b.score,0) / pool.length;
            
            for(let i=0; i<iterations; i++) {
                const c1 = Math.floor(Math.random() * k); 
                const c2 = Math.floor(Math.random() * k); 
                if(c1 === c2) continue;
                
                const cls1 = classes[c1];
                const cls2 = classes[c2];
                if(!cls1.students.length || !cls2.students.length) continue;

                const idx1 = Math.floor(Math.random() * cls1.students.length); 
                const idx2 = Math.floor(Math.random() * cls2.students.length);

                const s1 = cls1.students[idx1]; 
                const s2 = cls2.students[idx2];

                // 计算交换前的代价 (方差 + 性别平衡 + 难管分布)
                const costBefore = FB_calcClassCost(cls1, globalAvg) + FB_calcClassCost(cls2, globalAvg);
                
                // 试探性交换
                cls1.students[idx1] = s2; s2.classIdx = c1; 
                cls2.students[idx2] = s1; s1.classIdx = c2;

                const costAfter = FB_calcClassCost(cls1, globalAvg) + FB_calcClassCost(cls2, globalAvg);
                
                // 检查硬性约束 (如: 互斥)
                let violate = false; 
                if(FB_checkConflict(s1, cls2.students) || FB_checkConflict(s2, cls1.students)) violate = true;

                // 决策：如果代价变高了(更不平衡) 或者 违反约束，则撤销交换
                // (加入一点点随机接受概率以跳出局部最优，但这里为了稳定简化处理)
                if(violate || costAfter > costBefore) { 
                    // 撤销
                    cls1.students[idx1] = s1; s1.classIdx = c1; 
                    cls2.students[idx2] = s2; s2.classIdx = c2; 
                }
            }
        }

        // 这里的计算是为了 stats，方便外部筛选
        classes.forEach(c => {
            const n = c.students.length;
            const total = c.students.reduce((a,b)=>a+b.score,0);
            c.stats.avg = n ? total/n : 0;
            c.stats.male = c.students.filter(s=>s.gender==='M').length;
            c.stats.count = n;
        });

        return classes;
    }

    // 3. 渲染方案选择卡片
    function FB_renderSchemeSelector() {
        const container = document.getElementById('fb-scheme-cards');
        container.innerHTML = '';
        
        FB_SCHEMES_CACHE.forEach(scheme => {
            // 简单的评分逻辑
            const isBest = (scheme.range <= FB_SCHEMES_CACHE[0].range); // 假设已排序
            const borderStyle = isBest ? 'border:2px solid #16a34a; background:#fff;' : 'border:1px solid #ddd; background:#fff;';
            
            // 找出该方案中男女比例极差
            const males = scheme.data.map(c => c.stats.male);
            const maleRange = Math.max(...males) - Math.min(...males);

            container.innerHTML += `
                <div onclick="FB_applyScheme(${scheme.id})" style="cursor:pointer; padding:10px; border-radius:6px; ${borderStyle} transition:0.2s;" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background='#fff'">
                    <div style="font-weight:bold; color:#333; display:flex; justify-content:space-between;">
                        <span>${scheme.name}</span>
                        ${isBest ? '<span style="color:red; font-size:10px;">★ 推荐</span>' : ''}
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:5px;">
                        <div>均分极差: <strong>${scheme.range.toFixed(2)}</strong></div>
                        <div>男女极差: ${maleRange} 人</div>
                    </div>
                </div>
            `;
        });
    }

    // 4. 应用选中的方案
    function FB_applyScheme(id) {
        const scheme = FB_SCHEMES_CACHE.find(s => s.id === id);
        if(!scheme) return;
        
        // 更新全局变量
        FB_CLASSES = scheme.data;
        FB_SIMULATED_DATA = {}; 
        FB_CLASSES.forEach(c => FB_SIMULATED_DATA[c.name] = c.students);
        
        // 渲染原有仪表盘
        FB_renderDashboard();
        
        // 高亮选中的卡片
        const cards = document.getElementById('fb-scheme-cards').children;
        Array.from(cards).forEach((card, idx) => {
            if(scheme.id === FB_SCHEMES_CACHE[idx].id) { // 注意：这里简单按索引对应，实际上按ID匹配更稳
                card.style.borderColor = '#16a34a';
                card.style.boxShadow = '0 0 0 3px rgba(22, 163, 74, 0.2)';
            } else {
                card.style.borderColor = '#ddd';
                card.style.boxShadow = 'none';
            }
        });
    }

    function FB_calcClassCost(cls, gAvg) {
        const n = cls.students.length; if(n===0) return 10000; const avg = cls.students.reduce((a,b)=>a+b.score,0) / n; const male = cls.students.filter(s=>s.gender==='M').length; 
        const diff = cls.students.filter(s=>(s.isDiff || s._isDiff)).length;
        let cost = Math.pow(avg - gAvg, 2) * 100; cost += Math.pow((male/n) - 0.5, 2) * 5000; 
        if(document.getElementById('fb_rule_diff').value === 'spread') { cost += Math.pow(diff, 2) * 500; } return cost;
    }

    function FB_checkConflict(stu, targetArr) { 
        if(!stu.constraints) return false;
        for(let name of stu.constraints.diff) { if(targetArr.find(s => s.name === name)) return true; } 
        return false; 
    }

    function FB_renderDashboard() {
        document.getElementById('fb-results-area').classList.remove('hidden'); const container = document.getElementById('fb_class_container'); container.innerHTML = '';
        let allAvgs = [], tMale = 0, tFemale = 0, totalDiffCnt = 0;
        FB_CLASSES.forEach(c => {
            const n = c.students.length; const total = c.students.reduce((a,b)=>a+b.score,0); const avg = n ? total/n : 0; const male = c.students.filter(s=>s.gender==='M').length; 
            const diffCnt = c.students.filter(s=>(s.isDiff || s._isDiff)).length;
            allAvgs.push(avg); tMale += male; tFemale += (n-male); totalDiffCnt += diffCnt; c.stats = { avg, male, female: n-male, count: n }; const isWarn = diffCnt > 3; 
            container.innerHTML += `<div class="fb-class-box ${isWarn?'fb-warn-bg':''}" onclick="FB_openSeatMap(${c.id})"><div class="fb-c-head"><span style="font-weight:bold; font-size:16px;">${c.name}</span><span class="fb-tag fb-tag-red" style="${diffCnt>0?'':'display:none'}">难管: ${diffCnt}</span></div><div class="fb-c-body"><div>人数: <strong>${n}</strong></div><div>均分: <strong>${avg.toFixed(1)}</strong></div><div>男生: ${male}</div><div>女生: ${n-male}</div><div style="grid-column:span 2; font-size:11px; color:#999; margin-top:5px;">点击进入座位编排 →</div></div></div>`;
        });
        const range = Math.max(...allAvgs) - Math.min(...allAvgs);
        document.getElementById('fb_res_total').innerText = FB_STUDENTS.length; document.getElementById('fb_res_male').innerText = tMale; document.getElementById('fb_res_female').innerText = tFemale; document.getElementById('fb_res_diff').innerText = range.toFixed(2); document.getElementById('fb_res_diff_cnt').innerText = totalDiffCnt;
        const evalEl = document.getElementById('fb_res_eval');
        if(range <= 1.0) evalEl.innerHTML = '<span style="color:green;font-weight:bold;">✅ 完美均衡</span>'; else if(range <= 3.0) evalEl.innerHTML = '<span style="color:#d97706;font-weight:bold;">⚠️ 基本均衡</span>'; else evalEl.innerHTML = '<span style="color:red;font-weight:bold;">❌ 差异过大</span>';
        FB_renderBalanceChart();
    }

    function FB_renderBalanceChart() {
        const ctx = document.getElementById('balanceChart'); const tableContainer = document.getElementById('balanceTableContainer'); const labels = FB_CLASSES.map(c => c.name);
        const statsData = FB_CLASSES.map(c => { const scores = c.students.map(s => s.score).sort((a,b)=>a-b); const qs = calculateQuartiles(scores); return { min: scores[0], max: scores[scores.length-1], q1: qs.q1, median: qs.q2, q3: qs.q3, avg: c.stats.avg, sd: calculateSD(scores) }; });
        if (balanceChartInstance) balanceChartInstance.destroy();
        balanceChartInstance = new Chart(ctx, {
            type: 'bar', data: { labels: labels, datasets: [ { label: '平均分', data: statsData.map(s => s.avg), type: 'scatter', backgroundColor: '#2563eb', borderColor: '#2563eb', pointStyle: 'rectRot', pointRadius: 6 }, { label: '分数区间 (Min-Max)', data: statsData.map(s => [s.min, s.max]), backgroundColor: 'rgba(156, 163, 175, 0.2)', borderColor: 'rgba(156, 163, 175, 0.5)', borderWidth: 1, barPercentage: 0.1 }, { label: '核心分布 (Q1-Q3)', data: statsData.map(s => [s.q1, s.q3]), backgroundColor: 'rgba(37, 99, 235, 0.5)', borderColor: '#1e40af', borderWidth: 1, barPercentage: 0.6 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: function(context) { const s = statsData[context.dataIndex]; if(context.dataset.type === 'scatter') return `平均分: ${s.avg.toFixed(2)}`; if(context.datasetIndex === 1) return `范围: ${s.min} - ${s.max}`; if(context.datasetIndex === 2) return `核心区间: ${s.q1} - ${s.q3}`; } } }, title: { display: true, text: '班级分数结构对比 (箱线图)' } }, scales: { y: { beginAtZero: false, title: { display: true, text: '分数' } } } }
        });
        let tableHtml = `<table class="comparison-table" style="font-size:12px;"><thead><tr><th>班级</th><th>人数</th><th>平均分</th><th>标准差 (SD)</th><th>极差 (Max-Min)</th><th>前25%线 (Q3)</th><th>后25%线 (Q1)</th></tr></thead><tbody>`;
        statsData.forEach((s, i) => { tableHtml += `<tr><td>${labels[i]}</td><td>${FB_CLASSES[i].students.length}</td><td>${s.avg.toFixed(2)}</td><td>${s.sd.toFixed(2)}</td><td>${(s.max - s.min).toFixed(1)}</td><td>${s.q3}</td><td>${s.q1}</td></tr>`; });
        tableContainer.innerHTML = tableHtml + `</tbody></table>`;
    }

    const HistoryManager = {
        past: [],   // 过去的状态栈
        future: [], // 未来的状态栈 (供重做)
        limit: 20,  // 最多记录20步，防止内存溢出

        // 1. 记录当前状态 (在修改数据前调用)
        record: function() {
            // 深拷贝当前班级数据 (FB_CLASSES)
            // 注意：这里我们只记录当前正在操作的班级，以节省内存
            if (FB_CUR_CLASS_IDX === -1) return;
            
            const currentClassData = FB_CLASSES[FB_CUR_CLASS_IDX];
            const snapshot = JSON.parse(JSON.stringify(currentClassData));
            
            this.past.push(snapshot);
            if (this.past.length > this.limit) this.past.shift(); // 超过限制删最早的
            
            this.future = []; // 一旦有新操作，清空未来栈
            this.updateUI();
        },

        // 2. 执行撤销
        undo: function() {
            if (this.past.length === 0) return;
            
            // A. 把当前状态推入未来栈
            const current = JSON.parse(JSON.stringify(FB_CLASSES[FB_CUR_CLASS_IDX]));
            this.future.push(current);
            
            // B. 从过去栈取出上一个状态
            const previous = this.past.pop();
            FB_CLASSES[FB_CUR_CLASS_IDX] = previous;
            
            // C. 刷新视图
            this.refreshView("已撤销 ↩");
        },

        // 3. 执行重做
        redo: function() {
            if (this.future.length === 0) return;
            
            // A. 把当前状态推入过去栈
            const current = JSON.parse(JSON.stringify(FB_CLASSES[FB_CUR_CLASS_IDX]));
            this.past.push(current);
            
            // B. 从未来栈取出下一个状态
            const next = this.future.pop();
            FB_CLASSES[FB_CUR_CLASS_IDX] = next;
            
            // C. 刷新视图
            this.refreshView("已重做 ↪");
        },

        // 4. 辅助：刷新界面和按钮状态
        refreshView: function(msg) {
            FB_renderSeatMap(); // 重绘座位表
            this.updateUI();
            UI.toast(msg, 'info'); // 提示用户
        },

        updateUI: function() {
            const btnUndo = document.getElementById('btn_undo');
            const btnRedo = document.getElementById('btn_redo');
            if(btnUndo) {
                btnUndo.disabled = (this.past.length === 0);
                btnUndo.className = this.past.length > 0 ? "btn btn-primary" : "btn btn-gray";
            }
            if(btnRedo) {
                btnRedo.disabled = (this.future.length === 0);
                btnRedo.className = this.future.length > 0 ? "btn btn-primary" : "btn btn-gray";
            }
        },
        
        // 5. 初始化/清空
        reset: function() {
            this.past = [];
            this.future = [];
            this.updateUI();
        }
    };

    function FB_openSeatMap(clsId) {
        HistoryManager.reset(); 
        FB_CUR_CLASS_IDX = clsId; const cls = FB_CLASSES[clsId]; document.getElementById('seat_class_title').innerText = cls.name;
        document.getElementById('fb_seat_view').classList.remove('hidden'); document.getElementById('fb_seat_view').scrollIntoView({behavior:'smooth'});
        updateConstraintWidgetsContext('fb'); // 联动更新
        if(!cls.seatLayout) { FB_autoSeatAlgo(); } else { FB_renderSeatMap(); }
          FB_initScenarioSelect(); // <--- 记得加上这句
    }

   // --- 家长查分轻量包生成器 (严格验证版：必须输入 密码+班级+姓名) ---
    function generateInquiryPackage() {
        const sch = document.getElementById('studentSchoolSelect').value;
        if (!sch || sch.includes('请选择')) return alert("请先选择一个学校，系统将生成该校的查分包。");
        
        // 1. 准备数据
        const schoolStudents = SCHOOLS[sch].students;
        if (!schoolStudents || schoolStudents.length === 0) return alert("该学校无数据");

        // 判断是否只有一所学校 (用于控制显示的排名类型)
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;

        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const scores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            if (scores.length > 0) {
                const sum = scores.reduce((a, b) => a + b, 0);
                const avg = sum / scores.length;
                const variance = scores.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / scores.length;
                gradeStats[sub] = { avg: avg, sd: Math.sqrt(variance) };
            } else {
                gradeStats[sub] = { avg: 0, sd: 1 };
            }
        });

        // 2. 数据打包
        const secureData = {};
        
        schoolStudents.forEach(stu => {
            // 生成唯一 Key: 班级_姓名 (例如: 701_张三)
            // 去除所有空格，确保匹配准确
            const key = (stu.class + "_" + stu.name).replace(/\s+/g, "");
            
            const scoresSimple = {};

            const radarData = { labels: [], data: [] }; // 雷达图数据
            const varianceData = { labels: [], data: [] }; // 均衡度数据
            
            SUBJECTS.forEach(sub => {
                if(stu.scores[sub] !== undefined) {
                    scoresSimple[sub] = [
                        stu.scores[sub],
                        safeGet(stu, `ranks.${sub}.school`, '-'),
                        safeGet(stu, `ranks.${sub}.township`, '-')
                    ];

                    // A. 计算雷达图数据 (百分位)
                    // 逻辑复用 renderRadarChart 中的算法
                    const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => v !== undefined).sort((a, b) => b - a);
                    const rank = allScores.indexOf(stu.scores[sub]) + 1;
                    const total = allScores.length;
                    const percentile = ((1 - (rank / total)) * 100).toFixed(1);
                    radarData.labels.push(sub);
                    radarData.data.push(percentile);

                    // B. 计算均衡度数据 (Z-Score)
                    const stats = gradeStats[sub];
                    let z = 0;
                    if (stats && stats.sd > 0) {
                        z = (stu.scores[sub] - stats.avg) / stats.sd;
                    }
                    varianceData.labels.push(sub);
                    varianceData.data.push(parseFloat(z.toFixed(2)));
                }
            });

            // C. 获取或生成评语
            // 优先从批量生成缓存中取，如果没有则现场生成一条简单的
            const cacheKey = `${stu.school}_${stu.class}_${stu.name}`;
            const aiComment = BATCH_AI_CACHE[cacheKey] || generateAIComment(stu);
            
            secureData[key] = {
                cls: stu.class,  // 存储班级
                name: stu.name,  // 存储姓名
                s: scoresSimple, 
                t: stu.total,    
                tr: safeGet(stu, 'ranks.total.township', '-'), 
                sr: safeGet(stu, 'ranks.total.school', '-'),   
                cr: safeGet(stu, 'ranks.total.class', '-'), 

                rd: radarData,   // Radar Data
                vd: varianceData,// Variance Data
                cm: aiComment    // Comment

            };
        });

        // 3. 提示设置访问密码
        const password = prompt(`🔐 安全设置\n\n请设置一个“访问密码” (例如: 123456)。\n\n家长查询时要求：\n1. 输入此密码\n2. 输入准确的班级\n3. 输入准确的姓名`, "123456");
        
        if (password === null) return; 
        if (!password) return alert("❌ 必须设置密码才能生成安全查分包！");

        // 使用 CryptoJS 进行 AES 加密
        const jsonStr = JSON.stringify(secureData);
        const encryptedData = CryptoJS.AES.encrypt(jsonStr, password).toString();

        // 4. 构建独立的 HTML 模板 (包含班级输入框)
        const examName = CONFIG.name || "期中考试";
        const genDate = new Date().toLocaleDateString();
        
        const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${sch} - 成绩查询</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>

</head>
<body>
<div class="container">
    <h2>${sch} 成绩查询</h2>
    <div class="sub-title">${examName} | 发布日期: ${genDate}</div>
    
    <div class="password-section">
        <label>🔐 访问密码 (由老师提供)</label>
        <input type="password" id="inpPass" placeholder="请输入查看密码">
    </div>

    <!-- 👇👇👇 🟢 恢复：班级输入框 (必填) 🟢 👇👇👇 -->
    <div class="form-group">
        <label>班级</label>
        <input type="text" id="inpClass" placeholder="请输入班级 (如: 701)">
    </div>

    <div class="form-group">
        <label>学生姓名</label>
        <input type="text" id="inpName" placeholder="请输入姓名 (如: 张三)">
    </div>
    
    <button onclick="doSearch()">🔓 解密并查询</button>

    <div id="resultArea" class="result-box"></div>
</div>
<div class="footer">AES 256位端对端加密<br>仅限查询本人成绩</div>

<script>
    const PAYLOAD = "${encryptedData}";
    const IS_SINGLE_SCHOOL = ${isSingleSchool}; 

    let radarInst = null;
    let varInst = null;
    
    function doSearch() {
        const pass = document.getElementById('inpPass').value.trim();
        const cls = document.getElementById('inpClass').value.trim();
        const name = document.getElementById('inpName').value.trim();
        const resBox = document.getElementById('resultArea');
        
        if(!pass) return alert("❌ 请输入访问密码");
        if(!cls) return alert("❌ 请输入班级");
        if(!name) return alert("❌ 请输入学生姓名");
        
        let allData = null;

        // 1. 解密数据
        try {
            if (typeof CryptoJS === 'undefined') return alert("⚠️ 加载中，请稍后重试...");
            const bytes = CryptoJS.AES.decrypt(PAYLOAD, pass);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            if (!originalText) throw new Error("密码错误");
            allData = JSON.parse(originalText);
        } catch(e) {
            return alert("⛔ 访问拒绝：密码错误！");
        }

        // 2. 精确查找 (班级 + 姓名 必须完全匹配)
        // 构造 Key：将用户输入的班级和姓名拼接，并去除空格 (例如 "701_张三")
        const key = (cls + "_" + name).replace(/\\s+/g, "");
        const res = allData[key];

        // 3. 渲染结果
        resBox.innerHTML = '';
        
        if(!res) {
            alert("❌ 未找到学生信息！\\n请检查【班级】和【姓名】是否输入正确。\\n(班级如：701)");
        } else {
            let subHtml = '';
            for(let sub in res.s) {
                const item = res.s[sub];
                let rankHtml = '<span class="tag-rank">校: ' + item[1] + '</span>';
                if (!IS_SINGLE_SCHOOL) rankHtml += '<span class="tag-rank">镇: ' + item[2] + '</span>';
                subHtml += 
                    '<div class="sub-item">' +
                        '<div class="sub-main"><div class="sub-name">' + sub + '</div><div class="sub-val">' + item[0] + '</div></div>' +
                        '<div class="sub-ranks">' + rankHtml + '</div>' +
                    '</div>';
            }
            
            let totalRankHtml = 
                '<div class="rank-item"><div class="rank-val">' + res.cr + '</div><div class="rank-lbl">班排</div></div>' +
                '<div class="rank-item"><div class="rank-val">' + res.sr + '</div><div class="rank-lbl">校排</div></div>';
            if (!IS_SINGLE_SCHOOL) totalRankHtml += '<div class="rank-item"><div class="rank-val">' + res.tr + '</div><div class="rank-lbl">镇排</div></div>';

            // 注意：Canvas 需要固定高度
            const chartsHtml = \`
                <div class="comment-box">
                    <div class="comment-title">👩‍🏫 班主任评语</div>
                    <div class="comment-text">\${res.cm || '暂无评语'}</div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-title">📊 学科能力分布 (雷达图)</div>
                    <div style="height:200px; position:relative;">
                        <canvas id="mobRadarChart"></canvas>
                    </div>
                </div>

                <div class="chart-box">
                    <div class="chart-title">⚖️ 学科均衡度诊断 (标准分)</div>
                    <div style="height:200px; position:relative;">
                        <canvas id="mobVarChart"></canvas>
                    </div>
                    <div style="font-size:10px; color:#999; text-align:center; margin-top:5px;">
                        注: 柱子朝上为优势科目，朝下为弱势科目
                    </div>
                </div>
            \`;

            resBox.innerHTML = 
                '<div class="score-card">' +
                    '<div class="head-section">' +
                        '<div class="stu-info-bar">' + res.cls + '班 · ' + res.name + '</div>' +
                        '<div class="total-val">' + res.t + '</div>' +
                        '<div class="total-lbl">总分</div>' +
                    '</div>' +
                    '<div class="rank-bar">' + totalRankHtml + '</div>' +
                    '<div class="sub-grid">' + subHtml + '</div>' +
                '</div>' + 
                '<div style="text-align:center; color:green; font-size:12px; margin-top:10px;">✅ 查询成功</div>';
            
            resBox.style.display = 'block';

            setTimeout(() => {
                // 1. 绘制雷达图
                if (radarInst) radarInst.destroy();
                const ctxRadar = document.getElementById('mobRadarChart');
                if (ctxRadar && res.rd) {
                    radarInst = new Chart(ctxRadar, {
                        type: 'radar',
                        data: {
                            labels: res.rd.labels,
                            datasets: [{
                                label: '能力值',
                                data: res.rd.data,
                                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                borderColor: '#2563eb',
                                pointBackgroundColor: '#2563eb'
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: { r: { min: 0, max: 100, ticks: { display: false }, pointLabels: { font: { size: 10 } } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                // 2. 绘制均衡度柱状图
                if (varInst) varInst.destroy();
                const ctxVar = document.getElementById('mobVarChart');
                if (ctxVar && res.vd) {
                    const colors = res.vd.data.map(v => v >= 0 ? '#16a34a' : '#dc2626');
                    varInst = new Chart(ctxVar, {
                        type: 'bar',
                        data: {
                            labels: res.vd.labels,
                            datasets: [{
                                label: '标准分',
                                data: res.vd.data,
                                backgroundColor: colors,
                                borderRadius: 3
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y', // 横向柱状图更适合手机查看长标签
                            scales: { 
                                x: { grid: { display: true }, title: {display:true, text:'← 弱势 | 强势 →'} },
                                y: { grid: { display: false } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, 100);

        }
    }
<\/script>

</body>
</html>
