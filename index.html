<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script src="js/supabase-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin="anonymous" onload="window.initSupabase()"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/lz-string@1.5.0/libs/lz-string.min.js'"></script>
    <!-- 🟢 [修复] 添加 idb-keyval（本地缓存依赖） -->
    <script src="https://unpkg.com/idb-keyval@6/dist/idb-keyval-iife.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval-iife.min.js'"></script>
    <!-- 🟢 [修复] 添加 XLSX 库支持 Excel 导入导出功能 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>
    <!-- 🟢 [修复] 添加 Alpine.js（教师卡片依赖） -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js'"></script>
    <!-- 🟢 [修复] 添加 Chart.js（报告图表依赖） -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'"></script>
    <!-- 🟢 [修复] 添加 SweetAlert2（Swal 依赖） -->
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/sweetalert2@11/dist/sweetalert2.all.min.js'"></script>
    <!-- 🟢 [新增] 添加 jsPDF（PDF导出） -->
    <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'"></script>
    <link rel="stylesheet" href="styles.css">
    <script defer src="js/cloud-manager.js"></script>

    <!-- ================== 样式定义 (CSS) ================== -->
    <style>
       :root { 
               // --- 家长查分轻量包生成器 已迁移到 js/inquiry-package.js ---
               // --- 班级分析会 PPT 生成器 已迁移到 js/report-exports.js ---
        /* 评论区 (展示单科详情) */
        .insta-comments {
            padding: 0 14px 14px 14px;
            font-size: 14px;
        }
        .insta-comment-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .insta-comm-user { font-weight: 600; margin-right: 5px; }
        .insta-comm-text { color: #262626; }
        .insta-comm-score { font-weight: bold; color: #262626; }
        .insta-comm-rank { font-size: 12px; color: #8e8e8e; margin-left: 5px; }

        .insta-timestamp {
            padding: 0 14px 14px;
            font-size: 10px;
            color: #8e8e8e;
            text-transform: uppercase;
        }

        /* === 2. 手机端管理界面样式 (Teacher/Admin Mobile) === */
        #mobile-manager-app {
            display: none; /* 默认隐藏，JS控制显示 */
            padding-bottom: 70px;
            background: #f3f4f6;
            min-height: 100vh;
        }

            // === 家长查分轻量包生成器 已迁移到 js/inquiry-package.js ===
            // === 班级分析会 PPT 生成器 已迁移到 js/report-exports.js ===
                    </label>
                    <input type="text" id="login-class" placeholder="请输入班级 (仅家长/学生必填)" 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                        // === 家长查分轻量包生成器 已迁移到 js/inquiry-package.js ===
                        // === 班级分析会 PPT 生成器 已迁移到 js/report-exports.js ===
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> 指标生达标核算
                    <span class="module-help-btn" onclick="showModuleHelp('indicator')">📘 计分公式</span>
                </h2>
                <div>
                    <button class="btn btn-blue" onclick="openTargetEditor()">
                        <i class="ti ti-edit"></i> 在线调整目标
                    </button>
                    <button class="btn btn-green" id="btn-indicator-calc" onclick="calcIndicators()">开始计算</button>
                    <button class="btn" onclick="exportExcel('indicator')">导出结果</button>
                </div>
            </div>
            <details class="explain-panel">
                <summary>口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>指标线：根据设定的名次或比例自动换算为分数线。</p>
                    <p>达标人数：总分达到对应指标线的学生数。</p>
                    <p>达标率：达标人数 ÷ 实考人数。</p>
                    <p>指标得分：按达标率进行标准化折算，用于校际比较。</p>
                </div>
            </details>
            <div class="table-wrap"><table id="tb-indicator"><thead><tr><th>学校名称</th><th>指标一(目标/达标)</th><th>得分</th><th>指标二(目标/达标)</th><th>得分</th><th>指标生总分</th><th>排名</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 5. 综合总排名 -->
        <div id="summary" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-report"></i> 综合分析报告 <span class="badge" style="background:#16a34a;">⭐ 教务常用</span>
                    <span class="module-help-btn" onclick="showModuleHelp('summary')">📘 权重说明</span>
                </h2>
                <div>
                    <button class="btn btn-green" onclick="calcSummary()">生成总排名</button>
                    <button class="btn btn-green" onclick="exportSummaryTable()">导出报告</button>
                    <button class="btn btn-orange" onclick="exportPPTReport()">
                        <i class="ti ti-presentation"></i> 导出汇报PPT
                    </button>
</div></div>
            <div class="table-wrap"><table id="tb-summary"><thead><tr><th>学校名称</th><th>两率一分得分</th><th>后1/3得分</th><th>指标生得分</th><th>综合总分</th><th>总排名</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 6. 本校教师分析 -->
        <div id="teacher-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-school"></i> 本校教师教学分析 <span class="badge" style="background:#0ea5e9;">📊 班主任必看</span>
                    <span class="module-help-btn" onclick="showModuleHelp('teacher')">📘 评价模型</span>
                </h2>
                <button class="btn" onclick="exportTeacherAnalysis()">导出教师分析</button>
            </div>
            <div class="info-bar" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <span>本校教师教学分析基于导入的教师信息和成绩数据，展示教师所教班级的整体表现，并与乡镇学校进行对比。</span>
                <button id="teacher-sync-cta" class="btn btn-orange" style="display:none; white-space:nowrap;" onclick="openTeacherSync()">去同步任课表</button>
            </div>
            <details class="explain-panel">
                <summary>指标口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>平均分：该教师所教班级、该学科所有有效成绩的算术平均。</p>
                    <p>优秀线/及格线：按年级实考人数比例自动划定，9年级优秀线取前15%，其他年级取前20%，及格线取前50%；单校总分可按“名次线”换算。</p>
                    <p>优秀率：优秀人数 ÷ 实考人数，优秀线来自本次年级分布阈值。</p>
                    <p>及格率：及格人数 ÷ 实考人数，及格线来自本次年级分布阈值。</p>

                    // === 家长查分轻量包生成器 已迁移到 js/inquiry-package.js ===
                    // === 班级分析会 PPT 生成器 已迁移到 js/report-exports.js ===
                </div>
            </div>
        </div>
        

            // === 家长查分轻量包生成器 已迁移到 js/inquiry-package.js ===
            // === 班级分析会 PPT 生成器 已迁移到 js/report-exports.js ===
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">榜单类型：</label>
                        <select id="posterSubjectSelect" style="width:100%; margin-bottom:5px;">
                            <option value="total">🏆 总分光荣榜</option>
                            <!-- JS动态填充科目 -->
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">上榜人数：</label>
                        <input type="number" id="posterCount" value="10" min="1" max="50" style="width:100%;">
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">📝 3. 文案定制</h4>
                    <div style="margin-bottom:5px;"><input type="text" id="posterTitleInput" value="光荣榜" placeholder="大标题" style="width:100%;"></div>
                    <div style="margin-bottom:10px;"><input type="text" id="posterSubInput" value="本次期末考试优秀名单" placeholder="副标题" style="width:100%;"></div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="renderPoster()">🔄 生成/刷新预览</button>
                </div>

                <!-- 右侧：预览画布 -->
                <div class="poster-preview-area">
                    <div id="poster-canvas" class="poster-canvas theme-red">
                        <div class="p-header">
                            <h1 class="p-title" contenteditable="true">光荣榜</h1>
                            <div class="p-sub" contenteditable="true">2024-2025学年 第一学期期末考试</div>
                        </div>
                        <div class="p-list" id="poster-list-container">
                            <!-- 列表项将在这里生成 -->
                            <div style="text-align:center; padding-top:100px; opacity:0.7;">
                                请在左侧选择数据并点击生成
                            </div>
                        </div>
                        <div class="p-footer" contenteditable="true">
                            星光不问赶路人 · 时光不负有心人<br>
                            xx中学教务处 宣
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 语音控制入口 -->
    <div id="voice-fab" class="voice-fab" onclick="VoiceControl.toggle()" title="点击开启语音控制">
        <i class="ti ti-microphone"></i>
    </div>

    <!-- 全屏语音 HUD -->
    <div id="voice-hud" class="voice-hud" onclick="VoiceControl.stop()">
        <div class="voice-wave">
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
        </div>
        <div id="voice-status" class="voice-text-main">正在聆听...</div>
        <div id="voice-result" class="voice-text-sub">请说出指令，例如：“打开全科总表”</div>
        
        <div class="voice-cmd-list">
            <div class="voice-cmd-item"><span class="voice-cmd-key">"看总榜"</span> 跳转综合排名</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"看教师"</span> 教师分析</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"查某某"</span> 搜索学生</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"全屏模式"</span> 隐藏菜单</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"退出语音"</span> 关闭语音</div>
        </div>
        <div style="margin-top: 30px; font-size: 12px; color: #64748b;">(点击任意处关闭)</div>
    </div>

    <div id="drill-modal" class="modal" style="display: none; z-index: 12000;">
        <!-- 修改点：style 中宽度改为 95%，max-width 改为 1200px，高度改为 90vh -->
        <div class="modal-content" style="width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="drill-back-btn" class="btn btn-sm btn-gray hidden" onclick="DrillSystem.goBack()">
                        <i class="ti ti-arrow-left"></i> 返回
                    </button>
                    <h3 id="drill-title" style="margin:0; color:var(--primary); font-size:18px;">数据详情</h3>
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <!-- 新增导出按钮 -->
                    <button id="drill-export-btn" class="btn btn-sm btn-green" onclick="DrillSystem.exportExcel()">
                        <i class="ti ti-file-export"></i> 导出为Excel
                    </button>
                    <button onclick="document.getElementById('drill-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div id="drill-content" style="flex:1; overflow-y:auto;"></div>
            
            <!-- 底部统计 -->
            <div id="drill-footer" style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; font-size:12px; color:#666; text-align:right;"></div>
        </div>
    </div>

    <div id="target-editor-modal" class="modal" style="display: none; z-index: 11500;">
        <div class="modal-content" style="width: 90%; max-width: 1000px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;">🎯 设定各校指标目标</h3>
                <button onclick="document.getElementById('target-editor-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="info-bar" style="margin-bottom:10px;">
                💡 提示：此处修改将直接更新内存数据，记得点击“开始计算”刷新结果。
            </div>

            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="target-editor-table">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th style="background:#e0f2fe;">指标一目标 (人)</th>
                            <th style="background:#fff7ed;">指标二目标 (人)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-gray" onclick="document.getElementById('target-editor-modal').style.display='none'">取消</button>
                <button class="btn btn-primary" onclick="saveTargetEditor()">💾 保存并重算</button>
            </div>
        </div>
    </div>

    <style>
        /* 钻取弹窗专用样式 */
        .drill-class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .drill-class-card { 
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; 
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .drill-class-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-color: var(--primary); background: #eff6ff; }
        .drill-val { font-size: 18px; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .drill-label { font-size: 12px; color: #64748b; }
        
        .drill-stu-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .drill-stu-tag { 
            background: white; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 4px; 
            font-size: 13px; display: flex; align-items: center; gap: 5px;
        }
        .drill-stu-score { color: var(--primary); font-weight: bold; font-family: monospace; }
        .clickable-num { cursor: pointer; text-decoration: underline; color: var(--primary); font-weight: bold; }
        .clickable-num:hover { color: #d97706; }
    </style>
    <!-- 批量打印隐藏容器 -->
    <div id="batch-print-container" style="display:none;"></div>
    <div id="desk-labels-print-area"></div>
    <!-- 全局快捷搜索弹窗 -->
    <div id="spotlight-mask" class="spotlight-mask" onclick="closeSpotlight(event)">
        <div class="spotlight-box" onclick="event.stopPropagation()">
            <div class="spotlight-input-wrap">
                <i class="ti ti-search" style="font-size:24px; color:var(--primary); margin-right:10px;"></i>
                <input type="text" id="spotlight-input" class="spotlight-input" placeholder="输入姓名、学校或班级..." oninput="doSpotlightSearch()">
            </div>
            <div id="spotlight-results" class="spotlight-results"></div>
            <div class="spotlight-hint">输入关键字搜索，点击结果可直接跳转至该生分析报告</div>
        </div>
    </div>
    <!-- 教师详情模态框 -->
    <div class="modal" id="teacherModal" style="display: none;">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h3 id="modalTeacherName" style="color:var(--primary);">教师姓名</h3><button id="closeModal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div class="bg-gray-50"><h4 style="margin-bottom:15px; color:#333;">教学概况</h4><div style="display:flex; justify-content:space-around;"><div class="stat-item"><div class="stat-value" id="modalAvgScore">0.00</div><div class="stat-label">平均分</div></div><div class="stat-item"><div class="stat-value" id="modalExcellentRate">0%</div><div class="stat-label">优秀率</div></div><div class="stat-item"><div class="stat-value" id="modalPassRate">0%</div><div class="stat-label">及格率</div></div></div></div>
                <div class="bg-gray-50"><h4 style="margin-bottom:15px; color:#333;">对比分析</h4><div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;"><span>平均分对比</span><span id="modalAvgComparison">0%</span></div><div style="height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden;"><div id="modalAvgProgress" style="width:0; height:100%; transition:1s;"></div></div></div></div>
            </div>
            <table class="subject-table" id="modalSubjectTable"><thead><tr><th>学科</th><th>平均分</th><th>对比</th><th>优秀率</th><th>对比</th><th>及格率</th><th>对比</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div class="modal" id="mobileShareModal" style="display: none; z-index: 10001;">
        <div class="modal-content" style="max-width: 450px; text-align: center; background: #333;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:white; font-size:16px;">📱 长按/右键保存图片</h3>
                <button onclick="document.getElementById('mobileShareModal').style.display='none'" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="mobile-img-result" style="max-height: 80vh; overflow-y: auto; border:1px solid #555;">
                <!-- 图片将生成在这里 -->
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" onclick="downloadMobileImage()">⬇️ 下载图片</button>
            </div>
        </div>
    </div>
    <!-- 同名同姓/转班 手动映射确认框 -->
    <div class="modal" id="mappingModal" style="display: none; z-index: 10002;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="color:#d97706; font-size:18px;">⚠️ 检测到疑似同名/转班学生</h3>
                <p style="font-size:13px; color:#666; margin-top:5px;">
                    系统发现以下学生在“上次考试”中有同名记录，但班级不一致（可能转班了）。<br>
                    请手动确认对应关系，以便精确计算进退步。
                </p>
            </div>
            
            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="mappingTable" style="width:100%; font-size:13px;">
                    <thead>
                        <tr>
                            <th style="background:#fef3c7;">当前学生 (本次)</th>
                            <th style="background:#fef3c7;">选择对应的上次记录</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-gray" onclick="document.getElementById('mappingModal').style.display='none'">取消分析</button>
                <button class="btn btn-primary" onclick="confirmMappingsAndRun()">✅ 确认匹配并继续</button>
            </div>
        </div>
    </div>
    <!-- 电子奖状模态框 -->
    <div id="cert-modal" class="modal" style="display: none; z-index: 10005;">
        <div class="modal-content" style="max-width: 550px; text-align: center; background: #fff; padding: 10px;">
            <!-- 这里是奖状的可视化区域 -->
            <div id="cert-capture-area" style="padding: 40px; background: #fffaf0; border: 12px double #b45309; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(180,83,9,0.05);">
                <!-- 背景装饰：由于是单文件，我们用 CSS 画一个简易防伪印章效果 -->
                <div style="position: absolute; bottom: 30px; right: 40px; width: 100px; height: 100px; border: 3px solid rgba(220,38,38,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(220,38,38,0.2); font-weight: bold; transform: rotate(-15deg); pointer-events: none; font-size: 14px;">教务处核准</div>
                
                <h1 style="color: #b45309; font-size: 42px; margin-bottom: 5px; font-family: 'STKaiti', '楷体', serif;">荣誉证书</h1>
                <div style="width: 150px; height: 3px; background: #b45309; margin: 0 auto 25px;"></div>
                
                <p style="font-size: 22px; margin-top: 20px; text-align: left; line-height: 2;">
                    <strong id="cert-name" style="border-bottom: 2px solid #333; padding: 0 15px; color: #1e293b;">张三</strong> 同学：
                </p>
                <p style="text-align: left; text-indent: 2.5em; line-height: 2; font-size: 18px; color: #374151;">
                    在本次 <span id="cert-exam-name" style="font-weight: bold; color: #2563eb;">期末考试</span> 中，凭借坚持不懈的努力和出色的表现，获得了
                    <strong id="cert-honor" style="color: #dc2626; font-size: 24px;">“进步之星”</strong>
                    光荣称号，特发此证，以资鼓励！
                </p>
                <div style="margin-top: 50px; text-align: right; padding-right: 20px;">
                    <p style="font-weight: bold; font-size: 18px; color: #1e293b;" id="cert-school-footer">XX中学教务处</p>
                    <p id="cert-date" style="color: #64748b;">2024年12月</p>
                </div>
            </div>
            
            <!-- 底部操作按钮 -->
            <div style="margin-top: 20px; display: flex; gap: 15px; padding: 10px;">
                <button class="btn btn-orange" style="flex:1; font-size: 16px; height: 45px;" onclick="downloadCertificate()">
                    <i class="ti ti-download"></i> 保存奖状为高清图片
                </button>
                <button class="btn btn-gray" style="width: 100px;" onclick="document.getElementById('cert-modal').style.display='none'">关闭</button>
            </div>
        </div>
    </div>
    <div id="school-profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="sp-title" style="margin:0; color:var(--primary); font-size:20px;">🏫 学校画像</h3>
                <button onclick="document.getElementById('school-profile-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="school-modal-grid">
                <!-- 左侧：雷达图 -->
                <div style="background:#f8fafc; border-radius:8px; padding:10px; border:1px solid #e2e8f0; height:300px; position:relative;">
                    <h4 style="text-align:center; font-size:13px; color:#64748b; margin-bottom:5px;">学科均衡度诊断 (vs 全镇均值)</h4>
                    <div style="height:260px; width:100%;"><canvas id="schoolRadarChart"></canvas></div>
                </div>
                
                <!-- 右侧：数据概览 -->
                <div>
                    <h4 style="margin-bottom:10px; border-left:4px solid var(--primary); padding-left:8px;">📊 核心指标</h4>
                    <div class="fb-dashboard" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">综合排名</div>
                            <div class="fb-val text-red" id="sp-rank">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">考核总分</div>
                            <div class="fb-val text-blue" id="sp-score">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">平均分赋分</div>
                            <div class="fb-val" id="sp-s1">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">三率赋分</div>
                            <div class="fb-val" id="sp-s2">-</div>
                        </div>
                    </div>
                    
                    <div class="info-bar" style="font-size:12px;">
                        💡 <strong>诊断建议：</strong><br>
                        <span id="sp-diagnosis">点击学校查看分析...</span>
                    </div>
                </div>
            </div>

            <!-- 分数段分布图 (双轴) -->
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #e2e8f0;">
                <h4 style="margin-bottom:10px; color:#333; font-size:14px; display:flex; justify-content:space-between;">
                    <span>📉 分数段结构对比 (本校 vs 全镇)</span>
                    <span style="font-weight:normal; font-size:12px; color:#666;">柱状=本校占比 | 折线=全镇均值</span>
                </h4>
                <div style="height:180px; width:100%; position:relative;">
                    <canvas id="schoolDistChart"></canvas>
                </div>
            </div>

            <div class="school-modal-actions">
                <span style="font-size:12px; color:#999; margin-right:auto; align-self:center;">跳转后将自动筛选该校数据</span>
                <button class="btn btn-purple" onclick="jumpToModule('class-comparison')"><i class="ti ti-layout-columns"></i> 班级对比</button>
                <button class="btn btn-blue" onclick="jumpToModule('teacher-analysis')"><i class="ti ti-school"></i> 教师评价</button>
                <button class="btn btn-green" onclick="jumpToModule('student-details')"><i class="ti ti-users"></i> 学生名单</button>
            </div>
        </div>
    </div>
    <!-- 外观设置模态框 -->
    <div id="skin-modal" class="modal" style="display: none; z-index: 11000;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:var(--primary);"><i class="ti ti-palette"></i> 系统外观定制</h3>
                <button onclick="document.getElementById('skin-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 1. 主题色设置 -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">1. 选择主色调</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <!-- 预设颜色 -->
                    <div onclick="setThemeColor('#4f46e5')" style="width:30px; height:30px; background:#4f46e5; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="默认紫"></div>
                    <div onclick="setThemeColor('#2563eb')" style="width:30px; height:30px; background:#2563eb; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="科技蓝"></div>
                    <div onclick="setThemeColor('#059669')" style="width:30px; height:30px; background:#059669; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="护眼绿"></div>
                    <div onclick="setThemeColor('#dc2626')" style="width:30px; height:30px; background:#dc2626; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="中国红"></div>
                    <div onclick="setThemeColor('#b45309')" style="width:30px; height:30px; background:#b45309; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="尊贵金"></div>
                    <div onclick="setThemeColor('#0f172a')" style="width:30px; height:30px; background:#0f172a; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="深邃黑"></div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="color" id="custom-color-input" onchange="setThemeColor(this.value)" style="width:50px; height:30px; padding:0; border:none;">
                    <span style="font-size:12px; color:#666;">自定义颜色 (点击色块选择)</span>
                </div>
            </div>

            <!-- 2. Logo 设置 -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">2. 定制校徽/Logo</h4>
                <div class="upload-box" style="padding:15px; border:1px dashed #ccc; min-height:auto;" onclick="document.getElementById('logoInput').click()">
                    <div style="color:var(--primary); font-size:20px;"><i class="ti ti-photo-up"></i> 点击上传 Logo 图片</div>
                    <p style="font-size:12px; color:#999; margin:5px 0;">建议使用透明背景 PNG，高度60px左右<br>图片将保存在本地浏览器中</p>
                    <input type="file" id="logoInput" accept="image/*" hidden onchange="handleLogoUpload(this)">
                </div>
                <button class="btn btn-gray btn-sm" onclick="clearLogo()" style="margin-top:5px;">🗑️ 清除 Logo</button>
            </div>

            <!-- 3. 标题设置 -->
            <div style="margin-bottom: 10px;">
                <h4 style="margin-bottom:10px; color:#333;">3. 系统名称</h4>
                <input type="text" id="custom-title-input" placeholder="默认为：乡镇学校成绩分析..." style="width:100%; margin-bottom:5px;" oninput="updateTitlePreview(this.value)">
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="saveSkinSettings()">💾 保存并应用</button>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="modal" style="display: none; z-index: 60000;">
        <div class="modal-content" style="max-width: 600px;"> <!-- 稍微调宽一点 -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="color:#b91c1c; margin:0;"><i class="ti ti-shield-lock"></i> 账号管理</h3>
                <!-- 新增：查看日志按钮 -->
                <button onclick="Logger.view()" style="font-size:12px; background:#fff; border:1px solid #ccc; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                    <i class="ti ti-history"></i> 操作日志
                </button>
            </div>
            <button onclick="document.getElementById('admin-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
            
            <div class="info-bar" style="margin-bottom:20px;">
                此处功能将基于您在【数据中心】上传的 Excel 数据批量生成账号。<br>
                所有生成账号的默认初始密码均为 <strong>123456</strong>。
            </div>

            <div style="display:grid; gap:15px;">
                <!-- 功能区 1 -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <h4 style="margin-bottom:10px; color:#334155;">1. 批量生成/重置账号</h4>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px; font-weight:bold; color:#64748b; display:block; margin-bottom:5px;">
                            请选择要生成的学校 (多选):
                        </label>
                        <div id="admin-gen-school-list" style="max-height:100px; overflow-y:auto; background:white; border:1px solid #cbd5e1; border-radius:4px; padding:5px; font-size:12px;">
                            <div style="color:#999; text-align:center; padding:10px;">暂无数据，请先上传成绩</div>
                        </div>
                        <div style="text-align:right; margin-top:2px;">
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(true)" style="font-size:11px; color:var(--primary);">全选</a> / 
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(false)" style="font-size:11px; color:var(--primary);">清空</a>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="Auth.generateAccounts()" style="width:100%;">
                        <i class="ti ti-user-plus"></i> 一键生成所有账号 (教师+家长)
                    </button>
                    <button class="btn btn-green" onclick="Auth.exportAccounts()" style="width:100%; background:#059669; color:white;">
                        <i class="ti ti-file-export"></i> 导出账号密码表 (Excel)
                    </button>
<!-- 新增：批量同步云端按钮 -->
                <button class="btn btn-blue" onclick="Auth.syncBatchToCloud()" style="width:100%; background:#2563eb; color:white; margin-top:5px;">
                    <i class="ti ti-cloud-upload"></i> 一键同步所有账号到云端 (Database)
                </button>
                <p style="font-size:11px; color:#64748b; margin-top:2px; text-align:center;">
                    将本地生成的账号批量写入 Supabase 数据库，以便用户登录。
                </p>
<!-- 新增：清空云端按钮 -->
                <div style="margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                    <button class="btn btn-danger" onclick="Auth.deleteCloudAccounts()" style="width:100%; background:#dc2626; color:white;">
                        <i class="ti ti-trash-x"></i> ⚠️ 清空云端所有普通账号
                    </button>
                    <p style="font-size:11px; color:#ef4444; margin-top:2px; text-align:center;">
                        警告：将删除云端所有家长和教师账号（保留管理员）。
                    </p>
                </div>
                    <hr style="margin: 15px 0; border:0; border-top:1px dashed #ccc;">
                    <h4 style="margin-bottom:10px; color:#7c3aed;">🚀 发送给家长</h4>
                    <button class="btn btn-purple" onclick="Packager.exportDistributableHTML()" style="width:100%; background:#7c3aed; color:white; font-weight:bold;">
                        <i class="ti ti-package"></i> 生成可分发网页 (含数据)
                    </button>
                    <p style="font-size:11px; color:#7c3aed; margin-top:5px; background:#f3e8ff; padding:5px; border-radius:4px;">
                        生成一个内置了成绩和账号的新HTML文件。请把这个新文件发到家长群。
                    </p>
                    <p style="font-size:12px; color:#666; margin-top:5px;">
                        教师账号 = 教师姓名 (默认密码 yssy2016)<br> <!-- 🟢 修改点：更新显示文本 -->
                        家长账号 = 学生姓名 (默认密码 123456)
                    </p>
                </div>

                <!-- 功能区 2: 云端账号管理 (修正版) -->
            <div style="background:#fff; padding:15px; border:1px solid #cbd5e1; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                
                <!-- 👇👇👇 🟢 修改：增加了班主任、级部主任选项，以及右侧的 Excel 工具栏 🟢 👇👇👇 -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                     <h4 style="margin:0; color:#0369a1;"><i class="ti ti-cloud-upload"></i> 2. 添加/管理云端账号</h4>
                     <div style="display:flex; gap:5px;">
                        <button class="btn btn-sm btn-green" onclick="AccountExcel.downloadTemplate()" title="下载导入模板">
                            <i class="ti ti-download"></i> 模板
                        </button>
                        <button class="btn btn-sm btn-orange" onclick="document.getElementById('accExcelInput').click()" title="上传Excel批量导入">
                            <i class="ti ti-file-import"></i> 导入
                        </button>
                        <input type="file" id="accExcelInput" accept=".xlsx,.xls" hidden onchange="AccountExcel.upload(this)">
                     </div>
                </div>

                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="manual-role" style="padding:8px; border:1px solid #ccc; width:30%; font-size:12px;" onchange="toggleAdminManualInput()">
                        <option value="teacher">👨‍🏫 科任教师</option>
                        <option value="class_teacher">📋 班主任</option>
                        <option value="grade_director">🚀 级部主任</option>
                        <option value="director">🎓 教务主任</option>
                        <option value="parent">👨‍👩‍👧 家长</option>
                        <option value="admin">🔑 管理员</option>
                    </select>
                    <!-- 级部输入框 (默认隐藏) -->
                    <input type="text" id="manual-grade" placeholder="级部(如:7)" style="padding:8px; border:1px solid #ccc; width:20%; display:none;">
                    
                    <input type="text" id="manual-school" placeholder="所属学校 (必填)" style="padding:8px; border:1px solid #ccc; width:25%;">
                    <input type="text" id="manual-name" placeholder="账号/姓名" style="padding:8px; border:1px solid #ccc; flex:1;">
                </div>

                <!-- 班级输入框 (默认隐藏，仅家长需要) -->
                <div id="manual-class-wrap" style="margin-bottom:10px; display:none;">
                    <input type="text" id="manual-class" placeholder="输入班级 (如: 701，家长必填)" style="width:100%; padding:8px; border:1px solid #ccc;">
                </div>

                <div style="display:flex; gap:10px;">
                    <input type="text" id="manual-pass" value="123456" placeholder="密码" style="padding:8px; border-radius:4px; border:1px solid #ccc; width:60%;">
                    <!-- 这里的 onclick 必须指向 Auth.addCloudAccount -->
                    <button class="btn btn-primary" onclick="Auth.addCloudAccount()" style="flex:1;">添加/更新</button>
                </div>
                <p style="font-size:12px; color:#999; margin-top:5px;">提示：直接写入云端数据库。账号必须唯一。</p>
            </div>

                
                <!-- 功能区 3 -->
                <div style="background:#fff; padding:15px; border:1px solid #eee; border-radius:8px;">
                    <h4 style="margin-bottom:10px; color:#333;">3. 修改管理员密码</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-admin-pass" placeholder="输入新密码" style="padding:8px; flex:1; border:1px solid #cbd5e1; border-radius:4px;">
                        <button class="btn btn-gray" onclick="changeAdminPass()">确认修改</button>
                    </div>
                </div>
                <div style="background:#f0fdf4; padding:15px; border:1px solid #86efac; border-radius:8px; margin-top:5px;">
                    <h4 style="margin-bottom:10px; color:#166534;"><i class="ti ti-cloud-download"></i> 4. 导出云端所有账号 (完整备份)</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <p style="font-size:12px; color:#15803d; margin:0; flex:1;">
                            此功能直接从云端数据库下载，包含<strong>批量生成</strong>、<strong>手动添加</strong>及<strong>Excel导入</strong>的所有账号。<br>
                            包含：角色、学校、班级、账号、密码。
                        </p>
                        <button class="btn btn-green" onclick="Auth.exportAllCloudAccounts()" style="background:#16a34a; color:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            <i class="ti ti-download"></i> 下载全量账号表
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script defer src="js/account-admin.js"></script>
    <script defer src="js/app-core-part1.js"></script>
    <script defer src="js/navigation.js"></script>
    <script defer src="js/excel-utils.js"></script>
    <script defer src="js/auth-issues.js"></script>
    <script defer src="js/packager-help.js"></script>
    <script defer src="js/worker-source.js"></script>
    <script defer src="js/cohort-archive.js"></script>
    <script defer src="js/spotlight-help.js"></script>
    <script defer src="js/data-manager.js"></script>
    <script defer src="js/role-status.js"></script>
    <script defer src="js/project-snapshot.js"></script>
    <script defer src="js/skin-voice.js"></script>
    <script defer src="js/school-profile.js"></script>
    <script defer src="js/sse-tools.js"></script>
    <script defer src="js/app-state-vars.js"></script>
    <script defer src="js/privacy-guest-mode.js"></script>
    <script defer src="js/drill-system.js"></script>
    <script defer src="js/high-score.js"></script>
    <script defer src="js/batch-ai-comments.js"></script>
    <script defer src="js/table-visuals.js"></script>
    <script defer src="js/seat-print-tools.js"></script>
    <script defer src="js/admin-runtime.js"></script>
    <script defer src="js/app-runtime-core.js"></script>
    <script defer src="js/data-processing.js"></script>
    <script defer src="js/table-render.js"></script>
    <script defer src="js/select-updates.js"></script>
    <script defer src="js/teacher-analysis.js"></script>
    <script defer src="js/correlation-analysis.js"></script>
    <script defer src="js/progress-analysis.js"></script>
    <script defer src="js/analysis-tools.js"></script>
    <script defer src="js/analysis-extensions.js"></script>
    <script defer src="js/ai-chat.js"></script>
    <script defer src="js/student-details.js"></script>
    <script defer src="js/fb-division.js"></script>
    <script defer src="js/inquiry-package.js"></script>
    <script defer src="js/exam-scheduler.js"></script>
    <script defer src="js/grade-scheduler.js"></script>
    <script defer src="js/poster-tools.js"></script>
    <script defer src="js/marginal-push.js"></script>
    <script defer src="js/seat-adjust.js"></script>
    <script defer src="js/fb-seat-map.js"></script>
    <script defer src="js/mutual-aid.js"></script>
    <script defer src="js/ai-report-tools.js"></script>
    <script defer src="js/report-exports.js"></script>
    <script defer src="js/report-card.js"></script>
    <script defer src="js/ai-class-report.js"></script>
    
<!-- 核心逻辑已全部迁移到各 js 文件 -->
<button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
        style="position: fixed; bottom: 30px; left: 30px; width: 45px; height: 45px; 
               border-radius: 50%; background: rgba(30, 41, 59, 0.8); color: white; 
               border: none; cursor: pointer; display: none; z-index: 999; 
               box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;">
    <i class="ti ti-arrow-up" style="font-size: 20px;"></i>
</button>
<!-- 修改密码模态框 -->
<div id="user-password-modal" class="modal" style="display: none; z-index: 70000;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3 style="color:var(--primary); margin:0;"><i class="ti ti-lock"></i> 修改个人密码</h3>
            <button onclick="document.getElementById('user-password-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <div style="display:flex; flex-direction:column; gap:15px;">
            <div>
                <label style="font-size:12px; font-weight:bold; color:#666;">当前旧密码</label>
                <input type="password" id="upm-old" placeholder="输入当前密码" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold; color:#666;">新密码 (建议字母+数字)</label>
                <input type="password" id="upm-new" placeholder="输入新密码" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold; color:#666;">确认新密码</label>
                <input type="password" id="upm-confirm" placeholder="再次输入新密码" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
            </div>
            
            <button class="btn btn-primary" onclick="submitUserPasswordChange()" style="padding:12px; margin-top:10px;">
                确认修改并同步
            </button>
        </div>
    </div>
</div>

<!-- 1. 家长端：申诉提交弹窗 -->
<div id="issue-submit-modal" class="modal" style="display: none; z-index: 75000;">
    <div class="modal-content" style="max-width: 500px;">
        <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
            <h3 style="color:#b45309; margin:0; font-size:18px;">📝 成绩核查申请</h3>
            <p style="font-size:12px; color:#666; margin-top:5px;">请填写具体问题，教务处将在核实后处理。</p>
        </div>
        
        <div style="display:grid; gap:15px;">
            <!-- 隐藏域：自动填充学生信息 -->
            <div style="background:#f9fafb; padding:10px; border-radius:6px; font-size:13px; color:#374151; display:flex; gap:10px;">
                <input type="text" id="issue-student-school" readonly style="flex:1; border:none; background:transparent; font-weight:bold;">
                <input type="text" id="issue-student-class" readonly style="width:60px; border:none; background:transparent; font-weight:bold;">
                <input type="text" id="issue-student-name" readonly style="width:80px; border:none; background:transparent; font-weight:bold;">
            </div>

            <div>
                <label style="font-size:12px; font-weight:bold; color:#374151;">问题类型</label>
                <select id="issue-type" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;">
                    <option value="缺考/零分">❌ 显示缺考/零分 (实际已考)</option>
                    <option value="分数错误">📉 分数与预估严重不符</option>
                    <option value="信息有误">🆔 姓名/考号错误</option>
                    <option value="其他">📝 其他问题</option>
                </select>
            </div>

            <div>
                <label style="font-size:12px; font-weight:bold; color:#374151;">具体说明 (必填)</label>
                <textarea id="issue-desc" rows="4" placeholder="例如：数学试卷已交，但系统显示0分。大致预估分数为90分左右。" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px; font-size:14px;"></textarea>
            </div>

            <div>
                <label style="font-size:12px; font-weight:bold; color:#374151;">联系电话 (选填)</label>
                <input type="text" id="issue-contact" placeholder="方便老师回访" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-gray" style="flex:1;" onclick="document.getElementById('issue-submit-modal').style.display='none'">取消</button>
                <button class="btn btn-primary" style="flex:1; background:#b45309;" onclick="IssueManager.submit()">🚀 提交申请</button>
            </div>
        </div>
    </div>
</div>

<!-- 2. 管理员端：消息处理中心 -->
<div id="admin-issue-modal" class="modal" style="display: none; z-index: 76000;">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <!-- 顶部标题栏 -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <!-- 动态标题 ID -->
                <h3 style="color:var(--primary); margin:0;" id="issue-modal-title"><i class="ti ti-bell"></i> 申诉反馈中心</h3>
                <button class="btn btn-sm btn-gray" onclick="IssueManager.loadIssues()"><i class="ti ti-refresh"></i> 刷新</button>
            </div>
            <button onclick="document.getElementById('admin-issue-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- 操作工具栏 (包含正常模式和历史模式两套按钮) -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            
            <!-- A. 正常模式的操作按钮 -->
            <div style="display:flex; gap:10px;" id="issue-normal-actions">
                <button class="btn btn-sm btn-danger" onclick="IssueManager.batchSoftDelete()">
                    <i class="ti ti-trash"></i> 批量删除 (放入回收站)
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="issue-check-all" onchange="IssueManager.toggleSelectAll(this)" style="margin-right:5px;"> 全选
                </div>
            </div>
            
            <!-- B. 历史记录模式的操作按钮 (默认隐藏) -->
            <div style="display:none; gap:10px;" id="issue-history-actions">
                <button class="btn btn-sm btn-danger" style="background:#b91c1c; border-color:#991b1b;" onclick="IssueManager.batchHardDelete()">
                    <i class="ti ti-trash-x"></i> 彻底粉碎选中
                </button>
                <button class="btn btn-sm btn-green" onclick="IssueManager.batchRestore()">
                    <i class="ti ti-rotate"></i> 还原选中
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="issue-history-check-all" onchange="IssueManager.toggleSelectAll(this)" style="margin-right:5px;"> 全选
                </div>
            </div>

            <!-- C. 切换视图按钮 -->
            <div>
                <button class="btn btn-sm btn-gray" id="btn-issue-history" onclick="IssueManager.toggleHistoryView()">
                    <i class="ti ti-history"></i> 查看删除历史
                </button>
            </div>
        </div>

        <!-- 提示条 -->
        <div id="issue-tip-bar" style="background:#fffbeb; color:#92400e; padding:10px; border-radius:6px; font-size:12px; margin-bottom:10px;">
            <i class="ti ti-info-circle"></i> 提示：处理完问题后，请点击“标记已阅/解决”。点击“批量删除”会将记录移入历史记录。
        </div>

        <!-- 列表容器 -->
        <div id="admin-issue-list" style="flex:1; overflow-y:auto; background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #e5e7eb;">
            <!-- JS 动态加载内容 -->
        </div>
    </div>
</div>

<!-- 3. 管理员端：操作日志管理中心 -->
<div id="admin-log-modal" class="modal" style="display: none; z-index: 77000;">
    <div class="modal-content" style="max-width: 900px; height: 85vh; display: flex; flex-direction: column;">
        <!-- 标题栏 -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="color:#333; margin:0;" id="log-modal-title"><i class="ti ti-history"></i> 系统操作日志</h3>
                <button class="btn btn-sm btn-gray" onclick="Logger.loadLogs()"><i class="ti ti-refresh"></i> 刷新</button>
            </div>
            <button onclick="document.getElementById('admin-log-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- 操作栏 -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <!-- 正常模式按钮 -->
            <div style="display:flex; gap:10px;" id="log-normal-actions">
                <button class="btn btn-sm btn-danger" onclick="Logger.batchSoftDelete()">
                    <i class="ti ti-trash"></i> 批量删除
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="log-check-all" onchange="Logger.toggleSelectAll(this)" style="margin-right:5px;"> 全选
                </div>
            </div>
            
            <!-- 历史模式按钮 -->
            <div style="display:none; gap:10px;" id="log-history-actions">
                <button class="btn btn-sm btn-danger" style="background:#b91c1c;" onclick="Logger.batchHardDelete()">
                    <i class="ti ti-trash-x"></i> 彻底粉碎选中
                </button>
                <button class="btn btn-sm btn-green" onclick="Logger.batchRestore()">
                    <i class="ti ti-rotate"></i> 还原选中
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="log-history-check-all" onchange="Logger.toggleSelectAll(this)" style="margin-right:5px;"> 全选
                </div>
            </div>

            <!-- 视图切换 -->
            <div>
                <button class="btn btn-sm btn-gray" id="btn-log-history" onclick="Logger.toggleHistoryView()">
                    <i class="ti ti-recycle"></i> 日志回收站
                </button>
            </div>
        </div>

        <!-- 列表容器 -->
        <div id="admin-log-list" style="flex:1; overflow-y:auto; background:#f9fafb; padding:0; border:1px solid #e5e7eb; border-radius:4px;">
            <!-- 表格将在这里生成 -->
        </div>
        
        <!-- 底部简单分页或统计 -->
        <div style="padding-top:10px; font-size:12px; color:#999; text-align:right;">
            显示最近 100 条记录
        </div>
    </div>
</div>

<!-- 4. 通用：账号搜索与密码管理 (多角色权限) -->
<div id="account-manager-modal" class="modal" style="display: none; z-index: 78000;">
    <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3 style="color:var(--primary); margin:0;"><i class="ti ti-user-search"></i> 账号搜索与管理</h3>
            <button onclick="document.getElementById('account-manager-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <!-- 搜索区 -->
        <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="acc-search-input" placeholder="输入姓名或账号进行查找..." 
                       style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:6px;"
                       onkeydown="if(event.key==='Enter') AccountManager.search()">
                <button class="btn btn-primary" onclick="AccountManager.search()">
                    <i class="ti ti-search"></i> 搜索
                </button>
            </div>
            <div id="acc-permission-hint" style="font-size:12px; color:#64748b; margin-top:8px;">
                <!-- JS 会在这里显示当前用户的权限范围提示 -->
            </div>
        </div>

        <!-- 列表容器 -->
        <div class="table-wrap" style="flex:1; overflow-y:auto; box-shadow:none; border:1px solid #e2e8f0;">
            <table id="acc-result-table">
                <thead>
                    <tr>
                        <th>账号/姓名</th>
                        <th>角色</th>
                        <th>班级/范围</th>
                        <th>当前密码</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">请输入关键字搜索</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 5. 数据综合管理后台 (成绩/教师/档案) -->
<div id="data-manager-modal" class="modal" style="display: none; z-index: 79000;">
    <div class="modal-content" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <!-- ✋ 🔴 [旧代码]：标题 -->
            <h3 style="color:#0f172a; margin:0;"><i class="ti ti-database-edit"></i> 教务数据综合管理</h3>
            <!-- 🟢 [新代码]：修改标题，体现云端属性 -->
            <h3 style="color:#0f172a; margin:0;"><i class="ti ti-cloud-cog"></i> 云端教务数据综合控制台</h3>
            <!-- ✋ 🟢 [修改结束] -->

            <div style="display:flex; gap:10px;">
                <button class="btn btn-sm btn-purple" onclick="DataManager.saveAndSync()">
                    <i class="ti ti-cloud-upload"></i> 保存修改并同步云端
                </button>
                <button onclick="document.getElementById('data-manager-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
        </div>

        <!-- 顶部 Tab 切换 -->
        <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px; overflow-x:auto;">
            <div class="login-tab active" id="tab-data-stu" onclick="DataManager.switchTab('student')">
                <i class="ti ti-users"></i> 学生成绩
            </div>
            
            <div class="login-tab" id="tab-data-tea" onclick="DataManager.switchTab('teacher')">
                <i class="ti ti-id"></i> 教师任课
            </div>
                        
            <div class="login-tab" id="tab-data-params" onclick="DataManager.switchTab('params')">
                <i class="ti ti-settings"></i> 年级指标参数
            </div>
            <div class="login-tab" id="tab-data-targets" onclick="DataManager.switchTab('targets')">
                <i class="ti ti-target"></i> 目标人数管理
            </div>
                      
            <div class="login-tab" id="tab-data-sql" onclick="DataManager.switchTab('sql')">
                <i class="ti ti-terminal-2"></i> SQL 极速查询
            </div>
            <div class="login-tab" id="tab-data-cloud" onclick="DataManager.switchTab('cloud')">
                <i class="ti ti-cloud"></i> 云端存档管理
            </div>
            <div class="login-tab" id="tab-data-history" onclick="DataManager.switchTab('history')">
                <i class="ti ti-history"></i> 历史数据对比
            </div>
        </div>

        <!-- 搜索工具栏 (仅在学生/教师 Tab 显示) -->
        <div id="dm-search-bar" style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px; display:flex; gap:10px;">
            <input type="text" id="dm-search-input" placeholder="输入姓名/班级/考号筛选..." 
                   style="flex:1; padding:8px; border:1px solid #cbd5e1; border-radius:4px;"
                   oninput="DataManager.renderCurrentTab()">
            <button class="btn btn-sm btn-primary" onclick="DataManager.renderCurrentTab()">搜索</button>
        </div>

        <!-- 列表容器 -->
        <div class="table-wrap" style="flex:1; overflow-y:auto; box-shadow:none; border:1px solid #e2e8f0;">
            <!-- 学生表 -->
            <table id="dm-student-table" style="font-size:12px;">
                <thead>
                    <tr><th>学校</th><th>班级</th><th>姓名</th><th>考号</th><th>总分</th><th>操作</th></tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- ==================== 教师任课管理区域 ==================== -->
            <div id="dm-teacher-area" style="display:none;">
                <!-- 顶部控制栏 -->
                <div style="background:#f8fafc; padding:12px; border-bottom:2px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; position:sticky; top:0; z-index:10; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    
                    <!-- 左侧：学校和学期选择 -->
                    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <label style="font-weight:bold; color:#334155; font-size:13px;">🏫 本校：</label>
                            <select id="dm-teacher-school-select" style="padding:6px 10px; width:160px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px; outline:none;" onchange="DataManager.updateTeacherSchoolFilter()">
                                <option value="">-- 显示全部 --</option>
                            </select>
                        </div>
                        
                        <div style="display:flex; align-items:center; gap:6px;">
                            <label style="font-weight:bold; color:#334155; font-size:13px;">📅 学期：</label>
                            <select id="dm-teacher-term-select" style="padding:6px 10px; width:200px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px; outline:none;" onchange="DataManager.switchTeacherTerm(this.value)"></select>
                        </div>
                    </div>

                    <!-- 右侧：操作按钮组 -->
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <button class="btn btn-sm btn-purple" onclick="CloudManager.loadTeachers()" title="从云端同步本学期的教师任课数据" style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                            <i class="ti ti-cloud-download"></i> 云端同步
                        </button>

                        <button class="btn btn-sm btn-orange" onclick="CloudManager.saveTeachers()" title="保存当前教师任课数据到云端" style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                            <i class="ti ti-cloud-upload"></i> 上传云端
                        </button>

                        <button class="btn btn-sm btn-green" onclick="document.getElementById('dm-teacher-file').click()" title="导入Excel格式的教师任课表" style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                            <i class="ti ti-file-import"></i> Excel导入
                        </button>
                        <input type="file" id="dm-teacher-file" accept=".xlsx,.xls" hidden onchange="DataManager.handleTeacherUpload(this)">
                        
                        <button class="btn btn-sm btn-primary" onclick="DataManager.addTeacher()" title="手动添加一条教师任课记录" style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                            <i class="ti ti-plus"></i> 手动新增
                        </button>
                        
                        <button class="btn btn-sm" onclick="downloadTemplate('teacher')" title="下载教师任课表Excel模板" style="padding:6px 12px; font-size:12px; background:white; border:1px solid #cbd5e1; color:#475569; display:flex; align-items:center; gap:4px;">
                            <i class="ti ti-download"></i> 下载模板
                        </button>
                    </div>
                </div>

                <!-- 提示信息栏 -->
                <div style="background:#eff6ff; border-left:4px solid #3b82f6; padding:10px 15px; margin:10px; font-size:12px; color:#1e40af; border-radius:4px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="ti ti-info-circle" style="font-size:16px;"></i>
                        <div>
                            <strong>使用说明：</strong>
                            <ul style="margin:5px 0 0 20px; padding:0; line-height:1.6;">
                                <li>选择学期后，可以从云端同步或导入Excel文件</li>
                                <li>Excel格式要求：<strong>班级</strong>、<strong>学科</strong>、<strong>教师姓名</strong> 三列</li>
                                <li>导入后数据自动保存到本地，点击「上传云端」可同步到云端数据库</li>
                                <li>教师任课数据会在「班级教学管理」等模块中自动引用</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 教师任课表格 -->
                <div style="margin:10px;">
                    <table id="dm-teacher-table" style="font-size:12px; width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background:#f8fafc; border-bottom:2px solid #e2e8f0;">
                                <th style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:20%;">学校</th>
                                <th style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:15%;">班级</th>
                                <th style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:15%;">学科</th>
                                <th style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:20%;">教师姓名</th>
                                <th style="padding:10px; text-align:center; font-weight:bold; color:#475569; width:30%;">操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 档案管理区域 -->
            <!-- D. 年级指标参数设置区域 (保持不变，仅为了定位) -->
            <div id="dm-params-area" style="display:none; padding:20px;">
                <div style="background:#f0f9ff; border:1px solid #bae6fd; padding:20px; border-radius:8px;">
                    <h4 style="color:#0369a1; margin-bottom:15px; border-bottom:1px dashed #bae6fd; padding-bottom:10px;">
                        <i class="ti ti-settings"></i> 年级划线参数配置
                    </h4>
                    <div id="dm-params-tip" style="display:none; background:#fff7ed; border:1px dashed #fdba74; color:#9a3412; padding:8px 10px; border-radius:6px; font-size:12px; margin-bottom:12px;">
                        提示：当前非 9 年级期中/期末，参数仅用于预设，不参与计算。
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">指标一 (优生线) 划线名次：</label>
                            <input type="number" id="dm_ind1_input" class="mob-input" style="background:white;" placeholder="例如: 500">
                            <p style="font-size:12px; color:#64748b; margin-top:5px;">全镇总分排名第 N 名的分数将作为优生线。</p>
                        </div>
                        <div>
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">指标二 (普高线) 划线名次：</label>
                            <input type="number" id="dm_ind2_input" class="mob-input" style="background:white;" placeholder="例如: 1200">
                            <p style="font-size:12px; color:#64748b; margin-top:5px;">全镇总分排名第 N 名的分数将作为及格/普高线。</p>
                        </div>
                    </div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn btn-primary" onclick="DataManager.saveParamsLocally()">
                            <i class="ti ti-device-floppy"></i> 暂存参数 (需点击右上角保存同步)
                        </button>
                    </div>
                </div>
            </div>

            <!-- 👇👇👇 ✋ 🔴 [修改开始]：修改目标管理区域，改为文件导入模式 🔴 ✋ 👇👇👇 -->
            <!-- E. 目标人数管理区域 -->
            <div id="dm-targets-area" style="display:none; padding:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; color:#166534;"><i class="ti ti-target"></i> 各校目标人数管理</h4>
                    
                    <!-- 🟢 [新代码]：改为导入按钮 + 隐藏的文件输入框 -->
                    <div>
                        <button class="btn btn-sm btn-green" onclick="document.getElementById('dm-target-file').click()">
                            <i class="ti ti-file-import"></i> 导入目标人数文件 (.xlsx)
                        </button>
                        <input type="file" id="dm-target-file" accept=".xlsx,.xls" hidden onchange="DataManager.handleTargetUpload(this)">
                        
                        <a href="javascript:void(0)" style="font-size:12px; margin-left:10px; color:#666; text-decoration:underline;" onclick="alert('Excel格式要求：\n第一列：学校名称\n第二列：指标一目标人数\n第三列：指标二目标人数')">格式说明</a>
                    </div>
                    <!-- 👆 🟢 [修改结束] -->
                </div>
                
                <div class="info-bar" style="margin-bottom:10px;">
                    💡 提示：导入后请点击右上角【保存修改并同步云端】按钮，以防止刷新后丢失。
                </div>

                <div class="table-wrap" style="box-shadow:none; border:1px solid #e2e8f0; max-height: 60vh; overflow-y: auto;">
                    <table class="comparison-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>学校名称</th>
                                <th style="background:#e0f2fe;">指标一目标 (人)</th>
                                <th style="background:#fff7ed;">指标二目标 (人)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="dm-targets-tbody">
                            <!-- JS 动态渲染 -->
                        </tbody>
                    </table>
                </div>
            </div>
        
        <div id="dm-sql-area" style="display:none; padding:15px; height:100%; flex-direction:column;">
            <!-- 提示与常用语句 -->
            <div style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('base')">📋 查前10名</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('count')">📊 各校人数</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('avg')">📈 各班均分</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('failed')">📉 不及格名单</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('teacher')">👩‍🏫 查任课学生</button>
                <div style="flex:1; text-align:right; font-size:12px; color:#666; align-self:center;">
                    表名: <b>students</b> (成绩), <b>teachers</b> (任课)
                </div>
            </div>

            <!-- 历史与收藏 -->
            <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <select id="dm-sql-history-select" style="min-width:220px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;" onchange="DataManager.applySQLHistory(this.value)">
                    <option value="">🕘 最近/收藏</option>
                </select>
                <input id="dm-sql-history-name" type="text" placeholder="收藏名称(可选)" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px; width:180px;">
                <button class="btn btn-sm btn-green" onclick="DataManager.saveNamedSQL()">⭐ 保存收藏</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.clearSQLHistory()">🧹 清空历史</button>
            </div>

            <!-- Talk to Data 自然语言查数 -->
            <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; padding:8px;">
                <input id="dm-nlq-input" type="text" placeholder="例如：找出701班物理不及格但数学前10名的学生" style="flex:1; min-width:280px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;">
                <button class="btn btn-sm btn-purple" onclick="talkToData()">💬 自然语言查数</button>
                <span id="dm-nlq-status" style="font-size:12px; color:#64748b;"></span>
            </div>

            <!-- SQL 输入框 -->
            <textarea id="dm-sql-input" style="width:100%; height:120px; background:#1e293b; color:#a5b4fc; font-family:'Consolas', monospace; padding:10px; border-radius:6px; font-size:14px; border:1px solid #475569; resize:none;" placeholder="在此输入 SQL 语句..."></textarea>
            
            <!-- 操作栏 -->
            <div style="margin:10px 0; display:flex; justify-content:space-between;">
                <div id="sql-status-msg" style="font-size:12px; color:#ef4444; font-weight:bold;"></div>
                <div>
                    <button class="btn btn-sm btn-green" onclick="DataManager.exportSQLResult()">📥 导出结果 Excel</button>
                    <button class="btn btn-primary" onclick="DataManager.runSQL()"><i class="ti ti-player-play"></i> 执行查询 (Run)</button>
                </div>
            </div>

            <!-- 结果表格容器 -->
            <div class="table-wrap" style="flex:1; overflow:auto; border:1px solid #e2e8f0; border-radius:4px; box-shadow:none;">
                <table id="dm-sql-table" style="font-size:12px; width:100%;">
                    <thead><tr><th>查询结果将显示在这里</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="dm-cloud-area" style="display:none; padding:15px; flex-direction:column; height:100%;">
            <div class="info-bar">
                <i class="ti ti-cloud"></i> <strong>我的云端数据管理：</strong> 
                此处列出您上传到云端的所有备份（包括自动保存和手动备份）。您可以删除旧的存档以释放空间。
                <br><span style="color:red; font-size:11px;">* 注意：删除操作不可恢复，请谨慎操作。</span>
            </div>
            <div id="dm-cloud-summary" style="background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; padding:10px; font-size:12px; color:#475569; margin:10px 0;">
                📌 云端摘要将在此显示
            </div>
            <div style="display:flex; gap:12px; align-items:center; font-size:12px; color:#475569; margin-bottom:8px;">
                <label><input type="checkbox" id="cloud-filter-current" checked onchange="DataManager.renderCloudBackups()"> 仅当前项目</label>
                <label><input type="checkbox" id="cloud-filter-snapshots" checked onchange="DataManager.renderCloudBackups()"> 显示快照</label>
            </div>
            <div class="table-wrap" style="flex:1; overflow-y:auto;">
                <table class="comparison-table" id="dm-cloud-table">
                    <thead>
                        <tr>
                            <th>存档 Key (项目名)</th>
                            <th>上传时间</th>
                            <th>数据大小</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="dm-history-area" style="display:none; padding:15px; flex-direction:column; height:100%;">
            <div style="background:#f0fdf4; border:1px solid #86efac; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px 0; color:#166534;"><i class="ti ti-file-import"></i> 上传历史考试数据 (用于进退步分析)</h4>
                <div style="font-size:12px; color:#15803d; line-height:1.6; margin-bottom:10px;">
                    <strong>📂 智能解析规则：</strong><br>
                    1. <strong>多校识别：</strong> 系统将读取 Excel 的 <span style="background:white; padding:0 4px; border:1px dashed #ccc;">Sheet名称</span> 作为学校名称。<br>
                    2. <strong>匹配键值：</strong> 对比分析将严格基于 <span style="background:white; padding:0 4px; border:1px dashed #ccc;">[班级] + [姓名]</span> 进行锚定。<br>
                    3. <strong>匿名处理：</strong> 若表格中缺少姓名列，系统将自动标记为“无名氏_序号”，仅作校内人数统计，不参与个人进退步。<br>
                    4. <strong>单校模式：</strong> 若仅检测到一个学校，系统将自动隐藏“全镇排名”列，转为校内深度对比。
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="document.getElementById('dm-history-file').click()">
                        <i class="ti ti-upload"></i> 点击上传历史 Excel
                    </button>
                    <input type="file" id="dm-history-file" accept=".xlsx,.xls" hidden onchange="DataManager.handleHistoryUpload(this)">
                    <span id="dm-history-status" style="align-self:center; font-size:12px; color:#666;">暂未上传</span>
                </div>
            </div>

            <div class="sub-header">📊 历史对比数据预览</div>
            <div class="table-wrap" style="flex:1; overflow-y:auto;">
                <table id="dm-history-preview-table" style="font-size:12px;">
                    <thead>
                        <tr>
                            <th>学校 (Sheet名)</th>
                            <th>班级</th>
                            <th>姓名</th>
                            <th>上次总分</th>
                            <th>上次校排</th>
                            <th>上次镇排</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">请上传文件预览数据</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
     
        <!-- 分页控件 (仅在学生/教师 Tab 显示) -->
        <div id="dm-pagination" style="padding-top:10px; text-align:right; font-size:12px; color:#666; display:flex; justify-content:flex-end; gap:10px; align-items:center;">
            <button class="btn btn-sm btn-gray" onclick="DataManager.changePage(-1)">上一页</button>
            <span id="dm-page-info">1 / 1</span>
            <button class="btn btn-sm btn-gray" onclick="DataManager.changePage(1)">下一页</button>
        </div>
    </div>
</div>

<script defer src="js/app-utils.js"></script>

</body>
</html>
