<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
        // âœ… å…œåº•åˆå§‹åŒ– Supabaseï¼Œé˜²æ­¢ sbClient æœªå®šä¹‰
        var sbClient = window.sbClient || null;
        window.SUPABASE_URL = localStorage.getItem('SUPABASE_URL') || "https://okwcciujnfvobbwaydiv.supabase.co";
        window.SUPABASE_KEY = localStorage.getItem('SUPABASE_KEY') || "sb_publishable_NQqut_NdTW2z1_R27rJ8jA_S3fTh2r4";
        window.initSupabase = function() {
            if (window.supabase && !sbClient) {
                sbClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
                window.sbClient = sbClient;
                console.log("âœ… Supabase è¿æ¥åˆå§‹åŒ–æˆåŠŸ");
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin="anonymous" onload="window.initSupabase()"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/lz-string@1.5.0/libs/lz-string.min.js'"></script>
    <!-- ğŸŸ¢ [ä¿®å¤] æ·»åŠ  XLSX åº“æ”¯æŒ Excel å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>
    <script>
        // âœ… ç»Ÿä¸€äº‘ç«¯åŒæ­¥é€»è¾‘ (é‡æ„ç‰ˆ)
        const CloudManager = {
            check: () => {
                if (!sbClient) {
                    if (window.UI) UI.toast("äº‘ç«¯æœªè¿æ¥ (Supabase Disconnected)", "error");
                    return false;
                }
                return true;
            },

            getKey: () => {
                const meta = typeof getExamMetaFromUI === 'function' ? getExamMetaFromUI() : {};
                if (!meta.cohortId || !meta.year || !meta.term || !meta.type) return null;
                const parts = [
                    meta.cohortId + 'çº§',
                    meta.grade ? meta.grade + 'å¹´çº§' : 'æœªçŸ¥å¹´çº§',
                    meta.year,
                    meta.term,
                    meta.type,
                    meta.name || 'æ ‡å‡†è€ƒè¯•'
                ];
                return parts.join('_').replace(/[\s\/\\\?]/g, '');
            },

            save: async function() {
                if (!this.check()) return;
                const role = sessionStorage.getItem('CURRENT_ROLE');
                if (role !== 'admin' && role !== 'director' && role !== 'grade_director') {
                    if (window.UI) UI.toast("â›” æƒé™ä¸è¶³", "warning");
                    return;
                }
                const key = this.getKey();
                if (!key) return alert("è¯·å…ˆå®Œå–„è€ƒè¯•ä¿¡æ¯");
                if (window.UI) UI.loading(true, `â˜ï¸ æ­£åœ¨åŒæ­¥...`);
                try {
                    if (!window.SYS_VARS) window.SYS_VARS = { indicator: { ind1: '', ind2: '' }, targets: {} };
                    const i1 = document.getElementById('dm_ind1_input');
                    const i2 = document.getElementById('dm_ind2_input');
                    if (i1) window.SYS_VARS.indicator.ind1 = i1.value;
                    if (i2) window.SYS_VARS.indicator.ind2 = i2.value;
                    window.SYS_VARS.targets = window.TARGETS || {};

                    const payload = typeof getCurrentSnapshotPayload === 'function' ? getCurrentSnapshotPayload() : {};
                    const json = JSON.stringify(payload);
                    const compressed = "LZ|" + LZString.compressToUTF16(json);

                    const { error } = await sbClient.from('system_data').upsert({
                        key,
                        content: compressed,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'key' });
                    if (error) throw error;

                    localStorage.setItem('CURRENT_PROJECT_KEY', key);
                    if (window.idbKeyval) await idbKeyval.set(`cache_${key}`, payload);
                    if (window.UI) UI.toast("âœ… äº‘ç«¯åŒæ­¥æˆåŠŸ", "success");
                } catch (e) {
                    console.error("CloudManager Save Error:", e);
                    alert("åŒæ­¥å¤±è´¥: " + e.message);
                } finally {
                    if (window.UI) UI.loading(false);
                }
            },

            load: async function() {
                if (!this.check()) return;
                const key = this.getKey() || localStorage.getItem('CURRENT_PROJECT_KEY');
                if (!key) return;
                if (window.UI) UI.toast("â³ æ­£åœ¨æ£€æŸ¥äº‘ç«¯æ•°æ®...", "info");
                try {
                    const { data, error } = await sbClient
                        .from('system_data')
                        .select('content')
                        .eq('key', key)
                        .maybeSingle();
                    if (error) throw error;
                    if (!data) return;

                    let content = data.content;
                    if (typeof content === 'string' && content.startsWith("LZ|")) {
                        content = LZString.decompressFromUTF16(content.substring(3));
                    }
                    const payload = typeof content === 'string' ? JSON.parse(content) : content;
                    if (typeof applySnapshotPayload === 'function') applySnapshotPayload(payload);
                    if (window.UI) UI.toast("âœ… æ•°æ®å·²åŒæ­¥åˆ°æœ¬åœ°", "success");
                } catch (e) {
                    console.error("CloudManager Load Error:", e);
                    if (window.UI) UI.toast("åŠ è½½å¤±è´¥", "error");
                }
            },

            // æ•™å¸ˆä»»è¯¾ï¼šå­¦æœŸçº§åŒæ­¥
            getTeacherKey: () => {
                const termSel = document.getElementById('dm-teacher-term-select');
                const termId = termSel?.value || localStorage.getItem('CURRENT_TERM_ID') || '';
                const cohortId = window.CURRENT_COHORT_ID || window.CURRENT_COHORT_META?.id || localStorage.getItem('CURRENT_COHORT_ID') || '';
                if (!cohortId || !termId) return null;
                return `TEACHERS_${cohortId}çº§_${termId}`;
            },

            saveTeachers: async function() {
                if (!this.check()) return;
                const key = this.getTeacherKey();
                if (!key) return alert("è¯·å…ˆåœ¨ã€æ•™å¸ˆä»»è¯¾ã€‘é€‰æ‹©å­¦æœŸ");
                if (!window.TEACHER_MAP || Object.keys(window.TEACHER_MAP).length === 0) return alert("å½“å‰æ— ä»»è¯¾æ•°æ®");
                try {
                    const payload = JSON.stringify(window.TEACHER_MAP);
                    let error = null;
                    const primary = await sbClient.from('system_data').upsert({
                        key,
                        content: payload,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'key' });
                    error = primary?.error || null;
                    if (error) {
                        const fallback = await sbClient.from('system_data').upsert({ key, content: payload }, { onConflict: 'key' });
                        error = fallback?.error || null;
                    }
                    if (error) throw error;
                    if (window.UI) UI.toast(`âœ… ä»»è¯¾è¡¨å·²åŒæ­¥ï¼ˆ${key}ï¼‰`, "success");
                } catch (e) {
                    alert("ä»»è¯¾åŒæ­¥å¤±è´¥: " + e.message + "\nKey: " + this.getTeacherKey());
                }
            },

            loadTeachers: async function() {
                if (!this.check()) return;
                const key = this.getTeacherKey();
                if (!key) {
                    console.warn('âš ï¸ æ— æ³•ç”Ÿæˆæ•™å¸ˆKeyï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©å­¦æœŸ');
                    return;
                }
                try {
                    if (window.UI) UI.loading(true, "â˜ï¸ æ­£åœ¨ä»äº‘ç«¯æ‹‰å–å­¦æœŸä»»è¯¾è¡¨...");
                    const { data, error } = await sbClient.from('system_data').select('content').eq('key', key).maybeSingle();
                    if (error) throw error;
                    if (!data) {
                        if (window.UI) UI.loading(false);
                        console.warn(`â˜ï¸ äº‘ç«¯æœªæ‰¾åˆ°æœ¬å­¦æœŸçš„ä»»è¯¾æ¡£æ¡ˆ: ${key}`);
                        if (window.UI) UI.toast(`â˜ï¸ äº‘ç«¯æš‚æ— æœ¬å­¦æœŸä»»è¯¾æ•°æ®`, "info");
                        return;
                    }
                    let raw = data.content;
                    if (typeof raw === 'string' && raw.startsWith('LZ|')) {
                        raw = LZString.decompressFromUTF16(raw.substring(3));
                    }
                    const map = typeof raw === 'string' ? JSON.parse(raw) : raw;
                    window.TEACHER_MAP = map;
                    
                    // ğŸŸ¢ [ä¿®å¤]ï¼šåŠ è½½åè‡ªåŠ¨åŒæ­¥åˆ°æœ¬åœ°å†å²è®°å½•
                    if (window.DataManager && DataManager.syncTeacherHistory) DataManager.syncTeacherHistory();
                    if (window.DataManager && DataManager.renderTeachers) DataManager.renderTeachers();
                    
                    if (window.UI) UI.loading(false);
                    if (window.UI) UI.toast(`âœ… å·²ä»äº‘ç«¯åŠ è½½æœ¬å­¦æœŸä»»è¯¾è¡¨ï¼ˆ${Object.keys(map).length}æ¡ï¼‰`, "success");
                    console.log(`âœ… äº‘ç«¯ä»»è¯¾è¡¨åŠ è½½æˆåŠŸ: ${key}, å…± ${Object.keys(map).length} æ¡è®°å½•`);
                } catch (e) {
                    if (window.UI) UI.loading(false);
                    console.error('äº‘ç«¯åŠ è½½å¤±è´¥:', e);
                    if (window.UI) UI.toast('â˜ï¸ äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥', 'error');
                }
            }
        };

        window.CloudManager = CloudManager;
        window.saveCloudData = () => CloudManager.save();
        window.loadCloudData = () => CloudManager.load();
        window.getUniqueExamKey = () => CloudManager.getKey();
        window.saveCloudSnapshot = () => {};
        
        // ğŸŸ¢ [ä¿®å¤] é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å…³é”®åº“
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (typeof XLSX === 'undefined') {
                    console.error('âŒ XLSXåº“åŠ è½½å¤±è´¥ï¼ŒExcelå¯¼å…¥å¯¼å‡ºåŠŸèƒ½å°†ä¸å¯ç”¨');
                } else {
                    console.log('âœ… XLSXåº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', XLSX.version);
                }
            }, 1000);
        });
    </script>

    <!-- ================== æ ·å¼å®šä¹‰ (CSS) ================== -->
    <style>
       :root { 
            /* ä¸»è‰²è°ƒç³»ç»Ÿ */
            --primary: #4f46e5; 
            --primary-dark: #3730a3; 
            --primary-light: #eef2ff; 
            
            /* èƒŒæ™¯ç³»ç»Ÿ */
            --bg-body: #f3f4f6;
            --bg-card: rgba(255, 255, 255, 0.95);
            --border: #e2e8f0;
            
            /* åŠŸèƒ½è‰²æ¿ */
            --color-data: #1e293b;    
            --color-macro: #b45309;   
            --color-internal: #dc2626;
            --color-diag: #059669;    
            --color-student: #2563eb; 
            --color-tools: #7c3aed;   
            --secondary: #475569; 
            --success: #16a34a;  
            --danger: #dc2626;
            --warning: #f59e0b;

            /* é˜´å½±ä¸åœ†è§’ */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); 
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            
            /* åŠ¨ç”»æ—¶é•¿ */
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
        }
        
        /* å¢åŠ ç‚¹é˜µèƒŒæ™¯ï¼Œæå‡ç§‘æŠ€æ„Ÿ */
        body { 
            background-color: var(--bg-body); 
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            color: #1e293b; 
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding-bottom: 60px; 
            font-size: 14px; 
            scroll-behavior: smooth;
            line-height: 1.5;
        }
        
       /* æ·±è‰²æ¨¡å¼ä¼˜åŒ– */
       .dark-mode { 
            --bg-body: #0f172a; 
            --bg-card: rgba(30, 41, 59, 0.85);
            --border: rgba(255, 255, 255, 0.1); 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --color-data: #94a3b8;
            color: #e2e8f0;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
        }

        .dark-mode .card-box { border: 1px solid var(--border); }
        .dark-mode table thead th { 
            background: rgba(30, 41, 59, 0.9); 
            color: #94a3b8; 
            border-bottom: 1px solid #334155;
        }
        .dark-mode tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        .dark-mode tr:hover { background: rgba(255,255,255,0.05); }
        .dark-mode input, .dark-mode select, .dark-mode textarea { 
            background: #1e293b; 
            border-color: #334155; 
            color: white; 
        }
        .dark-mode .nav-link {
            background: rgba(255,255,255,0.05);
            color: #cbd5e1;
        }
        .dark-mode .nav-link:hover { background: rgba(255,255,255,0.1); }
        .dark-mode .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .spotlight-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); z-index: 30000;
            display: none; justify-content: center; padding-top: 100px; backdrop-filter: blur(4px);
        }
        .spotlight-box {
            width: 100%; max-width: 600px; background: var(--bg-card);
            border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            overflow: hidden; border: 1px solid var(--primary);
        }
        .spotlight-input-wrap { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); }
        .spotlight-input { border: none !important; flex: 1; font-size: 18px; outline: none; background: transparent; }
        .spotlight-results { max-height: 400px; overflow-y: auto; }
        .spotlight-item { 
            padding: 12px 20px; display: flex; justify-content: space-between; 
            cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border);
        }
        .spotlight-item:hover { background: var(--primary-light); color: var(--primary); }
        .spotlight-hint { padding: 10px; font-size: 12px; color: #94a3b8; text-align: center; }
        .module-help-btn {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 12px; color: #64748b; background: white;
            border: 1px solid #cbd5e1; padding: 2px 8px;
            border-radius: 12px; cursor: pointer; transition: all 0.2s;
            font-weight: normal; margin-left: 10px; vertical-align: middle;
            line-height: 1.5;
        }
        .module-help-btn:hover {
            color: var(--primary); border-color: var(--primary);
            background: var(--primary-light); transform: translateY(-1px);
        }
        .help-modal-content {
            text-align: left; font-size: 14px; line-height: 1.6; color: #333;
        }
        .help-modal-content h4 {
            color: var(--primary); margin: 15px 0 8px 0; border-left: 4px solid var(--primary); padding-left: 8px; font-size: 15px; font-weight: bold;
        }
        .help-modal-content ul { padding-left: 20px; margin: 0; }
        .help-modal-content li { margin-bottom: 5px; }
        .help-modal-content .formula-box {
            background: #f8fafc; border: 1px dashed #cbd5e1; padding: 10px; 
            border-radius: 6px; font-family: 'JetBrains Mono', monospace; 
            color: #b45309; margin: 5px 0; font-size: 13px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: #1e293b; line-height: 1.5; padding-bottom: 60px; font-size: 14px; scroll-behavior: smooth; }
        a { text-decoration: none; color: inherit; }
        .container { max-width: 1600px; margin: 0 auto; padding: 10px; }
        .hidden { display: none !important; }
        
        header { 
            /* ç§»é™¤ç¡¬ç¼–ç çš„çº¢è‰²ç»“å°¾ï¼Œæ”¹ç”¨ --primary-dark å˜é‡å®ç°åŒè‰²ç³»æ¸å˜ */
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, #3730a3) 100%); 
            color: white; 
            padding: 20px; 
            border-radius: var(--radius); 
            position: relative; /* ç¡®ä¿å®šä½å‡†ç¡® */
            transition: background 0.5s ease; /* å¢åŠ é¢œè‰²åˆ‡æ¢æ—¶çš„è¿‡æ¸¡åŠ¨ç”» */
        }

        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ æ–°å¢ä»£ç ï¼šæ’å…¥åœ¨è¿™é‡Œ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
        .module-desc-bar {
            background: white;
            border-left: 5px solid var(--primary);
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            line-height: 1.6;
        }
        .module-desc-bar p { margin: 4px 0 0 0; }
        .module-desc-bar .desc-toggle {
            margin-left: auto;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #475569;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            cursor: pointer;
        }
        .module-desc-bar.desc-collapsed p { display: none; }
        .module-desc-bar.desc-collapsed { padding-bottom: 10px; }

        /* æ°´å°å±‚ */
        #watermark-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 99999;
            opacity: 0.08;
            background-repeat: repeat;
            background-size: 320px 220px;
            transform: translateZ(0);
        }

        @media print {
            #watermark-layer {
                position: fixed;
                opacity: 0.08;
                display: block !important;
            }
        }
        .module-desc-bar h3 { margin-bottom: 5px; color: #333; display: flex; align-items: center; gap: 8px; font-size: 16px; }
        .module-desc-bar p { font-size: 13px; color: #64748b; margin: 0; }
        h1 { font-size: 22px; font-weight: 700; margin-bottom: 5px; letter-spacing: -0.5px; line-height: 1.3; }
        .badge { background: #f59e0b; color: white; padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 600; vertical-align: middle; margin-left: 5px; }

        .nav-wrapper { position: sticky; top: 0; z-index: 1000; margin-bottom: 15px; box-shadow: var(--shadow); border-radius: 0 0 var(--radius) var(--radius); overflow: hidden; background: white; }
        .nav-categories { display: flex; background: #1e293b; overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .nav-categories::-webkit-scrollbar { display: none; }
        .nav-cat-item { flex: 0 0 auto; padding: 12px 15px; color: #94a3b8; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; border-bottom: 3px solid transparent; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; }
        .nav-cat-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-cat-item.active { color: white; background: #0f172a; border-bottom-color: var(--primary); }

        .nav-sub-items { display: flex; gap: 10px; padding: 10px 15px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); overflow-x: auto; border-bottom: 1px solid var(--border); scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .nav-sub-items::-webkit-scrollbar { display: none; }
        .nav-link { flex: 0 0 auto; padding: 6px 12px; border-radius: 6px; white-space: nowrap; cursor: pointer; font-weight: 500; color: var(--secondary); font-size: 13px; transition: all 0.2s ease; border: 1px solid transparent; background: #f8fafc; display: flex; align-items: center; gap: 5px; }
        .nav-link:hover { background: var(--primary-light); color: var(--primary); border-color: #dbeafe; }
        .nav-link.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); border-color: var(--primary); }

        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å‡å°‘åŠ¨ç”»åå¥½ï¼šæå‡å¯è®¿é—®æ€§ä¸æ€§èƒ½ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        .card-box { 
            background: var(--bg-card); 
            backdrop-filter: blur(8px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            border-radius: var(--radius); 
            padding: 20px; /* å¢åŠ å†…è¾¹è· */
            margin-bottom: 20px; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.5); 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-box:hover {
            transform: translateY(-2px); /* æ‚¬æµ®å¾®åŠ¨ */
            box-shadow: var(--shadow-lg);
        }
        
        .layout-grid { display: grid; grid-template-columns: 220px 1fr; gap: 20px; align-items: start; }
        .side-nav { position: sticky; top: 120px; background: white; padding: 10px; border-radius: 8px; box-shadow: var(--shadow); border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; }
        .side-nav-title { font-size: 12px; text-transform: uppercase; color: #94a3b8; font-weight: 700; padding: 5px 10px; margin-bottom: 5px; }
        .side-nav-link { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 4px; color: #64748b; border-radius: 6px; font-size: 13px; font-weight: 600; transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; }
        .side-nav-link:hover { background: var(--bg-body); color: var(--primary); }
        .side-nav-link.active { background: var(--primary-light); color: var(--primary); border-left-color: var(--primary); }
        .nav-caret { transition: transform 0.2s ease; font-size: 12px; opacity: 0.6; }
        .side-nav-link.expanded .nav-caret { transform: rotate(90deg); }
        .side-nav-sub-container { display: none; padding-left: 10px; margin-bottom: 5px; border-left: 1px solid #e2e8f0; margin-left: 15px; }
        .side-nav-sub-container.show { display: block; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .side-nav-sub-link { display: block; padding: 6px 10px; color: #64748b; font-size: 12px; border-radius: 4px; text-decoration: none; transition: all 0.2s; position: relative; cursor: pointer; }
        .side-nav-sub-link:hover { color: var(--primary); background: white; }
        .side-nav-sub-link::before { content: 'â€¢'; margin-right: 5px; color: #cbd5e1; }
        .side-nav-sub-link:hover::before { color: var(--primary); }
        .content-area { min-width: 0; }
        .anchor-target { scroll-margin-top: 160px; }

        .sec-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .sec-head h2 { color: #0f172a; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .sec-head h2::before { content: ''; display: inline-block; width: 6px; height: 20px; background: var(--primary); border-radius: 3px; }
        .control-panel { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
        .bg-gray-50 { background-color: #f9fafb; padding: 15px; border-radius: 10px; }
        
       .table-wrap { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            background: white; 
            margin-top: 15px; 
            width: 100%; 
            
            /* å…³é”®ä¿®å¤ï¼šç»å¯¹ç¦æ­¢é™åˆ¶é«˜åº¦ï¼Œæœ‰å¤šå°‘æ•°æ®æ˜¾ç¤ºå¤šå°‘è¡Œ */
            max-height: none !important; 
            overflow-y: visible !important;
            display: block !important;
        }
        /* ä¼˜åŒ–è¡¨æ ¼å­—ä½“ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 700px; font-size: 13px; }
        
        /* æ•°å­—åˆ—ä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œçœ‹èµ·æ¥æ›´ä¸“ä¸š */
        td:nth-child(n+3) { 
            font-family: 'JetBrains Mono', 'Menlo', 'Courier New', monospace;
            font-variant-numeric: tabular-nums; 
        }

        /* è¡¨å¤´æ ·å¼ä¼˜åŒ– */
        thead th { 
            position: sticky; top: 0; z-index: 10; 
            background: #f1f5f9; 
            color: #334155; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-weight: 700; text-transform: uppercase; font-size: 12px; 
            padding: 12px 8px; /* å¢åŠ é«˜åº¦ */
            border-bottom: 2px solid #e2e8f0;
        }

        /* é¦–åˆ—å†»ç»“ (å­¦æ ¡å/å§“åå›ºå®š) */
        table th:first-child, table td:first-child {
            position: sticky; left: 0; 
            z-index: 11; /* æ¯”æ™®é€šè¡¨å¤´é«˜ */
            background: inherit; /* è·Ÿéšè¡Œçš„èƒŒæ™¯è‰² */
            border-right: 2px solid #e2e8f0;
        }
        /* ä¿®å¤é¦–åˆ—å†»ç»“æ—¶çš„èƒŒæ™¯è‰²ç©¿é€é—®é¢˜ */
        table td:first-child { background-color: inherit; }
        thead th:first-child { 
            background-color: #f1f5f9; 
            z-index: 20; /* å¿…é¡»é«˜äº z-index: 10 (è¡¨å¤´) å’Œ z-index: 11 (é¦–åˆ—) */
        }

        /* æ•°æ®æ¡ (Data Bars) èƒŒæ™¯æ ·å¼ */
        .data-bar-bg { position: relative; z-index: 1; }
        .data-bar-bg::before {
            content: ''; position: absolute;
            top: 15%; bottom: 15%; left: 4px;
            background: rgba(79, 70, 229, 0.1); /* æµ…ç´«è‰²æ¡ */
            z-index: -1; border-radius: 4px;
            width: var(--percent, 0%); /* JSæ§åˆ¶å®½åº¦ */
            transition: width 0.5s ease;
        }
        th, td { padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--border); white-space: nowrap; }
        /* [æ–°å¢] æ•™å¸ˆå¯¹æ¯”è¡¨æ ·å¼å¢å¼º */
        .text-gray { color: #94a3b8; }
        
        /* è®©è¡¨å¤´å‚ç›´å±…ä¸­ */
        .comparison-table th { vertical-align: middle; }
        
        /* å¢åŠ è¡¨å¤´é«˜åº¦ä»¥å®¹çº³ä¸¤è¡Œæ–‡å­— */
        .comparison-table thead th { height: 45px; line-height: 1.2; }
        
        /* è´¡çŒ®å€¼æ­£è´Ÿè‰²å½© */
        .text-green { color: #16a34a; }
        .text-red { color: #dc2626; }
        th:not(:last-child), td:not(:last-child) { border-right: 1px solid #f1f5f9; }
        tr:nth-child(even) { background: #fafafa; }
        tr:hover { background: var(--primary-light); transition: background 0.1s; }
        .rank-cell { font-weight: 800; } .r-1 { color: #dc2626; font-size: 1.1em; } .r-2 { color: #ea580c; } .r-3 { color: #d97706; }
        .bg-highlight { background-color: #fef9c3 !important; color: #854d0e; font-weight: bold; border-left: 3px solid #facc15; }
        .sub-header { background: linear-gradient(to right, #e0f2fe, transparent); color: #0369a1; padding: 8px 12px; border-radius: 6px; margin-top: 25px; margin-bottom: 10px; font-weight: 700; font-size: 15px; border-left: 4px solid #0284c7; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 5px; background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); white-space: nowrap; }
        .btn:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-green { background: var(--success); } .btn-green:hover { background: #15803d; }
        .btn-orange { background: #f59e0b; } .btn-orange:hover { background: #d97706; }
        .btn-purple { background: #7c3aed; } .btn-purple:hover { background: #6d28d9; }
        .btn-gray { background: #64748b; } .btn-gray:hover { background: #475569; }
        .btn-danger { background: #dc2626; } .btn-danger:hover { background: #b91c1c; }

        input[type="text"], input[type="number"], select { padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; transition: border 0.2s; background: white; max-width: 100%; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(0,0,0,0.05); color: #94a3b8;
            font-size: 12px; cursor: pointer; margin-left: 8px; vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .help-icon:hover {
            background: var(--primary); color: white; transform: scale(1.1); border-color: var(--primary);
        }
        .swal2-popup { font-size: 14px !important; } /* å¾®è°ƒå¼¹çª—å­—ä½“ */
        /* âœ‹ å¼•å¯¼æ­¥éª¤ä¸­çš„å›¾ç‰‡æ ·å¼ */
        .tutorial-img {
            max-width: 100%; border: 1px dashed #ccc; border-radius: 6px; margin: 10px 0;
        }
        .upload-box { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; cursor: pointer; border-radius: 12px; transition: 0.3s; background: #f8fafc; }
        .upload-box:hover { border-color: var(--primary); background: #eff6ff; }
        .upload-icon { font-size: 40px; color: #94a3b8; margin-bottom: 10px; }
        .info-bar { background: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .info-bar::before { content: 'â„¹ï¸'; }

        /* è¡¨æ ¼çƒ­åŠ›å›¾ä¸åˆ—ç­›é€‰æ ·å¼ */
        .heatmap-mode td { transition: background-color 0.3s; color: #000; }
        /* åœ¨æ·±è‰²æ¨¡å¼ä¸‹ï¼Œçƒ­åŠ›å›¾èƒŒæ™¯è¾ƒæ·±æ—¶ï¼Œæ–‡å­—éœ€è¦åç™½ï¼Œè¿™é‡Œæš‚å¼ºåˆ¶æ·±è‰²æ–‡å­—é…åˆæµ…è‰²çƒ­åŠ›èƒŒæ™¯ï¼Œæˆ–è€…å¢åŠ ç‰¹å¼‚æ€§ */
        .dark-mode .heatmap-mode td { color: #1e293b; font-weight: bold; } 
        .plank-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin: 2px; }
        .plank-drag { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; } /* æ‹–åè…¿/çŸ­æ¿ */
        .plank-lift { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; } /* æåˆ†/ä¼˜åŠ¿ */
        .plank-info-icon { font-size: 10px; opacity: 0.7; }
        .heatmap-legend { display:inline-flex; align-items:center; gap:5px; font-size:11px; margin-left:10px; padding:2px 8px; background:#f1f5f9; border-radius:4px; }
        .grad-bar { width:60px; height:8px; background: linear-gradient(to right, #f87171, #facc15, #4ade80); border-radius:2px; }
        
        .col-hidden { display: none !important; }
        
        .filter-popover {
            position: absolute; background: white; border: 1px solid #cbd5e1; padding: 10px;
            border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 50;
            display: none; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 300px;
        }
        .filter-popover.show { display: grid; }
        .filter-check-label { font-size: 12px; display: flex; align-items: center; gap: 4px; cursor: pointer; }

        /* ç‰¹æ®Šçº¦æŸæ¡†æ ·å¼ */
        .constraints-box { background: #fff0f0; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #fecaca; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.05); }
        .constraints-box h4 { color: #991b1b; margin-bottom: 10px; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .constraints-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
        .constraints-grid label { font-size: 12px; color: #7f1d1d; font-weight: 600; display: block; margin-bottom: 4px; }
        .constraints-grid input { border-color: #fca5a5; width: 100%; }
        .constraints-grid input:focus { border-color: #dc2626; box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }

        /* æ ‡ç­¾è¾“å…¥ç»„ä»¶æ ·å¼ */
        .tag-widget-container { position: relative; background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 4px; display: flex; flex-wrap: wrap; gap: 4px; min-height: 38px; transition: border 0.2s; }
        .tag-widget-container:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .tag-chip { background: #e0f2fe; color: #0369a1; font-size: 12px; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; cursor: default; border: 1px solid #bae6fd; }
        .tag-chip-remove { cursor: pointer; opacity: 0.6; font-weight: bold; }
        .tag-chip-remove:hover { opacity: 1; color: #dc2626; }
        .tag-input-field { border: none !important; outline: none !important; padding: 4px !important; flex: 1; min-width: 60px; font-size: 13px; background: transparent !important; box-shadow: none !important; }
        .suggestion-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 50; max-height: 200px; overflow-y: auto; display: none; margin-top: 4px; }
        .suggestion-item { padding: 8px 12px; font-size: 13px; cursor: pointer; border-bottom: 1px solid #f1f5f9; color: #333; }
        .suggestion-item:hover { background: #f8fafc; color: var(--primary); }
        .suggestion-item small { color: #94a3b8; margin-left: 5px; }
        .conflict-builder { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .conflict-builder select { flex: 1; font-size: 12px; padding: 4px; }

        /* å¡ç‰‡ */
        .teacher-cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 15px; }
        .teacher-card { background: white; border-radius: 10px; padding: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .teacher-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary); }
        .teacher-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .teacher-name { font-size: 15px; font-weight: 700; color: #333; }
        .teacher-classes { font-size: 12px; color: #64748b; margin-top: 2px; }
        .performance-badge { padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .performance-excellent { background: #dcfce7; color: #166534; } .performance-good { background: #fef3c7; color: #92400e; } .performance-average { background: #e0f2fe; color: #075985; } .performance-poor { background: #fee2e2; color: #991b1b; }
        .teacher-stats { display: flex; justify-content: space-between; margin-bottom: 10px; background: #f8fafc; padding: 8px; border-radius: 6px; }
        .stat-item { text-align: center; flex: 1; } .stat-value { font-size: 16px; font-weight: 800; color: #333; } .stat-label { font-size: 10px; color: #64748b; text-transform: uppercase; }
        .view-details-btn { width: 100%; padding: 8px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; color: #475569; font-weight: 500; transition: 0.2s; }
        .view-details-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .pairing-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .pairing-card { background: linear-gradient(to bottom right, #ffffff, #f8fafc); border: 1px solid #cbd5e1; border-radius: 10px; padding: 15px; display: flex; gap: 10px; position: relative; }
        .pairing-card::after { content: 'ğŸ¤'; position: absolute; right: 15px; top: 15px; font-size: 24px; opacity: 0.2; }
        .pairing-side { flex: 1; }
        .pairing-arrow { display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 20px; }
        .pairing-role { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 4px; }
        .pairing-name { font-weight: bold; color: #1e293b; font-size: 14px; }
        .pairing-skill { font-size: 11px; color: var(--success); margin-top: 2px; } .pairing-need { font-size: 11px; color: var(--danger); margin-top: 2px; }
        .pairing-tag { background: var(--primary-light); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-size: 10px; display: inline-block; margin-top: 5px; }

        #mode-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
        .mode-box { background: white; padding: 30px; border-radius: 16px; width: 100%; max-width: 600px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 90vh; overflow-y: auto; }
        .mode-btns { display: flex; gap: 15px; margin-top: 30px; justify-content: center; flex-wrap: wrap; }
        .mode-btn { flex: 1; min-width: 260px; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: 0.3s; text-align: left; background: #f8fafc; }
        .mode-btn:hover, .mode-btn:active { border-color: var(--primary); transform: translateY(-3px); background: #eff6ff; box-shadow: var(--shadow); }
        .mode-btn h3 { color: var(--primary); margin-bottom: 10px; font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; }
        .mode-btn ul { list-style: none; padding: 0; }
        .mode-btn li { font-size: 13px; color: #475569; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(3px); padding: 15px; }
        .modal-content { 
            background: white; 
            border-radius: 12px; 
            width: 95% !important;        /* å®½åº¦å å±å¹• 95% */
            max-width: 1600px !important; /* æœ€å¤§å®½åº¦æ”¾å®½åˆ° 1600px */
            height: auto;
            max-height: 95vh;             /* é«˜åº¦åˆ©ç”¨ç‡æå‡ */
            overflow-y: auto; 
            padding: 25px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            display: flex;                /* ä½¿ç”¨ Flex å¸ƒå±€ */
            flex-direction: column;       /* å‚ç›´æ’åˆ— */
        }

        .school-modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .school-modal-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 15px; }
        .clickable-school { cursor: pointer; color: var(--primary); text-decoration: underline; font-weight: bold; }
        .clickable-school:hover { color: var(--primary-dark); }
        /* ç§»åŠ¨ç«¯é€‚é…ï¼šå•åˆ—æ˜¾ç¤º */
        @media screen and (max-width: 768px) { .school-modal-grid { grid-template-columns: 1fr; } }

        .report-card-container { background: white; border: none; border-radius: 0; padding: 20px; max-width: 800px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; }
/* =========================================================
   ğŸŸ¢ å®¶é•¿ç«¯æˆç»©å•ã€å…¨å±æ²‰æµ¸æ¨¡å¼ã€‘å¢å¼ºæ ·å¼
   ä½œç”¨ï¼šå½»åº•è§£å†³â€œæˆç»©å•æ˜¾ç¤ºä¸å®Œæ•´ / è¢«æŒ¤æ²¡â€çš„é—®é¢˜
   ========================================================= */

body.parent-fullscreen-mode {
    overflow: hidden !important;
}

/* è§£é™¤æ‰€æœ‰å®¹å™¨å®½åº¦é™åˆ¶ */
body.parent-fullscreen-mode .container {
    max-width: none !important;
    width: 100vw !important;
    padding: 10px !important;
}

/* æˆç»©å•å¼ºåˆ¶é“ºæ»¡å±å¹• */
body.parent-fullscreen-mode .report-card-container {
    max-width: none !important;
    width: 100vw !important;
    min-height: 100vh !important;
    margin: 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
}

/* è¡¨æ ¼åŒºåŸŸä¸å†è¢«è£åˆ‡ */
body.parent-fullscreen-mode .table-wrap {
    max-height: none !important;
    overflow: visible !important;
}

/* ç¦ç”¨ stickyï¼Œé˜²æ­¢è¡¨å¤´é®æŒ¡ */
body.parent-fullscreen-mode thead th {
    position: static !important;
}

/* ç§»åŠ¨ç«¯å†å…œä¸€å±‚åº• */
@media screen and (max-width: 768px) {
    body.parent-fullscreen-mode {
        font-size: 13px;
    }
}
        .report-header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; }
        .report-header h3 { font-size: 24px; color: var(--primary); letter-spacing: 2px; font-weight: 800; }
        .report-info-row { display: flex; justify-content: space-between; background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; color: #333; border: 1px solid #e2e8f0; flex-wrap: wrap; gap: 10px; font-size: 13px; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; margin: 20px 0; display: flex; justify-content: center; align-items: center; }

        .dist-bar-container { display: flex; align-items: flex-end; height: 50px; gap: 1px; justify-content: center; }
        .dist-bar { background-color: var(--primary); width: 8px; border-radius: 2px 2px 0 0; position: relative; opacity: 0.8; transition: 0.2s; }
        .dist-bar:hover { background-color: var(--warning); opacity: 1; transform: scaleY(1.1); }
        .diagnosis-tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; display: inline-block; white-space: nowrap; }
        .diagnosis-bad { background: #fee2e2; color: #991b1b; } .diagnosis-good { background: #dcfce7; color: #166534; } .diagnosis-flat { background: #e0f2fe; color: #075985; }
        .text-red { color: var(--danger); font-weight: bold; } .text-green { color: var(--success); font-weight: bold; } .text-blue { color: var(--primary); font-weight: bold; } .text-orange { color: var(--warning); font-weight: bold; }
        .positive-percent { color: var(--success); font-weight: bold; } .negative-percent { color: var(--danger); font-weight: bold; }

        /* è¯­éŸ³æ‚¬æµ®çƒ */
        .voice-fab {
            position: fixed; bottom: 100px; right: 30px; z-index: 9999;
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #f43f5e, #e11d48);
            box-shadow: 0 10px 25px -5px rgba(225, 29, 72, 0.5);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 28px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .voice-fab:hover { transform: scale(1.1); box-shadow: 0 15px 30px -5px rgba(225, 29, 72, 0.6); }
        .voice-fab.listening { animation: pulse-ring 2s infinite; background: #22c55e; }
        
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* å…¨å±è¯­éŸ³ HUD (æŠ¬å¤´æ˜¾ç¤º) */
        .voice-hud {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px);
            z-index: 20000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            color: white; transition: opacity 0.3s;
        }
        .voice-hud.active { display: flex; animation: fadeIn 0.2s; }
        .voice-wave { display: flex; align-items: center; height: 60px; gap: 6px; margin-bottom: 30px; }
        .voice-bar { width: 8px; background: #38bdf8; border-radius: 4px; animation: sound-wave 0.5s ease-in-out infinite alternate; }
        .voice-bar:nth-child(1) { height: 20px; animation-delay: 0.1s; }
        .voice-bar:nth-child(2) { height: 40px; animation-delay: 0.2s; }
        .voice-bar:nth-child(3) { height: 60px; animation-delay: 0.3s; }
        .voice-bar:nth-child(4) { height: 40px; animation-delay: 0.4s; }
        .voice-bar:nth-child(5) { height: 20px; animation-delay: 0.5s; }
        
        @keyframes sound-wave { 0% { height: 10px; opacity: 0.5; } 100% { height: 60px; opacity: 1; } }

        .voice-text-main { font-size: 32px; font-weight: bold; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .voice-text-sub { font-size: 16px; color: #94a3b8; }
        .voice-cmd-list { margin-top: 40px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; text-align: left; }
        .voice-cmd-item { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 8px; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
        .voice-cmd-key { color: #38bdf8; font-weight: bold; margin-right: 10px; }

.notification-btn {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            background: #ef4444; /* é²œçº¢è‰² */
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            animation: pulse-red 2s infinite;
        }
        .notification-badge.hidden { display: none; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        #parent-view-container {
            position: fixed !important;       /* å¼ºåˆ¶å›ºå®šå®šä½ï¼Œå æ»¡å±å¹• */
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            background-color: #f3f4f6 !important; /* å¼ºåˆ¶ä¸é€æ˜èƒŒæ™¯ï¼Œé®æŒ¡åº•éƒ¨ */
            z-index: 20000 !important;    /* CSSå…è®¸çš„æœ€å¤§å±‚çº§ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            
            /* æ ¸å¿ƒæ»šåŠ¨ä¿®å¤ */
            overflow-y: auto !important;      /* å…è®¸çºµå‘æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch; /* iOS æƒ¯æ€§æ»šåŠ¨æ”¯æŒ */
            overscroll-behavior: contain;     /* é˜²æ­¢æ»šåŠ¨ç©¿é€åˆ°ä¸‹å±‚ */
            
            padding: 10px;
            box-sizing: border-box;
            display: block;
        }

        /* ç¡®ä¿å†…éƒ¨å†…å®¹æœ‰è¶³å¤Ÿç©ºé—´ */
        #parent-view-container .report-card-container {
            margin-bottom: 50px !important; /* åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«æ‰‹æœºå¯¼èˆªæ¡é®æŒ¡ */
            max-width: 100% !important;
            width: 100% !important;
        }

      /* === æ‰‹æœºæç®€æ¨¡å¼é€‚é… === */
        #mobile-app { 
            display: none; 
            background: #f3f4f6; 
            min-height: 100vh; 
            padding-bottom: 70px; /* ä¸ºåº•éƒ¨å¯¼èˆªç•™å‡ºç©ºé—´ */
            overflow-x: hidden;
        }
        
        @media screen and (max-width: 768px) {
            /* 1. å…¨å±€å®¹å™¨é€‚é…ï¼šå¼ºåˆ¶é“ºæ»¡å±å¹•ï¼Œç¦æ­¢é¡µé¢çº§æ¨ªå‘æ»šåŠ¨ */
            body, html { overflow-x: hidden !important; width: 100% !important; }
            
            /* 2. æ˜¾å¼å¼€å¯ç”µè„‘ç‰ˆå®¹å™¨ï¼Œä½†é™åˆ¶å®½åº¦ */
            body > .container, body > header, body > .nav-wrapper { 
                display: block !important; 
                width: 100% !important; 
                max-width: 100vw !important;
                padding: 10px !important; /* å‡å°è¾¹è· */
                margin: 0 !important;
                box-sizing: border-box;
            }

            /* 3. éšè—åŸæœ¬çš„æç®€æ‰‹æœºç‰ˆ (å› ä¸ºæˆ‘ä»¬è¦ç”¨å…¨åŠŸèƒ½ç‰ˆ) */
            #mobile-app, .mob-bottom-nav { display: none !important; }

           /* 4. æ ‡é¢˜æ æ·±åº¦é€‚é… (ä¿®å¤æ–‡å­—ç«–æ’æŒ¤å‹é—®é¢˜) */
            /* âœ… [æ–°å¢]ï¼šå¼ºåˆ¶ Header å†…éƒ¨æ”¹ä¸ºå‚ç›´å¸ƒå±€ï¼Œä¸å†å·¦å³æŒ¤å‹ */
            header > div { 
                flex-direction: column !important; 
                align-items: center !important; 
                gap: 10px !important;
            }

            /* âœ… [æ–°å¢]ï¼šæ ‡é¢˜å®¹å™¨å®½åº¦è®¾ä¸º100%å¹¶å±…ä¸­ */
            header > div > div:nth-of-type(1) {
                width: 100% !important;
                text-align: center !important;
                flex: none !important; /* ç¦æ­¢ç¼©æ”¾ */
            }

            /* âœ… [æ–°å¢]ï¼šå³ä¸Šè§’å·¥å…·æ æ”¹ä¸ºå±…ä¸­å¹¶å…è®¸æ¢è¡Œ */
            header > div > div:last-child {
                width: 100% !important;
                justify-content: center !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            /* âœ… [ä¿®æ”¹]ï¼šè°ƒæ•´æ ‡é¢˜å­—å·å’Œ Logo */
            h1 { 
                font-size: 20px !important; 
                line-height: 1.4 !important; 
                white-space: normal !important; /* å¼ºåˆ¶å…è®¸æ–‡å­—æ¨ªå‘æ˜¾ç¤º */
                margin: 0 !important;
            }
            /* éšè—å‰¯æ ‡é¢˜ä»¥èŠ‚çœæ‰‹æœºç©ºé—´ */
            #app-subtitle { display: none !important; }
            
            header { padding: 15px 10px !important; border-radius: 0 !important; height: auto !important; }
            #custom-logo-img { height: 50px !important; margin-bottom: 5px; } 
            
            /* è°ƒæ•´é¡¶éƒ¨æŒ‰é’®å¤§å°ï¼Œä½¿å…¶æ›´ç´§å‡‘ */
            header .btn, header div[onclick] {
                font-size: 12px !important;
                padding: 6px 12px !important;
                height: 32px !important;
                margin: 0 !important;
                width: auto !important; /* æŒ‰é’®ä¸è¦æ’‘æ»¡ï¼Œä¿æŒè‡ªç„¶å®½åº¦ */
            }


            /* 5. æ ¸å¿ƒå¸ƒå±€è°ƒæ•´ï¼šå·¦å³åˆ†æ æ”¹ä¸ºä¸Šä¸‹å †å  */
            .layout-grid { 
                display: block !important; /* å–æ¶ˆ Gridï¼Œæ”¹ä¸ºæµå¼å¸ƒå±€ */
            }
            .side-nav {
                width: 100% !important;
                position: static !important; /* å–æ¶ˆå›ºå®šå®šä½ */
                margin-bottom: 15px;
                background: #f8fafc;
                max-height: 180px; /* é™åˆ¶é«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨ */
                overflow-y: auto;
                border: 1px solid #e2e8f0;
            }

            /* 6. æ§åˆ¶é¢æ¿ä¼˜åŒ– (å…³é”®ï¼è§£å†³ç•Œé¢å¤ªå¤§çš„é—®é¢˜) */
            .control-panel {
                display: flex !important;
                flex-direction: column !important; /* å¼ºåˆ¶å‚ç›´æ’åˆ— */
                gap: 8px !important;
                align-items: stretch !important; /* æ‹‰ä¼¸å æ»¡å®½åº¦ */
            }
            
            /* è®©æ‰€æœ‰è¾“å…¥æ¡†ã€ä¸‹æ‹‰æ¡†ã€æŒ‰é’®åœ¨æ‰‹æœºä¸Šå æ»¡ä¸€è¡Œï¼Œæ–¹ä¾¿ç‚¹å‡» */
            .control-panel select, 
            .control-panel input[type="text"], 
            .control-panel input[type="number"], 
            .control-panel button, 
            .btn {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                box-sizing: border-box !important;
                height: 40px !important; /* å¢å¤§è§¦æ§åŒºåŸŸ */
                font-size: 14px !important;
            }
            /* ç‰¹æ®Šå¤„ç†ï¼šåœ¨ä¸€è¡Œå†…çš„å¤é€‰æ¡†è®©å®ƒä¿æŒè¡Œå†… */
            .control-panel label { display: flex; align-items: center; margin-bottom: 5px; }

            /* 7. è¡¨æ ¼æ·±åº¦ä¼˜åŒ–ï¼šå­—ä½“ç¼©å° + å¼ºåˆ¶æ¨ªå‘æ»šåŠ¨ */
            .table-wrap {
                width: 100% !important;
                overflow-x: auto !important; /* å…³é”®ï¼šåªåœ¨è¡¨æ ¼åŒºåŸŸæ»šåŠ¨ */
                -webkit-overflow-scrolling: touch; /* å¹³æ»‘æ»šåŠ¨ */
                display: block !important;
                margin-top: 10px !important;
                border: none !important; /* ç§»é™¤è¾¹æ¡†èŠ‚çœç©ºé—´ */
            }
            table { 
                min-width: 600px; /* ä¿è¯è¡¨æ ¼ä¸è¢«è¿‡åº¦å‹ç¼© */
                font-size: 12px !important; /* ç¼©å°å­—å· */
            }
            th, td { padding: 8px 4px !important; } /* å‡å°å•å…ƒæ ¼å†…è¾¹è· */

            /* 8. å¯¼èˆªæ é€‚é…ï¼šæ¨ªå‘æ»‘åŠ¨ */
            .nav-categories, .nav-sub-items {
                display: flex !important;
                overflow-x: auto !important;
                white-space: nowrap !important;
                scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ */
            }
            
            /* 9. éšè—ä¸å¿…è¦çš„æ‚¬æµ®å…ƒç´ ï¼Œé˜²æ­¢é®æŒ¡ */
            .voice-hud, #voice-fab, .spotlight-mask { display: none !important; }
            
            /* 10. å¼¹çª—å…¨å±åŒ– */
            .modal-content {
                width: 95% !important;
                margin: 20px auto !important;
                max-height: 85vh !important;
                padding: 15px !important;
            }
            
            /* 11. å¡ç‰‡ä¸æ¨¡å—é—´è·è°ƒæ•´ */
            .card-box, .section {
                padding: 15px !important;
                border-radius: 8px !important;
                margin-bottom: 15px !important;
            }
            
            /* 12. ä¿®å¤ä¸Šä¼ æ¡†å¤ªå¤§çš„é—®é¢˜ */
            .upload-box {
                padding: 20px !important;
                min-width: auto !important;
                width: 100% !important;
            }
            /* å¼ºåˆ¶å°†è¡¨æ ¼ç»„ä»¶è½¬æ¢ä¸ºå—çº§å…ƒç´  */
            .table-wrap table, 
            .table-wrap thead, 
            .table-wrap tbody, 
            .table-wrap th, 
            .table-wrap td, 
            .table-wrap tr { 
                display: block !important; 
            }

            /* éšè—åŸæœ¬çš„è¡¨å¤´ (ä½†ä¿ç•™ç»“æ„ä»¥é˜²è¾…åŠ©é˜…è¯»å™¨éœ€è¦) */
            .table-wrap thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            /* å°†æ¯ä¸€è¡Œå˜æˆä¸€ä¸ªæ¼‚äº®çš„ç™½è‰²å¡ç‰‡ */
            .table-wrap tbody tr { 
                background: #fff;
                border: 1px solid #e2e8f0;
                border-radius: 12px; /* åœ†è§’ */
                margin-bottom: 15px; /* å¡ç‰‡é—´è· */
                box-shadow: 0 2px 5px rgba(0,0,0,0.03); /* è½»å¾®é˜´å½± */
                padding: 10px;
                position: relative;
            }

            /* å•å…ƒæ ¼æ ·å¼ï¼šå˜æˆå·¦å³ç»“æ„çš„é”®å€¼å¯¹ */
            .table-wrap td { 
                border: none !important;
                border-bottom: 1px dashed #f1f5f9 !important; 
                position: relative;
                padding-left: 40% !important; /* å·¦ä¾§ç•™ç»™æ ‡ç­¾ */
                text-align: right !important; /* å†…å®¹é å³å¯¹é½ */
                white-space: normal !important; /* å…è®¸æ¢è¡Œ */
                min-height: 35px;
                display: flex !important;
                align-items: center;
                justify-content: flex-end;
            }

            .table-wrap td:last-child {
                border-bottom: none !important;
            }

            /* åˆ©ç”¨ data-label å±æ€§è‡ªåŠ¨ç”Ÿæˆå·¦ä¾§æ ‡ç­¾ (ä¼ªå…ƒç´ ) */
            .table-wrap td:before { 
                position: absolute;
                top: 50%;
                left: 10px;
                transform: translateY(-50%);
                width: 35%; 
                padding-right: 10px; 
                white-space: nowrap;
                text-align: left;
                font-weight: 700;
                color: #64748b; /* æ ‡ç­¾é¢œè‰² */
                content: attr(data-label); /* æ ¸å¿ƒï¼šè¯»å– HTML ä¸­çš„å±æ€§ */
                font-size: 12px;
            }

            /* ç‰¹æ®Šå¤„ç†ï¼šåå­—å’Œæ€»åˆ†åŠ ç²—æ˜¾ç¤º */
            .table-wrap td[data-label="å§“å"], 
            .table-wrap td[data-label="æ€»åˆ†"] {
                font-size: 15px;
                color: #1e293b;
                font-weight: 800;
            }
            
            /* âœ‹ å°æ‰‹æç¤ºï¼šå¦‚æœæ˜¯ç©ºæ•°æ®è¡Œï¼Œä¿æŒå±…ä¸­ */
            .table-wrap td[colspan] {
                text-align: center !important;
                padding-left: 10px !important;
                justify-content: center;
            }
            /* 1. ä¿®å¤ SweetAlert2 åœ¨æ‰‹æœºä¸Šè¿‡å®½çš„é—®é¢˜ */
            div.swal2-popup {
                width: 90% !important;
                padding: 1rem !important;
                font-size: 0.9rem !important;
            }
            div.swal2-actions {
                flex-direction: column-reverse; /* æ‰‹æœºä¸Šå–æ¶ˆæŒ‰é’®åœ¨ä¸‹æ›´æ˜“ç‚¹ */
                gap: 10px;
                width: 100%;
            }
            div.swal2-actions button {
                width: 100% !important;
                margin: 0 !important;
            }

        /* A. ç§»åŠ¨ç«¯è¡¨æ ¼å¼ºåˆ¶è½¬å¡ç‰‡ (å“åº”å¼ä¼˜åŒ–) */
        @media screen and (max-width: 768px) {
            /* å¼ºåˆ¶è¡¨æ ¼å…ƒç´ ä¸ºå—çº§æ˜¾ç¤º */
            .table-wrap table, .table-wrap thead, .table-wrap tbody, .table-wrap th, .table-wrap td, .table-wrap tr { 
                display: block !important; 
            }
            
            /* éšè—è¡¨å¤´ï¼Œä½†ä¿ç•™ç»“æ„ä¾›å±å¹•é˜…è¯»å™¨ */
            .table-wrap thead tr { 
                position: absolute; top: -9999px; left: -9999px; 
            }
            
            /* è¡Œå˜æˆå¡ç‰‡ */
            .table-wrap tbody tr { 
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 12px;
                margin-bottom: 15px;
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            }
            
            /* å•å…ƒæ ¼å˜æˆé”®å€¼å¯¹ */
            .table-wrap td { 
                border: none !important;
                border-bottom: 1px dashed rgba(0,0,0,0.05) !important; 
                position: relative;
                padding-left: 45% !important; /* å·¦ä¾§ç•™ç»™æ ‡ç­¾ */
                text-align: right !important;
                min-height: 30px;
                display: flex !important;
                align-items: center;
                justify-content: flex-end;
            }
            
            /* åˆ©ç”¨ data-label æ˜¾ç¤ºè¡¨å¤´ (å…³é”®UXä¼˜åŒ–) */
            .table-wrap td:before { 
                position: absolute;
                top: 50%; left: 0;
                transform: translateY(-50%);
                width: 40%; 
                padding-right: 10px; 
                white-space: nowrap;
                font-weight: 700;
                color: var(--secondary);
                content: attr(data-label); 
                text-align: left;
                font-size: 12px;
            }
            
            .table-wrap td:last-child { border-bottom: none !important; }
        }

        /* B. å…¨å±€éª¨æ¶å±åŠ è½½åŠ¨ç”» (Skeleton Shimmer) */
        .skeleton-loading {
            background: #f6f7f8;
            background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-repeat: no-repeat;
            background-size: 800px 100%; 
            animation: shimmer 1.5s infinite linear forwards;
            color: transparent !important;
            border-radius: 4px;
        }
        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }

        /* C. æ·±è‰²æ¨¡å¼å¯¹æ¯”åº¦ä¿®å¤ (WCAGæ ‡å‡†) */
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #f1f5f9 !important;
        }
        body.dark-mode input:focus, body.dark-mode select:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
        }
        body.dark-mode .spotlight-item.active, body.dark-mode .spotlight-item:hover {
            background-color: rgba(59, 130, 246, 0.2) !important;
        }

            /* 2. ä¼˜åŒ– Spotlight æœç´¢æ¡†åœ¨æ‰‹æœºä¸Šçš„ä½“éªŒ */
            .spotlight-box {
                width: 95% !important;
                top: 60px !important; /* é¿å¼€é¡¶éƒ¨å¯¼èˆª */
                max-height: 60vh;
            }
            
            /* 3. å¢å¤§ç‚¹å‡»åŒºåŸŸ (Accessibility) */
            input[type="checkbox"], input[type="radio"] {
                transform: scale(1.3);
                margin-right: 5px;
            }
        }

        /* 1. åº•éƒ¨å¯¼èˆªæ  */
        .mob-bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around;
            align-items: center; z-index: 9000; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
        }
        .mob-nav-item {
            flex: 1; text-align: center; color: #94a3b8; font-size: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: 0.2s;
        }
        .mob-nav-item i { font-size: 22px; margin-bottom: 2px; }
        .mob-nav-item.active { color: var(--primary); font-weight: bold; transform: translateY(-2px); }

       /* 2. é¡µé¢å®¹å™¨ä¸è½¬åœº */
        /* é»˜è®¤ display: blockï¼Œé˜²æ­¢ JS æŒ‚æ‰æ—¶é¡µé¢ä¸€ç‰‡ç™½ */
        .mob-view { display: block; padding: 15px; animation: fadeIn 0.3s ease; }
        
        /* åªæœ‰å½“æ²¡æœ‰ active ç±»æ—¶æ‰éšè— */
        .mob-view:not(.active) { display: none; }
        
        /* é…åˆ x-cloak é˜²æ­¢é—ªçƒ (å¯é€‰) */
        [x-cloak] { display: none !important; }

        /* 3. å¢å¼ºå‹å¡ç‰‡ (æ”¯æŒæŠ˜å ) */
        .mob-card { 
            background: white; border-radius: 16px; padding: 15px; 
            margin-bottom: 15px; box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .mob-card-header { display: flex; justify-content: space-between; align-items: center; }
        .mob-card-title { font-size: 16px; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        
        /* 4. æ•°æ®æ¦‚è§ˆå— */
        .mob-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .mob-stat-box { background: #f8fafc; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; }
        .mob-stat-val { font-size: 18px; font-weight: 800; color: var(--primary); }
        .mob-stat-lbl { font-size: 11px; color: #64748b; }

        /* 5. æœç´¢å¢å¼º */
        .mob-search-sticky { position: sticky; top: 0; z-index: 50; background: #f3f4f6; padding: 10px 0; margin-bottom: 10px; }
        .mob-filter-tags { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .mob-tag { padding: 4px 12px; background: white; border-radius: 20px; font-size: 12px; color: #64748b; border: 1px solid #e2e8f0; white-space: nowrap; }
        .mob-tag.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* 6. è¯¦æƒ…æŠ˜å åŒº */
        .mob-accordion-content { 
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .mob-score-badge { background: #f1f5f9; padding: 5px; border-radius: 6px; text-align: center; font-size: 12px; }
        .mob-score-badge b { display: block; color: #333; font-size: 14px; }

        .mob-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .mob-stat-row { display: flex; justify-content: space-between; text-align: center; margin-top: 10px; }
        .mob-stat-item { flex: 1; border-right: 1px solid #eee; }
        .mob-stat-item:last-child { border-right: none; }
        .mob-val { font-size: 24px; font-weight: 800; color: var(--primary); display: block; }
        .mob-label { font-size: 11px; color: #64748b; text-transform: uppercase; }
        
        .mob-search-box { position: relative; margin-bottom: 20px; }
        .mob-input { width: 100%; padding: 15px; padding-left: 45px; border: 2px solid #e2e8f0; border-radius: 50px; font-size: 16px; outline: none; transition: 0.3s; -webkit-appearance: none; }
        .mob-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        .mob-search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 20px; }
        
        .mob-res-card { border-left: 4px solid var(--primary); animation: slideUp 0.3s ease; }
        .mob-res-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .mob-res-name { font-size: 18px; font-weight: bold; color: #333; }
        .mob-res-cls { background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .mob-score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mob-score-item { background: #f8fafc; padding: 8px; border-radius: 6px; text-align: center; }
        .mob-s-sub { font-size: 10px; color: #64748b; margin-bottom: 2px; }
        .mob-s-val { font-size: 14px; font-weight: bold; color: #333; }
        .mob-upload-btn { display: block; width: 100%; padding: 15px; background: #3b82f6; color: white; text-align: center; border-radius: 12px; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); border: none; font-size: 16px; }
        
        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        /* æ‰“å°ä¼˜åŒ– */
        @media print {
            body > *:not(#app):not(#temp-print-wrapper):not(#batch-print-container) { display: none; }
            header, .nav-wrapper, .btn, .control-panel, .info-bar, .side-nav, .upload-box, #mode-mask { 
                display: none !important; 
            }
            /* 1. å¼ºåˆ¶ç§»é™¤å¡ç‰‡é˜´å½±ã€è¾¹æ¡†ã€èƒŒæ™¯è‰²å’Œç£¨ç ‚ç‰¹æ•ˆï¼Œå›å½’ç™½çº¸é»‘å­— */
            .card-box, .section, .container, #app {
                box-shadow: none !important;
                border: none !important;
                background: white !important; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ */
                backdrop-filter: none !important; /* ç§»é™¤æ¯›ç»ç’ƒ */
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            /* 2. å¼ºåˆ¶æ–‡å­—çº¯é»‘ï¼Œé˜²æ­¢æ‰“å°æœºæ‰“å°å‡ºæµ…ç°è‰²çœ‹ä¸æ¸… */
            body, table, th, td, h1, h2, h3, div, span, .text-gray {
                color: #000 !important;
            }

            /* 3. å¼ºåˆ¶æ‰“å°èƒŒæ™¯è‰² (å…³é”®ï¼å¦åˆ™æ•°æ®æ¡å’Œçº¢ç»¿åº•è‰²æ‰“ä¸å‡ºæ¥) */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;

            /* 4. é˜²æ­¢è¡¨æ ¼è¡Œè¢«åˆ‡æ–­ (åˆ†é¡µä¸æ–­è¡Œ) */
            tr { page-break-inside: avoid; }
            #app, .container, .content-area, .section.active, .table-wrap {
                width: 100% !important; margin: 0 !important; padding: 0 !important;
                display: block !important; overflow: visible !important;
            }
            .exam-print-page { page-break-after: always; display: block !important; width: 100%; margin: 0; padding: 20px; }
            .mp-grid { display: block; } 
            .task-ticket { 
                width: 48%; float: left; margin: 0 1% 20px 0; 
                border: 2px solid #000; box-shadow: none; page-break-inside: avoid;
            }
            #exam-results-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 9999; background: white; }
            
            #batch-print-container, #temp-print-wrapper { display: block !important; width: 100%; position: absolute; top: 0; left: 0; z-index: 10000; background: white; }
            .report-card-container { box-shadow: none !important; border: 2px solid #333 !important; }
            
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        #desk-labels-print-area { display: none; } 
        @media print {
            #desk-labels-print-area { display: block !important; }
            .desk-label-page { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr; /* A4çº¸æ¨ªå‘åˆ†ä¸¤åˆ— */
                gap: 10px; 
                padding: 10px;
                page-break-after: always; /* è€ƒåœºé—´å¼ºåˆ¶æ¢é¡µ */
            }
            .desk-label-card {
                border: 3px solid #000;
                padding: 15px;
                text-align: center;
                height: 250px; /* æ¯é¡µçº¸å¤§çº¦æ‰“6-8ä¸ª */
                display: flex;
                flex-direction: column;
                justify-content: center;
                border-radius: 10px;
                box-sizing: border-box;
            }
            .dl-seat-num { font-size: 64px; font-weight: 900; line-height: 1; border-bottom: 2px solid #000; margin-bottom: 5px; padding-bottom: 5px; }
            .dl-name { font-size: 32px; font-weight: bold; margin: 5px 0; }
            .dl-id { font-size: 18px; font-family: 'Courier New', Courier, monospace; letter-spacing: 1px; }
            .dl-class { font-size: 18px; margin-top: 5px; }
            .dl-footer { margin-top: 15px; font-size: 12px; border-top: 1px dashed #000; padding-top: 5px; opacity: 0.8; }
        }

        #desk-labels-print-area { display: none; } 
        @media print {
            /* 1. è®¾ç½®ç‰©ç†çº¸å¼ è¾¹è·ï¼Œç»™æ‰“å°æœºç•™å‡ºå·¦å³â€œå‘¼å¸â€ç©ºé—´ */
            /* 1. å¼ºåˆ¶æ¸…é™¤æµè§ˆå™¨é»˜è®¤è¾¹è·ï¼Œé˜²æ­¢ç¬¬ä¸€é¡µè¢«é¡¶ä¸‹æ¥ */
            @page { margin: 5mm; size: A4 portrait; }
            html, body { margin: 0 !important; padding: 0 !important; height: 100%; }

            #desk-labels-print-area { 
                display: block !important; 
                width: 100% !important; 
                margin: 0 !important;
                padding: 0 !important;
            }

            .desk-label-page { 
                display: grid !important; 
                grid-template-columns: repeat(5, 1fr); 
                gap: 2mm; 
                padding: 0;
                margin: 0 auto;
                page-break-after: always; 
                break-inside: avoid;
                width: 100%;
                box-sizing: border-box;
            }

            .desk-label-card {
                border: 1px dashed #aaa; 
                padding: 0 1px;
                text-align: center;
                /* é«˜åº¦ä¿æŒ 19mm (çº¦70%)ï¼Œç¡®ä¿ä¸€é¡µèƒ½æ‰“å¾ˆå¤š */
                height: 19mm; 
                display: flex;
                flex-direction: column;
                justify-content: space-evenly; /* å‡åŒ€åˆ†å¸ƒ */
                align-items: center;
                box-sizing: border-box;
                background: #fff !important;
                overflow: hidden;
                font-family: "Microsoft YaHei", sans-serif;
                line-height: 1;
            }

            /* 1. è€ƒå·ï¼šæœ€å¤§ï¼ŒåŠ ç²—ï¼Œæœ€é†’ç›® */
            .dl-exam-no {
                font-size: 14pt; /* å­—å·åŠ å¤§ */
                font-weight: 900; 
                font-family: 'Arial Black', 'Arial', sans-serif;
                color: #000;
                letter-spacing: -0.5px; /* ç´§å‡‘ä¸€ç‚¹é˜²æ­¢æ¢è¡Œ */
                margin-bottom: 1px;
            }

            /* 2. ç­çº§ + å§“åï¼šå­—å·ä¸­ç­‰ï¼Œç»Ÿä¸€å¤§å° */
            .dl-main-row {
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 5px; 
                font-size: 10pt; /* æ¯”è€ƒå·å° */
                font-weight: bold; 
                color: #333;
                white-space: nowrap;
            }

            /* 3. è€ƒåœº + åº§å·ï¼šæœ€å°ï¼Œæœ€åº•éƒ¨ */
            .dl-footer-row {
                width: 100%;
                display: flex;
                justify-content: center;
                gap: 0;
                font-size: 8pt; /* æœ€å° */
                color: #666;
                border-top: 1px solid #eee;
                background: #f9f9f9 !important; 
            }
            .dl-room-box, .dl-seat-box {
                padding: 0 4px;
            }
            .dl-seat-box {
                font-weight: bold;
                color: #000;
                border-left: 1px solid #ddd;
            }
        }
        .proctor-setup-grid { 
            display: grid; 
            grid-template-columns: 1.2fr 1fr; 
            gap: 20px; 
            margin-top: 15px; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
        }
        .teacher-scroll-list { 
            max-height: 250px; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 10px; 
            border-radius: 6px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 8px; 
        }
        .teacher-item { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 12px; 
            padding: 4px; 
            background: #f8fafc; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .teacher-item:hover { background: #e0f2fe; }
        .role-group { 
            background: #f1f5f9; 
            padding: 10px; 
            border-radius: 6px; 
            margin-bottom: 10px; 
        }
        .role-label { 
            font-weight: bold; 
            font-size: 13px; 
            color: #334155; 
            margin-bottom: 5px; 
            display: block; 
        }
        .role-select { 
            width: 100%; 
            height: 80px; 
            font-size: 12px; 
            border: 1px solid #cbd5e1; 
            border-radius: 4px; 
        }

        .fb-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .fb-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; position: relative; transition: 0.2s; }
        .fb-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .traffic-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px;
        }
        .traffic-col {
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: var(--shadow); border-top: 5px solid #ccc;
            display: flex; flex-direction: column; max-height: 400px;
        }
        .traffic-col.red { border-top-color: #ef4444; background: #fef2f2; }
        .traffic-col.yellow { border-top-color: #f59e0b; background: #fffbeb; }
        .traffic-col.green { border-top-color: #22c55e; background: #f0fdf4; }
        
        .traffic-head {
            font-weight: 800; font-size: 16px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .traffic-head.red { color: #b91c1c; }
        .traffic-head.yellow { color: #b45309; }
        .traffic-head.green { color: #15803d; }
        
        .traffic-list { overflow-y: auto; padding-right: 5px; flex: 1; }
        
        .traffic-item {
            background: white; border: 1px solid rgba(0,0,0,0.05);
            padding: 10px; border-radius: 8px; margin-bottom: 8px;
            cursor: pointer; transition: 0.2s; position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .traffic-item:hover { transform: translateX(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .t-school { font-weight: bold; font-size: 14px; color: #333; }
        .t-sub { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-top: 4px; }
        .t-badge { font-size: 10px; padding: 1px 5px; border-radius: 4px; font-weight: bold; }
        
        .bg-red-light { background: #fee2e2; color: #b91c1c; }
        .bg-yellow-light { background: #fef3c7; color: #b45309; }
        .bg-green-light { background: #dcfce7; color: #15803d; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media screen and (max-width: 768px) {
            .traffic-grid { grid-template-columns: 1fr; }
        }
        .fb-val { font-size: 24px; font-weight: 800; color: #1e293b; margin: 5px 0; }
        .fb-lbl { font-size: 12px; color: #64748b; }
        .fb-class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .fb-class-box { background: white; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; cursor: pointer; border-top: 4px solid var(--primary); transition: 0.2s; }
        .fb-class-box:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.01); }
        .fb-c-head { padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .fb-c-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .fb-warn-bg { background-color: #fef2f2 !important; border-color: #fca5a5 !important; }
        .fb-good-bg { background-color: #f0fdf4 !important; border-color: #86efac !important; }
        .fb-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .fb-tag-red { background: #fee2e2; color: #991b1b; }
        .seat-workspace { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .seat-tools { width: 280px; flex-shrink: 0; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .seat-canvas { flex: 1; background: white; border: 2px dashed #cbd5e1; border-radius: 8px; min-height: 600px; padding: 40px; display: flex; flex-direction: column; align-items: center; overflow-x: auto; position: relative; }
        .seat-stage { width: 60%; height: 40px; background: #cbd5e1; border-radius: 4px; margin-bottom: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; letter-spacing: 5px; color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .seat-container { display: grid; gap: 15px; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .desk { width: 80px; height: 55px; background: #f1f5f9; border: 1px solid #94a3b8; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; user-select: none; cursor: grab; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .desk:hover { transform: scale(1.1); z-index: 10; border-color: var(--primary); background: #eff6ff; }
        .desk.dragging { opacity: 0.4; border: 2px dashed #333; }
        .desk.drag-over { background: #bfdbfe; transform: scale(1.05); }
        .desk.locked { border: 2px solid #334155 !important; background: #e2e8f0; cursor: not-allowed; }
        .desk.locked::after { content: 'ğŸ”’'; position: absolute; top: -8px; right: -5px; font-size: 14px; z-index: 5; }

        .poster-workspace { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .poster-controls { width: 300px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .poster-preview-area { flex: 1; background: #94a3b8; padding: 40px; display: flex; justify-content: center; overflow: auto; border-radius: 8px; min-height: 600px; }
        
        /* æ ¸å¿ƒæµ·æŠ¥å®¹å™¨ (æ‰‹æœºç«–å±æ¯”ä¾‹ 9:16) */
        .poster-canvas {
            width: 375px; min-height: 667px; background: white; position: relative; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); transform-origin: top center; transition: 0.3s;
            display: flex; flex-direction: column;
        }

        /* --- ä¸»é¢˜ 1: å¤§çº¢å–œæŠ¥ (Traditional Red) --- */
        .theme-red { background: linear-gradient(180deg, #b91c1c 0%, #7f1d1d 100%); color: #fff; font-family: "Microsoft YaHei", serif; }
        .theme-red::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 50% 30%, rgba(255,215,0,0.1) 0%, transparent 60%); pointer-events: none; }
        .theme-red .p-header { text-align: center; padding-top: 40px; padding-bottom: 20px; }
        .theme-red .p-title { font-size: 42px; font-weight: 900; color: #fcd34d; text-shadow: 2px 2px 0px #7f1d1d; letter-spacing: 5px; margin: 0; }
        .theme-red .p-sub { font-size: 16px; color: #fca5a5; margin-top: 5px; letter-spacing: 2px; }
        .theme-red .p-list { padding: 20px; flex: 1; }
        .theme-red .p-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); margin-bottom: 10px; padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(255,215,0,0.3); }
        .theme-red .p-rank { font-size: 18px; font-weight: bold; color: #fcd34d; width: 30px; }
        .theme-red .p-name { font-size: 18px; font-weight: bold; flex: 1; text-align: left; padding-left: 10px; }
        .theme-red .p-score { font-size: 20px; font-weight: 900; color: #fff; }
        .theme-red .p-footer { text-align: center; padding: 20px; font-size: 12px; color: #fca5a5; opacity: 0.8; }

        /* --- ä¸»é¢˜ 2: æ¸…çˆ½è“è°ƒ (Clean Blue) --- */
        .theme-blue { background: linear-gradient(135deg, #e0f2fe 0%, #fff 100%); color: #333; position: relative; }
        .theme-blue::after { content: ''; position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: #3b82f6; border-radius: 50%; opacity: 0.1; }
        .theme-blue .p-header { padding: 40px 20px 20px; border-bottom: 3px solid #3b82f6; }
        .theme-blue .p-title { font-size: 32px; font-weight: 800; color: #1e40af; margin: 0; }
        .theme-blue .p-sub { font-size: 14px; color: #64748b; margin-top: 5px; }
        .theme-blue .p-list { padding: 20px; }
        .theme-blue .p-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px dashed #cbd5e1; }
        .theme-blue .p-rank { background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 12px; font-weight: bold; }
        .theme-blue .p-item:nth-child(1) .p-rank { background: #f59e0b; transform: scale(1.2); }
        .theme-blue .p-item:nth-child(2) .p-rank { background: #94a3b8; transform: scale(1.1); }
        .theme-blue .p-item:nth-child(3) .p-rank { background: #b45309; transform: scale(1.1); }
        .theme-blue .p-name { font-size: 16px; font-weight: 600; color: #334155; flex: 1; padding-left: 15px; }
        .theme-blue .p-score { font-size: 18px; font-weight: bold; color: #2563eb; }
        .theme-blue .p-footer { position: absolute; bottom: 0; width: 100%; text-align: center; padding: 15px; background: #f0f9ff; color: #0369a1; font-size: 11px; }

        /* --- ä¸»é¢˜ 3: ç§‘æŠ€é£ (Cyber Tech) --- */
        .theme-tech { background: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; position: relative; }
        .theme-tech::before { content: ''; position: absolute; inset: 0; background-image: linear-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(56, 189, 248, 0.05) 1px, transparent 1px); background-size: 20px 20px; }
        .theme-tech .p-header { padding: 40px 20px; text-align: center; border-bottom: 1px solid #334155; background: rgba(15, 23, 42, 0.9); }
        .theme-tech .p-title { font-size: 36px; font-weight: 800; color: transparent; background: linear-gradient(to right, #38bdf8, #818cf8); -webkit-background-clip: text; text-transform: uppercase; letter-spacing: 2px; }
        .theme-tech .p-sub { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 4px; margin-top: 5px; }
        .theme-tech .p-list { padding: 15px; }
        .theme-tech .p-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background: rgba(30, 41, 59, 0.6); padding: 10px; border-left: 4px solid #38bdf8; clip-path: polygon(0 0, 100% 0, 100% 85%, 98% 100%, 0 100%); }
        .theme-tech .p-rank { font-family: monospace; font-size: 16px; color: #38bdf8; font-weight: bold; width: 40px; }
        .theme-tech .p-name { font-size: 15px; font-weight: bold; color: #fff; flex: 1; }
        .theme-tech .p-score { font-family: monospace; font-size: 18px; color: #22d3ee; text-shadow: 0 0 5px rgba(34, 211, 238, 0.5); }
        .theme-tech .p-footer { text-align: center; padding: 20px; color: #475569; font-size: 10px; font-family: monospace; }

        .thumb-select { display: flex; gap: 5px; margin-bottom: 10px; }
        .thumb-btn { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px; }
        .thumb-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); font-weight: bold; }
        
        /* è®²å°è§†è§’ç¿»è½¬ï¼šå®¹å™¨è½¬180åº¦ï¼Œä½†æ¡Œå­é‡Œçš„å­—è¦è½¬å›æ¥ä¿æŒæ­£ç«‹ */
        .seat-canvas.view-rotated { transform: rotate(180deg); border-color: #94a3b8; }
        .seat-canvas.view-rotated .seat-stage { transform: rotate(180deg); }
        .seat-canvas.view-rotated .desk { transform: rotate(-180deg); }
        .seat-canvas.view-rotated .learning-group-label { transform: rotate(-180deg); }
        .desk.is-male { border-left: 4px solid #3b82f6; } .desk.is-female { border-left: 4px solid #ec4899; } .desk.is-diff { background: #fef2f2; border: 2px solid #ef4444; }
        .desk-name { font-weight: bold; font-size: 14px; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 95%; }
        .desk-info { font-size: 10px; color: #64748b; transform: scale(0.9); display: flex; gap: 4px; }
        .desk-popover { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; opacity: 0; transition: 0.2s; z-index: 20; }
        .desk:hover .desk-popover { opacity: 1; bottom: 120%; }

        /* æ–°å¢å…³è”åˆ†ææ ·å¼ */
        .heatmap-table th, .heatmap-table td { width: 50px; height: 35px; font-size: 12px; border: 1px solid white; text-align: center; }
        .heatmap-cell { transition: 0.2s; cursor: default; }
        .heatmap-cell:hover { transform: scale(1.2); z-index: 10; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-radius:4px; }
        .contribution-bar { height: 18px; border-radius: 4px; display: flex; align-items: center; padding-left: 5px; font-size: 11px; color: white; transition: width 0.5s; white-space: nowrap; overflow: hidden; }
        
        /* è€ƒåæ’åº§ä¸“ç”¨æ ·å¼ */
        .desk-rank-A { background-color: #dcfce7; border-color: #22c55e; } /* ä¼˜ - Green */
        .desk-rank-B { background-color: #e0f2fe; border-color: #3b82f6; } /* è‰¯ - Blue */
        .desk-rank-C { background-color: #fef9c3; border-color: #eab308; } /* åŠ - Yellow */
        .desk-rank-D { background-color: #fee2e2; border-color: #ef4444; } /* å·® - Red */
        
        /* å­¦ä¹ å°ç»„å®¹å™¨ */
        .learning-group-box {
            position: absolute;
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€åˆ°ä¸‹é¢çš„æ¡Œå­ */
            z-index: 0;
            background: rgba(241, 245, 249, 0.3);
        }
        .learning-group-label {
            position: absolute;
            top: -10px;
            left: 10px;
            background: #94a3b8;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* è¿›é€€æ­¥åˆ†æä¸“ç”¨ */
        .trend-up { color: var(--success); font-weight: bold; }
        .trend-down { color: var(--danger); font-weight: bold; }
        .trend-icon { font-size: 16px; vertical-align: middle; margin-right: 2px; }

        /* äº’åŠ©åˆ†ç»„å¡ç‰‡æ ·å¼ */
        .aid-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .aid-card {
            background: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
        }
        .aid-header {
            background: #f1f5f9;
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .aid-body {
            padding: 10px;
        }
        .aid-role-row {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px dashed #e2e8f0;
        }
        .aid-role-row:last-child { border-bottom: none; }
        .aid-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: #cbd5e1;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 12px;
        }
        .aid-leader .aid-avatar { background: var(--primary); color: white; }
        .aid-member .aid-avatar { background: #e2e8f0; }
        .aid-info { flex: 1; }
        .aid-name { font-weight: 600; color: #1e293b; }
        .aid-score { font-size: 12px; color: #64748b; margin-top: 2px; }
        .aid-tag { 
            font-size: 10px; padding: 2px 5px; border-radius: 4px; 
            margin-left: 5px; vertical-align: middle; 
        }
        .tag-strong { background: #dcfce7; color: #166534; }
        .tag-weak { background: #fee2e2; color: #991b1b; }
        .mobile-share-container {
            position: fixed; left: -9999px; top: 0; /* ç§»å‡ºå±å¹•å¤–è¿›è¡Œæ¸²æŸ“ */
            width: 375px; min-height: 667px;
            background: #f8fafc; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            border: 1px solid #e2e8f0; overflow: hidden;
        }
        .m-header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white; padding: 20px; text-align: center;
            border-radius: 0 0 20px 20px; margin-bottom: 15px;
        }
        .m-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .m-sub { font-size: 12px; opacity: 0.9; }
        .m-card {
            background: white; margin: 10px 15px; padding: 15px;
            border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .m-card-title {
            font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px;
            border-left: 3px solid #2563eb; padding-left: 8px;
        }
        .m-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; }
        .m-stat-val { font-size: 16px; font-weight: bold; color: #2563eb; }
        .m-stat-lbl { font-size: 10px; color: #64748b; }
        .m-list-row {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px dashed #eee; font-size: 13px; color: #333;
        }
        .m-list-row:last-child { border-bottom: none; }
        .m-rank-badge {
            background: #e2e8f0; color: #64748b; width: 20px; height: 20px;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; margin-right: 8px; font-weight: bold;
        }
        .m-top-1 { background: #fee2e2; color: #dc2626; }
        .m-top-2 { background: #ffedd5; color: #c2410c; }
        .m-top-3 { background: #fef9c3; color: #b45309; }
        .m-footer { text-align: center; padding: 20px; color: #cbd5e1; font-size: 10px; }

        /* ================== ä¸´ç•Œç”Ÿä»»åŠ¡å•ä¸“ç”¨æ ·å¼ ================== */
        .mp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); /* A4çº¸ä¸€åŠå®½åº¦çš„å¡ç‰‡ */
            gap: 20px;
            margin-top: 20px;
        }

        .task-ticket {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            break-inside: avoid; /* æ‰“å°æ—¶é¿å…ä»ä¸­é—´åˆ‡æ–­ */
            box-shadow: var(--shadow);
            transition: 0.2s;
        }
        .task-ticket:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }

        .ticket-header {
            background: #f8fafc;
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ticket-title { font-weight: 800; font-size: 16px; color: #1e293b; }
        .ticket-sub { font-size: 12px; color: #64748b; }

        .ticket-body { padding: 0; }
        .ticket-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .ticket-table th { background: #f1f5f9; padding: 6px; text-align: center; color: #475569; font-size: 12px; }
        .ticket-table td { border-bottom: 1px solid #f1f5f9; padding: 8px 6px; text-align: center; }
        .ticket-table tr:last-child td { border-bottom: none; }

        .tag-gap { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .gap-red { background: #fee2e2; color: #991b1b; } /* å·®å¾ˆå¤š */
        .gap-orange { background: #ffedd5; color: #9a3412; } /* å·®ä¸€ç‚¹ */
        .gap-green { background: #dcfce7; color: #166534; } /* è¸©çº¿ */

        .chk-box { width: 16px; height: 16px; border: 1px solid #cbd5e1; border-radius: 3px; display: inline-block; vertical-align: middle; }
    /* 1. å…¨å±€åŠ è½½é®ç½© (Loading) */
    #global-loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.9); z-index: 20000;
        display: flex; justify-content: center; align-items: center;
        flex-direction: column; backdrop-filter: blur(2px);
        transition: opacity 0.3s;
    }
    .loader-spinner {
        width: 50px; height: 50px; border: 5px solid #e2e8f0;
        border-top: 5px solid var(--primary); border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    .loader-text { margin-top: 15px; color: #64748b; font-weight: 600; font-size: 16px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* éª¨æ¶å±åŠ¨ç”»æ•ˆæœ */
    .skeleton {
        background: #f0f2f5;
        background-image: linear-gradient(90deg, #f0f2f5 25%, #e6e8eb 37%, #f0f2f5 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.4s ease infinite;
        border-radius: 4px;
        color: transparent !important;
    }
    .skeleton * { visibility: hidden; }
    @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0 50%; }
    }
    /* éª¨æ¶å±å¸ƒå±€å ä½ */
    .sk-block { width: 100%; height: 20px; margin-bottom: 10px; }
    .sk-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .sk-header { height: 60px; width: 60%; margin: 0 auto 20px; }
    .sk-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .sk-col { flex: 1; height: 40px; }
    .sk-chart { height: 200px; width: 100%; margin-bottom: 15px; }

    
    /* 2. æ¶ˆæ¯æç¤º (Toast) - æ›¿ä»£åŸç”Ÿä¸‘é™‹çš„ alert */
    .toast-container {
        position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
        z-index: 21000; display: flex; flex-direction: column; gap: 10px;
        pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ï¼Œä¸å½±å“ä¸‹æ–¹æ“ä½œ */
    }
    .toast-msg {
        background: white; color: #333; padding: 12px 24px; border-radius: 50px;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15), 0 8px 10px -6px rgba(0,0,0,0.1);
        font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;
        animation: toastSlideDown 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        border: 1px solid #e2e8f0; min-width: 200px; justify-content: center;
    }
    .toast-success { border-left: 4px solid var(--success); }
    .toast-error { border-left: 4px solid var(--danger); }
    .toast-info { border-left: 4px solid var(--primary); }
    @keyframes toastSlideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .spotlight-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); z-index: 30000;
            display: none; justify-content: center; padding-top: 100px; backdrop-filter: blur(4px);
        }
        .spotlight-box {
            width: 100%; max-width: 600px; background: var(--bg-card);
            border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            overflow: hidden; border: 1px solid var(--primary);
        }
        .spotlight-input-wrap { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); }
        .spotlight-input { border: none !important; flex: 1; font-size: 18px; outline: none; background: transparent; }
        .spotlight-results { max-height: 400px; overflow-y: auto; }
        .spotlight-item { 
            padding: 12px 20px; display: flex; justify-content: space-between; 
            cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border);
        }
        .spotlight-item:hover { background: var(--primary-light); color: var(--primary); }
        .spotlight-hint { padding: 10px; font-size: 12px; color: #94a3b8; text-align: center; }
        .login-tab {
            flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; 
            color: #64748b; cursor: pointer; border-radius: 6px; transition: 0.2s;
        }
        .login-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* --- è§’è‰²è§†å›¾æ§åˆ¶æ ¸å¿ƒ (æ ¹æ® body çš„ data-role å±æ€§æ˜¾éšå…ƒç´ ) --- */

        /* 1. å®¶é•¿æ¨¡å¼ï¼šæç®€ï¼Œéšè—ç»å¤§å¤šæ•°åŠŸèƒ½ï¼Œåªä¿ç•™æŸ¥åˆ†ç»“æœ */
        body[data-role="parent"] header, 
        body[data-role="parent"] .nav-wrapper, 
        body[data-role="parent"] .control-panel,
        body[data-role="parent"] #voice-fab,
        body[data-role="parent"] .voice-hud,
        body[data-role="parent"] .spotlight-mask,
        body[data-role="parent"] #mode-mask { 
            display: none !important; 
        }
        /* å®¶é•¿åªæ˜¾ç¤ºç‰¹å®šçš„ç»“æœå®¹å™¨ */
        body[data-role="parent"] #parent-view-container { display: block !important; }
        /* éšè—æ™®é€š App ä¸»å®¹å™¨ */
        body[data-role="parent"] #app { display: none !important; }

        /* 2. æ•™å¸ˆæ¨¡å¼ï¼šéšè—æ•æ„Ÿæ“ä½œ */
        /* éšè—ç»©æ•ˆè€ƒæ ¸(æ¶‰åŠåˆ°é’±/å¥–é‡‘)ã€éšè—é‡ç½®ç³»ç»ŸæŒ‰é’®ã€éšè—ç®¡ç†å‘˜é¢æ¿ */
        body[data-role="teacher"] #single-school-eval, 
        body[data-role="teacher"] .module-desc-bar button[onclick*="resetSystem"], 
        body[data-role="teacher"] #admin-panel-btn { 
            display: none !important;
        }

        /* 3. æ•™åŠ¡ä¸»ä»»æ¨¡å¼ï¼šéšè—è´¦å·ç®¡ç†ï¼Œä½†å¯ä»¥çœ‹ç»©æ•ˆ */
        body[data-role="director"] #admin-panel-btn { 
            display: none !important; 
        }

        /* 4. ç®¡ç†å‘˜æ¨¡å¼ï¼šæ˜¾ç¤ºç®¡ç†å…¥å£ (é»˜è®¤éšè—ï¼Œåªæœ‰ admin æ‰æ˜¾ç¤º) */
        #admin-panel-btn { display: none; }
        body[data-role="admin"] #admin-panel-btn { display: inline-flex !important; }

        /* é€šç”¨ï¼šé€€å‡ºç™»å½•æŒ‰é’® (æ‚¬æµ®åœ¨å³ä¸Šè§’) */
        #logout-btn {
            position: fixed; top: 10px; right: 10px; z-index: 10000;
            background: rgba(0,0,0,0.6); color: white; padding: 6px 12px;
            border-radius: 20px; font-size: 12px; cursor: pointer;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2);
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        #logout-btn:hover { background: #b91c1c; }

/* 1. è¡¨æ ¼å®¹å™¨é™åˆ¶é«˜åº¦ */
#student-details .table-wrap {
    max-height: 75vh !important;
    overflow: auto !important;
    position: relative;
    border: 1px solid #cbd5e1;
}

/* 2. è¡¨å¤´å›ºå®š (Sticky Header) */
#studentDetailTable thead th {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #f1f5f9;
    color: #334155;
    border-bottom: 2px solid #cbd5e1;
    height: 45px; /* é«˜åº¦è°ƒå›æ­£å¸¸ */
    vertical-align: middle;
    padding: 0; /* æ­¤æ—¶paddingç”±å†…éƒ¨divæ§åˆ¶ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* 3. å·¦ä¾§ä¸‰åˆ—å›ºå®š */
#studentDetailTable th:nth-child(1), #studentDetailTable td:nth-child(1) {
    position: sticky; left: 0; z-index: 10; background: inherit; width: 120px; min-width: 120px; border-right: 1px solid #e2e8f0;
}
#studentDetailTable th:nth-child(2), #studentDetailTable td:nth-child(2) {
    position: sticky; left: 120px; z-index: 10; background: inherit; width: 80px; min-width: 80px; border-right: 1px solid #e2e8f0;
}
#studentDetailTable th:nth-child(3), #studentDetailTable td:nth-child(3) {
    position: sticky; left: 200px; z-index: 10; background: inherit; width: 100px; min-width: 100px; border-right: 2px solid #94a3b8;
}
/* è¡¨å¤´äº¤å‰åŒºå±‚çº§æœ€é«˜ */
#studentDetailTable thead th:nth-child(1), #studentDetailTable thead th:nth-child(2), #studentDetailTable thead th:nth-child(3) {
    z-index: 200; background: #e2e8f0;
}

/* 4. Excel é£æ ¼è¡¨å¤´å¸ƒå±€ */
.excel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    height: 100%;
    cursor: pointer;
    user-select: none;
    position: relative; /* å…³é”®ï¼šç”¨äºå®šä½ä¸‹æ‹‰èœå• */
}
.excel-header:hover { background-color: #e2e8f0; }
.header-text { flex: 1; text-align: center; font-size: 13px; font-weight: bold; }

/* 5. ç­›é€‰/æ’åºå›¾æ ‡ */
.filter-icon-btn {
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 4px; color: #94a3b8; margin-left: 5px;
    transition: 0.2s;
}
.filter-icon-btn:hover { background: #cbd5e1; color: #333; }
.filter-icon-btn.active { color: var(--primary); background: #e0e7ff; }

/* 6. Excel ä¸‹æ‹‰ç­›é€‰èœå• */
.excel-filter-menu {
    position: absolute;
    top: 100%; right: 0; /* å¯¹é½å³ä¾§ */
    width: 250px;
    background: white;
    border: 1px solid #cbd5e1;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    border-radius: 6px;
    z-index: 1000 !important; /* ç¡®ä¿æµ®åœ¨æœ€ä¸Šå±‚ */
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column;
    padding: 5px 0;
    text-align: left;
    font-weight: normal;
    color: #333;
}
.excel-filter-menu.show { display: flex; }

#studentDetailTable th:nth-child(1) .excel-filter-menu,
#studentDetailTable th:nth-child(2) .excel-filter-menu {
    right: auto;
    left: 0;
}

/* èœå•å†…éƒ¨æ ·å¼ */
.menu-actions {
    padding: 8px;
    border-bottom: 1px solid #f1f5f9;
    display: flex; gap: 5px;
    flex-direction: column;
}
.menu-search {
    width: 100%; padding: 6px;
    border: 1px solid #cbd5e1; border-radius: 4px;
    font-size: 12px; outline: none;
}
.menu-list {
    max-height: 200px;
    overflow-y: auto;
    padding: 5px 0;
}
.menu-item {
    padding: 5px 12px;
    font-size: 12px;
    display: flex; align-items: center;
    cursor: pointer;
}
.menu-item:hover { background-color: #f1f5f9; }
.menu-item input { margin-right: 8px; transform: scale(1.2); }
.menu-footer {
    padding: 8px;
    border-top: 1px solid #f1f5f9;
    display: flex; justify-content: flex-end; gap: 8px;
}

        /* === 1. Instagram é£æ ¼æŸ¥åˆ†å¡ç‰‡ (ä»¿ç…§ IG ç¤¾äº¤åª’ä½“å¸ƒå±€) === */
        .insta-view-container {
            background-color: #fafafa; /* IG ç»å…¸æµ…ç°åº• */
            min-height: 100vh;
            padding-bottom: 60px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .insta-card {
            background: #ffffff;
            border: 1px solid #dbdbdb;
            border-radius: 3px; /* IG ç½‘é¡µç‰ˆæ˜¯ç›´è§’æˆ–å°åœ†è§’ï¼ŒAppæ˜¯å¤§åœ†è§’ï¼Œè¿™é‡Œå–ä¸­é—´å€¼ */
            margin: 0 auto 20px auto;
            max-width: 600px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œå¹³æ¿ä¸Šä¸è‡³äºå¤ªå®½ */
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* å¡ç‰‡å¤´éƒ¨ï¼šå¤´åƒ + ç”¨æˆ·å + æ›´å¤š */
        .insta-header {
            padding: 14px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #efefef;
        }

        .insta-avatar-ring {
            width: 42px;
            height: 42px;
            padding: 2px;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); /* IG å“ç‰Œæ¸å˜åœˆ */
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .insta-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #fff; /* ç™½è‰²å†…è¾¹æ¡† */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            font-size: 14px;
            overflow: hidden;
        }
        
        .insta-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .insta-user-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .insta-username {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .insta-verified { color: #3897f0; font-size: 12px; } /* è“V */

        .insta-location {
            font-size: 12px;
            color: #262626;
        }

        /* å›¾ç‰‡åŒºåŸŸ (å›¾è¡¨å®¹å™¨) */
        .insta-visual-area {
            width: 100%;
            background-color: #fff;
            position: relative;
            /* ä¿æŒæ­£æ–¹å½¢æˆ– 4:5 æ¯”ä¾‹ï¼Œè¿™é‡Œè‡ªé€‚åº”é«˜åº¦ */
            min-height: 300px; 
            padding: 20px 10px;
            box-sizing: border-box;
        }

        /* è½®æ’­æŒ‡ç¤ºç‚¹ (æ¨¡æ‹Ÿ) */
        .insta-dots {
            display: flex;
            justify-content: center;
            padding: 10px 0;
            gap: 4px;
        }
        .insta-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #dbdbdb;
        }
        .insta-dot.active { background: #0095f6; }

        /* æ“ä½œæ ï¼šå¿ƒå½¢ã€è¯„è®ºã€åˆ†äº« */
        .insta-actions {
            padding: 0 14px;
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .insta-action-left { display: flex; gap: 16px; }
        .insta-icon { cursor: pointer; transition: transform 0.2s; color: #262626; }
        .insta-icon:hover { transform: scale(1.1); }
        .insta-icon.liked { color: #ed4956; animation: insta-heart-beat 0.3s; }

        @keyframes insta-heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ç‚¹èµæ•° */
        .insta-likes {
            padding: 0 14px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: #262626;
        }

        /* æˆç»©æè¿° (Caption) */
        .insta-caption {
            padding: 0 14px;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .insta-caption-name { font-weight: 600; margin-right: 5px; }
        
        .insta-tags { color: #00376b; margin-top: 5px; display: block; }

        /* è¯„è®ºåŒº (å±•ç¤ºå•ç§‘è¯¦æƒ…) */
        .insta-comments {
            padding: 0 14px 14px 14px;
            font-size: 14px;
        }
        .insta-comment-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .insta-comm-user { font-weight: 600; margin-right: 5px; }
        .insta-comm-text { color: #262626; }
        .insta-comm-score { font-weight: bold; color: #262626; }
        .insta-comm-rank { font-size: 12px; color: #8e8e8e; margin-left: 5px; }

        .insta-timestamp {
            padding: 0 14px 14px;
            font-size: 10px;
            color: #8e8e8e;
            text-transform: uppercase;
        }

        /* === 2. æ‰‹æœºç«¯ç®¡ç†ç•Œé¢æ ·å¼ (Teacher/Admin Mobile) === */
        #mobile-manager-app {
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
            padding-bottom: 70px;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .mob-header-bar {
            background: #fff;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mob-header-title { font-weight: 800; font-size: 18px; color: #1e293b; }

        /* æ‰‹æœºç«¯åº•éƒ¨å¯¼èˆªæ  (å›ºå®š) */
        .mob-bottom-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: 60px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 9999;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .mob-nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 10px;
            height: 100%;
            background: none; border: none;
        }
        
        .mob-nav-btn i { font-size: 24px; margin-bottom: 2px; transition: 0.2s; }
        .mob-nav-btn.active { color: #4f46e5; }
        .mob-nav-btn.active i { transform: translateY(-2px); }

        /* æ‰‹æœºç«¯å¡ç‰‡åˆ—è¡¨ */
        .mob-list-container { padding: 10px; }
        
        .mob-list-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .mob-avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: #e0e7ff;
            color: #4f46e5;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 16px;
        }
        
        .mob-info { flex: 1; }
        .mob-name { font-weight: bold; font-size: 16px; color: #1e293b; }
        .mob-detail { font-size: 12px; color: #64748b; margin-top: 2px; }
        
        .mob-score-badge {
            background: #f0fdf4; color: #166534;
            padding: 4px 8px; border-radius: 6px;
            font-weight: bold; font-size: 14px;
        }

        /* æ‰‹æœºç«¯é€‚é…è°ƒæ•´ */
        @media screen and (max-width: 768px) {
            /* å¦‚æœåœ¨æ‰‹æœºä¸Šï¼Œä¸”ä¸æ˜¯å®¶é•¿æ¨¡å¼ï¼Œéšè—PCç«¯çš„æŸäº›æ‚¬æµ®å…ƒç´  */
            #back-to-top { bottom: 80px !important; } /* é¿å¼€åº•éƒ¨å¯¼èˆª */
            .voice-fab { bottom: 150px !important; }
        }


    </style>

    <!-- ================== Windows 11 Fluent Design UI é‡æ„åŒ… ================== -->
    <style>
        /* 1. å…¨å±€å­—ä½“ä¸èƒŒæ™¯ (Mica æè´¨æ¨¡æ‹Ÿ) */
        body {
            font-family: "Segoe UI Variable", "Segoe UI", "Microsoft YaHei", sans-serif !important;
            background-color: #f0f3f9 !important; /* Win11 æµ…è‰²èƒŒæ™¯ */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, hsla(253,16%,7%,0) 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, hsla(225,39%,30%,0) 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, hsla(339,49%,30%,0) 50%) !important;
            color: #202020 !important;
            -webkit-font-smoothing: antialiased;
        }

        /* 2. å¡ç‰‡ä¸å®¹å™¨ï¼šäºšå…‹åŠ›ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
        .card-box, .section, .nav-wrapper, .modal-content, .spotlight-box, .side-nav, .control-panel {
            background: rgba(255, 255, 255, 0.75) !important; /* åŠé€æ˜ç™½ */
            backdrop-filter: blur(20px) saturate(125%) !important; /* æ ¸å¿ƒï¼šé«˜æ–¯æ¨¡ç³Š */
            border: 1px solid rgba(255, 255, 255, 0.6) !important; /* ç»ç’ƒè¾¹ç¼˜å…‰ */
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.06) !important; /* å¼¥æ•£é˜´å½± */
            border-radius: 12px !important; /* Win11 æ ‡å‡†åœ†è§’ */
        }

        /* 3. é¡¶éƒ¨ Headerï¼šå»é™¤é‡è‰²ï¼Œæ”¹ä¸ºæ¸…çˆ½é£æ ¼ */
        header {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.03) !important;
            color: #333 !important;
            margin-bottom: 20px !important;
        }
        /* å¼ºåˆ¶æ ‡é¢˜æ–‡å­—é¢œè‰²å˜æ·±ï¼Œé€‚åº”æµ…è‰²èƒŒæ™¯ */
        header h1, header p, header .btn {
            color: #1a1a1a !important;
            text-shadow: none !important;
        }
        header .btn {
            background: rgba(255,255,255,0.5) !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
        }
        header .btn:hover {
            background: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }

        /* 4. æŒ‰é’®ï¼šæ‰å¹³åŒ– + å¾®åŠ¨æ•ˆ */
        .btn {
            border-radius: 6px !important; /* Win11 æŒ‰é’®åœ†è§’ */
            border: 1px solid transparent !important;
            font-weight: 600 !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
        }
        .btn:active {
            transform: scale(0.96) !important; /* ç‚¹å‡»ç¼©æ”¾ */
            opacity: 0.8;
        }
        /* ä¸»è‰²æŒ‰é’® */
        .btn-primary, button[onclick*="login"] {
            background-color: #0067c0 !important; /* Win11 é»˜è®¤è“ */
            color: white !important;
        }
        .btn:not(.btn-primary):not(.btn-danger):not(.btn-success):not(.btn-purple):not(.btn-orange) {
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            color: #333 !important;
        }
        .btn:not(.btn-primary):not(.btn-danger):hover {
            background-color: #f3f4f6 !important;
        }

        /* 5. è¾“å…¥æ¡†ï¼šåº•éƒ¨é«˜äº®çº¿é£æ ¼ */
        input[type="text"], input[type="number"], input[type="password"], select, textarea {
            background-color: rgba(255,255,255,0.6) !important;
            border: 1px solid #d1d5db !important;
            border-bottom: 2px solid #d1d5db !important; /* åº•éƒ¨åŠ ç²— */
            border-radius: 6px !important;
            transition: all 0.2s !important;
            color: #333 !important;
        }
        input:focus, select:focus, textarea:focus {
            background-color: #fff !important;
            border-color: #d1d5db !important;
            border-bottom-color: #0067c0 !important; /* èšç„¦å˜è“ */
            box-shadow: none !important;
        }

        /* 6. è¡¨æ ¼ï¼šæç®€é£ï¼Œå»ç«–çº¿ */
        table {
            border-collapse: separate !important;
            border-spacing: 0 !important;
        }
        thead th {
            background: transparent !important;
            border-bottom: 1px solid #e5e7eb !important;
            color: #64748b !important;
            font-size: 12px !important;
            text-transform: none !important;
            padding: 12px 8px !important;
        }
        /* æ‚¬æµ®è¡Œæ•ˆæœ */
        tbody tr {
            transition: background 0.1s !important;
            border-radius: 6px !important;
        }
        tbody tr:hover td {
            background-color: rgba(0, 0, 0, 0.03) !important; /* ææ·¡çš„ç° */
        }
        td {
            border-right: none !important; /* å»é™¤ç«–çº¿ */
            border-bottom: 1px solid #f1f5f9 !important;
            padding: 12px 8px !important;
        }
        /* ä¿®å¤é¦–åˆ—å†»ç»“çš„èƒŒæ™¯ */
        table th:first-child, table td:first-child {
            background: rgba(255,255,255,0.95) !important; 
            backdrop-filter: blur(10px);
        }

        /* 7. å¯¼èˆªæ ï¼šèƒ¶å›Šæ ·å¼ */
        .nav-wrapper {
            background: rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05) !important;
            border: 1px solid rgba(255,255,255,0.5) !important;
            padding: 5px !important;
        }
        .nav-categories {
            background: transparent !important;
            gap: 5px !important;
            padding: 5px !important;
        }
        .nav-cat-item {
            color: #666 !important;
            border-radius: 4px !important;
            border-bottom: none !important;
            padding: 8px 16px !important;
            background: transparent !important;
        }
        .nav-cat-item:hover {
            background-color: rgba(0,0,0,0.05) !important;
        }
        .nav-cat-item.active {
            background-color: #ffffff !important;
            color: #0067c0 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
            font-weight: 700 !important;
        }
        /* äºŒçº§å¯¼èˆªèƒ¶å›Š */
        .nav-link {
            border-radius: 20px !important;
            background: transparent !important;
            border: none !important;
        }
        .nav-link:hover {
            background: rgba(0,0,0,0.05) !important;
        }
        .nav-link.active {
            background: #0067c0 !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(0, 103, 192, 0.3) !important;
        }

        /* 8. å¼¹çª— Modalï¼šå±…ä¸­æ‚¬æµ®å¡ç‰‡ */
        .modal {
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(5px) !important; /* èƒŒæ™¯è™šåŒ– */
        }
        .modal-content {
            border: 1px solid rgba(255,255,255,0.8) !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2) !important;
            animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
        }
        @keyframes modalPop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* 9. æ»šåŠ¨æ¡ç¾åŒ– (Overlay Scrollbars) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* 10. ä¿®å¤å·¦ä¾§å¯¼èˆª (Side Nav) */
        .side-nav {
            background: rgba(255,255,255,0.6) !important;
            border: none !important;
        }
        .side-nav-link.active {
            background: rgba(0, 103, 192, 0.1) !important;
            color: #0067c0 !important;
            border-left: 3px solid #0067c0 !important;
        }

        /* 11. æ¶ˆæ¯æç¤º Toast */
        .toast-msg {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255,255,255,0.5) !important;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
        }

    /* ================== ã€ç»ˆæç‰ˆã€‘å…¨åŸŸæ²‰æµ¸å¼æ·±è‰²æ¨¡å¼ (Immersive Dark Mode) ================== */
    /* æ ¸å¿ƒé€»è¾‘ï¼šå¼ºåˆ¶å°†æ‰€æœ‰ç™½è‰²åŠé€æ˜å®¹å™¨æ”¹ä¸ºæ·±ç°åŠé€æ˜ï¼Œæ–‡å­—åç™½ */

    /* 1. æ•´ä½“èƒŒæ™¯ï¼šæ·±é‚ƒé»‘ */
    body.dark-mode {
        background-color: #0f0f0f !important;
        background-image: none !important; /* å»æ‰èŠ±å“¨èƒŒæ™¯ï¼Œä¿æŒçº¯å‡€æ·±è‰² */
        color: #e0e0e0 !important;
    }

    /* 2. æ ¸å¿ƒå®¹å™¨å˜é»‘ (å¡ç‰‡ã€å¤´éƒ¨ã€å¯¼èˆªã€å¼¹çª—ã€ä¾§è¾¹æ ) */
    body.dark-mode .card-box, 
    body.dark-mode .section, 
    body.dark-mode .nav-wrapper, 
    body.dark-mode .modal-content, 
    body.dark-mode .spotlight-box,
    body.dark-mode .side-nav, 
    body.dark-mode .control-panel,
    body.dark-mode .upload-box,
    body.dark-mode header,
    body.dark-mode .teacher-card,  /* æ•™å¸ˆå¡ç‰‡ */
    body.dark-mode .mob-card,      /* æ‰‹æœºç«¯å¡ç‰‡ */
    body.dark-mode .sub-header     /* å°æ ‡é¢˜æ  */
    {
        background: rgba(30, 30, 30, 0.85) !important; /* æ·±ç°è‰²èƒŒæ™¯ */
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.08) !important; /* æç»†çš„äº®è¾¹ */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6) !important; /* æ·±è‰²é˜´å½± */
        color: #e0e0e0 !important;
    }

    /* 3. å¼ºåˆ¶æ–‡å­—åç™½ */
    body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4,
    body.dark-mode p, body.dark-mode span, body.dark-mode label, 
    body.dark-mode div, body.dark-mode strong, body.dark-mode b,
    body.dark-mode .nav-cat-item, 
    body.dark-mode .side-nav-link {
        color: #e0e0e0 !important;
    }
    /* å¼±åŒ–æ¬¡è¦æ–‡å­— */
    body.dark-mode .text-gray, body.dark-mode small, body.dark-mode .nav-link {
        color: #a0a0a0 !important;
    }

    /* 4. è¾“å…¥æ¡†ã€ä¸‹æ‹‰æ¡†ï¼šæ·±ç°åº•ç™½å­— */
    body.dark-mode input, 
    body.dark-mode select, 
    body.dark-mode textarea {
        background-color: rgba(0, 0, 0, 0.4) !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        color: #fff !important;
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
        border-color: #3b82f6 !important; /* èšç„¦æ—¶äº®è“è¾¹ */
        background-color: rgba(0, 0, 0, 0.6) !important;
    }

    /* 5. æŒ‰é’®ï¼šå¾®è°ƒ */
    body.dark-mode .btn:not(.btn-primary):not(.btn-danger):not(.btn-success) {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #fff !important;
    }

    /* 6. è¡¨æ ¼ç‰¹æ®Šå¤„ç† */
    body.dark-mode thead th {
        background-color: rgba(45, 45, 45, 0.9) !important; /* è¡¨å¤´ç¨äº® */
        color: #ccc !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    body.dark-mode td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        color: #e0e0e0 !important;
    }
    /* å†»ç»“åˆ—èƒŒæ™¯å¿…é¡»å˜é»‘ï¼Œå¦åˆ™æ»šåŠ¨æ—¶ä¼šé€å‡ºæ–‡å­— */
    body.dark-mode table th:first-child, 
    body.dark-mode table td:first-child {
        background: #1e1e1e !important;
        border-right: 1px solid rgba(255,255,255,0.1) !important;
    }
    /* é¼ æ ‡æ‚¬åœè¡Œé«˜äº® */
    body.dark-mode tbody tr:hover td {
        background-color: rgba(255, 255, 255, 0.08) !important;
    }

    /* 7. å¯¼èˆªæ æ¿€æ´»çŠ¶æ€ */
    body.dark-mode .nav-cat-item.active,
    body.dark-mode .nav-link.active,
    body.dark-mode .side-nav-link.active {
        background-color: #3b82f6 !important; /* äº®è“è‰² */
        color: white !important;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.4) !important; /* å‘å…‰æ•ˆæœ */
    }
    
    /* 8. å»é™¤ç™½è‰²èƒŒæ™¯çš„è¡¥ä¸ */
    body.dark-mode .bg-gray-50, 
    body.dark-mode .bg-white {
        background-color: transparent !important;
    }

    /* ================== 3. å­—ä½“å±‚çº§ä¸é—´è·ä¼˜åŒ– (Typography & Spacing) ================== */
    
    /* A. å¢åŠ è¡¨æ ¼èˆ’é€‚åº¦ (Loose Display) */
    td, th {
        padding: 14px 12px !important; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©æ•°æ®ä¸æ‹¥æŒ¤ */
        font-size: 13px !important;    /* ç¨å¾®è°ƒå°å­—å·ï¼Œæ˜¾å¾—æ›´ç²¾è‡´ */
    }

    /* B. å¼ºè°ƒæ•°å­—åˆ—å­—ä½“ (Tabular Nums) */
    /* ä»ç¬¬3åˆ—å¼€å§‹é€šå¸¸æ˜¯æ•°å­—ï¼Œä½¿ç”¨ç­‰å®½å­—ä½“å¯¹é½æ›´æ•´é½ */
    td:nth-child(n+3) {
        font-family: "Cascadia Code", "Consolas", "Roboto Mono", "Menlo", monospace !important;
        letter-spacing: -0.5px; /* æ•°å­—ç¨å¾®ç´§å‡‘ä¸€ç‚¹ */
        font-feature-settings: "tnum"; /* å¼€å¯ç­‰å®½æ•°å­—ç‰¹æ€§ */
    }

    /* C. æ¨¡å—æ ‡é¢˜å¢åŠ å‘¼å¸æ„Ÿ */
    .sec-head {
        margin-bottom: 25px !important;
        padding-bottom: 15px !important;
        border-bottom-width: 1px !important; /* ç»†çº¿æ›´ç°ä»£ */
    }

    /* D. ä¼˜åŒ–å¡ç‰‡å†…é—´è· */
    .card-box, .section {
        padding: 25px !important; /* åŠ å¤§å¡ç‰‡å†…è¾¹è· */
    }
    
    /* E. ä¼˜åŒ–ç»Ÿè®¡æ•°å­—å­—é‡ */
    .stat-value, .fb-val, .total-val {
        font-weight: 700 !important;
        letter-spacing: -1px !important; /* å¤§æ•°å­—ç´§å‡‘æ›´å…·å¼ åŠ› */
    }

    /* ================== 4. éª¨æ¶å±åŠ è½½æ•ˆæœ (Skeleton Loading) ================== */
    
    /* A. å®šä¹‰å¾®å…‰æµä½“åŠ¨ç”» (Shimmer Animation) */
    @keyframes skeleton-shimmer {
        0% { background-position: 100% 50%; }
        100% { background-position: 0 50%; }
    }

    /* B. è¡¨æ ¼åŠ è½½æ€å®¹å™¨ */
    /* å½“ç»™ table æˆ– div åŠ ä¸Š class="loading-mask" æ—¶è§¦å‘ */
    .loading-mask {
        position: relative;
        pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
        min-height: 200px;
    }

    /* C. è¦†ç›–åœ¨å†…å®¹ä¸Šçš„éª¨æ¶å±‚ */
    .loading-mask::after {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10;
        /* æµ…è‰²æ¨¡å¼ä¸‹çš„éª¨æ¶èƒŒæ™¯ï¼šç°ç™½ç›¸é—´æµå…‰ */
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.8) 20%,
            rgba(240, 240, 240, 0.9) 50%,
            rgba(255, 255, 255, 0.8) 80%,
            rgba(255, 255, 255, 0) 100%
        );
        background-size: 200% 100%;
        animation: skeleton-shimmer 1.5s infinite linear;
        backdrop-filter: blur(2px); /* è½»å¾®æ¨¡ç³Šåº•å±‚æ–‡å­— */
        border-radius: 8px;
    }

    /* D. é’ˆå¯¹è¡¨æ ¼è¡Œçš„æ¡çº¹éª¨æ¶ (æ›´é€¼çœŸ) */
    /* è‡ªåŠ¨åŒ¹é…ç©ºè¡¨æ ¼æˆ–åŠ è½½ä¸­çš„è¡¨æ ¼ */
    .loading-mask tbody tr td {
        position: relative;
        color: transparent !important; /* éšè—çœŸå®æ–‡å­— */
    }
    .loading-mask tbody tr td::before {
        content: "";
        position: absolute;
        top: 12px; bottom: 12px; left: 10px; right: 10px;
        background: #e2e8f0;
        border-radius: 4px;
        /* éª¨æ¶æ¡çš„å¾®å…‰æ•ˆæœ */
        background-image: linear-gradient(
            90deg, 
            rgba(255,255,255, 0) 0, 
            rgba(255,255,255, 0.5) 20%, 
            rgba(255,255,255, 0.8) 60%, 
            rgba(255,255,255, 0) 
        );
        background-size: 200% 100%;
        animation: skeleton-shimmer 2s infinite linear;
    }

    /* E. æ·±è‰²æ¨¡å¼é€‚é… (Dark Mode Skeleton) */
    body.dark-mode .loading-mask::after {
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æµå…‰ï¼šæ·±ç°åˆ°é»‘ */
        background: linear-gradient(
            90deg,
            rgba(30, 30, 30, 0) 0%,
            rgba(50, 50, 50, 0.5) 50%,
            rgba(30, 30, 30, 0) 100%
        );
    }
    body.dark-mode .loading-mask tbody tr td::before {
        background: #2d2d2d; /* æ·±è‰²éª¨æ¶æ¡åº•è‰² */
        background-image: linear-gradient(
            90deg, 
            rgba(255,255,255, 0) 0, 
            rgba(255,255,255, 0.05) 50%, 
            rgba(255,255,255, 0) 
        );
    }
    /* ================== 5. ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªè´¨æ„Ÿå¢å¼º (Mobile Glassmorphism) ================== */
    @media screen and (max-width: 768px) {
        .mob-bottom-nav {
            background: rgba(255, 255, 255, 0.85) !important; /* é«˜é€ç™½ */
            backdrop-filter: blur(20px) saturate(180%) !important; /* iOS é£æ ¼æ¯›ç»ç’ƒ */
            -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
            border-top: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05) !important;
            /* é€‚é…å…¨é¢å±åº•éƒ¨æ¨ªæ¡ (Safe Area) */
            padding-bottom: max(10px, env(safe-area-inset-bottom)) !important; 
            height: auto !important;
            min-height: 65px;
            z-index: 99999 !important; /* ç¡®ä¿æœ€é¡¶å±‚ */
        }

        .mob-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.6;
            padding-top: 8px;
        }

        .mob-nav-item.active {
            color: #0067c0 !important;
            opacity: 1;
            transform: translateY(-2px); /* é€‰ä¸­å¾®æµ®åŠ¨ */
        }

        /* é€‰ä¸­æ—¶å›¾æ ‡åŠ ä¸ªèƒ¶å›Šå¾®å…‰èƒŒæ™¯ */
        .mob-nav-item.active i {
            background: rgba(0, 103, 192, 0.1);
            border-radius: 16px;
            padding: 6px 20px;
            margin-bottom: 2px;
            transition: 0.3s;
        }

        /* --- æ·±è‰²æ¨¡å¼é€‚é… (Dark Mode Mobile Nav) --- */
        body.dark-mode .mob-bottom-nav {
            background: rgba(30, 30, 30, 0.85) !important;
            border-top-color: rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5) !important;
        }
        
        body.dark-mode .mob-nav-item {
            color: #a0a0a0 !important;
        }

        body.dark-mode .mob-nav-item.active {
            color: #3b82f6 !important;
        }
        
        body.dark-mode .mob-nav-item.active i {
            background: rgba(59, 130, 246, 0.25);
            color: #ffffff !important;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }
    }
    </style>
</head>
<body>

    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="global-loader" class="hidden">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">ç³»ç»Ÿæ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</div>
    </div>

    <!-- âœ‹ ğŸ”´ [å·²ç§»é™¤]ï¼šåˆ é™¤äº† mobile-lite-interface æ•´ä¸ªå®¹å™¨ï¼Œæ‰‹æœºè®¿é—®å°†ç›´æ¥æ˜¾ç¤ºä¸‹æ–¹çš„ä¸»ç•Œé¢ ğŸ”´ -->

    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:50000; display:flex; align-items:center; justify-content:center; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;">
        <div style="background:white; padding:40px; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width:100%; max-width:420px; border:1px solid #e5e7eb;">
            <div style="text-align:center; margin-bottom:30px;">
                <h1 style="color:var(--primary); font-size:24px; font-weight:800; margin-bottom:5px;">æ™ºæ…§æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ</h1>
                <p style="color:#64748b; font-size:14px;">ç»Ÿä¸€èº«ä»½è®¤è¯å…¥å£</p>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <div id="login-form">
                
                <!-- 1. ç”¨æˆ·åè¾“å…¥æ¡† -->
                <div class="form-group">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">
                        è´¦å· / å§“å
                    </label>
                    <input type="text" id="login-user" placeholder="ç®¡ç†å‘˜è´¦å· / æ•™å¸ˆå§“å / å­¦ç”Ÿå§“å" 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <!-- 2. ç­çº§è¾“å…¥æ¡† (æ”¹ä¸ºå§‹ç»ˆæ˜¾ç¤ºï¼Œä½†åœ¨ JS é‡Œåˆ¤æ–­é€»è¾‘) -->
                <div class="form-group" style="margin-top:15px;">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">
                        ç­çº§ <span style="color:#f59e0b; font-weight:normal; font-size:11px;">(æ•™èŒå·¥ç•™ç©ºï¼Œå®¶é•¿å¿…å¡«å¦‚:701)</span>
                    </label>
                    <input type="text" id="login-class" placeholder="è¯·è¾“å…¥ç­çº§ (ä»…å®¶é•¿/å­¦ç”Ÿå¿…å¡«)" 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <!-- 3. å¯†ç è¾“å…¥æ¡† -->
                <div class="form-group" style="margin-top:15px;">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">å¯†ç </label>
                    <input type="password" id="login-pass" placeholder="è¾“å…¥å¯†ç " 
                           style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                           onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <button onclick="Auth.login()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:6px; font-size:16px; font-weight:bold; margin-top:25px; cursor:pointer; transition:0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    ç«‹å³ç™»å½•
                </button>
                
                <!-- å·²æ·»åŠ  display:none éšè—é»˜è®¤æç¤º -->
                <div style="display:none; text-align:center; margin-top:15px; font-size:12px; color:#94a3b8; line-height: 1.6;">
                    ç®¡ç†å‘˜é»˜è®¤: admin / admin123<br>
                    å…¶ä»–è§’è‰²é»˜è®¤å¯†ç : 123456
                </div>
            </div>
        </div>

        <!-- çºµå‘æˆé•¿æ¡£æ¡ˆ (Cohort Growth) -->
        <div id="cohort-growth" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-timeline"></i> çºµå‘æˆé•¿æ¡£æ¡ˆ <span class="badge" style="background:#0ea5e9;">ğŸ“ˆ ç­ä¸»ä»»å¿…çœ‹</span></h3>
                <p><strong>ä¸€å¥è¯ç›®çš„ï¼š</strong>åŸºäºå±Šåˆ«IDæ„å»ºå­¦ç”Ÿæˆé•¿æ›²çº¿ä¸ç¨³å®šæ€§ç”»åƒã€‚</p>
                <p><strong>æ¨èé¡ºåºï¼š</strong>å®Œæˆå¤šæ¬¡è€ƒè¯•å¯¼å…¥åä½¿ç”¨ã€‚</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-timeline"></i> æˆé•¿è½¨è¿¹ä¸ç¨³å®šæ€§åˆ†æ</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-purple" onclick="CohortGrowth.render()">ğŸ” ç”Ÿæˆæˆé•¿æ¡£æ¡ˆ</button>
                    <button class="btn btn-gray" onclick="CohortGrowth.exportVolatility()">ğŸ“¥ å¯¼å‡ºæ³¢åŠ¨åå•</button>
                </div>
            </div>
            <div class="info-bar">
                <span>åŸºäºå±Šåˆ«å†å²è€ƒè¯•ï¼Œè®¡ç®— $Z$ åˆ†æ•°æ³¢åŠ¨ç‡ã€æ’åç™¾åˆ†ä½å˜åŒ–ã€‚</span>
                <span style="margin-left:auto; font-size:12px;">å»ºè®®è‡³å°‘ 4 æ¬¡è€ƒè¯•æ•°æ®</span>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="card-box" style="border-left:4px solid #38bdf8; background:#f0f9ff;">
                    <div class="sub-header">ğŸŒŠ Z-Score æ³¢åŠ¨ç‡ (ç¨³å®šæ€§)</div>
                    <div class="table-wrap">
                        <table id="cohort-volatility-table">
                            <thead><tr><th>å§“å</th><th>ç­çº§</th><th>è€ƒè¯•æ¬¡æ•°</th><th>æ³¢åŠ¨ç‡(Ïƒ)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-box" style="border-left:4px solid #22c55e; background:#f0fdf4;">
                    <div class="sub-header">ğŸš€ æ’åç™¾åˆ†ä½æˆé•¿ (é¦–å°¾å¯¹æ¯”)</div>
                    <div class="table-wrap">
                        <table id="cohort-growth-table">
                            <thead><tr><th>å§“å</th><th>ç­çº§</th><th>èµ·å§‹ç™¾åˆ†ä½</th><th>æœ€æ–°ç™¾åˆ†ä½</th><th>å˜åŒ–</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- å±Šåˆ«å…¥å£å¼¹çª— -->
    <div id="mode-mask">
        <div class="mode-box">
            <h2 style="color:var(--primary); margin-bottom:15px; font-size:24px;">ğŸ“‚ è¿›å…¥å±Šåˆ«æ¡£æ¡ˆ</h2>
            <p style="color:#64748b;">ä»¥â€œå…¥å­¦å¹´ä»½â€ä¸ºä¸»çº¿å»ºç«‹å®Œæ•´æˆé•¿å‘¨æœŸï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…å¹´çº§ä¸æ ¸ç®—æ¨¡å¼</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                <input id="entry-cohort-year" type="number" min="2000" max="2100" placeholder="å…¥å­¦å¹´ä»½ (å¦‚ 2022)" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; width:200px;">
                <button class="btn btn-primary" onclick="enterCohortFromMask()">è¿›å…¥å±Šåˆ«</button>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#64748b;">å·²æœ‰å±Šåˆ«å¯åœ¨é¡¶éƒ¨ä¸‹æ‹‰ç›´æ¥åˆ‡æ¢</div>
        </div>
    </div>

    <!-- æ‰‹æœºç«¯ç®¡ç†ä¸»ç•Œé¢ (é»˜è®¤éšè—ï¼Œé€šè¿‡ JS æ¿€æ´») -->
    <div id="mobile-manager-app">
        <!-- 1. é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="mob-header-bar">
            <div class="mob-header-title" id="mob-page-title">ğŸ“± æ•™åŠ¡å·¥ä½œå°</div>
            <div onclick="Auth.logout()" style="color:#ef4444; font-size:12px; font-weight:bold; cursor: pointer;">é€€å‡º</div>
        </div>

        <!-- 2. å†…å®¹åŒºåŸŸ (é€šè¿‡ JS åˆ‡æ¢æ˜¾ç¤º) -->
        
        <!-- A. é¦–é¡µ/æ¦‚è§ˆ -->
        <div id="mob-view-home" class="mob-view active">
            <div style="background: linear-gradient(135deg, #4f46e5, #818cf8); border-radius: 12px; padding: 20px; color: white; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 12px; opacity: 0.8;">å½“å‰ç™»å½•</div>
                <div style="font-size: 24px; font-weight: bold; margin: 5px 0;" id="mob-user-name">è€å¸ˆ</div>
                <div style="font-size: 12px; background: rgba(255,255,255,0.2); display: inline-block; padding: 2px 10px; border-radius: 20px;" id="mob-user-role">ç§‘ä»»æ•™å¸ˆ</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div class="mob-list-item" style="flex-direction: column; align-items: center; text-align: center; padding: 15px;" onclick="MobMgr.switchTab('students')">
                    <div class="mob-avatar" style="background: #dbeafe; color: #2563eb;"><i class="ti ti-users"></i></div>
                    <div style="font-weight: bold; margin-top: 5px;">å­¦ç”Ÿç®¡ç†</div>
                </div>
                <div class="mob-list-item" style="flex-direction: column; align-items: center; text-align: center; padding: 15px;" onclick="MobMgr.switchTab('analysis')">
                    <div class="mob-avatar" style="background: #fef3c7; color: #d97706;"><i class="ti ti-chart-bar"></i></div>
                    <div style="font-weight: bold; margin-top: 5px;">æˆç»©åˆ†æ</div>
                </div>
            </div>
            
            <div style="background: white; border-radius: 12px; padding: 15px;">
                <h4 style="margin-bottom: 10px; color: #334155;">ğŸ“¢ ç³»ç»Ÿå…¬å‘Š</h4>
                <div style="font-size: 12px; color: #64748b; line-height: 1.6;">
                    æ¬¢è¿ä½¿ç”¨ç§»åŠ¨ç«¯ç®¡ç†ç³»ç»Ÿã€‚ç›®å‰æ”¯æŒæŸ¥çœ‹å­¦ç”Ÿåå•ã€å¿«é€ŸæŸ¥è¯¢æˆç»©ä»¥åŠåŸºç¡€çš„æ•°æ®åˆ†æåŠŸèƒ½ã€‚æ›´å¤šé«˜çº§åŠŸèƒ½è¯·ç™»å½• PC ç«¯æ“ä½œã€‚
                </div>
            </div>
        </div>

        <!-- B. å­¦ç”Ÿåˆ—è¡¨ -->
        <div id="mob-view-students" class="mob-view">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="mob-search-input" placeholder="ğŸ” æœå§“å/è€ƒå·..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" oninput="MobMgr.renderStudentList()">
            </div>
            <div id="mob-student-list" class="mob-list-container" style="padding: 0;">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ—è¡¨ -->
                <div style="text-align: center; color: #999; padding: 20px;">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- C. ç®€æŠ¥åˆ†æ -->
        <div id="mob-view-analysis" class="mob-view">
            <div class="mob-list-item" style="display: block; padding: 15px;">
                <h3 style="margin-bottom: 15px; border-left: 4px solid #4f46e5; padding-left: 8px; font-size: 16px;">ğŸ“Š å¿«é€Ÿæ¦‚è§ˆ</h3>
                <div id="mob-analysis-content">
                    <p style="color: #999; text-align: center;">è¯·å…ˆåœ¨ PC ç«¯ä¸Šä¼ å¹¶å¤„ç†æ•°æ®...</p>
                </div>
            </div>
        </div>

        <!-- 3. åº•éƒ¨å¯¼èˆªæ  -->
        <div class="mob-bottom-bar">
            <button class="mob-nav-btn active" onclick="MobMgr.switchTab('home')">
                <i class="ti ti-home"></i>
                <span>é¦–é¡µ</span>
            </button>
            <button class="mob-nav-btn" onclick="MobMgr.switchTab('students')">
                <i class="ti ti-users"></i>
                <span>å­¦ç”Ÿ</span>
            </button>
            <button class="mob-nav-btn" onclick="MobMgr.switchTab('analysis')">
                <i class="ti ti-chart-pie"></i>
                <span>åˆ†æ</span>
            </button>
        </div>
    </div>


    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="watermark-layer" aria-hidden="true"></div>
    <div class="container hidden" id="app">
        <header id="main-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Logo å®¹å™¨ (é»˜è®¤éšè—ï¼Œä¸Šä¼ åæ˜¾ç¤º) -->
                <img id="custom-logo-img" src="" loading="lazy" decoding="async" style="display:none; height: 60px; width: auto; border-radius: 6px; background: rgba(255,255,255,0.95); padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" alt="æ ¡å¾½">
                
                <!-- æ ‡é¢˜æ–‡å­—åŒºåŸŸ -->
                <div style="flex: 1;">
                    <h1 id="app-title" style="margin:0; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">ä¹¡é•‡å­¦æ ¡æˆç»©åˆ†æä¸æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ <span id="mode-badge" class="badge"></span></h1>
                    <p id="app-subtitle" style="margin:5px 0 0 0; opacity: 0.9; font-size: 13px;">é›†æˆï¼šä¹¡é•‡å­¦æ ¡æ¨ªå‘å¯¹æ¯” Â· æ•™å¸ˆæ•™å­¦æ·±åº¦åˆ†æ Â· åç§‘æŒ–æ˜ Â· è€ƒåŠ¡ç¼–æ’</p>
                </div>

                <!-- å³ä¸Šè§’å·¥å…·æ  -->
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="cohort-selector" onchange="CohortManager.switchTo(this.value)" 
                            style="background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); padding:5px; border-radius:4px; font-size:14px; font-weight:bold; cursor:pointer; outline:none;">
                        <option value="" style="color:#333">ğŸ“‚ è¯·é€‰æ‹©å±Šåˆ«</option>
                    </select>
                    <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white;" onclick="scrollToAnchor('upload', this)" title="å‰å¾€å±Šåˆ«ç®¡ç†">
                        <i class="ti ti-users-group"></i> å±Šåˆ«
                    </button>
                    <div id="admin-msg-btn" class="notification-btn" style="display:none;" onclick="IssueManager.openAdminPanel()">
                        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white;" title="æŸ¥çœ‹ç”³è¯‰åé¦ˆ">
                            <i class="ti ti-bell"></i>
                        </button>
                        <div id="msg-badge" class="notification-badge hidden">0</div>
                    </div>
                    <!-- æ³¨æ„ï¼šæ­¤æŒ‰é’®é»˜è®¤é€šè¿‡ CSS #admin-panel-btn {display:none} éšè—ï¼Œåªæœ‰ body[data-role="admin"] æ—¶æ‰æ˜¾ç¤º -->
                    <button class="btn" id="admin-panel-btn" onclick="document.getElementById('admin-modal').style.display='flex'" 
                            style="background:#b91c1c; color:white; border:1px solid rgba(255,255,255,0.4); display:none;">
                        <i class="ti ti-settings"></i> è´¦å·ç®¡ç†
                    </button>
                    <button class="btn" id="btn-cloud-rollback" onclick="openCloudRollback()" title="ç®¡ç†å‘˜ä¸“ç”¨ï¼šæ‰“å¼€äº‘ç«¯å¿«ç…§å›æ»š" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; display:none;">
                        <i class="ti ti-rotate"></i> äº‘ç«¯å›æ»š
                    </button>
                    <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); backdrop-filter:blur(5px); color:white;" onclick="HelpSystem.startTour()" title="æ–°æ‰‹å¼•å¯¼">
                        <i class="ti ti-help-circle"></i> æ•™ç¨‹
                    </button>
                    <!-- [æ–°å¢] å¤–è§‚è®¾ç½®æŒ‰é’® -->
                    <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); backdrop-filter:blur(5px); color:white;" onclick="openSkinModal()" title="è‡ªå®šä¹‰å¤–è§‚">
                        <i class="ti ti-palette"></i> å¤–è§‚è®¾ç½®
                    </button>
                    
                    <!-- æ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
                    <button class="btn" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.2); padding: 6px 10px;" onclick="toggleDarkMode()" title="åˆ‡æ¢æ·±è‰²æ¨¡å¼">
                        <i class="ti ti-moon"></i>
                    </button>
                    <!-- å…¨å±€æœç´¢æç¤ºæŒ‰é’® -->
                    <div style="color:rgba(255,255,255,0.9); font-size:12px; border:1px solid rgba(255,255,255,0.3); padding:6px 12px; border-radius:6px; cursor:pointer; background: rgba(0,0,0,0.1);" onclick="openSpotlight()">
                        <i class="ti ti-search"></i> æœç´¢
                    </div>
                                        
                    <button class="btn" id="btn-guest-mode" onclick="toggleGuestMode()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; font-size:12px; padding:5px 10px; margin-left:5px;" title="ä¸ä¿å­˜ä»»ä½•æ•°æ®ï¼Œå…³é—­å³æ¶ˆå¤±">
                        <i class="ti ti-flame"></i> é˜…åå³ç„š
                    </button>
                </div>
            </div>
        </header>

        <!-- åŒå±‚é¡¶éƒ¨å¯¼èˆªèœå• -->
        <div class="nav-wrapper">
            <div class="nav-categories" id="navCategories"></div>
            <div class="nav-sub-items" id="navSubItems"></div>
        </div>

        <!-- 1. æ•°æ®ä¸Šä¼  & é¡¹ç›®ç®¡ç† -->
        <div id="upload" class="section active card-box">
            <div class="module-desc-bar" style="border-color: var(--color-data)">
                <h3><i class="ti ti-database-import"></i> 01 æ•°æ®æ¢çº½ä¸­å¿ƒ <span class="badge" style="background:#16a34a;">â­ æ•™åŠ¡å¸¸ç”¨</span></h3>
                <p><strong>ä¸€å¥è¯ç›®çš„ï¼š</strong>å¯¼å…¥å¹¶è§„èŒƒåŒ–æˆç»©æ•°æ®ï¼Œå»ºç«‹åˆ†æåŸºç¡€ã€‚</p>
                <p><strong>æ¨èé¡ºåºï¼š</strong>ç¬¬1æ­¥ï¼ˆå¯¼å…¥æ•°æ®ï¼‰â†’ ç¬¬2æ­¥ï¼ˆç”Ÿæˆåˆ†æï¼‰â†’ ç¬¬3æ­¥ï¼ˆå¯¼å‡ºç»“æœï¼‰ã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-file-upload"></i> æ•°æ®æ–‡ä»¶ä¸Šä¼  
                    <span class="module-help-btn" onclick="showModuleHelp('upload')">ğŸ“˜ ä½¿ç”¨è¯´æ˜</span>
                </h2>
                <div style="margin-left: auto;">
                    <button class="btn btn-orange" onclick="runDataDoctor()">
                        <i class="ti ti-stethoscope"></i> æ•°æ®ä½“æ£€
                    </button>
                </div>
            </div>
            <div class="info-bar"><span>å½“å‰æ¨¡å¼ï¼š<strong id="mode-info"></strong>ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨è¿‡æ»¤æ— å…³æ•°æ®ã€‚</span></div>
            <div class="card-box" style="border-left:4px solid #7c3aed; background:#f5f3ff; margin-top:10px;">
                <div class="sec-head" style="border-bottom-color:#ddd6fe; margin-bottom:10px;">
                    <h2 style="color:#5b21b6;"><i class="ti ti-users-group"></i> å±Šåˆ«ç®¡ç† (Cohort)</h2>
                    <div style="font-size:12px; color:#6b7280;">ä»¥â€œå…¥å­¦å¹´ä»½â€ä¸ºä¸»è½´ï¼Œè´¯ç©¿ä¸‰å¹´æˆé•¿æ¡£æ¡ˆ</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <input id="cohort-year" type="number" min="2000" max="2100" placeholder="å…¥å­¦å¹´ä»½ (å¦‚ 2022)" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; width:180px;">
                    <button class="btn btn-purple" onclick="CohortManager.addFromUI()">â• æ–°å»ºå±Šåˆ«</button>
                    <button class="btn btn-gray" onclick="resetCohortSelection()">â†© é‡æ–°é€‰æ‹©å±Šåˆ«</button>
                    <span id="cohort-status" style="font-size:12px; color:#64748b;"></span>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569;">
                    å½“å‰å±Šåˆ«ï¼š<strong id="cohort-current-label">æœªé€‰æ‹©</strong>
                </div>
            </div>
            <div class="card-box" style="border-left:4px solid #0ea5e9; background:#f0f9ff; margin-top:10px;">
                <div class="sec-head" style="border-bottom-color:#bae6fd; margin-bottom:10px;">
                    <h2 style="color:#0369a1;"><i class="ti ti-archive"></i> è€ƒè¯•æ‰¹æ¬¡ / å­¦æœŸæ¡£æ¡ˆåŒ–</h2>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span id="exam-archive-status" style="font-size:12px; color:#64748b;">æœªå°å­˜</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <span style="font-size:12px; color:#475569;">å±Šåˆ«ï¼š</span>
                    <span id="exam-cohort-label" style="font-size:12px; font-weight:bold; color:#1e3a8a;">æœªé€‰æ‹©</span>
                    <select id="exam-year" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="2025-2026">2025-2026</option>
                        <option value="2026-2027">2026-2027</option>
                        <option value="2027-2028">2027-2028</option>
                    </select>
                    <select id="exam-term" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="ä¸Šå­¦æœŸ">ä¸Šå­¦æœŸ</option>
                        <option value="ä¸‹å­¦æœŸ">ä¸‹å­¦æœŸ</option>
                    </select>
                    <select id="exam-type" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="æœˆè€ƒ">æœˆè€ƒ</option>
                        <option value="æœŸä¸­">æœŸä¸­</option>
                        <option value="æœŸæœ«">æœŸæœ«</option>
                        <option value="æ¨¡æ‹Ÿ">æ¨¡æ‹Ÿ</option>
                    </select>
                    <input id="exam-date" type="date" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="exam-name" type="text" placeholder="è€ƒè¯•åç§°(å¯é€‰)" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; width:200px;">
                    <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#475569;">
                        <input type="checkbox" id="exam-reset-point"> æœ¬æ¬¡è€ƒè¯•ç»å†é‡æ–°åˆ†ç­
                    </label>
                    <span style="font-size:12px; color:#475569;">æœ¬æ¬¡å¹´çº§ï¼š</span>
                    <strong id="exam-grade-label" style="font-size:12px; color:#1e3a8a;">-</strong>
                    <button class="btn btn-primary" onclick="setCurrentExamMeta()">è®¾ä¸ºå½“å‰è€ƒè¯•</button>
                    <button class="btn btn-orange" onclick="archiveCurrentExam()">ä¸€é”®å°å­˜æœ¬æ¬¡è€ƒè¯•</button>
                    <button class="btn btn-gray" onclick="unlockArchive()">è§£é™¤å°å­˜</button>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569;">
                    å½“å‰è€ƒè¯•IDï¼š<strong id="exam-key-display">æœªè®¾ç½®</strong>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    å†å²è€ƒè¯•ï¼š
                    <select id="exam-history-select" style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;"></select>
                    <button class="btn btn-sm btn-gray" onclick="CohortDB.loadExamFromSelect()">åˆ‡æ¢åˆ°è¯¥è€ƒè¯•</button>
                </div>
            </div>
            <div style="background: #f0fdf4; border: 1px dashed #86efac; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="font-weight: bold; color: #166534; display: flex; align-items: center; gap: 5px;">
                    <i class="ti ti-template"></i> æ–°æ‰‹å¿…è¯»ï¼šæ ‡å‡†æ¨¡æ¿ä¸‹è½½
                </div>
                <div style="flex: 1; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-sm" style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;" onclick="downloadTemplate('primary')">
                        <i class="ti ti-download"></i> å°å­¦æœŸæœ«æ¨¡æ¿
                    </button>
                    <button class="btn btn-sm" style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;" onclick="downloadTemplate('junior')">
                        <i class="ti ti-download"></i> åˆä¸­æœˆè€ƒæ¨¡æ¿ (7-8å¹´çº§)
                    </button>
                    <button class="btn btn-sm" style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;" onclick="downloadTemplate('grade9')">
                        <i class="ti ti-download"></i> ä¸­è€ƒä¸€æ¨¡æ¨¡æ¿ (9å¹´çº§)
                    </button>
                    <button class="btn btn-sm" style="background: white; color: #0369a1; border: 1px solid #0369a1; font-size: 12px;" onclick="downloadTemplate('teacher')">
                        <i class="ti ti-id"></i> æ•™å¸ˆä»»è¯¾å¯¼å…¥æ¨¡æ¿
                    </button>
                </div>
            </div>
            <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon"><i class="ti ti-cloud-upload"></i></div>
                <p style="font-size:18px; margin-bottom:10px; font-weight:600;">ç‚¹å‡»ä¸Šä¼ æˆç»© Excel æ–‡ä»¶</p>
                <p style="color:#94a3b8;">æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼  (.xlsx, .xls)</p>
                <input type="file" id="fileInput" multiple accept=".xlsx,.xls" hidden>
            </div>
            
            <!-- [æ–°å¢] å±Šåˆ«å¿«ç…§ç®¡ç†åŒºåŸŸ -->
            <div class="control-panel" style="background: #eff6ff; border-color: #bfdbfe; margin-top: 15px;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 5px 0; color: var(--primary); font-size: 15px;">
                        ğŸ’¾ å±Šåˆ«çŠ¶æ€ç®¡ç† <span id="auto-backup-status" style="font-size:11px; color:#64748b; font-weight:normal; margin-left:10px;"></span>
                    </h3>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">ä¿å­˜å½“å‰å±Šåˆ«æ‰€æœ‰è¿›åº¦ï¼ˆå«æˆç»©ã€æ•™å¸ˆè®¾ç½®ã€æ’åº§ã€åˆ†ç­ç»“æœï¼‰ï¼Œä¸‹æ¬¡å¯ç›´æ¥æ¢å¤ã€‚</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="btn-save-project" onclick="saveProjectSnapshot()">
                        <i class="ti ti-download"></i> ä¿å­˜é¡¹ç›® (.json)
                    </button>
                    <button class="btn btn-orange" id="btn-load-project" onclick="document.getElementById('projectFileInput').click()">
                        <i class="ti ti-upload"></i> æ¢å¤é¡¹ç›®
                    </button>
                    <input type="file" id="projectFileInput" accept=".json" hidden onchange="loadProjectSnapshot(this)">
                    <button class="btn btn-danger" id="btn-reset-system" onclick="resetSystem()" style="background: #dc2626; color: white;">
                        <i class="ti ti-trash"></i> æ¸…ç©ºé‡ç½®
                    </button>
                </div>
            </div>

            <div class="control-panel" id="auto-snapshot-panel" style="background:#fff7ed; border-color:#fed7aa; margin-top:10px;">
                <div style="flex:1;">
                    <h3 style="margin:0 0 5px 0; color:#b45309; font-size:15px;">
                        ğŸ•˜ è‡ªåŠ¨å¿«ç…§ / å›æ»š
                    </h3>
                    <p style="font-size:12px; color:#64748b; margin:0;">æ¯æ¬¡ä¿å­˜å‰è‡ªåŠ¨ä¿ç•™æœ€è¿‘ 5 ç‰ˆï¼Œå¯ä¸€é”®å›æ»šã€‚</p>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn btn-sm btn-orange" onclick="createAutoSnapshot(getCurrentSnapshotPayload())">æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§</button>
                </div>
                <div id="auto-snapshot-list" style="width:100%; margin-top:8px; font-size:12px; color:#7c2d12;"></div>
            </div>

            <div class="card-box" style="border-left: 4px solid #2563eb; background: #eff6ff; margin-top: 15px;">
                <div class="sec-head" style="border-bottom-color: #bfdbfe; margin-bottom: 10px;">
                    <h2 style="color: #1e3a8a;"><i class="ti ti-id"></i> æ•™å¸ˆä»»è¯¾ä¿¡æ¯é…ç½®</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-sm" style="background:white; color:#2563eb; border:1px solid #2563eb;" onclick="downloadTemplate('teacher')">
                            <i class="ti ti-download"></i> ä¸‹è½½æ¨¡æ¿
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('teacherFileInput').click()">
                            <i class="ti ti-file-import"></i> å¯¼å…¥ä»»è¯¾è¡¨
                        </button>
                        <input type="file" id="teacherFileInput" accept=".xlsx,.xls" hidden onchange="importTeacherExcel()">
                    </div>
                </div>
                
                <div style="margin-bottom:10px; font-size:12px; color:#64748b;">
                    <i class="ti ti-info-circle"></i> è¯´æ˜ï¼šè¯·å…ˆåœ¨ä¸Šæ–¹<strong>â€œé€‰æ‹©æœ¬æ ¡â€</strong>ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ—å‡ºæœ¬æ ¡æ‰€æœ‰ç­çº§å’Œç§‘ç›®ã€‚æ‚¨å¯ä»¥æ‰‹åŠ¨è¾“å…¥æ•™å¸ˆå§“åï¼Œæˆ–ä½¿ç”¨Excelå¯¼å…¥ã€‚
                </div>
                
                <div id="teacherInputsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 20px;">
                        (è¯·å…ˆåœ¨é¡¶éƒ¨å·¥å…·æ é€‰æ‹©â€œæœ¬æ ¡â€ä»¥åŠ è½½ç­çº§)
                    </div>
                </div>
            </div>

                    
            <div class="card-box" style="border-left: 4px solid #10b981; background: #ecfdf5; margin-top: 20px;">
                <div class="sec-head" style="border-bottom-color: #a7f3d0; margin-bottom: 10px;">
                    <h2 style="color: #047857;"><i class="ti ti-robot"></i> AI æ™ºèƒ½åŠ©æ‰‹é…ç½® (LLM)</h2>
                </div>
                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #a7f3d0;">
                    <label style="font-weight:bold; color:#065f46; margin-right:15px;">ğŸ¤– é€‰æ‹© AI å¼•æ“ï¼š</label>
                    <label style="margin-right:15px; cursor:pointer;">
                        <input type="radio" name="ai_source" value="cloud" checked onchange="toggleAISource()"> â˜ï¸ äº‘ç«¯ API (DeepSeek/OpenAI)
                    </label>
                    <label style="cursor:pointer;">
                        <input type="radio" name="ai_source" value="local" onchange="toggleAISource()"> ğŸ’» æœ¬åœ°æ¨¡å‹ (WebLLM/å…è´¹/éœ€æ˜¾å¡)
                    </label>
                </div>

                <!-- äº‘ç«¯é…ç½®åŒº -->
                <div id="ai-config-cloud" style="display:flex; gap:15px; flex-wrap:wrap; align-items:flex-end;">
                    <div style="flex:1; min-width:200px;">
                        <label style="font-size:12px; font-weight:bold; color:#065f46;">API Key (å¯†é’¥):</label>
                        <input type="password" id="llm_apikey" placeholder="sk-..." value="" style="width:100%; border-color:#34d399;">
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label style="font-size:12px; font-weight:bold; color:#065f46;">Base URL:</label>
                        <input type="text" id="llm_baseurl" placeholder="https://api.deepseek.com" value="https://api.deepseek.com" style="width:100%; border-color:#34d399;">
                    </div>
                    <div style="flex:0.5; min-width:150px;">
                        <label style="font-size:12px; font-weight:bold; color:#065f46;">Model Name:</label>
                        <input type="text" id="llm_model" placeholder="deepseek-chat" value="deepseek-chat" style="width:100%; border-color:#34d399;">
                    </div>
                    <button class="btn" style="background:#059669; color:white; height:38px;" onclick="saveLLMConfig()">
                        <i class="ti ti-device-floppy"></i> ä¿å­˜é…ç½®
                    </button>
                </div>

                <!-- æœ¬åœ°é…ç½®åŒº (é»˜è®¤éšè—) -->
                <div id="ai-config-local" class="hidden" style="background:rgba(255,255,255,0.5); padding:10px; border-radius:6px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <select id="local_model_select" style="flex:1; border-color:#34d399;">
                            <option value="Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen2.5-1.5B (è½»é‡/æ¨è)</option>
                            <option value="Llama-3-8B-Instruct-q4f32_1-MLC">Llama-3-8B (å¼ºå¤§/éœ€8Gæ˜¾å­˜)</option>
                        </select>
                        <button class="btn btn-orange" onclick="initLocalModel()">â¬‡ï¸ ä¸‹è½½å¹¶åŠ è½½æ¨¡å‹</button>
                    </div>
                    <div id="local-ai-status" style="font-size:12px; color:#047857;">çŠ¶æ€ï¼šæœªåŠ è½½ (åˆæ¬¡ä½¿ç”¨éœ€ä¸‹è½½çº¦ 1GB æ•°æ®ï¼Œè¯·ä¿æŒç½‘ç»œé€šç•…)</div>
                    <div style="width:100%; height:6px; background:#e5e7eb; border-radius:3px; margin-top:5px; overflow:hidden;">
                        <div id="local-ai-progress" style="width:0%; height:100%; background:#10b981; transition:width 0.2s;"></div>
                    </div>
                </div>
                <div style="font-size:11px; color:#064e3b; margin-top:8px;">
                    ğŸ’¡ æ¨èä½¿ç”¨ DeepSeek (æ·±åº¦æ±‚ç´¢) æˆ– Kimiã€‚å¯†é’¥å°†å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨ã€‚
                </div>
            </div>
            
            <div id="msg-box" style="margin-top:20px; font-weight:bold; color:var(--success); text-align:center; font-size:16px;"></div>
        </div>

        <!-- 2. ä¹¡é•‡å­¦æ ¡åˆ†æ -->
        <div id="analysis" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-macro)">
                <h3><i class="ti ti-world-latitude"></i> 02 é•‡åŸŸå®è§‚æ¨ªå‘è¯„ä»· <span class="badge" style="background:#0ea5e9;">ğŸ“Š ç­ä¸»ä»»å¿…çœ‹</span></h3>
                <p><strong>ä¸€å¥è¯ç›®çš„ï¼š</strong>å¿«é€Ÿæ¯”è¾ƒå­¦æ ¡/ç­çº§æ•´ä½“æ°´å¹³ä¸æ’åä½ç½®ã€‚</p>
                <p><strong>æ¨èé¡ºåºï¼š</strong>å¯¼å…¥å®Œæˆåä¼˜å…ˆæŸ¥çœ‹æœ¬æ¨¡å—ï¼Œç¡®å®šæ•´ä½“ç«™ä½ã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-chart-dots"></i> ä¹¡é•‡å­¦æ ¡åˆ†æ - ä¸¤ç‡ä¸€åˆ† 
                    <span class="module-help-btn" onclick="showModuleHelp('macro')">ğŸ“˜ ç®—æ³•è¯´æ˜</span>
                </h2>
                <div class="control-panel" style="margin-bottom:0; padding:5px;">
                    <input type="text" id="mySchool" placeholder="è¾“å…¥æœ¬æ ¡åç§°é«˜äº®" style="width:180px;">
                    <button class="btn" onclick="renderHorizontalTable()">ç”Ÿæˆæ¨ªå‘å¯¹æ¯”è¡¨</button>
                    <button class="btn btn-purple" onclick="toggleTableHeatmap('horizontal-table')">ğŸ¨ å¼€å¯çƒ­åŠ›å›¾</button>
                    <button class="btn btn-green" onclick="exportMacroTables()">å¯¼å‡ºå…¨ç§‘åˆ†æè¡¨</button>
                </div>
            </div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">å¿«é€Ÿå®šä½</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-total', this)">ğŸ† ç»¼åˆæ€»è¡¨</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>ğŸ“˜ å„ç§‘è¯¦æƒ…</span><i class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-subjects-container" class="side-nav-sub-container"></div>
                    <div class="side-nav-link" onclick="scrollToAnchor('horizontal-box', this)">â†”ï¸ æ¨ªå‘å¯¹æ¯”</div>
                </div>
                <div class="content-area">
                    <div id="anchor-total" class="anchor-target"><div class="sub-header" style="margin-top:0;"><span>ğŸ† <span class="label-total">å…¨ç§‘æ€»</span> - ç»¼åˆåˆ†æè¡¨</span></div><div class="table-wrap"><table id="tb-total"><thead><tr><th>å­¦æ ¡åç§°</th><th>å®è€ƒäººæ•°</th><th>å¹³å‡åˆ†</th><th>ä¼˜ç§€ç‡</th><th>åŠæ ¼ç‡</th><th>å¹³å‡åˆ†èµ‹åˆ†</th><th>ä¼˜ç§€ç‡èµ‹åˆ†</th><th>åŠæ ¼ç‡èµ‹åˆ†</th><th>ä¸¤ç‡ä¸€åˆ†æ€»åˆ†</th><th>æ’å</th></tr></thead><tbody></tbody></table></div></div>
                    <div id="subject-tables-container" class="anchor-target" style="padding-top:20px;"></div>
                    <div id="horizontal-box" class="hidden anchor-target" style="padding-top:20px;">
                        <div class="sub-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>â†”ï¸ æ¨ªå‘å¯¹æ¯”ä¸€è§ˆè¡¨</span>
                            <button class="btn btn-green" onclick="exportHorizontalExcel()">å¯¼å‡ºæ¨ªå‘Excel</button>
                        </div>
                        <div class="table-wrap" id="horizontal-table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2.1 é•‡åŸŸé¢„è­¦ä¸äº®ç‚¹çœ‹æ¿ -->
        <div id="macro-watch" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-macro)">
                <h3><i class="ti ti-alert-triangle"></i> 02A é•‡åŸŸé¢„è­¦ä¸äº®ç‚¹çœ‹æ¿</h3>
                <p>è¯´æ˜ï¼šé›†ä¸­å‘ˆç°å…¨é•‡æ ¸å¿ƒKPIä¸çº¢é»„ç»¿é¢„è­¦æ¸…å•ï¼Œä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜å­¦æ ¡ä¸æ ‡æ†å­¦æ ¡ã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-dashboard"></i> é£é™©é¢„è­¦ä¸äº®ç‚¹æ€»è§ˆ
                    <span class="module-help-btn" onclick="showModuleHelp('macro')">ğŸ“˜ è§„åˆ™è¯´æ˜</span>
                </h2>
            </div>
            <div id="macro-dashboard" class="fb-dashboard" style="margin-bottom:25px;"></div>
            <div id="traffic-light-dashboard" class="traffic-grid hidden">
                <!-- çº¢ç¯åŒºï¼šä¸¥é‡é¢„è­¦ -->
                <div class="traffic-col red">
                    <div class="traffic-head red">
                        <span><i class="ti ti-alert-triangle-filled"></i> çº¢è‰²é¢„è­¦ (é‡ç‚¹æ•´æ”¹)</span>
                        <span id="count-red" class="badge" style="background:#b91c1c">0</span>
                    </div>
                    <div style="font-size:11px; color:#b91c1c; margin-bottom:10px; opacity:0.8;">
                        è§¦å‘æ¡ä»¶: åŠæ ¼ç‡&lt;60% æˆ– å•ç§‘æ’åå€’æ•°ç¬¬ä¸€
                    </div>
                    <div class="traffic-list" id="list-red"></div>
                </div>

                <!-- é»„ç¯åŒºï¼šé£é™©æç¤º -->
                <div class="traffic-col yellow">
                    <div class="traffic-head yellow">
                        <span><i class="ti ti-alert-circle-filled"></i> é»„è‰²å…³æ³¨ (åŸ¹ä¼˜æå‡)</span>
                        <span id="count-yellow" class="badge" style="background:#b45309">0</span>
                    </div>
                    <div style="font-size:11px; color:#b45309; margin-bottom:10px; opacity:0.8;">
                        è§¦å‘æ¡ä»¶: ä¼˜ç§€ç‡&lt;15% æˆ– ä¸´ç•Œç”Ÿå¯†é›†
                    </div>
                    <div class="traffic-list" id="list-yellow"></div>
                </div>

                <!-- ç»¿ç¯åŒºï¼šæ ‡æ†ç¤ºèŒƒ -->
                <div class="traffic-col green">
                    <div class="traffic-head green">
                        <span><i class="ti ti-thumb-up-filled"></i> ç»¿è‰²æ ‡æ† (ç»éªŒæ¨å¹¿)</span>
                        <span id="count-green" class="badge" style="background:#15803d">0</span>
                    </div>
                    <div style="font-size:11px; color:#15803d; margin-bottom:10px; opacity:0.8;">
                        è§¦å‘æ¡ä»¶: ä¼˜ç§€ç‡&gt;30% æˆ– ç»¼åˆæ’åç¬¬ä¸€
                    </div>
                    <div class="traffic-list" id="list-green"></div>
                </div>
            </div>
        </div>

        <!-- 2.1 æ–°å¢ï¼šé«˜åˆ†æ®µæ ¸ç®—ç‹¬ç«‹æ¨¡å— -->
        <div id="high-score" class="section card-box">
            <div class="module-desc-bar" style="border-color: #b45309">
                <h3><i class="ti ti-trophy"></i> 9å¹´çº§é«˜åˆ†æ®µæ ¸ç®—</h3>
                <p>è€ƒæ ¸æ ‡å‡†ï¼šæ€»åˆ†â‰¥490åˆ†ã€‚èµ‹åˆ†å…¬å¼ï¼š(æœ¬æ ¡é«˜åˆ†ç‡ / å…¨é•‡æœ€é«˜é«˜åˆ†ç‡) Ã— 70ã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-trophy"></i> é«˜åˆ†æ®µèµ‹åˆ†è¯¦æƒ…
                    <span class="module-help-btn" onclick="showModuleHelp('high-score')">ğŸ“˜ æ ¸ç®—è§„åˆ™</span>
                </h2>
                <button class="btn btn-green" onclick="exportHighScoreExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
            </div>
            <div class="table-wrap">
                <table id="tb-high-score">
                    <thead>
                        <tr>
                            <th>å­¦æ ¡åç§°</th>
                            <th>å®è€ƒäººæ•°</th>
                            <th style="background:#fff7ed; color:#b45309;">é«˜åˆ†äººæ•° (â‰¥490)</th>
                            <th style="background:#fff7ed; color:#b45309;">é«˜åˆ†ç‡</th>
                            <th style="background:#fff7ed; color:#b45309;">é«˜åˆ†èµ‹åˆ† (æ»¡åˆ†70)</th>
                            <th>æ’å</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        
        <!-- 3. å1/3æ ¸ç®— -->
        <div id="bottom3" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-arrow-bar-to-down"></i> å1/3å­¦ç”Ÿæ ¸ç®—
                    <span class="module-help-btn" onclick="showModuleHelp('bottom3')">ğŸ“˜ å‰”é™¤è§„åˆ™</span>
                    <span style="font-size:14px; font-weight:normal; color:#666; margin-left:5px;">(å‰”é™¤ç‡: <span id="label-exc"></span>)</span>
                </h2>
                <button class="btn" onclick="exportExcel('bottom3')">å¯¼å‡ºç»“æœ</button>
            </div>
            <div class="table-wrap"><table id="tb-bottom3"><thead><tr><th>å­¦æ ¡åç§°</th><th>æ€»äººæ•°</th><th>å1/3äººæ•°</th><th>å‰”é™¤äººæ•°</th><th>æœ‰æ•ˆå1/3å‡åˆ†</th><th>æ ¸ç®—å¾—åˆ†</th><th>æ’å</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 4. æŒ‡æ ‡ç”Ÿæ ¸ç®— -->
        <div id="indicator" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> æŒ‡æ ‡ç”Ÿè¾¾æ ‡æ ¸ç®—
                    <span class="module-help-btn" onclick="showModuleHelp('indicator')">ğŸ“˜ è®¡åˆ†å…¬å¼</span>
                </h2>
                <div>
                    <button class="btn btn-blue" onclick="openTargetEditor()">
                        <i class="ti ti-edit"></i> åœ¨çº¿è°ƒæ•´ç›®æ ‡
                    </button>
                    <button class="btn btn-green" id="btn-indicator-calc" onclick="calcIndicators()">å¼€å§‹è®¡ç®—</button>
                    <button class="btn" onclick="exportExcel('indicator')">å¯¼å‡ºç»“æœ</button>
                </div>
            </div>
            <div class="table-wrap"><table id="tb-indicator"><thead><tr><th>å­¦æ ¡åç§°</th><th>æŒ‡æ ‡ä¸€(ç›®æ ‡/è¾¾æ ‡)</th><th>å¾—åˆ†</th><th>æŒ‡æ ‡äºŒ(ç›®æ ‡/è¾¾æ ‡)</th><th>å¾—åˆ†</th><th>æŒ‡æ ‡ç”Ÿæ€»åˆ†</th><th>æ’å</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 5. ç»¼åˆæ€»æ’å -->
        <div id="summary" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-report"></i> ç»¼åˆåˆ†ææŠ¥å‘Š <span class="badge" style="background:#16a34a;">â­ æ•™åŠ¡å¸¸ç”¨</span>
                    <span class="module-help-btn" onclick="showModuleHelp('summary')">ğŸ“˜ æƒé‡è¯´æ˜</span>
                </h2>
                <div>
                    <button class="btn btn-green" onclick="calcSummary()">ç”Ÿæˆæ€»æ’å</button>
                    <button class="btn btn-green" onclick="exportSummaryTable()">å¯¼å‡ºæŠ¥å‘Š</button>
                    <button class="btn btn-orange" onclick="exportPPTReport()">
                        <i class="ti ti-presentation"></i> å¯¼å‡ºæ±‡æŠ¥PPT
                    </button>
                   <button class="btn btn-purple" onclick="generateAIMacroReport()">
                        <i class="ti ti-robot"></i> AI æ’°å†™è´¨é‡åˆ†æ (2000å­—)
                    </button>
</div></div>
            <div class="table-wrap"><table id="tb-summary"><thead><tr><th>å­¦æ ¡åç§°</th><th>ä¸¤ç‡ä¸€åˆ†å¾—åˆ†</th><th>å1/3å¾—åˆ†</th><th>æŒ‡æ ‡ç”Ÿå¾—åˆ†</th><th>ç»¼åˆæ€»åˆ†</th><th>æ€»æ’å</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 6. æœ¬æ ¡æ•™å¸ˆåˆ†æ -->
        <div id="teacher-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-school"></i> æœ¬æ ¡æ•™å¸ˆæ•™å­¦åˆ†æ <span class="badge" style="background:#0ea5e9;">ğŸ“Š ç­ä¸»ä»»å¿…çœ‹</span>
                    <span class="module-help-btn" onclick="showModuleHelp('teacher')">ğŸ“˜ è¯„ä»·æ¨¡å‹</span>
                </h2>
                <button class="btn" onclick="exportTeacherAnalysis()">å¯¼å‡ºæ•™å¸ˆåˆ†æ</button>
            </div>
            <div class="info-bar">æœ¬æ ¡æ•™å¸ˆæ•™å­¦åˆ†æåŸºäºå¯¼å…¥çš„æ•™å¸ˆä¿¡æ¯å’Œæˆç»©æ•°æ®ï¼Œå±•ç¤ºæ•™å¸ˆæ‰€æ•™ç­çº§çš„æ•´ä½“è¡¨ç°ï¼Œå¹¶ä¸ä¹¡é•‡å­¦æ ¡è¿›è¡Œå¯¹æ¯”ã€‚</div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">åŠŸèƒ½å¯¼èˆª</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-cards', this)">ğŸ“‡ æ•™å¸ˆæ¦‚å†µå¡ç‰‡</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-detail', this)">ğŸ“Š è¯¦ç»†æ•°æ®å¯¹æ¯”</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-pair', this)">ğŸ¤ ç»“å¯¹å­å»ºè®®</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>ğŸ… ä¹¡é•‡æ’å</span><i class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-teacher-ranks-container" class="side-nav-sub-container"></div>
                </div>
                <div class="content-area">
                    <div id="anchor-cards" class="anchor-target">                    <!-- ä½¿ç”¨ x-data å£°æ˜è¿™æ˜¯ä¸€ä¸ª Alpine ç»„ä»¶ï¼Œx-show æ§åˆ¶æ˜¾ç¤º -->
                    <div class="teacher-cards-container" id="teacherCardsContainer" x-data>
                        
                        <!-- ç©ºçŠ¶æ€æç¤º -->
                        <div x-show="$store.teacherData.list.length === 0" style="grid-column: 1/-1; text-align:center; color:#999; padding:20px;">
                            æš‚æ— æ•™å¸ˆæ•°æ®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹é…ç½®å¹¶å¯¼å…¥ã€‚
                        </div>

                        <!-- å¾ªç¯æ¸²æŸ“å¡ç‰‡ -->
                        <template x-for="item in $store.teacherData.list" :key="item.id">
                            <div class="teacher-card">
                                <div class="teacher-header">
                                    <div>
                                        <div class="teacher-name" x-text="item.name + ' - ' + item.subject"></div>
                                        <div class="teacher-classes" x-text="item.classes + 'ç­'"></div>
                                    </div>
                                    <div :class="`performance-badge ${item.badgeClass}`" x-text="item.badgeText"></div>
                                </div>
                                <div class="teacher-stats">
                                    <div class="stat-item"><div class="stat-value" x-text="item.avg"></div><div class="stat-label">å¹³å‡åˆ†</div></div>
                                    <div class="stat-item"><div class="stat-value" x-text="item.excRate"></div><div class="stat-label">ä¼˜ç§€ç‡</div></div>
                                    <div class="stat-item"><div class="stat-value" x-text="item.passRate"></div><div class="stat-label">åŠæ ¼ç‡</div></div>
                                </div>
                                <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:15px; padding:0 10px;">
                                    <span>å­¦ç”Ÿ: <span x-text="item.count"></span>äºº</span>
                                    <span>é•‡æ’: <strong style="color:var(--primary)" x-text="item.rank"></strong></span>
                                </div>
                                <!-- ç‚¹å‡»äº‹ä»¶ç›´æ¥ç»‘å®š JS å‡½æ•° -->
                                <button class="view-details-btn" @click="showTeacherDetails(item.name, item.subject)">æŸ¥çœ‹è¯¦æƒ…</button>
                            </div>
                        </template>
                    </div></div>
                    <div id="anchor-detail" class="anchor-target" style="padding-top:30px;">
                        <div class="sub-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>ğŸ“Š æ•™å¸ˆæ•™å­¦è¯¦ç»†æ•°æ®å¯¹æ¯”è¡¨</span>
                            <button class="btn btn-green" onclick="exportTeacherComparisonExcel()">å¯¼å‡ºExcel</button>
                        </div>
                        <div class="table-wrap"><table class="comparison-table" id="teacherComparisonTable"><thead><tr><th rowspan="2">æ•™å¸ˆå§“å</th><th rowspan="2">å­¦ç§‘</th><th rowspan="2">ä»»æ•™ç­çº§</th><th rowspan="2">äººæ•°</th><th colspan="3">å¹³å‡åˆ†</th><th colspan="3">ä¼˜ç§€ç‡</th><th colspan="3">åŠæ ¼ç‡</th><th rowspan="2">ç»¼åˆå¾—åˆ†</th><th rowspan="2">æ ¡å†…æ’å</th></tr><tr><th>å®é™…å€¼</th><th>ä¸çº§æ¯”</th><th>æ’å</th><th>å®é™…å€¼</th><th>ä¸çº§æ¯”</th><th>æ’å</th><th>å®é™…å€¼</th><th>ä¸çº§æ¯”</th><th>æ’å</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div id="anchor-pair" class="anchor-target" style="padding-top:30px;"><div id="teacher-pairing-box"><div class="sub-header">ğŸ¤ æ ¡å†…æ•™å¸ˆâ€œç»“å¯¹å­â€äº’åŠ©å»ºè®® (åŸºäºæ•°æ®åˆ†æ)</div><div id="teacher-pairing-suggestions" class="pairing-container"></div></div></div>
                    <div id="teacher-township-ranking-container"></div>
                    <div style="margin-top:10px; text-align:right;"><button class="btn btn-green" onclick="exportTeacherTownshipRankExcel()">å¯¼å‡ºæ•™å¸ˆä¹¡é•‡æ’å</button></div>
                </div>
            </div>
        </div>

        <!-- ================== æ–°å¢æ¨¡å—ï¼šæ ¡å†…ç»©æ•ˆå…¬å¹³è€ƒæ ¸ (å•æ ¡æ¨¡å¼) ================== -->
        <div id="single-school-eval" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-internal)">
                <h3><i class="ti ti-scale"></i> 03 æ ¡å†…ç»©æ•ˆç®¡ç†ä¸è¯„ä»·</h3>
                <p>è¯´æ˜ï¼šé¢å‘æ ¡é•¿å®¤ã€‚è§£å†³ç”Ÿæºä¸å‡å¯¼è‡´çš„è€ƒæ ¸ä¸å…¬ï¼Œé€šè¿‡â€œç”Ÿæºå¢å€¼æ¨¡å‹â€å’Œâ€œå¤§ç­é¢è¡¥å¿ç³»æ•°â€ï¼Œç§‘å­¦æ ¸ç®—æ¯ä½æ•™å¸ˆã€æ¯ä¸ªç­çº§çš„çœŸå®æ•™å­¦è´¡çŒ®ã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-scale"></i> æ ¡å†…ç»©æ•ˆå…¬å¹³è€ƒæ ¸æ¨¡å‹
                    <span class="module-help-btn" onclick="showModuleHelp('sse')">ğŸ“˜ 100åˆ†åˆ¶è¯¦è§£</span>
                </h2>
                <button class="btn btn-green" onclick="SSE_calculate()">ğŸš€ å¼€å§‹è€ƒæ ¸è®¡ç®—</button>
            </div>

            <!-- æ ¸å¿ƒç†å¿µå±•ç¤ºåŒº -->
            <div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); border: 1px solid #bae6fd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #0369a1; margin-bottom: 10px; font-size: 18px;"><i class="ti ti-bulb"></i> æ ¸å¿ƒç†å¿µï¼šâ€œä¸è®©è€å®äººåƒäºâ€</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">1. ä¸çœ‹äººå£çœ‹å¯†åº¦ (35+35åˆ†)</div>
                        <p style="font-size: 12px; color: #666;">
                            æ‘’å¼ƒâ€œä¼˜ç”Ÿäººæ•°â€ç»å¯¹å€¼ï¼Œæ”¹ç”¨<strong>â€œä¼˜ç§€ç‡/åŠæ ¼ç‡â€</strong>ã€‚<br>
                            <span style="background: #dcfce7; padding: 1px 4px;">60äººç­15ä¸ªä¼˜ç”Ÿ = 40äººç­10ä¸ªä¼˜ç”Ÿ</span>ï¼Œå¾—åˆ†å®Œå…¨ä¸€è‡´ã€‚
                        </p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">2. ä¸çœ‹èµ·ç‚¹çœ‹å˜åŒ– (10åˆ†)</div>
                        <p style="font-size: 12px; color: #666;">
                            å¼•å…¥<strong>â€œç”Ÿæºå¢å€¼åˆ†â€</strong>ã€‚å¯¹æ¯”ä¸Šæ¬¡è€ƒè¯•æ’ä½ç™¾åˆ†æ¯”å˜åŒ–ã€‚<br>
                            å·®ç­ä»å¹´çº§å20%è¿›æ­¥åˆ°å40%ï¼Œå³è§†ä¸ºé«˜ç»©æ•ˆï¼Œå¥–åŠ±<strong>â€œåŠ å·¥èƒ½åŠ›â€</strong>ã€‚
                        </p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">3. å¤§ç­é¢è¡¥å¿ç³»æ•° (é¢å¤–åŠ åˆ†)</div>
                        <p style="font-size: 12px; color: #666;">
                            æ‰¿è®¤ç®¡ç†æˆæœ¬ã€‚ä»¥å¹´çº§å¹³å‡äººæ•°ä¸ºåŸºå‡†ã€‚<br>
                            æ¯å¤š <strong>1</strong> åå­¦ç”Ÿï¼Œæ€»åˆ†é¢å¤–è¡¥å¿ <strong>0.1</strong> åˆ†è¾›è‹¦åˆ†ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <div style="flex: 1;">
                    <label><strong>é€‰æ‹©è€ƒæ ¸å­¦æ ¡ï¼š</strong></label>
                    <select id="sse_school_select" style="min-width: 200px; padding: 8px;">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                </div>
                <div style="flex: 2; display: flex; gap: 15px; align-items: center; font-size: 13px;">
                    <label><input type="checkbox" id="sse_check_exc" checked> ä¼˜ç§€è´¡çŒ®(å‰25%)</label>
                    <label><input type="checkbox" id="sse_check_pass" checked> åŠæ ¼ä¿åº•(å‰80%)</label>
                    <label><input type="checkbox" id="sse_check_avg" checked> å‡åˆ†æ°´ä½</label>
                    <label><input type="checkbox" id="sse_check_prog" checked> ç”Ÿæºå¢å€¼</label>
                </div>
                <div style="border-left: 1px solid #ccc; padding-left: 15px;">
                    <button class="btn btn-purple" onclick="SSE_export()">ğŸ“¥ å¯¼å‡ºè€ƒæ ¸è¡¨</button>
                </div>
            </div>

            <!-- ç»“æœå±•ç¤ºåŒº -->
            <div id="sse_result_container" class="hidden">
                <div class="sub-header">
                    <span>ğŸ“Š ç»©æ•ˆèµ‹åˆ†æ’è¡Œæ¦œ</span>
                    <span style="font-size: 12px; font-weight: normal; margin-left: 10px;">
                        (åŸºå‡†: ä¼˜ç§€35 + åŠæ ¼35 + å‡åˆ†20 + å¢å€¼10 = 100åˆ† + ç­é¢è¡¥å¿)
                    </span>
                </div>
                <div class="table-wrap">
                    <table id="sse_table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ç­çº§</th>
                                <th>ç­ä¸»ä»»/æ•™å¸ˆ</th>
                                <th>å®è€ƒäººæ•°</th>
                                <th>å¤§ç­è¡¥å¿åˆ†</th>
                                <th>ä¼˜ç§€ç‡(25%)<br><small style="color:#999">æƒé‡35</small></th>
                                <th>åŠæ ¼ç‡(80%)<br><small style="color:#999">æƒé‡35</small></th>
                                <th>å‡åˆ†å¯¹æ¯”<br><small style="color:#999">æƒé‡20</small></th>
                                <th>ç”Ÿæºå¢å€¼<br><small style="color:#999">æƒé‡10</small></th>
                                <th style="background: #eff6ff; color: #1e3a8a;">æœ€ç»ˆè€ƒæ ¸åˆ†</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; font-size: 12px; color: #666; background: #f9fafb; padding: 10px; border-radius: 6px;">
                    <strong>â„¹ï¸ ç®—æ³•è¯´æ˜ï¼š</strong><br>
                    1. <strong>ä¼˜ç§€/åŠæ ¼å¾—åˆ†ï¼š</strong> (æœ¬ç­ç‡ / å¹´çº§æœ€é«˜ç‡) Ã— æƒé‡åˆ†ã€‚é¼“åŠ±å‘æœ€é«˜æ ‡å‡†çœ‹é½ã€‚<br>
                    2. <strong>å‡åˆ†å¾—åˆ†ï¼š</strong> (æœ¬ç­å‡åˆ† / å¹´çº§å‡åˆ†) Ã— æƒé‡åˆ†ã€‚<br>
                    3. <strong>ç”Ÿæºå¢å€¼ï¼š</strong> è®¡ç®—å…¨ç­å­¦ç”Ÿæ’ä½ç™¾åˆ†æ¯”å˜åŒ–çš„å¹³å‡å€¼ã€‚æ­£å€¼ä¸ºè¿›æ­¥ã€‚æŒ‰ (è¿›æ­¥å€¼ / æœ€å¤§è¿›æ­¥å€¼) Ã— 10 è®¡ç®—ï¼Œé€€æ­¥è€…æ­¤é¡¹ä»ä½è®¡åˆ†ã€‚<br>
                    4. <strong>å¤§ç­è¡¥å¿ï¼š</strong> (ç­çº§äººæ•° - å¹´çº§å¹³å‡äººæ•°) Ã— 0.1ã€‚äººæ•°å°‘äºå¹³å‡çº¿ä¸æ‰£åˆ†ã€‚
                </div>
            </div>
        </div>

        <!-- å­¦ç§‘æ·±åº¦å…³è”åˆ†æ -->
        <div id="correlation-analysis" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-topology-star-3"></i> å­¦ç§‘è´¡çŒ®åº¦ä¸å…³è”æ€§æ·±åº¦åˆ†æ</h2><button class="btn btn-green" onclick="exportCorrelationExcel()">å¯¼å‡ºåˆ†æExcel</button></div>
            <div class="info-bar">æ¢ç´¢å­¦ç§‘é—´çš„å†…åœ¨è”ç³»ä»¥åŠå„å­¦ç§‘å¯¹æ€»åˆ†æ’åçš„è´¡çŒ®åº¦ï¼ˆåŒºåˆ†åº¦ï¼‰ã€‚</div>
            <div class="control-panel">
                <label>åˆ†æèŒƒå›´ï¼š</label><select id="corrSchoolSelect" style="min-width:200px;"><option value="ALL">å…¨ä¹¡é•‡</option></select>
                <button class="btn btn-purple" onclick="renderCorrelationAnalysis()">ğŸš€ å¼€å§‹æ·±åº¦åˆ†æ</button>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px;">
                <div class="bg-gray-50">
                    <h3 style="margin-bottom:15px; color:#333;">ğŸ”— å­¦ç§‘é—´ç›¸å…³æ€§çƒ­åŠ›çŸ©é˜µ (Pearson)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">æ•°å€¼è¶Šæ¥è¿‘1.0(æ·±çº¢)ï¼Œè¡¨ç¤ºä¸¤ç§‘æˆç»©è¶ŠåŒæ­¥ã€‚</p>
                    <div class="table-wrap" style="box-shadow:none; border:none; margin-top:0;"><table class="heatmap-table" id="corrMatrixTable"><tbody></tbody></table></div>
                </div>
                <div class="bg-gray-50">
                    <h3 style="margin-bottom:15px; color:#333;">âš–ï¸ å­¦ç§‘å¯¹æ€»æ’åè´¡çŒ®åº¦ (åŒºåˆ†åº¦)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">æ•°å€¼è¶Šé«˜ï¼Œè¯´æ˜è¯¥å­¦ç§‘è¶Šèƒ½å†³å®šæ€»æ’åçš„ä½æ¬¡ã€‚</p>
                    <div id="contributionChartContainer"></div>
                </div>
            </div>
            <div class="bg-gray-50" style="margin-top:20px;">
                <h3 style="margin-bottom:15px; color:#333;">ğŸ“‰ â€œæåˆ†é¡¹â€ä¸â€œæ‹–åè…¿â€é¢‘ç‡åˆ†æ</h3>
                <div class="table-wrap"><table id="liftDragTable"><thead><tr><th>å­¦ç§‘</th><th>æåˆ†ä¸»åŠ› (å•ç§‘æ’åå‰äºæ€»æ’)</th><th>æ‹–åˆ†ä¸»åŠ› (å•ç§‘æ’ååäºæ€»æ’)</th><th>å¹³è¡¡å‹</th><th>å‡€è´¡çŒ® (æåˆ†-æ‹–åˆ†)</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
        
        <!-- ä¸´ç•Œç”Ÿç²¾å‡†è¾…å¯¼ä»»åŠ¡å• -->
        <div id="marginal-push" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-target-arrow"></i> 04 ç²¾å‡†è¯Šæ–­ä¸å¹²é¢„</h3>
                <p>è¯´æ˜ï¼šé¢å‘ä¸€çº¿ç§‘ä»»æ•™å¸ˆã€‚æŒ–æ˜ä¸´ç•Œç”Ÿï¼ˆæ‹Ÿä¼˜ç§€ã€æ‹ŸåŠæ ¼ï¼‰ã€åç§‘ç”Ÿä»¥åŠæˆç»©æ³¢åŠ¨å‰§çƒˆçš„â€œè¿‡å±±è½¦â€å­¦ç”Ÿï¼Œç”Ÿæˆä»»åŠ¡å•å®ç°ç²¾å‡†å¸®æ‰¶ã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> ä¸´ç•Œç”Ÿç²¾å‡†è¾…å¯¼ä»»åŠ¡å•
                    <span class="module-help-btn" onclick="showModuleHelp('student-diag')">ğŸ“˜ ç­›é€‰é€»è¾‘</span>
                </h2>
                <div>
                    <button class="btn btn-purple" onclick="printMarginalTickets()">ğŸ–¨ æ‰¹é‡æ‰“å°ä»»åŠ¡å•</button>
                    <button class="btn btn-green" onclick="exportMarginalTasks()">ğŸ“Š å¯¼å‡ºExcel</button>
                </div>
            </div>
            
            <div class="info-bar">
                <strong>æ ¸å¿ƒç­–ç•¥ï¼š</strong> ç­›é€‰å‡ºè·ç¦»â€œä¼˜ç§€çº¿â€æˆ–â€œåŠæ ¼çº¿â€ä»…å·® 
                <span style="border-bottom:2px solid var(--primary); font-weight:bold;">Nåˆ†</span> 
                çš„å­¦ç”Ÿï¼Œç”Ÿæˆç§‘ä»»æ•™å¸ˆçš„é‡ç‚¹å…³æ³¨åå•ã€‚
            </div>

            <div class="control-panel" style="background: #fffbeb; border-color: #fcd34d;">
                <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                    <div>
                        <label>é€‰æ‹©å­¦æ ¡ï¼š</label><br>
                        <select id="mpSchoolSelect" style="min-width:150px;" onchange="updateMpClassSelect()"><option value="">--è¯·é€‰æ‹©--</option></select>
                    </div>
                    <div>
                        <label>ç­çº§ (å¯é€‰)ï¼š</label><br>
                        <select id="mpClassSelect" style="min-width:100px;"><option value="">å…¨éƒ¨ç­çº§</option></select>
                    </div>
                    <div>
                        <label>å­¦ç§‘ï¼š</label><br>
                        <select id="mpSubjectSelect" style="min-width:100px;"><option value="ALL">å…¨éƒ¨å­¦ç§‘</option></select>
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:15px;">
                        <label><strong>ğŸ¯ ä¸´ç•Œåˆ†å€¼ (Gap)</strong>ï¼š</label><br>
                        <input type="number" id="mpGap" value="5" style="width:70px; font-weight:bold; color:red;"> åˆ†ä»¥å†…
                    </div>
                    <div>
                        <label>ç›®æ ‡ç±»å‹ï¼š</label><br>
                        <select id="mpType">
                            <option value="both" selected>å…¨éƒ¨ (æ‹Ÿä¼˜+æ‹ŸåŠæ ¼)</option>
                            <option value="pass">ä»…çœ‹ æ‹ŸåŠæ ¼ (ä¿åº•)</option>
                            <option value="exc">ä»…çœ‹ æ‹Ÿä¼˜ç§€ (åŸ¹ä¼˜)</option>
                        </select>
                    </div>
                    <div style="padding-top:16px;">
                        <button class="btn btn-primary" onclick="generateMarginalTickets()">ğŸš€ ç”Ÿæˆè¾…å¯¼å•</button>
                    </div>
                </div>
            </div>

            <!-- é—­ç¯ç®¡ç†ï¼šè½¬åŒ–ç‡è¿½è¸ªé¢æ¿ -->
            <div style="margin:15px 0; background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #bbf7d0; padding-bottom:10px; margin-bottom:10px;">
                    <h3 style="color:#166534; margin:0; font-size:15px;"><i class="ti ti-refresh"></i> ä¸´ç•Œç”Ÿè½¬åŒ–é—­ç¯ç®¡ç† (æ•™å¸ˆè¯„ä»·)</h3>
                    <div style="font-size:12px; color:#15803d;">
                        é€»è¾‘ï¼šä¿å­˜æœ¬æ¬¡ç”Ÿæˆçš„åå•ä¸ºâ€œå†å²ä»»åŠ¡â€ -> ä¸‹æ¬¡è€ƒè¯•å¯¼å…¥æ•°æ® -> è‡ªåŠ¨è®¡ç®—æœ‰å¤šå°‘äººæˆåŠŸâ€œä¸Šçº¿â€
                    </div>
                </div>
                
                <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                    <!-- åŠ¨ä½œA: å­˜æ¡£ -->
                    <div style="flex:1; border-right:1px solid #bbf7d0; padding-right:15px;">
                        <div style="font-weight:bold; color:#166534; margin-bottom:5px;">ç¬¬1æ­¥ï¼šå½“å‰ä»»åŠ¡å­˜æ¡£</div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="mp_save_name" placeholder="ä»»åŠ¡å (å¦‚:æœŸä¸­ä¸´ç•Œç”Ÿ)" style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; flex:1;">
                            <button class="btn btn-green btn-sm" onclick="MP_saveSnapshot()">ğŸ’¾ å­˜æ¡£</button>
                        </div>
                    </div>

                    <!-- åŠ¨ä½œB: è¿½è¸ª -->
                    <div style="flex:2;">
                        <div style="font-weight:bold; color:#166534; margin-bottom:5px;">ç¬¬2æ­¥ï¼šè½¬åŒ–æ•ˆæœè¿½è¸ª (éœ€å…ˆä¸Šä¼ æ–°æ•°æ®)</div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select id="mp_snapshot_select" style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; min-width:150px;">
                                <option value="">-- é€‰æ‹©å†å²ä»»åŠ¡ --</option>
                            </select>
                            <button class="btn btn-orange btn-sm" onclick="MP_analyzeConversion()">ğŸ“ˆ è®¡ç®—è½¬åŒ–ç‡</button>
                            <button class="btn btn-gray btn-sm" onclick="MP_deleteSnapshot()"><i class="ti ti-trash"></i></button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†æç»“æœå±•ç¤ºåŒº -->
                <div id="mp-conversion-result" class="hidden" style="margin-top:15px; background:white; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                    <div class="sub-header" style="margin-top:0;">ğŸ“Š æ•™å¸ˆè¾…å¯¼æ•ˆèƒ½è¯„ä¼° (åŸºäºè½¬åŒ–ç‡)</div>
                    <div class="table-wrap">
                        <table id="mp_conversion_table" style="font-size:12px;">
                            <thead>
                                <tr>
                                    <th>æ•™å¸ˆ/ç­çº§</th>
                                    <th>å­¦ç§‘</th>
                                    <th>ç›®æ ‡ç±»å‹</th>
                                    <th>è¿½è¸ªäººæ•° (å†å²)</th>
                                    <th>æœ¬æ¬¡ä¸Šçº¿äººæ•°</th>
                                    <th>è½¬åŒ–æˆåŠŸç‡</th>
                                    <th>è¯„ä»·</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡å•é¢„è§ˆåŒº -->
            <div id="mp-tickets-container" class="mp-grid">
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#94a3b8;">
                    <i class="ti ti-clipboard-list" style="font-size:48px; margin-bottom:10px;"></i>
                    <p>è¯·è°ƒæ•´å‚æ•°åç‚¹å‡»â€œç”Ÿæˆè¾…å¯¼å•â€</p>
                </div>
            </div>
        </div>

        <!-- è€ƒååº§ä½å¾®è°ƒå»ºè®® -->
        <div id="seat-adjustment" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-armchair"></i> è€ƒåâ€œåº§ä½å¾®è°ƒâ€å»ºè®®</h2></div>
            <div class="info-bar">åŸºäºæœ€è¿‘å‘å±•åŒºç†è®º(ZPD)ä¸å°ç»„åˆä½œå­¦ä¹ æ¨¡å¼ï¼Œç”Ÿæˆä¿ƒè¿›äº’åŠ©çš„åº§ä½è¡¨ã€‚</div>
            
            <!-- [ä¿®æ”¹] è€ƒååº§ä½å¾®è°ƒ - äº¤äº’ä¼˜åŒ–åçš„çº¦æŸæ¡† -->
            <div class="constraints-box">
                <h4><i class="ti ti-alert-triangle"></i> ç‰¹æ®Šæƒ…å†µçº¦æŸé…ç½® (æ™ºèƒ½æ ‡ç­¾è¾“å…¥)</h4>
                <div class="info-bar" style="margin:0 0 10px 0; padding:5px; font-size:11px;">ğŸ’¡ æç¤ºï¼šåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å§“åï¼Œä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ã€‚æ•°æ®æºä¸ºå½“å‰é€‰ä¸­çš„ç­çº§ã€‚</div>
                <div class="constraints-grid">
                    <div><label>ğŸ˜¡ éš¾ç®¡/è°ƒçš®:</label><input type="hidden" id="adj_c_diff"><div id="widget_adj_diff" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="æœå§“å..."><div class="suggestion-dropdown"></div></div></div>
                    <div><label>ğŸ‘“ è§†åŠ›ä¸å¥½ (å‰æ’):</label><input type="hidden" id="adj_c_vision"><div id="widget_adj_vision" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="æœå§“å..."><div class="suggestion-dropdown"></div></div></div>
                    <div><label>â¤ï¸ å¿ƒç†å…³æ³¨:</label><input type="hidden" id="adj_c_psy"><div id="widget_adj_psy" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="æœå§“å..."><div class="suggestion-dropdown"></div></div></div>
                    <div><label>ğŸ—£ï¸ çˆ±è¯´è¯:</label><input type="hidden" id="adj_c_talk"><div id="widget_adj_talk" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="æœå§“å..."><div class="suggestion-dropdown"></div></div></div>
                    <div style="grid-column: 1/-1"><label>âš”ï¸ äº’æœ‰çŸ›ç›¾/é¿å…åŒæ¡Œ (ç”Ÿæˆå™¨):</label><div class="conflict-builder"><select id="conflict_sel_a"><option value="">å­¦ç”Ÿ A</option></select><span>&</span><select id="conflict_sel_b"><option value="">å­¦ç”Ÿ B</option></select><button class="btn btn-gray" style="padding:2px 8px; height:28px;" onclick="addConflictPair('adj')">â• æ·»åŠ </button></div><input type="hidden" id="adj_c_conflict"><div id="widget_adj_conflict" class="tag-widget-container" style="background:#f9fafb;"><span style="font-size:11px; color:#999; padding:4px;">è¯·ä½¿ç”¨ä¸Šæ–¹é€‰æ‹©å™¨æ·»åŠ çŸ›ç›¾å¯¹</span></div></div>
                </div>
            </div>

            <div class="control-panel">
                <div style="flex:2; display:flex; gap:10px; flex-wrap:wrap;">
                    <div><label>å­¦æ ¡ï¼š</label><br><select id="seatAdjSchoolSelect" style="min-width:120px;"><option value="">--è¯·é€‰æ‹©--</option></select></div>
                    <div><label>ç­çº§ï¼š</label><br><select id="seatAdjClassSelect" style="min-width:100px;"><option value="">--ç­çº§--</option></select></div>
                    <div><label>å·¦å³å¤§ç»„æ•° (ä¸­é—´è¿‡é“)ï¼š</label><br><input type="number" id="seatAdjGroups" value="2" min="1" max="4" style="width:60px;" onchange="renderSeatGrid()"></div>
                    <div><label>æ¯ç»„åˆ—æ•°ï¼š</label><br><input type="number" id="seatAdjCols" value="4" min="2" max="6" style="width:60px;" onchange="renderSeatGrid()"></div>
                    <div><label>åˆ†ç»„ç­–ç•¥ï¼š</label><br>
                        <select id="seatAdjStrategy">
                            <option value="conversion">ğŸš€ æåˆ†è½¬åŒ–å‹ (Aå¸¦C, Bå¸¦D)</option>
                            <option value="balanced">âš–ï¸ å›¢é˜ŸPKå‹ (4äººå‡åˆ†å¹³è¡¡)</option>
                            <option value="pair">ğŸ¤ ä¼ ç»Ÿäº’åŠ©å‹ (å¼ºå¼±ç»“å¯¹)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateSeatSuggestions()">ğŸ² ç”Ÿæˆå…±åŒä½“åº§æ¬¡</button>
                <button class="btn btn-purple" onclick="window.print()">ğŸ–¨ æ‰“å°</button>
            </div>
            <div id="seat-adj-workspace" class="seat-workspace hidden" style="margin-top:20px;">
                <div class="seat-tools" style="width:200px;">
                    <h4 style="margin-bottom:10px;">ç­–ç•¥è¯´æ˜</h4>
                    <div id="seat-strategy-desc" style="font-size:12px; color:#666; margin-bottom:15px; padding:10px; background:#e0f2fe; border-radius:6px;">
                        é€‰æ‹©ç­–ç•¥åæŸ¥çœ‹è¯¦ç»†è¯´æ˜...
                    </div>
                    <h4 style="margin-bottom:10px;">å›¾ä¾‹</h4>
                    <div style="font-size:12px; display:flex; flex-direction:column; gap:5px;">
                        <span style="background:#dcfce7; padding:2px 5px; border-radius:4px;">ğŸŸ© å‰25% (Aå±‚:ä¼˜)</span>
                        <span style="background:#e0f2fe; padding:2px 5px; border-radius:4px;">ğŸŸ¦ 25-50% (Bå±‚:è‰¯)</span>
                        <span style="background:#fef9c3; padding:2px 5px; border-radius:4px;">ğŸŸ¨ 50-75% (Cå±‚:æ½œ)</span>
                        <span style="background:#fee2e2; padding:2px 5px; border-radius:4px;">ğŸŸ¥ å25% (Då±‚:åŸº)</span>
                    </div>
                    <div id="seat-stats" style="margin-top:20px; font-size:12px; color:#333; font-weight:bold;"></div>
                </div>
                <div class="seat-canvas" style="min-height:500px;">
                    <div class="seat-stage">è®² å°</div>
                    <div id="seat-count-display" style="margin-bottom:10px; font-weight:bold; color:#666;"></div>
                    <div id="seat-adj-container" class="seat-container" style="position:relative;"></div>
                </div>
            </div>
        </div>
        
        <!-- å­¦ç§‘äº’åŠ©åˆ†ç»„ -->
        <div id="mutual-aid" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-friends"></i> å­¦ç§‘äº’åŠ©åˆ†ç»„</h2><button class="btn btn-green" onclick="exportMutualAidGroups()">å¯¼å‡ºExcel</button></div>
            <div class="info-bar">
                <strong>ç»„é•¿(å°è€å¸ˆ)é€‰æ‹”æ ‡å‡†ï¼š</strong> 
                â‘  å•ç§‘æˆç»©ç­çº§å‰ <strong>25%</strong>ï¼›
                â‘¡ æ€»åˆ†æˆç»©ç­çº§å‰ <strong>40%</strong> (æ‹’ç»ä¸¥é‡åç§‘ï¼Œç¡®ä¿ç»¼åˆè¾…å¯¼èƒ½åŠ›)ã€‚
            </div>
            <div class="control-panel">
                <div style="flex:1; border-right:1px solid #ccc; padding-right:10px; margin-right:10px;">
                    <label><strong>æ•°æ®æºï¼š</strong></label>
                    <select id="aid_source" style="width:100%; margin-top:5px;" onchange="updateMutualAidSelects()">
                        <option value="upload">ğŸ“Š ä¸Šä¼ çš„è€ƒè¯•æˆç»© (è€ç”Ÿ)</option>
                        <option value="freshman">ğŸš€ æ–°ç”Ÿåˆ†ç­ç»“æœ (æ–°ç”Ÿ)</option>
                    </select>
                </div>
                <div style="flex:2; display:flex; gap:10px; flex-wrap:wrap;">
                    <div><label>å­¦æ ¡ï¼š</label><br><select id="aidSchoolSelect" style="min-width:120px;"><option value="">--è¯·é€‰æ‹©--</option></select></div>
                    <div><label>ç­çº§ï¼š</label><br><select id="aidClassSelect" style="min-width:100px;"><option value="">--ç­çº§--</option></select></div>
                    <div><label>äº’åŠ©å­¦ç§‘ï¼š</label><br><select id="aidSubjectSelect" style="min-width:100px;"><option value="total">æ€»åˆ†(ç»¼åˆ)</option></select></div>
                    <div><label>æ¯ç»„äººæ•°ï¼š</label><br><input type="number" id="aidGroupSize" value="4" min="2" max="8" style="width:60px;"></div>
                </div>
                <button class="btn btn-primary" onclick="renderMutualAidGroups()">âš¡ ç”Ÿæˆåˆ†ç»„</button>
            </div>
            <div id="aid-groups-container" class="aid-grid">
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">
                    <i class="ti ti-users" style="font-size:48px; margin-bottom:10px;"></i>
                    <p>è¯·é€‰æ‹©ç­çº§å’Œå­¦ç§‘åç‚¹å‡»ç”Ÿæˆ</p>
                </div>
            </div>
        </div>

        <!-- 7. ç­çº§æ¨ªå‘å¯¹æ¯” -->
        <div id="class-comparison" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-layout-columns"></i> ç­çº§æ¨ªå‘å¯¹æ¯”åˆ†æ
                    <span class="module-help-btn" onclick="showModuleHelp('class-comp')">ğŸ“˜ å…¨æ™¯çŸ©é˜µè¯´æ˜</span>
                </h2>
            </div>
            <div class="info-bar">å¯¹æ¯”åŒä¸€å­¦æ ¡å†…å„ç­çº§çš„å„é¡¹æŒ‡æ ‡ï¼Œç‹¬ç«‹äºæ•™å¸ˆåˆ†æã€‚</div>
            <div class="control-panel">
                <label>é€‰æ‹©å­¦æ ¡ï¼š</label><select id="classCompSchoolSelect" style="min-width:200px;"><option value="">--è¯·é€‰æ‹©--</option></select>
                <button class="btn" onclick="renderClassComparison()">å¼€å§‹å¯¹æ¯”</button>
                <button class="btn btn-purple" onclick="generateClassDiagnosisReport()">
                    <i class="ti ti-brain"></i> AI è¯Šæ–­ç­çº§å¼±é¡¹
                </button>
                <button class="btn btn-green" onclick="exportClassComparisonExcel()">å¯¼å‡ºExcel</button>
                <div style="border-left:1px solid #ccc; padding-left:10px; margin-left:10px; display:flex; gap:5px;">
                    <button class="btn btn-purple" onclick="toggleTableHeatmap('class-comp-results')">ğŸ¨ çƒ­åŠ›å›¾</button>
                    <div style="position:relative;">
                        <button class="btn btn-gray" onclick="toggleColFilterMenu()" id="btn-col-filter">ğŸ‘ï¸ ç­›é€‰å­¦ç§‘</button>
                        <div id="col-filter-popover" class="filter-popover">
                            <!-- JS åŠ¨æ€å¡«å……å¤é€‰æ¡† -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">å¿«é€Ÿå®šä½</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-class-total', this)">ğŸ“Š æ€»åˆ†å¯¹æ¯”</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>ğŸ“˜ å•ç§‘è¯¦æƒ…</span><i class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-class-subjects" class="side-nav-sub-container"></div>
                </div>
                <div class="content-area" id="class-comp-results"></div>
            </div>
        </div>

        <!-- 8. ç­æƒ…è¯Šæ–­ -->
        <div id="class-diagnosis" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-activity"></i> ç­æƒ…è¯Šæ–­ (æ ‡å‡†å·®/åˆ†åŒ–åº¦åˆ†æ)</h2><button class="btn btn-green" onclick="exportDiagnosisExcel()">å¯¼å‡ºè¯Šæ–­è¡¨</button></div>
            <div class="info-bar">é€šè¿‡æ ‡å‡†å·®ï¼ˆSDï¼‰åˆ¤æ–­ç­çº§æˆç»©æ˜¯â€œä¸¤æåˆ†åŒ–â€è¿˜æ˜¯â€œæ•´ä½“å‡è¡¡â€ã€‚</div>
            <div class="control-panel">
                <label>å­¦æ ¡ï¼š</label><select id="diagSchoolSelect" style="min-width:200px;"><option value="">--è¯·é€‰æ‹©--</option></select>
                <label style="margin-left:15px;">å­¦ç§‘ï¼š</label><select id="diagSubjectSelect" style="min-width:100px;"><option value="total">æ€»åˆ†</option></select>
                <label style="margin-left:15px;">é—´è·ï¼š</label><input type="number" id="diagStep" value="10" style="width:80px;" placeholder="åˆ†">
                <button class="btn" style="margin-left:15px;" onclick="renderClassDiagnosis()">è¯Šæ–­åˆ†æ</button>
            </div>
            <div id="diagnosis-results"><div style="text-align:center; padding:40px; color:#94a3b8;"><i class="ti ti-chart-bar" style="font-size:48px; display:block; margin-bottom:10px;"></i><p>è¯·é€‰æ‹©å­¦æ ¡å’Œå­¦ç§‘å¼€å§‹è¯Šæ–­</p></div></div>
        </div>

        <!-- 9. åˆ†æ•°æ®µç»Ÿè®¡ -->
        <div id="segment-analysis" class="section card-box">
            <div class="sec-head"><h2><i class="ti ti-chart-histogram"></i> åˆ†æ•°æ®µç»Ÿè®¡åˆ†æ</h2><button class="btn btn-green" onclick="renderSegmentAnalysis()">ç”Ÿæˆç»Ÿè®¡è¡¨</button><button class="btn btn-green" onclick="exportSegmentExcel()">å¯¼å‡ºExcel</button></div>
            <div class="control-panel">
                <label>ç»Ÿè®¡èŒƒå›´ï¼š</label><select id="segSchoolSelect" style="min-width:150px;"><option value="ALL">å…¨ä¹¡é•‡</option></select>
                <label style="margin-left:10px;">å­¦ç§‘ï¼š</label><select id="segSubjectSelect" style="min-width:100px;"><option value="total">æ€»åˆ†</option></select>
                <label style="margin-left:10px;">åˆ†æ®µè·¨åº¦ï¼š</label><input type="number" id="segStep" value="10" style="width:80px;">
            </div>
            <div style="background:white; padding:15px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:15px; height:350px; position:relative;">
                <canvas id="segmentChart"></canvas>
            </div>
            <div class="table-wrap"><table id="tb-segment"><thead></thead><tbody></tbody></table></div>
        </div>

        <!-- 10. å­¦ç”Ÿè€ƒè¯•æ˜ç»† -->
        <div id="student-details" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-student)">
                <h3><i class="ti ti-users"></i> å­¦ç”Ÿè€ƒè¯•æ˜ç»† <span class="badge" style="background:#16a34a;">â­ æ•™åŠ¡å¸¸ç”¨</span></h3>
                <p><strong>ä¸€å¥è¯ç›®çš„ï¼š</strong>å¿«é€ŸæŸ¥çœ‹å­¦ç”Ÿæ˜ç»†ä¸ç­çº§æˆç»©åˆ—è¡¨ã€‚</p>
                <p><strong>æ¨èé¡ºåºï¼š</strong>æ€»ä½“åˆ†æåè¿›å…¥æœ¬æ¨¡å—è¿›è¡Œç­çº§/å­¦ç”Ÿç­›é€‰ã€‚</p>
            </div>
            <div class="sec-head"><h2><i class="ti ti-users"></i> å­¦ç”Ÿè€ƒè¯•æ˜ç»†</h2><button class="btn" onclick="exportStudentDetails()">å¯¼å‡ºExcel</button></div>
            <div class="control-panel">
                <label>é€‰æ‹©æœ¬æ ¡ï¼š</label><select id="studentSchoolSelect" style="min-width:150px;"><option value="">--è¯·é€‰æ‹©--</option></select>
                <label style="margin-left: 10px;">é€‰æ‹©ç­çº§ï¼š</label><select id="studentClassSelect" style="min-width:120px;"><option value="">å…¨éƒ¨</option></select>
                <button class="btn" onclick="renderStudentDetails()">ç­›é€‰æŸ¥è¯¢</button>
                <button class="btn btn-green" style="margin-left:auto;" onclick="generateMobileLongImage()">
                    <i class="ti ti-photo-scan"></i> ç”Ÿæˆç­çº§æˆç»©é•¿å›¾ (æ‰‹æœºç«¯)
                </button>
                <button class="btn btn-orange" onclick="generateInquiryPackage()">
                    <i class="ti ti-package"></i> ç”Ÿæˆå®¶é•¿æŸ¥åˆ†åŒ… (HTML)
                </button>
                <button class="btn btn-primary" style="background:#0891b2;" onclick="generateClassPPT()">
                    <i class="ti ti-presentation"></i> ç”Ÿæˆç­çº§åˆ†æä¼š PPT
                </button>
            </div>
            <div class="table-wrap"><table id="studentDetailTable"><thead><tr><th>å­¦æ ¡</th><th>ç­çº§</th><th>å§“å</th><th>è€ƒå·</th><th>è€ƒåœº</th></tr></thead><tbody></tbody></table></div>
            <div id="mobile-share-render-area" class="mobile-share-container"></div>
        </div>

        <!-- è¿›é€€æ­¥è¿½è¸ªåˆ†æ (ä¿®å¤ç¼ºå¤±æ¨¡å—) -->
        <div id="progress-analysis" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-trending-up"></i> è¿›é€€æ­¥è¿½è¸ªä¸å¢å€¼è¯„ä»· <span class="badge" style="background:#f59e0b;">ğŸ“Š ç­ä¸»ä»»å¿…çœ‹</span></h3>
                <p><strong>ä¸€å¥è¯ç›®çš„ï¼š</strong>å®šä½å­¦ç”Ÿè¿›é€€æ­¥ä¸ç­çº§å¢å€¼æ•ˆæœã€‚</p>
                <p><strong>æ¨èé¡ºåºï¼š</strong>å…ˆä¸Šä¼ å†å²æˆç»©ï¼Œå†è¿›å…¥æœ¬æ¨¡å—çœ‹è¿›æ­¥åˆ†å¸ƒã€‚</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-trending-up"></i> å­¦ç”Ÿè¿›é€€æ­¥è¿½è¸ªåˆ†æ
                    <span class="module-help-btn" onclick="showModuleHelp('value-added')">ğŸ“˜ å¢å€¼è¯„ä»·</span>
                </h2>
                <div style="display:flex; gap:10px;">
                    <div style="display:flex; border:1px solid #e2e8f0; border-radius:6px; overflow:hidden;">
                        <button class="btn btn-sm active" onclick="switchValueAddedView('school', this)" style="border-radius:0; background:#e0f2fe; color:#0369a1;">æŒ‰å­¦æ ¡çœ‹</button>
                        <button class="btn btn-sm" onclick="switchValueAddedView('class', this)" style="border-radius:0; background:white; color:#64748b;">æŒ‰ç­çº§çœ‹</button>
                    </div>
                    <button class="btn btn-green" onclick="exportValueAddedExcel()">ğŸ“Š å¯¼å‡ºå¢å€¼è¯„ä»·è¡¨</button>
                </div>
            </div>

            <div class="info-bar">
                <span id="va-data-status">âš ï¸ è¯·å…ˆä¸Šä¼ â€œä¸Šæ¬¡è€ƒè¯•â€æ•°æ®ä»¥æ¿€æ´»æ­¤åŠŸèƒ½</span>
                <span style="margin-left:auto; font-size:12px;">æ ¸å¿ƒç®—æ³•ï¼š(å…¥å£æ’å - å‡ºå£æ’å) = å¢å€¼åæ¬¡</span>
            </div>

            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">åŠŸèƒ½è§†å›¾</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-va-report', this)">ğŸ“ˆ å¢å€¼æ€§è¯„ä»·æŠ¥è¡¨</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-va-trend', this)">ğŸ” ä¸ªäººè¿›é€€æ­¥è¿½è¸ª</div>
                </div>
                <div class="content-area">
                    <!-- å¢å€¼è¯„ä»·è¡¨ -->
                    <div id="anchor-va-report" class="anchor-target">
                        <div class="sub-header">ğŸ« æ•™å­¦æ•ˆèƒ½å¢å€¼è¯„ä»·è¡¨ (é›†ä½“)</div>
                        <div class="table-wrap">
                            <table id="tb-value-added">
                                <thead>
                                    <tr>
                                        <th>å•ä½åç§°</th>
                                        <th>åŒ¹é…äººæ•°</th>
                                        <th>å…¥å£å‡ä½ (ä¸Šæ¬¡)</th>
                                        <th>å‡ºå£å‡ä½ (æœ¬æ¬¡)</th>
                                        <th>å¹³å‡å¢å€¼ (åæ¬¡)</th>
                                        <th>è¯„ä»·</th>
                                        <th>æ’å</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ä¸ªäººè¿½è¸ª -->
                    <div id="anchor-va-trend" class="anchor-target" style="margin-top:30px;">
                        <div class="sub-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>ğŸ‘¤ å­¦ç”Ÿä¸ªäººè¿›é€€æ­¥è¯¦æƒ…</span>
                            <div style="font-size:12px; font-weight:normal;">
                                <label>å­¦æ ¡ï¼š</label>
                                <!-- ğŸ”¥ å…³é”®ä¿®å¤ç‚¹ï¼šè¿™å°±æ˜¯æŠ¥é”™æ‰¾ä¸åˆ°çš„ ID -->
                                <select id="progressSchoolSelect" style="padding:4px; border:1px solid #ccc; border-radius:4px;" onchange="renderProgressAnalysis()">
                                    <option value="">--è¯·é€‰æ‹©--</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px; height:300px;">
                            <div style="background:white; border:1px solid #e2e8f0; border-radius:8px; padding:10px; position:relative;">
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">ğŸ›¤ï¸ æ’åæ•£ç‚¹åˆ†å¸ƒ (ä¸Šæµ®ä¸ºè¿›ï¼Œä¸‹æ²‰ä¸ºé€€)</h4>
                                <div style="height:calc(100% - 30px);"><canvas id="trendChart"></canvas></div>
                            </div>
                            <div style="background:white; border:1px solid #e2e8f0; border-radius:8px; padding:10px; position:relative;">
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">ğŸŒŠ ç”Ÿæºå±‚çº§æµåŠ¨æ¡‘åŸºå›¾ (A/B/C/Då±‚)</h4>
                                <div style="height:calc(100% - 30px);"><canvas id="sankeyChart"></canvas></div>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:5px; flex-wrap:wrap;">
                            <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                                <label>ç­›é€‰ï¼š</label>
                                <select id="progressFilterType" style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;" onchange="applyProgressFilter()">
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="up">ä»…è¿›æ­¥</option>
                                    <option value="down">ä»…é€€æ­¥</option>
                                </select>
                                <label>é˜ˆå€¼(åæ¬¡)</label>
                                <input id="progressFilterThreshold" type="number" value="20" style="width:70px; padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;" oninput="applyProgressFilter()">
                                <span style="color:#64748b;">ä»…æ˜¾ç¤º |å˜åŒ–| â‰¥ é˜ˆå€¼</span>
                                <button class="btn btn-sm btn-gray" onclick="resetProgressFilter()">é‡ç½®ç­›é€‰</button>
                            </div>
                            <button class="btn btn-sm btn-green" onclick="exportProgressAnalysis()">ğŸ“¥ å¯¼å‡ºä¸ªäººæ˜ç»†</button>
                        </div>
                        <div class="table-wrap">
                            <table id="progressTable">
                                <thead>
                                    <tr>
                                        <th>ç­çº§</th><th>å§“å</th><th>æœ¬æ¬¡æ€»åˆ†</th><th>æœ¬æ¬¡æ ¡æ’</th><th>ä¸Šæ¬¡æ€»åˆ†</th><th>ä¸Šæ¬¡æ ¡æ’</th><th>è¿›é€€æ­¥</th><th>çŠ¶æ€è¯„ä»·</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 11. ä¸ªæ€§åŒ–æˆç»©å•ç”Ÿæˆå™¨ -->
        <div id="report-generator" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-student)">
                <h3><i class="ti ti-user-heart"></i> 05 å­¦ç”Ÿå‘å±•ä¸å®¶æ ¡æ²Ÿé€š <span class="badge" style="background:#0ea5e9;">ğŸ“Š ç­ä¸»ä»»å¿…çœ‹</span></h3>
                <p><strong>ä¸€å¥è¯ç›®çš„ï¼š</strong>ç”Ÿæˆæˆç»©å•ä¸å®¶é•¿æŸ¥åˆ†ææ–™ã€‚</p>
                <p><strong>æ¨èé¡ºåºï¼š</strong>å®Œæˆåˆ†æåï¼Œç”¨äºç­çº§æ±‡æŠ¥ä¸å®¶æ ¡æ²Ÿé€šã€‚</p>
            </div>
            <div class="sec-head"><h2><i class="ti ti-certificate"></i> ä¸ªæ€§åŒ–æˆç»©å•ç”Ÿæˆå™¨</h2></div>
            <div class="control-panel" style="background:#fff; border-color:var(--primary-light);">
                <label>é€‰æ‹©å­¦æ ¡ï¼š</label><select id="sel-school" style="min-width:150px;"><option>--è¯·å…ˆä¸Šä¼ æ•°æ®--</option></select>
                <label>ç­çº§ï¼š</label><select id="sel-class" style="min-width:120px;"><option>--è¯·å…ˆé€‰æ‹©å­¦æ ¡--</option></select>
            </div>
            <div class="control-panel">
                 <input type="text" id="inp-name" placeholder="æŸ¥è¯¢å•ä¸ªå­¦ç”Ÿå§“å" style="width:120px;">
                 <button class="btn" onclick="doQuery()">æŸ¥è¯¢å•äººæŠ¥å‘Š</button>
                 <!-- [æ–°å¢] æ‰¹é‡PDFå…¥å£ -->
                 <button class="btn btn-primary" style="margin-left:auto;" onclick="batchGeneratePDF()">
                    <i class="ti ti-files"></i> æ‰¹é‡ç”Ÿæˆå…¨ç­ PDF
                </button>                 
            </div>
            <div id="single-report-result" class="hidden">
                <div style="text-align: right; margin-bottom: 10px; display:flex; justify-content:flex-end; gap:10px;">
                    <!-- [ä¿®æ”¹] æ‰“å°/PDF -->
                    <button class="btn btn-purple" onclick="printSingleReport()">
                        <i class="ti ti-printer"></i> æ‰“å° / å¦å­˜ä¸º PDF
                    </button>
                </div>
                <div id="report-card-capture-area" class="report-card-container"></div>
            </div>
            <div id="batch-ai-workspace" class="hidden card-box" style="margin-top:20px; border-left:4px solid #8b5cf6;">
                <div class="sec-head">
                    <h2 style="color:#6d28d9;"><i class="ti ti-sparkles"></i> æ‰¹é‡ AI è¯„è¯­ç”Ÿæˆä¸­å¿ƒ</h2>
                    <button class="btn btn-gray" onclick="document.getElementById('batch-ai-workspace').classList.add('hidden')">å…³é—­é¢æ¿</button>
                </div>
                <div class="info-bar">
                    <i class="ti ti-info-circle"></i> ç³»ç»Ÿå°†ä¾æ®ã€ä¸¤ç‡ä¸€åˆ†ã€‘ã€æ’åè¿›é€€æ­¥åŠä¼˜åŠ£åŠ¿å­¦ç§‘ï¼Œä¾æ¬¡è°ƒç”¨ AI æ¥å£ç”Ÿæˆè¯„è¯­ã€‚å»ºè®®æ¯ä½å­¦ç”Ÿé—´éš” 3-5 ç§’ä»¥å…è¯·æ±‚è¶…é™ã€‚
                </div>
                <div style="display:flex; gap:15px; margin-bottom:15px; align-items:center;">
                    <button class="btn btn-purple" id="btn-start-batch-ai" onclick="startBatchAIComments()">ğŸš€ å¼€å§‹ç”Ÿæˆ (å½“å‰é€‰ä¸­ç­çº§)</button>
                    <button class="btn btn-danger hidden" id="btn-stop-batch-ai" onclick="stopBatchAI()">â¹ åœæ­¢ç”Ÿæˆ</button>
                    <button class="btn btn-green" onclick="exportAICommentsExcel()">ğŸ“¥ å¯¼å‡ºè¯„è¯­ Excel</button>
                    <div style="font-size:12px; color:#666;">
                        é—´éš”(ç§’): <input type="number" id="batch-ai-interval" value="3" style="width:50px; padding:2px;">
                    </div>
                </div>
                <!-- è¿›åº¦æ¡ -->
                <div style="background:#e2e8f0; border-radius:10px; height:20px; width:100%; margin-bottom:15px; overflow:hidden; position:relative;">
                    <div id="batch-ai-progress" style="background:#8b5cf6; width:0%; height:100%; transition:width 0.3s;"></div>
                    <div id="batch-ai-progress-text" style="position:absolute; width:100%; text-align:center; top:0; font-size:12px; line-height:20px; color:#333; font-weight:bold;">0 / 0</div>
                </div>
                <!-- å®æ—¶æ—¥å¿— -->
                <div class="table-wrap" style="max-height:400px; overflow-y:auto;">
                    <table id="batch-ai-table" style="font-size:12px;">
                        <thead>
                            <tr>
                                <th style="width:60px;">çŠ¶æ€</th>
                                <th style="width:80px;">å§“å</th>
                                <th style="width:60px;">æ’å</th>
                                <th>AI ç”Ÿæˆè¯„è¯­é¢„è§ˆ</th>
                                <th style="width:60px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align:center; color:#999;">ç‚¹å‡»å¼€å§‹åï¼Œç”Ÿæˆç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="sub-header" style="margin-top: 50px;">ğŸ¯ ä¼˜ç§€å’ŒåŠæ ¼è¾¹ç¼˜ç”Ÿåˆ†æ</div>
            <div class="control-panel">
                <label>é€‰æ‹©æœ¬æ ¡ï¼š</label><select id="marginalSchoolSelect" style="min-width:200px;"><option value="">--è¯·é€‰æ‹©--</option></select>
                <button class="btn" onclick="analyzeMarginalStudents()">åˆ†æè¾¹ç¼˜ç”Ÿ</button>
                <button class="btn btn-green" onclick="exportMarginalStudents()">å¯¼å‡ºExcel</button>
            </div>
            <div id="marginal-student-results"></div>
        </div>

        <div id="subject-balance" class="section card-box">
            <div class="module-desc-bar" style="border-color: #059669">
                <h3><i class="ti ti-scale"></i> å­¦ç”Ÿä¼˜åŠ£åŠ¿å­¦ç§‘å¯è§†åŒ–é€è§†</h3>
                <p>è¯´æ˜ï¼šä»¥å…¨é•‡å¹³å‡åˆ†ä¸ºåŸºå‡†ï¼Œç›´è§‚å±•ç¤ºæ¯ä¸ªå­¦ç”Ÿâ€œå¼ºåœ¨å“ªã€å¼±åœ¨å“ªâ€ã€‚ç»¿è‰²ä»£è¡¨ä¼˜åŠ¿ï¼Œçº¢è‰²ä»£è¡¨åŠ£åŠ¿ï¼Œé•¿åº¦ä»£è¡¨ç¨‹åº¦ã€‚</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-activity"></i> ä¼˜åŠ£åŠ¿å­¦ç§‘é€è§†è¡¨</h2>
                <button class="btn btn-green" onclick="SB_exportExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
            </div>
            
            <div class="control-panel">
                <label>é€‰æ‹©å­¦æ ¡ï¼š</label>
                <select id="sbSchoolSelect" style="min-width:150px;">
                    <option value="">--è¯·é€‰æ‹©--</option>
                </select>
                
                <label style="margin-left: 10px;">ç­çº§ï¼š</label>
                <select id="sbClassSelect" style="min-width:120px;">
                    <option value="">å…¨éƒ¨</option>
                </select>

                <label style="margin-left: 10px; border-left:1px solid #ccc; padding-left:10px;">æ’åºä¾æ®ï¼š</label>
                <select id="sbSortBy">
                    <option value="total">æŒ‰æ€»åˆ†é™åº</option>
                    <option value="balance">æŒ‰åç§‘ç¨‹åº¦(æœ€ä¸å‡è¡¡åœ¨å‰)</option>
                </select>

                <button class="btn btn-primary" onclick="SB_renderTable()">ğŸ” å¼€å§‹åˆ†æ</button>
            </div>

            <!-- å›¾ä¾‹è¯´æ˜ -->
            <div style="font-size:12px; margin:10px 0; color:#666; display:flex; gap:15px; align-items:center;">
                <span>å›¾ä¾‹è¯´æ˜ï¼š</span>
                <span style="display:flex; align-items:center;"><div style="width:15px; height:8px; background:#16a34a; margin-right:5px;"></div> ä¼˜åŠ¿ (é«˜äºå‡åˆ†)</span>
                <span style="display:flex; align-items:center;"><div style="width:15px; height:8px; background:#dc2626; margin-right:5px;"></div> åŠ£åŠ¿ (ä½äºå‡åˆ†)</span>
                <span style="color:#94a3b8;">(æ•°å€¼è¡¨ç¤ºä¸å…¨é•‡å¹³å‡åˆ†çš„åˆ†å·®)</span>
            </div>

            <div class="table-wrap">
                <table id="sb-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">å§“å</th>
                            <th style="width:60px;">æ€»åˆ†</th>
                            <th style="width:60px;">é•‡æ’</th>
                            <th>ä¼˜åŠ£åŠ¿åˆ†å¸ƒå›¾ (åŸºå‡†çº¿ï¼šå…¨é•‡å¹³å‡åˆ†)</th>
                            <th style="width:150px;">AI ç®€è¯„</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">è¯·é€‰æ‹©ç­çº§å¹¶ç‚¹å‡»åˆ†æ</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card-box" style="border-left:4px solid #f59e0b; background:#fff7ed; margin-top:15px;">
                <div class="sec-head" style="border-bottom-color:#fed7aa; margin-bottom:10px;">
                    <h2 style="color:#9a3412;"><i class="ti ti-cluster"></i> å­¦ç§‘ç˜¸è…¿æ·±åº¦èšç±»</h2>
                    <button class="btn btn-orange" onclick="SB_runCluster()">ğŸ”¬ ç”Ÿæˆèšç±»ä¸è¾…å¯¼ç­–ç•¥</button>
                </div>
                <div style="font-size:12px; color:#7c2d12; margin-bottom:10px;">
                    è¯´æ˜ï¼šä½¿ç”¨ K-Means è‡ªåŠ¨åˆ†ç±»ä¸º<strong>å…¨ç§‘å‡è¡¡å‹ / æ–‡å¼ºç†å¼±å‹ / ç†å¼ºæ–‡å¼±å‹ / å•ç§‘çªå›´å‹</strong>ï¼Œå¹¶ç»™å‡ºè¾…å¯¼ç­–ç•¥æ¨¡æ¿ã€‚
                </div>
                <div id="sb-cluster-results" style="font-size:12px; color:#7c2d12;"></div>
            </div>
        </div>

        <!-- 12. åç§‘æ½œåŠ›ç”ŸæŒ–æ˜ -->
        <div id="potential-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-bulb"></i> åç§‘æ½œåŠ›ç”ŸæŒ–æ˜
                    <span class="module-help-btn" onclick="showModuleHelp('student-diag')">ğŸ“˜ æŒ–æ˜åŸç†</span>
                </h2>
                <button class="btn btn-green" onclick="exportPotentialAnalysis()">å¯¼å‡ºåå•</button>
            </div>
            <div class="info-bar"><span class="text-blue">æ ¸å¿ƒé€»è¾‘ï¼š</span> ç­›é€‰å‡º <strong>æ€»åˆ†æ’åé å‰</strong> (å¦‚å‰20%)ï¼Œä½† <strong>å•ç§‘æ’åä¸¥é‡æ»å</strong> (å¦‚50%ä»¥å) çš„å­¦ç”Ÿã€‚</div>
            <div class="control-panel" style="background:#fffbeb; border-color:#fcd34d;">
                <label>èŒƒå›´ï¼š</label><select id="potSchoolSelect" style="min-width:150px;"><option value="ALL">å…¨ä¹¡é•‡</option></select>
                <label style="margin-left:15px;">æ€»åˆ†æ’åå‰ï¼š</label><select id="potTopSelect" style="width:100px;"><option value="0.1">10%</option><option value="0.2" selected>20%</option><option value="0.3">30%</option><option value="0.5">50%</option></select>
                <label style="margin-left:15px;">å•ç§‘æ’ååï¼š</label><select id="potLowSelect" style="width:100px;"><option value="0.3">30%</option><option value="0.4">40%</option><option value="0.5" selected>50%</option><option value="0.6">60%</option><option value="0.8">80%</option></select>
                <button class="btn btn-orange" style="margin-left:15px;" onclick="renderPotentialAnalysis()">ğŸ” ä¸€é”®æŒ–æ˜</button>
            </div>
            <div id="potential-results"><div style="text-align:center; padding:40px; color:#94a3b8;"><i class="ti ti-search" style="font-size:48px; display:block; margin-bottom:10px;"></i><p>è¯·ç‚¹å‡»ä¸Šæ–¹â€œä¸€é”®æŒ–æ˜â€æŒ‰é’®å¼€å§‹åˆ†æ</p></div></div>
        </div>

        <!-- 13. æ–°ç”Ÿåˆ†ç­ & åº§ä½ç¼–æ’ -->
        <div id="freshman-simulator" class="section card-box">
           <div class="sec-head">
                <h2>
                    <i class="ti ti-arrows-split"></i> æ–°ç”Ÿå‡è¡¡åˆ†ç­
                    <span class="module-help-btn" onclick="showModuleHelp('tools')">ğŸ“˜ ç®—æ³•é€»è¾‘</span>
                </h2>
                <div>
                    <button class="btn btn-purple" onclick="FB_saveToLocal()">ğŸ’¾ ä¿å­˜æ–¹æ¡ˆ</button>
                    <button class="btn btn-green" onclick="FB_exportResult()">ğŸ“Š å¯¼å‡ºç»“æœ</button>
                </div>
            </div>
            <div class="control-panel" style="flex-direction: column; align-items: stretch;">
                <div style="display:flex; gap:20px; flex-wrap:wrap; border-bottom:1px dashed #cbd5e1; padding-bottom:15px; margin-bottom:15px;">
                    <div class="upload-box" style="flex:1; padding:20px; min-width:250px;" onclick="document.getElementById('fbFileInput').click()">
                        <div class="upload-icon"><i class="ti ti-file-import"></i></div>
                        <div style="font-weight:bold;">ç‚¹å‡»å¯¼å…¥æ–°ç”Ÿåå• Excel</div>
                        <div style="font-size:12px; color:#64748b;">å¿…éœ€: å§“å,æ€§åˆ«,æ€»åˆ† | å¯é€‰: èº«é«˜,è§†åŠ›,å¤‡æ³¨(å…³ç³»)</div>
                        <input type="file" id="fbFileInput" accept=".xlsx,.xls" hidden onchange="FB_loadData(this)">
                    </div>
                    <div style="flex:2; display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:15px;">
                        <div><label class="stat-label">æ‹Ÿåˆ†ç­çº§æ•°</label><input type="number" id="fb_cls_num" value="6" min="1" max="30" style="width:100%;"></div>
                        <div><label class="stat-label">ç­é¢å¾®è°ƒ</label><select id="fb_cls_size" style="width:100%;"><option value="0">è‡ªåŠ¨å¹³å‡</option><option value="auto">å…è®¸Â±2äºº</option></select></div>
                        <div><label class="stat-label">ç”·å¥³æ§åˆ¶</label><select id="fb_rule_gender" style="width:100%;"><option value="strict">ä¸¥æ ¼å‡è¡¡</option><option value="loose">å…è®¸å·®å¼‚</option></select></div>
                        <div><label class="stat-label">éš¾ç®¡å­¦ç”Ÿ</label><select id="fb_rule_diff" style="width:100%;"><option value="spread">å‡åŒ€åˆ†æ•£ (æ¨è)</option><option value="gather">é›†ä¸­ç®¡ç†</option></select></div>
                        <div><label class="stat-label">æ ¸å¿ƒç®—æ³•</label><select id="fb_algorithm" style="width:100%;"><option value="complex" selected>ğŸ§  ç»¼åˆæ™ºèƒ½ä¼˜åŒ–</option><option value="snake">ğŸ ç»å…¸è›‡å½¢åˆ†ç­</option></select></div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:13px; color:#b45309; background:#fffbeb; padding:5px 10px; border-radius:4px;"><i class="ti ti-alert-circle"></i> <strong>æ™ºèƒ½æç¤ºï¼š</strong> ç³»ç»Ÿå°†è‡ªåŠ¨è§£æå¤‡æ³¨åˆ—ä¸­çš„ "å’ŒXXåŒç­"ã€"ä¸XXåˆ†å¼€" ç­‰è‡ªç„¶è¯­è¨€ï¼Œä¼˜å…ˆçº§æœ€é«˜ã€‚</div>
                    <button class="btn btn-primary" style="padding:10px 30px; font-size:16px;" onclick="FB_runDivision()">ğŸš€ å¼€å§‹æ™ºèƒ½åˆ†ç­</button>
                </div>
            </div>
            <div id="fb-results-area" class="hidden">
                <!-- å±Šåˆ«å…¥å£å¼¹çª— -->
                <div id="mode-mask">
                    <div class="mode-box">
                        <h2 style="color:var(--primary); margin-bottom:15px; font-size:24px;">ğŸ“‚ è¿›å…¥å±Šåˆ«æ¡£æ¡ˆ</h2>
                        <p style="color:#64748b;">ä»¥â€œå…¥å­¦å¹´ä»½â€ä¸ºä¸»çº¿å»ºç«‹å®Œæ•´æˆé•¿å‘¨æœŸï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…å¹´çº§ä¸æ ¸ç®—æ¨¡å¼</p>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                            <input id="entry-cohort-year" type="number" placeholder="å…¥å­¦å¹´ä»½ (å¦‚ 2022)" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; width:180px;">
                            <select id="entry-cohort-start-grade" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                                <option value="7">åˆä¸­å…¥å­¦ (7å¹´çº§)</option>
                                <option value="6">å°å­¦å…¥å­¦ (6å¹´çº§)</option>
                            </select>
                            <button class="btn btn-primary" onclick="enterCohortFromMask()">è¿›å…¥å±Šåˆ«</button>
                        </div>
                        <div style="margin-top:10px; font-size:12px; color:#64748b;">å·²æœ‰å±Šåˆ«å¯åœ¨é¡¶éƒ¨ä¸‹æ‹‰ç›´æ¥åˆ‡æ¢</div>
                    </div>
                </div>
                <div style="background:white; border-radius:8px; padding:15px; margin-top:20px; border:1px solid #e2e8f0;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:16px;">âš–ï¸ åˆ†ç­å‡è¡¡åº¦è¯Šæ–­ (ç®±çº¿å›¾)</h3>
                    <div style="height:300px; position:relative;">
                        <canvas id="balanceChart"></canvas>
                    </div>
                    <div id="balanceTableContainer" style="margin-top:20px; overflow-x:auto;"></div>
                </div>

                <div class="sub-header" style="margin-top:20px;">ğŸ« åˆ†ç­ç»“æœåˆ—è¡¨ (ç‚¹å‡»ç­çº§å¡ç‰‡è¿›å…¥åº§ä½ç¼–æ’)</div>
                <div class="fb-class-grid" id="fb_class_container"></div>
            </div>
            <div id="fb_seat_view" class="hidden" style="margin-top:30px; border-top:3px solid var(--primary); padding-top:20px; background:#fff;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="color:var(--primary); margin:0;"><i class="ti ti-armchair"></i> <span id="seat_class_title"></span> åº§ä½ç¼–æ’</h2>
                    <button class="btn btn-gray" onclick="document.getElementById('fb_seat_view').classList.add('hidden')">âŒ å…³é—­/è¿”å›</button>
                </div>
                <div class="seat-workspace">
                    <div class="seat-tools">
                        <h4 style="border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">ğŸ›  æ•™å®¤å¸ƒå±€</h4>
                        <div style="margin-bottom:10px;"><label>å·¦å³å¤§ç»„æ•° (ä¸­é—´ä¸ºè¿‡é“):</label><input type="number" id="seat_opt_groups" value="2" min="1" max="4" style="width:60px;" onchange="FB_renderSeatMap()"></div>
                        <div style="margin-bottom:20px;"><label>æ¯ç»„åˆ—æ•°:</label><input type="number" id="seat_opt_cols" value="4" min="1" max="6" style="width:100%;" onchange="FB_renderSeatMap()"></div>
                        
                        <!-- [ä¿®æ”¹] æ–°ç”Ÿåˆ†ç­ - äº¤äº’ä¼˜åŒ–åçš„çº¦æŸæ¡† -->
                        <div class="constraints-box" style="padding:10px;">
                            <h4 style="margin:0 0 10px 0;">ğŸš§ ä¸´æ—¶å¹²é¢„ (æ™ºèƒ½è¾“å…¥)</h4>
                            <div style="font-size:12px; display:flex; flex-direction:column; gap:8px;">
                                <div><label>ğŸ˜¡ éš¾ç®¡:</label><input type="hidden" id="fb_c_diff"><div id="widget_fb_diff" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="è¾“å…¥å§“å..."><div class="suggestion-dropdown"></div></div></div>
                                <div><label>ğŸ‘“ è§†åŠ›:</label><input type="hidden" id="fb_c_vision"><div id="widget_fb_vision" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="è¾“å…¥å§“å..."><div class="suggestion-dropdown"></div></div></div>
                                <div><label>ğŸ—£ï¸ è¯´è¯:</label><input type="hidden" id="fb_c_talk"><div id="widget_fb_talk" class="tag-widget-container"><input type="text" class="tag-input-field" placeholder="è¾“å…¥å§“å..."><div class="suggestion-dropdown"></div></div></div>
                                <div><label>âš”ï¸ çŸ›ç›¾:</label><div class="conflict-builder"><select id="fb_conflict_sel_a" style="width:40%"><option value="">A</option></select><span>&</span><select id="fb_conflict_sel_b" style="width:40%"><option value="">B</option></select><button class="btn btn-gray" style="padding:0 5px;" onclick="addConflictPair('fb')">+</button></div><input type="hidden" id="fb_c_conflict"><div id="widget_fb_conflict" class="tag-widget-container" style="background:#f9fafb;"></div></div>
                            </div>
                        </div>

                        <!-- 1. æ–°å¢ï¼šå›ºå®šæ­æ¡£ (ç»‘å®š) ç»„ä»¶ -->
                        <div class="constraints-box" style="padding:10px; margin-top:10px; background:#f0fdf4; border-color:#86efac;">
                            <h4 style="margin:0 0 10px 0; color:#166534;">ğŸ”— å¼ºè¡Œç»‘å®š (å›ºå®šåŒæ¡Œ)</h4>
                            <div style="font-size:12px;">
                                <div class="conflict-builder">
                                    <select id="fb_bind_sel_a" style="width:40%"><option value="">A</option></select>
                                    <span>&</span>
                                    <select id="fb_bind_sel_b" style="width:40%"><option value="">B</option></select>
                                    <button class="btn btn-green" style="padding:0 5px;" onclick="addBindPair('fb')">+</button>
                                </div>
                                <input type="hidden" id="fb_c_bind">
                                <div id="widget_fb_bind" class="tag-widget-container" style="background:#f9fafb;"></div>
                            </div>
                        </div>

                        <!-- 2. æ–°å¢ï¼šå¤šæ–¹æ¡ˆç®¡ç†é¢æ¿ -->
                        <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:6px; padding:10px; margin-bottom:10px; display:flex; gap:10px;">
                            <button class="btn btn-gray" id="btn_undo" onclick="HistoryManager.undo()" disabled style="flex:1;">
                                <i class="ti ti-arrow-back-up"></i> æ’¤é”€
                            </button>
                            <button class="btn btn-gray" id="btn_redo" onclick="HistoryManager.redo()" disabled style="flex:1;">
                                <i class="ti ti-arrow-forward-up"></i> é‡åš
                            </button>
                        </div>
                        <div style="background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:10px; margin-bottom:15px; margin-top:10px;">
                            <h4 style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">ğŸ’¾ æ–¹æ¡ˆè®°å¿†</h4>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <select id="seat_scenario_select" style="flex:1; font-size:12px;" onchange="FB_loadScenario()">
                                    <option value="">-- é€‰æ‹©æ–¹æ¡ˆ --</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-primary btn-sm" style="flex:1; font-size:12px;" onclick="FB_saveScenario()">ä¿å­˜å½“å‰</button>
                                <button class="btn btn-danger btn-sm" style="width:30px; padding:0;" onclick="FB_deleteScenario()" title="åˆ é™¤é€‰ä¸­"><i class="ti ti-trash"></i></button>
                            </div>
                        </div>

                        <div style="background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:10px; margin-bottom:15px; margin-top:10px;">
                            <button class="btn btn-gray" style="width:100%; margin-bottom:8px;" onclick="FB_toggleViewRotation()">
                                <i class="ti ti-rotate"></i> åˆ‡æ¢è®²å°è§†è§’ (é»‘æ¿)
                            </button>
                            <div style="font-size:12px; color:#d97706; display:flex; align-items:start; gap:5px;">
                                <i class="ti ti-mouse-2"></i>
                                <span><strong>å³é”®ç‚¹å‡»åº§ä½</strong>å¯é”å®š/è§£é”ã€‚<br>é”å®šåï¼Œä¸€é”®é‡æ’æ—¶ä¸ç§»åŠ¨ä½ç½®ã€‚</span>
                            </div>
                        </div>
                        <h4 style="border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">ğŸ§  æ™ºèƒ½è§„åˆ™</h4>
                        <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
                            <label><input type="checkbox" id="rule_s_height" checked> æŒ‰èº«é«˜å‰ä½åé«˜</label><label><input type="checkbox" id="rule_s_vision" checked> è§†åŠ›ä¿æŠ¤ (å‰3æ’)</label><label><input type="checkbox" id="rule_s_gender" checked> ç”·å¥³åŒæ¡Œæ··æ’</label><label><input type="checkbox" id="rule_s_diff" checked> éš¾ç®¡å­¦ç”Ÿâ€œCä½â€ç›‘æ§</label><label><input type="checkbox" id="rule_s_rel" checked> å…³ç³»äº’æ–¥å¼ºåˆ¶åˆ†å¼€</label>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="FB_autoSeatAlgo()">âœ¨ ä¸€é”®ç”Ÿæˆåº§ä½</button>
                        <button class="btn btn-purple" style="width:100%; margin-top:10px;" onclick="window.print()">ğŸ–¨ æ‰“å°åº§ä½è¡¨</button>
                    </div>
                    <div class="seat-canvas"><div class="seat-stage">è®² å° / é»‘ æ¿</div><div id="seat_map_container" class="seat-container"></div></div>
                </div>
            </div>
        </div>

        <!-- 14. æ™ºèƒ½è€ƒåœºç¼–æ’ -->
        <div id="exam-arranger" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-tools)">
                <h3><i class="ti ti-settings-automation"></i> 06 æ™ºæ…§æ•™åŠ¡äº‹åŠ¡å·¥å…·</h3>
                <p>è¯´æ˜ï¼šè§£å†³æ—¥å¸¸ç¹æ‚æ•™åŠ¡ã€‚åŒ…å«è€ƒåœºæ™ºèƒ½ç¼–æ’ã€è‡ªåŠ¨ç”Ÿæˆæ¡Œè´´ã€æ–°ç”Ÿå‡è¡¡åˆ†ç­ã€åº§ä½è¡¨æ™ºèƒ½æ’åˆ—ï¼ˆè€ƒè™‘è§†åŠ›/èº«é«˜/çŸ›ç›¾ï¼‰ç­‰åŠŸèƒ½ã€‚</p>
            </div>
            <div class="sec-head"><h2><i class="ti ti-id-badge-2"></i> æ™ºèƒ½è€ƒåœºç¼–æ’å™¨</h2><div><button class="btn btn-green" onclick="EXAM_exportResult()">ğŸ“Š å¯¼å‡ºè€ƒåŠ¡Excel</button><button class="btn btn-orange" onclick="EXAM_generateDeskLabels()">ğŸ·ï¸ æ‰¹é‡æ‰“å°æ¡Œè´´</button><button class="btn btn-purple" onclick="window.print()">ğŸ–¨ æ‰¹é‡æ‰“å°æ¡Œè´´</button></div></div>
            <div class="control-panel" style="flex-direction: column; align-items: stretch;">
                <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                    <div class="upload-box" style="flex:1; padding:20px; min-width:250px;" onclick="document.getElementById('examFileInput').click()">
                        <div class="upload-icon"><i class="ti ti-file-certificate"></i></div>
                        <div style="font-weight:bold;">å¯¼å…¥æœ¬æ¬¡è€ƒè¯•å­¦ç”Ÿåå•</div>
                        <div style="font-size:12px; color:#64748b;">è‡ªåŠ¨è¯†åˆ«å§“å/ç­çº§/æ€»åˆ†(è‡ªåŠ¨æŒ‰åˆ†æ’åº)</div>
                        <input type="file" id="examFileInput" accept=".xlsx,.xls" hidden onchange="EXAM_loadData(this)">
                    </div>
                   <div style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:15px; background:#f8fafc; padding:10px; border-radius:8px;">
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div><label style="width:80px;font-weight:bold;">è€ƒå·å‰ç¼€ï¼š</label><input type="text" id="exam_prefix" value="202501" style="width:100px;"></div>
                    <div><label style="width:80px;font-weight:bold;">æ¯åœºäººæ•°ï¼š</label><input type="number" id="exam_seats_per_room" value="30" style="width:100px;"></div>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="checkbox" id="exam_opt_separate" checked> 
                        <span style="margin-left:5px;">ğŸ”€ <b>åŒç­äº’æ–¥</b> (é˜²ä½œå¼Š)</span>
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="checkbox" id="exam_opt_snake"> 
                        <span style="margin-left:5px;">ğŸ <b>Så‹è›‡å½¢æ’åˆ—</b> (åº§ä½å·)</span>
                    </label>
                </div>
                <button class="btn btn-primary" style="grid-column: 1/-1; margin-top:5px;" onclick="EXAM_generate()">
                    ğŸš€ æ™ºèƒ½ç”Ÿæˆè€ƒåœºå®‰æ’
                </button>
            </div>
                </div>
                <div id="exam-results-area" class="hidden">
                    <div class="nav-sub-items" style="margin-bottom:15px; background:#f1f5f9; border-radius:6px; border:none;">
                        <div class="nav-link active" onclick="EXAM_switchView('overview', this)">ğŸ‘€ è€ƒåœºæ¦‚è§ˆ</div>
                        <div class="nav-link" onclick="EXAM_switchView('setup', this)">ğŸ‘¨â€ğŸ« äººå‘˜é…ç½®</div>
                        <div class="nav-link" onclick="EXAM_switchView('students', this)">ğŸ“‹ è€ƒç”ŸæŸ¥è¯¢è¡¨</div>
                        <div class="nav-link" onclick="EXAM_switchView('proctor', this)">ğŸ‘® ç›‘è€ƒæ±‡æ€»è¡¨</div>
                    </div>
                    <div id="exam-view-overview">
                        <div class="info-bar">ğŸ’¡ ç‚¹å‡»è€ƒåœºå¡ç‰‡å¯æŸ¥çœ‹è¯¥è€ƒåœºçš„è¯¦ç»†åº§æ¬¡è¡¨ã€‚æ‰“å°æ—¶ä¼šè‡ªåŠ¨åˆ†é¡µã€‚</div>
                        <div id="exam_room_grid" class="exam-room-grid"></div>
                    </div>
                    <div id="exam-view-students" class="hidden">
                         <div class="table-wrap"><table id="exam_student_table"><thead><tr><th>è€ƒå·</th><th>å§“å</th><th>ç­çº§</th><th>è€ƒåœºå·</th><th>åº§å·</th><th>ä¸Šæ¬¡æˆç»©</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div id="exam-view-setup" class="hidden">
                        <div class="info-bar">ä¾æ®ã€æ•°æ®ä¸­å¿ƒã€‘å¯¼å…¥çš„æ•™å¸ˆä¿¡æ¯ï¼Œè¯·å‹¾é€‰ä¸åœ¨è€ƒåŠ¡åå•çš„äººå‘˜ï¼Œå¹¶åˆ†é…ç‰¹æ®Šè§’è‰²ã€‚</div>
                        <div class="proctor-setup-grid">
                            <!-- æ•™å¸ˆé»‘åå• -->
                            <div>
                                <span class="role-label"><i class="ti ti-user-x"></i> 1. æ’é™¤ä¸å‚åŠ ç›‘è€ƒçš„äººå‘˜ (å‹¾é€‰)</span>
                                <div id="proctor-teacher-pool" class="teacher-scroll-list">
                                    <!-- åŠ¨æ€åŠ è½½æ•™å¸ˆ -->
                                    <div style="color:#999; padding:20px; grid-column: 1/-1;">è¯·å…ˆå¯¼å…¥æ•™å¸ˆä¿¡æ¯...</div>
                                </div>
                            </div>
                            <!-- è§’è‰²åˆ†é… -->
                            <div>
                                <span class="role-label"><i class="ti ti-users"></i> 2. æŒ‡å®šç‰¹æ®Šå²—ä½ (å¤šé€‰/æŒ‰ä½Ctrl)</span>
                                <div class="role-group">
                                    <label class="role-label">âš–ï¸ çºªå¾‹å·¡è€ƒ/æ ¡çº§å·¡æŸ¥</label>
                                    <select id="proctor-role-patrol" class="role-select" multiple></select>
                                </div>
                                <div class="role-group" style="border-left: 4px solid #10b981;">
                                    <label class="role-label">ğŸ§¹ å«ç”Ÿè€ƒåŠ¡/åå‹¤ä¿éšœç»„</label>
                                    <select id="proctor-role-affairs" class="role-select" multiple></select>
                                </div>
                                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="EXAM_assignProctors()">
                                    ğŸš€ ä¸€é”®ç¼–æ’ç›‘è€ƒè¡¨ (2äºº/ç­)
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="exam-view-proctor" class="hidden">
                        <div class="table-wrap"><table id="exam_proctor_table" class="proctor-table"><thead><tr><th>è€ƒåœº</th><th>äººæ•°</th><th>èµ·æ­¢è€ƒå·</th><th>ç›‘è€ƒå‘˜ç­¾å­—</th><th>å·¡è€ƒå‘˜ç­¾å­—</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="grade-scheduler" class="section card-box">
            <div class="module-desc-bar" style="border-color: #7c3aed">
                <h3><i class="ti ti-calendar-time"></i> ä¸‹ä¸€å¹´çº§éƒ¨æ’è¯¾ç³»ç»Ÿ</h3>
                <p>è¯´æ˜ï¼šç‹¬ç«‹äºå½“å‰æˆç»©æ•°æ®ã€‚ç”¨äºæ–°å­¦æœŸæ’è¯¾ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯¾æ—¶ç»“æ„ã€åˆå ‚è¯¾ã€æ—©æ™šè‡ªä¹ ç‰¹å®šè§„åˆ™ä»¥åŠæ•™å¸ˆå‡è¡¡æ’ç­ã€‚</p>
            </div>
            
            <div class="sec-head">
                <h2><i class="ti ti-layout-grid"></i> çº§éƒ¨æ™ºèƒ½æ’è¯¾</h2>
                <div>
                    <button class="btn btn-purple" onclick="SCHEDULER.exportResult()">ğŸ“¥ å¯¼å‡ºè¯¾è¡¨(Excel)</button>
                    <button class="btn btn-orange" onclick="document.getElementById('schedulerImportFile').click()">ğŸ“¤ å¯¼å…¥å·²æœ‰è¯¾è¡¨ä¼˜åŒ–</button>
                    <button class="btn btn-gray" onclick="SCHEDULER.auditFatigue()">ğŸ§  AIç–²åŠ³å®¡è®¡</button>
                    <input type="file" id="schedulerImportFile" accept=".xlsx,.xls" hidden onchange="SCHEDULER.importExisting(this)">
                </div>
            </div>

            <!-- 1. åŸºç¡€é…ç½®é¢æ¿ -->
            <div class="control-panel" style="display:block;">
                <h4 style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">âš™ï¸ è¯¾æ—¶ç»“æ„é…ç½®</h4>
                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                    <div>
                        <label class="stat-label">ä¸ŠåˆèŠ‚æ•°</label>
                        <input type="number" id="sch_am_count" value="4" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">ä¸‹åˆèŠ‚æ•°</label>
                        <input type="number" id="sch_pm_count" value="4" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">æ™šè‡ªä¹ èŠ‚æ•°</label>
                        <input type="number" id="sch_eve_count" value="3" style="width:60px;">
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:15px;">
                        <label class="stat-label">å•èŠ‚æ—¶é•¿(åˆ†)</label>
                        <input type="number" id="sch_dur_class" value="45" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">è¯¾é—´æ—¶é•¿(åˆ†)</label>
                        <input type="number" id="sch_dur_break" value="10" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">å¤§è¯¾é—´ä½ç½®</label>
                        <select id="sch_big_break_pos" style="width:100px;">
                            <option value="2">ç¬¬2èŠ‚å</option>
                            <option value="3">ç¬¬3èŠ‚å</option>
                        </select>
                    </div>
                </div>

                <h4 style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">ğŸš§ å¸¸è§„è§„åˆ™çº¦æŸ</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px; font-size:13px;">
                    <label><input type="checkbox" id="sch_rule_fri_eve" checked> å‘¨äº”æ™šä¸Šä¸ä¸Šè¯¾</label>
                    <label><input type="checkbox" id="sch_rule_fri_pm" onchange="document.getElementById('sch_fri_pm_val').disabled=!this.checked"> å‘¨äº”ä¸‹åˆä»…ä¸Š <input type="number" id="sch_fri_pm_val" value="2" style="width:40px; padding:0;" disabled> èŠ‚</label>
                    <label><input type="checkbox" id="sch_rule_morning_read" checked> æ·»åŠ  [07:00] å°æ™¨è¯»+æ—©è¯»</label>
                    <label><input type="checkbox" id="sch_rule_noon_write" checked> æ·»åŠ  [13:30] åˆé—´ç»ƒå­—/åˆå”±</label>
                    <div style="grid-column: 1/-1; background:#fff; padding:8px; border:1px solid #eee; border-radius:4px;">
                        <strong>ğŸ”— åˆå ‚/è¿å ‚è§„åˆ™ (æ™šè‡ªä¹ ):</strong><br>
                        <select id="sch_combined_slot" style="margin-top:5px;">
                            <option value="eve_3">æ™šè‡ªä¹ ç¬¬3èŠ‚</option>
                            <option value="eve_all">æ•´ä¸ªæ™šè‡ªä¹ </option>
                        </select>
                        <span style="color:#666;"> å¿…é¡»ç”±åŒä¸€è€å¸ˆè·¨ç­è¿ä¸Š (å¦‚: 1,2,3ç­åˆå ‚)</span>
                    </div>
                </div>
            </div>

            <!-- 2. èµ„æºå¯¼å…¥ -->
            <div style="display:flex; gap:20px; margin-top:20px;">
                <div class="upload-box" style="flex:1; min-height:150px; padding:20px;" onclick="document.getElementById('schTeacherFile').click()">
                    <div class="upload-icon"><i class="ti ti-users"></i></div>
                    <div style="font-weight:bold;">å¯¼å…¥æ–°å­¦æœŸæ•™å¸ˆä»»è¯¾è¡¨ (Excel)</div>
                    <div style="font-size:12px; color:#64748b;">
                        å¿…éœ€åˆ—: [æ•™å¸ˆå§“å] [å­¦ç§‘] [ä»»æ•™ç­çº§] [å‘¨è¯¾æ—¶é‡]<br>
                        (ä¾‹å¦‚: å¼ ä¸‰ | è¯­æ–‡ | 701,702 | 12)
                    </div>
                    <input type="file" id="schTeacherFile" accept=".xlsx,.xls" hidden onchange="SCHEDULER.loadData(this)">
                </div>
                
                <div style="flex:2; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:15px; max-height:200px; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between;">
                        <h4 style="margin:0;">ğŸ“‹ å¾…æ’è¯¾ç¨‹èµ„æºé¢„è§ˆ</h4>
                        <button class="btn btn-sm btn-green" onclick="SCHEDULER.downloadTemplate()"><i class="ti ti-download"></i> ä¸‹è½½ä»»è¯¾æ¨¡æ¿</button>
                    </div>
                    <div id="sch_resource_preview" style="margin-top:10px; font-size:12px; color:#666;">
                        è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶...
                    </div>
                </div>
            </div>

            <!-- 3. åŠ¨æ€çº¦æŸé…ç½®åŒº (æ ¸å¿ƒä¿®æ”¹) -->
            <div class="constraints-box" style="margin-top:20px; background:#fff; border:1px solid #e2e8f0; box-shadow:0 4px 6px rgba(0,0,0,0.02);">
                <h4 style="color:#4f46e5; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:15px;">
                    <i class="ti ti-adjustments-alt"></i> æ’è¯¾è§„åˆ™ä¸ç‰¹æ®Šçº¦æŸ (åŠ¨æ€é…ç½®)
                </h4>
                
                <div class="constraints-grid" style="grid-template-columns: 1fr 1fr; gap:20px;">

                    <!-- 0. æ™šè‡ªä¹ åˆå ‚/è¿å ‚è§„åˆ™ (æ›¿æ¢äº†åŸæ¥çš„ç®€å•ä¸‹æ‹‰æ¡†) -->
                    <div style="grid-column: 1/-1; background:#fff7ed; padding:10px; border-radius:6px; border:1px solid #fdba74;">
                        <label style="font-weight:bold; color:#9a3412; margin-bottom:5px; display:block;">
                            ğŸ”— æ™šè‡ªä¹ åˆå ‚è§„åˆ™ (æŒ‡å®šå­¦ç§‘ + æ•™å¸ˆæ‰€æœ‰ç­çº§è¿ä¸Š)
                        </label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:5px;">
                            <span style="font-size:12px; color:#666;">å°†åœ¨:</span>
                            <select id="sch_comb_slot" style="width:120px; padding:4px; border:1px solid #fed7aa;">
                                <option value="eve_3">æ™šè‡ªä¹ ç¬¬3èŠ‚</option>
                                <option value="eve_2">æ™šè‡ªä¹ ç¬¬2èŠ‚</option>
                                <option value="eve_1">æ™šè‡ªä¹ ç¬¬1èŠ‚</option>
                            </select>
                            
                            <span style="font-size:12px; color:#666;">å…è®¸åˆå ‚çš„å­¦ç§‘:</span>
                            <select id="sch_comb_subject" style="width:100px; padding:4px; border:1px solid #fed7aa;">
                                <option value="ç‰©ç†">ç‰©ç†</option>
                                <option value="åŒ–å­¦">åŒ–å­¦</option>
                                <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                                <option value="æ”¿æ²»">æ”¿æ²»</option>
                                <option value="å†å²">å†å²</option>
                                <option value="åœ°ç†">åœ°ç†</option>
                                <option value="è¯­æ–‡">è¯­æ–‡</option>
                                <option value="æ•°å­¦">æ•°å­¦</option>
                                <option value="è‹±è¯­">è‹±è¯­</option>
                            </select>
                            
                            <button class="btn btn-sm" style="background:#ea580c; color:white;" onclick="SCHEDULER.addConstraint('combined')">
                                <i class="ti ti-link"></i> æ·»åŠ è§„åˆ™
                            </button>
                        </div>
                        <div id="sch_tags_combined" class="tag-widget-container" style="min-height:35px; background:white; border-color:#fed7aa;"></div>
                        <div style="font-size:11px; color:#c2410c; margin-top:4px;">
                            â„¹ï¸ é€»è¾‘ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¯»æ‰¾è¯¥å­¦ç§‘æ•™å¤šä¸ªç­çš„è€å¸ˆï¼Œå°è¯•åœ¨å‘¨ä¸€è‡³å‘¨äº”çš„æŒ‡å®šæ—¶æ®µï¼Œå®‰æ’å…¶æ‰€æœ‰ç­çº§ä¸€èµ·ä¸Šè¯¾ã€‚
                        </div>
                    </div>
                    
                    <!-- 1. ç­ä¼šè®¾ç½® (æ”¯æŒå¤šæ¬¡) -->
                    <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                        <label style="font-weight:bold; color:#333; margin-bottom:5px; display:block;">ğŸ« ç­ä¼š/å›ºå®šå…¨æ ¡æ´»åŠ¨</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="sch_meet_day" style="width:80px; padding:4px;">
                                <option value="1">å‘¨ä¸€</option><option value="2">å‘¨äºŒ</option><option value="3">å‘¨ä¸‰</option><option value="4">å‘¨å››</option><option value="5" selected>å‘¨äº”</option>
                            </select>
                            <select id="sch_meet_slot" style="flex:1; padding:4px;">
                                <option value="pm_3">ä¸‹åˆç¬¬3èŠ‚</option><option value="pm_4">ä¸‹åˆç¬¬4èŠ‚</option><option value="eve_1">æ™šè‡ªä¹ ç¬¬1èŠ‚</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="SCHEDULER.addConstraint('meeting')">â• æ·»åŠ </button>
                        </div>
                        <!-- åŠ¨æ€æ ‡ç­¾å®¹å™¨ -->
                        <div id="sch_tags_meeting" class="tag-widget-container" style="min-height:35px; background:white;"></div>
                    </div>

                    <!-- 2. æ•™å¸ˆç¦æ’ (å¼€ä¼š/è¯·å‡) -->
                    <div style="background:#fffbeb; padding:10px; border-radius:6px; border:1px solid #fcd34d;">
                        <label style="font-weight:bold; color:#b45309; margin-bottom:5px; display:block;">ğŸš« æ•™å¸ˆç¦æ’/å¼€ä¼š (ä¸æ’è¯¾)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="sch_busy_day" style="width:70px; padding:4px;">
                                <option value="1">å‘¨ä¸€</option><option value="5">å‘¨äº”</option><option value="3">å‘¨ä¸‰</option>
                            </select>
                            <input type="text" id="sch_busy_slots" placeholder="èŠ‚æ¬¡(å¦‚: 1,2 æˆ– am_1)" style="width:100px; padding:4px;">
                            <input type="text" id="sch_busy_name" placeholder="æ•™å¸ˆå§“å" style="flex:1; padding:4px;">
                            <button class="btn btn-sm btn-orange" onclick="SCHEDULER.addConstraint('busy')">â• æ·»åŠ </button>
                        </div>
                        <div id="sch_tags_busy" class="tag-widget-container" style="min-height:35px; background:white;"></div>
                    </div>

                    <!-- 3. æ•™ç ”æ´»åŠ¨/åŠå¤©æ— è¯¾ -->
                    <div style="grid-column: 1/-1; background:#f0fdf4; padding:10px; border-radius:6px; border:1px solid #86efac;">
                        <label style="font-weight:bold; color:#166534; margin-bottom:5px; display:block;">ğŸ—“ï¸ æ•™ç ”ç»„æ´»åŠ¨ / åŠå¤©æ— è¯¾ (æ‰¹é‡é”æ­»)</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:5px;">
                            <select id="sch_act_day" style="width:80px; padding:4px;">
                                <option value="3">å‘¨ä¸‰</option><option value="1">å‘¨ä¸€</option><option value="2">å‘¨äºŒ</option><option value="4">å‘¨å››</option><option value="5">å‘¨äº”</option>
                            </select>
                            <select id="sch_act_range" style="width:120px; padding:4px;">
                                <option value="pm_all">æ•´ä¸ªä¸‹åˆ</option>
                                <option value="am_all">æ•´ä¸ªä¸Šåˆ</option>
                                <option value="custom">æŒ‡å®šèŠ‚æ¬¡â†’</option>
                            </select>
                            <input type="text" id="sch_act_custom_slots" placeholder="å¦‚: 6,7,8" style="width:80px; padding:4px; display:none;">
                            
                            <span>å¯¹è±¡:</span>
                            <select id="sch_act_subject" style="width:100px; padding:4px;">
                                <option value="ALL">å…¨çº§éƒ¨(æ— è¯¾)</option>
                                <option value="è¯­æ–‡">è¯­æ–‡ç»„</option><option value="æ•°å­¦">æ•°å­¦ç»„</option><option value="è‹±è¯­">è‹±è¯­ç»„</option>
                                <option value="ç‰©ç†">ç‰©ç†ç»„</option><option value="åŒ–å­¦">åŒ–å­¦ç»„</option><option value="æ”¿æ²»">æ”¿æ²»ç»„</option>
                            </select>
                            <button class="btn btn-sm btn-green" onclick="SCHEDULER.addConstraint('activity')">â• æ·»åŠ æ´»åŠ¨</button>
                        </div>
                        <div id="sch_tags_activity" class="tag-widget-container" style="min-height:35px; background:white;"></div>
                    </div>
                </div>
                
                <div style="font-size:11px; color:#666; margin-top:5px; padding-left:5px;">
                    ğŸ’¡ æç¤ºï¼šæ•™å¸ˆç¦æ’æ”¯æŒè¾“å…¥ "ä¸Šåˆ"ã€"ä¸‹åˆ" æˆ–å…·ä½“æ•°å­— "1,2"ï¼›å…¨çº§éƒ¨æ— è¯¾ä¼šè‡ªåŠ¨è·³è¿‡æ’è¯¾ã€‚
                </div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn btn-primary" style="padding:12px 30px; font-size:16px;" onclick="SCHEDULER.run()">
                    ğŸš€ å¼€å§‹æ™ºèƒ½æ’è¯¾
                </button>
            </div>

            <!-- 4. ç»“æœå±•ç¤º -->
            <div id="sch_result_area" class="hidden" style="margin-top:20px;">
                <div class="sub-header">ğŸ“… æ’è¯¾ç»“æœé¢„è§ˆ (ç‚¹å‡»å•å…ƒæ ¼å¯å¾®è°ƒ)</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="sch_view_mode" onchange="SCHEDULER.renderTable()">
                        <option value="class">æŒ‰ç­çº§æŸ¥çœ‹</option>
                        <option value="teacher">æŒ‰æ•™å¸ˆæŸ¥çœ‹</option>
                    </select>
                    <select id="sch_view_target" onchange="SCHEDULER.renderTable()">
                        <!-- åŠ¨æ€å¡«å……ç­çº§æˆ–æ•™å¸ˆå -->
                    </select>
                </div>
                <div class="table-wrap">
                    <table id="sch_table" style="text-align:center; font-size:12px;">
                        <!-- JS æ¸²æŸ“ -->
                    </table>
                </div>
            </div>

            <!-- 5. AI ç–²åŠ³å®¡è®¡ -->
            <div id="sch_audit_area" class="hidden" style="margin-top:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px;">
                <div class="sub-header">ğŸ§  æ’è¯¾ç–²åŠ³å®¡è®¡ç»“æœ</div>
                <div id="sch_audit_summary" style="font-size:12px; color:#64748b; margin-bottom:6px;"></div>
                <div id="sch_audit_list" class="tag-widget-container" style="min-height:40px; background:white;"></div>
            </div>
        </div>

        <div id="poster-generator" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-photo-star"></i> å–œæŠ¥/çº¢æ¦œç”Ÿæˆå™¨</h2>
                <div class="control-panel" style="margin-bottom:0; padding:5px; border:none; background:none;">
                    <button class="btn btn-purple" onclick="downloadPoster()">â¬‡ï¸ ä¿å­˜å›¾ç‰‡</button>
                </div>
            </div>
            
            <div class="poster-workspace">
                <!-- å·¦ä¾§ï¼šæ§åˆ¶å™¨ -->
                <div class="poster-controls">
                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ¨ 1. é€‰æ‹©ä¸»é¢˜</h4>
                    <div class="thumb-select">
                        <div class="thumb-btn active" onclick="setPosterTheme('red', this)">ğŸ§§ å¤§çº¢å–œæŠ¥</div>
                        <div class="thumb-btn" onclick="setPosterTheme('blue', this)">ğŸ“˜ æ¸…çˆ½è“è°ƒ</div>
                        <div class="thumb-btn" onclick="setPosterTheme('tech', this)">ğŸ¤– èµ›åšç§‘æŠ€</div>
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">ğŸ“Š 2. æ•°æ®æ¥æº</h4>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">å­¦æ ¡ï¼š</label>
                        <select id="posterSchoolSelect" style="width:100%; margin-bottom:5px;" onchange="updatePosterClassSelect()">
                            <option value="">--è¯·é€‰æ‹©--</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">ç­çº§ (å¯é€‰)ï¼š</label>
                        <select id="posterClassSelect" style="width:100%; margin-bottom:5px;">
                            <option value="">å…¨æ ¡æ’å</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">æ¦œå•ç±»å‹ï¼š</label>
                        <select id="posterSubjectSelect" style="width:100%; margin-bottom:5px;">
                            <option value="total">ğŸ† æ€»åˆ†å…‰è£æ¦œ</option>
                            <!-- JSåŠ¨æ€å¡«å……ç§‘ç›® -->
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">ä¸Šæ¦œäººæ•°ï¼š</label>
                        <input type="number" id="posterCount" value="10" min="1" max="50" style="width:100%;">
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">ğŸ“ 3. æ–‡æ¡ˆå®šåˆ¶</h4>
                    <div style="margin-bottom:5px;"><input type="text" id="posterTitleInput" value="å…‰è£æ¦œ" placeholder="å¤§æ ‡é¢˜" style="width:100%;"></div>
                    <div style="margin-bottom:10px;"><input type="text" id="posterSubInput" value="æœ¬æ¬¡æœŸæœ«è€ƒè¯•ä¼˜ç§€åå•" placeholder="å‰¯æ ‡é¢˜" style="width:100%;"></div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="renderPoster()">ğŸ”„ ç”Ÿæˆ/åˆ·æ–°é¢„è§ˆ</button>
                </div>

                <!-- å³ä¾§ï¼šé¢„è§ˆç”»å¸ƒ -->
                <div class="poster-preview-area">
                    <div id="poster-canvas" class="poster-canvas theme-red">
                        <div class="p-header">
                            <h1 class="p-title" contenteditable="true">å…‰è£æ¦œ</h1>
                            <div class="p-sub" contenteditable="true">2024-2025å­¦å¹´ ç¬¬ä¸€å­¦æœŸæœŸæœ«è€ƒè¯•</div>
                        </div>
                        <div class="p-list" id="poster-list-container">
                            <!-- åˆ—è¡¨é¡¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                            <div style="text-align:center; padding-top:100px; opacity:0.7;">
                                è¯·åœ¨å·¦ä¾§é€‰æ‹©æ•°æ®å¹¶ç‚¹å‡»ç”Ÿæˆ
                            </div>
                        </div>
                        <div class="p-footer" contenteditable="true">
                            æ˜Ÿå…‰ä¸é—®èµ¶è·¯äºº Â· æ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäºº<br>
                            xxä¸­å­¦æ•™åŠ¡å¤„ å®£
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div id="ai-chat-widget" style="position:fixed; bottom:30px; right:30px; z-index:9999; font-family:sans-serif;">
    <!-- 1. æ‚¬æµ®çƒ -->
    <div id="ai-chat-fab" onclick="toggleAIChat()" 
         style="width:60px; height:60px; background:linear-gradient(135deg, #6366f1, #4f46e5); border-radius:50%; box-shadow:0 10px 25px -5px rgba(79, 70, 229, 0.5); cursor:pointer; display:flex; align-items:center; justify-content:center; color:white; font-size:30px; transition:transform 0.2s;">
        <i class="ti ti-message-chatbot"></i>
    </div>

    <!-- 2. å¯¹è¯çª—å£ -->
    <div id="ai-chat-box" class="hidden" 
         style="position:absolute; bottom:80px; right:0; width:400px; height:550px; background:white; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); display:flex; flex-direction:column; overflow:hidden; border:1px solid #e2e8f0;">
        
        <!-- æ ‡é¢˜æ  -->
        <div style="padding:15px; background:#4f46e5; color:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:bold;"><i class="ti ti-sparkles"></i> æ™ºèƒ½æ•°æ®åŠ©ç†</div>
            <div style="font-size:12px; opacity:0.8;">åŸºäºæœ¬åœ°æ•°æ®</div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="ai-chat-messages" style="flex:1; padding:15px; overflow-y:auto; background:#f8fafc; display:flex; flex-direction:column; gap:10px;">
            <div class="ai-msg-bubble system">
                ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ•°æ®åŠ©ç†ã€‚<br>ä½ å¯ä»¥è¿™æ ·é—®æˆ‘ï¼š
                <ul style="padding-left:20px; margin:5px 0; font-size:12px;">
                    <li>â€œåˆ—å‡ºä¸ƒå¹´çº§æ€»åˆ†å‰10åçš„å­¦ç”Ÿâ€</li>
                    <li>â€œæ‰¾å‡ºæ•°å­¦ä¸åŠæ ¼ä½†æ€»åˆ†æ’åå‰100çš„å­¦ç”Ÿâ€</li>
                    <li>â€œç­›é€‰å‡ºè‹±è¯­æ¯”æ•°å­¦é«˜20åˆ†ä»¥ä¸Šçš„åç§‘ç”Ÿâ€</li>
                    <li>â€œæŸ¥æ‰¾è¿›æ­¥è¶…è¿‡50åçš„æ½œåŠ›ç”Ÿâ€</li>
                </ul>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div style="padding:15px; background:white; border-top:1px solid #e2e8f0;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="ai-chat-input" placeholder="è¾“å…¥æŸ¥è¯¢æŒ‡ä»¤..." 
                       style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px; outline:none;"
                       onkeydown="if(event.key==='Enter') sendAIChat()">
                <button onclick="sendAIChat()" 
                        style="background:#4f46e5; color:white; border:none; padding:0 15px; border-radius:8px; cursor:pointer;">
                    <i class="ti ti-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .ai-msg-bubble { max-width: 85%; padding: 10px 12px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
    .ai-msg-bubble.system { align-self: flex-start; background: #e0e7ff; color: #3730a3; border-bottom-left-radius: 2px; }
    .ai-msg-bubble.user { align-self: flex-end; background: #3b82f6; color: white; border-bottom-right-radius: 2px; }
    .ai-chat-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; background: white; border-radius: 6px; overflow: hidden; }
    .ai-chat-table th { background: #f1f5f9; padding: 5px; text-align: left; color: #64748b; }
    .ai-chat-table td { border-bottom: 1px solid #f1f5f9; padding: 5px; color: #333; }
    .ai-error-box { color: #dc2626; background: #fee2e2; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 5px; }
</style>

    <!-- è¯­éŸ³æ§åˆ¶å…¥å£ -->
    <div id="voice-fab" class="voice-fab" onclick="VoiceControl.toggle()" title="ç‚¹å‡»å¼€å¯è¯­éŸ³æ§åˆ¶">
        <i class="ti ti-microphone"></i>
    </div>

    <!-- å…¨å±è¯­éŸ³ HUD -->
    <div id="voice-hud" class="voice-hud" onclick="VoiceControl.stop()">
        <div class="voice-wave">
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
        </div>
        <div id="voice-status" class="voice-text-main">æ­£åœ¨è†å¬...</div>
        <div id="voice-result" class="voice-text-sub">è¯·è¯´å‡ºæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šâ€œæ‰“å¼€å…¨ç§‘æ€»è¡¨â€</div>
        
        <div class="voice-cmd-list">
            <div class="voice-cmd-item"><span class="voice-cmd-key">"çœ‹æ€»æ¦œ"</span> è·³è½¬ç»¼åˆæ’å</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"çœ‹æ•™å¸ˆ"</span> æ•™å¸ˆåˆ†æ</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"æŸ¥æŸæŸ"</span> æœç´¢å­¦ç”Ÿ</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"å…¨å±æ¨¡å¼"</span> éšè—èœå•</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"é€€å‡ºè¯­éŸ³"</span> å…³é—­è¯­éŸ³</div>
        </div>
        <div style="margin-top: 30px; font-size: 12px; color: #64748b;">(ç‚¹å‡»ä»»æ„å¤„å…³é—­)</div>
    </div>

    <div id="drill-modal" class="modal" style="display: none; z-index: 12000;">
        <!-- ä¿®æ”¹ç‚¹ï¼šstyle ä¸­å®½åº¦æ”¹ä¸º 95%ï¼Œmax-width æ”¹ä¸º 1200pxï¼Œé«˜åº¦æ”¹ä¸º 90vh -->
        <div class="modal-content" style="width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="drill-back-btn" class="btn btn-sm btn-gray hidden" onclick="DrillSystem.goBack()">
                        <i class="ti ti-arrow-left"></i> è¿”å›
                    </button>
                    <h3 id="drill-title" style="margin:0; color:var(--primary); font-size:18px;">æ•°æ®è¯¦æƒ…</h3>
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <!-- æ–°å¢å¯¼å‡ºæŒ‰é’® -->
                    <button id="drill-export-btn" class="btn btn-sm btn-green" onclick="DrillSystem.exportExcel()">
                        <i class="ti ti-file-export"></i> å¯¼å‡ºä¸ºExcel
                    </button>
                    <button onclick="document.getElementById('drill-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div id="drill-content" style="flex:1; overflow-y:auto;"></div>
            
            <!-- åº•éƒ¨ç»Ÿè®¡ -->
            <div id="drill-footer" style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; font-size:12px; color:#666; text-align:right;"></div>
        </div>
    </div>

    <div id="target-editor-modal" class="modal" style="display: none; z-index: 11500;">
        <div class="modal-content" style="width: 90%; max-width: 1000px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;">ğŸ¯ è®¾å®šå„æ ¡æŒ‡æ ‡ç›®æ ‡</h3>
                <button onclick="document.getElementById('target-editor-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="info-bar" style="margin-bottom:10px;">
                ğŸ’¡ æç¤ºï¼šæ­¤å¤„ä¿®æ”¹å°†ç›´æ¥æ›´æ–°å†…å­˜æ•°æ®ï¼Œè®°å¾—ç‚¹å‡»â€œå¼€å§‹è®¡ç®—â€åˆ·æ–°ç»“æœã€‚
            </div>

            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="target-editor-table">
                    <thead>
                        <tr>
                            <th>å­¦æ ¡åç§°</th>
                            <th style="background:#e0f2fe;">æŒ‡æ ‡ä¸€ç›®æ ‡ (äºº)</th>
                            <th style="background:#fff7ed;">æŒ‡æ ‡äºŒç›®æ ‡ (äºº)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-gray" onclick="document.getElementById('target-editor-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveTargetEditor()">ğŸ’¾ ä¿å­˜å¹¶é‡ç®—</button>
            </div>
        </div>
    </div>

    <style>
        /* é’»å–å¼¹çª—ä¸“ç”¨æ ·å¼ */
        .drill-class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .drill-class-card { 
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; 
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .drill-class-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-color: var(--primary); background: #eff6ff; }
        .drill-val { font-size: 18px; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .drill-label { font-size: 12px; color: #64748b; }
        
        .drill-stu-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .drill-stu-tag { 
            background: white; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 4px; 
            font-size: 13px; display: flex; align-items: center; gap: 5px;
        }
        .drill-stu-score { color: var(--primary); font-weight: bold; font-family: monospace; }
        .clickable-num { cursor: pointer; text-decoration: underline; color: var(--primary); font-weight: bold; }
        .clickable-num:hover { color: #d97706; }
    </style>
    <!-- æ‰¹é‡æ‰“å°éšè—å®¹å™¨ -->
    <div id="batch-print-container" style="display:none;"></div>
    <div id="desk-labels-print-area"></div>
    <!-- å…¨å±€å¿«æ·æœç´¢å¼¹çª— -->
    <div id="spotlight-mask" class="spotlight-mask" onclick="closeSpotlight(event)">
        <div class="spotlight-box" onclick="event.stopPropagation()">
            <div class="spotlight-input-wrap">
                <i class="ti ti-search" style="font-size:24px; color:var(--primary); margin-right:10px;"></i>
                <input type="text" id="spotlight-input" class="spotlight-input" placeholder="è¾“å…¥å§“åã€å­¦æ ¡æˆ–ç­çº§..." oninput="doSpotlightSearch()">
            </div>
            <div id="spotlight-results" class="spotlight-results"></div>
            <div class="spotlight-hint">è¾“å…¥å…³é”®å­—æœç´¢ï¼Œç‚¹å‡»ç»“æœå¯ç›´æ¥è·³è½¬è‡³è¯¥ç”Ÿåˆ†ææŠ¥å‘Š</div>
        </div>
    </div>
    <!-- æ•™å¸ˆè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="teacherModal" style="display: none;">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h3 id="modalTeacherName" style="color:var(--primary);">æ•™å¸ˆå§“å</h3><button id="closeModal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div class="bg-gray-50"><h4 style="margin-bottom:15px; color:#333;">æ•™å­¦æ¦‚å†µ</h4><div style="display:flex; justify-content:space-around;"><div class="stat-item"><div class="stat-value" id="modalAvgScore">0.00</div><div class="stat-label">å¹³å‡åˆ†</div></div><div class="stat-item"><div class="stat-value" id="modalExcellentRate">0%</div><div class="stat-label">ä¼˜ç§€ç‡</div></div><div class="stat-item"><div class="stat-value" id="modalPassRate">0%</div><div class="stat-label">åŠæ ¼ç‡</div></div></div></div>
                <div class="bg-gray-50"><h4 style="margin-bottom:15px; color:#333;">å¯¹æ¯”åˆ†æ</h4><div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;"><span>å¹³å‡åˆ†å¯¹æ¯”</span><span id="modalAvgComparison">0%</span></div><div style="height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden;"><div id="modalAvgProgress" style="width:0; height:100%; transition:1s;"></div></div></div></div>
            </div>
            <table class="subject-table" id="modalSubjectTable"><thead><tr><th>å­¦ç§‘</th><th>å¹³å‡åˆ†</th><th>å¯¹æ¯”</th><th>ä¼˜ç§€ç‡</th><th>å¯¹æ¯”</th><th>åŠæ ¼ç‡</th><th>å¯¹æ¯”</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div class="modal" id="mobileShareModal" style="display: none; z-index: 10001;">
        <div class="modal-content" style="max-width: 450px; text-align: center; background: #333;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:white; font-size:16px;">ğŸ“± é•¿æŒ‰/å³é”®ä¿å­˜å›¾ç‰‡</h3>
                <button onclick="document.getElementById('mobileShareModal').style.display='none'" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="mobile-img-result" style="max-height: 80vh; overflow-y: auto; border:1px solid #555;">
                <!-- å›¾ç‰‡å°†ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" onclick="downloadMobileImage()">â¬‡ï¸ ä¸‹è½½å›¾ç‰‡</button>
            </div>
        </div>
    </div>
    <!-- åŒååŒå§“/è½¬ç­ æ‰‹åŠ¨æ˜ å°„ç¡®è®¤æ¡† -->
    <div class="modal" id="mappingModal" style="display: none; z-index: 10002;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="color:#d97706; font-size:18px;">âš ï¸ æ£€æµ‹åˆ°ç–‘ä¼¼åŒå/è½¬ç­å­¦ç”Ÿ</h3>
                <p style="font-size:13px; color:#666; margin-top:5px;">
                    ç³»ç»Ÿå‘ç°ä»¥ä¸‹å­¦ç”Ÿåœ¨â€œä¸Šæ¬¡è€ƒè¯•â€ä¸­æœ‰åŒåè®°å½•ï¼Œä½†ç­çº§ä¸ä¸€è‡´ï¼ˆå¯èƒ½è½¬ç­äº†ï¼‰ã€‚<br>
                    è¯·æ‰‹åŠ¨ç¡®è®¤å¯¹åº”å…³ç³»ï¼Œä»¥ä¾¿ç²¾ç¡®è®¡ç®—è¿›é€€æ­¥ã€‚
                </p>
            </div>
            
            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="mappingTable" style="width:100%; font-size:13px;">
                    <thead>
                        <tr>
                            <th style="background:#fef3c7;">å½“å‰å­¦ç”Ÿ (æœ¬æ¬¡)</th>
                            <th style="background:#fef3c7;">é€‰æ‹©å¯¹åº”çš„ä¸Šæ¬¡è®°å½•</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-gray" onclick="document.getElementById('mappingModal').style.display='none'">å–æ¶ˆåˆ†æ</button>
                <button class="btn btn-primary" onclick="confirmMappingsAndRun()">âœ… ç¡®è®¤åŒ¹é…å¹¶ç»§ç»­</button>
            </div>
        </div>
    </div>
    <!-- ç”µå­å¥–çŠ¶æ¨¡æ€æ¡† -->
    <div id="cert-modal" class="modal" style="display: none; z-index: 10005;">
        <div class="modal-content" style="max-width: 550px; text-align: center; background: #fff; padding: 10px;">
            <!-- è¿™é‡Œæ˜¯å¥–çŠ¶çš„å¯è§†åŒ–åŒºåŸŸ -->
            <div id="cert-capture-area" style="padding: 40px; background: #fffaf0; border: 12px double #b45309; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(180,83,9,0.05);">
                <!-- èƒŒæ™¯è£…é¥°ï¼šç”±äºæ˜¯å•æ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨ CSS ç”»ä¸€ä¸ªç®€æ˜“é˜²ä¼ªå°ç« æ•ˆæœ -->
                <div style="position: absolute; bottom: 30px; right: 40px; width: 100px; height: 100px; border: 3px solid rgba(220,38,38,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(220,38,38,0.2); font-weight: bold; transform: rotate(-15deg); pointer-events: none; font-size: 14px;">æ•™åŠ¡å¤„æ ¸å‡†</div>
                
                <h1 style="color: #b45309; font-size: 42px; margin-bottom: 5px; font-family: 'STKaiti', 'æ¥·ä½“', serif;">è£èª‰è¯ä¹¦</h1>
                <div style="width: 150px; height: 3px; background: #b45309; margin: 0 auto 25px;"></div>
                
                <p style="font-size: 22px; margin-top: 20px; text-align: left; line-height: 2;">
                    <strong id="cert-name" style="border-bottom: 2px solid #333; padding: 0 15px; color: #1e293b;">å¼ ä¸‰</strong> åŒå­¦ï¼š
                </p>
                <p style="text-align: left; text-indent: 2.5em; line-height: 2; font-size: 18px; color: #374151;">
                    åœ¨æœ¬æ¬¡ <span id="cert-exam-name" style="font-weight: bold; color: #2563eb;">æœŸæœ«è€ƒè¯•</span> ä¸­ï¼Œå‡­å€ŸåšæŒä¸æ‡ˆçš„åŠªåŠ›å’Œå‡ºè‰²çš„è¡¨ç°ï¼Œè·å¾—äº†
                    <strong id="cert-honor" style="color: #dc2626; font-size: 24px;">â€œè¿›æ­¥ä¹‹æ˜Ÿâ€</strong>
                    å…‰è£ç§°å·ï¼Œç‰¹å‘æ­¤è¯ï¼Œä»¥èµ„é¼“åŠ±ï¼
                </p>
                <div style="margin-top: 50px; text-align: right; padding-right: 20px;">
                    <p style="font-weight: bold; font-size: 18px; color: #1e293b;" id="cert-school-footer">XXä¸­å­¦æ•™åŠ¡å¤„</p>
                    <p id="cert-date" style="color: #64748b;">2024å¹´12æœˆ</p>
                </div>
            </div>
            
            <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 20px; display: flex; gap: 15px; padding: 10px;">
                <button class="btn btn-orange" style="flex:1; font-size: 16px; height: 45px;" onclick="downloadCertificate()">
                    <i class="ti ti-download"></i> ä¿å­˜å¥–çŠ¶ä¸ºé«˜æ¸…å›¾ç‰‡
                </button>
                <button class="btn btn-gray" style="width: 100px;" onclick="document.getElementById('cert-modal').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>
    <div id="school-profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="sp-title" style="margin:0; color:var(--primary); font-size:20px;">ğŸ« å­¦æ ¡ç”»åƒ</h3>
                <button onclick="document.getElementById('school-profile-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="school-modal-grid">
                <!-- å·¦ä¾§ï¼šé›·è¾¾å›¾ -->
                <div style="background:#f8fafc; border-radius:8px; padding:10px; border:1px solid #e2e8f0; height:300px; position:relative;">
                    <h4 style="text-align:center; font-size:13px; color:#64748b; margin-bottom:5px;">å­¦ç§‘å‡è¡¡åº¦è¯Šæ–­ (vs å…¨é•‡å‡å€¼)</h4>
                    <div style="height:260px; width:100%;"><canvas id="schoolRadarChart"></canvas></div>
                </div>
                
                <!-- å³ä¾§ï¼šæ•°æ®æ¦‚è§ˆ -->
                <div>
                    <h4 style="margin-bottom:10px; border-left:4px solid var(--primary); padding-left:8px;">ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</h4>
                    <div class="fb-dashboard" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">ç»¼åˆæ’å</div>
                            <div class="fb-val text-red" id="sp-rank">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">è€ƒæ ¸æ€»åˆ†</div>
                            <div class="fb-val text-blue" id="sp-score">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">å¹³å‡åˆ†èµ‹åˆ†</div>
                            <div class="fb-val" id="sp-s1">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">ä¸‰ç‡èµ‹åˆ†</div>
                            <div class="fb-val" id="sp-s2">-</div>
                        </div>
                    </div>
                    
                    <div class="info-bar" style="font-size:12px;">
                        ğŸ’¡ <strong>è¯Šæ–­å»ºè®®ï¼š</strong><br>
                        <span id="sp-diagnosis">ç‚¹å‡»å­¦æ ¡æŸ¥çœ‹åˆ†æ...</span>
                    </div>
                </div>
            </div>

            <!-- åˆ†æ•°æ®µåˆ†å¸ƒå›¾ (åŒè½´) -->
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #e2e8f0;">
                <h4 style="margin-bottom:10px; color:#333; font-size:14px; display:flex; justify-content:space-between;">
                    <span>ğŸ“‰ åˆ†æ•°æ®µç»“æ„å¯¹æ¯” (æœ¬æ ¡ vs å…¨é•‡)</span>
                    <span style="font-weight:normal; font-size:12px; color:#666;">æŸ±çŠ¶=æœ¬æ ¡å æ¯” | æŠ˜çº¿=å…¨é•‡å‡å€¼</span>
                </h4>
                <div style="height:180px; width:100%; position:relative;">
                    <canvas id="schoolDistChart"></canvas>
                </div>
            </div>

            <div class="school-modal-actions">
                <span style="font-size:12px; color:#999; margin-right:auto; align-self:center;">è·³è½¬åå°†è‡ªåŠ¨ç­›é€‰è¯¥æ ¡æ•°æ®</span>
                <button class="btn btn-purple" onclick="jumpToModule('class-comparison')"><i class="ti ti-layout-columns"></i> ç­çº§å¯¹æ¯”</button>
                <button class="btn btn-blue" onclick="jumpToModule('teacher-analysis')"><i class="ti ti-school"></i> æ•™å¸ˆè¯„ä»·</button>
                <button class="btn btn-green" onclick="jumpToModule('student-details')"><i class="ti ti-users"></i> å­¦ç”Ÿåå•</button>
            </div>
        </div>
    </div>
    <!-- å¤–è§‚è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="skin-modal" class="modal" style="display: none; z-index: 11000;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:var(--primary);"><i class="ti ti-palette"></i> ç³»ç»Ÿå¤–è§‚å®šåˆ¶</h3>
                <button onclick="document.getElementById('skin-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 1. ä¸»é¢˜è‰²è®¾ç½® -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">1. é€‰æ‹©ä¸»è‰²è°ƒ</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <!-- é¢„è®¾é¢œè‰² -->
                    <div onclick="setThemeColor('#4f46e5')" style="width:30px; height:30px; background:#4f46e5; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="é»˜è®¤ç´«"></div>
                    <div onclick="setThemeColor('#2563eb')" style="width:30px; height:30px; background:#2563eb; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="ç§‘æŠ€è“"></div>
                    <div onclick="setThemeColor('#059669')" style="width:30px; height:30px; background:#059669; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="æŠ¤çœ¼ç»¿"></div>
                    <div onclick="setThemeColor('#dc2626')" style="width:30px; height:30px; background:#dc2626; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="ä¸­å›½çº¢"></div>
                    <div onclick="setThemeColor('#b45309')" style="width:30px; height:30px; background:#b45309; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="å°Šè´µé‡‘"></div>
                    <div onclick="setThemeColor('#0f172a')" style="width:30px; height:30px; background:#0f172a; border-radius:50%; cursor:pointer; border:2px solid #ddd;" title="æ·±é‚ƒé»‘"></div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="color" id="custom-color-input" onchange="setThemeColor(this.value)" style="width:50px; height:30px; padding:0; border:none;">
                    <span style="font-size:12px; color:#666;">è‡ªå®šä¹‰é¢œè‰² (ç‚¹å‡»è‰²å—é€‰æ‹©)</span>
                </div>
            </div>

            <!-- 2. Logo è®¾ç½® -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">2. å®šåˆ¶æ ¡å¾½/Logo</h4>
                <div class="upload-box" style="padding:15px; border:1px dashed #ccc; min-height:auto;" onclick="document.getElementById('logoInput').click()">
                    <div style="color:var(--primary); font-size:20px;"><i class="ti ti-photo-up"></i> ç‚¹å‡»ä¸Šä¼  Logo å›¾ç‰‡</div>
                    <p style="font-size:12px; color:#999; margin:5px 0;">å»ºè®®ä½¿ç”¨é€æ˜èƒŒæ™¯ PNGï¼Œé«˜åº¦60pxå·¦å³<br>å›¾ç‰‡å°†ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</p>
                    <input type="file" id="logoInput" accept="image/*" hidden onchange="handleLogoUpload(this)">
                </div>
                <button class="btn btn-gray btn-sm" onclick="clearLogo()" style="margin-top:5px;">ğŸ—‘ï¸ æ¸…é™¤ Logo</button>
            </div>

            <!-- 3. æ ‡é¢˜è®¾ç½® -->
            <div style="margin-bottom: 10px;">
                <h4 style="margin-bottom:10px; color:#333;">3. ç³»ç»Ÿåç§°</h4>
                <input type="text" id="custom-title-input" placeholder="é»˜è®¤ä¸ºï¼šä¹¡é•‡å­¦æ ¡æˆç»©åˆ†æ..." style="width:100%; margin-bottom:5px;" oninput="updateTitlePreview(this.value)">
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="saveSkinSettings()">ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨</button>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="modal" style="display: none; z-index: 60000;">
        <div class="modal-content" style="max-width: 600px;"> <!-- ç¨å¾®è°ƒå®½ä¸€ç‚¹ -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="color:#b91c1c; margin:0;"><i class="ti ti-shield-lock"></i> è´¦å·ç®¡ç†</h3>
                <!-- æ–°å¢ï¼šæŸ¥çœ‹æ—¥å¿—æŒ‰é’® -->
                <button onclick="Logger.view()" style="font-size:12px; background:#fff; border:1px solid #ccc; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                    <i class="ti ti-history"></i> æ“ä½œæ—¥å¿—
                </button>
            </div>
            <button onclick="document.getElementById('admin-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
            
            <div class="info-bar" style="margin-bottom:20px;">
                æ­¤å¤„åŠŸèƒ½å°†åŸºäºæ‚¨åœ¨ã€æ•°æ®ä¸­å¿ƒã€‘ä¸Šä¼ çš„ Excel æ•°æ®æ‰¹é‡ç”Ÿæˆè´¦å·ã€‚<br>
                æ‰€æœ‰ç”Ÿæˆè´¦å·çš„é»˜è®¤åˆå§‹å¯†ç å‡ä¸º <strong>123456</strong>ã€‚
            </div>

            <div style="display:grid; gap:15px;">
                <!-- åŠŸèƒ½åŒº 1 -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <h4 style="margin-bottom:10px; color:#334155;">1. æ‰¹é‡ç”Ÿæˆ/é‡ç½®è´¦å·</h4>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px; font-weight:bold; color:#64748b; display:block; margin-bottom:5px;">
                            è¯·é€‰æ‹©è¦ç”Ÿæˆçš„å­¦æ ¡ (å¤šé€‰):
                        </label>
                        <div id="admin-gen-school-list" style="max-height:100px; overflow-y:auto; background:white; border:1px solid #cbd5e1; border-radius:4px; padding:5px; font-size:12px;">
                            <div style="color:#999; text-align:center; padding:10px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æˆç»©</div>
                        </div>
                        <div style="text-align:right; margin-top:2px;">
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(true)" style="font-size:11px; color:var(--primary);">å…¨é€‰</a> / 
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(false)" style="font-size:11px; color:var(--primary);">æ¸…ç©º</a>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="Auth.generateAccounts()" style="width:100%;">
                        <i class="ti ti-user-plus"></i> ä¸€é”®ç”Ÿæˆæ‰€æœ‰è´¦å· (æ•™å¸ˆ+å®¶é•¿)
                    </button>
                    <button class="btn btn-green" onclick="Auth.exportAccounts()" style="width:100%; background:#059669; color:white;">
                        <i class="ti ti-file-export"></i> å¯¼å‡ºè´¦å·å¯†ç è¡¨ (Excel)
                    </button>
<!-- æ–°å¢ï¼šæ‰¹é‡åŒæ­¥äº‘ç«¯æŒ‰é’® -->
                <button class="btn btn-blue" onclick="Auth.syncBatchToCloud()" style="width:100%; background:#2563eb; color:white; margin-top:5px;">
                    <i class="ti ti-cloud-upload"></i> ä¸€é”®åŒæ­¥æ‰€æœ‰è´¦å·åˆ°äº‘ç«¯ (Database)
                </button>
                <p style="font-size:11px; color:#64748b; margin-top:2px; text-align:center;">
                    å°†æœ¬åœ°ç”Ÿæˆçš„è´¦å·æ‰¹é‡å†™å…¥ Supabase æ•°æ®åº“ï¼Œä»¥ä¾¿ç”¨æˆ·ç™»å½•ã€‚
                </p>
<!-- æ–°å¢ï¼šæ¸…ç©ºäº‘ç«¯æŒ‰é’® -->
                <div style="margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                    <button class="btn btn-danger" onclick="Auth.deleteCloudAccounts()" style="width:100%; background:#dc2626; color:white;">
                        <i class="ti ti-trash-x"></i> âš ï¸ æ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ™®é€šè´¦å·
                    </button>
                    <p style="font-size:11px; color:#ef4444; margin-top:2px; text-align:center;">
                        è­¦å‘Šï¼šå°†åˆ é™¤äº‘ç«¯æ‰€æœ‰å®¶é•¿å’Œæ•™å¸ˆè´¦å·ï¼ˆä¿ç•™ç®¡ç†å‘˜ï¼‰ã€‚
                    </p>
                </div>
                    <hr style="margin: 15px 0; border:0; border-top:1px dashed #ccc;">
                    <h4 style="margin-bottom:10px; color:#7c3aed;">ğŸš€ å‘é€ç»™å®¶é•¿</h4>
                    <button class="btn btn-purple" onclick="Packager.exportDistributableHTML()" style="width:100%; background:#7c3aed; color:white; font-weight:bold;">
                        <i class="ti ti-package"></i> ç”Ÿæˆå¯åˆ†å‘ç½‘é¡µ (å«æ•°æ®)
                    </button>
                    <p style="font-size:11px; color:#7c3aed; margin-top:5px; background:#f3e8ff; padding:5px; border-radius:4px;">
                        ç”Ÿæˆä¸€ä¸ªå†…ç½®äº†æˆç»©å’Œè´¦å·çš„æ–°HTMLæ–‡ä»¶ã€‚è¯·æŠŠè¿™ä¸ªæ–°æ–‡ä»¶å‘åˆ°å®¶é•¿ç¾¤ã€‚
                    </p>
                    <p style="font-size:12px; color:#666; margin-top:5px;">
                        æ•™å¸ˆè´¦å· = æ•™å¸ˆå§“å (é»˜è®¤å¯†ç  yssy2016)<br> <!-- ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šæ›´æ–°æ˜¾ç¤ºæ–‡æœ¬ -->
                        å®¶é•¿è´¦å· = å­¦ç”Ÿå§“å (é»˜è®¤å¯†ç  123456)
                    </p>
                </div>

                <!-- åŠŸèƒ½åŒº 2: äº‘ç«¯è´¦å·ç®¡ç† (ä¿®æ­£ç‰ˆ) -->
            <div style="background:#fff; padding:15px; border:1px solid #cbd5e1; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                
                <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ ä¿®æ”¹ï¼šå¢åŠ äº†ç­ä¸»ä»»ã€çº§éƒ¨ä¸»ä»»é€‰é¡¹ï¼Œä»¥åŠå³ä¾§çš„ Excel å·¥å…·æ  ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                     <h4 style="margin:0; color:#0369a1;"><i class="ti ti-cloud-upload"></i> 2. æ·»åŠ /ç®¡ç†äº‘ç«¯è´¦å·</h4>
                     <div style="display:flex; gap:5px;">
                        <button class="btn btn-sm btn-green" onclick="AccountExcel.downloadTemplate()" title="ä¸‹è½½å¯¼å…¥æ¨¡æ¿">
                            <i class="ti ti-download"></i> æ¨¡æ¿
                        </button>
                        <button class="btn btn-sm btn-orange" onclick="document.getElementById('accExcelInput').click()" title="ä¸Šä¼ Excelæ‰¹é‡å¯¼å…¥">
                            <i class="ti ti-file-import"></i> å¯¼å…¥
                        </button>
                        <input type="file" id="accExcelInput" accept=".xlsx,.xls" hidden onchange="AccountExcel.upload(this)">
                     </div>
                </div>

                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="manual-role" style="padding:8px; border:1px solid #ccc; width:30%; font-size:12px;" onchange="toggleAdminManualInput()">
                        <option value="teacher">ğŸ‘¨â€ğŸ« ç§‘ä»»æ•™å¸ˆ</option>
                        <option value="class_teacher">ğŸ“‹ ç­ä¸»ä»»</option>
                        <option value="grade_director">ğŸš€ çº§éƒ¨ä¸»ä»»</option>
                        <option value="director">ğŸ“ æ•™åŠ¡ä¸»ä»»</option>
                        <option value="parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿</option>
                        <option value="admin">ğŸ”‘ ç®¡ç†å‘˜</option>
                    </select>
                    <!-- çº§éƒ¨è¾“å…¥æ¡† (é»˜è®¤éšè—) -->
                    <input type="text" id="manual-grade" placeholder="çº§éƒ¨(å¦‚:7)" style="padding:8px; border:1px solid #ccc; width:20%; display:none;">
                    
                    <input type="text" id="manual-school" placeholder="æ‰€å±å­¦æ ¡ (å¿…å¡«)" style="padding:8px; border:1px solid #ccc; width:25%;">
                    <input type="text" id="manual-name" placeholder="è´¦å·/å§“å" style="padding:8px; border:1px solid #ccc; flex:1;">
                </div>

                <!-- ç­çº§è¾“å…¥æ¡† (é»˜è®¤éšè—ï¼Œä»…å®¶é•¿éœ€è¦) -->
                <div id="manual-class-wrap" style="margin-bottom:10px; display:none;">
                    <input type="text" id="manual-class" placeholder="è¾“å…¥ç­çº§ (å¦‚: 701ï¼Œå®¶é•¿å¿…å¡«)" style="width:100%; padding:8px; border:1px solid #ccc;">
                </div>

                <div style="display:flex; gap:10px;">
                    <input type="text" id="manual-pass" value="123456" placeholder="å¯†ç " style="padding:8px; border-radius:4px; border:1px solid #ccc; width:60%;">
                    <!-- è¿™é‡Œçš„ onclick å¿…é¡»æŒ‡å‘ Auth.addCloudAccount -->
                    <button class="btn btn-primary" onclick="Auth.addCloudAccount()" style="flex:1;">æ·»åŠ /æ›´æ–°</button>
                </div>
                <p style="font-size:12px; color:#999; margin-top:5px;">æç¤ºï¼šç›´æ¥å†™å…¥äº‘ç«¯æ•°æ®åº“ã€‚è´¦å·å¿…é¡»å”¯ä¸€ã€‚</p>
            </div>

            <script>
                // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šExcel è´¦å·æ‰¹é‡å¯¼å…¥å·¥å…· ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                const AccountExcel = {
                    downloadTemplate: function() {
                        const wb = XLSX.utils.book_new();
                        const headers = ["è§’è‰²", "å­¦æ ¡", "ç­çº§", "çº§éƒ¨(å¹´çº§)", "å§“å/è´¦å·", "å¯†ç ", "å¤‡æ³¨"];
                        const data = [
                            headers,
                            ["ç§‘ä»»æ•™å¸ˆ", "å®éªŒä¸­å­¦", "", "7", "å¼ è€å¸ˆ", "123456", "åªçœ‹è‡ªå·±æ•™çš„è¯¾"],
                            ["ç­ä¸»ä»»", "å®éªŒä¸­å­¦", "701", "7", "ç‹ç­å¤´", "123456", "çœ‹æœ¬ç­æ‰€æœ‰"],
                            ["çº§éƒ¨ä¸»ä»»", "å®éªŒä¸­å­¦", "", "7", "æçº§éƒ¨", "123456", "ç®¡ç†æ•´ä¸ªä¸ƒå¹´çº§"],
                            ["å®¶é•¿", "å®éªŒä¸­å­¦", "701", "", "å¼ å°æ˜", "123456", "åªèƒ½çœ‹è‡ªå·±"],
                            ["æ•™åŠ¡ä¸»ä»»", "å®éªŒä¸­å­¦", "", "", "èµµä¸»ä»»", "123456", "æŸ¥çœ‹å…¨æ ¡"]
                        ];
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        ws['!cols'] = [{wch:12}, {wch:15}, {wch:8}, {wch:10}, {wch:15}, {wch:10}, {wch:20}];
                        XLSX.utils.book_append_sheet(wb, ws, "è´¦å·å¯¼å…¥æ¨¡æ¿");
                        XLSX.writeFile(wb, "è´¦å·æ‰¹é‡å¯¼å…¥æ¨¡æ¿.xlsx");
                    },

                    upload: function(input) {
                        const file = input.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const wb = XLSX.read(data, {type: 'array'});
                                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                
                                if (json.length === 0) return alert("è¡¨æ ¼ä¸ºç©º");
                                if (!confirm(`è§£æåˆ° ${json.length} æ¡è´¦å·æ•°æ®ï¼Œç¡®å®šè¦å¯¼å…¥äº‘ç«¯å—ï¼Ÿ`)) return;

                                UI.loading(true, "æ­£åœ¨æ‰¹é‡åˆ›å»ºäº‘ç«¯è´¦å·...");
                                
                                const roleMap = {
                                    "ç§‘ä»»æ•™å¸ˆ": "teacher", "æ•™å¸ˆ": "teacher",
                                    "ç­ä¸»ä»»": "class_teacher",
                                    "çº§éƒ¨ä¸»ä»»": "grade_director", "å¹´çº§ä¸»ä»»": "grade_director",
                                    "å®¶é•¿": "parent", "å­¦ç”Ÿ": "parent",
                                    "æ•™åŠ¡ä¸»ä»»": "director",
                                    "ç®¡ç†å‘˜": "admin"
                                };

                                let successCount = 0;
                                const batchData = [];

                                json.forEach(row => {
                                    const roleCN = row['è§’è‰²'] || "";
                                    const role = roleMap[roleCN.trim()] || "teacher"; // é»˜è®¤æ•™å¸ˆ
                                    const user = row['å§“å/è´¦å·'] || row['å§“å'];
                                    const pass = row['å¯†ç '] || "123456";
                                    const school = row['å­¦æ ¡'] || window.MY_SCHOOL || "é»˜è®¤å­¦æ ¡";
                                    const cls = row['ç­çº§'] ? String(row['ç­çº§']).trim() : "";
                                    const grade = row['çº§éƒ¨(å¹´çº§)'] ? String(row['çº§éƒ¨(å¹´çº§)']).trim() : ""; // æ–°å¢çº§éƒ¨å­—æ®µ

                                    if (user) {
                                        batchData.push({
                                            username: user,
                                            password: pass.toString(),
                                            role: role,
                                            school: school,
                                            class_name: role === 'class_teacher' || role === 'parent' ? cls : (role === 'grade_director' ? grade : ""), // çº§éƒ¨ä¸»ä»»çš„classå­—æ®µå­˜å¹´çº§
                                            // æ³¨æ„ï¼šè¿™é‡Œå¤ç”¨äº† class_name å­—æ®µã€‚
                                            // å¯¹äºçº§éƒ¨ä¸»ä»»ï¼Œclass_name å­˜ "7" (ä»£è¡¨7å¹´çº§)
                                            // å¯¹äºç­ä¸»ä»»ï¼Œclass_name å­˜ "701"
                                        });
                                    }
                                });

                                // åˆ†æ‰¹å†™å…¥ Supabase
                                const { error } = await sbClient.from('system_users').upsert(batchData, { onConflict: 'username' });
                                
                                UI.loading(false);
                                if (error) throw error;
                                
                                alert(`âœ… æˆåŠŸå¯¼å…¥ ${batchData.length} ä¸ªè´¦å·ï¼`);
                                input.value = ''; // æ¸…ç©º

                            } catch (err) {
                                UI.loading(false);
                                alert("å¯¼å…¥å¤±è´¥ï¼š" + err.message);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                };

               // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ ä¿®æ”¹ï¼šè¾“å…¥æ¡†è”åŠ¨é€»è¾‘ (é€‚é…æ–°è§’è‰²) ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                function toggleAdminManualInput() {
                    const role = document.getElementById('manual-role').value;
                    const clsWrap = document.getElementById('manual-class-wrap'); // å®¶é•¿/ç­ä¸»ä»»ç”¨
                    const clsInput = document.getElementById('manual-class');
                    const nameInp = document.getElementById('manual-name');
                    const schoolInp = document.getElementById('manual-school');
                    const gradeInp = document.getElementById('manual-grade'); // çº§éƒ¨ä¸»ä»»ç”¨
                    
                    // 1. å…ˆå…¨éƒ¨éšè—/é‡ç½®
                    clsWrap.style.display = 'none';
                    gradeInp.style.display = 'none';
                    schoolInp.style.display = 'block'; // é»˜è®¤æ˜¾ç¤ºå­¦æ ¡
                    
                    // 2. æ ¹æ®è§’è‰²å¼€å¯ç‰¹å®šæ¡†
                    if (role === 'parent') {
                        clsWrap.style.display = 'block';
                        clsInput.placeholder = "è¾“å…¥ç­çº§ (å¦‚: 701ï¼Œå®¶é•¿å¿…å¡«)";
                        nameInp.placeholder = "å­¦ç”Ÿå§“å";
                    } 
                    else if (role === 'class_teacher') {
                        clsWrap.style.display = 'block'; 
                        clsInput.placeholder = "ç®¡ç†ç­çº§ (å¦‚: 701)";
                        nameInp.placeholder = "ç­ä¸»ä»»å§“å";
                    }
                    else if (role === 'grade_director') {
                        gradeInp.style.display = 'block'; // âœ… ç¡®ä¿è¿™è¡Œæ‰§è¡Œï¼Œæ˜¾ç¤ºå¹´çº§æ¡†
                        nameInp.placeholder = "ä¸»ä»»å§“å";
                    }
                    else if (role === 'director') {
                        nameInp.placeholder = "ä¸»ä»»å§“å";
                    } 
                    else if (role === 'admin') {
                        schoolInp.style.display = 'none'; // ç®¡ç†å‘˜ä¸éœ€è¦å¡«å­¦æ ¡
                        nameInp.placeholder = "ç®¡ç†å‘˜è´¦å·";
                    } 
                    else { // teacher
                        nameInp.placeholder = "æ•™å¸ˆå§“å";
                    }
                }
            </script>
                
                <!-- åŠŸèƒ½åŒº 3 -->
                <div style="background:#fff; padding:15px; border:1px solid #eee; border-radius:8px;">
                    <h4 style="margin-bottom:10px; color:#333;">3. ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-admin-pass" placeholder="è¾“å…¥æ–°å¯†ç " style="padding:8px; flex:1; border:1px solid #cbd5e1; border-radius:4px;">
                        <button class="btn btn-gray" onclick="changeAdminPass()">ç¡®è®¤ä¿®æ”¹</button>
                    </div>
                </div>
                <div style="background:#f0fdf4; padding:15px; border:1px solid #86efac; border-radius:8px; margin-top:5px;">
                    <h4 style="margin-bottom:10px; color:#166534;"><i class="ti ti-cloud-download"></i> 4. å¯¼å‡ºäº‘ç«¯æ‰€æœ‰è´¦å· (å®Œæ•´å¤‡ä»½)</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <p style="font-size:12px; color:#15803d; margin:0; flex:1;">
                            æ­¤åŠŸèƒ½ç›´æ¥ä»äº‘ç«¯æ•°æ®åº“ä¸‹è½½ï¼ŒåŒ…å«<strong>æ‰¹é‡ç”Ÿæˆ</strong>ã€<strong>æ‰‹åŠ¨æ·»åŠ </strong>åŠ<strong>Excelå¯¼å…¥</strong>çš„æ‰€æœ‰è´¦å·ã€‚<br>
                            åŒ…å«ï¼šè§’è‰²ã€å­¦æ ¡ã€ç­çº§ã€è´¦å·ã€å¯†ç ã€‚
                        </p>
                        <button class="btn btn-green" onclick="Auth.exportAllCloudAccounts()" style="background:#16a34a; color:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            <i class="ti ti-download"></i> ä¸‹è½½å…¨é‡è´¦å·è¡¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®€å•çš„ä¿®æ”¹å¯†ç è„šæœ¬ (å†…è” - äº‘ç«¯åŒæ­¥ç‰ˆ) -->
<script>
async function changeAdminPass() {
    const p = document.getElementById('new-admin-pass').value.trim();
    if(!p) return alert("å¯†ç ä¸èƒ½ä¸ºç©º");

    // 1. æ›´æ–°æœ¬åœ°çŠ¶æ€ (ç¡®ä¿å½“å‰ä¼šè¯ç«‹å³ç”Ÿæ•ˆ)
    if(typeof Auth !== 'undefined') {
        Auth.db.admin.pass = p;
        localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
    }

    // 2. åŒæ­¥åˆ°äº‘ç«¯æ•°æ®åº“ (æ ¸å¿ƒä¿®å¤)
    if(sbClient) {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const loader = document.getElementById('global-loader');
        const txt = document.getElementById('loader-text');
        if(loader) { loader.classList.remove('hidden'); if(txt) txt.innerText = "æ­£åœ¨æ›´æ–°äº‘ç«¯å¯†ç ..."; }

        try {
            // æ›´æ–° system_users è¡¨ä¸­ username='admin' çš„è®°å½•
            const { error } = await sbClient
                .from('system_users')
                .update({ password: p })
                .eq('username', 'admin');

            // éšè—åŠ è½½åŠ¨ç”»
            if(loader) loader.classList.add('hidden');

            if (error) {
                console.error(error);
                alert("âŒ æœ¬åœ°ä¿®æ”¹æˆåŠŸï¼Œä½†ã€äº‘ç«¯åŒæ­¥å¤±è´¥ã€‘ï¼\né”™è¯¯ä¿¡æ¯ï¼š" + error.message);
            } else {
                alert("âœ… ç®¡ç†å‘˜å¯†ç å·²ä¿®æ”¹ï¼\n(æœ¬åœ°å’Œäº‘ç«¯å‡å·²æ›´æ–°ä¸º: " + p + ")");
                document.getElementById('new-admin-pass').value = '';
            }
        } catch (err) {
            if(loader) loader.classList.add('hidden');
            alert("âŒ ç¨‹åºå¼‚å¸¸ï¼š" + err.message);
        }
    } else {
        alert("âš ï¸ è­¦å‘Šï¼šæœªè¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“ï¼Œä»…ä¿®æ”¹äº†æœ¬åœ°ç¼“å­˜å¯†ç ã€‚");
    }
}
</script>
 
<!-- ç”¨æˆ·ä¸ªäººä¿®æ”¹å¯†ç é€»è¾‘ (é€šç”¨ - å®Œæ•´ä¿®å¤ç‰ˆ) -->
<script>
// 1. æ‰“å¼€ä¿®æ”¹å¯†ç å¼¹çª— (æ”¯æŒå¼ºåˆ¶æ¨¡å¼)
function openUserPasswordModal(isForced = false) {
    // è·å–å½“å‰ç”¨æˆ·
    const user = JSON.parse(sessionStorage.getItem('CURRENT_USER'));
    if (!user) return alert("æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚");

    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('upm-old').value = '';
    document.getElementById('upm-new').value = '';
    document.getElementById('upm-confirm').value = '';
    
    const modal = document.getElementById('user-password-modal');
    const closeBtn = modal.querySelector('button[onclick*="none"]'); // æŸ¥æ‰¾å…³é—­æŒ‰é’®

    if (isForced) {
        // ğŸ”´ å¼ºåˆ¶æ¨¡å¼ï¼šéšè—å…³é—­æŒ‰é’®ï¼Œç¦æ­¢ç‚¹å‡»èƒŒæ™¯å…³é—­
        if(closeBtn) closeBtn.style.display = 'none';
        // ç®€å•çš„é˜²æ­¢ç‚¹å‡»èƒŒæ™¯å…³é—­é€»è¾‘ (è¦†ç›– onclick)
        modal.onclick = (e) => e.stopPropagation(); 
    } else {
        // æ™®é€šæ¨¡å¼ï¼šæ˜¾ç¤ºå…³é—­æŒ‰é’®
        if(closeBtn) closeBtn.style.display = 'block';
        modal.onclick = (e) => { 
            if(e.target === modal) modal.style.display = 'none'; 
        };
    }
    
    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
}

// 2. æäº¤å¯†ç ä¿®æ”¹ (åŒæ­¥äº‘ç«¯)
async function submitUserPasswordChange() {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if (!sbClient) return alert("âŒ äº‘ç«¯æœªè¿æ¥ï¼Œæ— æ³•ä¿®æ”¹å¯†ç ã€‚");
    
    const user = JSON.parse(sessionStorage.getItem('CURRENT_USER'));
    if (!user) return alert("æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");

    // è·å–è¾“å…¥å€¼
    const oldPass = document.getElementById('upm-old').value.trim();
    const newPass = document.getElementById('upm-new').value.trim();
    const confirmPass = document.getElementById('upm-confirm').value.trim();

    // åŸºç¡€æ ¡éªŒ
    if (!oldPass || !newPass) return alert("å¯†ç ä¸èƒ½ä¸ºç©º");
    if (newPass !== confirmPass) return alert("ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´");
    if (newPass.length < 6) return alert("æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä½ï¼Œå»ºè®®ä½¿ç”¨å­—æ¯+æ•°å­—ç»„åˆ");
    if (oldPass === newPass) return alert("æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ");

    UI.loading(true, "æ­£åœ¨éªŒè¯å¹¶æ›´æ–°å¯†ç ...");

    try {
        // A. éªŒè¯æ—§å¯†ç æ˜¯å¦æ­£ç¡® (å¿…é¡»å»æ•°æ®åº“æŸ¥ï¼Œé˜²æ­¢æœ¬åœ°ç¯¡æ”¹)
        const { data: verifyData, error: verifyError } = await sbClient
            .from('system_users')
            .select('*')
            .eq('username', user.name)
            .eq('password', oldPass)
            .maybeSingle();

        if (verifyError) {
            throw new Error("éªŒè¯æ—§å¯†ç æ—¶å‡ºé”™: " + verifyError.message);
        }

        if (!verifyData) {
            UI.loading(false);
            return alert("âŒ æ—§å¯†ç é”™è¯¯ï¼è¯·æ£€æŸ¥åé‡è¯•ã€‚");
        }

        // B. æ‰§è¡Œæ›´æ–°æ“ä½œ
        const { error: updateError } = await sbClient
            .from('system_users')
            .update({ password: newPass })
            .eq('username', user.name); 

        UI.loading(false);

        if (updateError) {
            throw new Error("æ›´æ–°å¯†ç å¤±è´¥: " + updateError.message);
        }

        // C. æˆåŠŸåå¤„ç†
        alert("âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼\n\nä¸ºäº†å®‰å…¨èµ·è§ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚");
        document.getElementById('user-password-modal').style.display = 'none';
        
        // å¼ºåˆ¶ç™»å‡º
        Auth.logout(); 

    } catch (e) {
        UI.loading(false);
        console.error(e);
        alert("âŒ ä¿®æ”¹å¤±è´¥ï¼š" + e.message);
    }
}
</script>

<!-- æ ¸å¿ƒé€»è¾‘è„šæœ¬ -->
<script>
window.onerror = function (msg, url, lineNo, columnNo, error) {
    // å¿½ç•¥ç¬¬ä¸‰æ–¹æ’ä»¶çš„éå…³é”®é”™è¯¯
    if (msg.includes('Script error')) return false;
    
    console.error('å…¨å±€é”™è¯¯æ•è·:', error);
    
    // å¦‚æœ SweetAlert2 å·²åŠ è½½ï¼Œç”¨å®ƒæç¤º
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon: 'error',
            title: 'ç¨‹åºé‡åˆ°æ„å¤–é”™è¯¯',
            html: `<div style="text-align:left; font-size:12px; color:#666;">
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${msg}<br>
                    <strong>ä½ç½®:</strong> Line ${lineNo}<br><br>
                    å»ºè®®æ“ä½œï¼š<br>1. åˆ·æ–°é¡µé¢é‡è¯•<br>2. æ£€æŸ¥ä¸Šä¼ çš„ Excel æ˜¯å¦æ ¼å¼æ­£ç¡®<br>3. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°è¯•æ¸…ç©ºç¼“å­˜
                   </div>`,
            showCancelButton: true,
            confirmButtonText: 'åˆ·æ–°é¡µé¢',
            cancelButtonText: 'æ¸…ç©ºç¼“å­˜å¹¶åˆ·æ–°',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33'
        }).then((result) => {
            if (result.isDismissed) { // ç”¨æˆ·ç‚¹å‡»äº†â€œæ¸…ç©ºç¼“å­˜â€
                idbKeyval.del('autosave_backup').then(() => location.reload());
            } else {
                location.reload();
            }
        });
        return true; // é˜»æ­¢é»˜è®¤çš„æ§åˆ¶å°æŠ¥é”™
    }
    return false;
};
    // Alpine.js æ•°æ®ä»“åº“åˆå§‹åŒ–
    document.addEventListener('alpine:init', () => {
        Alpine.store('teacherData', {
            list: [], // å­˜æ”¾æ‰å¹³åŒ–çš„æ•™å¸ˆæ•°æ®
            
            // æ›´æ–°æ•°æ®çš„é€»è¾‘ (ä¾›æ—§ä»£ç è°ƒç”¨)
            update(statsObj, rankingObj) {
                const arr = [];
                // å°†å¤æ‚çš„åµŒå¥—å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ï¼Œæ–¹ä¾¿å‰ç«¯å¾ªç¯
                if (statsObj && Object.keys(statsObj).length > 0) {
                    Object.keys(statsObj).sort().forEach(teacher => {
                        Object.keys(statsObj[teacher]).sort((a,b)=>a.localeCompare(b)).forEach(subject => {
                            const data = statsObj[teacher][subject];
                            // è®¡ç®—è¯„çº§æ ·å¼
                            let badgeClass = 'performance-poor', badgeText = 'éœ€æ”¹è¿›';
                            const avg = parseFloat(data.avg), exc = data.excellentRate*100, pass = data.passRate*100;
                            if (avg>=85 && exc>=30 && pass>=90) { badgeClass='performance-excellent'; badgeText='ä¼˜ç§€'; }
                            else if (avg>=80 && exc>=25 && pass>=85) { badgeClass='performance-good'; badgeText='è‰¯å¥½'; }
                            else if (avg>=75 && exc>=20 && pass>=80) { badgeClass='performance-average'; badgeText='ä¸­ç­‰'; }

                            // è·å–æ’å
                            const rank = (rankingObj && rankingObj[teacher] && rankingObj[teacher][subject]) 
                                         ? rankingObj[teacher][subject].rank : '-';

                            arr.push({
                                id: `${teacher}-${subject}`, // å”¯ä¸€é”®
                                name: teacher,
                                subject: subject,
                                classes: data.classes,
                                avg: data.avg,
                                excRate: (data.excellentRate * 100).toFixed(1) + '%',
                                passRate: (data.passRate * 100).toFixed(1) + '%',
                                count: data.studentCount,
                                rank: rank,
                                badgeClass: badgeClass,
                                badgeText: badgeText
                            });
                        });
                    });
                }
                this.list = arr;
            }
        });
    });
    // æ·±è‰²æ¨¡å¼åˆ‡æ¢é€»è¾‘
     function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme-dark', isDark);
        // å®šä¹‰é¢œè‰²å˜é‡
        const textColor = isDark ? '#cbd5e1' : '#666';
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

        // æ›´æ–° Chart.js å…¨å±€é»˜è®¤é…ç½®
        if (window.Chart) {
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
        }

        // åˆ·æ–°é¡µé¢ä¸Šå·²å­˜åœ¨çš„ç‰¹å®šå›¾è¡¨å®ä¾‹
        // æ³¨æ„ï¼šè¿™é‡Œåˆ—å‡ºäº†ä½ ä»£ç ä¸­å®šä¹‰è¿‡çš„æ‰€æœ‰å›¾è¡¨å®ä¾‹å˜é‡
        const charts = [
            window.radarChartInstance, 
            window.historyChartInstance, 
            window.varianceChartInstance, 
            window.segmentChartInstance, 
            window.balanceChartInstance,
            window.schoolRadarInstance,
            window.schoolDistInstance,
            window.sankeyChartInstance, // æ¡‘åŸºå›¾
            window.trendChartInstance   // æ•£ç‚¹å›¾
        ];

        charts.forEach(chart => {
            if (chart) {
                // æ›´æ–°å›¾è¡¨é…ç½®
                chart.options.scales.x && (chart.options.scales.x.grid.color = gridColor);
                chart.options.scales.y && (chart.options.scales.y.grid.color = gridColor);
                
                // ç‰¹æ®Šå¤„ç†é›·è¾¾å›¾
                if (chart.config.type === 'radar') {
                    chart.options.scales.r.grid.color = gridColor;
                    chart.options.scales.r.pointLabels.color = textColor;
                }
                
                chart.update(); // é‡ç»˜
            }
        });
        
        // æç¤ºç”¨æˆ·
        if(window.UI) UI.toast(isDark ? "ğŸŒ™ å·²åˆ‡æ¢æ·±è‰²æ¨¡å¼" : "â˜€ï¸ å·²åˆ‡æ¢æµ…è‰²æ¨¡å¼");
    }

    function openSpotlight() {
        document.getElementById('spotlight-mask').style.display = 'flex';
        document.getElementById('spotlight-input').focus();
    }

    function closeSpotlight() {
        document.getElementById('spotlight-mask').style.display = 'none';
    }

    function jumpToStudent(name, school, cls) {
        closeSpotlight();
        switchTab('report-generator');
        const schSel = document.getElementById('sel-school');
        schSel.value = school;
        updateClassSelect(); // è§¦å‘æ›´æ–°ç­çº§ä¸‹æ‹‰æ¡†
        setTimeout(() => {
            document.getElementById('sel-class').value = cls;
            document.getElementById('inp-name').value = name;
            doQuery();
        }, 100);
    }

    function showCertificate(name, honorType) {
        document.getElementById('cert-name').innerText = name;
        document.getElementById('cert-honor').innerText = honorType;
        document.getElementById('cert-exam-name').innerText = CONFIG.name || "æœ¬æ¬¡è€ƒè¯•";
        document.getElementById('cert-school-footer').innerText = MY_SCHOOL || "æ•™åŠ¡å¤„";
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString();
        document.getElementById('cert-modal').style.display = 'flex';
    }

    async function downloadCertificate() {
        const area = document.getElementById('cert-capture-area');
        const canvas = await html2canvas(area, { scale: 2 });
        const link = document.createElement('a');
        link.download = `å¥–çŠ¶_${document.getElementById('cert-name').innerText}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
    const UI = {
        // 1. åŠ è½½åŠ¨ç”»æ§åˆ¶
        loading: (show, text = 'ç³»ç»Ÿæ­£åœ¨å¤„ç†æ•°æ®...') => {
            const loader = document.getElementById('global-loader');
            const txt = document.getElementById('loader-text');
            if (show) {
                if(txt) txt.innerText = text;
                loader.classList.remove('hidden');
            } else {
                setTimeout(() => loader.classList.add('hidden'), 200); // ç¨å¾®å»¶è¿Ÿé˜²æ­¢é—ªçƒ
            }
        },
        // 2. æ¶ˆæ¯æç¤ºæ§åˆ¶
        toast: (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            let icon = 'â„¹ï¸';
            if(type === 'success' || msg.includes('æˆåŠŸ') || msg.includes('âœ…')) { type = 'success'; icon = 'âœ…'; }
            if(type === 'error' || msg.includes('å¤±è´¥') || msg.includes('é”™è¯¯') || msg.includes('âŒ')) { type = 'error'; icon = 'âŒ'; }
            div.className = `toast-msg toast-${type}`;
            div.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateY(-20px)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }
    };

    // ğŸ” æƒé™ä¸è´¦å·ç®¡ç†ç³»ç»Ÿæ ¸å¿ƒ
    const Auth = {
        currentUser: null,
        
        // æ¨¡æ‹Ÿæ•°æ®åº“ (å®é™…å­˜å‚¨åœ¨ localStorage 'SYS_USERS')
        db: JSON.parse(localStorage.getItem('SYS_USERS')) || {
            admin: { pass: 'admin123' }, 
            teachers: [],
            parents: []
        },

        // åˆå§‹åŒ–ï¼šæ£€æŸ¥ä¼šè¯çŠ¶æ€
        init: function() {
            const session = sessionStorage.getItem('CURRENT_USER');
            if(session) {
                this.currentUser = JSON.parse(session);
                this.applyRoleView();
                document.getElementById('login-overlay').style.display = 'none';
                
                // å¦‚æœæ˜¯å®¶é•¿ï¼Œæ¢å¤è§†å›¾
                if(this.currentUser.role === 'parent' && typeof RAW_DATA !== 'undefined' && RAW_DATA.length > 0) {
                    this.renderParentView();
                } 
                // ğŸŸ¢ è¡¥å……ï¼šå¦‚æœæ˜¯å…¶ä»–è§’è‰²ï¼Œæ¢å¤ä¸»è§†å›¾ (é˜²æ­¢åˆ·æ–°åç©ºç™½)
                else if (this.currentUser.role !== 'parent') {
                    document.getElementById('app').classList.remove('hidden');
                    if(typeof renderNavigation === 'function') renderNavigation();
                }
            }
        },

        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ âœ‹ ğŸŸ¢ [æ­¤å¤„å¼€å§‹æ›¿æ¢] é‡å†™ login å‡½æ•° (ç™»å½•åç«‹å³åˆ·æ–°ä¸»ç•Œé¢) ğŸŸ¢ âœ‹ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
        
        // ğŸŸ¢ æ ¸å¿ƒç™»å½•é€»è¾‘ï¼šæ”¹ä¸ºæŸ¥ Supabase æ•°æ®åº“ (å·²ä¿®å¤ 406 æŠ¥é”™ + å¢åŠ ç­çº§å¼ºæ ¡éªŒ)
    login: async function() {
        const user = document.getElementById('login-user').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        // è·å–è¾“å…¥çš„ç­çº§ (å»é™¤ç©ºæ ¼)
        const inputClass = document.getElementById('login-class').value.trim();
        
        if(!user || !pass) return UI.toast('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');

        UI.loading(true, "æ­£åœ¨éªŒè¯èº«ä»½...");

        try {
            // 1. æŸ¥è¯¢æ•°æ®åº“ (ä½¿ç”¨æ–°å˜é‡ sbClient)
            // ğŸ”´ æ”¹åŠ¨ç‚¹ï¼šä½¿ç”¨ .maybeSingle() ä»£æ›¿ .single()
            const { data, error } = await sbClient
                .from('system_users')
                .select('*')
                .eq('username', user)
                .eq('password', pass) // ç®€å•æ˜æ–‡åŒ¹é…
                .maybeSingle(); 

            UI.loading(false);

            // 2. æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿçº§é”™è¯¯
            if (error) {
                console.error("Database Login Error:", error);
                return alert("ç³»ç»Ÿè¿æ¥é”™è¯¯ï¼š" + error.message);
            }

            // 3. æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°äº†ç”¨æˆ·
            if (!data) {
                return alert("âŒ ç™»å½•å¤±è´¥ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. è´¦å·æˆ–å¯†ç é”™è¯¯\n2. ç®¡ç†å‘˜å°šæœªå°†è´¦å·ã€åŒæ­¥åˆ°äº‘ç«¯ã€‘");
            }

            /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ æ–°å¢ä»£ç ï¼šå®¶é•¿è§’è‰²å¼ºåˆ¶æ ¡éªŒç­çº§ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
            if (data.role === 'parent') {
                if (!inputClass) {
                    return alert("âŒ ç™»å½•å¤±è´¥ï¼šå®¶é•¿/å­¦ç”Ÿå¿…é¡»è¾“å…¥ã€ç­çº§ã€‘æ‰èƒ½ç™»å½•ã€‚");
                }
                
                // å¯¹æ¯”è¾“å…¥çš„ç­çº§å’Œæ•°æ®åº“å­˜çš„ç­çº§ (å»é™¤ç©ºæ ¼åæ¯”è¾ƒï¼Œé˜²æ­¢ '701 ' å’Œ '701' ä¸åŒ¹é…)
                // data.class_name æ˜¯æ•°æ®åº“é‡Œçš„åˆ—å
                const dbClass = (data.class_name || "").toString().replace(/\s+/g, "");
                const userClass = inputClass.toString().replace(/\s+/g, "");

                if (dbClass !== userClass) {
                    return alert(`âŒ ç­çº§ä¸åŒ¹é…ï¼\n\næ‚¨è¾“å…¥çš„ç­çº§ï¼š${inputClass}\nç³»ç»Ÿè®°å½•çš„ç­çº§ï¼š${data.class_name || 'æœªå½•å…¥'}\n\nè¯·æ ¸å¯¹åé‡è¯•ã€‚`);
                }
            }
            /* ğŸ‘†ğŸ‘†ğŸ‘† ğŸŸ¢ ç»“æŸ ğŸŸ¢ ğŸ‘†ğŸ‘†ğŸ‘† */

            // 4. ç™»å½•æˆåŠŸï¼Œæ„å»ºç”¨æˆ·å¯¹è±¡
            const matchedUser = {
                name: data.username,
                role: data.role,
                school: data.school,
                class: data.class_name // æ•°æ®åº“å­—æ®µå
            };

            this.currentUser = matchedUser;
            sessionStorage.setItem('CURRENT_USER', JSON.stringify(matchedUser));
            sessionStorage.setItem('CURRENT_ROLE', matchedUser.role); 
setTimeout(() => {
    loadCloudData();
}, 200);

            // ç•Œé¢åˆ‡æ¢
            this.applyRoleView();
            updateAdminOnlyButtons();
            updateWatermark();

            // === ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥ï¼šå¼ºåˆ¶ä¿®æ”¹é»˜è®¤å¯†ç  ===
            // é»˜è®¤å¯†ç å®šä¹‰ï¼šæ•™å¸ˆæ˜¯ yssy2016ï¼Œå…¶ä»–äººæ˜¯ 123456
            const isDefaultPass = (matchedUser.role === 'teacher' && pass === 'yssy2016') || pass === '123456';
            
            if (isDefaultPass) {
                document.getElementById('login-overlay').style.display = 'none'; // å…ˆå…³æ‰ç™»å½•æ¡†
                
                // å¼¹å‡ºæç¤º
                alert("âš ï¸ å®‰å…¨è­¦å‘Šï¼š\næ£€æµ‹åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨é»˜è®¤å¯†ç ï¼\nä¸ºäº†ä¿éšœè´¦å·å®‰å…¨ï¼Œé¦–æ¬¡ç™»å½•å¿…é¡»ä¿®æ”¹å¯†ç ã€‚");
                
                // æ‰“å¼€ä¿®æ”¹å¯†ç å¼¹çª— (ä¼ å…¥ true è¡¨ç¤ºå¼ºåˆ¶æ¨¡å¼)
                setTimeout(() => openUserPasswordModal(true), 500);
                return; // â›” ç»ˆæ­¢åç»­åŠ è½½ï¼Œç›´åˆ°å¯†ç ä¿®æ”¹å®Œæˆ
            }
            // === ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥ç»“æŸ ===
            document.getElementById('login-overlay').style.display = 'none';
            
            if(window.UI) UI.toast(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${matchedUser.name}`, 'success');

            // 5. ã€å…³é”®ã€‘æ‹‰å–äº‘ç«¯æ•°æ®
            UI.loading(true, "æ­£åœ¨åŒæ­¥æœ€æ–°æˆç»©æ•°æ®...");
            await loadCloudData();
            UI.loading(false);

            // 6. åˆ†æµè·³è½¬ä¸æƒé™åˆå§‹åŒ–
            if(matchedUser.role === 'parent') {
                // === å®¶é•¿æ¨¡å¼ ===
                this.renderParentView();
            } else {
                // === æ•™èŒå·¥æ¨¡å¼ (ç®¡ç†å‘˜/ä¸»ä»»/æ•™å¸ˆ/ç­ä¸»ä»»/çº§éƒ¨ä¸»ä»») ===
                document.getElementById('app').classList.remove('hidden');
                
                // åˆå§‹åŒ–å¯¼èˆªå’Œè¡¨æ ¼
                if(typeof renderNavigation === 'function') renderNavigation();
                if(typeof updateSchoolSelect === 'function') updateSchoolSelect();
                if(typeof renderTables === 'function') renderTables();

                // 7. å±Šåˆ«è‡ªåŠ¨è®°å¿†/é€‰æ‹©
                if (typeof CohortManager !== 'undefined') {
                    CohortManager.init();
                    applyUserCohortPreference();
                }

                // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šè§’è‰²ä¸“å±åˆå§‹åŒ–é€»è¾‘ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                
                // A. å¦‚æœæœ‰å­¦æ ¡ç»‘å®š (é™¤ç®¡ç†å‘˜å¤–é€šå¸¸éƒ½æœ‰)
                if (matchedUser.school) {
                    // è‡ªåŠ¨è®¾ç½®æœ¬æ ¡å…¨å±€å˜é‡
                    window.MY_SCHOOL = matchedUser.school; 
                    
                    // å°è¯•æ›´æ–°ç•Œé¢ä¸Šçš„â€œé€‰æ‹©æœ¬æ ¡â€ä¸‹æ‹‰æ¡†
                    const sel = document.getElementById('mySchoolSelect');
                    if(sel) { 
                        sel.value = matchedUser.school; 
                        // è§¦å‘ä¸€æ¬¡ change äº‹ä»¶ä»¥æ›´æ–°ç›¸å…³ä¸‹æ‹‰æ¡† (å¦‚ç­çº§åˆ—è¡¨)
                        sel.dispatchEvent(new Event('change')); 
                    }
                }

                // B. è§’è‰²æƒé™ç»†åˆ†å¤„ç†
                if (matchedUser.role === 'teacher') {
                    // æ™®é€šæ•™å¸ˆï¼šåç»­å°†åœ¨ renderStudentDetails ä¸­è¿‡æ»¤åªèƒ½çœ‹è‡ªå·±æ•™çš„è¯¾
                    UI.toast(`æ¬¢è¿æ‚¨ï¼Œ${matchedUser.name}è€å¸ˆ`, "success");
                } 
                else if (matchedUser.role === 'class_teacher') {
                    // ç­ä¸»ä»»ï¼šåç»­å°†åœ¨ renderStudentDetails ä¸­è¿‡æ»¤åªèƒ½çœ‹æœ¬ç­
                    UI.toast(`æ¬¢è¿æ‚¨ï¼Œ${matchedUser.class}ç­ç­ä¸»ä»»`, "success");
                    
                    // å°è¯•è‡ªåŠ¨å®šä½åˆ°â€œå­¦ç”Ÿæ¡£æ¡ˆæŸ¥è¯¢â€æ¨¡å—çš„ç­çº§ç­›é€‰
                    setTimeout(() => {
                        const clsSel = document.getElementById('studentClassSelect');
                        if(clsSel) {
                            clsSel.value = matchedUser.class;
                            clsSel.dispatchEvent(new Event('change')); // è§¦å‘ç­›é€‰
                        }
                    }, 500);
                }
                else if (matchedUser.role === 'grade_director') {
                    // çº§éƒ¨ä¸»ä»»ï¼š
                    // 1. æ‹¥æœ‰ä¿®æ”¹æˆç»©æƒé™ (åœ¨ updateStudentScore ä¸­æ§åˆ¶)
                    // 2. èƒ½æ¥æ”¶æ¶ˆæ¯ (éœ€æ˜¾ç¤ºé“ƒé“›æŒ‰é’®)
                    // 3. åªèƒ½çœ‹æœ¬çº§éƒ¨ (åœ¨ renderStudentDetails ä¸­æ§åˆ¶)
                    
                    UI.toast(`æ¬¢è¿æ‚¨ï¼Œ${matchedUser.class}å¹´çº§ä¸»ä»»`, "success");
                    
                    // å¼€å¯æ¶ˆæ¯è½®è¯¢ (å¤ç”¨ç®¡ç†å‘˜çš„é€»è¾‘)
                    const msgBtn = document.getElementById('admin-msg-btn');
                    if(msgBtn) msgBtn.style.display = 'block'; // æ˜¾ç¤ºé“ƒé“›
                    
                    if (typeof IssueManager !== 'undefined') {
                        IssueManager.checkIssues(); // ç«‹å³æŸ¥ä¸€æ¬¡
                        // æ¯30ç§’è½®è¯¢ä¸€æ¬¡æ–°æ¶ˆæ¯
                        setInterval(() => IssueManager.checkIssues(), 30000);
                    }
                }
                /* ğŸ‘†ğŸ‘†ğŸ‘† ğŸŸ¢ ç»“æŸ ğŸŸ¢ ğŸ‘†ğŸ‘†ğŸ‘† */
            }

        } catch (err) {
            UI.loading(false);
            console.error(err);
            alert("ç™»å½•å¼‚å¸¸ä¸­æ–­ï¼š" + err.message);
        }
    },

        // ç™»å‡º
        logout: function() {
            sessionStorage.removeItem('CURRENT_USER');
            location.reload(); // åˆ·æ–°é¡µé¢æœ€å½»åº•ï¼Œæ¸…é™¤æ‰€æœ‰ä¸´æ—¶çŠ¶æ€
        },

        // åº”ç”¨è§†å›¾æƒé™ (é…åˆ CSS data-role å±æ€§)
        applyRoleView: function() {
            if(!this.currentUser) return;
            const role = this.currentUser.role;
            document.body.dataset.role = role;

            const msgBtn = document.getElementById('admin-msg-btn');
            if (msgBtn) {
                // ğŸŸ¢ ä¿®æ”¹ï¼šå…è®¸ ç®¡ç†å‘˜ã€æ•™åŠ¡ä¸»ä»»ã€çº§éƒ¨ä¸»ä»»ã€ç­ä¸»ä»» çœ‹åˆ°é“ƒé“›
                // åªæœ‰è¿™äº›è§’è‰²æœ‰èµ„æ ¼å¤„ç†ç”³è¯‰æˆ–æŸ¥çœ‹é€šçŸ¥
                if (role === 'admin' || role === 'director' || role === 'grade_director' || role === 'class_teacher') {
                    msgBtn.style.display = 'block';
                    
                    // å¯åŠ¨æ¶ˆæ¯è½®è¯¢ (æ¯30ç§’æŸ¥ä¸€æ¬¡ï¼Œæ£€æŸ¥ IssueManager æ˜¯å¦å·²åŠ è½½)
                    if (typeof IssueManager !== 'undefined') {
                        IssueManager.checkIssues();
                        // æ¸…é™¤æ—§å®šæ—¶å™¨é˜²æ­¢é‡å¤
                        if (window.msgInterval) clearInterval(window.msgInterval);
                        window.msgInterval = setInterval(() => IssueManager.checkIssues(), 30000);
                    }
                } else {
                    msgBtn.style.display = 'none';
                }
            }

            // æ·»åŠ æˆ–æ›´æ–°æ‚¬æµ®ä¸ªäººä¸­å¿ƒæ¡ (åŒ…å«ä¿®æ”¹å¯†ç )
        let btn = document.getElementById('logout-btn');
        
        if(!btn) {
            btn = document.createElement('div');
            btn.id = 'logout-btn';
            // å¢åŠ ä¸€ç‚¹æ ·å¼è°ƒæ•´ï¼Œè®©å®ƒæ›´åƒä¸€ä¸ªå·¥å…·æ¡
            btn.style.display = 'flex';
            btn.style.gap = '10px';
            btn.style.alignItems = 'center';
            document.body.appendChild(btn);
        }

        // æ¸²æŸ“ä¸¤ä¸ªæŒ‰é’®ï¼šä¿®æ”¹å¯†ç  | é€€å‡º
        btn.innerHTML = `
            <span onclick="openUserPasswordModal()" style="cursor:pointer; border-right:1px solid rgba(255,255,255,0.3); padding-right:10px; display:flex; align-items:center; gap:4px;" title="ä¿®æ”¹å¯†ç ">
                <i class="ti ti-key"></i> å¯†ç 
            </span>
            <span onclick="Auth.logout()" style="cursor:pointer; display:flex; align-items:center; gap:4px;" title="é€€å‡ºç™»å½•">
                <i class="ti ti-logout"></i> ${this.currentUser.name}
            </span>
        `;
        
        // æ³¨æ„ï¼šè¿™é‡Œç§»é™¤äº† btn.onclickï¼Œå› ä¸ºç‚¹å‡»äº‹ä»¶ç›´æ¥å†™åœ¨ span é‡Œçš„ HTML ä¸­äº†
// ğŸŸ¢ [æ–°å¢] åŠ¨æ€æ·»åŠ â€œè´¦å·ç®¡ç†â€å…¥å£æŒ‰é’® (é’ˆå¯¹æœ‰æƒç”¨æˆ·)
            // 1. è·å–å½“å‰ç”¨æˆ·è§’è‰²
            const currentRole = this.currentUser.role;
            const allowedRoles = ['admin', 'director', 'grade_director', 'class_teacher'];
            
            // 2. æŸ¥æ‰¾ header é‡Œçš„å·¥å…·æ å®¹å™¨ (é€šå¸¸æ˜¯ header çš„æœ€åä¸€ä¸ªå­å…ƒç´ çš„æœ€åä¸€ä¸ª div)
            // æ ¹æ® CSS ç»“æ„: header > div(flex) > div(toolbar)
            const toolbar = document.querySelector('header > div > div:last-child');
            
            // 3. å…ˆç§»é™¤æ—§æŒ‰é’®(é˜²æ­¢é‡å¤æ·»åŠ )
            const oldBtn = document.getElementById('header-acc-mgr-btn');
            if(oldBtn) oldBtn.remove();

            // 4. å¦‚æœæœ‰æƒé™ä¸”å®¹å™¨å­˜åœ¨ï¼Œæ’å…¥æŒ‰é’®
            if (toolbar && allowedRoles.includes(currentRole)) {
                const mgrBtn = document.createElement('button');
                mgrBtn.id = 'header-acc-mgr-btn';
                mgrBtn.className = 'btn';
                // æ ·å¼å¾®è°ƒï¼šåŠé€æ˜èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—
                mgrBtn.style.cssText = 'background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; margin-right:5px; font-size:12px; padding:6px 12px; display:inline-flex; align-items:center; gap:5px;';
                mgrBtn.innerHTML = '<i class="ti ti-user-cog"></i> è´¦å·';
                mgrBtn.title = "ç®¡ç†è´¦å· / é‡ç½®å¯†ç ";
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šæ‰“å¼€è´¦å·ç®¡ç†å¼¹çª—
                mgrBtn.onclick = () => AccountManager.open();
                
                // 5. å°†æŒ‰é’®æ’å…¥åˆ°å·¥å…·æ çš„æœ€å‰é¢ (ä½œä¸ºç¬¬ä¸€ä¸ªæŒ‰é’®æ˜¾ç¤º)
                // ä¹Ÿå¯ä»¥æ”¹ä¸º insertBefore åˆ°ç‰¹å®šæŒ‰é’®å‰ï¼Œè¿™é‡Œæ”¾æœ€å‰æ¯”è¾ƒæ˜¾çœ¼
                if (toolbar.firstChild) {
                    toolbar.insertBefore(mgrBtn, toolbar.firstChild);
                } else {
                    toolbar.appendChild(mgrBtn);
                }
            }
            // ğŸŸ¢ [ä¿®æ­£]ï¼šå°†ä»¥ä¸‹ä»£ç ç§»å…¥ applyRoleView å‡½æ•°å†…éƒ¨ï¼Œæ¥åœ¨ä¸Šé¢çš„ä»£ç åé¢

            // ğŸŸ¢ [æ–°å¢] åŠ¨æ€æ·»åŠ â€œæ•°æ®ç®¡ç†â€å…¥å£ (ä»…é™ ç®¡ç†å‘˜/æ•™åŠ¡ä¸»ä»»)
            const dataRoles = ['admin', 'director'];
            
            // å…ˆç§»é™¤æ—§æŒ‰é’®(é˜²æ­¢é‡å¤)
            const oldDataBtn = document.getElementById('header-data-mgr-btn');
            if(oldDataBtn) oldDataBtn.remove();

            // å¦‚æœæœ‰æƒé™ä¸”å®¹å™¨å­˜åœ¨
            // æ³¨æ„ï¼šè¿™é‡Œçš„ role å’Œ toolbar å˜é‡ç»§æ‰¿è‡ª applyRoleView å‡½æ•°é¡¶éƒ¨çš„å®šä¹‰
            if (toolbar && dataRoles.includes(role)) {
                const dataBtn = document.createElement('button');
                dataBtn.id = 'header-data-mgr-btn';
                dataBtn.className = 'btn';
                // æ ·å¼ï¼šç´«è‰²èƒŒæ™¯ï¼ŒåŒºåˆ«äºè´¦å·ç®¡ç†
                dataBtn.style.cssText = 'background:rgba(124, 58, 237, 0.4); border:1px solid rgba(255,255,255,0.4); color:white; margin-right:5px; font-size:12px; padding:6px 12px; display:inline-flex; align-items:center; gap:5px;';
                dataBtn.innerHTML = '<i class="ti ti-database-edit"></i> æ•°æ®';
                dataBtn.title = "ç®¡ç†åŸå§‹æˆç»©å’Œæ•™å¸ˆè®¾ç½®";
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                dataBtn.onclick = () => DataManager.open();
                
                // æ’å…¥åˆ°å·¥å…·æ æœ€å‰é¢ (ä½œä¸ºæœ€é«˜é¢‘åŠŸèƒ½ï¼Œæ’åœ¨è´¦å·æŒ‰é’®å‰é¢)
                if (toolbar.firstChild) {
                    toolbar.insertBefore(dataBtn, toolbar.firstChild);
                } else {
                    toolbar.appendChild(dataBtn);
                }
            }
            
    },

        // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ æ¸²æŸ“å®¶é•¿ä¸“å±è§†å›¾ (å®Œå…¨éš”ç¦»)
        renderParentView: function() {
            // 1. å½»åº•éšè—ä¸»ç•Œé¢åŠæ‰€æœ‰å¹²æ‰°å…ƒç´  (é˜²æ­¢é€è§†)
            const app = document.getElementById('app');
            const header = document.querySelector('header');
            const nav = document.querySelector('.nav-wrapper');
            const overlay = document.getElementById('login-overlay');
            const loader = document.getElementById('global-loader');

            if(app) app.style.display = 'none'; // å…³é”®ï¼šéšè—ä¸»åº”ç”¨
            if(header) header.style.display = 'none';
            if(nav) nav.style.display = 'none';
            if(overlay) overlay.style.display = 'none';
            if(loader) loader.classList.add('hidden');

            // 2. åˆ›å»ºæˆ–é‡ç½®å®¶é•¿å®¹å™¨
            let container = document.getElementById('parent-view-container');
            if(!container) {
                container = document.createElement('div');
                container.id = 'parent-view-container';
                document.body.appendChild(container);
            }
            
            // ç¡®ä¿å®¹å™¨å¯è§
            container.style.display = 'block';

            // 3. ç§»åŠ¨ç«¯è§†å£é€‚é… (é˜²æ­¢è¡¨æ ¼å¤ªå®½çœ‹ä¸å…¨)
            let viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes');
            }

            // A. ç«‹å³æ¸²æŸ“éª¨æ¶å± (Skeleton Screen)
            container.innerHTML = `
                <div class="sk-card skeleton"><div class="sk-header"></div></div>
                <div class="sk-card skeleton"><div class="sk-block" style="width:80%"></div></div>
                <div style="display:flex; gap:10px;">
                    <div class="sk-card skeleton" style="flex:1;"><div class="sk-chart"></div></div>
                    <div class="sk-card skeleton" style="flex:1;"><div class="sk-chart"></div></div>
                </div>
            `;

            // å»¶æ—¶åŠ è½½æ•°æ®ï¼Œç»™éª¨æ¶å±ä¸€ç‚¹å±•ç¤ºæ—¶é—´
            setTimeout(() => {
                if(!RAW_DATA || RAW_DATA.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:50px; color:#666;">
                        <i class="ti ti-database-off" style="font-size:48px; margin-bottom:10px; display:block;"></i>
                        æ•°æ®åŠ è½½ä¸­...<br><small>è¯·ç¨å€™ (å¦‚é•¿æ—¶é—´æ— ååº”è¯·åˆ·æ–°)</small>
                    </div>`;
                    return;
                }

                // ç²¾ç¡®æŸ¥æ‰¾ï¼šå§“å + ç­çº§
                const stu = RAW_DATA.find(s => s.name === this.currentUser.name && s.class === this.currentUser.class);
                
                if(!stu) {
                    container.innerHTML = `<div style="text-align:center; padding:50px; color:red;">
                        âŒ æœªæ‰¾åˆ°å­¦ç”Ÿã€${this.currentUser.name}ã€‘ï¼ˆ${this.currentUser.class}ç­ï¼‰çš„æ•°æ®ã€‚<br>
                        è¯·è”ç³»ç­ä¸»ä»»ç¡®è®¤åå•æ˜¯å¦å·²ä¸Šä¼ ã€‚
                    </div>`;
                    return;
                }

                // æ¸²æŸ“æŠ¥è¡¨ HTML
                let reportHtml = renderSingleReportCardHTML(stu, 'H5');
                
                // å»é™¤ä¸å¿…è¦çš„æŒ‰é’®å’Œè¾“å…¥æ¡†
                reportHtml = reportHtml.replace(/<button.*AI æ·±åº¦ç”Ÿæˆ.*<\/button>/, '');
                const teacherName = TEACHER_MAP[stu.class+'_ç­ä¸»ä»»'] || 'ç­ä¸»ä»»';
                reportHtml = reportHtml.replace(/<input.*id="inp-teacher-name".*?>/, `<span style="font-weight:bold">${teacherName}</span>`);

                                // å®‰å…¨å¤„ç†ï¼šé˜²æ­¢å§“åæˆ–ç­çº§ä¸­æœ‰å¼•å·å¯¼è‡´ JS æŠ¥é”™
                const safeName = stu.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeClass = stu.class.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeSchool = stu.school.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                // è¿½åŠ åº•éƒ¨åŠŸèƒ½æ  (ç”³è¯‰ & é€€å‡º)
                reportHtml += `
                    <div style="text-align:center; margin-top:30px; padding-bottom:80px; border-top:1px dashed #e5e7eb; padding-top:20px;">
                        <p style="font-size:14px; color:#64748b; margin-bottom:15px;">æ•°æ®æœ‰ç–‘é—®ï¼Ÿ</p>
                        
                        <!-- æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨è½¬ä¹‰åçš„å˜é‡ -->
                        <button class="btn" style="background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; font-size:16px; padding:10px 20px; margin-bottom:20px;" 
                                onclick="IssueManager.openSubmitModal('${safeName}', '${safeClass}', '${safeSchool}')">
                            <i class="ti ti-alert-circle"></i> ç”³è¯·æˆç»©æ ¸æŸ¥
                        </button>
                        
                        <br>
                        <button onclick="Auth.logout()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; font-size:14px; cursor:pointer;">
                            é€€å‡ºç™»å½•
                        </button>
                    </div>
                `;

                container.innerHTML = reportHtml;

                // æ¸²æŸ“å›¾è¡¨ (Canvas)
                setTimeout(() => {
                    try {
                        if(typeof renderRadarChart === 'function') renderRadarChart(stu);                        
                        if(typeof renderVarianceChart === 'function') renderVarianceChart(stu);
                    } catch(e) { console.error("å›¾è¡¨æ¸²æŸ“å¤±è´¥:", e); }
                }, 200);

            }, 500); 
        },

        // è¾…åŠ©ï¼šæ¸²æŸ“ç”Ÿæˆè´¦å·æ—¶çš„å­¦æ ¡åˆ—è¡¨
        renderSchoolCheckboxes: function() {
            const container = document.getElementById('admin-gen-school-list');
            if(!container) return; // å¦‚æœæ‰¾ä¸åˆ°å®¹å™¨ï¼ˆæ¯”å¦‚éç®¡ç†å‘˜ï¼‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸æŠ¥é”™
            
            if(typeof SCHOOLS === 'undefined' || Object.keys(SCHOOLS).length === 0) {
                container.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æˆç»©</div>';
                return;
            }

            let html = '';
            Object.keys(SCHOOLS).forEach(sch => {
                html += `
                    <label style="display:flex; align-items:center; margin-bottom:3px; cursor:pointer;">
                        <input type="checkbox" class="gen-school-check" value="${sch}" checked>
                        <span style="margin-left:5px;">${sch}</span>
                    </label>
                `;
            });
            container.innerHTML = html;
        },

        // è¾…åŠ©ï¼šå…¨é€‰/åé€‰
        toggleAllSchools: function(check) {
            document.querySelectorAll('.gen-school-check').forEach(el => el.checked = check);
        },

        // ğŸ› ï¸ ç®¡ç†å‘˜å·¥å…·ï¼šæ‰¹é‡ç”Ÿæˆè´¦å· (æ”¯æŒæŒ‡å®šå­¦æ ¡å¢é‡æ›´æ–°)
        generateAccounts: function() {
            if(!RAW_DATA.length) return alert("è¯·å…ˆåœ¨ã€æ•°æ®ä¸­å¿ƒã€‘ä¸Šä¼ æˆç»©æ•°æ®");
            
            // 1. è·å–ç•Œé¢ä¸Šå‹¾é€‰çš„å­¦æ ¡
            const checkboxes = document.querySelectorAll('.gen-school-check:checked');
            const selectedSchools = Array.from(checkboxes).map(cb => cb.value);

            if(selectedSchools.length === 0) {
                return alert("è¯·è‡³å°‘å‹¾é€‰ä¸€æ‰€å­¦æ ¡ï¼\n(å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆä¸Šä¼ æ•°æ®)");
            }
            
            if(!confirm(`âš ï¸ ç¡®å®šè¦ä¸ºé€‰ä¸­çš„ [${selectedSchools.length}] æ‰€å­¦æ ¡ç”Ÿæˆè´¦å·å—ï¼Ÿ\n\n1. ä»…ç”Ÿæˆ/æ›´æ–°é€‰ä¸­å­¦æ ¡çš„å­¦ç”Ÿå’Œè€å¸ˆè´¦å·ã€‚\n2. æœªé€‰ä¸­å­¦æ ¡çš„ç°æœ‰è´¦å·å°†ã€ä¿ç•™ã€‘ã€‚\n3. é»˜è®¤åˆå§‹å¯†ç å‡ä¸º 123456ã€‚`)) return;

            let countParentNew = 0;
            let countParentUpd = 0;
            let countTeacherNew = 0;

            // --- A. ç”Ÿæˆå®¶é•¿è´¦å· (å¢é‡æ›´æ–°) ---
            // ç­–ç•¥ï¼šéå†æ•°æ®ï¼Œå¦‚æœè¯¥å­¦ç”Ÿå±äºé€‰ä¸­å­¦æ ¡ï¼Œåˆ™æ›´æ–°/æ·»åŠ ï¼›å¦åˆ™ä¸åŠ¨ã€‚
            
            // ç­›é€‰å‡ºå±äºé€‰ä¸­å­¸æ ¡çš„å­¦ç”Ÿ
            const targetStudents = RAW_DATA.filter(s => selectedSchools.includes(s.school));
            
            targetStudents.forEach(s => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è´¦å· (å”¯ä¸€é”®ï¼šå§“å+ç­çº§)
                const existIdx = this.db.parents.findIndex(p => p.name === s.name && p.class === s.class);
                
                const newAccount = {
                    name: s.name,
                    class: s.class,
                    pass: '123456' // é»˜è®¤å¯†ç 
                };

                if (existIdx >= 0) {
                    // å·²å­˜åœ¨ï¼Œå¼ºåˆ¶é‡ç½®å¯†ç ä¸ºé»˜è®¤ (ä¹Ÿå¯é€‰æ‹©ä¸é‡ç½®ï¼Œçœ‹éœ€æ±‚)
                    this.db.parents[existIdx] = newAccount; 
                    countParentUpd++;
                } else {
                    // ä¸å­˜åœ¨ï¼Œæ·»åŠ 
                    this.db.parents.push(newAccount);
                    countParentNew++;
                }
            });

            // --- B. ç”Ÿæˆæ•™å¸ˆè´¦å· (å¢é‡æ›´æ–°) ---
            // ç­–ç•¥ï¼šå…ˆæ‰¾åˆ°é€‰ä¸­å­¦æ ¡æ¶‰åŠçš„æ‰€æœ‰ç­çº§ï¼Œå†åæŸ¥ TEACHER_MAP é‡Œçš„è€å¸ˆ
            const targetClasses = new Set();
            targetStudents.forEach(s => targetClasses.add(s.class));
            
            // æ”¶é›†æ¶‰åŠåˆ°çš„è€å¸ˆåå­— (å»é‡)
            let targetTeachers = new Set();
            if(Object.keys(TEACHER_MAP).length > 0) {
                Object.keys(TEACHER_MAP).forEach(key => {
                    // key æ ¼å¼é€šå¸¸ä¸º "701_è¯­æ–‡" æˆ– "701_ç­ä¸»ä»»"
                    const [cls, sub] = key.split('_');
                    // å¦‚æœè¿™ä¸ªç­çº§å±äºé€‰ä¸­çš„å­¦æ ¡
                    if (targetClasses.has(cls)) {
                        targetTeachers.add(TEACHER_MAP[key]);
                    }
                });
            } else {
                console.warn("æœªé…ç½®æ•™å¸ˆä»»è¯¾è¡¨ï¼Œä»…èƒ½ç”Ÿæˆå®¶é•¿è´¦å·");
            }

            targetTeachers.forEach(tName => {
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                const existIdx = this.db.teachers.findIndex(t => t.name === tName);
                const newAccount = {
                    name: tName,
                    pass: 'yssy2016', // ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šå°† '123456' æ”¹ä¸º 'yssy2016'
                    grade: 'all'
                };

                if (existIdx >= 0) {
                    // æ•™å¸ˆè´¦å·é€šå¸¸è·¨å¹´çº§ï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œä¸€èˆ¬ä¸é‡ç½®å¯†ç ï¼Œæˆ–è€…ä¹Ÿé‡ç½®
                    this.db.teachers[existIdx].pass = 'yssy2016'; // ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šå°† '123456' æ”¹ä¸º 'yssy2016'
                } else {
                    this.db.teachers.push(newAccount);
                    countTeacherNew++;
                }
            });

            // 4. ä¿å­˜ç»“æœåˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('SYS_USERS', JSON.stringify(this.db));
            
            let msg = `âœ… æ“ä½œå®Œæˆï¼\n\n`;
            msg += `è¦†ç›–å­¦æ ¡ï¼š${selectedSchools.join(', ')}\n`;
            msg += `å®¶é•¿è´¦å·ï¼šæ–°å¢ ${countParentNew} / é‡ç½® ${countParentUpd}\n`;
            msg += `æ•™å¸ˆè´¦å·ï¼šæ–°å¢ ${countTeacherNew} / æ¶‰åŠ ${targetTeachers.size}\n`;
            msg += `\n(æç¤ºï¼šæœªé€‰ä¸­å­¦æ ¡çš„æ—§è´¦å·å·²è‡ªåŠ¨ä¿ç•™)`;
            
            // ğŸš« å·²æ³¨é‡Šæ‰æˆåŠŸåçš„å¼¹çª—ï¼Œé¿å…å¹²æ‰°
            // alert(msg);
            
            // ä»…åœ¨å³ä¸‹è§’æ˜¾ç¤ºè½»æç¤º
            if(window.UI) UI.toast("âœ… è´¦å·ç”Ÿæˆæ“ä½œå®Œæˆ", "success");
        },


         // ğŸ› ï¸ ç®¡ç†å‘˜å·¥å…·ï¼šå¯¼å‡ºè´¦å·æ˜ç»† (æ–°åŠŸèƒ½)
        exportAccounts: function() {
            if(!this.db.teachers.length && !this.db.parents.length) {
                return alert("å½“å‰æ²¡æœ‰ç”Ÿæˆä»»ä½•æ™®é€šè´¦å·ï¼Œè¯·å…ˆç‚¹å‡»â€œä¸€é”®ç”Ÿæˆâ€ã€‚");
            }

            // 1. è·å–ç•Œé¢ä¸Šå‹¾é€‰çš„å­¦æ ¡
            const checkboxes = document.querySelectorAll('.gen-school-check:checked');
            const selectedSchools = Array.from(checkboxes).map(cb => cb.value);
            
            // åˆ¤æ–­æ˜¯å¦å¯ç”¨äº†ç­›é€‰ (å¦‚æœæœ‰å‹¾é€‰ï¼Œä¸”å‹¾é€‰æ•°é‡å°äºæ€»å­¦æ ¡æ•°ï¼Œåˆ™è§†ä¸ºç­›é€‰)
            // é€»è¾‘ä¼˜åŒ–ï¼šåªè¦æœ‰å‹¾é€‰ï¼Œå°±åªå¯¼å‡ºå‹¾é€‰çš„ï¼›å¦‚æœä¸€ä¸ªéƒ½æ²¡å‹¾(æˆ–å…¨æ²¡å‹¾)ï¼Œåˆ™å¯¼å‡ºå…¨éƒ¨
            const isFiltering = selectedSchools.length > 0;

            const wb = XLSX.utils.book_new();
            // è¡¨å¤´å¢åŠ ä¸€åˆ— "æ‰€å±å­¦æ ¡ (ä»…å¯¼å‡ºæ—¶è®¡ç®—)"
            const data = [['è§’è‰²', 'ç”¨æˆ·å/å§“å', 'ç™»å½•ç­çº§ (å®¶é•¿å¿…å¡«)', 'å¯†ç ', 'æ‰€å±å­¦æ ¡/å¤‡æ³¨']];

            // --- A. å†™å…¥ç®¡ç†å‘˜/ä¸»ä»» (å§‹ç»ˆå¯¼å‡ºï¼Œä¸å—ç­›é€‰å½±å“) ---
            data.push(['ç®¡ç†å‘˜', 'admin', '-', this.db.admin.pass, 'æœ€é«˜æƒé™']);
            const dirPass = this.db.director ? this.db.director.pass : 'admin123';
            data.push(['æ•™åŠ¡ä¸»ä»»', 'director', '-', dirPass, 'æŸ¥çœ‹é™¤è´¦å·å¤–æ‰€æœ‰ä¿¡æ¯']);

            // --- å‡†å¤‡ç­›é€‰è¾…åŠ©æ•°æ® ---
            let validClasses = new Set();   // é€‰ä¸­å­¦æ ¡åŒ…å«çš„æ‰€æœ‰ç­çº§
            
            if (isFiltering) {
                // éå† RAW_DATA æ„å»ºç™½åå•ï¼Œæ¯”æ¯æ¬¡ find å¿«
                RAW_DATA.forEach(s => {
                    if (selectedSchools.includes(s.school)) {
                        validClasses.add(s.class);
                    }
                });
            }

            // --- B. å†™å…¥æ•™å¸ˆä¿¡æ¯ ---
            let teacherCount = 0;
            this.db.teachers.forEach(t => {
                let shouldExport = true;
                if (isFiltering) {
                    // æ£€æŸ¥è¯¥è€å¸ˆæ˜¯å¦ä»»æ•™äºé€‰ä¸­çš„å­¦æ ¡ (é€šè¿‡ç­çº§åæŸ¥)
                    let isRelevant = false;
                    // éå† TEACHER_MAP æŸ¥æ‰¾è¯¥è€å¸ˆæ•™çš„ç­çº§
                    for (const [key, tName] of Object.entries(TEACHER_MAP)) {
                        if (tName === t.name) {
                            const [cls, sub] = key.split('_');
                            if (validClasses.has(cls)) {
                                isRelevant = true;
                                break;
                            }
                        }
                    }
                    shouldExport = isRelevant;
                }

                if (shouldExport) {
                    data.push(['æ•™å¸ˆ', t.name, '-', t.pass, isFiltering ? 'å…³è”é€‰ä¸­å­¦æ ¡' : '']);
                    teacherCount++;
                }
            });

            // --- C. å†™å…¥å®¶é•¿ä¿¡æ¯ ---
            let parentCount = 0;
            this.db.parents.forEach(p => {
                let shouldExport = true;
                let schoolName = '';

                // å°è¯•æ‰¾å›å­¦æ ¡åä»¥ä¾¿å¡«å†™åœ¨å¤‡æ³¨é‡Œ (è´¦å·åº“é‡Œæ²¡å­˜å­¦æ ¡ï¼Œéœ€è¦å›æŸ¥ RAW_DATA)
                const stuRecord = RAW_DATA.find(r => r.name === p.name && r.class === p.class);
                if (stuRecord) schoolName = stuRecord.school;

                if (isFiltering) {
                    // åªæœ‰å½“å­¦ç”Ÿå±äºé€‰ä¸­å­¦æ ¡æ—¶æ‰å¯¼å‡º
                    if (stuRecord && selectedSchools.includes(stuRecord.school)) {
                        shouldExport = true;
                    } else {
                        shouldExport = false;
                    }
                }

                if (shouldExport) {
                    data.push(['å®¶é•¿', p.name, p.class, p.pass, schoolName || 'æœªçŸ¥/å·²åˆ é™¤']);
                    parentCount++;
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:10}, {wch:20}, {wch:15}, {wch:15}, {wch:25}];
            
            let fileName = `è´¦å·æ¸…å•_${new Date().toLocaleDateString()}.xlsx`;
            if (isFiltering) {
                // å¦‚æœåªé€‰äº†ä¸€ä¸ªå­¦æ ¡ï¼Œæ–‡ä»¶åå¸¦ä¸Šå­¦æ ¡å
                if (selectedSchools.length === 1) fileName = `${selectedSchools[0]}_è´¦å·æ¸…å•.xlsx`;
                else fileName = `ç‰¹å®šå­¦æ ¡è´¦å·æ¸…å•(å…±${selectedSchools.length}æ ¡).xlsx`;
            }

            XLSX.utils.book_append_sheet(wb, ws, "è´¦å·åˆ—è¡¨");
            XLSX.writeFile(wb, fileName);
            
            // ğŸš« å·²æ³¨é‡Šæ‰å¯¼å‡ºæˆåŠŸåçš„å¼¹çª—
            /*
            if (isFiltering) {
                alert(`âœ… å·²å¯¼å‡ºé€‰å®šèŒƒå›´çš„è´¦å·ï¼š\næ•™å¸ˆ: ${teacherCount} äºº\nå®¶é•¿: ${parentCount} äºº`);
            }
            */
        },
  
// ğŸŸ¢ [æ–°å¢] å‘äº‘ç«¯æ•°æ®åº“æ·»åŠ è´¦å·
        
        // ğŸŸ¢ [ä¿®æ”¹] é€‚é…çº§éƒ¨ä¸»ä»»å’Œç­ä¸»ä»»çš„æ‰‹åŠ¨æ·»åŠ 
        addCloudAccount: async function() {
            const role = document.getElementById('manual-role').value;
            const username = document.getElementById('manual-name').value.trim();
            const password = document.getElementById('manual-pass').value.trim();
            const school = document.getElementById('manual-school').value.trim();
            
            // è·å–å„ä¸ªè¾“å…¥æ¡†çš„å…ƒç´ 
            const classInput = document.getElementById('manual-class');
            const gradeInput = document.getElementById('manual-grade');

            // æ ¹æ®è§’è‰²è·å– "class_name" å­—æ®µåº”è¯¥å­˜ä»€ä¹ˆ
            let className = "";
            
            if (role === 'parent' || role === 'class_teacher') {
                // å¿…é¡»æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if(classInput) className = classInput.value.trim(); 
            } 
            else if (role === 'grade_director') {
                // å¿…é¡»æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if(gradeInput) className = gradeInput.value.trim(); 
            }
            // æ™®é€šæ•™å¸ˆç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼Œé˜²æ­¢æ•°æ®åº“éç©ºæŠ¥é”™
            else if (role === 'teacher') {
                className = "æ•™å¸ˆ"; 
            }

            // --- æ ¡éªŒé€»è¾‘ ---
            // 1. è´¦å·å¯†ç å¿…å¡«
            if (!username || !password) return alert("âŒ è¯·å¡«å†™è´¦å·å’Œå¯†ç ");
            
            // 2. å­¦æ ¡å¿…å¡« (é™¤äº†ç®¡ç†å‘˜)
            if (role !== 'admin' && !school) return alert("âŒ è¯·å¡«å†™æ‰€å±å­¦æ ¡");

            // 3. ç­çº§/å¹´çº§å¿…å¡«æ ¡éªŒ
            if ((role === 'parent' || role === 'class_teacher') && !className) {
                return alert("âŒ è¯·å¡«å†™ã€ç­çº§ã€‘(ä¾‹å¦‚: 701)");
            }
            if (role === 'grade_director' && !className) {
                return alert("âŒ è¯·å¡«å†™ã€çº§éƒ¨/å¹´çº§ã€‘(ä¾‹å¦‚: 7)");
            }

            UI.loading(true, "æ­£åœ¨å†™å…¥æ•°æ®åº“...");

            const newUserData = {
                username: username,
                password: password,
                role: role,
                school: role === 'admin' ? 'ç³»ç»Ÿ' : school, // ç®¡ç†å‘˜é»˜è®¤å­¦æ ¡
                class_name: className // è¿™æ˜¯ä¸€ä¸ªå¤ç”¨å­—æ®µï¼šå¯¹å®¶é•¿/ç­ä¸»ä»»æ˜¯ç­çº§ï¼Œå¯¹çº§éƒ¨ä¸»ä»»æ˜¯å¹´çº§
            };

            // æ‰§è¡Œæ’å…¥ (ä½¿ç”¨ upsert ä»¥ä¾¿æ”¯æŒâ€œæ›´æ–°â€æ“ä½œï¼Œå³è¦†ç›–æ—§è´¦å·)
            const { error } = await sbClient
                .from('system_users')
                .upsert(newUserData, { onConflict: 'username' });

            UI.loading(false);

            if (error) {
                console.error(error);
                alert("âŒ æ“ä½œå¤±è´¥ï¼š" + error.message);
            } else {
                UI.toast(`âœ… è´¦å· [${username}] å·²æ·»åŠ /æ›´æ–°æˆåŠŸï¼`, "success");
                // æ¸…ç©ºå§“åè¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç»§ç»­æ·»åŠ 
                document.getElementById('manual-name').value = '';
                // å¦‚æœæ˜¯å®¶é•¿ï¼Œä¸æ¸…ç©ºç­çº§ï¼Œæ–¹ä¾¿è¿ç»­æ·»åŠ åŒç­å­¦ç”Ÿ
                if(role !== 'parent') {
                     if(classInput) classInput.value = '';
                     if(gradeInput) gradeInput.value = '';
                }
            }
        },
// ğŸ› ï¸ ç®¡ç†å‘˜å·¥å…·ï¼šæ‰¹é‡åŒæ­¥æœ¬åœ°ç”Ÿæˆçš„è´¦å·åˆ°äº‘ç«¯ (V4 æ™ºèƒ½å®¹é”™ç‰ˆ)
        // ç‰¹æ€§ï¼šè‡ªåŠ¨å»é‡ + å¤±è´¥è‡ªåŠ¨é™çº§ä¸ºå•æ¡ä¸Šä¼  + ç²¾ç¡®æŠ¥é”™
        syncBatchToCloud: async function() {
            if (!sbClient) return alert("âŒ äº‘ç«¯æ•°æ®åº“è¿æ¥å¤±è´¥ã€‚");

            const parents = this.db.parents || [];
            const teachers = this.db.teachers || [];
            
            if (parents.length === 0 && teachers.length === 0) {
                return alert("âš ï¸ æœ¬åœ°è´¦å·ä¸ºç©ºï¼è¯·å…ˆç‚¹å‡»ã€ğŸ‘¤ ä¸€é”®ç”Ÿæˆæ‰€æœ‰è´¦å·ã€‘ã€‚");
            }

            if (!confirm(`âš ï¸ å‡†å¤‡åŒæ­¥è´¦å·åˆ°äº‘ç«¯ï¼š\n\nğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿ï¼š${parents.length}\nğŸ‘¨â€ğŸ« æ•™å¸ˆï¼š${teachers.length}\n\nç¡®å®šè¦†ç›–äº‘ç«¯æ•°æ®å—ï¼Ÿ`)) return;

            UI.loading(true, "æ­£åœ¨æ¸…æ´—å¹¶å»é‡æ•°æ®...");

            // 1. æ„å»ºæ˜ å°„è¡¨ä¸å»é‡å®¹å™¨
            const uniqueMap = new Map(); // key: username, value: dataObj
            const globalDefaultSchool = window.MY_SCHOOL || "é»˜è®¤å­¦æ ¡";
            
            // è¾…åŠ©ï¼šæŸ¥æ‰¾å­¦æ ¡
            const getSchool = (name, cls) => {
                // å°è¯•ä» RAW_DATA æŸ¥æ‰¾å‡†ç¡®å­¦æ ¡
                if(typeof RAW_DATA !== 'undefined') {
                    const s = RAW_DATA.find(r => r.name === name && r.class == cls);
                    if(s) return s.school;
                }
                return globalDefaultSchool;
            };

            // è¾…åŠ©ï¼šå¼ºåŠ›æ¸…æ´—å­—ç¬¦ä¸² (å»ç©ºæ ¼ã€å»ç‰¹æ®Šç¬¦)
            const cleanStr = (str) => String(str || "").trim().replace(/\s+/g, "");

            // --- A. å¤„ç†å®¶é•¿æ•°æ® ---
            parents.forEach(p => {
                const user = cleanStr(p.name);
                if(!user) return;
                
                uniqueMap.set(user, {
                    username: user,
                    password: cleanStr(p.pass) || "123456",
                    role: 'parent',
                    school: getSchool(p.name, p.class),
                    class_name: cleanStr(p.class) // ç­çº§
                });
            });

            // --- B. å¤„ç†æ•™å¸ˆæ•°æ® (ä¼˜å…ˆçº§é«˜ï¼Œè¦†ç›–åŒåå®¶é•¿) ---
            // é¢„å¤„ç†æ•™å¸ˆå­¦æ ¡æ˜ å°„
            const teaSchMap = {};
            if(typeof TEACHER_MAP !== 'undefined') {
                Object.entries(TEACHER_MAP).forEach(([k, v]) => {
                    const cls = k.split('_')[0];
                    // ç®€æ˜“åæŸ¥ï¼šéå†å­¦æ ¡æ‰¾ç­çº§
                    if(typeof SCHOOLS !== 'undefined') {
                        for(let sName in SCHOOLS) {
                            if(SCHOOLS[sName].students.some(s => s.class == cls)) {
                                teaSchMap[v] = sName; break;
                            }
                        }
                    }
                });
            }

            teachers.forEach(t => {
                const user = cleanStr(t.name);
                if(!user) return;

                uniqueMap.set(user, { // å†™å…¥ Mapï¼Œè‡ªåŠ¨è¦†ç›–åŒå Key
                    username: user,
                    password: cleanStr(t.pass) || "123456",
                    role: 'teacher',
                    school: teaSchMap[t.name] || globalDefaultSchool,
                    class_name: 'æ•™å¸ˆ'
                });
            });

            const batchData = Array.from(uniqueMap.values());
            console.log(`[åŒæ­¥å‡†å¤‡] åŸå§‹:${parents.length+teachers.length} -> å»é‡å:${batchData.length}`);

            // --- C. æ™ºèƒ½åˆ†æ‰¹ä¸Šä¼  ---
            const BATCH_SIZE = 10; // ä¿å®ˆæ‰¹æ¬¡å¤§å°
            let successCount = 0;
            let failCount = 0;
            let errorDetails = [];

            // å®šä¹‰å•æ¡é‡è¯•å‡½æ•°
            const uploadOneByOne = async (items) => {
                let ok = 0;
                for(let item of items) {
                    const { error } = await sbClient.from('system_users').upsert(item, { onConflict: 'username' });
                    if(error) {
                        console.warn(`âŒ å•æ¡å†™å…¥å¤±è´¥ [${item.username}]:`, error.message);
                        failCount++;
                        errorDetails.push(`${item.username}: ${error.message}`);
                    } else {
                        ok++;
                        successCount++;
                    }
                }
                return ok;
            };

            try {
                for (let i = 0; i < batchData.length; i += BATCH_SIZE) {
                    const chunk = batchData.slice(i, i + BATCH_SIZE);
                    
                    // 1. å°è¯•æ‰¹é‡å†™å…¥
                    const { error } = await sbClient.from('system_users').upsert(chunk, { onConflict: 'username' });

                    const pct = Math.round(((i + chunk.length) / batchData.length) * 100);
                    
                    if (error) {
                        console.warn(`âš ï¸ æ‰¹æ¬¡ ${Math.ceil(i/BATCH_SIZE)+1} æŠ¥é”™ (HTTP 500/409)ï¼Œè‡ªåŠ¨é™çº§ä¸ºå•æ¡ä¸Šä¼ æ¨¡å¼...`);
                        // 2. æ‰¹é‡å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§ä¸ºå•æ¡å¾ªç¯
                        await uploadOneByOne(chunk);
                    } else {
                        successCount += chunk.length;
                    }
                    
                    UI.loading(true, `â˜ï¸ åŒæ­¥ä¸­... ${pct}% (æˆåŠŸ:${successCount} / å¤±è´¥:${failCount})`);
                    // ç¨å¾®å»¶æ—¶é˜²æ­¢æ•°æ®åº“å‹åŠ›è¿‡å¤§
                    if(failCount > 50) throw new Error("é”™è¯¯è¿‡å¤šï¼Œä¸­æ­¢ä¸Šä¼ "); // ç†”æ–­æœºåˆ¶
                    await new Promise(r => setTimeout(r, 50));
                }

                UI.loading(false);

                if (failCount > 0) {
                    console.error("å¤±è´¥è¯¦æƒ…:", errorDetails);
                    alert(`âš ï¸ åŒæ­¥å®Œæˆï¼Œä½†æœ‰ ${failCount} ä¸ªè´¦å·å¤±è´¥ï¼\n\nâœ… æˆåŠŸï¼š${successCount}\nâŒ å¤±è´¥ï¼š${failCount}\n\nå¯èƒ½åŸå› ï¼šè´¦å·åŒ…å«éæ³•å­—ç¬¦æˆ–æ•°æ®åº“å­—æ®µè¶…é•¿ã€‚\næŒ‰ F12 æŸ¥çœ‹æ§åˆ¶å°å¯çœ‹å…·ä½“å¤±è´¥åå•ã€‚`);
                } else {
                    UI.toast(`âœ… å®Œç¾åŒæ­¥ï¼å…± ${successCount} ä¸ªè´¦å·å·²ä¸Šçº¿`, "success");
                    if(window.Logger) Logger.log('åŒæ­¥è´¦å·', `åŒæ­¥äº† ${successCount} ä¸ªè´¦å·`);
                }

            } catch (e) {
                UI.loading(false);
                console.error(e);
                alert("âŒ åŒæ­¥ä¸­æ–­ï¼š" + e.message);
            }
        },

// ğŸ› ï¸ ç®¡ç†å‘˜å·¥å…·ï¼šæ‰¹é‡åˆ é™¤äº‘ç«¯è´¦å· (ä¿ç•™ç®¡ç†å‘˜)
    deleteCloudAccounts: async function() {
        if (!sbClient) return alert("âŒ äº‘ç«¯æ•°æ®åº“è¿æ¥å¤±è´¥ã€‚");

        // 1. ç¬¬ä¸€é‡ç¡®è®¤
        if (!confirm("âš ï¸ã€é«˜é£é™©æ“ä½œã€‘âš ï¸\n\næ‚¨ç¡®å®šè¦æ¸…ç©ºäº‘ç«¯æ•°æ®åº“ä¸­çš„æ‰€æœ‰ã€å®¶é•¿ã€‘å’Œã€æ•™å¸ˆã€‘è´¦å·å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n2. ç®¡ç†å‘˜è´¦å·ä¼šè¢«ä¿ç•™ï¼Œä¸ä¼šè¢«åˆ é™¤ã€‚\n3. åˆ é™¤åç”¨æˆ·å°†æ— æ³•ç™»å½•ï¼Œç›´åˆ°æ‚¨å†æ¬¡åŒæ­¥ã€‚")) {
            return;
        }

        // 2. ç¬¬äºŒé‡ç¡®è®¤ (é˜²æ­¢è¯¯è§¦)
        const input = prompt("ğŸ”´ è¯·è¾“å…¥ 'ç¡®è®¤åˆ é™¤' å››ä¸ªå­—ä»¥æ‰§è¡Œæ¸…ç©ºæ“ä½œï¼š");
        if (input !== "ç¡®è®¤åˆ é™¤") {
            return alert("æ“ä½œå·²å–æ¶ˆã€‚");
        }

        UI.loading(true, "æ­£åœ¨æ¸…ç†äº‘ç«¯è´¦å·åº“...");

        try {
            // æ‰§è¡Œåˆ é™¤æ“ä½œ
            // é€»è¾‘ï¼šåˆ é™¤æ‰€æœ‰ role ä¸ç­‰äº 'admin' å’Œ 'director' çš„ç”¨æˆ·
            const { error, count } = await sbClient
                .from('system_users')
                .delete({ count: 'exact' }) // è¯·æ±‚è¿”å›åˆ é™¤çš„æ•°é‡
                .neq('role', 'admin')       // ä¿æŠ¤ç®¡ç†å‘˜
                .neq('role', 'director');   // ä¿æŠ¤æ•™åŠ¡ä¸»ä»»

            UI.loading(false);

            if (error) {
                throw error;
            }

            alert(`âœ… æ¸…ç†å®Œæˆï¼\nå…±åˆ é™¤äº† ${count !== null ? count : 'è‹¥å¹²'} ä¸ªäº‘ç«¯è´¦å·ã€‚\n\nç°åœ¨æ‚¨å¯ä»¥é‡æ–°ç”Ÿæˆå¹¶åŒæ­¥æ–°åå•äº†ã€‚`);

// ğŸ›¡ï¸ [æ—¥å¿—åŸ‹ç‚¹] è®°å½•æ¸…ç©ºè´¦å·æ“ä½œ
        Logger.log('æ¸…ç©ºè´¦å·', `ç®¡ç†å‘˜æ‰§è¡Œäº†æ¸…ç©ºäº‘ç«¯æ™®é€šè´¦å·æ“ä½œ (å½±å“:${count}äºº)`);

        } catch (e) {
            UI.loading(false);
            console.error(e);
            alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + e.message);
        }
    },
 
        exportAllCloudAccounts: async function() {
            if (!sbClient) return alert("âŒ äº‘ç«¯æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•å¯¼å‡ºã€‚");
            
            if (!confirm("âš ï¸ å‡†å¤‡ä»äº‘ç«¯ä¸‹è½½æ‰€æœ‰è´¦å·æ•°æ®ã€‚\n\nè¿™å°†åŒ…å«æ•°æ®åº“ä¸­å­˜å‚¨çš„ï¼š\n1. ç®¡ç†å‘˜\n2. æ•™å¸ˆ/ç­ä¸»ä»»/ä¸»ä»»\n3. å®¶é•¿/å­¦ç”Ÿ\n\nç¡®å®šè¦å¯¼å‡ºå—ï¼Ÿ")) return;

            UI.loading(true, "æ­£åœ¨ä»äº‘ç«¯æ‹‰å–æ‰€æœ‰è´¦å·...");

            try {
                // 1. ä» Supabase è·å–æ‰€æœ‰ç”¨æˆ· (é™åˆ¶10000æ¡ï¼Œä¸€èˆ¬å¤Ÿç”¨ï¼Œä¸å¤Ÿéœ€åˆ†é¡µ)
                const { data, error } = await sbClient
                    .from('system_users')
                    .select('*')
                    .order('school', { ascending: true }) // æŒ‰å­¦æ ¡æ’åº
                    .order('role', { ascending: true });  // å†æŒ‰è§’è‰²æ’åº
                    
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    throw new Error("äº‘ç«¯æ•°æ®åº“ä¸ºç©ºï¼Œæ²¡æœ‰è´¦å·å¯å¯¼å‡ºã€‚");
                }

                // 2. å‡†å¤‡ Excel æ•°æ®
                const headers = ['è§’è‰²', 'å­¦æ ¡', 'ç­çº§/èŒƒå›´', 'è´¦å·/å§“å', 'å¯†ç  (å¦‚å¯è§)'];
                const excelData = [headers];

                // è§’è‰²åç§°æ˜ å°„å­—å…¸
                const roleMap = {
                    'admin': 'ğŸ‘‘ ç®¡ç†å‘˜',
                    'director': 'ğŸ“ æ•™åŠ¡ä¸»ä»»',
                    'grade_director': 'ğŸš€ çº§éƒ¨ä¸»ä»»',
                    'class_teacher': 'ğŸ“‹ ç­ä¸»ä»»',
                    'teacher': 'ğŸ‘¨â€ğŸ« ç§‘ä»»æ•™å¸ˆ',
                    'parent': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿/å­¦ç”Ÿ'
                };

                data.forEach(u => {
                    const roleName = roleMap[u.role] || u.role;
                    excelData.push([
                        roleName,
                        u.school || '-',       // å­¦æ ¡
                        u.class_name || '-',   // ç­çº§
                        u.username,            // è´¦å·
                        u.password             // å¯†ç 
                    ]);
                });

                // 3. ç”Ÿæˆå¹¶ä¸‹è½½ Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // è®¾ç½®åˆ—å®½ (ç¾è§‚)
                ws['!cols'] = [{wch:15}, {wch:20}, {wch:15}, {wch:20}, {wch:15}];
                
                XLSX.utils.book_append_sheet(wb, ws, "äº‘ç«¯å…¨é‡è´¦å·");
                
                const fileName = `äº‘ç«¯å…¨é‡è´¦å·å¤‡ä»½_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                UI.loading(false);
                UI.toast(`âœ… å¯¼å‡ºæˆåŠŸï¼å…± ${data.length} æ¡æ•°æ®`, "success");

            } catch (err) {
                UI.loading(false);
                console.error(err);
                alert("âŒ å¯¼å‡ºå¤±è´¥: " + err.message);
            }
        },
     
        // ğŸ› ï¸ ç®¡ç†å‘˜å·¥å…·ï¼šæ¸…é™¤è´¦å·
        clearAccounts: function() {
            if(!confirm("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•™å¸ˆå’Œå®¶é•¿è´¦å·å—ï¼Ÿ\n(ç®¡ç†å‘˜å¯†ç ä¸ä¼šè¢«æ¸…é™¤)")) return;
            this.db.teachers = [];
            this.db.parents = [];
            localStorage.setItem('SYS_USERS', JSON.stringify(this.db));
            alert("âœ… æ‰€æœ‰æ™®é€šè´¦å·å·²æ¸…ç©º");
        }
    };

    const IssueManager = {
        isHistoryMode: false, // çŠ¶æ€æ ‡è®°ï¼šæ˜¯å¦å¤„äºå†å²è®°å½•æ¨¡å¼

        // 1. æ‰“å¼€å®¶é•¿ç”³è¯‰å¼¹çª—
        openSubmitModal: function(name, cls, school) {
            document.getElementById('issue-student-name').value = name;
            document.getElementById('issue-student-class').value = cls;
            document.getElementById('issue-student-school').value = school;
            // æ¸…ç©ºæ—§å†…å®¹
            const descArea = document.getElementById('issue-desc');
            descArea.value = '';
            descArea.style.borderColor = '#d1d5db'; // é‡ç½®è¾¹æ¡†é¢œè‰²
            
            // åŠ¨æ€æ’å…¥è¯­éŸ³æŒ‰é’® (å¦‚æœè¿˜æ²¡åŠ è¿‡)
            if (!document.getElementById('btn-voice-input-issue')) {
                const label = descArea.previousElementSibling; // æ‰¾åˆ° Label
                const voiceBtn = document.createElement('span');
                voiceBtn.id = 'btn-voice-input-issue';
                voiceBtn.innerHTML = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                voiceBtn.style.cssText = 'float:right; font-size:12px; color:var(--primary); cursor:pointer; margin-right:5px;';
                voiceBtn.onclick = function() {
                    // è°ƒç”¨ç®€å•çš„ Web Speech API
                    if (!('webkitSpeechRecognition' in window)) return alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥");
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = 'zh-CN';
                    recognition.start();
                    voiceBtn.innerText = 'ğŸ”´ æ­£åœ¨è†å¬...';
                    recognition.onresult = function(event) {
                        descArea.value += event.results[0][0].transcript;
                        voiceBtn.innerText = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    };
                    recognition.onerror = function() {
                        alert("è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥");
                        voiceBtn.innerText = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    };
                };
                label.appendChild(voiceBtn);
            }
            document.getElementById('issue-submit-modal').style.display = 'flex';
        },

        // 2. æäº¤ç”³è¯‰ (å®¶é•¿ç«¯)
        submit: async function() {
            if (!sbClient) return alert("âŒ äº‘ç«¯æœåŠ¡æœªè¿æ¥ï¼Œæ— æ³•æäº¤ã€‚");

            const name = document.getElementById('issue-student-name').value;
            const cls = document.getElementById('issue-student-class').value;
            const school = document.getElementById('issue-student-school').value;
            const type = document.getElementById('issue-type').value;
            const desc = document.getElementById('issue-desc').value.trim();
            const contact = document.getElementById('issue-contact').value.trim();

            // å®æ—¶éªŒè¯ï¼šæè¿°å¿…å¡«
            if (!desc) {
                const descArea = document.getElementById('issue-desc');
                descArea.style.borderColor = '#ef4444'; // å˜çº¢
                descArea.focus();
                
                // ä½¿ç”¨ SweetAlert2 (å¦‚æœæœ‰) æˆ– Toast æç¤º
                if(window.Swal) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'è¯·å¡«å†™è¯´æ˜',
                        text: 'ä¸ºäº†è€å¸ˆèƒ½å‡†ç¡®æ ¸å®ï¼Œè¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ã€‚',
                        timer: 2000
                    });
                } else {
                    alert("è¯·å¡«å†™å…·ä½“æƒ…å†µè¯´æ˜");
                }
                return;
            }

            UI.loading(true, "æ­£åœ¨æäº¤ç”³è¯·...");

            const { error } = await sbClient
                .from('issues')
                .insert([{
                    student_name: name,
                    student_class: cls,
                    school: school,
                    issue_type: type,
                    description: desc,
                    contact_info: contact,
                    status: 'pending' // é»˜è®¤ä¸ºå¾…å¤„ç†
                }]);

            UI.loading(false);

            if (error) {
                alert("æäº¤å¤±è´¥ï¼š" + error.message);
            } else {
                alert("âœ… ç”³è¯·å·²æäº¤ï¼\næ•™åŠ¡å¤„å°†å°½å¿«æ ¸æŸ¥ï¼Œè¯·ç•™æ„åç»­é€šçŸ¥æˆ–è€å¸ˆåé¦ˆã€‚");
                document.getElementById('issue-submit-modal').style.display = 'none';
                document.getElementById('issue-desc').value = '';
            }
        },

        // 3. æ£€æŸ¥å¾…å¤„ç†æ¶ˆæ¯ (çº¢ç‚¹è½®è¯¢ - æ ¸å¿ƒæƒé™é€»è¾‘)
        checkIssues: async function() {
            if (!sbClient) return;
            const user = typeof Auth !== 'undefined' ? Auth.currentUser : null;
            if (!user) return;

            // åŸºç¡€æ¡ä»¶æ˜¯ status = pending
            let query = sbClient
                .from('issues')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');

            // ğŸŸ¢ [æ–°å¢] æƒé™è¿‡æ»¤ï¼šç¡®ä¿çº¢ç‚¹æ•°é‡åªç»Ÿè®¡è‡ªå·±ç®¡è¾–èŒƒå›´å†…çš„
            if (user.role === 'grade_director') {
                // çº§éƒ¨ä¸»ä»»ï¼šçœ‹æœ¬å¹´çº§ (æ¨¡ç³ŠåŒ¹é… "7%")
                if (user.class) query = query.ilike('student_class', `${user.class}%`);
            } else if (user.role === 'class_teacher') {
                // ğŸŸ¢ ç­ä¸»ä»»ï¼šåªçœ‹æœ¬ç­ (ç²¾ç¡®åŒ¹é… "701")
                if (user.class) query = query.eq('student_class', user.class);
            } else if (user.role === 'director') {
                // æ•™åŠ¡ä¸»ä»»ï¼šçœ‹æœ¬æ ¡
                if (user.school) query = query.eq('school', user.school);
            }

            const { count, error } = await query;

            if (!error) {
                const badge = document.getElementById('msg-badge');
                if (badge) {
                    if (count > 0) {
                        badge.innerText = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }
        },

        // 4. æ‰“å¼€ç®¡ç†å‘˜å¤„ç†é¢æ¿
        openAdminPanel: async function() {
            this.isHistoryMode = false; // é»˜è®¤è¿›å…¥çœ‹æ­£å¸¸åˆ—è¡¨
            this.updateUIState();
            const modal = document.getElementById('admin-issue-modal');
            modal.style.display = 'flex';
            this.loadIssues();
        },

        // åˆ‡æ¢ å†å²è®°å½• / æ­£å¸¸è§†å›¾
        toggleHistoryView: function() {
            this.isHistoryMode = !this.isHistoryMode;
            this.updateUIState();
            this.loadIssues(); // é‡æ–°åŠ è½½æ•°æ®
        },

        // æ›´æ–°ç•Œé¢æŒ‰é’®çŠ¶æ€
        updateUIState: function() {
            const titleEl = document.getElementById('issue-modal-title');
            const btnHistory = document.getElementById('btn-issue-history');
            const normalActions = document.getElementById('issue-normal-actions');
            const historyActions = document.getElementById('issue-history-actions');
            const tipBar = document.getElementById('issue-tip-bar');
            
            // é‡ç½®å…¨é€‰çŠ¶æ€
            if(document.getElementById('issue-check-all')) document.getElementById('issue-check-all').checked = false;
            if(document.getElementById('issue-history-check-all')) document.getElementById('issue-history-check-all').checked = false;

            if (this.isHistoryMode) {
                titleEl.innerHTML = '<i class="ti ti-trash"></i> åˆ é™¤å†å²è®°å½• (å›æ”¶ç«™)';
                titleEl.style.color = '#666';
                btnHistory.innerHTML = '<i class="ti ti-arrow-back-up"></i> è¿”å›åˆ—è¡¨';
                btnHistory.className = 'btn btn-sm btn-primary';
                normalActions.style.display = 'none';
                historyActions.style.display = 'flex';
                tipBar.style.display = 'none';
            } else {
                titleEl.innerHTML = '<i class="ti ti-bell"></i> ç”³è¯‰åé¦ˆä¸­å¿ƒ';
                titleEl.style.color = 'var(--primary)';
                btnHistory.innerHTML = '<i class="ti ti-history"></i> æŸ¥çœ‹åˆ é™¤è®°å½•';
                btnHistory.className = 'btn btn-sm btn-gray';
                normalActions.style.display = 'flex';
                historyActions.style.display = 'none';
                tipBar.style.display = 'block';
            }
        },

        // å…¨é€‰/åé€‰
        toggleSelectAll: function(source) {
            const checkboxes = document.querySelectorAll('.issue-item-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
        },

        // è·å–é€‰ä¸­çš„ID
        getCheckedIds: function() {
            const checkboxes = document.querySelectorAll('.issue-item-check:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        },

        // 5. åŠ è½½ç”³è¯‰åˆ—è¡¨ (åˆ—è¡¨æ¸²æŸ“ - æ ¸å¿ƒæƒé™é€»è¾‘)
        loadIssues: async function() {
            const listEl = document.getElementById('admin-issue-list');
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">â³ åŠ è½½ä¸­...</div>';

            const user = typeof Auth !== 'undefined' ? Auth.currentUser : null;
            
            // æ„å»ºæŸ¥è¯¢
            let query = sbClient
                .from('issues')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(100);

            // çŠ¶æ€è¿‡æ»¤ (æ­£å¸¸ vs å†å²)
            if (this.isHistoryMode) {
                query = query.eq('status', 'deleted');
            } else {
                query = query.neq('status', 'deleted');
            }

            // ğŸŸ¢ [æ–°å¢] æƒé™è¿‡æ»¤ (ç¡®ä¿åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡è¾–çš„ç­çº§)
            if (user && user.role === 'grade_director') {
                if (user.class) query = query.ilike('student_class', `${user.class}%`);
            } else if (user && user.role === 'class_teacher') {
                // ğŸŸ¢ ç­ä¸»ä»»è¿‡æ»¤ï¼šå¼ºåˆ¶åŒ¹é… student_class == ç­çº§å
                if (user.class) query = query.eq('student_class', user.class);
            } else if (user && user.role === 'director') {
                if (user.school) query = query.eq('school', user.school);
            }

            const { data, error } = await query;

            if (error) {
                listEl.innerHTML = `<div style="color:red; text-align:center;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">ğŸ“­ æš‚æ— ç›¸å…³è®°å½•</div>';
                return;
            }

            let html = '';
            data.forEach(item => {
                const time = new Date(item.created_at).toLocaleString();
                const isPending = item.status === 'pending';
                const isDeleted = item.status === 'deleted';
                
                let statusBadge = '';
                let actionBtn = '';

                if (isDeleted) {
                    statusBadge = `<span class="badge" style="background:#9ca3af; color:white;">å·²åˆ é™¤</span>`;
                    actionBtn = `<span style="font-size:12px; color:#999;">å·²åˆ é™¤</span>`;
                } else {
                    statusBadge = isPending 
                        ? `<span class="badge" style="background:#ef4444; color:white;">å¾…å¤„ç†</span>` 
                        : `<span class="badge" style="background:#10b981; color:white;">å·²è§£å†³</span>`;
                    
                    actionBtn = isPending 
                        ? `<button class="btn btn-sm btn-primary" onclick="IssueManager.resolve(${item.id})">âœ… æ ‡è®°å·²é˜…/è§£å†³</button>` 
                        : `<span style="font-size:12px; color:#ccc;">å·²å½’æ¡£</span>`;
                }

                html += `
                    <div style="background:white; border:1px solid #e2e8f0; border-left:4px solid ${isPending?'#ef4444':(isDeleted?'#9ca3af':'#10b981')}; border-radius:8px; padding:15px; margin-bottom:10px; display:flex; gap:10px;">
                        <div style="display:flex; align-items:center;">
                            <input type="checkbox" class="issue-item-check" value="${item.id}" style="transform:scale(1.2); cursor:pointer;">
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <div style="font-weight:bold; color:#333;">
                                    ${item.school} Â· ${item.student_class} Â· ${item.student_name}
                                </div>
                                <div style="font-size:12px; color:#64748b;">${time}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; font-size:13px;">
                                <span style="background:#f3f4f6; padding:2px 6px; border-radius:4px;">${item.issue_type}</span>
                                ${statusBadge}
                            </div>
                            <div style="background:#f8fafc; padding:10px; border-radius:4px; font-size:14px; color:#475569; margin-bottom:10px;">
                                ${item.description}
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-size:12px; color:#0369a1;">ğŸ“ è”ç³»: ${item.contact_info || 'æ— '}</div>
                                <div>${actionBtn}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        },

        // 6. å•æ¡å¤„ç†
        resolve: async function(id) {
            if (!confirm("ç¡®è®¤å·²æ ¸å®å¹¶å¤„ç†è¯¥é—®é¢˜äº†å—ï¼Ÿ\næ ‡è®°ä¸ºå·²è§£å†³åï¼Œè¯¥æ¡ç›®å°†ä¸å†æ˜¾ç¤ºçº¢ç‚¹ã€‚")) return;
            const { error } = await sbClient.from('issues').update({ status: 'resolved' }).eq('id', id);
            if (error) alert("æ“ä½œå¤±è´¥ï¼š" + error.message);
            else { this.loadIssues(); this.checkIssues(); }
        },

        // 7. ğŸŸ¢ [æ–°åŠŸèƒ½] æ‰¹é‡è½¯åˆ é™¤ (ç§»å…¥å†å²)
        batchSoftDelete: async function() {
            const ids = this.getCheckedIds();
            if (ids.length === 0) return UI.toast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹", "error");
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿ\n(åˆ é™¤åå¯åœ¨â€œå†å²è®°å½•â€ä¸­æ‰¾å›)`)) return;

            UI.loading(true, "æ­£åœ¨ç§»é™¤...");
            // å°†çŠ¶æ€æ”¹ä¸º deleted
            const { error } = await sbClient.from('issues').update({ status: 'deleted' }).in('id', ids);
            UI.loading(false);

            if (error) alert("åˆ é™¤å¤±è´¥: " + error.message);
            else {
                UI.toast(`å·²åˆ é™¤ ${ids.length} æ¡è®°å½•`, 'success');
                this.loadIssues(); // é‡æ–°åŠ è½½ï¼Œå·²åˆ é™¤çš„æ¡ç›®ä¼šæ¶ˆå¤±
                this.checkIssues(); // åˆ·æ–°çº¢ç‚¹
                document.getElementById('issue-check-all').checked = false;
            }
        },

        // 8. ğŸŸ¢ [æ–°åŠŸèƒ½] æ‰¹é‡è¿˜åŸ
        batchRestore: async function() {
            const ids = this.getCheckedIds();
            if (ids.length === 0) return UI.toast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹", "error");
            
            UI.loading(true, "æ­£åœ¨è¿˜åŸ...");
            // è¿˜åŸä¸º resolved (å·²è¯»)ï¼Œæ¯”è¾ƒå®‰å…¨
            const { error } = await sbClient.from('issues').update({ status: 'resolved' }).in('id', ids);
            UI.loading(false);

            if (error) alert("è¿˜åŸå¤±è´¥: " + error.message);
            else {
                UI.toast(`å·²è¿˜åŸ ${ids.length} æ¡è®°å½•`, 'success');
                this.loadIssues(); // é‡æ–°åŠ è½½ï¼Œè¿˜åŸçš„æ¡ç›®ä¼šä»å†å²åˆ—è¡¨ä¸­æ¶ˆå¤±
                document.getElementById('issue-history-check-all').checked = false;
            }
        },

        // 9. ğŸŸ¢ [æ–°åŠŸèƒ½] æ‰¹é‡å½»åº•åˆ é™¤ (ç‰©ç†åˆ é™¤)
        batchHardDelete: async function() {
            const ids = this.getCheckedIds();
            if (ids.length === 0) return UI.toast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹", "error");
            
            // åŒé‡ç¡®è®¤ï¼Œé˜²æ­¢è¯¯åˆ 
            if (!confirm(`âš ï¸ é«˜èƒ½é¢„è­¦ âš ï¸\n\nç¡®å®šè¦ã€å½»åº•åˆ é™¤ã€‘é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

            UI.loading(true, "æ­£åœ¨å½»åº•ç²‰ç¢æ•°æ®...");
            const { error } = await sbClient.from('issues').delete().in('id', ids);
            UI.loading(false);

            if (error) alert("åˆ é™¤å¤±è´¥: " + error.message);
            else {
                UI.toast(`å½»åº•åˆ é™¤äº† ${ids.length} æ¡è®°å½•`, 'success');
                this.loadIssues(); // é‡æ–°åŠ è½½ï¼Œæ•°æ®å°†æ°¸ä¹…æ¶ˆå¤±
                document.getElementById('issue-history-check-all').checked = false;
            }
        }
    };

    // ğŸ“¦ ç³»ç»Ÿæ‰“åŒ…å·¥å…·
    const Packager = {
        // ç”ŸæˆåŒ…å«æ•°æ®çš„ç‹¬ç«‹ HTML æ–‡ä»¶
        exportDistributableHTML: function() {
            // 1. æ£€æŸ¥æ•°æ®
            if (!RAW_DATA.length) return alert("å½“å‰æ— æˆç»©æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆåˆ†å‘ç‰ˆã€‚");
            if (!Auth.db.parents.length && !Auth.db.teachers.length) return alert("å½“å‰æ— è´¦å·ä¿¡æ¯ï¼Œè¯·å…ˆåœ¨è´¦å·ç®¡ç†ä¸­ç”Ÿæˆè´¦å·ã€‚");

            if (!confirm("âš ï¸ å‡†å¤‡ç”Ÿæˆã€åˆ†å‘ç‰ˆç½‘é¡µã€‘...\n\næ­¤æ–‡ä»¶å°†åŒ…å«ï¼š\n1. æ‰€æœ‰å­¦ç”Ÿæˆç»©æ•°æ®\n2. æ‰€æœ‰ç”Ÿæˆçš„è´¦å·å¯†ç \n\nè¯·å°†ç”Ÿæˆçš„ .html æ–‡ä»¶å‘é€ç»™å®¶é•¿/è€å¸ˆã€‚\nä»–ä»¬æ— éœ€ä¸Šä¼ Excelï¼Œç›´æ¥è¾“å…¥è´¦å·å³å¯ç™»å½•ã€‚\n\nç¡®å®šç»§ç»­å—ï¼Ÿ")) return;

            UI.loading(true, "æ­£åœ¨æ‰“åŒ…å…¨é‡æ•°æ®...");

            setTimeout(() => {
                try {
                    // 2. å‡†å¤‡è¦æ³¨å…¥çš„æ•°æ®åŒ…
                    const dataPackage = {
                        timestamp: new Date().getTime(),
                        // æ ¸å¿ƒä¸šåŠ¡æ•°æ®
                        RAW_DATA: RAW_DATA,
                        SCHOOLS: SCHOOLS, // åŒ…å«ç»Ÿè®¡ç»“æœï¼Œé¿å…é‡æ–°è®¡ç®—
                        SUBJECTS: SUBJECTS,
                        THRESHOLDS: THRESHOLDS,
                        TEACHER_MAP: TEACHER_MAP,
                        MY_SCHOOL: MY_SCHOOL,
                        CONFIG: CONFIG,
                        // æ ¸å¿ƒæƒé™æ•°æ®
                        AUTH_DB: Auth.db, 
                        // å…¶ä»–é…ç½®
                        LLM_CONFIG: LLM_CONFIG
                    };

                    // 3. è·å–å½“å‰é¡µé¢çš„å®Œæ•´æºä»£ç 
                    let htmlContent = document.documentElement.outerHTML;

                   // A. å¼ºåˆ¶æ˜¾ç¤ºç™»å½•é®ç½©ï¼Œéšè—ä¸»ç•Œé¢
                    htmlContent = htmlContent.replace(
                        /id="login-overlay"\s+style="([^"]*)"/, 
                        'id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:50000; display:flex; align-items:center; justify-content:center; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;"'
                    );
                    
                    // å¼ºåˆ¶éšè—ä¸»å®¹å™¨
                    if (htmlContent.includes('id="app" class="container"')) {
                         htmlContent = htmlContent.replace('id="app" class="container"', 'id="app" class="container hidden"');
                    } else {
                        htmlContent = htmlContent.replace('id="app"', 'id="app" class="hidden"');
                    }

                    // B. ã€ä¿®å¤å¼¹çª—é—®é¢˜ã€‘å¼ºåˆ¶éšè—ç®¡ç†å‘˜æ¨¡æ€æ¡†
                    htmlContent = htmlContent.replace(
                        /id="admin-modal"\s+class="modal"\s+style="([^"]*)"/,
                        'id="admin-modal" class="modal" style="display: none; z-index: 60000;"'
                    );

                    // C. ã€ä¿®å¤å³ä¸Šè§’åå­—é—®é¢˜ã€‘ç§»é™¤å·²å­˜åœ¨çš„é€€å‡ºæŒ‰é’®
                    htmlContent = htmlContent.replace(/<div id="logout-btn".*?<\/div>/, '');

                    // D. éšè—ç®¡ç†å‘˜å…¥å£æŒ‰é’®
                    htmlContent = htmlContent.replace('id="admin-panel-btn" onclick', 'id="admin-panel-btn" style="display:none" onclick');

                    // E. ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶éšè—å…¨å±€åŠ è½½é®ç½© (ä¿®å¤ä¸€ç›´è½¬åœˆçš„é—®é¢˜) ğŸ”¥
                    // ä½¿ç”¨æ­£åˆ™æ›¿æ¢ï¼Œå¼ºåˆ¶ç»™ global-loader åŠ ä¸Š hidden ç±»ï¼Œå¹¶å»æ‰å¯èƒ½å­˜åœ¨çš„å†…è” style
                    htmlContent = htmlContent.replace(
                        /<div id="global-loader"[\s\S]*?>/, 
                        '<div id="global-loader" class="hidden">'
                    );

                    // 4. æ„å»ºæ³¨å…¥è„šæœ¬ (å°†æ•°æ®å¯¹è±¡è½¬ä¸º JSON å­—ç¬¦ä¸²)
                    // ä¸ºäº†é˜²æ­¢ XSS æˆ–é—­åˆæ ‡ç­¾é”™è¯¯ï¼Œè¿›è¡Œç®€å•çš„è½¬ä¹‰
                    const jsonStr = JSON.stringify(dataPackage).replace(/<\/script>/g, '<\\/script>');
                    const injectionCode = `window.EMBEDDED_DB = ${jsonStr};`;

                    // 5. æ›¿æ¢æ’æ§½å†…å®¹
                    // å¯»æ‰¾ç¬¬ä¸€æ­¥ä¸­é¢„ç•™çš„ window.EMBEDDED_DB = null;
                    const targetStr = "window.EMBEDDED_DB = null;";
                    
                    if (!htmlContent.includes(targetStr)) {
                        throw new Error("æ¨¡æ¿æ’æ§½æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ HTML å¤´éƒ¨æ˜¯å¦æ·»åŠ äº† id='embedded-data-script'");
                    }

                    // æ‰§è¡Œæ›¿æ¢
                    const newHtml = htmlContent.replace(targetStr, injectionCode);

                    // 6. ä¸‹è½½æ–°æ–‡ä»¶
                    const blob = new Blob([newHtml], { type: "text/html;charset=utf-8" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    // æ–‡ä»¶åå¸¦ä¸Šæ—¶é—´ï¼Œæ–¹ä¾¿åŒºåˆ†
                    link.download = `æŸ¥åˆ†ç³»ç»Ÿ_åˆ†å‘ç‰ˆ_${new Date().toLocaleDateString().replace(/\//g,'-')}.html`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    UI.loading(false);
                    alert("âœ… åˆ†å‘ç‰ˆå·²ç”Ÿæˆï¼\n\nè¯·å°†ä¸‹è½½çš„ .html æ–‡ä»¶å‘é€ç»™å®¶é•¿ã€‚\nå®¶é•¿æ‰“å¼€è¯¥æ–‡ä»¶åï¼Œå¯ç›´æ¥ç”¨è´¦å·ç™»å½•ã€‚");

                } catch (e) {
                    console.error(e);
                    UI.loading(false);
                    alert("æ‰“åŒ…å¤±è´¥: " + e.message);
                }
            }, 500);
        }
    };

    const HelpSystem = {
        // å®šä¹‰å„æ¨¡å—çš„å¸®åŠ©å†…å®¹
        content: {
            'upload': {
                title: 'ğŸ“ æ•°æ®ä¸Šä¼ è§„èŒƒ',
                html: `
                    <div style="text-align:left; line-height:1.6;">
                        <p><strong>1. Excel æ ¼å¼è¦æ±‚ï¼š</strong></p>
                        <ul>
                            <li>ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯è¡¨å¤´ï¼ˆå¦‚ï¼šå§“åã€ç­çº§ã€è¯­æ–‡ã€æ•°å­¦...ï¼‰ã€‚</li>
                            <li>å¿…é¡»åŒ…å«<strong>å§“å</strong>åˆ—ã€‚</li>
                            <li>å¦‚æœæœ‰å¤šä¸ªå­¦æ ¡ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ Sheet é¡µï¼Œ<strong>Sheetåç§°å³ä¸ºå­¦æ ¡å</strong>ã€‚</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>2. å¸¸è§é—®é¢˜ï¼š</strong></p>
                        <ul>
                            <li>ç¼ºè€ƒ/ä½œå¼Šï¼šå¯å¡« "0" æˆ– "ç¼ºè€ƒ"ï¼ˆç³»ç»ŸæŒ‰0åˆ†å¤„ç†ï¼‰ã€‚</li>
                            <li>åˆ—åè¯†åˆ«ï¼šç³»ç»Ÿæ”¯æŒâ€œè¯­æ–‡/è¯­/Chineseâ€ç­‰å¤šç§åˆ«åè‡ªåŠ¨è¯†åˆ«ã€‚</li>
                        </ul>
                    </div>
                `,
                icon: 'info'
            },
            'macro': {
                title: 'ğŸ“Š ä¸¤ç‡ä¸€åˆ†ç®—æ³•è¯´æ˜',
                html: `
                    <div style="text-align:left;">
                        <p><strong>æ ¸å¿ƒå…¬å¼ï¼š</strong></p>
                        <p>æ€»åˆ† = (å‡åˆ†èµ‹åˆ†) + (ä¼˜ç‡èµ‹åˆ†) + (åŠæ ¼èµ‹åˆ†)</p>
                        <hr style="margin:10px 0; border:0; border-top:1px dashed #eee;">
                        <p><strong>é»˜è®¤æƒé‡é…ç½®ï¼š</strong></p>
                        <ul>
                            <li><strong>6-8å¹´çº§ï¼š</strong> å‡åˆ†60 + ä¼˜ç‡70 + åŠæ ¼70 = æ»¡åˆ†200</li>
                            <li><strong>9å¹´çº§ï¼š</strong> å‡åˆ†40 + ä¼˜ç‡80 + åŠæ ¼40 = æ»¡åˆ†160</li>
                        </ul>
                        <p style="font-size:12px; color:#666; margin-top:5px;">* æŒ‡æ ‡è®¡ç®—åŸºå‡†ï¼šä»¥å…¨é•‡æœ€é«˜å€¼ä¸ºæ»¡åˆ†è¿›è¡Œå½’ä¸€åŒ–æŠ˜ç®—ã€‚</p>
                    </div>
                `
            },
            'teacher': {
                title: 'ğŸ‘¨â€ğŸ« æ•™å¸ˆè¯„ä»·æ¨¡å‹',
                html: `
                    <div style="text-align:left;">
                        <p>ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹ç»´åº¦è¯„ä»·æ•™å¸ˆæ•™å­¦è´¨é‡ï¼š</p>
                        <ol>
                            <li><strong>ä¸‰ç‡æŒ‡æ ‡ï¼š</strong> ä¼˜ç§€ç‡ã€åŠæ ¼ç‡ã€ä½åˆ†ç‡ã€‚</li>
                            <li><strong>è´¡çŒ®å€¼ï¼š</strong> (ç­çº§å‡åˆ† - å¹´çº§å‡åˆ†)ã€‚</li>
                            <li><strong>ä¹¡é•‡æ’åï¼š</strong> è¯¥æ•™å¸ˆæ‰€æ•™ç­çº§åœ¨å…¨é•‡åŒç§‘ç›®çš„æ’åã€‚</li>
                        </ol>
                        <div class="info-bar" style="margin-top:10px; font-size:12px;">
                            ğŸ’¡ æç¤ºï¼šè¯·å…ˆåœ¨ã€æ•°æ®ä¸Šä¼ ã€‘é¡µé¢ä¸‹æ–¹é…ç½®å¥½â€œæ•™å¸ˆä»»è¯¾è¡¨â€æ‰èƒ½çœ‹åˆ°æ­¤åˆ†æã€‚
                        </div>
                    </div>
                `
            }
        },

        // æ˜¾ç¤ºå•ç‚¹å¸®åŠ©
        show: function(key) {
            if(this.content[key]) {
                Swal.fire({
                    title: this.content[key].title,
                    html: this.content[key].html,
                    icon: 'question',
                    confirmButtonText: 'æ˜ç™½äº†',
                    confirmButtonColor: '#4f46e5'
                });
            }
        },

        // å¯åŠ¨æ–°æ‰‹å¼•å¯¼ä¹‹æ—… (Wizard)
        startTour: function() {
            const steps = [
                {
                    title: 'ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½æ•™åŠ¡ç³»ç»Ÿ',
                    html: 'åªéœ€ 3 æ­¥å®Œæˆä¸€æ¬¡å®Œæ•´æµç¨‹ï¼š<strong>å¯¼å…¥ â†’ åˆ†æ â†’ å¯¼å‡º</strong>ã€‚',
                    imageUrl: 'https://cdn-icons-png.flaticon.com/512/4205/4205622.png',
                    imageWidth: 100,
                    confirmButtonText: 'ä¸‹ä¸€æ­¥: å¯¼å…¥æ•°æ®'
                },
                {
                    title: '1ï¸âƒ£ å¯¼å…¥',
                    html: 'è¿›å…¥<strong>ã€æ•°æ®æ¢çº½ã€‘</strong>ä¸Šä¼  Excelã€‚<br><small style="color:#666">ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å­¦æ ¡ã€ç­çº§ä¸å­¦ç§‘ã€‚</small>',
                    icon: 'info',
                    confirmButtonText: 'ä¸‹ä¸€æ­¥: åˆ†æ'
                },
                {
                    title: '2ï¸âƒ£ åˆ†æ',
                    html: 'è¿›å…¥<strong>ã€æ ¡é™…è”è€ƒåˆ†æã€‘</strong>æŸ¥çœ‹æ¨ªå‘æ’åï¼Œ<br>è¿›å…¥<strong>ã€ç­çº§æ•™å­¦ç®¡ç†ã€‘</strong>çœ‹æ•™å¸ˆè´¡çŒ®åº¦ã€‚',
                    icon: 'success',
                    confirmButtonText: 'ä¸‹ä¸€æ­¥: å¯¼å‡º'
                },
                {
                    title: '3ï¸âƒ£ å¯¼å‡º',
                    html: 'è¿›å…¥<strong>ã€ç»¼åˆåˆ†ææŠ¥å‘Šã€‘</strong>æˆ–<strong>ã€æˆç»©å•/å®¶é•¿æŸ¥åˆ†ã€‘</strong>ä¸€é”®å¯¼å‡ºã€‚',
                    icon: 'success',
                    confirmButtonText: 'å¼€å§‹ä½¿ç”¨ï¼'
                }
            ];

            // ä½¿ç”¨ SweetAlert2 çš„é˜Ÿåˆ—åŠŸèƒ½
            let currentStep = 0;
            const showStep = (index) => {
                if (index >= steps.length) return;
                Swal.fire({
                    ...steps[index],
                    showCancelButton: index < steps.length - 1,
                    cancelButtonText: 'è·³è¿‡æ•™ç¨‹',
                    confirmButtonColor: '#4f46e5',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        showStep(index + 1);
                    }
                });
            };
            showStep(0);
        },

        // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è®¿é—®
        checkFirstRun: function() {
            if (!localStorage.getItem('hasSeenV3Tour')) {
                setTimeout(() => {
                    this.startTour();
                    localStorage.setItem('hasSeenV3Tour', 'true');
                }, 1000); // å»¶è¿Ÿ1ç§’æ˜¾ç¤ºï¼Œç­‰å¾…é¡µé¢æ¸²æŸ“
            }
        }
    };

    // 1. Worker è„šæœ¬æºç  (åå°çº¿ç¨‹é€»è¾‘)
    const WORKER_SOURCE = `
    self.onmessage = function(e) {
        const { cmd, data } = e.data;
        if (cmd === 'PROCESS_ALL') {
            const { RAW_DATA, SUBJECTS, CONFIG, THRESHOLDS } = data;
            // æ¥æ”¶è½»é‡ç‰ˆ SCHOOLS (æ— å¾ªç¯å¼•ç”¨)
            let SCHOOLS = data.SCHOOLS_LITE; 

            try {
                // --- A. é‡å»ºç´¢å¼• ---
                const schoolMap = {};
                Object.keys(SCHOOLS).forEach(k => {
                    schoolMap[k] = { ...SCHOOLS[k], students: [] };
                });
                // é‡æ–°å½’ç±»å­¦ç”Ÿ
                RAW_DATA.forEach(s => {
                    if (schoolMap[s.school]) schoolMap[s.school].students.push(s);
                });

                // --- B. è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ (åŸ processData é€»è¾‘) ---
                Object.values(schoolMap).forEach(sch => {
                    [...SUBJECTS, 'total'].forEach(k => {
                        const vals = sch.students.map(s => k==='total'?s.total:s.scores[k]).filter(v=>v!==undefined);
                        if(!vals.length) { sch.metrics[k] = { count:0, avg:0, excRate:0, passRate:0 }; return; }
                        const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
                        const excN = vals.filter(v=>v>=THRESHOLDS[k].exc).length;
                        const passN = vals.filter(v=>v>=THRESHOLDS[k].pass).length;
                        sch.metrics[k] = { count: vals.length, avg: avg, excRate: excN / vals.length, passRate: passN / vals.length };
                    });
                    
                    // å1/3è®¡ç®—
                    const totalN = sch.students.length; 
                    const bottomN = Math.ceil(totalN / 3); 
                    const excN = Math.ceil(bottomN * CONFIG.excRate);
                    const sorted = [...sch.students].sort((a,b)=>b.total - a.total);
                    const bottomGroup = sorted.slice(-bottomN);
                    const validGroup = bottomGroup.slice(0, Math.max(0, bottomGroup.length - excN));
                    const bAvg = validGroup.length ? validGroup.reduce((a,b)=>a+b.total,0)/validGroup.length : 0;
                    sch.bottom3 = { totalN, bottomN, excN, avg: bAvg };
                });

               // === æ–°å¢åŠŸèƒ½ï¼šè®¡ç®—å…¨é•‡å„ç§‘æ ‡å‡†å·® & å­¦ç”Ÿ T åˆ† (T-Score) ===
                
                // 1. è®¡ç®—å…¨é•‡å„ç§‘çš„ç»Ÿè®¡æŒ‡æ ‡ (å‡åˆ† & æ ‡å‡†å·®)
                const globalStats = {};
                SUBJECTS.forEach(sub => {
                    const scores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                    if (scores.length > 1) {
                        const sum = scores.reduce((a, b) => a + b, 0);
                        const avg = sum / scores.length;
                        const variance = scores.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / scores.length;
                        const sd = Math.sqrt(variance);
                        globalStats[sub] = { avg, sd };
                    }
                });

                // 2. å®šä¹‰ 9 å¹´çº§æ ¸å¿ƒäº”ç§‘ (ç”¨äºé”å®šæ ‡å‡†åˆ†æ€»åˆ†è®¡ç®—èŒƒå›´)
                const isGrade9Mode = CONFIG.name && CONFIG.name.includes('9');
                const grade9CoreSubjects = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦'];

                // 3. ä¸ºæ¯ä¸ªå­¦ç”Ÿè®¡ç®— T åˆ†
                RAW_DATA.forEach(stu => {
                    stu.tScores = {}; // å­˜å‚¨å•ç§‘ T åˆ†
                    stu.totalTScore = 0; // T åˆ†æ€»å’Œ
                    
                    SUBJECTS.forEach(sub => {
                        const val = stu.scores[sub];
                        const stats = globalStats[sub];
                        
                        // å¿…é¡»ç¡®ä¿ stats å­˜åœ¨ï¼Œä¸”æ ‡å‡†å·®å¤§äºæå°å€¼é˜²æ­¢é™¤é›¶
                        if (typeof val === 'number' && stats && stats.sd > 0.00001) {
                            // Tåˆ†å…¬å¼ï¼š50 + 10 * Z
                            const z = (val - stats.avg) / stats.sd;
                            let t = 50 + 10 * z;
                            
                            // è¾¹ç•Œä¿æŠ¤ï¼šé™åˆ¶ T åˆ†åœ¨ 0-100 ä¹‹é—´ï¼Œé˜²æ­¢æç«¯ç¦»ç¾¤å€¼ç ´åæ€»åˆ†
                            t = Math.max(0, Math.min(100, t));
                            
                            // A. è®°å½•å•ç§‘ T åˆ† (æ‰€æœ‰ç§‘ç›®éƒ½è®°å½•ï¼Œæ–¹ä¾¿æŸ¥çœ‹å•ç§‘å¼ºå¼±)
                            stu.tScores[sub] = parseFloat(t.toFixed(1));

                            // B. è®¡ç®—æ ‡å‡†åˆ†æ€»å’Œ (æ ¹æ®å¹´çº§æ¨¡å¼ç­›é€‰)
                            if (isGrade9Mode) {
                                // â˜… 9å¹´çº§æ¨¡å¼ï¼šåªç´¯åŠ  è¯­æ•°è‹±ç‰©åŒ–
                                if (grade9CoreSubjects.includes(sub)) {
                                    stu.totalTScore += t;
                                }
                            } else {
                                // â˜… 6-8å¹´çº§æ¨¡å¼ï¼šç´¯åŠ æ‰€æœ‰ç§‘ç›®
                                stu.totalTScore += t;
                            }
                        } else {
                            stu.tScores[sub] = 0; 
                        }
                    });
                    
                    stu.totalTScore = parseFloat(stu.totalTScore.toFixed(1));
                });

                // --- C. è®¡ç®—æ’å (åŸ calculateStudentRanks éƒ¨åˆ†) ---
                const calcRank = (list, keyGetter, rankSetter) => {
                    list.sort((a, b) => keyGetter(b) - keyGetter(a));
                    list.forEach((item, i) => {
                        let rank = i + 1;
                        if (i > 0 && Math.abs(keyGetter(item) - keyGetter(list[i-1])) < 0.0001) {
                            rank = list[i-1]._tempRank;
                        }
                        item._tempRank = rank;
                        rankSetter(item, rank);
                    });
                };

                // å…¨é•‡æ’å
                SUBJECTS.forEach(sub => {
                    const validStus = RAW_DATA.filter(s => s.scores[sub] !== undefined);
                    calcRank(validStus, s => s.scores[sub], (s, r) => { if(!s.ranks) s.ranks={}; if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].township = r; });
                });
                calcRank(RAW_DATA, s => s.total, (s, r) => { if(!s.ranks) s.ranks={}; if(!s.ranks.total) s.ranks.total={}; s.ranks.total.township = r; });

                // æ ¡å†…æ’å
                Object.values(schoolMap).forEach(sch => {
                    calcRank(sch.students, s => s.total, (s, r) => s.ranks.total.school = r);
                    SUBJECTS.forEach(sub => {
                        const subStus = sch.students.filter(s => s.scores[sub] !== undefined);
                        calcRank(subStus, s => s.scores[sub], (s, r) => s.ranks[sub].school = r);
                    });
                });

               // --- D. å­¦æ ¡ç»¼åˆæ’å (åŸ calculateRankings) ---
                const doSchoolRank = (sub, key) => {
                    const list = Object.values(schoolMap).filter(s => s.metrics[sub]);
                    list.sort((a,b) => b.metrics[sub][key] - a.metrics[sub][key]);
                    list.forEach((s, i) => {
                        if(!s.rankings) s.rankings = {}; if(!s.rankings[sub]) s.rankings[sub] = {};
                        if(i>0 && Math.abs(s.metrics[sub][key] - list[i-1].metrics[sub][key]) < 0.0001) s.rankings[sub][key] = list[i-1].rankings[sub][key]; 
                        else s.rankings[sub][key] = i + 1;
                    });
                };
                [...SUBJECTS, 'total'].forEach(sub => { doSchoolRank(sub, 'avg'); doSchoolRank(sub, 'excRate'); doSchoolRank(sub, 'passRate'); });
                
                // è®¡ç®—ç»¼åˆå¾—åˆ†çš„æœ€å¤§å€¼åŸºå‡†
                let max = { avg:0, exc:0, pass:0 };
                Object.values(schoolMap).forEach(s => { if(s.metrics.total) { max.avg = Math.max(max.avg, s.metrics.total.avg); max.exc = Math.max(max.exc, s.metrics.total.excRate); max.pass = Math.max(max.pass, s.metrics.total.passRate); } });

                // === ğŸ”¥ 1. æ–°å¢ï¼š9å¹´çº§é«˜åˆ†æ®µç»Ÿè®¡ (>=490åˆ†) ===
                let maxHighRatio = 0;
                // åˆ¤æ–­æ˜¯å¦ä¸º9å¹´çº§æ¨¡å¼
                const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
                
                if (isGrade9) {
                    Object.values(schoolMap).forEach(s => {
                        // è®¡ç®—é«˜åˆ†äººæ•° (æ€»åˆ† >= 490)
                        const highCount = s.students.filter(stu => stu.total >= 490).length;
                        const totalCount = s.metrics.total ? s.metrics.total.count : 1;
                        const ratio = totalCount > 0 ? (highCount / totalCount) : 0;
                        
                        s.highScoreStats = {
                            count: highCount,
                            ratio: ratio,
                            score: 0 // ç¨åè®¡ç®—
                        };
                        
                        if (ratio > maxHighRatio) maxHighRatio = ratio;
                    });
                }

                // === ğŸ”¥ 2. è®¡ç®—å„é¡¹èµ‹åˆ† (å«9å¹´çº§ç‰¹æ®Šæƒé‡) ===
                Object.values(schoolMap).forEach(s => {
                    if(s.metrics.total) {
                        const m = s.metrics.total;
                        // å®šä¹‰é»˜è®¤æƒé‡ (6-8å¹´çº§)
                        let wAvg = 60, wExc = 70, wPass = 70;
                        
                        // ğŸŸ¢ å¦‚æœæ˜¯ 9å¹´çº§æ¨¡å¼ï¼Œä¿®æ”¹æƒé‡ (å‡åˆ†40 + ä¼˜ç§€80 + åŠæ ¼40)
                        if (isGrade9) {
                            wAvg = 40; 
                            wExc = 80; 
                            wPass = 40; 
                        }

                        // åˆ†åˆ«è®¡ç®—ä¸‰é¡¹èµ‹åˆ†
                        const valAvg = (max.avg ? m.avg/max.avg * wAvg : 0);
                        const valExc = (max.exc ? m.excRate/max.exc * wExc : 0);
                        const valPass = (max.pass ? m.passRate/max.pass * wPass : 0);
                        
                        // ä¿å­˜åˆ°å¯¹è±¡ä¸­ä¾›å‰ç«¯æ˜¾ç¤º
                        m.ratedAvg = valAvg;
                        m.ratedExc = valExc;
                        m.ratedPass = valPass;
                        
                        // è®¡ç®—ä¸¤ç‡ä¸€åˆ†åŸºå‡†æ€»åˆ†
                        s.score2Rate = valAvg + valExc + valPass;

                        // === ğŸ”¥ 3. å¦‚æœæ˜¯9å¹´çº§ï¼Œè®¡ç®—é«˜åˆ†èµ‹åˆ† ===
                        if (isGrade9 && s.highScoreStats) {
                            // èµ‹åˆ†å…¬å¼ï¼š(æœ¬æ ¡æ¯”ä¾‹ / æœ€é«˜æ¯”ä¾‹) * 70
                            const highScore = maxHighRatio > 0 ? (s.highScoreStats.ratio / maxHighRatio * 70) : 0;
                            s.highScoreStats.score = highScore;
                            
                            // âš ï¸ æ³¨æ„ï¼šç›®å‰é«˜åˆ†èµ‹åˆ†ä»…åšå±•ç¤ºï¼Œæš‚æœªå åŠ åˆ° score2Rate (æ€»æ’ååˆ†) ä¸­ã€‚
                            // å¦‚æœéœ€è¦å åŠ è¿›æ€»æ’åï¼Œè¯·å–æ¶ˆä¸‹ä¸€è¡Œçš„æ³¨é‡Šï¼š
                            // s.score2Rate += highScore; 
                        }

                    } else { 
                        s.score2Rate = 0; 
                        // é˜²æ­¢ç©ºå¯¹è±¡æŠ¥é”™
                        if(isGrade9) s.highScoreStats = { count:0, ratio:0, score:0 };
                    }
                });

                // æ’åº (æŒ‰ä¸¤ç‡ä¸€åˆ†æ€»åˆ†é™åº)
                // ä¿®å¤ï¼šç¡®ä¿ list åŒ…å«æ‰€æœ‰å­¦æ ¡ï¼Œä¸è¿›è¡Œä»»ä½• slice æˆªæ–­
                const list = Object.values(schoolMap).sort((a,b) => {
                    const scoreA = a.score2Rate || 0;
                    const scoreB = b.score2Rate || 0;
                    return scoreB - scoreA; 
                });
                
                // é‡æ–°èµ‹äºˆæ’åç´¢å¼•
                list.forEach((s, i) => {
                    s.rank2Rate = i + 1;
                });
                
                // å1/3æ’åº
                let maxBAvg = 0; 
                list.forEach(s => maxBAvg = Math.max(maxBAvg, s.bottom3.avg || 0));
                
                list.forEach(s => {
                    s.scoreBottom = maxBAvg ? (s.bottom3.avg / maxBAvg * 40) : 0;
                });
                
                // æŒ‰å1/3å¾—åˆ†æ’åº
                list.sort((a,b) => (b.scoreBottom || 0) - (a.scoreBottom || 0))
                    .forEach((s,i) => s.rankBottom = i + 1);

                // è¿”å›ç»“æœï¼šæˆ‘ä»¬è¦æŠŠ RAW_DATA (å«ranks) å’Œ SCHOOLS (å«metrics/rankings) å‘å›å»
                const SCHOOLS_RESULT = {};
                Object.keys(schoolMap).forEach(k => {
                    const { students, ...rest } = schoolMap[k];
                    SCHOOLS_RESULT[k] = rest;
                });

                self.postMessage({ status: 'ok', RAW_DATA, SCHOOLS: SCHOOLS_RESULT });

            } catch(err) {
                self.postMessage({ status: 'error', msg: err.message });
            }
        }
    };`;

    // 2. Worker ç®¡ç†å™¨
    const WorkerAPI = {
        worker: null,
        init() {
            if (this.worker) return;
            const blob = new Blob([WORKER_SOURCE], { type: 'application/javascript' });
            this.worker = new Worker(URL.createObjectURL(blob));
        },
        run(data) {
            this.init();
            return new Promise((resolve, reject) => {
                this.worker.onmessage = (e) => {
                    if (e.data.status === 'ok') resolve(e.data);
                    else reject(e.data.msg);
                };
                this.worker.onerror = (e) => reject(e.message);
                
                // ä¸ºäº†ä¼ è¾“æ•ˆç‡ï¼Œå‰¥ç¦» SCHOOLS ä¸­çš„ students å¼•ç”¨
                const schoolsLite = {};
                Object.keys(data.SCHOOLS).forEach(k => {
                    const { students, ...rest } = data.SCHOOLS[k];
                    schoolsLite[k] = rest;
                });

                this.worker.postMessage({ 
                    cmd: 'PROCESS_ALL', 
                    data: { ...data, SCHOOLS_LITE: schoolsLite } 
                });
            });
        }
    };

    // ã€é­”æ³•ã€‘åŠ«æŒåŸç”Ÿ alertï¼Œä½ æ—§ä»£ç é‡Œçš„ alert éƒ½ä¼šè‡ªåŠ¨å˜æ¼‚äº®
    // å‡çº§ç‰ˆï¼šä½¿ç”¨ SweetAlert2 æ›¿ä»£åŸç”Ÿå¼¹çª—
    window.alert = function(msg, icon = 'info') {
        if(typeof Swal !== 'undefined') {
            Swal.fire({
                text: msg,
                icon: (msg.includes('æˆåŠŸ') || msg.includes('âœ…')) ? 'success' : ((msg.includes('å¤±è´¥') || msg.includes('é”™è¯¯')) ? 'error' : 'info'),
                confirmButtonColor: '#4f46e5',
                timer: 2000,
                timerProgressBar: true
            });
        } else {
            // é™çº§å¤„ç†
            UI.toast(msg);
        }
    };

    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ âœ‹ ğŸ”´ [ä¿®å¤é‡ç‚¹å¼€å§‹]ï¼šè°ƒæ•´ä»£ç é¡ºåºï¼Œé˜²æ­¢é€’å½’æ­»å¾ªç¯ ğŸ”´ âœ‹ ğŸ‘‡ğŸ‘‡ğŸ‘‡

    // ğŸŸ¢ [ä¿®æ­£æ­¥éª¤ 1]ï¼šå¿…é¡»åœ¨é‡å†™ä¹‹å‰ï¼Œå…ˆå¤‡ä»½æµè§ˆå™¨åŸç”Ÿçš„ confirm å‡½æ•°ï¼
    // ä¹‹å‰ä»£ç æŠŠè¿™è¡Œæ”¾åœ¨äº†åé¢ï¼Œå¯¼è‡´å¤‡ä»½çš„æ˜¯â€œæ–°å‡½æ•°è‡ªå·±â€ï¼Œä»è€Œå¼•å‘æ­»å¾ªç¯ã€‚
    if(!window.originalConfirm) window.originalConfirm = window.confirm;

    // ğŸŸ¢ [ä¿®æ­£æ­¥éª¤ 2]ï¼šç„¶åå†é‡å†™ window.confirm
    // (è¿™æ˜¯ä¸ºäº†è®© window.confirm = async function å˜æˆå¼‚æ­¥ï¼Œè™½ç„¶è¿™é‡Œæš‚æ—¶è¿˜æ˜¯åŒæ­¥è°ƒç”¨)
    window.confirm = function(msg) {
        // æ³¨æ„ï¼šåŸç”Ÿçš„ confirm æ˜¯åŒæ­¥é˜»å¡çš„ï¼ŒSweetAlert2 æ˜¯å¼‚æ­¥ Promiseã€‚
        // è¿™é‡Œåªæ˜¯ä¸ºäº†è¦†ç›–é»˜è®¤è¡Œä¸ºï¼Œå®é™…ä»£ç ä¸­éœ€è¦æŠŠ if(confirm(...)) æ”¹ä¸º await æ¨¡å¼
        // ä¸ºäº†å…¼å®¹æ—§ä»£ç ï¼Œè¿™é‡Œæš‚æ—¶ä¿ç•™åŸç”Ÿ confirm ä½œä¸ºåŒæ­¥é˜»å¡ï¼Œ
        // ä½†å»ºè®®åœ¨å…³é”®æ“ä½œï¼ˆå¦‚åˆ é™¤ï¼‰ä¸­æ˜¾å¼è°ƒç”¨ Swal.fire
        
        // è¿™é‡Œçš„ window.originalConfirm ç°åœ¨æŒ‡å‘çš„æ˜¯çœŸæ­£çš„åŸç”Ÿå‡½æ•°ï¼Œä¸ä¼šæ­»å¾ªç¯äº†
        return window.originalConfirm ? window.originalConfirm(msg) : true; 
    };

    // å¤‡ä»½åŸç”Ÿ confirm ä»¥é˜²ä¸‡ä¸€ (è¿™æ®µæ—§æœ‰çš„å†—ä½™ä»£ç å¯ä»¥ä¿ç•™ï¼Œä¹Ÿå¯ä»¥åˆ æ‰ï¼Œä¸Šé¢çš„æ­¥éª¤1å·²ç»å¤„ç†äº†)
    if(!window.originalConfirm) window.originalConfirm = window.confirm;

    // ğŸ‘†ğŸ‘†ğŸ‘† âœ‹ ğŸŸ¢ [ä¿®å¤é‡ç‚¹ç»“æŸ] ğŸŸ¢ âœ‹ ğŸ‘†ğŸ‘†ğŸ‘†

// ğŸ›¡ï¸ [å‡çº§ç‰ˆ] ç³»ç»Ÿæ“ä½œæ—¥å¿—è®°å½•å™¨ (æ”¯æŒå›æ”¶ç«™)
const Logger = {
    isHistoryMode: false,

    // 1. å†™å…¥æ—¥å¿— (ä¿æŒä¸å˜)
    log: async function(action, details) {
        if (!sbClient) return;
        let operator = "æœªçŸ¥/ç³»ç»Ÿ";
        try {
            const userStr = sessionStorage.getItem('CURRENT_USER');
            if (userStr) {
                const user = JSON.parse(userStr);
                operator = `${user.name} (${user.role})`;
            }
        } catch(e) {}

        try {
            await sbClient.from('system_logs').insert([{
                operator: operator,
                action: action,
                details: details,
                status: 'normal' // é»˜è®¤çŠ¶æ€
            }]);
            console.log(`[Log] ${action}: ${details}`);
        } catch (e) {
            console.error("å†™æ—¥å¿—å¤±è´¥:", e);
        }
    },

    // 2. æ‰“å¼€æŸ¥çœ‹é¢æ¿ (UIå‡çº§)
    view: function() {
        this.isHistoryMode = false;
        this.updateUIState();
        document.getElementById('admin-log-modal').style.display = 'flex';
        this.loadLogs();
    },

    // 3. åˆ‡æ¢è§†å›¾
    toggleHistoryView: function() {
        this.isHistoryMode = !this.isHistoryMode;
        this.updateUIState();
        this.loadLogs();
    },

    // 4. æ›´æ–°UIçŠ¶æ€
    updateUIState: function() {
        const titleEl = document.getElementById('log-modal-title');
        const btnHistory = document.getElementById('btn-log-history');
        const normalActions = document.getElementById('log-normal-actions');
        const historyActions = document.getElementById('log-history-actions');
        
        // é‡ç½®å…¨é€‰
        if(document.getElementById('log-check-all')) document.getElementById('log-check-all').checked = false;
        if(document.getElementById('log-history-check-all')) document.getElementById('log-history-check-all').checked = false;

        if (this.isHistoryMode) {
            titleEl.innerHTML = '<i class="ti ti-trash"></i> æ—¥å¿—å›æ”¶ç«™';
            titleEl.style.color = '#666';
            btnHistory.innerHTML = '<i class="ti ti-arrow-back-up"></i> è¿”å›æ—¥å¿—åˆ—è¡¨';
            btnHistory.className = 'btn btn-sm btn-primary';
            normalActions.style.display = 'none';
            historyActions.style.display = 'flex';
        } else {
            titleEl.innerHTML = '<i class="ti ti-history"></i> ç³»ç»Ÿæ“ä½œæ—¥å¿—';
            titleEl.style.color = '#333';
            btnHistory.innerHTML = '<i class="ti ti-recycle"></i> æ—¥å¿—å›æ”¶ç«™';
            btnHistory.className = 'btn btn-sm btn-gray';
            normalActions.style.display = 'flex';
            historyActions.style.display = 'none';
        }
    },

    // 5. åŠ è½½æ—¥å¿—æ•°æ®
    loadLogs: async function() {
        const listEl = document.getElementById('admin-log-list');
        listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">â³ åŠ è½½ä¸­...</div>';

        let query = sbClient
            .from('system_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(100);

        // çŠ¶æ€è¿‡æ»¤
        if (this.isHistoryMode) {
            query = query.eq('status', 'deleted');
        } else {
            // å…¼å®¹æ—§æ•°æ®ï¼šstatus ä¸ç­‰äº deletedï¼Œæˆ–è€… status ä¸º null
            query = query.or('status.eq.normal,status.is.null'); 
        }

        const { data, error } = await query;

        if (error) return listEl.innerHTML = `<div style="color:red; padding:20px;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        if (!data || data.length === 0) return listEl.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">ğŸ“­ æš‚æ— è®°å½•</div>`;

        // æ¸²æŸ“è¡¨æ ¼
        let html = `
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead style="position:sticky; top:0; background:#f3f4f6; z-index:1;">
                    <tr style="border-bottom:1px solid #ddd; color:#64748b;">
                        <th style="width:40px; padding:10px; text-align:center;">é€‰</th>
                        <th style="width:140px; padding:10px; text-align:left;">æ—¶é—´</th>
                        <th style="width:120px; padding:10px; text-align:left;">æ“ä½œäºº</th>
                        <th style="width:100px; padding:10px; text-align:left;">åŠ¨ä½œ</th>
                        <th style="padding:10px; text-align:left;">è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach(log => {
            const time = new Date(log.created_at).toLocaleString();
            let color = "#333";
            if(log.action.includes("åˆ é™¤")) color = "#dc2626";
            if(log.action.includes("ä¿®æ”¹")) color = "#d97706";
            if(log.action.includes("åŒæ­¥")) color = "#2563eb";

            html += `
                <tr style="border-bottom:1px solid #eee; background:white;">
                    <td style="text-align:center;">
                        <input type="checkbox" class="log-item-check" value="${log.id}">
                    </td>
                    <td style="padding:8px 10px; color:#666;">${time}</td>
                    <td style="padding:8px 10px; font-weight:bold;">${log.operator || '-'}</td>
                    <td style="padding:8px 10px; color:${color}; font-weight:bold;">${log.action}</td>
                    <td style="padding:8px 10px; color:#444;">${log.details}</td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        listEl.innerHTML = html;
    },

    // --- æ‰¹é‡æ“ä½œé€»è¾‘ ---

    toggleSelectAll: function(source) {
        document.querySelectorAll('.log-item-check').forEach(cb => cb.checked = source.checked);
    },

    getCheckedIds: function() {
        return Array.from(document.querySelectorAll('.log-item-check:checked')).map(cb => cb.value);
    },

    // æ‰¹é‡è½¯åˆ é™¤
    batchSoftDelete: async function() {
        const ids = this.getCheckedIds();
        if (ids.length === 0) return UI.toast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹", "error");
        
        UI.loading(true, "æ­£åœ¨åˆ é™¤...");
        const { error } = await sbClient.from('system_logs').update({ status: 'deleted' }).in('id', ids);
        UI.loading(false);

        if (error) alert("åˆ é™¤å¤±è´¥: " + error.message);
        else {
            UI.toast(`å·²åˆ é™¤ ${ids.length} æ¡æ—¥å¿—`, "success");
            this.loadLogs();
            if(document.getElementById('log-check-all')) document.getElementById('log-check-all').checked = false;
        }
    },

    // æ‰¹é‡è¿˜åŸ
    batchRestore: async function() {
        const ids = this.getCheckedIds();
        if (ids.length === 0) return UI.toast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹", "error");

        UI.loading(true, "æ­£åœ¨è¿˜åŸ...");
        const { error } = await sbClient.from('system_logs').update({ status: 'normal' }).in('id', ids);
        UI.loading(false);

        if (error) alert("è¿˜åŸå¤±è´¥: " + error.message);
        else {
            UI.toast(`å·²è¿˜åŸ ${ids.length} æ¡æ—¥å¿—`, "success");
            this.loadLogs();
            if(document.getElementById('log-history-check-all')) document.getElementById('log-history-check-all').checked = false;
        }
    },

    // æ‰¹é‡å½»åº•åˆ é™¤
    batchHardDelete: async function() {
        const ids = this.getCheckedIds();
        if (ids.length === 0) return UI.toast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹", "error");
        if (!confirm(`âš ï¸ ç¡®å®šè¦ã€å½»åº•é”€æ¯ã€‘è¿™ ${ids.length} æ¡æ—¥å¿—å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

        UI.loading(true, "æ­£åœ¨ç²‰ç¢...");
        const { error, count } = await sbClient.from('system_logs').delete({ count: 'exact' }).in('id', ids);
        UI.loading(false);

        if (error) {
            alert("åˆ é™¤å¤±è´¥: " + error.message);
        } else if (count === 0) {
            alert("âš ï¸ åˆ é™¤å¤±è´¥ï¼šæƒé™ä¸è¶³ï¼è¯·åœ¨ Supabase å¼€å¯ system_logs çš„ DELETE æƒé™ã€‚");
        } else {
            UI.toast(`å½»åº•åˆ é™¤äº† ${count} æ¡æ—¥å¿—`, "success");
            this.loadLogs();
            if(document.getElementById('log-history-check-all')) document.getElementById('log-history-check-all').checked = false;
        }
    }
};

// ğŸ” [æ–°å¢] å¤šè§’è‰²è´¦å·ç®¡ç†æ§åˆ¶å™¨ (ç®¡ç†å‘˜/ä¸»ä»»/ç­ä¸»ä»»)
const AccountManager = {
    // 1. æ‰“å¼€ç®¡ç†é¢æ¿
    open: function() {
        const user = Auth.currentUser;
        if (!user) return alert("è¯·å…ˆç™»å½•");

        // æƒé™æ£€æŸ¥åˆ—è¡¨
        const allowedRoles = ['admin', 'director', 'grade_director', 'class_teacher'];
        if (!allowedRoles.includes(user.role)) {
            return alert("â›” æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜ã€ä¸»ä»»æˆ–ç­ä¸»ä»»å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚");
        }

        // æ ¹æ®è§’è‰²è®¾ç½®æç¤ºæ–‡æ¡ˆ
        const hintEl = document.getElementById('acc-permission-hint');
        let hintText = "";
        
        if (user.role === 'admin') hintText = "ğŸ‘‘ ç®¡ç†å‘˜æƒé™ï¼šå¯ç®¡ç†ç³»ç»Ÿä¸­ã€æ‰€æœ‰ã€‘è´¦å·ã€‚";
        else if (user.role === 'director') hintText = "ğŸ“ æ•™åŠ¡ä¸»ä»»æƒé™ï¼šå¯ç®¡ç†æœ¬æ ¡ã€æ‰€æœ‰ã€‘è´¦å·ã€‚";
        else if (user.role === 'grade_director') hintText = `ğŸš€ çº§éƒ¨ä¸»ä»»æƒé™ï¼šå¯ç®¡ç† ${user.class}å¹´çº§ çš„ã€å®¶é•¿ã€‘åŠæœ¬æ ¡ã€æ•™å¸ˆã€‘ã€‚`;
        else if (user.role === 'class_teacher') hintText = `ğŸ“‹ ç­ä¸»ä»»æƒé™ï¼šä»…å¯ç®¡ç† ${user.class}ç­ çš„ã€å®¶é•¿ã€‘è´¦å·ã€‚`;

        hintEl.innerHTML = `<i class="ti ti-shield-lock"></i> ${hintText}`;
        
        // é‡ç½®ç•Œé¢
        document.getElementById('acc-result-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">è¯·è¾“å…¥å…³é”®å­—æœç´¢</td></tr>';
        document.getElementById('acc-search-input').value = "";
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('account-manager-modal').style.display = 'flex';
        document.getElementById('acc-search-input').focus();
    },

    // 2. æ‰§è¡Œæœç´¢ (æ ¸å¿ƒæƒé™é€»è¾‘)
    search: async function() {
        const keyword = document.getElementById('acc-search-input').value.trim();
        if (!keyword) return UI.toast("è¯·è¾“å…¥æœç´¢å…³é”®å­—", "warning");

        const user = Auth.currentUser;
        if (!user) return;

        UI.loading(true, "æ­£åœ¨æœç´¢è´¦å·...");

        // --- A. æ„å»ºåŸºç¡€æŸ¥è¯¢ ---
        let query = sbClient
            .from('system_users')
            .select('*')
            .ilike('username', `%${keyword}%`) // æ¨¡ç³ŠåŒ¹é…ç”¨æˆ·å
            .limit(50); // é™åˆ¶è¿”å›æ¡æ•°ï¼Œé˜²æ­¢æ•°æ®é‡è¿‡å¤§

        // --- B. æ•°æ®åº“çº§åˆæ­¥è¿‡æ»¤ (Role-Based Filter) ---
        
        // 1. ç®¡ç†å‘˜ (admin): æ— é™åˆ¶ï¼ŒæŸ¥æ‰€æœ‰
        if (user.role === 'admin') {
            // No filter
        }
        
        // 2. æ•™åŠ¡ä¸»ä»» (director): é™åˆ¶æœ¬æ ¡
        else if (user.role === 'director') {
            query = query.eq('school', user.school);
        }

        // 3. çº§éƒ¨ä¸»ä»» (grade_director): é™åˆ¶æœ¬æ ¡ (åç»­åœ¨å†…å­˜ä¸­ç»†åˆ†)
        else if (user.role === 'grade_director') {
            query = query.eq('school', user.school);
        }

        // 4. ç­ä¸»ä»» (class_teacher): é™åˆ¶æœ¬æ ¡ + æœ¬ç­ + ä»…å®¶é•¿
        else if (user.role === 'class_teacher') {
            query = query
                .eq('school', user.school)
                .eq('class_name', user.class) // user.class å¦‚ "701"
                .eq('role', 'parent'); // åªèƒ½ç®¡å®¶é•¿
        }

        // æ‰§è¡ŒæŸ¥è¯¢
        const { data, error } = await query;
        
        UI.loading(false);

        if (error) {
            return alert("æŸ¥è¯¢å¤±è´¥: " + error.message);
        }

        // --- C. å†…å­˜çº§äºŒæ¬¡è¿‡æ»¤ (å¤„ç†å¤æ‚é€»è¾‘) ---
        let filteredData = data;

        // çº§éƒ¨ä¸»ä»»ç‰¹æ®Šé€»è¾‘ï¼šå¯ä»¥ç®¡ã€æ•™å¸ˆã€‘ OR ã€æœ¬å¹´çº§å®¶é•¿ã€‘
        if (user.role === 'grade_director') {
            const gradePrefix = String(user.class); // å¦‚ "7"
            filteredData = data.filter(u => {
                // å…è®¸ç®¡ç†æœ¬æ ¡æ‰€æœ‰æ•™å¸ˆ
                if (u.role === 'teacher') return true; 
                // å…è®¸ç®¡ç†æœ¬å¹´çº§å®¶é•¿ (ç­çº§ä»¥ "7" å¼€å¤´)
                if (u.role === 'parent' && String(u.class_name).startsWith(gradePrefix)) return true; 
                // å…¶ä»–æƒ…å†µ (å¦‚åˆ«çš„å¹´çº§å®¶é•¿ã€ç®¡ç†å‘˜è´¦å·) è¿‡æ»¤æ‰
                return false;
            });
        }

        this.renderTable(filteredData);
    },

    // 3. æ¸²æŸ“ç»“æœè¡¨æ ¼ (å·²æ·»åŠ â€œä¿®æ”¹ä¿¡æ¯â€æŒ‰é’®)
        renderTable: function(list) {
            const tbody = document.querySelector('#acc-result-table tbody');
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">æœªæ‰¾åˆ°åŒ¹é…çš„è´¦å· (æˆ–æ— æƒç®¡ç†)</td></tr>';
                return;
            }
    
            const roleMap = { 'admin':'ğŸ‘‘ ç®¡ç†å‘˜', 'director':'ğŸ“ æ•™åŠ¡ä¸»ä»»', 'grade_director':'ğŸš€ çº§éƒ¨ä¸»ä»»', 'class_teacher':'ğŸ“‹ ç­ä¸»ä»»', 'teacher':'ğŸ‘¨â€ğŸ« æ•™å¸ˆ', 'parent':'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿' };
            const myRole = Auth.currentUser ? Auth.currentUser.role : 'guest';
    
            let html = '';
            list.forEach(u => {
                const roleName = roleMap[u.role] || u.role;
                
                let canEdit = false;
    
                // æƒé™åˆ¤å®šé€»è¾‘ (ä¿æŒåŸæœ‰ä¸¥è°¨æ€§)
                if (myRole === 'admin') {
                    canEdit = (u.role !== 'admin' || u.username === Auth.currentUser.name); // å¯ä»¥æ”¹è‡ªå·±ï¼Œä¸èƒ½æ”¹åˆ«çš„admin
                } else if (myRole === 'director') {
                    canEdit = (u.role !== 'admin' && u.role !== 'director');
                } else {
                    canEdit = (u.role === 'parent' || u.role === 'teacher');
                }
                
                // æŒ‰é’®æ ·å¼
                const btnClass = canEdit ? 'btn-primary' : 'btn-gray';
                const cursorStyle = canEdit ? '' : 'cursor:not-allowed; opacity:0.6;';
                const disableAttr = canEdit ? '' : 'disabled';

                // è½¬ä¹‰å¤„ç†ï¼Œé˜²æ­¢å•å¼•å·ç ´å HTML ç»“æ„
                const safeUser = u.username.replace(/'/g, "\\'");
                const safeRole = u.role;
                const safeClass = (u.class_name || '').replace(/'/g, "\\'");
    
                html += `
                    <tr>
                        <td style="font-weight:bold;">${u.username}</td>
                        <td><span class="badge" style="background:#e0f2fe; color:#0369a1;">${roleName}</span></td>
                        <td>${u.class_name || '-'}</td>
                        <td style="font-family:monospace; color:#666;">${u.password}</td>
                        <td>
                            <!-- ğŸŸ¢ æ–°å¢ï¼šä¿®æ”¹ä¿¡æ¯æŒ‰é’® -->
                            <button class="btn btn-sm btn-purple" ${disableAttr} style="padding:2px 6px; font-size:12px; margin-right:5px; ${cursorStyle}" 
                                    onclick="AccountManager.editAttributes('${safeUser}', '${safeRole}', '${safeClass}')">
                                <i class="ti ti-edit"></i> ä¿®æ”¹
                            </button>
                            <!-- åŸæœ‰ï¼šæ”¹å¯†æŒ‰é’® -->
                            <button class="btn btn-sm ${btnClass}" ${disableAttr} style="padding:2px 6px; font-size:12px; ${cursorStyle}" 
                                    onclick="AccountManager.resetPassword('${safeUser}')">
                                <i class="ti ti-key"></i> æ”¹å¯†
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        },


        // 3.5 ç¼–è¾‘ç”¨æˆ·å±æ€§ (è§’è‰² & ç­çº§)
        editAttributes: async function(username, currentRole, currentClass) {
            // æ„å»ºè§’è‰²ä¸‹æ‹‰é€‰é¡¹
            const roleOptions = [
                {val: 'teacher', txt: 'ğŸ‘¨â€ğŸ« ç§‘ä»»æ•™å¸ˆ (é»˜è®¤)'},
                {val: 'class_teacher', txt: 'ğŸ“‹ ç­ä¸»ä»» (éœ€å¡«ç­çº§)'},
                {val: 'grade_director', txt: 'ğŸš€ çº§éƒ¨ä¸»ä»» (éœ€å¡«å¹´çº§)'},
                {val: 'parent', txt: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿/å­¦ç”Ÿ (éœ€å¡«ç­çº§)'},
                {val: 'director', txt: 'ğŸ“ æ•™åŠ¡ä¸»ä»»'},
                {val: 'admin', txt: 'ğŸ‘‘ ç®¡ç†å‘˜'}
            ].map(opt => `<option value="${opt.val}" ${opt.val === currentRole ? 'selected' : ''}>${opt.txt}</option>`).join('');

            // å¼¹å‡º SweetAlert2 è¡¨å•
            const { value: formValues } = await Swal.fire({
                title: `ä¿®æ”¹è´¦å·ä¿¡æ¯ï¼š${username}`,
                html: `
                    <div style="text-align:left; font-size:14px;">
                        <label style="display:block; margin-bottom:5px; font-weight:bold;">è§’è‰²æƒé™</label>
                        <select id="swal-edit-role" class="swal2-input" style="margin:0 0 15px 0; width:100%; font-size:14px;">
                            ${roleOptions}
                        </select>
                        
                        <label style="display:block; margin-bottom:5px; font-weight:bold;">
                            ç­çº§ / èŒƒå›´ <small style="color:#666; font-weight:normal;">(æ•™å¸ˆç•™ç©º, å®¶é•¿å¡«ç­çº§, ä¸»ä»»å¡«å¹´çº§)</small>
                        </label>
                        <input id="swal-edit-class" class="swal2-input" value="${currentClass}" placeholder="ä¾‹å¦‚: 901 æˆ– 9" style="margin:0; width:100%; font-size:14px;">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'ä¿å­˜ä¿®æ”¹',
                cancelButtonText: 'å–æ¶ˆ',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        role: document.getElementById('swal-edit-role').value,
                        class_name: document.getElementById('swal-edit-class').value.trim()
                    }
                }
            });

            if (!formValues) return; // ç”¨æˆ·å–æ¶ˆ

            // ç®€å•æ ¡éªŒ
            if ((formValues.role === 'parent' || formValues.role === 'class_teacher') && !formValues.class_name) {
                return Swal.fire('é”™è¯¯', 'ä¿®æ”¹ä¸ºå®¶é•¿æˆ–ç­ä¸»ä»»æ—¶ï¼Œã€ç­çº§ã€‘ä¸èƒ½ä¸ºç©ºï¼', 'error');
            }

            UI.loading(true, "æ­£åœ¨æ›´æ–°äº‘ç«¯æ•°æ®...");

            // æäº¤åˆ° Supabase
            const { error } = await sbClient
                .from('system_users')
                .update({ 
                    role: formValues.role,
                    class_name: formValues.class_name 
                })
                .eq('username', username);

            UI.loading(false);

            if (error) {
                alert("âŒ æ›´æ–°å¤±è´¥: " + error.message);
            } else {
                UI.toast(`âœ… è´¦å· [${username}] ä¿¡æ¯å·²æ›´æ–°`, "success");
                // åˆ·æ–°åˆ—è¡¨
                this.search(); 
                
                // è®°å½•æ—¥å¿—
                if(window.Logger) Logger.log('ä¿®æ”¹è´¦å·ä¿¡æ¯', `ä¿®æ”¹äº† ${username} çš„è§’è‰²ä¸º ${formValues.role}, èŒƒå›´ä¸º ${formValues.class_name}`);
            }
        },

    // 4. é‡ç½®/ä¿®æ”¹å¯†ç 
    resetPassword: async function(username) {
        const newPass = prompt(`ğŸ” æ­£åœ¨ä¿®æ”¹è´¦å· [${username}] çš„å¯†ç \n\nè¯·è¾“å…¥æ–°å¯†ç  (ç•™ç©ºåˆ™å–æ¶ˆ):`);
        if (newPass === null) return;
        if (!newPass.trim()) return alert("å¯†ç ä¸èƒ½ä¸ºç©º");
        const ok = confirm(`âš ï¸ ç¡®è®¤å°†è´¦å· [${username}] çš„å¯†ç ä¿®æ”¹ä¸ºï¼š\n${newPass}\n\næ­¤æ“ä½œå°†ç«‹å³ç”Ÿæ•ˆã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`);
        if (!ok) return;

        UI.loading(true, "æ­£åœ¨æ›´æ–°å¯†ç ...");

        // è°ƒç”¨ Supabase æ›´æ–°
        const { error } = await sbClient
            .from('system_users')
            .update({ password: newPass.trim() })
            .eq('username', username);

        UI.loading(false);

        if (error) {
            alert("âŒ ä¿®æ”¹å¤±è´¥: " + error.message);
        } else {
            UI.toast(`âœ… è´¦å· [${username}] å¯†ç å·²ä¿®æ”¹ä¸º ${newPass}`, "success");
            
            // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºæ–°å¯†ç 
            this.search();
            
            // è®°å½•åˆ°æ“ä½œæ—¥å¿— (å¦‚æœæœ‰ Logger æ¨¡å—)
            if(window.Logger) Logger.log('ä¿®æ”¹å¯†ç ', `ä¿®æ”¹äº†ç”¨æˆ· ${username} çš„å¯†ç `);
        }
    }
};

// ğŸ“Š [æ–°å¢] æ•°æ®ç»¼åˆç®¡ç†å™¨ (å­¦ç”Ÿ/æ•™å¸ˆ/æ¡£æ¡ˆ/å‚æ•°/ç›®æ ‡)
const DataManager = {
    currentTab: 'student', // student | teacher | archive | params | targets
    pagination: { page: 1, size: 50, total: 0 },
    
    // 1. æ‰“å¼€é¢æ¿
    open: function() {
        const user = Auth.currentUser;
        if (!user) return alert("è¯·å…ˆç™»å½•");
        if (user.role !== 'admin' && user.role !== 'director') {
            return alert("â›” æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜æˆ–æ•™åŠ¡ä¸»ä»»å¯æ“ä½œåº•å±‚æ•°æ®ã€‚");
        }
        
        document.getElementById('data-manager-modal').style.display = 'flex';
        this.switchTab('student');
    },

    // 2. åˆ‡æ¢æ ‡ç­¾é¡µ (ä¿®å¤ç‰ˆï¼šæ”¯æŒæ‰€æœ‰ç®¡ç†æ¨¡å—)
    switchTab: function(tab) {
        this.currentTab = tab;
        this.pagination.page = 1;
        const searchInput = document.getElementById('dm-search-input');
        if(searchInput) searchInput.value = ''; 
        
        // æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
        
        let tabId = 'tab-data-stu';
        if(tab === 'teacher') tabId = 'tab-data-tea';
        if(tab === 'archive') tabId = 'tab-data-arch';
        if(tab === 'params') tabId = 'tab-data-params';
        if(tab === 'targets') tabId = 'tab-data-targets';
        if(tab === 'sql') tabId = 'tab-data-sql';
        if(tab === 'cloud') tabId = 'tab-data-cloud';
        if(tab === 'history') tabId = 'tab-data-history';

        const el = document.getElementById(tabId);
        if(el) el.classList.add('active');
        
        // --- åŒºåŸŸæ˜¾éšæ§åˆ¶ ---
        
        // å­¦ç”Ÿè¡¨
        const stuTable = document.getElementById('dm-student-table');
        if(stuTable) stuTable.style.display = tab === 'student' ? 'table' : 'none';
        
        // æ•™å¸ˆåŒºåŸŸ (æ–°ç‰ˆå®¹å™¨)
        const teaArea = document.getElementById('dm-teacher-area');
        if(teaArea) teaArea.style.display = tab === 'teacher' ? 'block' : 'none';
        
        // éšè—æ—§ç‰ˆç›´æ¥å¼•ç”¨çš„æ•™å¸ˆè¡¨ (é˜²æ­¢å†²çª)
        const oldTeaTable = document.getElementById('dm-teacher-table');
        if(oldTeaTable && !teaArea) oldTeaTable.style.display = tab === 'teacher' ? 'table' : 'none';

        // å…¶ä»–åŒºåŸŸ
        const archArea = document.getElementById('dm-archive-area');
        if(archArea) archArea.style.display = tab === 'archive' ? 'block' : 'none';
        
        const paramArea = document.getElementById('dm-params-area');
        if(paramArea) paramArea.style.display = tab === 'params' ? 'block' : 'none';
        
        const targetArea = document.getElementById('dm-targets-area');
        if(targetArea) targetArea.style.display = tab === 'targets' ? 'block' : 'none';
        
        const sqlArea = document.getElementById('dm-sql-area');
        if(sqlArea) sqlArea.style.display = tab === 'sql' ? 'flex' : 'none';

        const cloudArea = document.getElementById('dm-cloud-area');
        if(cloudArea) cloudArea.style.display = tab === 'cloud' ? 'flex' : 'none';

        const histArea = document.getElementById('dm-history-area');
        if(histArea) histArea.style.display = tab === 'history' ? 'flex' : 'none';
        
        // å¦‚æœåˆ‡åˆ°äº‘ç«¯ç®¡ç†ï¼Œç«‹å³åŠ è½½åˆ—è¡¨
        if(tab === 'cloud') this.renderCloudBackups();
        if(tab === 'sql') this.renderSQLHistory();

        // æœç´¢æ å’Œåˆ†é¡µæ é€»è¾‘ (æ•™å¸ˆé¡µç°åœ¨æœ‰ç‹¬ç«‹ç­›é€‰ï¼Œä¸å†ä½¿ç”¨é¡¶éƒ¨é€šç”¨æœç´¢)
        const showSearch = (tab === 'student'); 
        const searchBar = document.getElementById('dm-search-bar');
        const pageBar = document.getElementById('dm-pagination');
        if(searchBar) searchBar.style.display = showSearch ? 'flex' : 'none';
        if(pageBar) pageBar.style.display = showSearch ? 'flex' : 'none';

        // åˆå§‹åŒ–æ•™å¸ˆé¡µé¢çš„å­¦æ ¡ä¸‹æ‹‰æ¡†
        if (tab === 'teacher') {
            // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–å±Šåˆ«å…ƒæ•°æ®ï¼Œé˜²æ­¢å› æ•°æ®å»¶è¿Ÿå¯¼è‡´çš„æ¸²æŸ“å¤±è´¥
            if (!window.CURRENT_COHORT_META && window.CURRENT_COHORT_ID) {
                try {
                    const storedMeta = localStorage.getItem('CURRENT_COHORT_META');
                    if (storedMeta) window.CURRENT_COHORT_META = JSON.parse(storedMeta);
                    else window.CURRENT_COHORT_META = { id: window.CURRENT_COHORT_ID, year: String(window.CURRENT_COHORT_ID).replace(/\D/g,'') };
                } catch(e) {}
            }

            this.updateTeacherSchoolSelect();
            this.renderTeacherTermSelect();
            
            // ğŸŸ¢ [ä¿®å¤]ï¼šé€‰ä¸­å­¦æœŸå¹¶è‡ªåŠ¨åŒæ­¥äº‘ç«¯æ•°æ®
            setTimeout(() => {
                const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
                if(termId) {
                    const sel = document.getElementById('dm-teacher-term-select');
                    if(sel) sel.value = termId;
                    // switchTeacherTerm å†…éƒ¨å·²ç»åŒ…å«äº‘ç«¯åŒæ­¥é€»è¾‘
                    DataManager.switchTeacherTerm(termId);
                }
            }, 50);
        }

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ [åŒæ­¥ä¿®å¤]ï¼šåˆ‡æ¢åˆ°å‚æ•°é¡µæ—¶ï¼Œå¼ºåˆ¶åˆ·æ–°æ•°æ®æ˜¾ç¤º ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        if (tab === 'params') {
            this.renderParams();
        }

        this.renderCurrentTab();
    },

    // --- æ¨¡å— A: äº‘ç«¯æ•°æ®ç®¡ç† (é‡æ„ç‰ˆ) ---
    renderCloudBackups: async function() {
        if (!sbClient) return;
        const tbody = document.querySelector('#dm-cloud-table tbody');
        const summaryEl = document.getElementById('dm-cloud-summary');
        
        // åˆå§‹åŒ–åŠ è½½çŠ¶æ€
        if(tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">â³ æ­£åœ¨è¯»å–äº‘ç«¯æ•°æ®åº“...</td></tr>';
        if(summaryEl) {
            summaryEl.style.display = 'block';
            summaryEl.innerHTML = 'â³ æ­£åœ¨åˆ†ææ•°æ®...';
        }

        try {
            // 1. è·å–æ•°æ®åˆ—è¡¨ (åªå–å…ƒæ•°æ®ï¼Œä¸å–ä½ å¯ä»¥è®©è½½è·è¿‡å¤§çš„ content)
            const { data, error } = await sbClient
                .from('system_data')
                .select('key, created_at, updated_at, content') // content ç”¨äºè®¡ç®—å¤§å°
                .order('updated_at', { ascending: false });

            if (error) throw error;

            if (!data || data.length === 0) {
                if(tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#64748b;">â˜ï¸ äº‘ç«¯æ•°æ®åº“ä¸ºç©º</td></tr>';
                if(summaryEl) summaryEl.innerHTML = 'ğŸ“Œ æš‚æ— å­˜æ¡£è®°å½•';
                return;
            }

            // 2. ç»Ÿè®¡ä¿¡æ¯
            const totalSize = data.reduce((acc, item) => acc + (item.content ? item.content.length : 0), 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            if(summaryEl) {
                summaryEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>ğŸ“Œ äº‘ç«¯å…± <b>${data.length}</b> ä¸ªå­˜æ¡£ | æ€»å ç”¨: <b>${totalSizeMB} MB</b></span>
                        <span style="font-size:11px; color:#94a3b8;">åªæ˜¾ç¤ºæœ€è¿‘æ›´æ–°çš„è®°å½•</span>
                    </div>
                `;
            }

            // 3. æ¸²æŸ“åˆ—è¡¨
            const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY');
            let rows = '';
            
            data.forEach(item => {
                const isCurrent = (item.key === currentKey);
                const sizeKB = (item.content ? item.content.length / 1024 : 0).toFixed(1);
                const time = new Date(item.updated_at || item.created_at).toLocaleString();
                
                // è§£æKeyç»“æ„ï¼š2022çº§_9å¹´çº§_2025-2026_ä¸Šå­¦æœŸ_æœŸä¸­_å…¨é•‡è”è€ƒ
                // å¦‚æœä¸ç¬¦åˆç»“æ„ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºKey
                let displayName = item.key;
                let tags = '';
                
                const parts = item.key.split('_');
                if (parts.length >= 5) {
                    displayName = `<b>${parts[0]} ${parts[1]}</b><br><span style="color:#64748b; font-size:11px;">${parts[2]} ${parts[3]} ${parts[5]||''}</span>`;
                    tags = `<span class="badge" style="background:${parts[4]==='æœŸæœ«'?'#ef4444':'#3b82f6'}; color:white; padding:2px 6px; border-radius:4px; font-size:10px;">${parts[4]}</span>`;
                }

                rows += `
                    <tr style="${isCurrent ? 'background:#f0fdf4;' : ''}">
                        <td>
                            <div style="display:flex; align-items:center; gap:8px;">
                                ${isCurrent ? '<i class="ti ti-current-location" style="color:#16a34a;" title="å½“å‰é¡¹ç›®"></i>' : ''}
                                <div>${displayName}</div>
                                ${tags}
                            </div>
                        </td>
                        <td style="font-size:12px; color:#64748b;">${time}</td>
                        <td style="font-size:12px;">${sizeKB} KB</td>
                        <td>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-sm btn-primary" onclick="DataManager.loadCloudBackup('${item.key}')" title="è¯»å–æ­¤å­˜æ¡£">
                                    <i class="ti ti-download"></i> è¯»å–
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="DataManager.deleteCloudBackup('${item.key}')" title="æ°¸ä¹…åˆ é™¤">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            if(tbody) tbody.innerHTML = rows;

        } catch (err) {
            console.error(err);
            if(tbody) tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#ef4444;">âŒ åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        }
    },

    // åŠ è½½æŒ‡å®šçš„äº‘ç«¯å­˜æ¡£
    loadCloudBackup: async function(key) {
        if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ‡æ¢åˆ°å­˜æ¡£ [${key}] å—ï¼Ÿ\nå½“å‰æœªä¿å­˜çš„å·¥ä½œå°†ä¼šä¸¢å¤±ã€‚`)) return;
        
        // ä¸´æ—¶ä¿®æ”¹ Current Keyï¼Œç„¶åè°ƒç”¨ CloudManager.load
        localStorage.setItem('CURRENT_PROJECT_KEY', key);
        await CloudManager.load();
        
        // åˆ·æ–°åˆ—è¡¨çŠ¶æ€
        this.renderCloudBackups();
    },

    deleteCloudBackup: async function(key) {
        if (!confirm(`ğŸ§¨ å±é™©æ“ä½œï¼\n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤ [${key}] å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ï¼`)) return;
        
        UI.loading(true, `æ­£åœ¨åˆ é™¤ ${key}...`);
        try {
            const { error } = await sbClient
                .from('system_data')
                .delete()
                .eq('key', key);
            
            if (error) throw error;
            
            UI.toast('âœ… åˆ é™¤æˆåŠŸ', 'success');
            this.renderCloudBackups();
        } catch (e) {
            alert('åˆ é™¤å¤±è´¥: ' + e.message);
        } finally {
            UI.loading(false);
        }
    },



    // --- æ¨¡å— B: å†å²æ•°æ®ä¸Šä¼  (Sheetå=å­¦æ ¡å, ç­çº§+å§“å=Key) ---
    handleHistoryUpload: function(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                
                let parsedHistory = [];
                let calcModeMsg = ""; 
                
                // 1. éå†æ‰€æœ‰ Sheet
                wb.SheetNames.forEach(sheetName => {
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                    if (json.length === 0) return;

                    const sample = json[0];
                    const keyName = Object.keys(sample).find(k => k.includes('å§“å') || k.toLowerCase() === 'name');
                    const keyClass = Object.keys(sample).find(k => k.includes('ç­') || k.toLowerCase().includes('class'));
                    const keyScore = Object.keys(sample).find(k => k.includes('æ€»åˆ†') || k.includes('å¾—åˆ†') || k.includes('Total'));
                    
                    const subjectKeywords = ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦','æ”¿æ²»','å†å²','åœ°ç†','ç”Ÿç‰©','ç§‘å­¦','é“æ³•'];
                    const subjectColMap = {}; 
                    
                    Object.keys(sample).forEach(header => {
                        const cleanHeader = header.trim();
                        if (cleanHeader.includes('æ’') || cleanHeader.includes('èµ‹')) return;
                        const matchedSub = subjectKeywords.find(k => cleanHeader.includes(k));
                        if (matchedSub) {
                            subjectColMap[matchedSub] = header; 
                            if (!SUBJECTS.includes(matchedSub)) SUBJECTS.push(matchedSub);
                        }
                    });
                    SUBJECTS.sort(sortSubjects);

                    // ç¡®å®šè®¡ç®—ç­–ç•¥
                    const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
                    let targetSubjects = isGrade9 ? ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦'] : Object.keys(subjectColMap);
                    if (isGrade9) calcModeMsg = "9å¹´çº§æ¨¡å¼"; else calcModeMsg = "å…¨ç§‘æ¨¡å¼";

                    let schoolStudents = [];

                    json.forEach((row, idx) => {
                        let name = keyName ? row[keyName] : "";
                        if (!name || String(name).trim() === '') name = `${sheetName}_è€ƒç”Ÿ_${idx + 1}`;
                        let className = (keyClass && row[keyClass]) ? normalizeClass(row[keyClass]) : "é»˜è®¤ç­çº§";
                        
                        let totalScore = 0;
                        let scoresObj = {}; 

                        // è§£æå•ç§‘
                        Object.keys(subjectColMap).forEach(sub => {
                            const colName = subjectColMap[sub];
                            if (row[colName] !== undefined) {
                                const val = parseFloat(row[colName]);
                                if (!isNaN(val)) scoresObj[sub] = val;
                            }
                        });

                        // è®¡ç®—æ€»åˆ†
                        if (keyScore && row[keyScore] !== undefined) {
                            totalScore = parseFloat(row[keyScore]);
                        } else {
                            let sum = 0; let hasValidSub = false;
                            targetSubjects.forEach(sub => {
                                if (scoresObj[sub] !== undefined) { sum += scoresObj[sub]; hasValidSub = true; }
                            });
                            if (hasValidSub) totalScore = parseFloat(sum.toFixed(2));
                        }

                        schoolStudents.push({
                            name: String(name).trim(),
                            class: className,
                            school: sheetName,
                            total: totalScore || 0,
                            scores: scoresObj,
                            ranks: {} // åˆå§‹åŒ–æ’åå¯¹è±¡
                        });
                    });
                    parsedHistory = parsedHistory.concat(schoolStudents);
                });

                if (parsedHistory.length === 0) throw new Error("æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®");

                // ==========================================
                // ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šè®¡ç®—å†å²æ•°æ®çš„ã€æ€»åˆ†ã€‘åŠã€æ‰€æœ‰å•ç§‘ã€‘æ’å ğŸ”¥
                // ==========================================
                
                // è¾…åŠ©å‡½æ•°ï¼šé€šç”¨æ’åè®¡ç®—
                const calcRank = (list, scoreGetter, rankSetter) => {
                    list.sort((a,b) => scoreGetter(b) - scoreGetter(a));
                    list.forEach((s, i) => rankSetter(s, i + 1));
                };

                // 1. å…¨é•‡èŒƒå›´ (æ€»åˆ† + å•ç§‘)
                calcRank(parsedHistory, s => s.total, (s, r) => { if(!s.ranks.total) s.ranks.total={}; s.townRank = r; s.ranks.total.township = r; });
                
                SUBJECTS.forEach(sub => {
                    // è¿‡æ»¤å‡ºæœ‰è¯¥ç§‘æˆç»©çš„å­¦ç”Ÿ
                    const validList = parsedHistory.filter(s => s.scores[sub] !== undefined);
                    calcRank(validList, s => s.scores[sub], (s, r) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].township = r; });
                });

                // 2. å­¦æ ¡èŒƒå›´ (æ€»åˆ† + å•ç§‘)
                const schools = {};
                parsedHistory.forEach(s => { if(!schools[s.school]) schools[s.school]=[]; schools[s.school].push(s); });
                
                Object.values(schools).forEach(group => {
                    calcRank(group, s => s.total, (s, r) => { s.schoolRank = r; s.ranks.total.school = r; });
                    SUBJECTS.forEach(sub => {
                        const validList = group.filter(s => s.scores[sub] !== undefined);
                        calcRank(validList, s => s.scores[sub], (s, r) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].school = r; });
                    });
                });

                // 3. ç­çº§èŒƒå›´ (æ€»åˆ† + å•ç§‘)
                const classes = {};
                parsedHistory.forEach(s => { const k = s.school+"_"+s.class; if(!classes[k]) classes[k]=[]; classes[k].push(s); });

                Object.values(classes).forEach(group => {
                    calcRank(group, s => s.total, (s, r) => { s.classRank = r; s.ranks.total.class = r; });
                    SUBJECTS.forEach(sub => {
                        const validList = group.filter(s => s.scores[sub] !== undefined);
                        calcRank(validList, s => s.scores[sub], (s, r) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].class = r; });
                    });
                });
                // ==========================================

                window.PREV_DATA = parsedHistory; 
                
                // æ›´æ–° UI
                const statusEl = document.getElementById('dm-history-status');
                statusEl.innerHTML = `âœ… å·²åŠ è½½ ${parsedHistory.length} æ¡ | ${calcModeMsg}`;
                statusEl.style.color = "#16a34a";
                
                DataManager.renderHistoryPreview();
                if (typeof performSilentMatching === 'function') performSilentMatching();
                if(typeof saveCloudData === 'function') saveCloudData();

                alert(`å†å²æ•°æ®å¯¼å…¥æˆåŠŸï¼\nå…± ${parsedHistory.length} äººã€‚\nâœ… å·²è‡ªåŠ¨è®¡ç®—å†å²æ€»åˆ†åŠå•ç§‘çš„ä¸‰çº§æ’å(ç­/æ ¡/é•‡)ã€‚`);
                input.value = ''; 

            } catch (err) {
                console.error(err);
                alert("è§£æå¤±è´¥: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },
    

    renderHistoryPreview: function() {
        const tbody = document.querySelector('#dm-history-preview-table tbody');
        if (!window.PREV_DATA || window.PREV_DATA.length === 0) return;

        // åˆ¤æ–­æ˜¯å¦å•æ ¡
        const schools = new Set(window.PREV_DATA.map(s => s.school));
        const isSingleSchool = schools.size === 1;

        let html = '';
        // åªå±•ç¤ºå‰ 50 æ¡é¢„è§ˆ
        window.PREV_DATA.slice(0, 50).forEach(s => {
            const townRankDisplay = isSingleSchool ? '<span style="color:#ccc">-</span>' : s.townRank;
            html += `
                <tr>
                    <td>${s.school}</td>
                    <td>${s.class}</td>
                    <td>${s.name.includes('æ— åæ°') ? '<span style="color:#999;font-style:italic;">'+s.name+'</span>' : '<strong>'+s.name+'</strong>'}</td>
                    <td style="font-weight:bold; color:#1e3a8a;">${s.total}</td>
                    <td>${s.schoolRank}</td>
                    <td>${townRankDisplay}</td>
                </tr>
            `;
        });
        
        if (window.PREV_DATA.length > 50) {
            html += `<tr><td colspan="6" style="text-align:center; color:#666;">... å…± ${window.PREV_DATA.length} æ¡è®°å½• ...</td></tr>`;
        }
        
        tbody.innerHTML = html;
        
        // åŠ¨æ€éšè—/æ˜¾ç¤ºè¡¨å¤´
        const townTh = document.querySelector('#dm-history-preview-table th:last-child');
        if (townTh) {
            if (isSingleSchool) {
                townTh.innerHTML = '<span style="color:#ccc; text-decoration:line-through">å…¨é•‡æ’å</span><br><small>(å•æ ¡å·²éšè—)</small>';
            } else {
                townTh.innerText = 'å…¨é•‡æ’å';
            }
        }
    },

    // 3. æ¸²æŸ“è°ƒåº¦å™¨
    renderCurrentTab: function() {
        const input = document.getElementById('dm-search-input');
        const keyword = input ? input.value.trim().toLowerCase() : '';
        
        if (this.currentTab === 'student') {
            this.renderStudents(keyword);
        } else if (this.currentTab === 'teacher') {
            this.renderTeachers(); // æ•™å¸ˆé¡µç‹¬ç«‹æ¸²æŸ“
        } else if (this.currentTab === 'archive') {
            this.renderArchives();
        } else if (this.currentTab === 'params') {
            this.renderParams();
        } else if (this.currentTab === 'targets') {
            this.renderTargets();
        }        
    },

    // 4. å­¦ç”Ÿåˆ—è¡¨æ¸²æŸ“ (ä¼˜åŒ–ç‰ˆï¼šä½¿ç”¨ DocumentFragment å’Œå­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–æ€§èƒ½)
    renderStudents: function(keyword) {
        if (!window.RAW_DATA) return;

        // æ€§èƒ½ä¼˜åŒ–ï¼šä»…åœ¨æœ‰æœç´¢è¯æ—¶è¿›è¡Œè¿‡æ»¤
        let list = keyword 
            ? RAW_DATA.filter(s => 
                (s.name && s.name.toLowerCase().includes(keyword)) || 
                (String(s.id) && String(s.id).includes(keyword)) || 
                (s.class && s.class.includes(keyword)) || 
                (s.school && s.school.includes(keyword))
              ).map((item, index) => ({ ...item, _originalIndex: RAW_DATA.indexOf(item) }))
            : RAW_DATA.map((item, index) => ({ ...item, _originalIndex: index }));
        
        this.pagination.total = list.length;
        const totalPages = Math.ceil(this.pagination.total / this.pagination.size) || 1;
        
        if (this.pagination.page > totalPages) this.pagination.page = totalPages;
        if (this.pagination.page < 1) this.pagination.page = 1;
        
        const start = (this.pagination.page - 1) * this.pagination.size;
        const pageData = list.slice(start, start + this.pagination.size);
        
        const tbody = document.querySelector('#dm-student-table tbody');
        if (!tbody) return;

        if (pageData.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">æ— æ•°æ®</td></tr>'; 
        } else {
            // ä½¿ç”¨æ•°ç»„ join æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ¯” += æ€§èƒ½æ›´å¥½
            const rows = pageData.map(s => `
                <tr>
                    <td>${s.school}</td>
                    <td>${s.class}</td>
                    <td style="font-weight:bold;">${s.name}</td>
                    <td>${s.id}</td>
                    <td>${s.total}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="DataManager.editStudent(${s._originalIndex})" style="padding:2px 6px; font-size:11px;">ç¼–è¾‘</button> 
                        <button class="btn btn-sm btn-danger" onclick="DataManager.deleteStudent(${s._originalIndex})" style="padding:2px 6px; background:#dc2626; font-size:11px;">åˆ é™¤</button>
                    </td>
                </tr>`);
            tbody.innerHTML = rows.join('');
        }
        this.updatePaginationUI(totalPages);
    },

    // 5. åˆ†é¡µ UI æ›´æ–°
    updatePaginationUI: function(totalPages) {
        const el = document.getElementById('dm-page-info');
        if(el) el.innerText = `${this.pagination.page} / ${totalPages}`;
    },

    changePage: function(delta) {
        this.pagination.page += delta;
        this.renderCurrentTab();
    },

    // --- æ•™å¸ˆç®¡ç†æ ¸å¿ƒé€»è¾‘ ---

    // ğŸŸ¢ [ä¿®å¤]ï¼šåŠ¨æ€æ¸²æŸ“å­¦æœŸä¸‹æ‹‰æ¡† (æ™ºèƒ½å±Šåˆ«æ¨¡å¼)
    renderTeacherTermSelect: function() {
        const sel = document.getElementById('dm-teacher-term-select');
        if (!sel) return;
        
        let years = [];
        let startYear = null;

        // 1. ä¼˜å…ˆä»å†…å­˜å…ƒæ•°æ®è¯»å–
        if (window.CURRENT_COHORT_META && window.CURRENT_COHORT_META.year) {
            startYear = parseInt(window.CURRENT_COHORT_META.year, 10);
        }

        // 2. å†ä»æœ¬åœ°å­˜å‚¨è¯»å–
        if (!startYear) {
            try {
                const metaStr = localStorage.getItem('CURRENT_COHORT_META');
                if (metaStr) {
                    const meta = JSON.parse(metaStr);
                    if (meta && meta.year) startYear = parseInt(meta.year, 10);
                }
            } catch (e) {}
        }

        // 3. å†ä»å±Šåˆ«IDæ¨æ–­
        if (!startYear) {
            const id = window.CURRENT_COHORT_ID || localStorage.getItem('CURRENT_COHORT_ID');
            const match = id ? String(id).match(/(\d{4})/) : null;
            if (match) startYear = parseInt(match[1], 10);
        }

        // 4. æœ€åä»ç•Œé¢æ ‡ç­¾æ–‡æœ¬å…œåº•
        if (!startYear) {
            const label = document.getElementById('cohort-current-label')?.innerText || '';
            const match = label.match(/(\d{4})/);
            if (match) startYear = parseInt(match[1], 10);
        }

        // 2. ç”Ÿæˆå­¦å¹´åˆ—è¡¨
        if (startYear) {
            // å±Šåˆ«æ¨¡å¼ï¼šç”Ÿæˆ 6å¹´çº§(å…¥å­¦) åˆ° 9å¹´çº§(æ¯•ä¸š) çš„4ä¸ªå­¦å¹´
            // Year 0 (6çº§): startYear
            // Year 3 (9çº§): startYear + 3
            for (let i = 0; i < 4; i++) {
                years.push(startYear + i);
            }
        } else {
            // å…œåº•æ¨¡å¼ï¼šå½“å‰å¹´ä»½ å‰åæ¨å¯¼
            const currentYear = new Date().getFullYear();
            years = [currentYear - 2, currentYear - 1, currentYear, currentYear + 1];
        }

        let options = '';
        years.forEach(year => {
            const yearStr = `${year}-${year+1}`; // e.g., 2022-2023
            
            // è®¡ç®—å¹´çº§æ ‡ç­¾
            let gradeLabel = '';
            if (startYear) {
                const gradeNum = 6 + (year - startYear);
                gradeLabel = ` [${gradeNum}å¹´çº§]`;
            }

            ['ä¸Šå­¦æœŸ','ä¸‹å­¦æœŸ'].forEach(term => {
                const termId = `${yearStr}_${term}`; 
                options += `<option value="${termId}">${yearStr} ${term}${gradeLabel}</option>`;
            });
        });

        sel.innerHTML = options;
        
        // 3. æ™ºèƒ½é€‰ä¸­é€»è¾‘
        const uiMeta = getExamMetaFromUI();
        const savedTerm = localStorage.getItem('CURRENT_TERM_ID');

        // æ•°æ®æ¸…æ´—ï¼šæ£€æŸ¥å½“å‰ value æ˜¯å¦åœ¨ options é‡Œ
        const setAndValidate = (val) => {
            sel.value = val;
            return sel.value === val; // éªŒè¯æ˜¯å¦é€‰ä¸­æˆåŠŸ
        };

        let isSet = false;
        if (uiMeta.year && uiMeta.term) {
            // ä¼˜å…ˆé€‰ä¸­é¡¶éƒ¨å·¥å…·æ çš„è®¾ç½®
            isSet = setAndValidate(`${uiMeta.year}_${uiMeta.term}`);
        } 
        
        if (!isSet && savedTerm) {
            // å…¶æ¬¡é€‰ä¸­ä¸Šæ¬¡ä¿å­˜çš„
            isSet = setAndValidate(savedTerm);
        }

        // å¦‚æœéƒ½æ²¡é€‰ä¸­ï¼ˆæ¯”å¦‚åˆ‡æ¢äº†å±Šåˆ«ï¼Œå¹´ä»½å˜äº†ï¼‰ï¼Œé»˜è®¤é€‰ä¸­æœ€åä¸€é¡¹ï¼ˆæœ€é«˜å¹´çº§ï¼‰
        if (!sel.value && sel.options.length > 0) {
            sel.value = sel.options[sel.options.length - 1].value;
        }
    },

    // ğŸŸ¢ [ä¿®å¤]ï¼šä¿®æ­£ updateTeacherSchoolSelect ç¼ºå¤±é—®é¢˜
    updateTeacherSchoolSelect: function() {
        const sel = document.getElementById('dm-teacher-school-select');
        if (!sel) return;
        
        const currentVal = sel.value;
        // å¦‚æœæœ‰ä¸Šä¼ æ•°æ®ï¼Œåˆ™ä» TEACHER_MAP ä¸­æ‰«æå­¦æ ¡
        // å¦åˆ™æ˜¾ç¤º global SCHOOLS
        let schools = new Set();
        
        if (typeof SCHOOLS !== 'undefined') {
            Object.keys(SCHOOLS).forEach(s => schools.add(s));
        }

        sel.innerHTML = '<option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>';
        [...schools].sort().forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });
        
        if (currentVal && schools.has(currentVal)) sel.value = currentVal;
    },

    switchTeacherTerm: function(termId) {
        if(!termId) return;
        localStorage.setItem('CURRENT_TERM_ID', termId);
        // è¿™é‡Œå¯ä»¥å¢åŠ é‡æ–°ä»äº‘ç«¯æ‹‰å–è¯¥å­¦æœŸä»»è¯¾è¡¨çš„é€»è¾‘
        // CloudManager.loadTeachers(); æš‚ä¸è‡ªåŠ¨æ‹‰å–ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹åŒæ­¥æŒ‰é’®
    },

    // è‡ªåŠ¨å°†ä¸Šä¼ çš„ä»»è¯¾æ•°æ®åŒæ­¥åˆ° CloudManager çš„å­¦æœŸæ¡£æ¡ˆ
    handleTeacherUpload: function(input) {
        const file = input.files[0];
        if (!file) return;
        const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
        if (!termId) return alert('è¯·å…ˆè®¾ç½®å½“å‰è€ƒè¯•/å­¦æœŸ');

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const sheetName = wb.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                
                if (json.length === 0) {
                    alert("è¡¨æ ¼ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");
                    return;
                }

                let count = 0;
                json.forEach(row => {
                    const className = normalizeClass(row['ç­çº§'] || row['class'] || row['Class']);
                    const subject = row['å­¦ç§‘'] || row['subject'] || row['ç§‘ç›®'];
                    const teacher = row['æ•™å¸ˆ'] || row['teacher'] || row['æ•™å¸ˆå§“å'] || row['å§“å'];

                    if (className && subject && teacher) {
                        TEACHER_MAP[`${className}_${subject}`] = teacher;
                        count++;
                    }
                });

                DataManager.syncTeacherHistory();
                DataManager.renderTeachers();

                // ğŸ”¥ è‡ªåŠ¨å­˜æ¡£åˆ°äº‘ç«¯å­¦æœŸåº“
                if (window.CloudManager && CloudManager.saveTeachers) {
                    CloudManager.saveTeachers();
                }

                alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} æ¡ä»»è¯¾ä¿¡æ¯ï¼\nå·²è‡ªåŠ¨åŒæ­¥è‡³äº‘ç«¯å­¦æœŸæ¡£æ¡ˆï¼Œä¾›åŒç±»è€ƒè¯•å…±ç”¨ã€‚`);
                input.value = ''; 

            } catch (err) {
                console.error(err);
                alert("è§£æå¤±è´¥ï¼š" + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },

    renderTeacherTermSelect: function() {
        const sel = document.getElementById('dm-teacher-term-select');
        if (!sel) return;

        const getEntryYear = () => {
            let y = null;

            if (window.CURRENT_COHORT_META && window.CURRENT_COHORT_META.year) {
                y = parseInt(window.CURRENT_COHORT_META.year, 10);
            }

            if (!y) {
                try {
                    const metaStr = localStorage.getItem('CURRENT_COHORT_META');
                    if (metaStr) {
                        const meta = JSON.parse(metaStr);
                        if (meta && meta.year) y = parseInt(meta.year, 10);
                    }
                } catch (e) {}
            }

            if (!y) {
                const id = window.CURRENT_COHORT_ID || localStorage.getItem('CURRENT_COHORT_ID');
                const match = id ? String(id).match(/(\d{4})/) : null;
                if (match) y = parseInt(match[1], 10);
            }

            if (!y) {
                const label = document.getElementById('cohort-current-label')?.innerText || '';
                const match = label.match(/(\d{4})/);
                if (match) y = parseInt(match[1], 10);
            }

            if (!y) {
                try {
                    const list = JSON.parse(localStorage.getItem(COHORT_STORAGE_KEY) || '[]');
                    const currentId = window.CURRENT_COHORT_ID || localStorage.getItem('CURRENT_COHORT_ID');
                    const found = list.find(c => String(c.id) === String(currentId));
                    if (found && found.year) y = parseInt(found.year, 10);
                    if (!y && list.length) y = parseInt(list[0].year, 10);
                } catch (e) {}
            }

            return y;
        };

        let years = [];
        const startYear = getEntryYear();

        if (startYear) {
            for (let i = 0; i < 4; i++) years.push(startYear + i);
        } else {
            const currentYear = new Date().getFullYear();
            years = [currentYear - 2, currentYear - 1, currentYear, currentYear + 1];
        }

        let options = '';
        years.forEach(year => {
            const yearStr = `${year}-${year + 1}`;
            let gradeLabel = '';
            if (startYear) {
                const gradeNum = 6 + (year - startYear);
                gradeLabel = ` [${gradeNum}å¹´çº§]`;
            }
            ['ä¸Šå­¦æœŸ', 'ä¸‹å­¦æœŸ'].forEach(term => {
                const termId = `${yearStr}_${term}`;
                options += `<option value="${termId}">${yearStr} ${term}${gradeLabel}</option>`;
            });
        });

        sel.innerHTML = options || '<option value="">æš‚æ— å­¦æœŸ</option>';

        const uiMeta = getExamMetaFromUI();
        const saved = localStorage.getItem('CURRENT_TERM_ID');
        const prefer = uiMeta.year && uiMeta.term ? `${uiMeta.year}_${uiMeta.term}` : saved;
        if (prefer) sel.value = prefer;
        if (!sel.value && sel.options.length) sel.value = sel.options[0].value;
    },

    switchTeacherTerm: function(termId) {
        if (!termId) return;
        localStorage.setItem('CURRENT_TERM_ID', termId);
        
        // ğŸŸ¢ [ä¿®å¤]ï¼šåˆ‡æ¢å­¦æœŸæ—¶ï¼Œå…ˆå°è¯•ä»æœ¬åœ°å†å²è¯»å–
        const db = CohortDB.ensure();
        const history = db.teachingHistory || {};
        const hasLocal = history[termId] && Object.keys(history[termId]).length > 0;
        
        if (hasLocal) {
            // æœ‰æœ¬åœ°æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
            TEACHER_MAP = JSON.parse(JSON.stringify(history[termId]));
            this.renderTeachers();
            console.log(`âœ… å·²ä»æœ¬åœ°å†å²åŠ è½½å­¦æœŸ ${termId} çš„ä»»è¯¾è¡¨`);
        } else {
            // ğŸŸ¢ [ä¿®å¤]ï¼šæœ¬åœ°æ— æ•°æ®ï¼Œè‡ªåŠ¨å°è¯•ä»äº‘ç«¯æ‹‰å–
            console.log(`âš ï¸ æœ¬åœ°æ— å­¦æœŸ ${termId} çš„ä»»è¯¾æ•°æ®ï¼Œå°è¯•ä»äº‘ç«¯åŒæ­¥...`);
            TEACHER_MAP = {};
            this.renderTeachers(); // å…ˆæ¸²æŸ“ç©ºè¡¨
            
            // å¼‚æ­¥ä»äº‘ç«¯åŠ è½½
            if (window.CloudManager && CloudManager.loadTeachers) {
                CloudManager.loadTeachers().catch(err => {
                    console.warn('äº‘ç«¯åŠ è½½å¤±è´¥:', err);
                });
            }
        }
    },

    syncTeacherHistory: function() {
        const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
        if (!termId) return;
        const db = CohortDB.ensure();
        db.teachingHistory = db.teachingHistory || {};
        db.teachingHistory[termId] = JSON.parse(JSON.stringify(TEACHER_MAP));
    },

    handleTeacherUpload: function(input) {
        const file = input.files[0];
        if (!file) return;
        
        // ğŸŸ¢ [ä¿®å¤] æ£€æŸ¥ XLSX åº“æ˜¯å¦åŠ è½½
        if (typeof XLSX === 'undefined') {
            alert('âŒ Excelè§£æåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
        }
        
        const termId = localStorage.getItem('CURRENT_TERM_ID') || getTermId(getExamMetaFromUI());
        if (!termId) return alert('è¯·å…ˆè®¾ç½®å½“å‰è€ƒè¯•/å­¦æœŸ');

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const sheetName = wb.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                
                if (json.length === 0) {
                    alert("è¡¨æ ¼ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");
                    return;
                }

                let count = 0;
                json.forEach(row => {
                    const className = normalizeClass(row['ç­çº§'] || row['class'] || row['Class']);
                    const subject = row['å­¦ç§‘'] || row['subject'] || row['ç§‘ç›®'];
                    const teacher = row['æ•™å¸ˆ'] || row['teacher'] || row['æ•™å¸ˆå§“å'] || row['å§“å'];

                    if (className && subject && teacher) {
                        TEACHER_MAP[`${className}_${subject}`] = teacher;
                        count++;
                    }
                });

                DataManager.syncTeacherHistory();
                DataManager.renderTeachers();
                
                // ğŸŸ¢ [ä¿®å¤] å¯¼å…¥æˆåŠŸåè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
                if (window.CloudManager && CloudManager.saveTeachers) {
                    CloudManager.saveTeachers().then(() => {
                        if (window.UI) UI.toast(`âœ… å·²å¯¼å…¥ ${count} æ¡ä»»è¯¾ä¿¡æ¯å¹¶åŒæ­¥åˆ°äº‘ç«¯`, "success");
                    }).catch(err => {
                        console.error('äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} æ¡ä»»è¯¾ä¿¡æ¯ï¼\n\nâš ï¸ ä½†äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»å³ä¸Šè§’ã€ä¿å­˜ä¿®æ”¹å¹¶åŒæ­¥äº‘ç«¯ã€‘æŒ‰é’®ã€‚`);
                    });
                } else {
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} æ¡ä»»è¯¾ä¿¡æ¯ï¼`);
                }
                input.value = ''; 

            } catch (err) {
                console.error('Excelè§£æé”™è¯¯:', err);
                alert("âŒ è§£æå¤±è´¥ï¼š" + err.message + "\n\nè¯·ç¡®ä¿ï¼š\n1. Excelæ–‡ä»¶æ ¼å¼æ­£ç¡®\n2. åŒ…å«'ç­çº§'ã€'å­¦ç§‘'ã€'æ•™å¸ˆ'åˆ—\n3. æ•°æ®æ ¼å¼ç¬¦åˆè¦æ±‚");
            }
        };
        reader.onerror = function() {
            alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
        };
        reader.readAsArrayBuffer(file);
    },

    renderTeachers: function() {
        const tbody = document.querySelector('#dm-teacher-table tbody');
        if(!tbody) return;
        tbody.innerHTML = '';

        const sel = document.getElementById('dm-teacher-school-select');
        const selectedSchool = sel ? sel.value : "";

        // è‹¥å­¦æœŸä¸‹æ‹‰ä»æœªæ¸²æŸ“ï¼Œè¿›è¡Œå…œåº•åˆ·æ–°
        const termSel = document.getElementById('dm-teacher-term-select');
        if (termSel && termSel.options && termSel.options.length <= 1) {
            const txt = termSel.options[0]?.textContent || '';
            if (txt.includes('æš‚æ— å­¦æœŸ')) {
                this.renderTeacherTermSelect();
            }
        }
        
        let list = Object.entries(TEACHER_MAP).map(([key, name]) => {
            const parts = key.split('_');
            const clsName = parts[0];
            const subject = parts.length > 1 ? parts[1] : '(æœªçŸ¥)';
            
            let schoolName = "æœªçŸ¥/æœªä¸Šä¼ ";
            if (typeof SCHOOLS !== 'undefined') {
                for (const [schName, schData] of Object.entries(SCHOOLS)) {
                    if (schData.students && schData.students.some(s => s.class == clsName)) {
                        schoolName = schName;
                        break;
                    }
                }
            }
            return { key, class: clsName, subject, name, school: schoolName };
        });

        // é€»è¾‘ï¼šç»Ÿè®¡åˆ—è¡¨ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„å­¦æ ¡ï¼Œè‡ªåŠ¨å°†å…¶è®¾ä¸º MY_SCHOOL
        if (list.length > 0) {
            const schoolCounts = {};
            list.forEach(t => {
                if (t.school && !t.school.includes("æœªçŸ¥")) {
                    schoolCounts[t.school] = (schoolCounts[t.school] || 0) + 1;
                }
            });

            // æ‰¾å‡ºæ•°é‡æœ€å¤šçš„å­¦æ ¡
            let maxCount = 0;
            let autoDetectedSchool = "";
            for (const [sch, count] of Object.entries(schoolCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    autoDetectedSchool = sch;
                }
            }

            // å¦‚æœæ‰¾åˆ°äº†æœ‰æ•ˆå­¦æ ¡ï¼Œä¸”å½“å‰æœªè®¾ç½®æˆ–ä¸ä¸€è‡´ï¼Œåˆ™å¼ºåˆ¶è‡ªåŠ¨åŒæ­¥
            if (autoDetectedSchool && window.MY_SCHOOL !== autoDetectedSchool) {
                window.MY_SCHOOL = autoDetectedSchool;
                console.log(`ğŸ¤– ç³»ç»Ÿå·²è‡ªåŠ¨å°†æœ¬æ ¡é”å®šä¸ºï¼š${autoDetectedSchool}`);
                
                // åŒæ­¥æ›´æ–°ä¸»ç•Œé¢çš„ä¸‹æ‹‰æ¡† UI
                const mainSelect = document.getElementById('mySchoolSelect');
                if (mainSelect) {
                    mainSelect.value = autoDetectedSchool;
                    // ç¨å¾®å»¶æ—¶è§¦å‘å˜æ›´äº‹ä»¶ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
                    setTimeout(() => {
                        // ä»…æ›´æ–°å†…å­˜ï¼Œä¸é¢‘ç¹è§¦å‘ renderTables ä»¥å…å¡é¡¿ï¼Œä½†åœ¨å…³é—­æ¨¡æ€æ¡†æ—¶ä¼šç”Ÿæ•ˆ
                    }, 100);
                }
                
                // æç¤ºç”¨æˆ·
                if(window.UI && list.length > 5) { // åªæœ‰æ•°æ®é‡è¶³å¤Ÿæ—¶æ‰æç¤º
                    // UI.toast(`å·²è‡ªåŠ¨è¯†åˆ«æœ¬æ ¡ä¸ºï¼š${autoDetectedSchool}`, "success");
                }
            }
        }

        if (selectedSchool) {
            list = list.filter(t => t.school === selectedSchool);
        }

        list.sort((a,b) => {
            if (a.school !== b.school) return a.school.localeCompare(b.school);
            if (a.class !== b.class) return a.class.localeCompare(b.class, undefined, {numeric:true});
            return a.subject.localeCompare(b.subject);
        });

        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">æš‚æ— ä»»è¯¾æ•°æ® (æˆ–æœªåŒ¹é…åˆ°è¯¥æ ¡ç­çº§)</td></tr>';
        } else {
            const displayList = list.slice(0, 500); 
            
            displayList.forEach(t => {
                const schoolStyle = t.school.includes("æœªçŸ¥") ? "color:#94a3b8; font-style:italic;" : "color:#475569;";
                tbody.innerHTML += `
                    <tr>
                        <td style="${schoolStyle}">${t.school}</td>
                        <td style="font-weight:bold;">${t.class}</td>
                        <td><span class="badge" style="background:#f1f5f9; color:#475569;">${t.subject}</span></td>
                        <td style="font-weight:bold; color:#1e293b;">${t.name}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="DataManager.editTeacher('${t.key}', '${t.name}')" style="padding:2px 6px; font-size:11px;">ä¿®æ”¹</button> 
                            <button class="btn btn-sm btn-danger" onclick="DataManager.deleteTeacher('${t.key}')" style="padding:2px 6px; background:#dc2626; font-size:11px;">åˆ é™¤</button>
                        </td>
                    </tr>`;
            });
            
            if (list.length > 500) {
                tbody.innerHTML += `<tr><td colspan="5" style="text-align:center; color:#999; padding:5px;">... æ•°æ®è¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 500 æ¡ ...</td></tr>`;
            }
        }
    },

    // --- æ•°æ®æ“ä½œè¾…åŠ©å‡½æ•° ---

    deleteStudent: function(index) { 
        const s = RAW_DATA[index]; 
        if(!s) return; 
        if(!confirm(`âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å­¦ç”Ÿã€${s.school} ${s.class}ç­ ${s.name}ã€‘å—ï¼Ÿ`)) return; 
        RAW_DATA.splice(index, 1); 
        this.renderCurrentTab(); 
        UI.toast("å·²æš‚å­˜åˆ é™¤ (è¯·ç‚¹å‡»ä¿å­˜)", "info"); 
    },

    editStudent: function(index) { 
        const s = RAW_DATA[index]; 
        Swal.fire({ 
            title: 'ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯', 
            html: `<div style="text-align:left; font-size:14px; line-height:2.5;">
                <label style="width:50px; display:inline-block;">å§“å:</label> <input id="swal-name" class="swal2-input" value="${s.name}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">ç­çº§:</label> <input id="swal-class" class="swal2-input" value="${s.class}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">è€ƒå·:</label> <input id="swal-id" class="swal2-input" value="${s.id}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">å­¦æ ¡:</label> <input id="swal-school" class="swal2-input" value="${s.school}" style="width:200px; height:30px; margin:0;"><br>
                <label style="width:50px; display:inline-block;">çŠ¶æ€:</label>
                <select id="swal-status" class="swal2-input" style="width:200px; height:30px; margin:0;">
                    <option value="active">æ­£å¸¸</option>
                    <option value="transfer_in">è½¬å…¥</option>
                    <option value="transfer_out">è½¬å‡º</option>
                    <option value="leave">ä¼‘å­¦/å€Ÿè¯»</option>
                </select>
            </div>`, 
            showCancelButton: true, 
            confirmButtonText: 'æš‚å­˜ä¿®æ”¹', 
            didOpen: () => {
                const st = document.getElementById('swal-status');
                const saved = (s.status || (COHORT_DB?.students?.[s.uuid]?.status)) || 'active';
                if (st) st.value = saved;
            },
            preConfirm: () => ({ 
                name: document.getElementById('swal-name').value.trim(), 
                class: document.getElementById('swal-class').value.trim(), 
                id: document.getElementById('swal-id').value.trim(), 
                school: document.getElementById('swal-school').value.trim(),
                status: document.getElementById('swal-status').value
            }) 
        }).then((result) => { 
            if (result.isConfirmed) { 
                const n = result.value; 
                if(!n.name || !n.class) return; 
                Object.assign(s, n); 
                if (s.uuid && COHORT_DB && COHORT_DB.students && COHORT_DB.students[s.uuid]) {
                    COHORT_DB.students[s.uuid].status = n.status || 'active';
                }
                this.renderCurrentTab(); 
                UI.toast("å·²ä¿®æ”¹ (è¯·ç‚¹å‡»ä¿å­˜)", "success"); 
            } 
        }); 
    },

    editTeacher: function(key, oldName) { 
        const newName = prompt(`ä¿®æ”¹ [${key.replace('_',' ')}] çš„ä»»è¯¾æ•™å¸ˆï¼š`, oldName); 
        if (newName && newName.trim()) { 
            TEACHER_MAP[key] = newName.trim(); 
            this.syncTeacherHistory();
            this.renderTeachers(); 
            UI.toast("å·²ä¿®æ”¹ (éœ€ç‚¹å‡»ä¿å­˜)", "info"); 
        } 
    },

    deleteTeacher: function(key) { 
        if(!confirm(`ç¡®å®šç§»é™¤ã€${key.replace('_',' ')}ã€‘çš„ä»»è¯¾ä¿¡æ¯å—ï¼Ÿ`)) return; 
        delete TEACHER_MAP[key]; 
        this.syncTeacherHistory();
        this.renderTeachers(); 
        UI.toast("å·²ç§»é™¤ (éœ€ç‚¹å‡»ä¿å­˜)", "info"); 
    },

    addTeacher: function() { 
        Swal.fire({ 
            title: 'æ–°å¢ä»»è¯¾', 
            html: `<div style="text-align:left; font-size:14px; line-height:2.5;">
                <label style="width:60px;">ç­çº§:</label> <input id="add-cls" class="swal2-input" placeholder="å¦‚: 701" style="width:180px; height:30px;"><br>
                <label style="width:60px;">å­¦ç§‘:</label> <input id="add-sub" class="swal2-input" placeholder="å¦‚: è¯­æ–‡" style="width:180px; height:30px;"><br>
                <label style="width:60px;">æ•™å¸ˆ:</label> <input id="add-name" class="swal2-input" placeholder="å§“å" style="width:180px; height:30px;">
            </div>`, 
            confirmButtonText: 'æ·»åŠ ', showCancelButton: true, 
            preConfirm: () => ({ 
                cls: document.getElementById('add-cls').value.trim(), 
                sub: document.getElementById('add-sub').value.trim(), 
                name: document.getElementById('add-name').value.trim() 
            }) 
        }).then((result) => { 
            if (result.isConfirmed) { 
                const d = result.value; 
                if(!d.cls || !d.sub || !d.name) return alert("è¯·å¡«å†™å®Œæ•´"); 
                TEACHER_MAP[`${d.cls}_${d.sub}`] = d.name; 
                this.syncTeacherHistory();
                this.renderTeachers(); 
                UI.toast("æ·»åŠ æˆåŠŸ (éœ€ç‚¹å‡»ä¿å­˜)", "success"); 
            } 
        }); 
    },

    // --- æ¡£æ¡ˆç®¡ç† ---

    renderArchives: function() {
        const examStats = {}; 
        if (typeof HISTORY_ARCHIVE !== 'undefined') {
            Object.keys(HISTORY_ARCHIVE).forEach(uid => {
                const records = HISTORY_ARCHIVE[uid];
                records.forEach(r => { if (!examStats[r.exam]) examStats[r.exam] = 0; examStats[r.exam]++; });
            });
        }
        const tbody = document.getElementById('dm-history-tbody');
        if(!tbody) return;

        if (Object.keys(examStats).length === 0) { 
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px; color:#999;">æš‚æ— å†å²è½¨è¿¹æ•°æ®</td></tr>'; 
        } else {
            let html = '';
            Object.keys(examStats).forEach(examName => {
                html += `<tr><td style="font-weight:bold;">${examName}</td><td>${examStats[examName]} æ¡è®°å½•</td><td><button class="btn btn-sm btn-primary" onclick="DataManager.renameHistoryExam('${examName}')" style="padding:2px 6px;">é‡å‘½å</button> <button class="btn btn-sm btn-danger" onclick="DataManager.deleteHistoryExam('${examName}')" style="padding:2px 6px; background:#dc2626;">åˆ é™¤</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }
        if (this.currentTab === 'archive') { this.loadCloudSnapshots(); }
    },

    deleteHistoryExam: function(examName) { 
        if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ã€${examName}ã€‘å—ï¼Ÿ`)) return; 
        Object.keys(HISTORY_ARCHIVE).forEach(key => { 
            HISTORY_ARCHIVE[key] = HISTORY_ARCHIVE[key].filter(r => r.exam !== examName); 
            if (HISTORY_ARCHIVE[key].length === 0) delete HISTORY_ARCHIVE[key]; 
        }); 
        this.renderArchives(); 
        UI.toast("å·²åˆ é™¤", "success"); 
    },

    renameHistoryExam: function(oldName) { 
        const newName = prompt("é‡å‘½åä¸ºï¼š", oldName); 
        if (!newName) return; 
        Object.values(HISTORY_ARCHIVE).forEach(records => { 
            records.forEach(r => { if (r.exam === oldName) r.exam = newName; }); 
        }); 
        this.renderArchives(); 
    },

    loadCloudSnapshots: async function() { 
        if (!sbClient) return; 
        const tbody = document.getElementById('dm-cloud-tbody'); 
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="3">â³ åŠ è½½ä¸­...</td></tr>'; 
        const { data } = await sbClient.from('system_data').select('key, created_at').order('created_at', { ascending: false }); 
        if (!data || !data.length) { 
            tbody.innerHTML = '<tr><td colspan="3">æ— å¤‡ä»½</td></tr>'; return; 
        } 
        tbody.innerHTML = data.map(i => `<tr><td>${i.key}</td><td>${new Date(i.created_at).toLocaleString()}</td><td><button class="btn btn-sm btn-danger" onclick="DataManager.deleteCloudSnapshot('${i.key}')">åˆ é™¤</button></td></tr>`).join(''); 
    },

    deleteCloudSnapshot: async function(key) { 
        if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return; 
        await sbClient.from('system_data').delete().eq('key', key); 
        this.loadCloudSnapshots(); 
    },

    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ [åŒæ­¥ä¿®å¤]ï¼šå‚æ•°ç®¡ç†æ¸²æŸ“é€»è¾‘ä¼˜åŒ– ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    renderParams: function() {
        if (!isIndicatorPromptAllowed()) {
            const area = document.getElementById('dm-params-area');
            if (area) area.style.display = 'none';
            return;
        }
        // 1. ç¡®ä¿å…¨å±€å˜é‡ç»“æ„å­˜åœ¨
        if (!window.SYS_VARS) window.SYS_VARS = { indicator: { ind1: '', ind2: '' }, targets: {} };
        if (!window.SYS_VARS.indicator) window.SYS_VARS.indicator = { ind1: '', ind2: '' };

        // 2. ä¼˜å…ˆä»å…¨å±€å˜é‡è¯»å–
        let i1 = window.SYS_VARS.indicator.ind1;
        let i2 = window.SYS_VARS.indicator.ind2;

        // 3. å…œåº•ï¼šå¦‚æœå…¨å±€å˜é‡ä¸ºç©ºï¼Œå°è¯•ä»ä¸»ç•Œé¢ DOM è·å–ï¼ˆé˜²æ­¢ä¸»ç•Œé¢æœ‰å€¼ä½†è¿™é‡Œæ²¡æ˜¾ç¤ºï¼‰
        const mainInput1 = document.getElementById('ind1');
        const mainInput2 = document.getElementById('ind2');
        
        if (!i1 && mainInput1) i1 = mainInput1.value;
        if (!i2 && mainInput2) i2 = mainInput2.value;
        
        // 4. å°†å€¼å¡«å…¥å¼¹çª—çš„è¾“å…¥æ¡†
        const el1 = document.getElementById('dm_ind1_input');
        const el2 = document.getElementById('dm_ind2_input');
        
        if(el1) {
            el1.value = i1 || '';
            // ç»‘å®šå®æ—¶æ›´æ–°
            el1.oninput = function() { 
                if(!window.SYS_VARS.indicator) window.SYS_VARS.indicator = {};
                window.SYS_VARS.indicator.ind1 = this.value; 
            };
        }
        if(el2) {
            el2.value = i2 || '';
            el2.oninput = function() { 
                if(!window.SYS_VARS.indicator) window.SYS_VARS.indicator = {};
                window.SYS_VARS.indicator.ind2 = this.value; 
            };
        }
    },

    saveParamsLocally: function() {
        if (!isIndicatorAllowed()) return;
        // 1. é˜²å¾¡æ€§åˆå§‹åŒ–
        if (!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
        
        // 2. è·å–ç®¡ç†é¢æ¿å¼¹çª—å†…çš„å€¼
        const v1 = document.getElementById('dm_ind1_input').value;
        const v2 = document.getElementById('dm_ind2_input').value;
        
        // 3. æ›´æ–°å†…å­˜å…¨å±€å˜é‡
        window.SYS_VARS.indicator = { ind1: v1, ind2: v2 };
        
        // 4. åŒæ­¥æ›´æ–°ä¸»ç•Œé¢çš„è¾“å…¥æ¡† (ç¡®ä¿ processData è¿è¡Œæ—¶èƒ½è¯»åˆ°)
        const main1 = document.getElementById('ind1');
        const main2 = document.getElementById('ind2');
        if(main1) main1.value = v1;
        if(main2) main2.value = v2;

        // 5. ğŸ”¥ æ ¸å¿ƒæ–°å¢ï¼šç«‹å³è§¦å‘äº‘ç«¯åŒæ­¥ ğŸ”¥
        if(typeof saveCloudData === 'function') {
            // ä½¿ç”¨ toast æç¤ºæ­£åœ¨ä¿å­˜ï¼Œä½“éªŒæ›´å¥½
            UI.toast('ğŸ’¾ æ­£åœ¨åŒæ­¥å‚æ•°è‡³äº‘ç«¯...', 'info');
            saveCloudData().then(() => {
                UI.toast('âœ… å‚æ•°å·²ä¿å­˜å¹¶åŒæ­¥äº‘ç«¯', 'success');
                
                // å¯é€‰ï¼šå‚æ•°å˜åŠ¨åï¼Œé€šå¸¸éœ€è¦é‡ç®—æŒ‡æ ‡ç”Ÿæ•°æ®
                // if(confirm("å‚æ•°å·²æ›´æ–°ï¼Œæ˜¯å¦ç«‹å³é‡æ–°è®¡ç®—æŒ‡æ ‡ç”Ÿæ•°æ®ï¼Ÿ")) {
                //     calcIndicators();
                // }
            });
        } else {
            UI.toast('âœ… å‚æ•°å·²æš‚å­˜åˆ°å†…å­˜ (æœªè¿æ¥äº‘ç«¯)', 'success');
        }
    },

    // --- ç›®æ ‡äººæ•°ç®¡ç† (å¢å¼ºç‰ˆ) ---
    renderTargets: function() {
        const tbody = document.getElementById('dm-targets-tbody');
        if(!tbody) return;
        
        // ç¡®ä¿å…¨å±€å˜é‡å­˜åœ¨
        if(typeof window.TARGETS === 'undefined') window.TARGETS = {};
        
        const list = Object.keys(window.TARGETS).sort();
        
        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯¼å…¥ Excel</td></tr>';
            return;
        }

        let html = '';
        list.forEach(sch => {
            const t = window.TARGETS[sch];
            html += `<tr><td style="font-weight:bold;">${sch}</td><td>${t.t1}</td><td>${t.t2}</td><td><button class="btn btn-sm btn-primary" onclick="DataManager.editTarget('${sch}')" style="padding:2px 6px;">ä¿®æ”¹</button> <button class="btn btn-sm btn-danger" onclick="DataManager.deleteTarget('${sch}')" style="padding:2px 6px;">åˆ é™¤</button></td></tr>`;
        });
        tbody.innerHTML = html;
    },

    handleTargetUpload: function(input) {
        if (isArchiveLocked()) return alert("â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œç¦æ­¢å¯¼å…¥ç›®æ ‡äººæ•°");
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (json.length === 0) return alert("ç©ºè¡¨æ ¼");

                let successCount = 0;
                let errorCount = 0;
                let dupCount = 0;
                const seen = new Set();
                const errors = [];

                json.forEach((row, idx) => {
                    const rowNo = idx + 2;
                    const name = row['å­¦æ ¡åç§°'] || row['å­¦æ ¡'];
                    const t1Key = Object.keys(row).find(k => k.includes('æŒ‡æ ‡ä¸€') || k.includes('ç›®æ ‡ä¸€'));
                    const t2Key = Object.keys(row).find(k => k.includes('æŒ‡æ ‡äºŒ') || k.includes('ç›®æ ‡äºŒ'));

                    if (!name) {
                        errorCount++;
                        errors.push(`ç¬¬ ${rowNo} è¡Œï¼šå­¦æ ¡åç§°ä¸ºç©º`);
                        return;
                    }
                    if (seen.has(name)) {
                        dupCount++;
                    }
                    seen.add(name);

                    const t1 = parseInt(row[t1Key] || row['æŒ‡æ ‡ä¸€ç›®æ ‡äººæ•°'] || 0);
                    const t2 = parseInt(row[t2Key] || row['æŒ‡æ ‡äºŒç›®æ ‡äººæ•°'] || 0);

                    if (isNaN(t1) || isNaN(t2)) {
                        errorCount++;
                        errors.push(`ç¬¬ ${rowNo} è¡Œï¼šç›®æ ‡äººæ•°éæ•°å­— (${name})`);
                        return;
                    }

                    window.TARGETS[name] = { t1, t2 };
                    successCount++;
                });

                DataManager.renderTargets();

                if(typeof saveCloudData === 'function') {
                    saveCloudData();
                    if (window.UI) UI.toast("âœ… ç›®æ ‡æ•°æ®å·²è‡ªåŠ¨åŒæ­¥äº‘ç«¯", "success");
                }

                const msg = `âœ… å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} æ¡ï¼Œé‡å¤ ${dupCount} æ¡ï¼Œé”™è¯¯ ${errorCount} æ¡ã€‚`;
                if (errors.length > 0 && typeof Swal !== 'undefined') {
                    Swal.fire('å¯¼å…¥ç»“æœ', `<div style="text-align:left; font-size:12px;">${msg}<br><br>${errors.slice(0, 8).join('<br>')}${errors.length > 8 ? '<br>...': ''}</div>`, errorCount > 0 ? 'warning' : 'success');
                } else {
                    alert(msg);
                }
                input.value = '';
            } catch (err) { alert("å¤±è´¥ï¼š" + err.message); }
        };
        reader.readAsArrayBuffer(file);
    },

    editTarget: function(schoolName) {
        const t = window.TARGETS[schoolName] || { t1: 0, t2: 0 };
        Swal.fire({
            title: `ç¼–è¾‘ç›®æ ‡ - ${schoolName}`,
            html: `<div style="text-align:left;line-height:2.5;"><label>æŒ‡æ ‡ä¸€:</label><input id="swal-t1" type="number" class="swal2-input" value="${t.t1}" style="width:100px;height:30px;"><br><label>æŒ‡æ ‡äºŒ:</label><input id="swal-t2" type="number" class="swal2-input" value="${t.t2}" style="width:100px;height:30px;"></div>`,
            showCancelButton: true,
            confirmButtonText: 'ç¡®å®š',
            preConfirm: () => ({ t1: parseInt(document.getElementById('swal-t1').value)||0, t2: parseInt(document.getElementById('swal-t2').value)||0 })
        }).then((result) => {
            if (result.isConfirmed) {
                window.TARGETS[schoolName] = result.value;
                this.renderTargets();
            }
        });
    },

    deleteTarget: function(schoolName) {
        if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
        delete window.TARGETS[schoolName];
        this.renderTargets();
    },

    // 7. ä¿å­˜å¹¶åŒæ­¥ (æ ¸å¿ƒä¿®å¤)
    saveAndSync: async function() {
        if (isArchiveLocked()) return alert("â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œä»…æ”¯æŒåªè¯»æŸ¥çœ‹");
        if (!confirm("âš ï¸ ç¡®å®šè¦åº”ç”¨æ‰€æœ‰ä¿®æ”¹å¹¶åŒæ­¥åˆ°äº‘ç«¯å—ï¼Ÿ\n\n1. ç³»ç»Ÿå°†é‡ç®—æ’å\n2. ç›®æ ‡/å‚æ•°å°†è¢«ä¿å­˜")) return;
        
        UI.loading(true, "æ­£åœ¨ä¿å­˜...");
        
        try {
            // 1. ç¡®ä¿å‚æ•°å·²åŒæ­¥åˆ°å…¨å±€
            this.saveParamsLocally();
            this.syncTeacherHistory();
            if (!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
            window.SYS_VARS.targets = window.TARGETS || {};
            
            // 2. é‡æ–°è®¡ç®—æ•°æ® (ä¼šè¯»å– ind1, ind2)
            if (window.RAW_DATA && window.RAW_DATA.length) {
                try {
                    await processData(); 
                    renderTables();
                } catch (e) {
                    console.warn('é‡ç®—å¤±è´¥ï¼Œä»å°†åŒæ­¥äº‘ç«¯ï¼š', e);
                }
            }
            
            // 3. ä¸Šä¼ åˆ°äº‘ç«¯
            await saveCloudData();
            
            UI.loading(false);
            Swal.fire('æˆåŠŸ', 'æ•°æ®å·²æ›´æ–°å¹¶åŒæ­¥è‡³äº‘ç«¯ï¼', 'success');
        } catch (e) {
            UI.loading(false);
            alert("ä¿å­˜å¤±è´¥: " + e.message);
        }
    }, // ğŸ‘ˆ æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ªé€—å·ï¼Œè¿æ¥ä¸‹é¢çš„æ–°å‡½æ•°

    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ [ä¿®æ”¹ç‚¹ 4.2]ï¼šåœ¨æ­¤å¤„ç²˜è´´ SQL æ‰§è¡Œæ ¸å¿ƒé€»è¾‘ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    
    // ç¼“å­˜æŸ¥è¯¢ç»“æœ
    sqlResultCache: [],
    sqlHistoryKey: 'SQL_HISTORY',
    sqlHistoryLimit: 12,

    // è·å–å†å²
    getSQLHistory: function() {
        try {
            return JSON.parse(localStorage.getItem(this.sqlHistoryKey) || '[]');
        } catch(e) {
            return [];
        }
    },

    // ä¿å­˜å†å²
    setSQLHistory: function(list) {
        try {
            localStorage.setItem(this.sqlHistoryKey, JSON.stringify(list));
        } catch(e) {}
    },

    // æ·»åŠ æœ€è¿‘æŸ¥è¯¢
    addRecentSQL: function(sql) {
        if (!sql) return;
        let list = this.getSQLHistory();
        list = list.filter(item => item.sql !== sql);
        list.unshift({ name: 'æœ€è¿‘æŸ¥è¯¢', sql, ts: Date.now(), pinned: false });
        if (list.length > this.sqlHistoryLimit) list = list.slice(0, this.sqlHistoryLimit);
        this.setSQLHistory(list);
    },

    // æ¸²æŸ“å†å²ä¸‹æ‹‰
    renderSQLHistory: function() {
        const sel = document.getElementById('dm-sql-history-select');
        if (!sel) return;
        const list = this.getSQLHistory();
        let options = '<option value="">ğŸ•˜ æœ€è¿‘/æ”¶è—</option>';
        list.forEach((item, idx) => {
            const label = item.pinned ? `â­ ${item.name}` : `ğŸ•˜ ${item.sql.slice(0, 28)}${item.sql.length > 28 ? '...' : ''}`;
            options += `<option value="${idx}">${label}</option>`;
        });
        sel.innerHTML = options;
    },

    // åº”ç”¨å†å²
    applySQLHistory: function(idx) {
        if (idx === '') return;
        const list = this.getSQLHistory();
        const item = list[Number(idx)];
        if (item && item.sql) {
            document.getElementById('dm-sql-input').value = item.sql;
        }
    },

    // ä¿å­˜æ”¶è—
    saveNamedSQL: function() {
        const sql = document.getElementById('dm-sql-input').value.trim();
        if (!sql) return alert('è¯·å…ˆè¾“å…¥ SQL');
        const nameInput = document.getElementById('dm-sql-history-name');
        const name = (nameInput && nameInput.value.trim()) || `æ”¶è— ${new Date().toLocaleString()}`;
        let list = this.getSQLHistory();
        list = list.filter(item => item.sql !== sql);
        list.unshift({ name, sql, ts: Date.now(), pinned: true });
        if (list.length > this.sqlHistoryLimit) list = list.slice(0, this.sqlHistoryLimit);
        this.setSQLHistory(list);
        if (nameInput) nameInput.value = '';
        this.renderSQLHistory();
        if (window.UI) UI.toast('âœ… å·²ä¿å­˜æ”¶è—', 'success');
    },

    // æ¸…ç©ºå†å²
    clearSQLHistory: function() {
        if (!confirm('ç¡®å®šæ¸…ç©ºSQLå†å²å—ï¼Ÿ')) return;
        localStorage.removeItem(this.sqlHistoryKey);
        this.renderSQLHistory();
    },

    // é¢„è®¾ SQL è¯­å¥
    setQuickSQL: function(type) {
        let sql = "";
        switch(type) {
            case 'base': 
                sql = "SELECT school, class, name, total FROM students ORDER BY total DESC LIMIT 10"; 
                break;
            case 'count': 
                sql = "SELECT school, COUNT(*) as cnt, AVG(total) as avg_score FROM students GROUP BY school ORDER BY avg_score DESC"; 
                break;
            case 'avg': 
                sql = "SELECT class, AVG(è¯­æ–‡) as chinese_avg FROM students GROUP BY class ORDER BY chinese_avg DESC"; 
                break;
            case 'failed': 
                sql = "SELECT class, name, æ•°å­¦ FROM students WHERE æ•°å­¦ < 90 ORDER BY æ•°å­¦ ASC"; // å‡è®¾æ»¡åˆ†150
                break;
            case 'teacher':
                // è”åˆæŸ¥è¯¢ç¤ºä¾‹
                sql = "SELECT s.class, s.name, s.è‹±è¯­, t.teacher FROM students s JOIN teachers t ON s.class = t.class AND t.subject = 'è‹±è¯­' WHERE t.teacher LIKE 'å¼ %' LIMIT 20";
                break;
        }
        document.getElementById('dm-sql-input').value = sql;
    },

    // å‡†å¤‡æ•°æ®æº
    prepareSQLData: function() {
        // 1. å‡†å¤‡ students è¡¨ (RAW_DATA å·²ç»æ˜¯æ•°ç»„ï¼Œå¯ä»¥ç›´æ¥ç”¨ï¼Œä½†ä¸ºäº†æ–¹ä¾¿æŸ¥è¯¢æŠŠ scores å±•å¼€)
        const studentsTable = window.RAW_DATA.map(s => {
            // æµ…æ‹·è´åŸºç¡€ä¿¡æ¯
            let row = { school: s.school, class: s.class, name: s.name, id: s.id, total: s.total };
            // å±•å¼€ç§‘ç›®åˆ†æ•° (ä¾‹å¦‚ s.scores.è¯­æ–‡ -> row.è¯­æ–‡)
            if(s.scores) {
                Object.keys(s.scores).forEach(sub => row[sub] = s.scores[sub]);
            }
            return row;
        });

        // 2. å‡†å¤‡ teachers è¡¨ (å°† TEACHER_MAP è½¬æ¢ä¸ºæ•°ç»„)
        // TEACHER_MAP ç»“æ„æ˜¯Key-Valueï¼Œéœ€è½¬ä¸º [{class:'701', subject:'è¯­æ–‡', teacher:'å¼ ä¸‰'}]
        const teachersTable = [];
        if(window.TEACHER_MAP) {
            Object.keys(window.TEACHER_MAP).forEach(key => {
                const [cls, sub] = key.split('_');
                teachersTable.push({ class: cls, subject: sub, teacher: window.TEACHER_MAP[key] });
            });
        }

        return { students: studentsTable, teachers: teachersTable };
    },

    runSQL: function() {
        const sql = document.getElementById('dm-sql-input').value.trim();
        const msgEl = document.getElementById('sql-status-msg');
        const thead = document.querySelector('#dm-sql-table thead');
        const tbody = document.querySelector('#dm-sql-table tbody');
        
        msgEl.innerText = "";
        thead.innerHTML = "";
        tbody.innerHTML = "";

        if(!sql) return;

        try {
            // 1. å‡†å¤‡æ•°æ®
            const db = this.prepareSQLData();
            
            // 2. æ‰§è¡ŒæŸ¥è¯¢ (Alasql æ”¯æŒç›´æ¥ä¼ å…¥æ•°æ®å¯¹è±¡ä½œä¸ºè¡¨)
            alasql("CREATE TABLE students");
            alasql("SELECT * INTO students FROM ?", [db.students]);
            
            alasql("CREATE TABLE teachers");
            alasql("SELECT * INTO teachers FROM ?", [db.teachers]);

            // æ‰§è¡Œç”¨æˆ·è¾“å…¥çš„ SQL
            const res = alasql(sql);
            
            this.sqlResultCache = res; // å­˜èµ·æ¥ä¾›å¯¼å‡º

            // 3. æ¸²æŸ“ç»“æœ
            if (!res || res.length === 0) {
                tbody.innerHTML = '<tr><td style="padding:20px; text-align:center; color:#666;">æŸ¥è¯¢ç»“æœä¸ºç©º</td></tr>';
                return;
            }

            // åŠ¨æ€ç”Ÿæˆè¡¨å¤´
            const columns = Object.keys(res[0]);
            let headerHtml = "<tr>";
            columns.forEach(col => headerHtml += `<th style="background:#f1f5f9; padding:8px;">${col}</th>`);
            headerHtml += "</tr>";
            thead.innerHTML = headerHtml;

            // ç”Ÿæˆå†…å®¹ (é™åˆ¶æ˜¾ç¤ºå‰ 500 æ¡é˜²æ­¢å¡é¡¿)
            let bodyHtml = "";
            res.slice(0, 500).forEach(row => {
                bodyHtml += "<tr>";
                columns.forEach(col => {
                    let val = row[col];
                    // ç®€å•çš„æ ¼å¼åŒ–å°æ•°
                    if (typeof val === 'number' && val % 1 !== 0) val = val.toFixed(2);
                    bodyHtml += `<td>${val}</td>`;
                });
                bodyHtml += "</tr>";
            });
            
            if (res.length > 500) {
                bodyHtml += `<tr><td colspan="${columns.length}" style="text-align:center; color:#999;">(ç»“æœè¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 500 æ¡ï¼Œè¯·å¯¼å‡º Excel æŸ¥çœ‹å…¨éƒ¨)</td></tr>`;
            }

            tbody.innerHTML = bodyHtml;

            // è®°å½•æœ€è¿‘æŸ¥è¯¢
            this.addRecentSQL(sql);
            this.renderSQLHistory();
            
            // æ¸…ç†å†…å­˜è¡¨
            alasql("DROP TABLE students");
            alasql("DROP TABLE teachers");

        } catch (e) {
            console.error(e);
            msgEl.innerText = "âŒ SQL é”™è¯¯: " + e.message;
            // ç¡®ä¿æ¸…ç†
            try { alasql("DROP TABLE IF EXISTS students"); alasql("DROP TABLE IF EXISTS teachers"); } catch(ex){}
        }
    },

    exportSQLResult: function() {
        if (!this.sqlResultCache || this.sqlResultCache.length === 0) return alert("å½“å‰æ²¡æœ‰æŸ¥è¯¢ç»“æœå¯å¯¼å‡º");
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(this.sqlResultCache);
        XLSX.utils.book_append_sheet(wb, ws, "SQLæŸ¥è¯¢ç»“æœ");
        XLSX.writeFile(wb, "è‡ªå®šä¹‰æŸ¥è¯¢ç»“æœ.xlsx");
    }
}; // ğŸ‘ˆ è¿™é‡Œæ˜¯ DataManager å¯¹è±¡çš„ç»“æŸï¼Œåé¢ä¸èƒ½æœ‰ HTML ä»£ç ï¼

    // ğŸŸ£ Talk to Dataï¼šè‡ªç„¶è¯­è¨€æŸ¥æ•°
    async function talkToData() {
        const inputEl = document.getElementById('dm-nlq-input');
        const statusEl = document.getElementById('dm-nlq-status');
        if (!inputEl || !statusEl) return;
        const question = inputEl.value.trim();
        if (!question) return alert('è¯·è¾“å…¥æŸ¥è¯¢éœ€æ±‚');
        statusEl.innerText = 'AI è§£æä¸­...';

        try {
            const schema = buildNLQSchema();
            const prompt = buildNLQPrompt(question, schema);
            const aiText = await callUnifiedAI(prompt);
            const sql = extractSQLFromAI(aiText);

            if (!isSafeSQL(sql)) {
                statusEl.innerText = 'âš ï¸ ç”ŸæˆSQLä¸å®‰å…¨æˆ–ä¸å®Œæ•´ï¼Œè¯·ä¿®æ”¹åå†æ‰§è¡Œ';
                return;
            }

            document.getElementById('dm-sql-input').value = sql;
            DataManager.runSQL();
            statusEl.innerText = 'âœ… å·²ç”ŸæˆSQLå¹¶æ‰§è¡Œ';
        } catch (e) {
            console.error(e);
            statusEl.innerText = 'âŒ è§£æå¤±è´¥ï¼Œè¯·é‡è¯•';
            if (window.UI) UI.toast('AI è§£æå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    function buildNLQSchema() {
        const db = DataManager.prepareSQLData();
        const studentsCols = db.students && db.students.length ? Object.keys(db.students[0]) : [];
        const teachersCols = db.teachers && db.teachers.length ? Object.keys(db.teachers[0]) : ['class', 'subject', 'teacher'];
        return {
            tables: {
                students: studentsCols,
                teachers: teachersCols
            },
            notes: 'studentså«æˆç»©å­—æ®µï¼Œteachersä¸ºä»»è¯¾è¡¨ï¼Œå¯JOIN students.class=teachers.class'
        };
    }

    function buildNLQPrompt(question, schema) {
        return `ä½ æ˜¯æ ¡åŠ¡æ•°æ®åˆ†æå¸ˆã€‚è¯·æŠŠç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ AlaSQL SELECT è¯­å¥ã€‚
è¦æ±‚ï¼š
1) åªå…è®¸ SELECT æŸ¥è¯¢ï¼›ä¸è¦ä½¿ç”¨ INSERT/UPDATE/DELETE/CREATE/DROPã€‚
2) è¡¨åªæœ‰ students å’Œ teachersã€‚
3) ä¼˜å…ˆè¾“å‡ºæ˜ç¡®å­—æ®µï¼Œä¸è¦ SELECT *ã€‚
4) è¾“å‡ºä»…åŒ…å« SQLï¼Œä¸è¦è§£é‡Šï¼Œä¸è¦ Markdownã€‚

ã€è¡¨ç»“æ„ã€‘\n${JSON.stringify(schema)}\n
ã€ç”¨æˆ·é—®é¢˜ã€‘\n${question}\n`;
    }

    function extractSQLFromAI(text) {
        if (!text) return '';
        let sql = text.trim();
        const codeMatch = sql.match(/```(?:sql)?\s*([\s\S]*?)```/i);
        if (codeMatch) sql = codeMatch[1].trim();
        const selectIdx = sql.toUpperCase().indexOf('SELECT');
        if (selectIdx > 0) sql = sql.slice(selectIdx);
        sql = sql.replace(/;\s*$/g, '').trim();
        return sql;
    }

    function isSafeSQL(sql) {
        if (!sql) return false;
        const s = sql.trim();
        if (!/^select\b/i.test(s)) return false;
        if (/(update|delete|insert|drop|alter|truncate|create|replace|merge|grant|revoke)\b/i.test(s)) return false;
        return true;
    }

    // ğŸŸ¢ [ä¼˜åŒ–ç‰ˆ] æ•°æ®æŒä¹…åŒ–å·¥å…·ï¼šæ”¯æŒ Supabase äº‘ç«¯åŒæ­¥ + IndexedDB æœ¬åœ°ç¼“å­˜
    const DB = {
        // ä¿å­˜æ•°æ®ï¼šåŒæ—¶ä¿å­˜åˆ°äº‘ç«¯å’Œæœ¬åœ°ç¼“å­˜
        save: async (key, value) => {
            // 1. ä¼˜å…ˆä¿å­˜åˆ°æœ¬åœ° IndexedDB (æé€Ÿ)
            try {
                if (window.idbKeyval) {
                    await idbKeyval.set(`cache_${key}`, value);
                    console.log(`ğŸ’¾ æœ¬åœ°ç¼“å­˜å·²æ›´æ–°: ${key}`);
                }
            } catch (e) { console.warn("æœ¬åœ°ç¼“å­˜å¤±è´¥:", e); }

            // 2. å¼‚æ­¥åŒæ­¥åˆ°äº‘ç«¯
            if (!sbClient) return; 
            try {
                const jsonStr = JSON.stringify(value);
                const compressedStr = "LZ|" + LZString.compressToUTF16(jsonStr);
                
                const { error } = await sbClient
                    .from('system_data') 
                    .upsert({ key: key, content: compressedStr }, { onConflict: 'key' });

                if (error) {
                    console.error("äº‘ç«¯å¤‡ä»½å¤±è´¥:", error);
                } else {
                    const statusEl = document.getElementById('auto-backup-status');
                    if (statusEl) statusEl.innerHTML = `<span style="color:#16a34a;">â˜ï¸ äº‘ç«¯å·²åŒæ­¥</span>`;
                }
            } catch (e) {
                console.error("äº‘ç«¯åŒæ­¥å‡ºé”™:", e);
            }
        },

        // è¯»å–æ•°æ®ï¼šä¼˜å…ˆæœ¬åœ°ç¼“å­˜ï¼Œåå°é™é»˜æ›´æ–°
        get: async (key) => {
            let localData = null;
            // 1. å°è¯•ä»æœ¬åœ° IndexedDB è¯»å– (ç§’å¼€)
            try {
                if (window.idbKeyval) {
                    localData = await idbKeyval.get(`cache_${key}`);
                    if (localData) {
                        console.log(`ğŸš€ ä»æœ¬åœ°ç¼“å­˜åŠ è½½æˆåŠŸ: ${key}`);
                        // è§¦å‘å¼‚æ­¥äº‘ç«¯æ ¡éªŒï¼ˆå¯é€‰ï¼Œæ­¤å¤„ä¸ºäº†æ€§èƒ½å…ˆè¿”å›æœ¬åœ°ï¼‰
                        DB.syncFromCloud(key); 
                        return localData;
                    }
                }
            } catch (e) { console.warn("è¯»å–æœ¬åœ°ç¼“å­˜å¤±è´¥:", e); }

            // 2. æœ¬åœ°æ— æ•°æ®ï¼Œä»äº‘ç«¯è¯»å–
            return await DB.syncFromCloud(key);
        },

        // ä»äº‘ç«¯å¼ºåˆ¶åŒæ­¥å¹¶æ›´æ–°æœ¬åœ°
        syncFromCloud: async (key) => {
            if (!sbClient) return null;
            try {
                const { data, error } = await sbClient
                    .from('system_data')
                    .select('content')
                    .eq('key', key)
                    .maybeSingle();

                if (error) throw error;

                if (data && data.content) {
                    let db = data.content;
                    if (typeof db === 'string' && db.startsWith("LZ|")) {
                        if (typeof LZString === 'undefined') {
                            throw new Error('LZString æœªåŠ è½½ï¼Œæ— æ³•è§£å‹äº‘ç«¯å†…å®¹');
                        }
                        const decompressed = LZString.decompressFromUTF16(db.substring(3));
                        db = JSON.parse(decompressed);
                    } else if (typeof db === 'string') {
                        db = JSON.parse(db);
                    }

                    // æ›´æ–°æœ¬åœ°ç¼“å­˜
                    if (window.idbKeyval) await idbKeyval.set(`cache_${key}`, db);
                    return db;
                }
            } catch (e) {
                console.error("äº‘ç«¯åŒæ­¥å¤±è´¥:", e);
            }
            return null;
        },

        // æ¸…é™¤æ•°æ®
        clear: async (key) => {
            if (!sbClient) return;
            try {
                await sbClient.from('system_data').delete().eq('key', key);
            } catch(e) {
                console.error("æ¸…é™¤æ•°æ®å¤±è´¥", e);
            }
        }
    };

    // ğŸ”„ åˆ‡æ¢å±Šåˆ« (å®‰å…¨ä¿®å¤ç‰ˆ)
    async function switchCohort(cohortId) {
        if (!cohortId) return;
        const cohortKey = getCohortKey(cohortId);
        const current = localStorage.getItem('CURRENT_PROJECT_KEY') || '';
        if (current === cohortKey) return;

        if(!confirm("âš ï¸ æ­£åœ¨åˆ‡æ¢å±Šåˆ«æ¡£æ¡ˆ...\n\nåˆ‡æ¢å‰è¯·ç¡®ä¿å½“å‰å·¥ä½œå·²ä¿å­˜ï¼ˆæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰ï¼Œå¦åˆ™æœªåŒæ­¥çš„ä¿®æ”¹å¯èƒ½ä¸¢å¤±ã€‚\n\nç¡®å®šåˆ‡æ¢å—ï¼Ÿ")) {
            const selector = document.getElementById('cohort-selector');
            if(selector) selector.value = localStorage.getItem('CURRENT_COHORT_ID') || '';
            return;
        }

        UI.loading(true, "æ­£åœ¨ä»äº‘ç«¯æ‹‰å– [" + cohortKey + "] çš„æ•°æ®...");
        
        // 1. è®°å½•å½“å‰é€‰æ‹©çš„å±Šåˆ«
        localStorage.setItem('CURRENT_PROJECT_KEY', cohortKey);
        localStorage.setItem('CURRENT_COHORT_ID', cohortId);
        const label = CURRENT_COHORT_META ? formatCohortLabel(CURRENT_COHORT_META) : `${cohortId}çº§`;
        const currentLabel = document.getElementById('cohort-current-label');
        if (currentLabel) currentLabel.innerText = label;
        const examCohortLabel = document.getElementById('exam-cohort-label');
        if (examCohortLabel) examCohortLabel.innerText = label;

        // 2. ä»äº‘ç«¯æ‹‰å–æ–°å±Šåˆ«çš„æ•°æ®
        const data = await DB.get(cohortKey);

        if (data) {
            // 3. æ¢å¤æ•°æ®
            COHORT_DB = data.COHORT_DB || null;
            CURRENT_COHORT_ID = data.CURRENT_COHORT_ID || cohortId;
            CURRENT_COHORT_META = data.CURRENT_COHORT_META || CURRENT_COHORT_META;
            CURRENT_EXAM_ID = data.CURRENT_EXAM_ID || '';

            // ä¼˜å…ˆä½¿ç”¨å±Šåˆ«è€ƒè¯•å¿«ç…§
            if (COHORT_DB && COHORT_DB.currentExamId && CohortDB.applyExamToWorkspace(COHORT_DB.currentExamId)) {
                // å·²åŠ è½½å½“å‰è€ƒè¯•å¿«ç…§
            } else {
                RAW_DATA = data.RAW_DATA || [];
                SCHOOLS = data.SCHOOLS || {};
                SUBJECTS = data.SUBJECTS || [];
                THRESHOLDS = data.THRESHOLDS || {};
                TEACHER_MAP = data.TEACHER_MAP || {};
                CONFIG = data.CONFIG || {};
            }
            
            // â˜…â˜…â˜… å…³é”®ï¼šæ¢å¤è´¦å·æ•°æ® â˜…â˜…â˜…
            if(data.AUTH_DB) {
                Auth.db = data.AUTH_DB;
                localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
                console.log("âœ… è´¦å·å·²åˆ‡æ¢ä¸º [" + projectKey + "] çš„ç‰ˆæœ¬");
            }
            
            // â˜…â˜…â˜… å…³é”®ï¼šæ¢å¤æŒ‡æ ‡å‚æ•°è¾“å…¥æ¡† (å®‰å…¨æ£€æŸ¥ç‰ˆ) â˜…â˜…â˜…
            if(data.INDICATOR_PARAMS) {
                const i1 = document.getElementById('ind1');
                const i2 = document.getElementById('ind2');
                // ğŸŸ¢ ä¿®å¤ï¼šå…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå†èµ‹å€¼
                if(i1) i1.value = data.INDICATOR_PARAMS.ind1 || '';
                if(i2) i2.value = data.INDICATOR_PARAMS.ind2 || '';
                
                // åŒæ—¶æ›´æ–°å†…å­˜
                if(!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
                window.SYS_VARS.indicator = data.INDICATOR_PARAMS;
            }

            // æ¢å¤å…¶ä»–å˜é‡
            if(data.TARGETS) { 
                TARGETS = data.TARGETS;
                if(!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
                window.SYS_VARS.targets = data.TARGETS;
            }
            if(data.PREV_DATA) PREV_DATA = data.PREV_DATA;
            if(data.HISTORY_ARCHIVE) HISTORY_ARCHIVE = data.HISTORY_ARCHIVE;
            if(data.FB_CLASSES) FB_CLASSES = data.FB_CLASSES;
            
            // 4. åˆ·æ–°ç•Œé¢
            updateSchoolSelect();
            updateMySchoolSelect();
            renderTables();
            
            // å¦‚æœæœ‰é…ç½®åï¼Œåˆ·æ–°å¯¼èˆª
            const badge = document.getElementById('mode-badge');
            if(badge && CONFIG.name) badge.innerText = CONFIG.name;
            renderNavigation();
            document.getElementById('mode-mask').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');

            CohortDB.renderExamList();
            
            UI.toast(`âœ… å·²åˆ‡æ¢åˆ° [${cohortKey}]ï¼Œæ•°æ®åŠ è½½å®Œæ¯•`, "success");
        } else {
            // 4. å¦‚æœäº‘ç«¯æ²¡è¿™ä¸ªå±Šåˆ«çš„æ•°æ®ï¼ˆæ–°æ¡£æ¡ˆï¼‰
            RAW_DATA = [];
            SCHOOLS = {};
            SUBJECTS = [];
            THRESHOLDS = {};
            COHORT_DB = {
                cohortId,
                cohortMeta: CURRENT_COHORT_META || null,
                students: {},
                teachingHistory: {},
                exams: {},
                currentExamId: '',
                resetPoints: []
            };
            
            Auth.db = { admin: { pass: 'admin123' }, teachers: [], parents: [] }; 
            localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
            
            // æ¸…ç©ºæŒ‡æ ‡è¾“å…¥æ¡† (å®‰å…¨æ£€æŸ¥ç‰ˆ)
            const i1 = document.getElementById('ind1');
            const i2 = document.getElementById('ind2');
            // ğŸŸ¢ ä¿®å¤ï¼šå…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå†æ¸…ç©º
            if(i1) i1.value = '';
            if(i2) i2.value = '';

            updateSchoolSelect();
            renderTables();
            const grade = computeCohortGrade(CURRENT_COHORT_META, getExamMetaFromUI());
            applyModeByGrade(grade);
            document.getElementById('mode-mask').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');

            CohortDB.renderExamList();
            
            UI.toast(`âœ¨ å·²åˆ‡æ¢åˆ° [${cohortKey}] (æ–°å­˜æ¡£)ï¼Œè¯·å¼€å§‹ä¸Šä¼ æ•°æ®`, "info");
        }
        
        UI.loading(false);
    }

    // å…¼å®¹æ—§å…¥å£
    window.switchProject = switchCohort;


    // 4. å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥æ¢å¤ (ç¨‹åºå…¥å£)
    window.addEventListener('load', async () => {
        
        // âœ‹ ğŸ”´ [å·²ç§»é™¤]ï¼šåˆ é™¤äº† MobApp.init() çš„æ‹¦æˆªé€»è¾‘ï¼Œç¡®ä¿æ‰‹æœºç«¯ä¹Ÿç»§ç»­æ‰§è¡Œåç»­çš„å®Œæ•´åˆå§‹åŒ–æµç¨‹ ğŸ”´

        // 0. åˆå§‹åŒ–å±Šåˆ«é€‰æ‹©å™¨çŠ¶æ€
        if (typeof CohortManager !== 'undefined') {
            CohortManager.init();
        }
        const selector = document.getElementById('cohort-selector');
        if(selector) selector.value = localStorage.getItem('CURRENT_COHORT_ID') || '';

        // 1. åˆå§‹åŒ–é‰´æƒ (æœ€å…ˆæ‰§è¡Œ)
        if (typeof Auth !== 'undefined') {
            Auth.init();
        }

        // 2. æ•™ç¨‹æ£€æŸ¥
        if(typeof HelpSystem !== 'undefined') {
            HelpSystem.checkFirstRun();
        }
        
        // (setInterval ä»£ç åœ¨ç¬¬ä¸€æ­¥å·²ç»ä¿®æ”¹è¿‡ï¼Œè¿™é‡Œä¸å†é‡å¤å±•ç¤ºï¼Œä¿æŒç¬¬ä¸€æ­¥çš„ä»£ç å³å¯)

        // ğŸŸ¢ åˆ†æ”¯ä¸€ï¼šè¿™æ˜¯åˆ†å‘ç‰ˆ (æœ‰å†…ç½®æ•°æ®) -> åŠ è½½å†…ç½®æ•°æ®
        if (window.EMBEDDED_DB) {
            console.log("æ£€æµ‹åˆ°å†…ç½®æ•°æ®åŒ…ï¼Œæ­£åœ¨è£…è½½...");
            const loader = document.getElementById('global-loader');
            if(loader) loader.classList.add('hidden');
            sessionStorage.removeItem('CURRENT_USER'); 
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('app').classList.add('hidden');
            const db = window.EMBEDDED_DB;
            
            // æ¢å¤å†…å­˜
            RAW_DATA = db.RAW_DATA || [];
            SCHOOLS = db.SCHOOLS || {};
            SUBJECTS = db.SUBJECTS || [];
            THRESHOLDS = db.THRESHOLDS || {};
            TEACHER_MAP = db.TEACHER_MAP || {};
            MY_SCHOOL = db.MY_SCHOOL || "";
            CONFIG = db.CONFIG || {};
            
            // æ¢å¤è´¦å· (åˆ†å‘ç‰ˆæ ¸å¿ƒ)
            if (db.AUTH_DB) {
                localStorage.setItem('SYS_USERS', JSON.stringify(db.AUTH_DB));
                if (typeof Auth !== 'undefined') Auth.db = db.AUTH_DB;
            }
            
            // æ¢å¤æŒ‡æ ‡å‚æ•°
            if(db.INDICATOR_PARAMS) {
                setTimeout(() => {
                    const i1 = document.getElementById('ind1');
                    const i2 = document.getElementById('ind2');
                    if(i1) i1.value = db.INDICATOR_PARAMS.ind1 || '';
                    if(i2) i2.value = db.INDICATOR_PARAMS.ind2 || '';
                }, 100);
            }
            if(db.TARGETS) window.TARGETS = db.TARGETS;

            // åˆ·æ–°
            updateSchoolSelect();
            updateMySchoolSelect();
            renderTables();
            document.getElementById('mode-mask').style.display = 'none';
            if(CONFIG.name) renderNavigation();

            UI.toast("âœ… æ•°æ®å·²è‡ªåŠ¨åŠ è½½ (åˆ†å‘ç‰ˆæ¨¡å¼)", "success");
        } 
        
        // ğŸŸ  åˆ†æ”¯äºŒï¼šè¿™æ˜¯ç®¡ç†å‘˜åŸç‰ˆ -> ä»äº‘ç«¯/æœ¬åœ°åŠ è½½
        else {
            // ğŸ”¥ å…³é”®ï¼šè¯»å–å½“å‰é€‰ä¸­çš„é¡¹ç›® Key
            const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup';
            const backup = await DB.get(currentKey);
            const isForceRestore = localStorage.getItem('SYS_FORCE_RESTORE'); 

            // å®šä¹‰ç»Ÿä¸€çš„æ¢å¤å‡½æ•°
            const performRestore = async () => {
                Perf.runAsync(async () => {
                    // æ¢å¤åŸºç¡€æ•°æ®
                    RAW_DATA = backup.RAW_DATA || [];
                    SCHOOLS = backup.SCHOOLS || {};
                    SUBJECTS = backup.SUBJECTS || [];
                    THRESHOLDS = backup.THRESHOLDS || {};
                    TEACHER_MAP = backup.TEACHER_MAP || {};
                    MY_SCHOOL = backup.MY_SCHOOL || "";
                    if(backup.CONFIG) CONFIG = backup.CONFIG;
                    
                    // â˜…â˜…â˜… æ¢å¤è´¦å· â˜…â˜…â˜…
                    if (backup.AUTH_DB) {
                        Auth.db = backup.AUTH_DB;
                        localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
                        console.log("âœ… è´¦å·ä¿¡æ¯å·²åŒæ­¥");
                    }

                    // â˜…â˜…â˜… æ¢å¤æŒ‡æ ‡å‚æ•° (ä¿®å¤ç‰ˆ) â˜…â˜…â˜…
                    if(backup.INDICATOR_PARAMS) {
                        // 1. æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»æ›´æ–°å…¨å±€å†…å­˜å˜é‡ï¼
                        // è¿™æ ·å½“ä½ æ‰“å¼€ç®¡ç†é¢æ¿æ—¶ï¼ŒswitchTab æ‰èƒ½è¯»å–åˆ°æ­£ç¡®çš„å€¼
                        if (!window.SYS_VARS) window.SYS_VARS = { indicator: {}, targets: {} };
                        window.SYS_VARS.indicator = backup.INDICATOR_PARAMS;

                        // 2. å°è¯•å›å¡«åˆ° DOM (ä½¿ç”¨æ­£ç¡®çš„æ–° ID: dm_ind..._input)
                        // ä½¿ç”¨ setTimeout ç¡®ä¿æ¨¡æ€æ¡†DOMå·²å°±ç»ª
                        setTimeout(() => {
                            const dm1 = document.getElementById('dm_ind1_input');
                            const dm2 = document.getElementById('dm_ind2_input');
                                                        
                            if(dm1) dm1.value = backup.INDICATOR_PARAMS.ind1 || '';
                            if(dm2) dm2.value = backup.INDICATOR_PARAMS.ind2 || '';
                                                        
                        }, 500);

                        console.log("âœ… [è‡ªåŠ¨æ¢å¤] æŒ‡æ ‡å‚æ•°å·²åŠ è½½åˆ°å†…å­˜:", window.SYS_VARS.indicator);
                    }
                    if(backup.TARGETS) TARGETS = backup.TARGETS;
                    
                    // æ¢å¤å…¶ä»–
                    if(backup.PREV_DATA) PREV_DATA = backup.PREV_DATA;
                    if(backup.HISTORY_ARCHIVE) HISTORY_ARCHIVE = backup.HISTORY_ARCHIVE;
                    
                    // åˆ·æ–°ç•Œé¢
                    document.getElementById('mode-mask').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    
                    if(CONFIG.name) {
                        document.getElementById('mode-badge').innerText = CONFIG.name;
                        document.getElementById('mode-info').innerText = `${CONFIG.name}æ¨¡å¼`;
                        renderNavigation();
                    }
                    
                    updateSchoolSelect(); 
                    updateMySchoolSelect();
                    // ğŸ‘ˆ ä¿®å¤ä½ç½®ï¼šæ·»åŠ  null æ£€æŸ¥ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
                    const mySchoolSelect = document.getElementById('mySchoolSelect');
                    if(MY_SCHOOL && mySchoolSelect) mySchoolSelect.value = MY_SCHOOL;
                    
                    renderTables();
                    if(MY_SCHOOL) generateTeacherInputs();

                    UI.toast(`âœ… å·²åŠ è½½é¡¹ç›®ï¼š[${currentKey}]`, 'success');
                }, "æ­£åœ¨åŠ è½½æ•°æ®...");
            };

            if (isForceRestore === 'true' && backup && backup.RAW_DATA) {
                localStorage.removeItem('SYS_FORCE_RESTORE'); 
                await performRestore(); 
            } 
            else if (backup && backup.RAW_DATA && backup.RAW_DATA.length > 0 && RAW_DATA.length === 0) {
                // å¦‚æœå‘ç°æœ‰ç¼“å­˜ï¼Œä¸”éé¦–æ¬¡ç©ºåŠ è½½
                await performRestore();
            } 
            else {
                // æ— æ•°æ®ï¼Œæ˜¾ç¤ºåˆå§‹æ¨¡å¼é€‰æ‹©
                document.getElementById('mode-mask').style.display = 'flex';
            }
        }
    });


    // æ€§èƒ½ä¼˜åŒ–å·¥å…·
    const Perf = {
        // å¼‚æ­¥ä»»åŠ¡åŒ…è£…å™¨ï¼šè§£å†³ç‚¹å‡»æŒ‰é’®åç•Œé¢â€œå‡æ­»â€çš„é—®é¢˜
        runAsync: (fn, loadingText) => {
            UI.loading(true, loadingText);
            // åˆ©ç”¨ setTimeout å°†ä»»åŠ¡æ¨åˆ°ä¸‹ä¸€å¸§ï¼Œè®© UI å…ˆæ¸²æŸ“å‡º Loading
            setTimeout(async () => {
                try {
                    await fn();
                } catch (e) {
                    console.error(e);
                    UI.toast("å‘ç”Ÿé”™è¯¯: " + e.message, 'error');
                } finally {
                    UI.loading(false);
                }
            }, 50);
        },
        // é«˜æ€§èƒ½åˆ—è¡¨æ¸²æŸ“ï¼šè§£å†³ += HTML å¯¼è‡´çš„å¡é¡¿
        renderList: (data, templateFn) => {
            if(!data || !data.length) return '';
            return data.map(templateFn).join('');
        }
    };
    // ================= å…¨å±€å˜é‡ =================
    let CONFIG = { 
        name: '6-8å¹´çº§', 
        label: 'å…¨ç§‘æ€»', 
        excRate: 0.05, 
        totalSubs: 'auto', 
        analysisSubs: 'auto', 
        showQuery: true 
    };
    let RAW_DATA = [], SCHOOLS = {}, SUBJECTS = [], THRESHOLDS = {}, TARGETS = {};
    let TEACHER_MAP = {}, MY_SCHOOL = "", TEACHER_STATS = {}; 
    let COHORT_DB = null;
    let CURRENT_COHORT_ID = '';
    let CURRENT_COHORT_META = null;
    let CURRENT_EXAM_ID = '';
    window.switchMobileTab = function(tabName) {
        const app = document.getElementById('mobile-app');
        // å…¼å®¹ Alpine V3 çš„å†™æ³•
        if (app && window.Alpine) {
            Alpine.$data(app).activeTab = tabName;
        } else {
            console.error("Alpine æœªåŠ è½½æˆ–å…ƒç´ ä¸å­˜åœ¨");
        }
    };
    let TEACHER_TOWNSHIP_RANKINGS = {}; MARGINAL_STUDENTS = {}; 
    let POTENTIAL_STUDENTS_CACHE = []; TOWNSHIP_RANKING_DATA = {}; 
    let radarChartInstance = null; 
    let segmentChartInstance = null; // æ–°å¢ï¼šåˆ†æ•°æ®µç›´æ–¹å›¾å®ä¾‹
    let trendChartInstance = null; // è¿›é€€æ­¥è¶‹åŠ¿å›¾å®ä¾‹
    let TEACHER_STAMP_BASE64 = "";
    // å­˜å‚¨ç»“æ„: { "å­¦æ ¡_å§“å": [ {exam:"åˆä¸€ä¸Š", rank:100}, {exam:"åˆä¸€ä¸‹", rank:50} ... ] }
    let HISTORY_ARCHIVE = {}; 
    let ROLLER_COASTER_STUDENTS = []; // å­˜å‚¨æ³¢åŠ¨å‰§çƒˆçš„å­¦ç”Ÿåå•
    let historyChartInstance = null;
    let LLM_CONFIG = {
        apiKey: localStorage.getItem('LLM_API_KEY') || '',
        baseURL: localStorage.getItem('LLM_BASE_URL') || 'https://api.deepseek.com',
        model: localStorage.getItem('LLM_MODEL') || 'deepseek-chat',
        systemPrompt: "ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œã€è¯­è°ƒæ¸©å’Œçš„åˆä¸­ç­ä¸»ä»»ã€‚è¯·æ ¹æ®å­¦ç”Ÿæ•°æ®å†™è¯„è¯­ï¼Œå¤šé¼“åŠ±ï¼ŒæŒ‡å‡ºå…·ä½“ä¼˜ç¼ºç‚¹ã€‚",
        source: 'cloud' // æ–°å¢å­—æ®µï¼šcloud | local
    };

    // 1. æœ¬åœ°å¼•æ“çŠ¶æ€ç®¡ç†
    let LOCAL_ENGINE = null;
    let IS_LOCAL_LOADING = false;

    // 2. åˆ‡æ¢ AI æ¥æº (UI äº¤äº’)
    function toggleAISource() {
        const source = document.querySelector('input[name="ai_source"]:checked').value;
        LLM_CONFIG.source = source;
        if(source === 'cloud') {
            document.getElementById('ai-config-cloud').classList.remove('hidden');
            document.getElementById('ai-config-local').classList.add('hidden');
        } else {
            document.getElementById('ai-config-cloud').classList.add('hidden');
            document.getElementById('ai-config-local').classList.remove('hidden');
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ WebGPU
            if (!navigator.gpu) {
                document.getElementById('local-ai-status').innerHTML = '<span style="color:red">âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebGPUï¼Œæ— æ³•ä½¿ç”¨æœ¬åœ° AIã€‚è¯·å°è¯•å‡çº§ Chrome/Edge æµè§ˆå™¨ã€‚</span>';
            }
        }
    }

    // 3. åˆå§‹åŒ–æœ¬åœ°æ¨¡å‹ (WebLLM æ ¸å¿ƒ)
    async function initLocalModel() {
        if(IS_LOCAL_LOADING) return;
        if(!window.webllm) return alert("WebLLM åº“å°šæœªåŠ è½½å®Œæˆï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢");
    
        // å°è¯•ç­‰å¾…æ¨¡å—åŠ è½½ï¼ˆå¦‚æœæ˜¯å¼‚æ­¥å¯¼å…¥ï¼‰
        if (!window.webllm) {
            try {
                // åŠ¨æ€å†æ¬¡å¯¼å…¥å°è¯•ï¼Œç¡®ä¿æ¨¡å—å°±ç»ª
                const loadedModule = await import("https://esm.run/@mlc-ai/web-llm");
                window.webllm = loadedModule;
            } catch (e) {
                console.error("WebLLM module load failed:", e);
                return alert("WebLLM AI å¼•æ“åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆéœ€è¦è®¿é—® jsdelivr CDNï¼‰ã€‚");
            }
        }
    
        const modelId = document.getElementById('local_model_select').value;
        IS_LOCAL_LOADING = true;
        
        const statusEl = document.getElementById('local-ai-status');
        const progressEl = document.getElementById('local-ai-progress');
        const btn = document.querySelector('button[onclick="initLocalModel()"]');
        
        btn.disabled = true;
        btn.innerHTML = 'â³ åŠ è½½ä¸­...';

        try {
            // å®šä¹‰åŠ è½½è¿›åº¦å›è°ƒ
            const initProgressCallback = (report) => {
                console.log(report); // æ§åˆ¶å°è°ƒè¯•
                statusEl.innerText = report.text; // æ˜¾ç¤ºå…·ä½“é˜¶æ®µ
                // è§£æè¿›åº¦ (WebLLMè¿”å› 0.0 ~ 1.0)
                const pct = Math.round(report.progress * 100);
                progressEl.style.width = `${pct}%`;
            };

            // å¦‚æœå·²æœ‰å¼•æ“å®ä¾‹ï¼Œå…ˆå¸è½½é‡Šæ”¾æ˜¾å­˜
            if (LOCAL_ENGINE) { await LOCAL_ENGINE.unload(); }

            // åˆ›å»ºå¼•æ“å®ä¾‹
            LOCAL_ENGINE = new window.webllm.MLCEngine();
            
            // å¼€å§‹åŠ è½½æ¨¡å‹
            await LOCAL_ENGINE.reload(modelId, { initProgressCallback });
            
            statusEl.innerHTML = 'âœ… æ¨¡å‹åŠ è½½å®Œæ¯•ï¼ç°åœ¨å¯ä»¥æ–­ç½‘ä½¿ç”¨äº†ã€‚';
            progressEl.style.background = '#16a34a';
            UI.toast('æœ¬åœ° AI å¼•æ“å°±ç»ª', 'success');
        } catch (err) {
            console.error(err);
            statusEl.innerHTML = `<span style="color:red">âŒ åŠ è½½å¤±è´¥: ${err.message}</span>`;
            alert("æœ¬åœ°æ¨¡å‹åŠ è½½å¤±è´¥ã€‚\nå¯èƒ½åŸå› ï¼šæ˜¾å­˜ä¸è¶³ã€ç½‘ç»œä¸­æ–­æˆ–æµè§ˆå™¨ä¸æ”¯æŒ WebGPUã€‚\nå»ºè®®åˆ‡æ¢å›äº‘ç«¯ API æ¨¡å¼ã€‚");
        } finally {
            IS_LOCAL_LOADING = false;
            btn.disabled = false;
            btn.innerHTML = 'â¬‡ï¸ é‡æ–°åŠ è½½';
        }
    }

    // 4. ç»Ÿä¸€ AI è°ƒç”¨æ¥å£ (è‡ªåŠ¨è·¯ç”±)
    async function callUnifiedAI(prompt, onChunk) {
        // --- åˆ†æ”¯ A: æœ¬åœ°æ¨¡å‹ ---
        if (LLM_CONFIG.source === 'local') {
            if (!LOCAL_ENGINE) return alert("è¯·å…ˆåœ¨ã€æ•°æ®æ¢çº½ -> AIé…ç½®ã€‘ä¸­åŠ è½½æœ¬åœ°æ¨¡å‹ï¼");
            
            try {
                const completion = await LOCAL_ENGINE.chat.completions.create({
                    messages: [{ role: "user", content: prompt }],
                    stream: true, // å¼ºåˆ¶æµå¼è¾“å‡º
                });

                let fullText = "";
                for await (const chunk of completion) {
                    const delta = chunk.choices[0].delta.content;
                    if (delta) {
                        fullText += delta;
                        if (onChunk) onChunk(delta);
                    }
                }
                return fullText;
            } catch (err) {
                console.error("Local AI Error", err);
                throw new Error("æœ¬åœ°æ¨ç†å‡ºé”™: " + err.message);
            }
        } 
        // --- åˆ†æ”¯ B: äº‘ç«¯ API ---
        else {
            return new Promise((resolve, reject) => {
                let fullResponse = "";
                // å¤ç”¨ä¹‹å‰çš„ callLLM é€»è¾‘ï¼Œä½†åŒ…è£¹åœ¨ Promise ä¸­
                callLLM(prompt, 
                    (chunk) => { // onChunk
                        fullResponse += chunk;
                        if (onChunk) onChunk(chunk);
                    }, 
                    (finalText) => { // onFinish
                        if(finalText.includes("(è¯·æ±‚å¤±è´¥)")) reject(new Error("APIè¯·æ±‚å¤±è´¥"));
                        else resolve(finalText);
                    }
                );
            });
        }
    }

    // 5. [æ–°åŠŸèƒ½] ç­çº§å¼±é¡¹æ·±åº¦è¯Šæ–­æŠ¥å‘Š
    async function generateClassDiagnosisReport() {
        const sch = document.getElementById('classCompSchoolSelect').value;
        if (!sch || !SCHOOLS[sch]) return alert("è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©å­¦æ ¡ï¼Œå¹¶ç‚¹å‡»ã€å¼€å§‹å¯¹æ¯”ã€‘ç”Ÿæˆæ•°æ®åŸºç¡€ã€‚");
        
        // A. å‡†å¤‡æ•°æ®ä¸Šä¸‹æ–‡
        const schoolData = SCHOOLS[sch];
        const classNames = [...new Set(schoolData.students.map(s => s.class))].sort();
        
        // æ„å»ºæç¤ºè¯ (Prompt Engineering)
        let prompt = `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´ç»éªŒçš„èµ„æ·±æ•™åŠ¡ä¸»ä»»ã€‚è¯·æ ¹æ®ä»¥ä¸‹ ${sch} çš„ç­çº§æˆç»©æ•°æ®ï¼Œæ’°å†™ä¸€ä»½æ·±åº¦çš„â€œç­çº§å¼±é¡¹è¯Šæ–­ä¸æå‡æ–¹æ¡ˆâ€ã€‚
        
ã€å…¨æ ¡åŸºå‡†æ•°æ®ã€‘ï¼š
- å…¨æ ¡å‡åˆ†: ${schoolData.metrics.total.avg.toFixed(1)}
- å…¨æ ¡ä¼˜ç§€ç‡: ${(schoolData.metrics.total.excRate*100).toFixed(1)}%

ã€å„ç­çº§è¯¦ç»†è¡¨ç°ã€‘ï¼š
`;
        classNames.forEach(cls => {
            const stus = schoolData.students.filter(s => s.class === cls);
            const n = stus.length;
            const avg = stus.reduce((a,b)=>a+b.total,0)/n;
            const exc = stus.filter(s=>s.total>=THRESHOLDS.total.exc).length/n;
            
            // å¯»æ‰¾è¯¥ç­çš„æœ€å·®å­¦ç§‘ (ä¸å¹´çº§å‡åˆ†å·®è·æœ€å¤§)
            let worstSub = {name:'', diff: 999};
            SUBJECTS.forEach(sub => {
                const subScores = stus.map(s=>s.scores[sub]).filter(v=>v!==undefined);
                if(subScores.length === 0) return;
                const subAvg = subScores.reduce((a,b)=>a+b,0)/subScores.length;
                const gradeSubAvg = schoolData.metrics[sub].avg;
                const diff = subAvg - gradeSubAvg; // è´Ÿæ•°è¡¨ç¤ºè½å
                if(diff < worstSub.diff) { worstSub = {name:sub, diff:diff}; }
            });

            prompt += `- ${cls}ç­(${n}äºº): æ€»åˆ†å‡åˆ†${avg.toFixed(1)} (ä¸å¹´çº§å·® ${(avg - schoolData.metrics.total.avg).toFixed(1)}), ä¼˜ç§€ç‡${(exc*100).toFixed(1)}%ã€‚æœ€æ˜æ˜¾çš„çŸ­æ¿å­¦ç§‘æ˜¯ã€${worstSub.name}ã€‘(ä½äºå¹´çº§å‡åˆ† ${Math.abs(worstSub.diff).toFixed(1)} åˆ†)ã€‚\n`;
        });

        prompt += `
\nè¯·è¾“å‡ºä¸€ä»½è¯Šæ–­æŠ¥å‘Šï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼ˆè¯·ä½¿ç”¨Markdownæ ¼å¼ï¼‰ï¼š
1. **å¹´çº§æ•´ä½“å­¦æƒ…ç»¼è¿°**ï¼šç®€è¦è¯„ä»·æ ¡å†…ä¸¤æåˆ†åŒ–æƒ…å†µã€‚
2. **é‡ç‚¹å…³æ³¨ç­çº§**ï¼šæŒ‡å‡º1-2ä¸ªå‡åˆ†è½åæˆ–å­¦ç§‘çŸ­æ¿æœ€ä¸¥é‡çš„ç­çº§ï¼Œè¯­æ°”è¦å®¢è§‚ä¸¥å‰ã€‚
3. **å­¦ç§‘æ”»åšå»ºè®®**ï¼šé’ˆå¯¹å‡ºç°çš„å…±æ€§å¼±åŠ¿å­¦ç§‘ï¼ˆæˆ–æŸç­çš„ç‰¹åˆ«å¼±é¡¹ï¼‰ï¼Œç»™å‡ºå…·ä½“çš„æ•™å­¦å¹²é¢„æªæ–½ï¼ˆå¦‚é›†ä½“å¤‡è¯¾ã€åˆ†å±‚ä½œä¸šã€åŸ¹ä¼˜è¾…å·®ç­‰ï¼‰ã€‚
4. **ç»™ç­ä¸»ä»»çš„ç®¡ç†å»ºè®®**ï¼šå¦‚ä½•è°ƒåŠ¨ç­çº§å­¦é£ã€‚

è¦æ±‚ï¼šæ¡ç†æ¸…æ™°ï¼Œè¯­æ°”ä¸“ä¸šï¼Œå­—æ•° 400-500 å­—ã€‚ä¸è¦ç½—åˆ—æ•°å­—ï¼Œç›´æ¥ç»™å‡ºå®šæ€§åˆ†æå’Œå¯æ‰§è¡Œçš„å»ºè®®ã€‚`;

        // B. åˆ›å»º/æ˜¾ç¤ºå¼¹çª—
        const modalId = 'ai-class-report-modal';
        let modal = document.getElementById(modalId);
        if(!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:800px; display:flex; flex-direction:column; max-height:85vh;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <h3 style="color:var(--primary)"><i class="ti ti-brain"></i> AI ç­çº§è¯Šæ–­æŠ¥å‘Š</h3>
                        <button onclick="document.getElementById('${modalId}').style.display='none'" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
                    </div>
                    <div id="ai-class-report-content" style="background:#f8fafc; padding:20px; border-radius:8px; line-height:1.6; flex:1; overflow-y:auto; white-space:pre-wrap; font-family: sans-serif;">ğŸ¤” æ­£åœ¨é€šè¿‡ ${LLM_CONFIG.source==='local'?'æœ¬åœ°æ˜¾å¡':'äº‘ç«¯ API'} è¿›è¡Œæ·±åº¦åˆ†æï¼Œè¯·ç¨å€™...</div>
                    <div style="margin-top:15px; text-align:right; padding-top:10px; border-top:1px solid #eee;">
                        <button class="btn btn-gray" onclick="document.getElementById('${modalId}').style.display='none'">å…³é—­</button>
                        <button class="btn btn-blue" onclick="navigator.clipboard.writeText(document.getElementById('ai-class-report-content').innerText); alert('å·²å¤åˆ¶')">ğŸ“‹ å¤åˆ¶æŠ¥å‘Š</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        
        const contentBox = document.getElementById('ai-class-report-content');
        contentBox.innerHTML = '<div style="text-align:center; padding:30px;"><span class="loader-spinner" style="width:30px;height:30px;display:inline-block;vertical-align:middle;"></span><br><br>æ­£åœ¨æ€è€ƒä¸­...<br><span style="font-size:12px;color:#666">å¼•æ“: ' + (LLM_CONFIG.source==='local'?'WebLLM (æœ¬åœ°)':'Cloud API') + '</span></div>';

        // C. æ‰§è¡Œè°ƒç”¨
        try {
            let fullText = "";
            await callUnifiedAI(prompt, (chunk) => {
                if (fullText === "") contentBox.innerHTML = ""; // æ”¶åˆ°ç¬¬ä¸€ä¸ªå­—æ—¶æ¸…é™¤loading
                fullText += chunk;
                contentBox.innerHTML = fullText; // å®æ—¶æ‰“å­—æœºæ•ˆæœ
                contentBox.scrollTop = contentBox.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            });
        } catch (e) {
            contentBox.innerHTML = `<div style="color:red; text-align:center; padding:20px;">
                <h3>ğŸš« åˆ†æå¤±è´¥</h3>
                <p>${e.message}</p>
                <p style="font-size:12px; color:#666;">å¦‚æœæ˜¯æœ¬åœ°æ¨¡å¼ï¼Œè¯·ç¡®ä¿æ¨¡å‹å·²åŠ è½½ä¸”æ˜¾å­˜å……è¶³ã€‚</p>
            </div>`;
        }
    }    let CURRENT_REPORT_STUDENT = null; // æš‚å­˜å½“å‰æ­£åœ¨æŸ¥è¯¢çš„å­¦ç”Ÿå¯¹è±¡
    let BATCH_AI_CACHE = {}; // å­˜å‚¨æ‰¹é‡ç”Ÿæˆçš„è¯„è¯­ key: "å­¦æ ¡_ç­çº§_å§“å"
    let IS_BATCH_AI_RUNNING = false; // æ§åˆ¶æ‰¹é‡ä»»åŠ¡çŠ¶æ€
    // âœ‹ æ€§èƒ½ä¼˜åŒ–ï¼šå®šä¹‰å­¦ç”Ÿæ˜ç»†è¡¨çš„åˆ†é¡µçŠ¶æ€
    let STD_PAGINATION = {
        page: 1,       // å½“å‰é¡µç 
        size: 100,     // æ¯é¡µæ˜¾ç¤ºæ¡æ•° (è°ƒæ•´æ­¤æ•°å€¼å¹³è¡¡æ€§èƒ½ä¸ä¿¡æ¯é‡)
        data: []       // ç¼“å­˜å½“å‰ç­›é€‰åçš„å®Œæ•´æ•°æ®ï¼Œé¿å…ç¿»é¡µæ—¶é‡å¤ç­›é€‰
    };
    
    let PREV_DATA = []; // è¿›é€€æ­¥åˆ†æä¸“ç”¨
    let PROGRESS_CACHE = []; 
    let MANUAL_ID_MAPPINGS = {}; // å­˜å‚¨ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤çš„åŒåæ˜ å°„å…³ç³» key: "Current_Class_Name" -> val: "Prev_Class_Name"
    let balanceChartInstance = null;
    let AID_GROUPS_CACHE = []; 
    let MP_DATA_CACHE = []; // ä¸´ç•Œç”Ÿæ•°æ®ç¼“å­˜
    let MP_SNAPSHOTS = JSON.parse(localStorage.getItem('MP_SNAPSHOTS') || '{}'); // æŒä¹…åŒ–å­˜å‚¨ä¸´ç•Œç”Ÿå¿«ç…§
    let CURRENT_CONTEXT_STUDENTS = []; // æ ‡ç­¾ç»„ä»¶ç”¨
    
    // è€ƒåŠ¡ä¸åˆ†ç­ç›¸å…³å˜é‡
    let FB_STUDENTS = []; let FB_CLASSES = []; let FB_CUR_CLASS_IDX = -1; let FB_SIMULATED_DATA = {};
    let EXAM_DATA = []; let EXAM_ROOMS = [];

    let FB_SCHEMES_CACHE = []; // å­˜å‚¨ç”Ÿæˆçš„å¤šç§æ–¹æ¡ˆ

    const SUBJECT_ORDER = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'æ”¿æ²»', 'å†å²', 'åœ°ç†', 'ç”Ÿç‰©'];

    // [ä¿®æ”¹] å¯¼èˆªé…ç½®ä¸é€»è¾‘ (æ–¹æ¡ˆäºŒï¼šåŠŸèƒ½åœºæ™¯å¯¼å‘ç‰ˆ)
    // è¯´æ˜ï¼šæŒ‰â€œç®¡æ•°æ® -> æ¯”å­¦æ ¡ -> è¯„ç­çº§ -> æŠ“å­¦ç”Ÿ -> ç”¨å·¥å…·â€çš„é€»è¾‘æ’åˆ—
    const NAV_STRUCTURE = {
        'data': { 
            title: 'ğŸ“‚ æ•°æ®ç®¡ç†', 
            color: '#334155', // æ·±ç° Slate
            items: [
                { id: 'upload', icon: 'ti-database-import', text: 'æ•°æ®ä¸Šä¼ ä¸è®¾ç½®' }
            ] 
        },
        'town': { 
            title: 'ğŸ† æ ¡é™…è”è€ƒåˆ†æ', 
            color: '#b45309', // é‡‘è‰² Amber (ä»£è¡¨è£èª‰ä¸æ’å)
            items: [
                { id: 'summary', icon: 'ti-report', text: 'ç»¼åˆè¯„ä»·æ€»æ¦œ' }, // é¢†å¯¼æœ€çˆ±çœ‹ï¼Œæ”¾ç¬¬ä¸€
                { id: 'analysis', icon: 'ti-chart-pie', text: 'ä¸¤ç‡ä¸€åˆ†(æ¨ªå‘)' }, 
                { id: 'macro-watch', icon: 'ti-alert-triangle', text: 'é¢„è­¦ä¸äº®ç‚¹çœ‹æ¿' },
                { id: 'high-score', icon: 'ti-trophy', text: 'é«˜åˆ†æ®µ/å°–å­ç”Ÿ' }, 
                { id: 'indicator', icon: 'ti-target', text: 'æŒ‡æ ‡ç”Ÿè¾¾æ ‡æ ¸ç®—' },
                { id: 'bottom3', icon: 'ti-arrow-bar-to-down', text: 'ä½åˆ†ç‡/å1/3æ ¸ç®—' }
            ] 
        },
        'class': { 
            title: 'ğŸ« ç­çº§æ•™å­¦ç®¡ç†', 
            color: '#dc2626', // çº¢è‰² Red (ä»£è¡¨ç»©æ•ˆä¸è€ƒæ ¸)
            items: [
                { id: 'teacher-analysis', icon: 'ti-school', text: 'æ•™å¸ˆæ•™å­¦è´¨é‡ç”»åƒ' }, 
                { id: 'single-school-eval', icon: 'ti-scale', text: 'ç»©æ•ˆå…¬å¹³è€ƒæ ¸æ¨¡å‹' },
                { id: 'class-comparison', icon: 'ti-layout-columns', text: 'ç­çº§æ¨ªå‘å¯¹æ¯”' },
                { id: 'class-diagnosis', icon: 'ti-activity', text: 'ç­çº§åˆ†åŒ–è¯Šæ–­(SD)' }
            ] 
        },
        'student': { 
            title: 'ğŸ” å­¦æƒ…æ·±åº¦è¯Šæ–­', 
            color: '#059669', // ç»¿è‰² Emerald (ä»£è¡¨ç”Ÿé•¿ä¸è¯Šæ²»)
            items: [
                { id: 'student-details', icon: 'ti-list-details', text: 'å­¦ç”Ÿæ¡£æ¡ˆæŸ¥è¯¢' },                 
                { id: 'subject-balance', icon: 'ti-scale', text: 'âš–ï¸ ä¼˜åŠ£åŠ¿å­¦ç§‘é€è§†' },
                { id: 'marginal-push', icon: 'ti-target-arrow', text: 'ğŸ¯ ä¸´ç•Œç”Ÿç²¾å‡†å¹²é¢„' }, 
                { id: 'progress-analysis', icon: 'ti-trending-up', text: 'è¿›é€€æ­¥/å¢å€¼è¯„ä»·' },
                { id: 'cohort-growth', icon: 'ti-timeline', text: 'ğŸ“ˆ çºµå‘æˆé•¿æ¡£æ¡ˆ' },
                { id: 'potential-analysis', icon: 'ti-bulb', text: 'åç§‘æ½œåŠ›æŒ–æ˜' },
                { id: 'segment-analysis', icon: 'ti-chart-histogram', text: 'åˆ†æ•°æ®µç»Ÿè®¡' },
                { id: 'correlation-analysis', icon: 'ti-topology-star-3', text: 'å­¦ç§‘å…³è”åº¦åˆ†æ' },                
                { id: 'report-generator', icon: 'ti-certificate', text: 'æˆç»©å•/å®¶é•¿æŸ¥åˆ†' }
            ] 
        },
        'tools': { 
            title: 'ğŸ› ï¸ æ•™åŠ¡è€ƒåŠ¡å·¥å…·', 
            color: '#7c3aed', // ç´«è‰² Violet (ä»£è¡¨å·¥å…·ç®±)
            items: [
                { id: 'exam-arranger', icon: 'ti-id-badge-2', text: 'æ™ºèƒ½è€ƒåœºç¼–æ’' }, 
                { id: 'freshman-simulator', icon: 'ti-arrows-split', text: 'æ–°ç”Ÿå‡è¡¡åˆ†ç­' },
                { id: 'grade-scheduler', icon: 'ti-calendar-time', text: 'çº§éƒ¨æ™ºèƒ½æ’è¯¾' },
                { id: 'seat-adjustment', icon: 'ti-armchair', text: 'è€ƒåæ’åº§/äº’åŠ©ç»„' },
                { id: 'mutual-aid', icon: 'ti-friends', text: 'å­¦ç§‘å°è€å¸ˆåˆ†ç»„' },
                { id: 'poster-generator', icon: 'ti-photo-star', text: 'å–œæŠ¥çº¢æ¦œç”Ÿæˆ' }
            ] 
        }
    };

    let currentCategory = 'data';

    function renderNavigation() {
        const catContainer = document.getElementById('navCategories');
        const subContainer = document.getElementById('navSubItems');
        catContainer.innerHTML = '';

        // å¦‚æœ Auth æœªåˆå§‹åŒ–æˆ–æœªç™»å½•ï¼Œé»˜è®¤ä¸º guest
        const role = (typeof Auth !== 'undefined' && Auth.currentUser) ? Auth.currentUser.role : 'guest';
        
        // 1. å®šä¹‰å—é™äººç¾¤ (ç§‘ä»»æ•™å¸ˆ, ç­ä¸»ä»», çº§éƒ¨ä¸»ä»»)
        const restrictedRoles = ['teacher', 'class_teacher', 'grade_director'];
        const isRestricted = restrictedRoles.includes(role);

        // 2. å¼ºåˆ¶é‡å®šå‘ï¼šå¦‚æœå½“å‰æ‰€åœ¨çš„å¤§ç±»æ˜¯è¢«ç¦æ­¢çš„ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ°â€œæ ¡é™…è”è€ƒåˆ†æâ€('town')
        // (é˜²æ­¢ç”¨æˆ·åˆ·æ–°é¡µé¢ååœç•™åœ¨è¢«éšè—çš„æ¨¡å—)
        if (isRestricted && (currentCategory === 'data' || currentCategory === 'tools')) {
            currentCategory = 'town';
            // åŒæ—¶åº”ç”¨æ–°é¢œè‰²çš„ä¸»é¢˜ (é‡‘è‰²)
            document.documentElement.style.setProperty('--primary', NAV_STRUCTURE['town'].color);
        }

        Object.keys(NAV_STRUCTURE).forEach(key => {
            const cat = NAV_STRUCTURE[key];

            // 3. æ ¸å¿ƒå±è”½é€»è¾‘ï¼šå¦‚æœæ˜¯å—é™è§’è‰²ï¼Œè·³è¿‡ 'data' å’Œ 'tools' çš„æ¸²æŸ“
            if (isRestricted) {
                if (key === 'data' || key === 'tools') return;
            }

            // --- åŸæœ‰æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜ ---
            const div = document.createElement('div');
            div.className = `nav-cat-item ${key === currentCategory ? 'active' : ''}`;
            div.innerHTML = `${cat.title}`;
            
            div.onclick = () => {
                currentCategory = key;
                document.documentElement.style.setProperty('--primary', cat.color);
                renderNavigation();
                
                if (cat.items.length > 0) {
                    // è‡ªåŠ¨è·³è½¬åˆ°è¯¥ç±»ç›®ä¸‹çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½
                    switchTab(cat.items[0].id);
                }
            };
            catContainer.appendChild(div);
        });

        subContainer.innerHTML = '';
        if (!NAV_STRUCTURE[currentCategory]) currentCategory = 'town';
        const subItems = NAV_STRUCTURE[currentCategory].items;
        subItems.forEach(item => {
            
            // 1. æ•™å¸ˆæƒé™æ§åˆ¶
            if (role === 'teacher') {
                // å±è”½ï¼šç»©æ•ˆè€ƒæ ¸(æ¶‰åŠå·¥èµ„)ã€è€ƒåŠ¡ç¼–æ’(æ•™åŠ¡æƒ)ã€æ–°ç”Ÿåˆ†ç­(æ•™åŠ¡æƒ)
                const blockedModules = ['single-school-eval', 'exam-arranger', 'freshman-simulator'];
                if(blockedModules.includes(item.id)) return; 
            }

            // 2. å®¶é•¿æƒé™æ§åˆ¶ (è™½ç„¶ CSS å·²ç»éšè—äº† headerï¼Œè¿™é‡ŒåšåŒé‡ä¿é™©)
            if (role === 'parent') return; 

            // 3. æ•™åŠ¡ä¸»ä»»æƒé™ (é€šå¸¸æ‹¥æœ‰æ‰€æœ‰ä¸šåŠ¡æƒé™ï¼Œé™¤äº†è´¦å·ç®¡ç†ï¼Œè´¦å·ç®¡ç†å·²åœ¨ Header æŒ‰é’®å¤„æ§åˆ¶)
            
            if (item.id === 'report-generator' && !CONFIG.showQuery) return;
            const a = document.createElement('a');
            a.className = `nav-link`;
            if(document.getElementById(item.id).classList.contains('active')) a.classList.add('active');
            a.innerHTML = `<i class="ti ${item.icon}"></i> ${item.text}`;
            a.onclick = () => switchTab(item.id);
            subContainer.appendChild(a);
        });
    }

    function switchCategory(key) { currentCategory = key; renderNavigation(); }

    // ================= ä¾§è¾¹æ ä¸é€šç”¨å·¥å…· =================
    function scrollToAnchor(id, element) {
        const target = document.getElementById(id);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (element && element.closest) {
                const parent = element.closest('.side-nav');
                if(parent) {
                    parent.querySelectorAll('.side-nav-link').forEach(el => el.classList.remove('active'));
                    parent.querySelectorAll('.side-nav-sub-link').forEach(el => el.classList.remove('active')); 
                }
                if (element.classList) element.classList.add('active');
            }
        }
    }

    function toggleSubNav(element) {
        const container = element.nextElementSibling;
        if (container && container.classList.contains('side-nav-sub-container')) {
            container.classList.toggle('show');
            element.classList.toggle('expanded');
        }
    }

    function scrollToSubAnchor(id, element) {
        const target = document.getElementById(id);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            const sideNav = element.closest('.side-nav');
            if(sideNav) {
                sideNav.querySelectorAll('.side-nav-link').forEach(el => el.classList.remove('active'));
                sideNav.querySelectorAll('.side-nav-sub-link').forEach(el => el.classList.remove('active'));
                const parentContainer = element.closest('.side-nav-sub-container');
                if(parentContainer && parentContainer.previousElementSibling) parentContainer.previousElementSibling.classList.add('active');
            }
            element.classList.add('active');
        }
    }

    function safeGet(obj, path, defaultValue = '-') { return path.split('.').reduce((acc, key) => acc && acc[key], obj) || defaultValue; }
    function getSubjectOrderIndex(sub) { const idx = SUBJECT_ORDER.indexOf(sub); return idx === -1 ? 999 : idx; }
    function sortSubjects(a, b) { const idxA = getSubjectOrderIndex(a); const idxB = getSubjectOrderIndex(b); if (idxA !== idxB) return idxA - idxB; return a.localeCompare(b); }

    // ================= è¾…åŠ©å‡½æ•°ï¼šExcel æ ¼å¼åŒ– =================
    function getExcelPercent(val) {
        if (typeof val !== 'number' || isNaN(val)) return '-';
        return { t: 'n', v: val, z: '0.00%' };
    }
    function getExcelNum(val, decimals = 2) {
        if (typeof val !== 'number' || isNaN(val)) return '-';
        return { t: 'n', v: parseFloat(val.toFixed(decimals)) };
    }

    // å®šä¹‰ä¸€å¥—ä¸“ä¸šçš„æ ·å¼é…ç½®
    const XLS_STYLES = {
        // è¡¨å¤´æ ·å¼
        HEADER: {
            font: { bold: true, sz: 12, color: { rgb: "333333" }, name: "Microsoft YaHei" },
            fill: { fgColor: { rgb: "E5E7EB" } }, // æµ…ç°èƒŒæ™¯
            border: { top: {style:'thin'}, bottom: {style:'medium'}, left: {style:'thin'}, right: {style:'thin'} },
            alignment: { horizontal: "center", vertical: "center", wrapText: true }
        },
        // æ™®é€šå•å…ƒæ ¼
        CELL: {
            font: { sz: 11, name: "Arial" },
            border: { top: {style:'thin', color: {rgb:"E5E7EB"}}, bottom: {style:'thin', color: {rgb:"E5E7EB"}}, left: {style:'thin', color: {rgb:"E5E7EB"}}, right: {style:'thin', color: {rgb:"E5E7EB"}} },
            alignment: { horizontal: "center", vertical: "center" }
        },
        // æ’åé«˜äº® (å‰ä¸‰å)
        RANK_TOP: {
            font: { bold: true, color: { rgb: "DC2626" } } // çº¢è‰²
        },
        // ä¼˜ç§€ (ç»¿è‰²)
        SCORE_GOOD: {
            font: { color: { rgb: "16A34A" }, bold: true }
        },
        // ä¸åŠæ ¼ (çº¢è‰²)
        SCORE_BAD: {
            font: { color: { rgb: "DC2626" } }
        }
    };

    /**
     * ä¸€é”®ç¾åŒ– Worksheet å¯¹è±¡
     * @param {Object} ws SheetJS çš„ worksheet å¯¹è±¡
     * @param {Array} headers è¡¨å¤´æ•°ç»„ï¼ˆç”¨äºåˆ¤æ–­åˆ—ç±»å‹ï¼‰
     */
    function decorateExcelSheet(ws, headers = []) {
        if(!ws['!ref']) return;
        
        const range = XLSX.utils.decode_range(ws['!ref']);
        const colWidths = [];

        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({ c: C, r: R });
                if (!ws[cellRef]) continue;

                const cell = ws[cellRef];
                const headerName = headers[C] || ""; // è·å–å½“å‰åˆ—çš„è¡¨å¤´å
                
                // 1. åŸºç¡€æ ·å¼åº”ç”¨
                let style = JSON.parse(JSON.stringify(R === 0 ? XLS_STYLES.HEADER : XLS_STYLES.CELL));
                
                // 2. è¡¨å¤´ç‰¹æ®Šå¤„ç†
                if (R === 0) {
                    // å¦‚æœæ˜¯â€œæ€»åˆ†â€æˆ–â€œæ’åâ€ï¼ŒåŠ æ·±èƒŒæ™¯
                    if (String(cell.v).includes("æ€»åˆ†") || String(cell.v).includes("æ’å")) {
                        style.fill.fgColor = { rgb: "D1FAE5" }; // æµ…ç»¿
                    }
                } 
                // 3. æ•°æ®è¡Œæ™ºèƒ½å¤„ç†
                else {
                    // ğŸ¦“ æ–‘é©¬çº¹ (å¶æ•°è¡Œå¾®ç°)
                    if (R % 2 === 0) style.fill = { fgColor: { rgb: "F9FAFB" } };

                    // ğŸ† æ’åºåˆ—å¤„ç†
                    if (headerName.includes("æ’å") || headerName.includes("åæ¬¡")) {
                        if (cell.v === 1 || cell.v === 2 || cell.v === 3) {
                            Object.assign(style.font, XLS_STYLES.RANK_TOP.font);
                            style.fill = { fgColor: { rgb: "FEF3C7" } }; // æµ…é»„åº•
                        }
                    }
                    
                    // ğŸ“‰ åˆ†æ•°/ç‡ å¤„ç†
                    if (typeof cell.v === 'number') {
                        // åŠæ ¼ç‡/ä¼˜ç§€ç‡ < 60% æ ‡çº¢ (å¦‚æœæ˜¯ç™¾åˆ†æ¯”æ•°å€¼ 0.6)
                        if (headerName.includes("ç‡") && cell.v < 0.6) {
                            Object.assign(style.font, XLS_STYLES.SCORE_BAD.font);
                        }
                        // åˆ†æ•° < 60 æ ‡çº¢ (å‡è®¾æ»¡åˆ†100ä»¥ä¸Š)
                        if ((headerName.includes("åˆ†") || headerName.includes("ç»©")) && cell.v < 60 && cell.v > 0) {
                            Object.assign(style.font, XLS_STYLES.SCORE_BAD.font);
                        }
                    }
                    
                    // æ–‡æœ¬å¯¹é½ä¼˜åŒ–ï¼šå§“åã€å­¦æ ¡å·¦å¯¹é½
                    if (headerName.includes("å§“å") || headerName.includes("å­¦æ ¡") || headerName.includes("ç­çº§")) {
                        style.alignment.horizontal = "left";
                        // å¢åŠ ä¸€ç‚¹ç¼©è¿›
                        style.alignment.indent = 1;
                    }
                }

                // åº”ç”¨æ ·å¼
                cell.s = style;

                // 4. è®¡ç®—åˆ—å®½ (ç®€å•ä¼°ç®—)
                const valLen = (cell.v ? String(cell.v).length : 0) * 1.5;
                colWidths[C] = Math.max(colWidths[C] || 5, valLen > 50 ? 50 : valLen); // é™åˆ¶æœ€å¤§å®½åº¦
            }
        }

        // åº”ç”¨åˆ—å®½
        ws['!cols'] = colWidths.map(w => ({ wch: w + 2 })); // åŠ ä¸€ç‚¹padding
        
        // å†»ç»“é¦–è¡Œ
        ws['!freeze'] = { xSplit: 0, ySplit: 1 };
    }

    // --- éšç§/æ¼”ç¤ºæ¨¡å¼é€»è¾‘ ---
    
    function togglePrivacyMode() {
        const btn = document.getElementById('btn-privacy-toggle');
        const indicator = document.getElementById('privacy-indicator');
        
        if (!IS_PRIVACY_ON) {
            // === å¼€å¯éšç§æ¨¡å¼ ===
            if (RAW_DATA.length === 0) return alert("è¯·å…ˆä¸Šä¼ æ•°æ®åå†å¼€å¯æ¼”ç¤ºæ¨¡å¼ã€‚");
            
            if (!confirm("ğŸ›¡ï¸ å³å°†è¿›å…¥ã€éšç§æ¼”ç¤ºæ¨¡å¼ã€‘ï¼š\n\n1. æ‰€æœ‰å­¦ç”Ÿå§“åå°†å˜ä¸ºä»£ç  (å¦‚ S-001)\n2. æ‰€æœ‰æ•™å¸ˆå§“åå°†å˜ä¸ºä»£ç  (å¦‚ T-01)\n3. é€‚åˆæŠ•å±æ±‡æŠ¥æˆ–æˆªå›¾åˆ†äº«\n\nç‚¹å‡»ç¡®å®šç»§ç»­ã€‚")) return;

            // 1. å¤‡ä»½åŸå§‹æ•°æ® (Deep Copy)
            DATA_BACKUP_PRIVACY = {
                RAW_DATA: JSON.parse(JSON.stringify(RAW_DATA)),
                TEACHER_MAP: JSON.parse(JSON.stringify(TEACHER_MAP)),
                // ä¹Ÿè¦å¤‡ä»½å†å²æ•°æ®ï¼Œå¦åˆ™è¿›é€€æ­¥åˆ†æä¼šä¹±
                PREV_DATA: JSON.parse(JSON.stringify(PREV_DATA))
            };

            // 2. æ‰§è¡Œè„±æ• (Masking)
            // å»ºç«‹æ˜ å°„è¡¨ä¿è¯åŒååŒID
            const stuMap = new Map(); 
            let stuCounter = 1;
            
            // è„±æ• RAW_DATA
            RAW_DATA.forEach(s => {
                const key = s.name; // ç®€å•æŒ‰å§“åæ˜ å°„ï¼Œå¦‚æœæœ‰é‡åä¼šæ˜ å°„æˆåŒä¸€ä¸ªä»£ç ï¼Œç¬¦åˆæ¼”ç¤ºé€»è¾‘
                if (!stuMap.has(key)) {
                    stuMap.set(key, `S-${String(stuCounter++).padStart(3, '0')}`);
                }
                s.name = stuMap.get(key);
            });

            // è„±æ• PREV_DATA (å¦‚æœæœ‰)
            if (PREV_DATA.length > 0) {
                PREV_DATA.forEach(p => {
                    const key = p.name;
                    // å¦‚æœæ˜¯ä¸Šæ¬¡æœ‰ä½†æœ¬æ¬¡æ²¡æœ‰çš„å­¦ç”Ÿï¼Œç»™æ–°å·ï¼›å¦‚æœæœ‰ï¼Œç”¨æ—§å·
                    if (!stuMap.has(key)) {
                         stuMap.set(key, `S-${String(stuCounter++).padStart(3, '0')}`);
                    }
                    p.name = stuMap.get(key);
                });
            }

            // è„±æ• TEACHER_MAP
            const teacherMap = new Map();
            let teaCounter = 1;
            Object.keys(TEACHER_MAP).forEach(k => {
                const realName = TEACHER_MAP[k];
                if (!teacherMap.has(realName)) {
                    teacherMap.set(realName, `T-${String(teaCounter++).padStart(2, '0')}`);
                }
                TEACHER_MAP[k] = teacherMap.get(realName);
            });

            // 3. æ ‡è®°çŠ¶æ€å¹¶åˆ·æ–°
            IS_PRIVACY_ON = true;
            btn.innerHTML = '<i class="ti ti-eye"></i> é€€å‡ºéšç§æ¨¡å¼';
            btn.style.background = "#dc2626"; // çº¢è‰²æŒ‰é’®æç¤ºé€€å‡º
            indicator.style.display = "block";
            document.body.classList.add('privacy-mode-active'); // å¯ç”¨äºCSSæ‰©å±•

        } else {
            // === å…³é—­éšç§æ¨¡å¼ (è¿˜åŸ) ===
            if (DATA_BACKUP_PRIVACY) {
                RAW_DATA = DATA_BACKUP_PRIVACY.RAW_DATA;
                TEACHER_MAP = DATA_BACKUP_PRIVACY.TEACHER_MAP;
                PREV_DATA = DATA_BACKUP_PRIVACY.PREV_DATA;
                DATA_BACKUP_PRIVACY = null;
            }

            IS_PRIVACY_ON = false;
            btn.innerHTML = '<i class="ti ti-eye-off"></i> å¼€å¯éšç§æ¨¡å¼';
            btn.style.background = "rgba(255,255,255,0.2)";
            indicator.style.display = "none";
            document.body.classList.remove('privacy-mode-active');
        }

        // 4. å…¨å±€é‡ç®—ä¸é‡ç»˜
        // å› ä¸º SCHOOLS, TEACHER_STATS ç­‰éƒ½æ˜¯åŸºäº RAW_DATA è®¡ç®—çš„ï¼Œå¿…é¡»é‡ç½®
        SCHOOLS = {}; 
        TEACHER_STATS = {}; 
        TEACHER_TOWNSHIP_RANKINGS = {};
        
        // é‡æ–°è¿è¡Œæ•°æ®å¤„ç†æµç¨‹
        processData(); 
        calculateRankings(); 
        
        // å¦‚æœå½“å‰åœ¨æ•™å¸ˆåˆ†æé¡µï¼Œé‡ç®—æ•™å¸ˆæ•°æ®
        if (Object.keys(TEACHER_MAP).length > 0 && MY_SCHOOL) {
            analyzeTeachers(); 
        }

        // åˆ·æ–°æ‰€æœ‰è¡¨æ ¼è§†å›¾
        renderTables();
        
        // åˆ·æ–°ç‰¹å®šçš„è§†å›¾ï¼ˆå¦‚æœå½“å‰æ­£åœç•™åœ¨è¿™äº›Tabï¼‰
        // æ¯”å¦‚æ•™å¸ˆå¡ç‰‡
        if (!document.getElementById('teacherCardsContainer').innerHTML.includes('æš‚æ— ')) {
            renderTeacherCards();
            renderTeacherComparisonTable();
            renderTeacherTownshipRanking();
        }
        // æ¯”å¦‚è¿›é€€æ­¥
        if (document.getElementById('progress-analysis').classList.contains('active')) {
             if (PREV_DATA.length > 0) renderProgressAnalysis();
        }

        alert(IS_PRIVACY_ON ? "âœ… éšç§æ¨¡å¼å·²å¼€å¯ï¼šå§“åå·²è„±æ•ï¼Œå¯è¿›è¡Œæ±‡æŠ¥æ¼”ç¤ºã€‚" : "âœ… éšç§æ¨¡å¼å·²é€€å‡ºï¼šæ•°æ®å·²è¿˜åŸã€‚");
    }

    window.IS_GUEST_MODE = false; // å…¨å±€æ ‡è®°

    function toggleGuestMode() {
        const btn = document.getElementById('btn-guest-mode');
        
        if (!window.IS_GUEST_MODE) {
            // === å‡†å¤‡å¼€å¯ ===
            Swal.fire({
                title: 'ğŸ”¥ å¼€å¯â€œé˜…åå³ç„šâ€æ¨¡å¼ï¼Ÿ',
                html: `
                    <div style="text-align:left; font-size:14px; color:#555;">
                        <p>æ­¤æ¨¡å¼é€‚ç”¨äºå…¬ç”¨ç”µè„‘æˆ–ä¸´æ—¶å¤„ç†æ•°æ®ã€‚</p>
                        <ul style="color:#b91c1c; font-weight:bold;">
                            <li>1. ç«‹å³æ¸…ç©ºç°æœ‰çš„è‡ªåŠ¨å­˜æ¡£ã€‚</li>
                            <li>2. åœæ­¢ä¸€åˆ‡è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½ã€‚</li>
                            <li>3. å…³é—­é¡µé¢æˆ–åˆ·æ–°åï¼Œæ‰€æœ‰æ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ã€‚</li>
                        </ul>
                        <p>ç¡®å®šè¦è¿›å…¥æ­¤æ¨¡å¼å—ï¼Ÿ</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'ç¡®å®šå¼€å¯ (æ¸…é™¤æ—§ç¼“å­˜)',
                cancelButtonText: 'å–æ¶ˆ'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // 1. ç«‹å³æ¸…é™¤ç¼“å­˜
                    await DB.clear('autosave_backup');
                    
                    // 2. æ¸…é™¤ LocalStorage ä¸­çš„éé…ç½®ç±»æ•°æ®
                    localStorage.removeItem('FB_DATA_BACKUP');
                    localStorage.removeItem('MP_SNAPSHOTS');
                    
                    // 3. æ”¹å˜çŠ¶æ€
                    window.IS_GUEST_MODE = true;
                    
                    // 4. UI å˜åŒ–
                    btn.innerHTML = '<i class="ti ti-flame-off"></i> é€€å‡ºå¹¶æ¸…ç©º';
                    btn.style.background = "#dc2626";
                    btn.style.borderColor = "#b91c1c";
                    
                    // 5. é¡µé¢å¢åŠ æ°´å°æˆ–æ ‡è¯†
                    document.body.style.borderTop = "5px solid #dc2626";
                    const statusEl = document.getElementById('auto-backup-status');
                    if(statusEl) statusEl.innerHTML = `<span style="color:#dc2626; font-weight:bold;">ğŸ”¥ é˜…åå³ç„šæ¨¡å¼ï¼šæ•°æ®ä¸è½åœ°</span>`;

                    UI.toast("ğŸ”¥ å·²å¼€å¯é˜…åå³ç„šï¼šæ—§ç¼“å­˜å·²æ¸…ç†ï¼Œæ–°æ•°æ®å°†ä¸å†ä¿å­˜ã€‚", "success");
                }
            });

        } else {
            // === å‡†å¤‡å…³é—­ (å…¶å®å°±æ˜¯é‡ç½®) ===
            Swal.fire({
                title: 'é€€å‡ºé˜…åå³ç„š',
                text: "é€€å‡ºå°†åˆ·æ–°é¡µé¢å¹¶é‡ç½®ç³»ç»Ÿã€‚å½“å‰å±å¹•ä¸Šçš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'é€€å‡ºå¹¶åˆ·æ–°',
                confirmButtonColor: '#4f46e5'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload(); // ç›´æ¥åˆ·æ–°ï¼Œå›å½’åˆå§‹çŠ¶æ€
                }
            });
        }
    }
    
    // æ‹¦æˆªæ‰‹åŠ¨ä¿å­˜æ“ä½œ (åŒé‡ä¿é™©)
    const originalSaveSnapshot = saveProjectSnapshot; // å¤‡ä»½åŸå‡½æ•°
    saveProjectSnapshot = function() {
        if (window.IS_GUEST_MODE) {
            Swal.fire({
                title: 'âš ï¸ æ¨¡å¼é™åˆ¶',
                text: 'å½“å‰å¤„äºâ€œé˜…åå³ç„šâ€æ¨¡å¼ï¼Œç¦æ­¢ä¿å­˜é¡¹ç›®å¿«ç…§åˆ°æœ¬åœ°ç¡¬ç›˜ã€‚è¯·å…ˆé€€å‡ºæ­¤æ¨¡å¼ã€‚',
                icon: 'error',
                confirmButtonColor: '#dc2626'
            });
            return;
        }
        originalSaveSnapshot();
    };

    // ================= åˆå§‹åŒ– =================
   function initSystem(type) {
        document.getElementById('mode-mask').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        if (type === '6-8') CONFIG = { name: '6-8å¹´çº§', label: 'å…¨ç§‘æ€»', excRate: 0.05, totalSubs: 'auto', analysisSubs: 'auto', showQuery: true };
        else CONFIG = { name: '9å¹´çº§', label: 'äº”ç§‘æ€»', excRate: 0.06, totalSubs: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦'], analysisSubs: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦','æ”¿æ²»'], showQuery: true };
        document.getElementById('mode-badge').innerText = CONFIG.name;
        document.getElementById('mode-info').innerText = `${CONFIG.name}æ¨¡å¼ (æ€»åˆ†: ${CONFIG.label}, å1/3å‰”é™¤: ${CONFIG.excRate*100}%)`;
        document.querySelectorAll('.label-total').forEach(e => e.innerText = CONFIG.label);
        document.getElementById('label-exc').innerText = (CONFIG.excRate*100) + '%';
        renderNavigation();
    }

    // [ä¼˜åŒ–] switchTab: å¢åŠ åŠ¨æ€å‰¯æ ‡é¢˜æ›´æ–°ï¼Œæå‡ä¸Šä¸‹æ–‡æ„ŸçŸ¥
    function switchTab(id) {
        // 1. åˆ‡æ¢å†…å®¹åŒºåŸŸæ˜¾ç¤º
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // 2. å®šä½æ‰€å±å¤§ç±»
        let foundCategory = null;
        let currentItemName = '';
        
        Object.keys(NAV_STRUCTURE).forEach(catKey => { 
            const item = NAV_STRUCTURE[catKey].items.find(i => i.id === id);
            if(item) {
                foundCategory = catKey;
                currentItemName = item.text;
            }
        });

        // 3. å¦‚æœå¤§ç±»å˜åŒ–ï¼Œåˆ·æ–°ä¸€çº§å¯¼èˆªå’Œå…¨å±€é¢œè‰²
        if(foundCategory && foundCategory !== currentCategory) {
            currentCategory = foundCategory;
            // ç«‹å³åº”ç”¨æ–°é¢œè‰²çš„ä¸»é¢˜
            const newColor = NAV_STRUCTURE[currentCategory].color;
            document.documentElement.style.setProperty('--primary', newColor);
            
            // é‡æ–°æ¸²æŸ“å¯¼èˆªä»¥æ›´æ–°é«˜äº®
            renderNavigation();
        } else {
            // å¦‚æœå¤§ç±»æ²¡å˜ï¼Œä»…æ›´æ–°äºŒçº§èœå•çš„é«˜äº®çŠ¶æ€ (æ€§èƒ½ä¼˜åŒ–ï¼Œä¸é‡ç»˜æ•´ä¸ªå¯¼èˆª)
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // æ‰¾åˆ°å«æœ‰å¯¹åº” onclick çš„é“¾æ¥æ·»åŠ  active
            const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(el => el.onclick.toString().includes(id));
            if(activeLink) activeLink.classList.add('active');
        }

        // 4. [æ–°å¢] åŠ¨æ€æ›´æ–° Header å‰¯æ ‡é¢˜ (é¢åŒ…å±‘æ•ˆæœ)
        const catTitle = NAV_STRUCTURE[currentCategory].title; // e.g. "ğŸ† æ ¡é™…è”è€ƒ"
        const subTitleEl = document.getElementById('app-subtitle');
        if(subTitleEl) {
            subTitleEl.innerHTML = `<span style="opacity:0.7">${catTitle}</span> <i class="ti ti-chevron-right" style="font-size:10px;"></i> <strong>${currentItemName}</strong>`;
            subTitleEl.style.animation = 'none';
            subTitleEl.offsetHeight; /* trigger reflow */
            subTitleEl.style.animation = 'fadeIn 0.5s';
        }

        // [æ–°å¢] 5. è‡ªåŠ¨åŒæ­¥å½“å‰é¡µé¢çš„â€œè¯´æ˜æ¡â€é¢œè‰² (è§†è§‰ç»Ÿä¸€)
        // æ‰¾åˆ°å½“å‰æ¿€æ´»çš„ section
        const activeSection = document.getElementById(id);
        if(activeSection) {
            // æ‰¾åˆ°å†…éƒ¨çš„ module-desc-bar
            const descBar = activeSection.querySelector('.module-desc-bar');
            if(descBar) {
                // å¼ºåˆ¶åº”ç”¨å½“å‰å¤§ç±»çš„é¢œè‰²
                descBar.style.borderLeftColor = NAV_STRUCTURE[currentCategory].color;
                // å¯é€‰ï¼šåŒæ—¶è®©æ ‡é¢˜é¢œè‰²ä¹Ÿè·Ÿéšå˜åŒ–
                const descTitle = descBar.querySelector('h3');
                if(descTitle) descTitle.style.color = '#333'; // ä¿æŒæ·±è‰²æˆ–è®¾ä¸º NAV_STRUCTURE[currentCategory].color
            }
        }
        
        // 6. æ¨¡å—ç‰¹å®šåˆå§‹åŒ–é€»è¾‘ (ä¿æŒåŸæœ‰é€»è¾‘ä¸å˜)
        if (id === 'student-details') updateStudentSchoolSelect();
        if (id === 'high-score') renderHighScoreTable(); 
        if (id === 'teacher-analysis') {
            
            // 1. æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæœ¬æ ¡å˜é‡ä¸ºç©ºï¼Œç«‹å³æ ¹æ®æ•°æ®è¿›è¡Œæš´åŠ›æ¨æ–­
            if (!MY_SCHOOL && typeof SCHOOLS !== 'undefined' && Object.keys(SCHOOLS).length > 0) {
                
                // ç­–ç•¥A: å¦‚æœå…¨é•‡åªæœ‰ä¸€æ‰€å­¦æ ¡ï¼ˆå•æ ¡ç‰ˆï¼‰ï¼Œç›´æ¥é”å®š
                const schoolNames = Object.keys(SCHOOLS);
                if (schoolNames.length === 1) {
                    MY_SCHOOL = schoolNames[0];
                } 
                // ç­–ç•¥B: å¦‚æœæœ‰å¤šæ‰€å­¦æ ¡ï¼Œæ ¹æ®ä»»è¯¾è¡¨åæ¨â€œæœ€å¯èƒ½çš„å­¦æ ¡â€
                else if (typeof TEACHER_MAP !== 'undefined' && Object.keys(TEACHER_MAP).length > 0) {
                    const schoolCounts = {};
                    
                    // éå†ä»»è¯¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªâ€œç­çº§_ç§‘ç›®â€é”®
                    Object.keys(TEACHER_MAP).forEach(key => {
                        const cls = key.split('_')[0]; // æå–ç­çº§åï¼Œå¦‚ "9.1"
                        
                        // åœ¨æ‰€æœ‰å­¦æ ¡ä¸­æœå¯»ï¼šè°æ‹¥æœ‰è¿™ä¸ªç­çº§ï¼Ÿ
                        for (const sName of schoolNames) {
                            const hasClass = SCHOOLS[sName].students.some(s => s.class == cls);
                            if (hasClass) {
                                // æ‰¾åˆ°å½’å±ï¼Œç»™è¯¥å­¦æ ¡æŠ•ä¸€ç¥¨
                                schoolCounts[sName] = (schoolCounts[sName] || 0) + 1;
                                break; 
                            }
                        }
                    });

                    // ç¥¨æ•°æœ€é«˜çš„å­¦æ ¡å³ä¸ºæœ¬æ ¡
                    let max = 0;
                    let winner = "";
                    for(const [s, c] of Object.entries(schoolCounts)) {
                        if(c > max) { max = c; winner = s; }
                    }
                    
                    if (winner) {
                        MY_SCHOOL = winner;
                        console.log("ğŸ¤– [æ™ºèƒ½ä¿®å¤] ç³»ç»Ÿå·²è‡ªåŠ¨æ ¹æ®ä»»è¯¾è¡¨é”å®šæœ¬æ ¡ä¸º:", MY_SCHOOL);
                    }
                }
                
                // å¦‚æœæ¨æ–­æˆåŠŸï¼Œè‡ªåŠ¨åŒæ­¥ UI ä¸‹æ‹‰æ¡†ï¼Œè®©ç”¨æˆ·æ— æ„Ÿ
                if (MY_SCHOOL) {
                    const sel = document.getElementById('mySchoolSelect');
                    if (sel) sel.value = MY_SCHOOL;
                }
            }

            // 2. æ‰§è¡Œåˆ†æ (ç°åœ¨ MY_SCHOOL åº”è¯¥å·²ç»è¢«è‡ªåŠ¨å¡«å¥½äº†)
            if (MY_SCHOOL && Object.keys(TEACHER_MAP).length > 0) {
                analyzeTeachers(); 
                renderTeacherComparisonTable(); 
                renderTeacherTownshipRanking();
            } else {
                // 3. å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼ˆé€šå¸¸æ˜¯å› ä¸ºè¿˜æ²¡ä¸Šä¼ å­¦ç”Ÿæˆç»©ï¼Œåªæœ‰æ•™å¸ˆåå•æ˜¯æ— æ³•åˆ†æçš„ï¼‰
                const compTable = document.getElementById('teacherComparisonTable');
                if(compTable) {
                    compTable.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#999;">
                            <div style="font-size:48px; margin-bottom:10px;">ğŸ«â“</div>
                            <p style="font-size:16px; font-weight:bold; color:#333;">æ— æ³•è‡ªåŠ¨è¯†åˆ«â€œæœ¬æ ¡â€</p>
                            <div style="background:#f9fafb; padding:10px 20px; border-radius:6px; display:inline-block; text-align:left; margin-top:10px; font-size:13px; color:#666; line-height:1.8;">
                                <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                                1. æ‚¨ä»…å¯¼å…¥äº†æ•™å¸ˆé…ç½®ï¼Œä½†å°šæœªä¸Šä¼ <strong>ã€å­¦ç”Ÿæˆç»©ã€‘</strong>æ•°æ®ã€‚<br>
                                <span style="color:#d97706">(ç³»ç»Ÿéœ€è¦ç»“åˆå­¦ç”Ÿåå•æ‰èƒ½ç¡®è®¤ç­çº§å½’å±)</span><br>
                                2. ä»»è¯¾è¡¨ä¸­çš„ç­çº§å (å¦‚ 9.1) ä¸æˆç»©è¡¨ä¸­çš„ç­çº§å (å¦‚ 901) ä¸ä¸€è‡´ã€‚<br>
                            </div>
                        </div>`;
                }
                document.getElementById('teacher-township-ranking-container').innerHTML = '';
            }
        }
        if (id === 'exam-arranger') {
            EXAM_initProctorUI(); 
        }
        if (id === 'report-generator') { updateMarginalSchoolSelect(); updateClassSelect(); }
        if (id === 'segment-analysis') updateSegmentSelects();
        if (id === 'class-comparison') updateClassCompSchoolSelect();
        if (id === 'potential-analysis') updatePotentialSchoolSelect();
        if (id === 'class-diagnosis') updateDiagnosisSelects();
        if (id === 'correlation-analysis') updateCorrelationSchoolSelect();
        if (id === 'seat-adjustment') updateSeatAdjSelects();
        if (id === 'subject-balance') updateSubjectBalanceSelects();
        if (id === 'progress-analysis') {
            
            // 1. æ™ºèƒ½æ¨æ–­æœ¬æ ¡ (é€»è¾‘ä¿æŒä¸å˜)
            if (!MY_SCHOOL && typeof TEACHER_MAP !== 'undefined' && Object.keys(TEACHER_MAP).length > 0 && typeof SCHOOLS !== 'undefined') {
                const schoolCounts = {};
                const schoolNames = Object.keys(SCHOOLS);
                Object.keys(TEACHER_MAP).forEach(key => {
                    const cls = key.split('_')[0]; 
                    for (const sName of schoolNames) {
                        if (SCHOOLS[sName].students.some(s => s.class == cls)) {
                            schoolCounts[sName] = (schoolCounts[sName] || 0) + 1;
                            break; 
                        }
                    }
                });
                let max = 0; let winner = "";
                for(const [s, c] of Object.entries(schoolCounts)) { if(c > max) { max = c; winner = s; } }
                if (winner) { MY_SCHOOL = winner; }
            }

            // 2. åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
            updateProgressSchoolSelect();
            const progSel = document.getElementById('progressSchoolSelect');
            if (MY_SCHOOL && progSel) progSel.value = MY_SCHOOL;

            // 3. ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥å†…å­˜æ•°æ®å¹¶æ¿€æ´» ğŸ”¥
            const statusEl = document.getElementById('va-data-status');
            
            // åªè¦ PREV_DATA æœ‰é•¿åº¦ï¼Œå°±è¯´æ˜äº‘ç«¯æˆ–æœ¬åœ°å·²åŠ è½½
            if (window.PREV_DATA && window.PREV_DATA.length > 0) {
                // æˆåŠŸçŠ¶æ€
                if(statusEl) {
                    statusEl.innerHTML = `âœ… æ•°æ®å°±ç»ª (å·²åŠ è½½ ${window.PREV_DATA.length} æ¡å†å²è®°å½•)`;
                    statusEl.style.color = "#16a34a";
                    statusEl.style.fontWeight = "bold";
                }
                
                // å¦‚æœè¿˜æ²¡æœ‰ç”Ÿæˆç¼“å­˜(PROGRESS_CACHE)ï¼Œç«‹å³æ‰§è¡Œé™é»˜åŒ¹é…
                if (!window.PROGRESS_CACHE || window.PROGRESS_CACHE.length === 0) {
                    if (typeof performSilentMatching === 'function') performSilentMatching();
                }
                
                // æ¸²æŸ“æŠ¥è¡¨
                if (typeof renderValueAddedReport === 'function') renderValueAddedReport(true);
                
                // å¦‚æœé€‰ä¸­äº†å­¦æ ¡ï¼Œæ¸²æŸ“ä¸ªäººè¿½è¸ª
                if (progSel && progSel.value && typeof renderProgressAnalysis === 'function') {
                    renderProgressAnalysis(); 
                }
            } else {
                // å¤±è´¥çŠ¶æ€
                if(statusEl) {
                    statusEl.innerHTML = `âŒ ç¼ºä¸Šæ¬¡è€ƒè¯•æ•°æ® (è¯·åˆ°â€œæ•°æ® -> å†å²æ•°æ®å¯¹æ¯”â€ä¸Šä¼ )`;
                    statusEl.style.color = "#dc2626";
                }
            }
        }
        if (id === 'mutual-aid') updateMutualAidSelects();
        if (id === 'poster-generator') updatePosterSelects();
        if (id === 'marginal-push') updateMpSchoolSelect();
        // å¦‚æœæ˜¯å•æ ¡ç»©æ•ˆæ¨¡å—ï¼Œè§¦å‘ä¸€æ¬¡ä¸‹æ‹‰æ¡†æ›´æ–°
        if (id === 'single-school-eval') updateSSESchoolSelect();
    }

    const DrillSystem = {
        history: [], // å¯¼èˆªå†å²æ ˆ
        currentData: null, // å½“å‰æš‚å­˜æ•°æ®
        exportData: null, // ğŸŸ¢ æ–°å¢ï¼šä¸“é—¨ç”¨äºå¯¼å‡ºçš„æ•°æ®ç¼“å­˜

        // 1. æ‰“å¼€å…¥å£
        open: function(title, studentList, scoreLabel = "æ€»åˆ†") {
            this.history = []; // æ¸…ç©ºå†å²
            this.currentData = { title, list: studentList, scoreLabel };
            
            // ğŸŸ¢ ç¼“å­˜å¯¼å‡ºæ•°æ®ï¼šå¦‚æœæ˜¯æ™®é€šåå•ï¼Œç›´æ¥ç¼“å­˜å­¦ç”Ÿåˆ—è¡¨
            this.exportData = { type: 'list', data: studentList, fileName: title };
            
            // ğŸŸ¢ æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’® (é˜²æ­¢ä¹‹å‰è¢«éšè—)
            const btn = document.getElementById('drill-export-btn');
            if(btn) btn.classList.remove('hidden');

            document.getElementById('drill-modal').style.display = 'flex';
            this.renderClassView();
        },

        // ğŸŸ¢ æ–°å¢ï¼šé€šç”¨å¯¼å‡ºåŠŸèƒ½
        exportExcel: function() {
            if (!this.exportData || !this.exportData.data) return alert("å½“å‰æ— æ•°æ®å¯å¯¼å‡º");
            
            const wb = XLSX.utils.book_new();
            let ws = null;
            const filename = (this.exportData.fileName || "å¯¼å‡ºæ•°æ®") + ".xlsx";

            if (this.exportData.type === 'gap') {
                // ğŸ…°ï¸ å¯¼å‡ºä¸´ç•Œç”Ÿ/æ½œåŠ›ç”Ÿåˆ†ææ•°æ® (ç‰¹æ®Šè¡¨å¤´)
                const headers = ['ç­çº§', 'å§“å', 'å½“å‰æ€»åˆ†', 'è·ç›®æ ‡åˆ†å·®', 'å»ºè®®è¡¥æ•‘/æ½œåŠ›å­¦ç§‘', 'è¯¥ç§‘ä¸å¹´çº§å‡åˆ†å·®'];
                const data = [headers];
                this.exportData.data.forEach(item => {
                    // å»é™¤HTMLæ ‡ç­¾ (æå–çº¯æ–‡æœ¬)
                    const cleanSub = item.worstSub.replace(/<[^>]+>/g, ""); 
                    data.push([
                        item.class, 
                        item.name, 
                        item.total, 
                        item.scoreGap.toFixed(1), 
                        cleanSub, 
                        item.worstDiff
                    ]);
                });
                ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:10}, {wch:10}, {wch:10}, {wch:12}, {wch:30}, {wch:15}];

            } else {
                // ğŸ…±ï¸ å¯¼å‡ºæ™®é€šå­¦ç”Ÿåå• (å¦‚ç‚¹å‡»"è¾¾æ ‡äººæ•°"æ—¶)
                const headers = ['ç­çº§', 'å§“å', 'è€ƒå·', 'æ€»åˆ†', 'å…¨é•‡æ’å'];
                const data = [headers];
                this.exportData.data.forEach(s => {
                    data.push([
                        s.class, 
                        s.name, 
                        s.id, 
                        s.total, 
                        safeGet(s, 'ranks.total.township', '-')
                    ]);
                });
                ws = XLSX.utils.aoa_to_sheet(data);
            }

            XLSX.utils.book_append_sheet(wb, ws, "å¯¼å‡ºæ•°æ®");
            XLSX.writeFile(wb, filename);
        },

        // 2. æ¸²æŸ“ç­çº§è§†å›¾
        renderClassView: function() {
            const { title, list, scoreLabel } = this.currentData;
            document.getElementById('drill-title').innerText = title;
            document.getElementById('drill-back-btn').classList.add('hidden');

            // æŒ‰ç­çº§åˆ†ç»„
            const classMap = {};
            list.forEach(s => {
                if (!classMap[s.class]) classMap[s.class] = [];
                classMap[s.class].push(s);
            });

            // æ’åºç­çº§
            const classes = Object.keys(classMap).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));

            let html = `<div class="drill-class-grid">`;
            classes.forEach(cls => {
                const count = classMap[cls].length;
                html += `
                    <div class="drill-class-card" onclick="DrillSystem.renderStudentView('${cls}')">
                        <div class="drill-label">${cls}</div>
                        <div class="drill-val">${count} äºº</div>
                        <div class="drill-label" style="font-size:10px;">ç‚¹å‡»æŸ¥çœ‹åå• &gt;</div>
                    </div>`;
            });
            html += `</div>`;

            if(list.length === 0) html = '<div style="text-align:center; padding:30px; color:#999;">æš‚æ— ç›¸å…³å­¦ç”Ÿæ•°æ®</div>';

            document.getElementById('drill-content').innerHTML = html;
            document.getElementById('drill-footer').innerText = `åˆè®¡: ${list.length} äºº`;
        },

        // 3. æ¸²æŸ“å­¦ç”Ÿåå•è§†å›¾
        renderStudentView: function(className) {
            const { list, scoreLabel } = this.currentData;
            this.history.push('class_view');
            
            document.getElementById('drill-title').innerText = `${className} - åå•`;
            document.getElementById('drill-back-btn').classList.remove('hidden');

            const students = list.filter(s => s.class === className).sort((a,b) => b.total - a.total);

            let html = `<div class="drill-stu-list">`;
            students.forEach(s => {
                html += `
                    <div class="drill-stu-tag">
                        <span style="cursor:pointer;" onclick="jumpToStudent('${s.name}', '${s.school}', '${s.class}'); document.getElementById('drill-modal').style.display='none';">${s.name}</span>
                        <span class="drill-stu-score">${s.total}</span>
                    </div>`;
            });
            html += `</div>`;
            
            document.getElementById('drill-content').innerHTML = html;
        },

        // 4. è¿”å›ä¸Šä¸€çº§
        goBack: function() {
            if (this.history.length > 0) {
                this.history.pop();
                this.renderClassView();
            }
        }
    };

    // è¾…åŠ©ï¼šå„æ¨¡å—çš„ç‚¹å‡»å¤„ç†å™¨
    function handleIndicatorClick(schoolName, type) {
        if (!SCHOOLS[schoolName]) return;
        
        // è·å–å½“å‰è®¾å®šçš„åˆ’çº¿
        const r1 = parseInt(document.getElementById('ind1').value);
        const r2 = parseInt(document.getElementById('ind2').value);
        if (!r1 || !r2) return alert("è¯·å…ˆè®¾ç½®æŒ‡æ ‡å‚æ•°");

        const allScores = RAW_DATA.map(s => s.total).sort((a,b)=>b-a);
        const line = type === 'ind1' ? (allScores[r1-1] || 0) : (allScores[r2-1] || 0);
        const title = `${schoolName} - ${type==='ind1'?'æŒ‡æ ‡ä¸€':'æŒ‡æ ‡äºŒ'}è¾¾æ ‡åå• (çº¿â‰¥${line})`;

        // ç­›é€‰å­¦ç”Ÿ
        const students = SCHOOLS[schoolName].students.filter(s => s.total >= line);
        
        DrillSystem.open(title, students);
    }

    function handleHighClick(schoolName) {
        if (!SCHOOLS[schoolName]) return;
        // 9å¹´çº§é»˜è®¤490ï¼Œæˆ–è€…è¿™é‡Œå¯ä»¥åšæˆåŠ¨æ€çš„
        const line = 490; 
        const students = SCHOOLS[schoolName].students.filter(s => s.total >= line);
        DrillSystem.open(`${schoolName} - é«˜åˆ†æ®µ(â‰¥${line})åå•`, students);
    }

    function handleExcludedClick(schoolName) {
        if (!SCHOOLS[schoolName]) return;
        const s = SCHOOLS[schoolName];
        // é‡æ–°è®¡ç®—å‰”é™¤é€»è¾‘
        const sorted = [...s.students].sort((a,b) => a.total - b.total); // å‡åº
        const excN = s.bottom3 ? s.bottom3.excN : 0;
        
        // å–æœ€ä½åˆ†çš„ N ä¸ª
        const students = sorted.slice(0, excN).sort((a,b) => b.total - a.total); // å±•ç¤ºæ—¶æŒ‰åˆ†é™åºå¥½çœ‹ç‚¹
        
        DrillSystem.open(`${schoolName} - å1/3æ ¸ç®—å‰”é™¤åå• (å…±${excN}äºº)`, students);
    }

    // === æ¸²æŸ“é«˜åˆ†æ®µè¡¨æ ¼ ===
    function renderHighScoreTable() {
        const tbody = document.querySelector('#tb-high-score tbody');
        tbody.innerHTML = '';
        
        if (!CONFIG.name || !CONFIG.name.includes('9')) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ğŸš« å½“å‰é 9 å¹´çº§æ¨¡å¼ï¼Œæ— é«˜åˆ†æ®µæ ¸ç®—æ•°æ®ã€‚</td></tr>';
            return;
        }
        if (Object.keys(SCHOOLS).length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">è¯·å…ˆä¸Šä¼ æ•°æ®</td></tr>';
            return;
        }

        // 1. æå–æ‰€æœ‰å­¦æ ¡æ•°æ®
        const list = Object.values(SCHOOLS).map(s => {
            const hs = s.highScoreStats || { count: 0, ratio: 0, score: 0 };
            return {
                name: s.name,
                count: s.metrics.total ? s.metrics.total.count : 0,
                hsCount: hs.count,
                hsRatio: hs.ratio,
                score: hs.score
            };
        });

        // 2. æ’åºï¼šæŒ‰é«˜åˆ†èµ‹åˆ†é™åº
        list.sort((a,b) => b.score - a.score);

        // 3. æ¸²æŸ“æ‰€æœ‰è¡Œ (æ²¡æœ‰ slice)
        let html = '';
        list.forEach((d, i) => {
            const isMySchool = d.name === MY_SCHOOL;
            html += `<tr class="${isMySchool?'bg-highlight':''}">
                <td>${d.name}</td>
                <td>${d.count}</td>
                <td style="font-weight:bold;">
                    <!-- æ·»åŠ ç‚¹å‡»äº‹ä»¶ -->
                    <span class="clickable-num" onclick="handleHighClick('${d.name}')" title="ç‚¹å‡»æŸ¥çœ‹é«˜åˆ†å­¦ç”Ÿåå•">
                        ${d.hsCount}
                    </span>
                </td>
                <td>${(d.hsRatio * 100).toFixed(2)}%</td>
                <td class="text-red" style="font-size:1.1em; font-weight:bold;">${d.score.toFixed(2)}</td>
                ${getRankHTML(i + 1)}
            </tr>`;
        });
        tbody.innerHTML = html;
        
        // æ›´æ–° UI æç¤º
        console.log(`å·²æ¸²æŸ“ ${list.length} æ‰€å­¦æ ¡çš„é«˜åˆ†æ•°æ®`);
    }

    // === å¯¼å‡ºé«˜åˆ†æ®µ Excel ===
    function exportHighScoreExcel() {
        if (!Object.keys(SCHOOLS).length) return alert("æ— æ•°æ®");
        if (!CONFIG.name.includes('9')) return alert("é9å¹´çº§æ¨¡å¼æ— æ­¤æ•°æ®");

        const wb = XLSX.utils.book_new();
        const headers = ["å­¦æ ¡åç§°", "å®è€ƒäººæ•°", "é«˜åˆ†äººæ•°(â‰¥490)", "é«˜åˆ†ç‡", "é«˜åˆ†èµ‹åˆ†(70)", "æ’å"];
        const wsData = [headers];

        const list = Object.values(SCHOOLS).map(s => {
            const hs = s.highScoreStats || { count: 0, ratio: 0, score: 0 };
            return {
                name: s.name,
                count: s.metrics.total ? s.metrics.total.count : 0,
                hsCount: hs.count,
                hsRatio: hs.ratio,
                score: hs.score
            };
        }).sort((a,b) => b.score - a.score);

        list.forEach((d, i) => {
            wsData.push([
                d.name,
                d.count,
                d.hsCount,
                getExcelPercent(d.hsRatio),
                getExcelNum(d.score),
                i + 1
            ]);
        });

        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "é«˜åˆ†æ®µæ ¸ç®—");
        XLSX.writeFile(wb, `é«˜åˆ†æ®µæ ¸ç®—_${CONFIG.name}.xlsx`);
    }

    // ================= æ•°æ®å¤„ç† =================
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (isArchiveLocked()) return alert("â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œç¦æ­¢ä¸Šä¼ æ–°æ•°æ®");
        if (!CURRENT_COHORT_ID) return alert("è¯·å…ˆé€‰æ‹©æˆ–æ–°å»ºå±Šåˆ«");
        if (!CURRENT_EXAM_ID) {
            setCurrentExamMeta();
            if (!CURRENT_EXAM_ID) return;
        }
        const files = e.target.files; 
        if(!files.length) return;

        // ä½¿ç”¨ Perf.runAsync åŒ…è£¹ï¼Œå®ç°åŠ è½½åŠ¨ç”» + é˜²å¡æ­»
        Perf.runAsync(async () => {
            // é‡ç½®æ•°æ®
            RAW_DATA = []; SCHOOLS = {}; SUBJECTS = []; TEACHER_MAP = {}; TEACHER_STATS = {}; 
            TEACHER_TOWNSHIP_RANKINGS = {}; MARGINAL_STUDENTS = {}; POTENTIAL_STUDENTS_CACHE = []; TOWNSHIP_RANKING_DATA = {}; MY_SCHOOL = "";
            document.getElementById('teacherCardsContainer').innerHTML = ''; 
            document.getElementById('teacherComparisonTable').querySelector('tbody').innerHTML = '';
            document.getElementById('teacher-township-ranking-container').innerHTML = ''; 
            document.getElementById('studentDetailTable').querySelector('tbody').innerHTML = '';
            document.getElementById('marginal-student-results').innerHTML = '';
            
            // è€—æ—¶æ“ä½œ
            for(let f of files) await readExcel(f);
            SUBJECTS.sort(sortSubjects);
            await processData(); // è¿™æ˜¯ä¸€ä¸ªè€—æ—¶æ“ä½œ

            // ğŸŸ£ Cohortï¼šå†™å…¥è€ƒè¯•å¿«ç…§å¹¶æ‰§è¡Œæ™ºèƒ½åŒ¹é…
            await CohortDB.syncCurrentExam();
            
            // ğŸŸ¢ [æ–°å¢] å¤„ç†å®Œæ•°æ®åï¼Œç«‹å³åŒæ­¥åˆ°äº‘ç«¯ (ä»…ç®¡ç†å‘˜æœ‰æ•ˆ)
            // æ³¨æ„ï¼šå› ä¸ºæ˜¯å¼‚æ­¥ï¼Œæˆ‘ä»¬åœ¨åå°é»˜é»˜ä¿å­˜ï¼Œä¸é˜»å¡ç•Œé¢æ˜¾ç¤º
            saveCloudData().then(() => {
                console.log("è‡ªåŠ¨å¤‡ä»½å®Œæˆ");
            }).catch(e => console.error("è‡ªåŠ¨å¤‡ä»½å¤±è´¥", e));
            renderTables();            
            // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰æ¡†
            updateSchoolSelect(); updateMySchoolSelect(); updateStudentSchoolSelect(); updateMarginalSchoolSelect(); 
            updateClassSelect(); updateSegmentSelects(); updateClassCompSchoolSelect(); updatePotentialSchoolSelect(); 
            updateDiagnosisSelects(); updateCorrelationSchoolSelect(); updateSeatAdjSelects(); updateProgressSchoolSelect(); 
            updateMutualAidSelects(); updateMpSchoolSelect(); 

            document.getElementById('msg-box').innerText = `âœ… æˆåŠŸå¯¼å…¥ ${Object.keys(SCHOOLS).length} æ‰€å­¦æ ¡ï¼Œå…± ${RAW_DATA.length} åå­¦ç”Ÿ`;
            UI.toast(`âœ… å¯¼å…¥æˆåŠŸï¼åŒ…å« ${RAW_DATA.length} æ¡æ•°æ®`, 'success');
        }, "æ­£åœ¨è§£æ Excel å¹¶è®¡ç®—æ’å...");
    });

        async function readExcel(file) {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, {type:'array'});
        wb.SheetNames.forEach(sname => {
            if(sname.includes('äºŒæ¨¡æœ¬æ ¡') || sname.includes('å„ç­å„ç§‘') || sname.includes('æ¨ªå‘å¯¹æ¯”')) return;
            const json = XLSX.utils.sheet_to_json(wb.Sheets[sname], {header:1});
            if(json.length < 2) return;
            parseRows(json, sname);
        });
    }

    // =========== ğŸ”¥ ä¿®æ”¹é‡ç‚¹ï¼šparseRows å…¨è‡ªåŠ¨ç‰ˆ (å«ç¼ºè€ƒå½•å…¥) ===========
    // é€»è¾‘è¯´æ˜ï¼š
    // 1. åªè¦Excelé‡Œæœ‰å§“åï¼Œå°±å½•å…¥ç³»ç»Ÿï¼Œä½œä¸ºã€åœ¨ç±äººæ•°ã€‘çš„åŸºæ•°ã€‚
    // 2. åªæœ‰å½“å­¦ç”Ÿæœ‰æœ‰æ•ˆåˆ†æ•°æ—¶ï¼Œæ ‡è®° hasValidScore=trueï¼Œä½œä¸ºã€å®è€ƒäººæ•°ã€‘çš„åŸºæ•°ã€‚
    function parseRows(rows, defaultSchool) {
        const headers = rows[0].map(h => String(h).trim());
        
        // 1. åˆå§‹åŒ–ç´¢å¼•æ˜ å°„
        const idxMap = { name: -1, id: -1, school: -1, class: -1, examRoom: -1, scores: {} };

        // 2. åˆ«ååŒ¹é…
        const aliasMap = {
            name: ['å§“å', 'å­¦ç”Ÿå§“å', 'å­¦ç”Ÿ', 'Name', 'è€ƒç”Ÿå§“å'],
            id: ['è€ƒå·', 'å­¦å·', 'å‡†è€ƒè¯å·', 'ID', 'è€ƒç”Ÿå·'],
            // school: å¿½ç•¥è¡¨å†…å­¦æ ¡åˆ—ï¼Œå¼ºåˆ¶ä½¿ç”¨Sheetå
            class: ['ç­çº§', 'ç­', 'ç­æ¬¡', 'Class', 'è¡Œæ”¿ç­'],
            examRoom: ['è€ƒåœº', 'è€ƒå®¤', 'Room', 'è€ƒè¯•åœ°ç‚¹']
        };
        
        // å¢åŠ å®¹é”™ï¼šå¸¸è§çš„å­¦ç§‘åç§°
        const subjectMap = { 'è¯­æ–‡':'è¯­æ–‡', 'æ•°å­¦':'æ•°å­¦', 'è‹±è¯­':'è‹±è¯­', 'ç‰©ç†':'ç‰©ç†', 'åŒ–å­¦':'åŒ–å­¦', 'æ”¿æ²»':'æ”¿æ²»', 'é“æ³•':'æ”¿æ²»', 'é“å¾·ä¸æ³•æ²»':'æ”¿æ²»', 'å†å²':'å†å²', 'åœ°ç†':'åœ°ç†', 'ç”Ÿç‰©':'ç”Ÿç‰©', 'ç§‘å­¦':'ç§‘å­¦' };
        const excludeKeywords = ['æ’', 'æ¬¡', 'çº§', 'Rank', 'èµ‹åˆ†', 'æ ‡å‡†åˆ†', 'Tåˆ†', 'æŠ˜ç®—', 'ç­‰çº§', 'ä¼˜åŠ£'];

        // 3. æ‰«æè¡¨å¤´
        headers.forEach((h, i) => {
            const hTrim = h.replace(/\s+/g, '');
            for (const [key, aliases] of Object.entries(aliasMap)) {
                if (aliases.some(alias => hTrim.includes(alias))) idxMap[key] = i;
            }
            for (const [key, standardName] of Object.entries(subjectMap)) {
                if(h.includes(key) && !excludeKeywords.some(ex => h.includes(ex))) {
                    if(!idxMap.scores[standardName]) idxMap.scores[standardName] = [];
                    idxMap.scores[standardName].push(i);
                    if(!SUBJECTS.includes(standardName)) SUBJECTS.push(standardName);
                }
            }
        });

        if(CONFIG.analysisSubs && CONFIG.analysisSubs !== 'auto') {
            SUBJECTS = SUBJECTS.filter(s => CONFIG.analysisSubs.includes(s));
        }
        const subsForTotal = CONFIG.totalSubs === 'auto' ? SUBJECTS : CONFIG.totalSubs;

        // 1. å…¨è§’è½¬åŠè§’å·¥å…· (é’ˆå¯¹åˆ†æ•°å½•å…¥é”™è¯¯)
        const toHalfWidth = (str) => {
            if (typeof str !== 'string') return str;
            return str.replace(/[\uff01-\uff5e]/g, (ch) => String.fromCharCode(ch.charCodeAt(0) - 0xfee0))
                      .replace(/\u3000/g, ' ');
        };

        // 2. å§“åæ¸…æ´—å·¥å…· (å»é™¤ç©ºæ ¼ã€ä¸å¯è§å­—ç¬¦)
        const cleanNameStr = (str) => {
            if (!str) return "";
            return String(str).replace(/\s+/g, '').replace(/[\u200b-\u200f\uFEFF]/g, '');
        };

        // 4. éå†æ•°æ® (æ ¸å¿ƒä¿®æ”¹åŒº)
        for(let i=1; i<rows.length; i++) {
            const r = rows[i]; 
            if(!r || !r.length) continue;

            // --- ä¿®æ”¹ç‚¹ A: å§“åå¤„ç† ---
            // å¦‚æœæ‰¾ä¸åˆ°å§“ååˆ—ï¼Œæˆ–è€…å•å…ƒæ ¼ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ "åŒ¿åè€ƒç”Ÿ_è¡Œå·"
            let rawName = idxMap.name !== -1 ? (r[idxMap.name] || "") : "";
            let nameStr = cleanNameStr(rawName);

            if (!nameStr || nameStr === '-' || nameStr === '0' || nameStr === '0.0' || nameStr === 'å§“å') {
                nameStr = `è€ƒç”Ÿ${String(i).padStart(3, '0')}`;
            }

            // --- ä¿®æ”¹ç‚¹ B: ç­çº§å¤„ç† ---
            // å¦‚æœæ‰¾ä¸åˆ°ç­çº§åˆ—ï¼Œé»˜è®¤ä¸º "æœªåˆ†ç­"
            let classStr = "æœªåˆ†ç­";
            if (idxMap.class !== -1 && r[idxMap.class]) {
                classStr = normalizeClass(r[idxMap.class]);
            }

            const stu = { 
                name: nameStr, 
                id: idxMap.id !== -1 ? r[idxMap.id] : '-', 
                
                // å¼ºåˆ¶ä½¿ç”¨Sheetåä½œä¸ºå­¦æ ¡
                school: defaultSchool, 
                class: classStr, 
                
                examRoom: idxMap.examRoom !== -1 ? r[idxMap.examRoom] : '-', 
                scores: {}, 
                total: 0,
                hasValidScore: false 
            };
            
            // æ•°æ®è¯»å–é€»è¾‘
            let hasAnyScore = false;
            SUBJECTS.forEach(sub => {
                const colIndices = idxMap.scores[sub];
                if(colIndices && colIndices.length > 0) {
                    let subSum = 0;
                    let validSub = false;
                    colIndices.forEach(idx => {
                        let rawVal = r[idx];
                        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå…ˆå°è¯•è½¬åŠè§’
                        if (typeof rawVal === 'string') {
                            rawVal = toHalfWidth(rawVal).trim();
                        }
                        let val = parseFloat(rawVal);

                        // å¦‚æœè§£æç»“æœä¸æ˜¯æ•°å­—ï¼Œè¿›è¡Œæ™ºèƒ½æ¸…æ´—
                        if (isNaN(val)) {
                            const strVal = String(rawVal || "").trim().toUpperCase(); // è½¬å¤§å†™å»ç©ºæ ¼
                            
                            // å®šä¹‰ç”±äºç‰¹æ®ŠåŸå› å¯¼è‡´çš„â€œ0åˆ†â€å…³é”®è¯
                            // ç¼ºè€ƒ(ABS/Q/ç¼º), ä½œå¼Š(CHE/è¿çºª), ç—…å‡(BJ), ç¼“è€ƒ ç­‰
                            const zeroKeywords = ["ç¼º", "ABS", "ä½œå¼Š", "è¿çºª", "ç—…å‡", "ç¼“è€ƒ", "å–æ¶ˆ", "é›¶åˆ†", "Q", "CHE"];
                            
                            // å¦‚æœåŒ…å«ä¸Šè¿°å…³é”®è¯ï¼Œå¼ºåˆ¶è§†ä¸º 0 åˆ† (å‚ä¸æ’å)
                            if (zeroKeywords.some(key => strVal.includes(key))) {
                                val = 0;
                            } 
                            // å¦åˆ™ï¼Œè¯¥æ•°æ®ä¾ç„¶ä¸º NaNï¼Œåç»­é€»è¾‘ä¼šè‡ªåŠ¨â€œæ’é™¤â€ (ä¸å‚ä¸å‡åˆ†è®¡ç®—)
                        }
                        if(!isNaN(val)) { subSum += val; validSub = true; }
                    });
                    if(validSub) {
                        stu.scores[sub] = parseFloat(subSum.toFixed(2));
                        stu.hasValidScore = true;
                        hasAnyScore = true;
                        if (subsForTotal.includes(sub)) stu.total += subSum;
                    }
                }
            });

            // å¦‚æœè¿™ä¸€è¡Œå®Œå…¨æ²¡æœ‰æˆç»©ï¼Œå¹¶ä¸”åå­—ä¹Ÿæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¤§æ¦‚ç‡æ˜¯ç©ºè¡Œï¼Œè·³è¿‡
            if (!hasAnyScore && nameStr.startsWith("è€ƒç”Ÿ")) continue;

            stu.total = parseFloat(stu.total.toFixed(2));
            RAW_DATA.push(stu);
            
            if(!SCHOOLS[stu.school]) SCHOOLS[stu.school] = { name: stu.school, students: [], metrics: {}, rankings: {} };
            SCHOOLS[stu.school].students.push(stu);
        }
    }



    function normalizeClass(classStr) {
        if (!classStr) return '';
        let normalized = String(classStr).replace(/ç­/g, '').replace(/\s/g, '');
        if (normalized.includes('.')) return normalized;
        else if (/^\d+$/.test(normalized)) {
            const grade = String(getActiveGrade() || '6');
            return `${grade}.${normalized}`;
        } else if (/^[6789]\d+$/.test(normalized)) { const grade = normalized.charAt(0); const classNum = normalized.substring(1); return `${grade}.${classNum}`; }
        return classStr;
    }
    
    async function processData() {
        // 1. é¢„å¤„ç†
        // ğŸŸ¢ [ä¿®æ”¹å¼€å§‹]ï¼šå¼•å…¥å•æ ¡æ¨¡å¼åˆ¤æ–­ä¸é˜ˆå€¼è®¡ç®—ä¼˜åŒ–
                
        // é‡æ–°æ„å»ºä¸´æ—¶çš„ SCHOOLS é”®åˆ—è¡¨ä»¥æ£€æµ‹æ•°é‡
        const schoolSet = new Set(RAW_DATA.map(s => s.school));
        const isSingleSchool = schoolSet.size === 1;

        // è·å–ç”¨æˆ·è¾“å…¥çš„æŒ‡æ ‡å‚æ•° (ç”¨äºå•æ ¡æ¨¡å¼ä¸‹çš„ç²¾ç¡®åˆ’çº¿)
        // ç¡®ä¿ window.SYS_VARS å·²åˆå§‹åŒ–
        const input1 = parseFloat(window.SYS_VARS?.indicator?.ind1) || 0;
        const input2 = parseFloat(window.SYS_VARS?.indicator?.ind2) || 0;

        const keys = [...SUBJECTS, 'total'];
        keys.forEach(k => {
            const vals = RAW_DATA.map(s => k==='total'?s.total:s.scores[k]).filter(v=>v!==undefined).sort((a,b)=>b-a);
            
            if(vals.length) {
                // å¦‚æœæ˜¯å•æ ¡æ¨¡å¼ï¼Œä¸”æ˜¯æ€»åˆ†ï¼Œä¸”ç”¨æˆ·è¾“å…¥äº†æœ‰æ•ˆçš„åæ¬¡æŒ‡æ ‡
                if (isSingleSchool && k === 'total' && input1 > 0 && input2 > 0) {
                    // ğŸ« å•æ ¡æ¨¡å¼ç‰¹æ®Šé€»è¾‘ï¼š
                    // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„â€œå¹´çº§åæ¬¡â€æ¥åæ¨åˆ†æ•°çº¿ï¼Œè¿™åœ¨å•æ ¡æœˆè€ƒä¸­æ¯”ç™¾åˆ†æ¯”æ›´ç¨³å®š
                    const idx1 = Math.min(Math.floor(input1), vals.length) - 1;
                    const idx2 = Math.min(Math.floor(input2), vals.length) - 1;
                    
                    THRESHOLDS[k] = { 
                        exc: vals[Math.max(0, idx1)] || 0, 
                        pass: vals[Math.max(0, idx2)] || 0 
                    };
                    console.log(`[å•æ ¡æ¨¡å¼] æ€»åˆ†åˆ’çº¿é”å®š: ä¼˜=${THRESHOLDS[k].exc} (Top${input1}), è‰¯=${THRESHOLDS[k].pass} (Top${input2})`);
                } else {
                    // ğŸŒ å¤šæ ¡è”è€ƒæ¨¡å¼ / å•ç§‘é»˜è®¤é€»è¾‘ï¼šæŒ‰å›ºå®šæ¯”ä¾‹
                    // 9å¹´çº§ 15%ï¼Œå…¶ä»– 20%
                    const excRatio = (CONFIG.name && CONFIG.name.includes('9')) ? 0.15 : 0.2;
                    // å•æ ¡æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šï¼Œå•ç§‘ä¾ç„¶æ²¿ç”¨ç™¾åˆ†æ¯”ï¼Œä½†å¯ä»¥è€ƒè™‘åç»­å¢åŠ å•ç§‘æ‰‹åŠ¨è®¾ç½®
                    THRESHOLDS[k] = { 
                        exc: vals[Math.floor(vals.length * excRatio)] || 0, 
                        pass: vals[Math.floor(vals.length * 0.5)] || 0 
                    };
                }
            }
        });

        // 2. å‘¼å« Worker
        const result = await WorkerAPI.run({ RAW_DATA, SUBJECTS, CONFIG, THRESHOLDS, SCHOOLS });
        
        // 3. æ¥æ”¶ç»“æœ (RAW_DATA æ˜¯å…¨æ–°çš„ï¼Œå¸¦æœ‰æ’åçš„æ•°ç»„)
        RAW_DATA = result.RAW_DATA; 

        // 4. ã€å…³é”®ä¿®å¤ã€‘é‡å»º SCHOOLS ä¸æ–° RAW_DATA çš„å…³è”
        // Worker è¿”å›äº†å…¨æ–°çš„ RAW_DATAï¼Œå¿…é¡»æŠŠè¿™äº›æ–°å¯¹è±¡é‡æ–°å¡å› SCHOOLS çš„ students æ•°ç»„é‡Œ
        // å¦åˆ™ SCHOOLS é‡Œå­˜çš„è¿˜æ˜¯æ—§å¯¹è±¡(æ— æ’å)ï¼Œå¯¼è‡´"æœ¬æ ¡"æŸ¥è¯¢å¤±æ•ˆ
        
        // A. å…ˆæ¸…ç©ºæ‰€æœ‰å­¦æ ¡çš„å­¦ç”Ÿåˆ—è¡¨
        Object.keys(SCHOOLS).forEach(k => { 
            if(SCHOOLS[k]) SCHOOLS[k].students = []; 
        });
        
        // B. é‡æ–°åˆ†é…æ–°å­¦ç”Ÿå¯¹è±¡
        RAW_DATA.forEach(stu => {
            if (!SCHOOLS[stu.school]) {
                // é˜²æ­¢æœ‰æ¼ç½‘ä¹‹é±¼
                SCHOOLS[stu.school] = { name: stu.school, students: [], metrics: {}, rankings: {} };
            }
            SCHOOLS[stu.school].students.push(stu);
        });

        // 5. æ›´æ–°ç»Ÿè®¡æŒ‡æ ‡ (metrics)
        const newSchools = result.SCHOOLS;
        Object.keys(newSchools).forEach(k => {
            if (SCHOOLS[k]) {
                const { students, ...metricsData } = newSchools[k]; 
                // åªåˆå¹¶ç»Ÿè®¡æ•°æ®ï¼Œä¸åŠ¨åˆšæ‰é‡æ–°ç”Ÿæˆçš„ students æ•°ç»„
                Object.assign(SCHOOLS[k], metricsData);
            }
        });

        // 6. è¡¥å…¨ç­çº§æ’å
        calculateClassRanksOnly(); 
    
        if (typeof fuseInstance !== 'undefined') fuseInstance = null; // å¼ºåˆ¶é‡å»ºç´¢å¼•
    
        if (isSingleSchool) {
            console.log("ğŸ« æ£€æµ‹åˆ°å•æ ¡æ•°æ®ï¼Œè‡ªåŠ¨åˆ‡æ¢ UI ä¸ºå¹´çº§æ¨¡å¼...");
            
            // 1. éšè—æ¨ªå‘å¯¹æ¯”å…¥å£ (è‡ªå·±è·Ÿè‡ªå·±æ²¡æ³•æ¯”)
            const analysisMod = document.getElementById('analysis');
            if(analysisMod) analysisMod.style.display = 'none';

            // 2. ä¿®æ”¹è¡¨å¤´æ–‡å­— (å»¶è¿Ÿæ‰§è¡Œç¡®ä¿ DOM å·²æ¸²æŸ“)
            // å°† "å…¨é•‡"ã€"é•‡æ’" æ›¿æ¢ä¸º "å¹´çº§"ã€"çº§æ’"ï¼Œæ¶ˆé™¤æ­§ä¹‰
            setTimeout(() => {
                document.querySelectorAll('th').forEach(th => {
                    if(th.innerText.includes('é•‡æ’')) th.innerHTML = th.innerHTML.replace('é•‡æ’', 'çº§æ’');
                    if(th.innerText.includes('å…¨é•‡')) th.innerHTML = th.innerHTML.replace('å…¨é•‡', 'å¹´çº§');
                });
            }, 500);
        } else {
            const analysisMod = document.getElementById('analysis');
            if(analysisMod) analysisMod.style.display = 'block';
        }

        try {
            console.log("ğŸ”„ æ­£åœ¨è‡ªåŠ¨æ‰§è¡Œè¡ç”Ÿè®¡ç®—...");
            
            // 1. è‡ªåŠ¨è®¡ç®—æŒ‡æ ‡ç”Ÿ (ä¾èµ– RAW_DATA å’Œ TARGETS)
            // å³ä½¿æ²¡æœ‰è®¾ç½®åˆ’çº¿ï¼Œè¿è¡Œä¸€ä¸‹ä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œåªæ˜¯å¾—åˆ†ä¸º0
            if (typeof calcIndicators === 'function' && isIndicatorCalcAllowed()) {
                calcIndicators(true); // ä¼ å…¥ true è¡¨ç¤ºé™é»˜æ¨¡å¼(å¯é€‰ï¼Œè§†å‡½æ•°å®ç°è€Œå®š)
            }

            // 2. è‡ªåŠ¨è®¡ç®—ç»¼åˆæ€»æ¦œ (ä¾èµ–å‰ä¸€æ­¥è®¡ç®—å‡ºçš„ scoreInd)
            if (typeof calcSummary === 'function') {
                calcSummary(true);    // ä¼ å…¥ true è¡¨ç¤ºé™é»˜æ¨¡å¼
            }

        } catch (e) {
            console.warn("âš ï¸ è‡ªåŠ¨è®¡ç®—è¡ç”ŸæŒ‡æ ‡æ—¶é‡åˆ°éè‡´å‘½é”™è¯¯:", e);
        }

        // 7. è‡ªåŠ¨ä¿å­˜
        if(typeof DB !== 'undefined') {
            // âœ‹ ğŸ”´ [ä¿®å¤å¼€å§‹]ï¼šä¸è¦å†™æ­» 'autosave_backup'ï¼Œè€Œæ˜¯è·å–å½“å‰é€‰ä¸­çš„é¡¹ç›® KEY
            // å¦‚æœè·å–ä¸åˆ°ï¼Œæ‰å…œåº•ä½¿ç”¨ 'autosave_backup'
            const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup';
            
            DB.save(currentKey, { 
                timestamp: Date.now(), 
                RAW_DATA, SCHOOLS, SUBJECTS, THRESHOLDS, TEACHER_MAP, CONFIG, MY_SCHOOL 
            });
            console.log(`âœ… æ•°æ®å·²è‡ªåŠ¨ä¿å­˜è‡³: ${currentKey}`);
            // ğŸ‘† ğŸŸ¢ [ä¿®å¤ç»“æŸ]
        }
    }

    // è¾…åŠ©ï¼šä»…è®¡ç®—ç­çº§æ’å
    function calculateClassRanksOnly() {
        const classes = {}; 
        RAW_DATA.forEach(s => { if (!classes[s.class]) classes[s.class] = []; classes[s.class].push(s); });
        
        Object.values(classes).forEach(group => {
            // æ€»åˆ†
            group.sort((a,b)=>b.total - a.total);
            group.forEach((s,i) => { if(!s.ranks) s.ranks={}; if(!s.ranks.total) s.ranks.total={}; s.ranks.total.class = i+1; });
            // å•ç§‘
            SUBJECTS.forEach(sub => {
                const subGroup = group.filter(s => s.scores[sub] !== undefined).sort((a,b)=>b.scores[sub]-a.scores[sub]);
                subGroup.forEach((s,i) => { if(!s.ranks[sub]) s.ranks[sub]={}; s.ranks[sub].class = i+1; });
            });
        });
    }
    
    function calculateStudentRanks() {
        return;SUBJECTS.forEach(subject => {
            const subjectStudents = RAW_DATA.filter(s => s.scores[subject] !== undefined).sort((a, b) => b.scores[subject] - a.scores[subject]);
            subjectStudents.forEach((student, index) => {
                if (!student.ranks) student.ranks = {}; if (!student.ranks[subject]) student.ranks[subject] = {};
                if (index > 0 && student.scores[subject] === subjectStudents[index - 1].scores[subject]) student.ranks[subject].township = subjectStudents[index - 1].ranks[subject].township;
                else student.ranks[subject].township = index + 1;
            });
            Object.values(SCHOOLS).forEach(school => {
                const schStus = school.students.filter(s => s.scores[subject] !== undefined).sort((a,b) => b.scores[subject] - a.scores[subject]);
                schStus.forEach((s, i) => { if (!s.ranks[subject]) s.ranks[subject] = {}; if (i > 0 && s.scores[subject] === schStus[i - 1].scores[subject]) s.ranks[subject].school = schStus[i - 1].ranks[subject].school; else s.ranks[subject].school = i + 1; });
            });
            const classes = {}; RAW_DATA.forEach(student => { if (!classes[student.class]) classes[student.class] = []; classes[student.class].push(student); });
            Object.values(classes).forEach(classStudents => {
                const classSubjectStudents = classStudents.filter(s => s.scores[subject] !== undefined).sort((a, b) => b.scores[subject] - a.scores[subject]);
                classSubjectStudents.forEach((student, index) => { if (index > 0 && student.scores[subject] === classSubjectStudents[index - 1].scores[subject]) student.ranks[subject].class = classSubjectStudents[index - 1].ranks[subject].class; else student.ranks[subject].class = index + 1; });
            });
        });
        const totalStudents = RAW_DATA.filter(s => s.total !== undefined).sort((a, b) => b.total - a.total);
        totalStudents.forEach((student, index) => {
            if (!student.ranks) student.ranks = {}; if (!student.ranks.total) student.ranks.total = {};
            if (index > 0 && Math.abs(student.total - totalStudents[index - 1].total) < 0.0001) student.ranks.total.township = totalStudents[index - 1].ranks.total.township; else student.ranks.total.township = index + 1;
        });
         Object.values(SCHOOLS).forEach(school => {
            const schStus = school.students.sort((a,b) => b.total - a.total);
            schStus.forEach((s, i) => { if (i > 0 && Math.abs(s.total - schStus[i - 1].total) < 0.0001) s.ranks.total.school = schStus[i - 1].ranks.total.school; else s.ranks.total.school = i + 1; });
        });
        const classes = {}; RAW_DATA.forEach(student => { if (!classes[student.class]) classes[student.class] = []; classes[student.class].push(student); });
        Object.values(classes).forEach(classStudents => {
            const classTotalStudents = classStudents.sort((a, b) => b.total - a.total);
            classTotalStudents.forEach((student, index) => { if (index > 0 && Math.abs(student.total - classTotalStudents[index - 1].total) < 0.0001) student.ranks.total.class = classTotalStudents[index - 1].ranks.total.class; else student.ranks.total.class = index + 1; });
        });
    }

    function calculateRankings() {
        return;const doRank = (subject, key) => {
            const list = Object.values(SCHOOLS).filter(s => s.metrics[subject]);
            list.sort((a,b) => b.metrics[subject][key] - a.metrics[subject][key]);
            list.forEach((s, i) => {
                if(!s.rankings[subject]) s.rankings[subject] = {};
                if(i>0 && Math.abs(s.metrics[subject][key] - list[i-1].metrics[subject][key]) < 0.0001) s.rankings[subject][key] = list[i-1].rankings[subject][key]; else s.rankings[subject][key] = i + 1;
            });
        };
        [...SUBJECTS, 'total'].forEach(sub => { doRank(sub, 'avg'); doRank(sub, 'excRate'); doRank(sub, 'passRate'); });
        const max = { avg:0, exc:0, pass:0 };
        Object.values(SCHOOLS).forEach(s => { if(s.metrics.total) { max.avg = Math.max(max.avg, s.metrics.total.avg); max.exc = Math.max(max.exc, s.metrics.total.excRate); max.pass = Math.max(max.pass, s.metrics.total.passRate); } });
        Object.values(SCHOOLS).forEach(s => {
            if(s.metrics.total) {
                const m = s.metrics.total; const ratedAvg = max.avg > 0 ? (m.avg / max.avg * 60) : 0; const ratedExc = max.exc > 0 ? (m.excRate / max.exc * 70) : 0; const ratedPass = max.pass > 0 ? (m.passRate / max.pass * 70) : 0;
                m.ratedAvg = ratedAvg; m.ratedExc = ratedExc; m.ratedPass = ratedPass; s.score2Rate = ratedAvg + ratedExc + ratedPass;
            } else { s.score2Rate = 0; }
        });
        const list = Object.values(SCHOOLS); list.sort((a,b)=>b.score2Rate - a.score2Rate); list.forEach((s,i)=>s.rank2Rate = i+1);
        let maxBAvg = 0; list.forEach(s => maxBAvg = Math.max(maxBAvg, s.bottom3.avg));
        list.forEach(s => s.scoreBottom = maxBAvg ? (s.bottom3.avg/maxBAvg*40) : 0); list.sort((a,b)=>b.scoreBottom - a.scoreBottom).forEach((s,i)=>s.rankBottom = i+1);
    }

    function getRankHTML(rank, type = 'school') { let cls = 'rank-cell'; if(rank===1) cls += ' r-1'; if(rank===2) cls += ' r-2'; if(rank===3) cls += ' r-3'; return `<td class="${cls}">${rank}</td>`; }
    // æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ˜¯æ•°å­—ï¼Œä¿ç•™2ä½å°æ•°å±•ç¤ºï¼›å¦‚æœæ˜¯æ— æ•ˆå€¼ï¼Œæ˜¾ç¤º '-'
    // æ³¨æ„ï¼šè¿™åªæ”¹å˜æ˜¾ç¤ºï¼Œä¸æ”¹å˜ underlying calculation (åº•å±‚è®¡ç®—)
    function formatVal(val) {
        if (typeof val !== 'number' || isNaN(val)) return '-';
        // toFixed(2) ä¼šå››èˆäº”å…¥å¹¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå¦‚ 89.567 -> "89.57", 90 -> "90.00"
        return val.toFixed(2);
    }
    function formatRankDisplay(value, rank, type = 'school', isPercent = false) { const displayValue = isPercent ? (value * 100).toFixed(2) + '%' : value.toFixed(2); return `${displayValue} <span style="font-size:0.9em; color:#94a3b8">(${rank})</span>`; }

    function renderTables() {
        const tbTotal = document.querySelector('#tb-total tbody'); 
        
        // --- ğŸ“Š æ–°å¢ï¼šæ•°æ®ç»Ÿè®¡çœ‹æ¿é€»è¾‘ å¼€å§‹ ---
        // å¦‚æœæ•°æ®å­˜åœ¨ï¼Œä¸”é¡µé¢ä¸Šæœ‰ KPI å®¹å™¨ (æˆ‘ä»¬å¯ä»¥åŠ¨æ€æ’å…¥ä¸€ä¸ª)
        if(Object.keys(SCHOOLS).length > 0) {
            // è®¡ç®—å…¨é•‡æ•°æ®
            const totalStudents = RAW_DATA.length;
            const totalSchools = Object.keys(SCHOOLS).length;
            const allScores = RAW_DATA.map(s => s.total);
            const globalAvg = (allScores.reduce((a,b)=>a+b,0) / totalStudents).toFixed(1);
            const maxScore = Math.max(...allScores);

            // åœ¨çœ‹æ¿æ¨¡å—ä¸­æ¸²æŸ“KPI
            let dashboard = document.getElementById('macro-dashboard');
            if(!dashboard) {
                dashboard = document.createElement('div');
                dashboard.id = 'macro-dashboard';
                dashboard.className = 'fb-dashboard';
                dashboard.style.marginBottom = '25px';
                const watchSection = document.getElementById('macro-watch');
                if(watchSection) watchSection.appendChild(dashboard);
            }

            // æ¸²æŸ“å¡ç‰‡å†…å®¹
            dashboard.innerHTML = `
                <div class="fb-card">
                    <div class="fb-lbl">å‚è€ƒæ€»äººæ•°</div>
                    <div class="fb-val text-blue">${totalStudents}</div>
                    <div class="fb-lbl">è¦†ç›– ${totalSchools} æ‰€å­¦æ ¡</div>
                </div>
                <div class="fb-card">
                    <div class="fb-lbl">å…¨é•‡å¹³å‡åˆ†</div>
                    <div class="fb-val text-green">${globalAvg}</div>
                    <div class="fb-lbl">æ€»åˆ†åŸºå‡†çº¿</div>
                </div>
                <div class="fb-card">
                    <div class="fb-lbl">æœ€é«˜åˆ† (çŠ¶å…ƒ)</div>
                    <div class="fb-val text-orange">${maxScore}</div>
                    <div class="fb-lbl">åˆ†å·® ${(maxScore - Math.min(...allScores))} åˆ†</div>
                </div>
                <div class="fb-card">
                    <div class="fb-lbl">æ•°æ®çŠ¶æ€</div>
                    <div class="fb-val" style="font-size:18px; color:#64748b; margin-top:5px;">${CONFIG.name}</div>
                    <div class="fb-lbl">å·²å‰”é™¤å ${ (CONFIG.excRate*100) }%</div>
                </div>
            `;
        }
        // --- ğŸ“Š æ–°å¢ï¼šæ•°æ®ç»Ÿè®¡çœ‹æ¿é€»è¾‘ ç»“æŸ ---

        const theadTotal = document.querySelector('#tb-total thead tr');
        
        // 1. è·å–æ‰€æœ‰å­¦æ ¡åˆ—è¡¨ (ç§»é™¤ä»»ä½•æ’åºè¿‡æ»¤ï¼Œå…ˆæ‹¿åŸå§‹æ•°æ®)
        let list = Object.values(SCHOOLS);
        
        // --- ğŸ” è¯Šæ–­ä»£ç å¼€å§‹ ---
        // åªæœ‰å½“ç‚¹å‡»â€œç”Ÿæˆæ¨ªå‘å¯¹æ¯”è¡¨â€æˆ–é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœå­¦æ ¡æ•°é‡å°‘äºé¢„æœŸ(æ¯”å¦‚13)ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°
        console.log(`ç³»ç»Ÿå…±è¯†åˆ«åˆ° ${list.length} æ‰€å­¦æ ¡ï¼š`, list.map(s => s.name));
        
        // åœ¨è¡¨å¤´æ˜¾ç¤ºé†’ç›®çš„æ•°é‡
        const countInfo = `<span style="background:#ef4444; color:white; padding:2px 6px; border-radius:4px; font-size:11px;">å…±è¯†åˆ« ${list.length} æ‰€</span>`;
        // --- ğŸ” è¯Šæ–­ä»£ç ç»“æŸ ---

        theadTotal.innerHTML = `
            <th>å­¦æ ¡åç§° ${countInfo}</th><th>å®è€ƒäººæ•°</th><th>å¹³å‡åˆ†</th><th>ä¼˜ç§€ç‡</th><th>åŠæ ¼ç‡</th>
            <th>å¹³å‡åˆ†èµ‹åˆ†</th><th>ä¼˜ç§€ç‡èµ‹åˆ†</th><th>åŠæ ¼ç‡èµ‹åˆ†</th>
            <th>ä¸¤ç‡ä¸€åˆ†æ€»åˆ†</th><th>æ’å</th>
        `;
        
        // 2. æ’åº
        list.sort((a,b) => (a.rank2Rate || 9999) - (b.rank2Rate || 9999));
        
        // 3. æ¸²æŸ“
        let html = '';
        list.forEach(s => {
            const m = s.metrics.total || {}; 
            const rA = m.ratedAvg || 0; 
            const rE = m.ratedExc || 0; 
            const rP = m.ratedPass || 0; 
            const isMySchool = s.name === MY_SCHOOL;
            
            // è®¡ç®—æ•°æ®æ¡ç™¾åˆ†æ¯” (å‡è®¾æ»¡åˆ†æŒ‰å…¨é•‡æœ€é«˜å‡åˆ†ç®—ï¼Œæˆ–è€…å›ºå®šå€¼å¦‚100/120)
            const maxAvg = list[0].metrics.total?.avg || 100; // å–ç¬¬ä¸€åå‡åˆ†ä½œä¸ºåŸºå‡†
            const barPercent = m.avg ? (m.avg / maxAvg * 100).toFixed(1) : 0;

            html += `<tr class="${isMySchool?'bg-highlight':''}">
                <td data-label="å­¦æ ¡" class="clickable-school" onclick="showSchoolProfile('${s.name}')" title="ç‚¹å‡»æŸ¥çœ‹å­¦æ ¡å­¦ç§‘è¯Šæ–­">
                    ${s.name} <i class="ti ti-chart-radar" style="font-size:12px; opacity:0.5;"></i>
                </td>
                <td data-label="äººæ•°">${m.count||0}</td>
                
                <!-- æ³¨å…¥æ ·å¼å˜é‡ --percent -->
                <td data-label="å¹³å‡åˆ†" class="data-bar-bg" style="--percent: ${barPercent}%">
                    ${formatRankDisplay(m.avg||0, s.rankings.total?.avg || 0)}
                </td>
                
                <td data-label="ä¼˜ç§€ç‡">${formatRankDisplay(m.excRate||0, s.rankings.total?.excRate || 0, 'school', true)}</td>
                <td data-label="åŠæ ¼ç‡">${formatRankDisplay(m.passRate||0, s.rankings.total?.passRate || 0, 'school', true)}</td>
                <td data-label="å‡åˆ†èµ‹åˆ†">${rA.toFixed(2)}</td>
                <td data-label="ä¼˜ç‡èµ‹åˆ†">${rE.toFixed(2)}</td>
                <td data-label="åŠæ ¼èµ‹åˆ†">${rP.toFixed(2)}</td>
                <td data-label="æ€»åˆ†" class="text-red" style="font-size:1.1em; font-weight:bold;">${(s.score2Rate||0).toFixed(2)}</td>
                ${getRankHTML(s.rank2Rate)}
            </tr>`;
        });
        tbTotal.innerHTML = html;

        // ... (ä¸‹æ¥å„ç§‘æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸å˜) ...
        const subContainer = document.getElementById('subject-tables-container');         const sideNavSubjects = document.getElementById('side-nav-subjects-container'); 
        subContainer.innerHTML = ''; 
        sideNavSubjects.innerHTML = '';
        
        SUBJECTS.forEach(sub => {
            const thresh = THRESHOLDS[sub]; 
            const box = document.createElement('div'); 
            const anchorId = `anchor-subject-${sub}`; 
            box.id = anchorId; 
            box.className = 'anchor-target'; 
            box.style.paddingTop = '20px';
            box.innerHTML = `<div class="sub-header"><span>ğŸ“˜ ${sub}</span><span style="font-weight:normal; font-size:12px; opacity:0.8;">ä¼˜ç§€çº¿â‰¥${(thresh?.exc || 0).toFixed(1)}, åŠæ ¼çº¿â‰¥${(thresh?.pass || 0).toFixed(1)}</span></div><div class="table-wrap"><table><thead><tr><th>å­¦æ ¡åç§°</th><th>å®è€ƒäººæ•°</th><th>å¹³å‡åˆ†</th><th>ä¼˜ç§€ç‡</th><th>åŠæ ¼ç‡</th></tr></thead><tbody></tbody></table></div>`;
            const tbody = box.querySelector('tbody'); 
            const subList = Object.values(SCHOOLS).filter(s=>s.metrics[sub]).sort((a,b)=>(a.rankings[sub].avg - b.rankings[sub].avg)); 
            let htmlSub = '';
            subList.forEach(s => { const m = s.metrics[sub]; const r = s.rankings[sub]; const isMySchool = s.name === MY_SCHOOL; htmlSub += `<tr class="${isMySchool?'bg-highlight':''}"><td>${s.name}</td><td>${m.count}</td><td>${formatRankDisplay(m.avg, r.avg)}</td><td>${formatRankDisplay(m.excRate, r.excRate, 'school', true)}</td><td>${formatRankDisplay(m.passRate, r.passRate, 'school', true)}</td></tr>`; });
            tbody.innerHTML = htmlSub; subContainer.appendChild(box); const navLink = document.createElement('a'); navLink.className = 'side-nav-sub-link'; navLink.innerText = sub; navLink.onclick = () => scrollToSubAnchor(anchorId, navLink); sideNavSubjects.appendChild(navLink);
        });

        const tbBottom = document.querySelector('#tb-bottom3 tbody'); let htmlBottom = ''; 
        let bottomList = Object.values(SCHOOLS).sort((a,b)=> (a.rankBottom || 9999) - (b.rankBottom || 9999));
        bottomList.forEach(s => { 
            const isMySchool = s.name === MY_SCHOOL; 
            htmlBottom += `
            <tr class="${isMySchool?'bg-highlight':''}">
                <td>${s.name}</td>
                <td>${s.bottom3.totalN}</td>
                <td>${s.bottom3.bottomN}</td>
                <td>
                    <span class="clickable-num" onclick="handleExcludedClick('${s.name}')" title="ç‚¹å‡»æŸ¥çœ‹è¢«å‰”é™¤çš„ä½åˆ†å­¦ç”Ÿ">
                        ${s.bottom3.excN}
                    </span>
                </td>
                <td>${s.bottom3.avg.toFixed(2)}</td>
                <td class="text-red">${s.scoreBottom.toFixed(2)}</td>
                ${getRankHTML(s.rankBottom)}
            </tr>`; 
        });
        tbBottom.innerHTML = htmlBottom;
        renderTrafficLightDashboard();
    }

    function renderTrafficLightDashboard() {
        const container = document.getElementById('traffic-light-dashboard');
        const listRed = document.getElementById('list-red');
        const listYellow = document.getElementById('list-yellow');
        const listGreen = document.getElementById('list-green');
        
        if(Object.keys(SCHOOLS).length === 0) {
            container.classList.add('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        listRed.innerHTML = ''; listYellow.innerHTML = ''; listGreen.innerHTML = '';
        
        let cntRed = 0, cntYellow = 0, cntGreen = 0;

        // éå†æ‰€æœ‰å­¦æ ¡å’Œæ‰€æœ‰ç§‘ç›®è¿›è¡Œâ€œä½“æ£€â€
        Object.values(SCHOOLS).forEach(s => {
            [...SUBJECTS, 'total'].forEach(sub => {
                const m = s.metrics[sub];
                if(!m) return;
                
                const subName = sub === 'total' ? CONFIG.label : sub;
                const excP = m.excRate * 100;
                const passP = m.passRate * 100;
                const rank = s.rankings[sub]?.avg || 999;
                const totalSchools = Object.keys(SCHOOLS).length;

                // 1. ğŸ”´ çº¢è‰²é¢„è­¦æ¡ä»¶ï¼šåŠæ ¼ç‡ < 60% æˆ– æ’åå«åº•
                if (passP < 60 || rank === totalSchools) {
                    const reason = passP < 60 ? `åŠæ ¼ç‡è¿‡ä½ (${passP.toFixed(1)}%)` : `å…¨é•‡æ’åå€’æ•°ç¬¬ä¸€`;
                    const html = `
                        <div class="traffic-item" onclick="jumpToDetail('${s.name}', '${sub}')">
                            <div class="t-school">${s.name} <span class="t-badge bg-red-light">${subName}</span></div>
                            <div class="t-sub">
                                <span>${reason}</span>
                                <span style="font-weight:bold;">ğŸ“‰ Avg: ${m.avg.toFixed(1)}</span>
                            </div>
                        </div>`;
                    listRed.innerHTML += html;
                    cntRed++;
                }
                // 2. ğŸŸ¢ ç»¿è‰²æ ‡æ†æ¡ä»¶ï¼šä¼˜ç§€ç‡ > 30% æˆ– æ’åç¬¬ä¸€
                else if (excP > 30 || rank === 1) {
                    const reason = rank === 1 ? `å…¨é•‡æ’åç¬¬ä¸€` : `ä¼˜ç§€ç‡çªå‡º (${excP.toFixed(1)}%)`;
                    const html = `
                        <div class="traffic-item" onclick="jumpToDetail('${s.name}', '${sub}')">
                            <div class="t-school">${s.name} <span class="t-badge bg-green-light">${subName}</span></div>
                            <div class="t-sub">
                                <span>${reason}</span>
                                <span style="font-weight:bold;">ğŸ† No.${rank}</span>
                            </div>
                        </div>`;
                    listGreen.innerHTML += html;
                    cntGreen++;
                }
                // 3. ğŸŸ¡ é»„è‰²å…³æ³¨æ¡ä»¶ï¼šä¼˜ç§€ç‡ < 15% (å³ç¼ºä¹å°–å­ç”Ÿ) ä¸”æ²¡è¢«å½’å…¥çº¢ç¯
                else if (excP < 15) {
                    const html = `
                        <div class="traffic-item" onclick="jumpToDetail('${s.name}', '${sub}')">
                            <div class="t-school">${s.name} <span class="t-badge bg-yellow-light">${subName}</span></div>
                            <div class="t-sub">
                                <span>å°–å­ç”ŸåŒ®ä¹ (ä¼˜ç‡${excP.toFixed(1)}%)</span>
                                <span>æ’: ${rank}</span>
                            </div>
                        </div>`;
                    listYellow.innerHTML += html;
                    cntYellow++;
                }
            });
        });

        // æ›´æ–°è®¡æ•°å¾½ç« 
        document.getElementById('count-red').innerText = cntRed;
        document.getElementById('count-yellow').innerText = cntYellow;
        document.getElementById('count-green').innerText = cntGreen;
        
        // ç©ºçŠ¶æ€å¤„ç†
        if(cntRed===0) listRed.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">ğŸ‰ å¹³å®‰æ— äº‹ï¼Œæš‚æ— ä¸¥é‡è­¦å‘Š</div>';
        if(cntYellow===0) listYellow.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">æ— é£é™©é¢„è­¦</div>';
        if(cntGreen===0) listGreen.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">æš‚æ— çªå‡ºæ ‡æ†ï¼Œç»§ç»­åŠ æ²¹</div>';
    }

    // è¾…åŠ©è·³è½¬å‡½æ•°ï¼šç‚¹å‡»å¡ç‰‡å®šä½åˆ°å¯¹åº”è¡¨æ ¼
    function jumpToDetail(school, subject) {
        // å¦‚æœæ˜¯æ€»åˆ†ï¼Œè·³åˆ°æ€»è¡¨
        if (subject === 'total') {
            document.getElementById('anchor-total').scrollIntoView({behavior: "smooth", block: "center"});
        } else {
            // å¦‚æœæ˜¯å•ç§‘ï¼Œè·³åˆ°å•ç§‘è¡¨
            const anchor = document.getElementById(`anchor-subject-${subject}`);
            if(anchor) {
                // å±•å¼€ä¾§è¾¹æ ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const navLink = document.querySelector(`.side-nav-sub-link[onclick*="${subject}"]`);
                if(navLink) {
                    // æ¨¡æ‹Ÿç‚¹å‡»å±•å¼€çˆ¶çº§èœå•
                    const parent = navLink.closest('.side-nav-sub-container');
                    if(parent) parent.classList.add('show');
                }
                anchor.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
        
        // é«˜äº®è¡Œé—ªçƒæ•ˆæœ
        setTimeout(() => {
            // ç®€å•æŸ¥æ‰¾åŒ…å«å­¦æ ¡åçš„è¡Œï¼ˆä¸ä»…é™äºç²¾ç¡®åŒ¹é…ï¼Œä¸ºäº†ç®€åŒ–ï¼‰
            // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´ç²¾ç¡®çš„IDå®šä½ï¼Œä½†è¿™é‡Œé€šè¿‡æ–‡å­—åŒ¹é…å³å¯
            // æç¤ºç”¨æˆ·
            UI.toast(`å·²å®šä½åˆ°ï¼š${school} - ${subject}`, 'info');
        }, 500);
    }

    // ================= æ•™å¸ˆé…ç½®ä¸åˆ†æ =================
    function updateSchoolSelect() {
        const sel = document.getElementById('sel-school');
        sel.innerHTML = '<option>--è¯·é€‰æ‹©å­¦æ ¡--</option>';
        Object.keys(SCHOOLS).forEach(n => sel.innerHTML += `<option>${n}</option>`);
        sel.addEventListener('change', updateClassSelect);
    }

    function updateMySchoolSelect() {
        // ğŸŸ¢ 1. ã€æ ¸å¿ƒä¿®å¤ã€‘æ— æ¡ä»¶ä¼˜å…ˆåˆ·æ–°ç®¡ç†å‘˜é¢æ¿çš„å­¦æ ¡åˆ—è¡¨
        // æ— è®ºç•Œé¢ä¸Šæœ‰æ²¡æœ‰ "mySchoolSelect" ä¸‹æ‹‰æ¡†ï¼Œåªè¦æ•°æ®å¤„ç†å®Œäº†ï¼Œå°±å¿…é¡»é€šçŸ¥è´¦å·ç®¡ç†å™¨
        if(typeof Auth !== 'undefined') {
            Auth.renderSchoolCheckboxes();
        }

        // ğŸŸ¢ 2. ç„¶åå†å¤„ç†ä¸‹æ‹‰æ¡†é€»è¾‘ (å¦‚æœ ID å­˜åœ¨çš„è¯)
        const select = document.getElementById('mySchoolSelect');
    
        // å¦‚æœæ‰¾ä¸åˆ°ä¸‹æ‹‰æ¡†ï¼Œä»…ä»…åœæ­¢å¤„ç†ä¸‹æ‹‰æ¡†ï¼Œä¸è¦å½±å“ä¸Šé¢çš„è´¦å·åˆ—è¡¨åˆ·æ–°
        if (!select) return; 
        
        // ä¸‹é¢æ˜¯åŸæœ‰çš„ä¸‹æ‹‰æ¡†å¡«å……é€»è¾‘
        select.innerHTML = '<option value="">--è¯·é€‰æ‹©æœ¬æ ¡--</option>';
        Object.keys(SCHOOLS).forEach(school => { 
            select.innerHTML += `<option value="${school}">${school}</option>`; 
        });
        
        // å½“å­¦æ ¡æ•°æ®æ›´æ–°æ—¶ï¼Œé¡ºä¾¿åˆ·æ–°ç®¡ç†å‘˜é¢æ¿é‡Œçš„â€œå­¦æ ¡å¤é€‰æ¡†åˆ—è¡¨â€ (æ­¤å¤„æ—§ä»£ç å·²åœ¨ä¸Šé¢ç¬¬ä¸€æ­¥æ‰§è¡Œäº†ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤)
        
        select.addEventListener('change', function() { 
            MY_SCHOOL = this.value; 
            if (MY_SCHOOL) generateTeacherInputs(); 
            renderTables(); 
        });
    }

    function updateClassSelect() {
        const schoolSelect = document.getElementById('sel-school'); const classSelect = document.getElementById('sel-class');
        classSelect.innerHTML = '<option>--è¯·å…ˆé€‰æ‹©å­¦æ ¡--</option>';
        if (schoolSelect.value && SCHOOLS[schoolSelect.value]) { const classes = [...new Set(SCHOOLS[schoolSelect.value].students.map(s => s.class))].sort(); classes.forEach(cls => classSelect.innerHTML += `<option>${cls}</option>`); }
    }

    function updateStudentSchoolSelect() {
        const select = document.getElementById('studentSchoolSelect'); 
        const classSelect = document.getElementById('studentClassSelect');
        select.innerHTML = '<option value="">--è¯·é€‰æ‹©æœ¬æ ¡--</option>'; 
        classSelect.innerHTML = '<option value="">å…¨éƒ¨ç­çº§</option>';
        
        Object.keys(SCHOOLS).forEach(school => { select.innerHTML += `<option value="${school}">${school}</option>`; });
        
        select.addEventListener('change', function() { 
            const selectedSchool = this.value; 
            classSelect.innerHTML = '<option value="">å…¨éƒ¨ç­çº§</option>'; 
            if(selectedSchool && SCHOOLS[selectedSchool]) { 
                const classes = [...new Set(SCHOOLS[selectedSchool].students.map(s => s.class))].sort(); 
                classes.forEach(c => classSelect.innerHTML += `<option value="${c}">${c}</option>`); 
            }
            // âœ‹ æ€§èƒ½ä¼˜åŒ–å…³é”®ï¼šåˆ‡æ¢å­¦æ ¡æ—¶ï¼Œé‡ç½®åˆ†é¡µå¹¶ç«‹å³æ¸²æŸ“
            renderStudentDetails(true); 
        });

        // ğŸŸ¢ æ–°å¢ï¼šç­çº§åˆ‡æ¢ä¹Ÿè§¦å‘é‡ç½®
        classSelect.addEventListener('change', function() {
            renderStudentDetails(true);
        });
    }
    
    function updateMarginalSchoolSelect() {
        const select = document.getElementById('marginalSchoolSelect');
        select.innerHTML = '<option value="">--è¯·é€‰æ‹©æœ¬æ ¡--</option>';
        Object.keys(SCHOOLS).forEach(school => select.innerHTML += `<option value="${school}">${school}</option>`);
    }

    function generateTeacherInputs() {
        if (!MY_SCHOOL) { alert('è¯·å…ˆé€‰æ‹©æœ¬æ ¡'); return; }
        const container = document.getElementById('teacherInputsContainer'); container.innerHTML = '';
        const mySchoolData = SCHOOLS[MY_SCHOOL]; if (!mySchoolData) return;
        const classes = [...new Set(mySchoolData.students.map(s => s.class))].sort((a, b) => { const [gradeA, classA] = a.split('.').map(Number); const [gradeB, classB] = b.split('.').map(Number); if (gradeA !== gradeB) return gradeA - gradeB; return classA - classB; });
        classes.forEach(cls => {
            SUBJECTS.forEach(sub => { const key = `${cls}_${sub}`; const currentTeacher = TEACHER_MAP[key] || ''; const inputDiv = document.createElement('div'); inputDiv.innerHTML = `<label style="font-size:12px;color:#666;">${cls}ç­ ${sub}</label><input type="text" class="teacher-input" data-key="${key}" value="${currentTeacher}" placeholder="å§“å" style="width:100%;margin-top:2px;">`; container.appendChild(inputDiv); });
        });
        container.querySelectorAll('.teacher-input').forEach(input => { input.addEventListener('input', function() { const key = this.dataset.key; const value = this.value.trim(); if (value) TEACHER_MAP[key] = value; else delete TEACHER_MAP[key];             // é˜²æŠ–ä¿å­˜ï¼šè¾“å…¥åœæ­¢ 1 ç§’åä¿å­˜ï¼Œé¿å…é¢‘ç¹å†™å…¥
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                const currentKey = localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup';
                
                DB.save(currentKey, {
                    timestamp: Date.now(),
                    RAW_DATA: RAW_DATA,
                    SCHOOLS: SCHOOLS,
                    SUBJECTS: SUBJECTS,
                    THRESHOLDS: THRESHOLDS,
                    TEACHER_MAP: TEACHER_MAP, // é‡ç‚¹ä¿å­˜è¿™ä¸ª
                    TEACHER_STATS: TEACHER_STATS,
                    FB_CLASSES: FB_CLASSES,
                    CONFIG: CONFIG,
                    MY_SCHOOL: MY_SCHOOL
                });
            }, 1000);}); });
    }

    function importTeacherExcel() {
        if (isArchiveLocked()) return alert("â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œç¦æ­¢å¯¼å…¥ä»»è¯¾è¡¨");
        const fileInput = document.getElementById('teacherFileInput');
        if (!fileInput.files.length) { alert('è¯·é€‰æ‹©æ•™å¸ˆä¿¡æ¯Excelæ–‡ä»¶'); return; }
        const file = fileInput.files[0]; const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                jsonData.forEach(row => { const className = normalizeClass(row['ç­çº§'] || row['class']); const subject = row['å­¦ç§‘'] || row['subject']; const teacher = row['æ•™å¸ˆ'] || row['teacher'] || row['æ•™å¸ˆå§“å']; if (className && subject && teacher) TEACHER_MAP[`${className}_${subject}`] = teacher; });
                generateTeacherInputs(); 
                saveCloudData().then(() => {
                    if(window.UI) UI.toast("âœ… æ•™å¸ˆæ•°æ®å·²åŒæ­¥è‡³äº‘ç«¯", "success");
                });
alert(`æˆåŠŸå¯¼å…¥ ${Object.keys(TEACHER_MAP).length} æ¡æ•™å¸ˆä¿¡æ¯`);
            } catch (error) { alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message); }
        };
        reader.readAsArrayBuffer(file);
    }

    // [æ ¸å¿ƒä¿®æ”¹] æ•™å¸ˆå››ç»´è¯„ä»·è®¡ç®—é€»è¾‘ (å«è´¡çŒ®å€¼ã€å¢å€¼ã€ä½åˆ†ç‡)
    function analyzeTeachers() {
        if (!MY_SCHOOL) { alert('è¯·å…ˆé€‰æ‹©æœ¬æ ¡'); return; }
        TEACHER_STATS = {}; 
        const mySchoolData = SCHOOLS[MY_SCHOOL]; 
        if (!mySchoolData) return;

        // 1. é¢„è®¡ç®—å¹´çº§åŸºå‡†
        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const scores = mySchoolData.students.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            if (scores.length > 0) {
                const sum = scores.reduce((a,b)=>a+b, 0);
                const avg = sum / scores.length;
                const variance = scores.reduce((a,b) => a + Math.pow(b - avg, 2), 0) / scores.length;
                
                gradeStats[sub] = {
                    avg: avg,
                    sd: Math.sqrt(variance),
                    exc: THRESHOLDS[sub]?.exc || 0,
                    pass: THRESHOLDS[sub]?.pass || 0,
                    low: (THRESHOLDS[sub]?.pass || 60) * 0.6 
                };
            }
        });

        // 2. å½’é›†æ•™å¸ˆæ•°æ®
        Object.entries(TEACHER_MAP).forEach(([key, teacherName]) => {
            const [className, subject] = key.split('_'); 
            if(!SUBJECTS.includes(subject)) return;
            
            if (!TEACHER_STATS[teacherName]) TEACHER_STATS[teacherName] = {}; 
            if (!TEACHER_STATS[teacherName][subject]) { 
                TEACHER_STATS[teacherName][subject] = { 
                    classes: [], students: []
                }; 
            }
            
            const teacherStudents = mySchoolData.students.filter(s => s.class === className && s.scores[subject] !== undefined);
            TEACHER_STATS[teacherName][subject].classes.push(className); 
            TEACHER_STATS[teacherName][subject].students.push(...teacherStudents);
        });

        // 3. è®¡ç®—å¤šç»´æŒ‡æ ‡ (å·²ç§»é™¤å¢å€¼é¡¹)
        Object.keys(TEACHER_STATS).forEach(teacher => {
            Object.keys(TEACHER_STATS[teacher]).forEach(subject => {
                const data = TEACHER_STATS[teacher][subject]; 
                const students = data.students;
                const gs = gradeStats[subject] || { avg:0, low:0 };

                if (students.length > 0) {
                    // åŸºç¡€æŒ‡æ ‡
                    data.totalScore = students.reduce((sum, s) => sum + s.scores[subject], 0); 
                    data.avg = (data.totalScore / students.length).toFixed(2);
                    data.studentCount = students.length;
                    data.classes = [...new Set(data.classes)].sort().join(',');

                    // ä¸‰ç‡
                    data.excellentCount = students.filter(s => s.scores[subject] >= gs.exc).length; 
                    data.passCount = students.filter(s => s.scores[subject] >= gs.pass).length;
                    data.lowCount = students.filter(s => s.scores[subject] < gs.low).length;

                    data.excellentRate = (data.excellentCount / students.length); 
                    data.passRate = (data.passCount / students.length); 
                    data.lowRate = (data.lowCount / students.length);

                    // è´¡çŒ®å€¼
                    data.contribution = (parseFloat(data.avg) - gs.avg).toFixed(2);

                    // â˜… ç»¼åˆç»©æ•ˆåˆ† (ç§»é™¤å¢å€¼åˆ†ï¼Œæé«˜ä¼˜è‰¯ç‡æƒé‡)
                    // æ–°ç®—æ³•ï¼šåŸºå‡†30 + è´¡çŒ®å€¼ + ä¼˜ç‡(30) + åŠæ ¼(30) - ä½åˆ†æƒ©ç½š
                    let score = 30; 
                    score += parseFloat(data.contribution); 
                    score += (data.excellentRate * 30); // æƒé‡ç”±25æè‡³30
                    score += (data.passRate * 30);      // æƒé‡ç”±25æè‡³30
                    score -= (data.lowRate * 20); 

                    data.finalScore = score.toFixed(1);

                } else { 
                    Object.assign(data, { 
                        avg: "0.00", excellentRate: 0, passRate: 0, lowRate: 0, 
                        contribution: 0, finalScore: 0, classes: "æ— æˆç»©" 
                    });
                }
            });
        });
        
        calculateTeacherTownshipRanking(); 
        renderTeacherCards(); 
        renderTeacherComparisonTable(); 
        generateTeacherPairing(); 
    }

    function generateTeacherPairing() {
        const container = document.getElementById('teacher-pairing-suggestions'); container.innerHTML = '';
        if(!MY_SCHOOL || !SCHOOLS[MY_SCHOOL]) return;
        const schoolMetrics = SCHOOLS[MY_SCHOOL].metrics; let pairs = [];
        SUBJECTS.forEach(sub => {
            const baseline = schoolMetrics[sub]; if(!baseline) return;
            const teachers = []; Object.keys(TEACHER_STATS).forEach(tName => { if(TEACHER_STATS[tName][sub]) { teachers.push({name: tName, data: TEACHER_STATS[tName][sub]}); } });
            if(teachers.length < 2) return;
            const typeA = teachers.filter(t => t.data.passRate > baseline.passRate && t.data.excellentRate < baseline.excRate);
            const typeB = teachers.filter(t => t.data.excellentRate > baseline.excRate && t.data.passRate < baseline.passRate);
            typeA.forEach(a => { typeB.forEach(b => { const id = [a.name, b.name].sort().join('-'); if(!pairs.find(p => p.id === id + sub)) { pairs.push({ id: id + sub, subject: sub, teacher1: a, teacher2: b }); } }); });
        });
        if(pairs.length === 0) { container.innerHTML = '<div style="text-align:center; color:#999; grid-column:1/-1;">æš‚æ— æ˜æ˜¾çš„äº’è¡¥å‹ç»“å¯¹å»ºè®®ï¼Œè¯´æ˜å„ä½è€å¸ˆå‘å±•è¾ƒä¸ºå‡è¡¡æˆ–å·®å¼‚ä¸å¤§ã€‚</div>'; return; }
        pairs.forEach(p => {
            const card = document.createElement('div'); card.className = 'pairing-card';
            card.innerHTML = `<div class="pairing-side"><div class="pairing-role">åŸºç¡€æ‰å®å‹</div><div class="pairing-name">${p.teacher1.name}</div><div class="pairing-skill">âœ… åŠæ ¼ç‡é«˜ (${(p.teacher1.data.passRate*100).toFixed(1)}%)</div><div class="pairing-need">ğŸ”» éœ€æå‡ä¼˜ç§€ç‡</div></div><div class="pairing-arrow"><div style="text-align:center;"><i class="ti ti-arrows-left-right"></i><div class="pairing-tag">${p.subject}</div></div></div><div class="pairing-side" style="text-align:right;"><div class="pairing-role">åŸ¹ä¼˜æ‹”å°–å‹</div><div class="pairing-name">${p.teacher2.name}</div><div class="pairing-skill">âœ… ä¼˜ç§€ç‡é«˜ (${(p.teacher2.data.excellentRate*100).toFixed(1)}%)</div><div class="pairing-need">ğŸ”» éœ€æå‡åŠæ ¼ç‡</div></div>`; container.appendChild(card);
        });
    }

    function calculateTeacherTownshipRanking() {
        TEACHER_TOWNSHIP_RANKINGS = {}; TOWNSHIP_RANKING_DATA = {}; 
        SUBJECTS.forEach(subject => {
            let rankingData = [];
            Object.keys(TEACHER_STATS).forEach(teacher => {
                if (TEACHER_STATS[teacher][subject]) { const data = TEACHER_STATS[teacher][subject]; rankingData.push({ name: teacher, type: 'teacher', subject: subject, avg: parseFloat(data.avg) || 0, excellentRate: data.excellentRate || 0, passRate: data.passRate || 0, studentCount: data.studentCount }); }
            });
            Object.keys(SCHOOLS).forEach(school => {
                if (school !== MY_SCHOOL && SCHOOLS[school].metrics[subject]) { const metrics = SCHOOLS[school].metrics[subject]; rankingData.push({ name: school, type: 'school', subject: subject, avg: parseFloat(metrics.avg) || 0, excellentRate: metrics.excRate || 0, passRate: metrics.passRate || 0, studentCount: metrics.count }); }
            });
            rankingData.sort((a, b) => b.avg - a.avg); rankingData.forEach((item, index) => item.rankAvg = index + 1);
            rankingData.sort((a, b) => b.excellentRate - a.excellentRate); rankingData.forEach((item, index) => item.rankExc = index + 1);
            rankingData.sort((a, b) => b.passRate - a.passRate); rankingData.forEach((item, index) => item.rankPass = index + 1);
            rankingData.sort((a, b) => b.avg - a.avg);
            rankingData.forEach(item => { if (item.type === 'teacher') { if (!TEACHER_TOWNSHIP_RANKINGS[item.name]) TEACHER_TOWNSHIP_RANKINGS[item.name] = {}; TEACHER_TOWNSHIP_RANKINGS[item.name][subject] = { avg: item.avg, rankAvg: item.rankAvg, excellentRate: item.excellentRate, rankExc: item.rankExc, passRate: item.passRate, rankPass: item.rankPass, rank: item.rankAvg }; } });
            TOWNSHIP_RANKING_DATA[subject] = rankingData;
        });
    }

    function renderTeacherCards() {
        // ä»¥å‰è¿™é‡Œéœ€è¦å†™å‡ åè¡Œ HTML æ‹¼æ¥é€»è¾‘ï¼Œç°åœ¨åªéœ€è¦ä¸€è¡Œï¼š
        // æŠŠå…¨å±€æ•°æ®åŒæ­¥åˆ° Alpine Storeï¼Œç•Œé¢ä¼šè‡ªåŠ¨å˜ï¼
        Alpine.store('teacherData').update(TEACHER_STATS, TEACHER_TOWNSHIP_RANKINGS);
    }

    function calculatePerformanceLevel(teacherData) {
        const avg = parseFloat(teacherData.avg), excellentRate = teacherData.excellentRate * 100, passRate = teacherData.passRate * 100;
        if (avg >= 85 && excellentRate >= 30 && passRate >= 90) return { class: 'performance-excellent', text: 'ä¼˜ç§€' };
        else if (avg >= 80 && excellentRate >= 25 && passRate >= 85) return { class: 'performance-good', text: 'è‰¯å¥½' };
        else if (avg >= 75 && excellentRate >= 20 && passRate >= 80) return { class: 'performance-average', text: 'ä¸­ç­‰' };
        else return { class: 'performance-poor', text: 'éœ€æ”¹è¿›' };
    }

   // [ä¿®æ”¹] æ¸²æŸ“æ•™å¸ˆè¯¦ç»†å¯¹æ¯”è¡¨ (å¢åŠ è´¡çŒ®å€¼ã€å¢å€¼ã€ä½åˆ†ç‡ç­‰åˆ—)
    function renderTeacherComparisonTable() {
        const container = document.getElementById('teacherComparisonTable');
        if (Object.keys(TEACHER_STATS).length === 0) { 
            container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ•™å¸ˆç»Ÿè®¡æ•°æ®</p>'; return; 
        }

        // 1. å‡†å¤‡æ•°æ®
        const subjectTeachers = {};
        Object.keys(TEACHER_STATS).forEach(teacher => {
            Object.keys(TEACHER_STATS[teacher]).forEach(subject => {
                if (!subjectTeachers[subject]) subjectTeachers[subject] = [];
                subjectTeachers[subject].push({ 
                    teacher, 
                    data: TEACHER_STATS[teacher][subject] 
                });
            });
        });

        // 2. æ„å»º HTML (å·²ç§»é™¤å¢å€¼åˆ—)
        let tableHtml = `
        <thead>
            <tr>
                <th rowspan="2">æ•™å¸ˆ</th>
                <th rowspan="2">ç­çº§</th>
                <th rowspan="2">äººæ•°</th>
                <th colspan="2" style="background:#e0f2fe; color:#0369a1;">æ•™å­¦å®ç»©</th>
                <th colspan="3" style="background:#dcfce7; color:#166534;">ä¸‰ç‡æŒ‡æ ‡</th>
                <th style="background:#fef9c3; color:#b45309;">è€ƒæ ¸</th>
            </tr>
            <tr>
                <th>å‡åˆ†</th>
                <th>è´¡çŒ®å€¼</th>
                <th>ä¼˜ç§€ç‡</th>
                <th>åŠæ ¼ç‡</th>
                <th>ä½åˆ†ç‡</th>
                <th title="ç»¼åˆç»©æ•ˆåˆ†">ç»©æ•ˆåˆ†</th>
            </tr>
        </thead>
        <tbody>`;

        const existingSubjects = Object.keys(subjectTeachers).sort(sortSubjects);
        
        existingSubjects.forEach(subject => {
            tableHtml += `<tr style="background:#f1f5f9; font-weight:bold; color:#64748b;"><td colspan="9" style="text-align:left; padding-left:15px;">ğŸ“˜ ${subject}</td></tr>`;
            const arr = subjectTeachers[subject].sort((a,b) => b.data.finalScore - a.data.finalScore);

            arr.forEach((item, idx) => {
                const d = item.data;
                const contribClass = d.contribution >= 0 ? 'text-green' : 'text-red';
                const contribSign = d.contribution >= 0 ? '+' : '';
                const lowStyle = d.lowRate > 0.1 ? 'color:red; font-weight:bold;' : 'color:#333;';

                tableHtml += `
                <tr>
                    <td><strong>${item.teacher}</strong></td>
                    <td>${d.classes}</td>
                    <td>${d.studentCount}</td>
                    
                    <td style="font-weight:bold;">${d.avg}</td>
                    <td class="${contribClass}" style="font-weight:bold;">${contribSign}${d.contribution}</td>
                    
                    <td>${(d.excellentRate * 100).toFixed(1)}%</td>
                    <td>${(d.passRate * 100).toFixed(1)}%</td>
                    <td style="${lowStyle}">${(d.lowRate * 100).toFixed(1)}%</td>
                    
                    <td style="background:#fffbeb; font-weight:bold; color:#b45309; font-size:1.1em;">${d.finalScore}</td>
                </tr>`;
            });
        });

        tableHtml += `</tbody>`;
        container.innerHTML = `<table class="comparison-table">${tableHtml}</table>`;
    }


    function renderTeacherTownshipRanking() {
        const container = document.getElementById('teacher-township-ranking-container');
        const sideNavTeacherRanks = document.getElementById('side-nav-teacher-ranks-container'); sideNavTeacherRanks.innerHTML = '';
        if (!TOWNSHIP_RANKING_DATA || Object.keys(TOWNSHIP_RANKING_DATA).length === 0) { container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ•™å¸ˆä¹¡é•‡æ’åæ•°æ®</p>'; return; }
        const townshipAverages = {};
        SUBJECTS.forEach(subject => {
            let totalAvg = 0, totalExc = 0, totalPass = 0, count = 0;
            Object.keys(SCHOOLS).forEach(school => { if (school !== MY_SCHOOL && SCHOOLS[school].metrics[subject]) { const metrics = SCHOOLS[school].metrics[subject]; totalAvg += metrics.avg; totalExc += metrics.excRate; totalPass += metrics.passRate; count++; } });
            if (count > 0) townshipAverages[subject] = { avg: totalAvg / count, excRate: totalExc / count, passRate: totalPass / count };
        });
        let htmlAll = '';
        SUBJECTS.forEach(subject => {
            const rankingData = TOWNSHIP_RANKING_DATA[subject]; if (!rankingData || rankingData.length === 0) return;
            const townshipAvg = townshipAverages[subject] || { avg: 0, excRate: 0, passRate: 0 }; let tbodyHtml = '';
            rankingData.forEach((item) => {
                const avgComparison = townshipAvg.avg ? ((item.avg - townshipAvg.avg) / townshipAvg.avg * 100).toFixed(2) : 0; const excComparison = townshipAvg.excRate ? ((item.excellentRate - townshipAvg.excRate) / townshipAvg.excRate * 100).toFixed(2) : 0; const passComparison = townshipAvg.passRate ? ((item.passRate - townshipAvg.passRate) / townshipAvg.passRate * 100).toFixed(2) : 0; const typeClass = item.type === 'teacher' ? 'text-blue' : ''; const typeText = item.type === 'teacher' ? 'æ•™å¸ˆ' : 'å­¦æ ¡';
                tbodyHtml += `<tr><td class="${typeClass}">${item.name}</td><td>${typeText}</td><td>${formatRankDisplay(item.avg, item.rankAvg, 'teacher')}</td><td class="${avgComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${avgComparison >= 0 ? '+' : ''}${avgComparison}%</td><td>${item.rankAvg}</td><td>${formatRankDisplay(item.excellentRate, item.rankExc, 'teacher', true)}</td><td class="${excComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${excComparison >= 0 ? '+' : ''}${excComparison}%</td><td>${item.rankExc}</td><td>${formatRankDisplay(item.passRate, item.rankPass, 'teacher', true)}</td><td class="${passComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${passComparison >= 0 ? '+' : ''}${passComparison}%</td><td>${item.rankPass}</td></tr>`;
            });
            const anchorId = `rank-anchor-${subject}`; htmlAll += `<div id="${anchorId}" class="anchor-target" style="padding-top:20px;"><div class="sub-header">ğŸ… ${subject} æ•™å¸ˆä¹¡é•‡æ’å <span style="font-size:12px; font-weight:normal; margin-left:10px;">(å«å¤–æ ¡æ•´ä½“æ•°æ®)</span></div><div class="table-wrap"><table class="comparison-table"><thead><tr><th>æ•™å¸ˆ/å­¦æ ¡</th><th>ç±»å‹</th><th>å¹³å‡åˆ†</th><th>ä¸é•‡å‡æ¯”</th><th>é•‡æ’</th><th>ä¼˜ç§€ç‡</th><th>ä¸é•‡å‡æ¯”</th><th>é•‡æ’</th><th>åŠæ ¼ç‡</th><th>ä¸é•‡å‡æ¯”</th><th>é•‡æ’</th></tr></thead><tbody>${tbodyHtml}</tbody></table></div></div>`;
            const navLink = document.createElement('a'); navLink.className = 'side-nav-sub-link'; navLink.innerText = subject; navLink.onclick = () => scrollToSubAnchor(anchorId, navLink); sideNavTeacherRanks.appendChild(navLink);
        });
        container.innerHTML = htmlAll;
    }

    function showTeacherDetails(teacher, subject) {
        const data = TEACHER_STATS[teacher][subject]; if (!data) return;
        document.getElementById('modalTeacherName').textContent = `${teacher} - ${subject} æ•™å­¦è¯¦æƒ…`;
        document.getElementById('modalAvgScore').textContent = data.avg; document.getElementById('modalExcellentRate').textContent = (data.excellentRate * 100).toFixed(2) + '%'; document.getElementById('modalPassRate').textContent = (data.passRate * 100).toFixed(2) + '%';
        const subjectAvg = THRESHOLDS[subject] ? (THRESHOLDS[subject].exc + THRESHOLDS[subject].pass) / 2 : 0; const avgComparison = subjectAvg ? ((parseFloat(data.avg) - subjectAvg) / subjectAvg * 100).toFixed(1) : 0;
        document.getElementById('modalAvgComparison').textContent = (avgComparison >= 0 ? '+' : '') + avgComparison + '%';
        const avgProgress = Math.min(Math.max(50 + (avgComparison / 2), 0), 100);
        document.getElementById('modalAvgProgress').style.width = avgProgress + '%'; document.getElementById('modalAvgProgress').className = avgComparison >= 0 ? 'progress-good' : 'progress-poor'; document.getElementById('modalAvgProgress').style.backgroundColor = avgComparison >= 0 ? '#22c55e' : '#ef4444';
        const tableBody = document.querySelector('#modalSubjectTable tbody');
        tableBody.innerHTML = `<tr><td>${subject}</td><td>${data.avg}</td><td class="${avgComparison >= 0 ? 'positive-percent' : 'negative-percent'}">${avgComparison >= 0 ? '+' : ''}${avgComparison}%</td><td>${(data.excellentRate * 100).toFixed(2)}%</td><td>-</td><td>${(data.passRate * 100).toFixed(2)}%</td><td>-</td></tr>`;
        document.getElementById('teacherModal').style.display = 'flex';
    }

    document.getElementById('closeModal').addEventListener('click', () => document.getElementById('teacherModal').style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === document.getElementById('teacherModal')) document.getElementById('teacherModal').style.display = 'none'; });

    // ================= å…³è”åˆ†æé€»è¾‘ =================
    function updateCorrelationSchoolSelect() {
        const sel = document.getElementById('corrSchoolSelect'); const old = sel.value;
        sel.innerHTML = '<option value="ALL">å…¨ä¹¡é•‡ (All)</option>';
        Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        if(old) sel.value = old;
    }

    function calculatePearson(x, y) {
        let n = x.length; if (n === 0) return 0;
        let sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0, sum_y2 = 0;
        for (let i = 0; i < n; i++) { sum_x += x[i]; sum_y += y[i]; sum_xy += x[i] * y[i]; sum_x2 += x[i] * x[i]; sum_y2 += y[i] * y[i]; }
        let numerator = (n * sum_xy) - (sum_x * sum_y); let denominator = Math.sqrt((n * sum_x2 - sum_x * sum_x) * (n * sum_y2 - sum_y * sum_y));
        return (denominator === 0) ? 0 : numerator / denominator;
    }

    function renderCorrelationAnalysis() {
        const scope = document.getElementById('corrSchoolSelect').value;
        const students = (scope === 'ALL') ? RAW_DATA : (SCHOOLS[scope]?.students || []);
        if(students.length < 5) return alert('æ ·æœ¬æ•°æ®å¤ªå°‘ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆåˆ†æ');

        const matrixBody = document.querySelector('#corrMatrixTable tbody');
        let mHtml = '<tr><th></th>'; SUBJECTS.forEach(s => mHtml += `<th>${s}</th>`); mHtml += '</tr>';
        SUBJECTS.forEach(rowSub => {
            mHtml += `<tr><th>${rowSub}</th>`;
            SUBJECTS.forEach(colSub => {
                if (rowSub === colSub) { mHtml += '<td style="background:#eee;">-</td>'; } else {
                    const common = students.filter(s => s.scores[rowSub] !== undefined && s.scores[colSub] !== undefined);
                    const r = calculatePearson(common.map(s => s.scores[rowSub]), common.map(s => s.scores[colSub]));
                    let bg = '#fff'; if(r > 0) bg = `rgba(220, 38, 38, ${r * 0.8})`; else bg = `rgba(37, 99, 235, ${Math.abs(r) * 0.8})`;
                    let color = Math.abs(r) > 0.5 ? '#fff' : '#333';
                    mHtml += `<td class="heatmap-cell" style="background:${bg}; color:${color}" title="${rowSub} vs ${colSub} ç›¸å…³ç³»æ•°: ${r.toFixed(3)}">${r.toFixed(2)}</td>`;
                }
            });
            mHtml += '</tr>';
        });
        matrixBody.innerHTML = mHtml;

        const contribData = SUBJECTS.map(sub => {
            const common = students.filter(s => s.scores[sub] !== undefined);
            const r = calculatePearson(common.map(s => s.scores[sub]), common.map(s => s.total));
            return { sub, r };
        }).sort((a, b) => b.r - a.r);

        const chartContainer = document.getElementById('contributionChartContainer');
        chartContainer.innerHTML = '';
        contribData.forEach(item => {
            const w = Math.max(0, item.r * 100);
            chartContainer.innerHTML += `<div style="display:flex; align-items:center; margin-bottom:5px;"><span style="width:40px; font-size:12px; font-weight:bold;">${item.sub}</span><div style="flex:1; background:#f1f5f9; border-radius:4px; margin-left:10px; height:20px;"><div class="contribution-bar" style="width:${w}%; background:${item.r>0.8?'#16a34a':(item.r>0.6?'#2563eb':'#ca8a04')}">${item.r.toFixed(3)}</div></div></div>`;
        });

        const liftDragBody = document.querySelector('#liftDragTable tbody'); let ldHtml = '';
        SUBJECTS.forEach(sub => {
            let lift = 0, drag = 0, balance = 0; let validCount = 0;
            students.forEach(s => {
                const tRank = safeGet(s, 'ranks.total.township', 0); const sRank = safeGet(s, `ranks.${sub}.township`, 0);
                if(!tRank || !sRank) return;
                validCount++; const threshold = students.length * 0.1; 
                if (sRank < tRank - threshold) lift++; else if (sRank > tRank + threshold) drag++; else balance++;
            });
            if(validCount > 0) {
                const net = lift - drag;
                ldHtml += `<tr><td>${sub}</td><td class="text-green">${lift} äºº (${(lift/validCount*100).toFixed(0)}%)</td><td class="text-red">${drag} äºº (${(drag/validCount*100).toFixed(0)}%)</td><td>${balance} äºº</td><td style="font-weight:bold; color:${net>0?'green':'red'}">${net>0?'+':''}${net}</td></tr>`;
            }
        });
        liftDragBody.innerHTML = ldHtml;
    }

    // ================= è¿›é€€æ­¥åˆ†æé€»è¾‘ =================
    function updateProgressSchoolSelect() {
        const sel = document.getElementById('progressSchoolSelect');
        sel.innerHTML = '<option value="">--è¯·é€‰æ‹©æœ¬æ ¡--</option>';
        Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
    }

    // ============================================================
    //  æ™ºèƒ½ç‰ˆä¸Šæ¬¡æˆç»©åŠ è½½å‡½æ•° (è‡ªåŠ¨é€‚é… 9å¹´çº§äº”ç§‘æ¨¡å¼ vs å…¶ä»–å¹´çº§å…¨ç§‘æ¨¡å¼)
    // ============================================================
    function loadPreviousData(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                
                if(json.length < 2) throw new Error("è¡¨æ ¼æ•°æ®å¤ªå°‘");

                const headers = json[0].map(h => String(h).trim());
                let idxName = -1, idxSchool = -1, idxTotal = -1, idxClass = -1;
                
                // 1. è¯†åˆ«åŸºç¡€åˆ—
                headers.forEach((h, i) => { 
                    if(h.includes('å§“å')) idxName = i; 
                    if(h.includes('å­¦æ ¡')) idxSchool = i; 
                    if(h.includes('ç­çº§') || h.toLowerCase() === 'class') idxClass = i; 
                    if(h.includes('æ€»åˆ†') || h.includes('Total') || h === 'å¾—åˆ†') idxTotal = i; 
                });

                // ğŸ”¥ğŸ”¥ [æ ¸å¿ƒä¿®æ”¹ç‚¹å¼€å§‹]ï¼šæ™ºèƒ½åˆ¤æ–­è¦ç´¯åŠ å“ªäº›ç§‘ç›® ğŸ”¥ğŸ”¥
                let subjectIndices = [];
                let calcModeInfo = "å…¨ç§‘ç´¯åŠ ";

                // å¦‚æœè¡¨æ ¼é‡Œæ²¡æœ‰â€œæ€»åˆ†â€åˆ—ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±ç®—
                if (idxTotal === -1) {
                    let targetSubjects = [];
                    
                    // è¯»å–å…¨å±€é…ç½® CONFIGï¼Œåˆ¤æ–­å½“å‰æ˜¯ 9å¹´çº§æ¨¡å¼ è¿˜æ˜¯ 6-8å¹´çº§æ¨¡å¼
                    if (CONFIG && Array.isArray(CONFIG.totalSubs)) {
                        // ğŸ‘‰ 9å¹´çº§æ¨¡å¼ï¼šåªå¯»æ‰¾ ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦']
                        targetSubjects = CONFIG.totalSubs; 
                        calcModeInfo = "9å¹´çº§äº”ç§‘";
                    } else {
                        // ğŸ‘‰ å…¶ä»–æ¨¡å¼ï¼šå¯»æ‰¾æ‰€æœ‰å¸¸è§ç§‘ç›®
                        targetSubjects = ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦','æ”¿æ²»','å†å²','åœ°ç†','ç”Ÿç‰©','ç§‘å­¦','é“æ³•'];
                    }

                    // éå†è¡¨å¤´ï¼Œè®°å½•ç¬¦åˆè¦æ±‚çš„åˆ—ç´¢å¼•
                    headers.forEach((h, i) => {
                        if (targetSubjects.some(sub => h.includes(sub))) {
                            subjectIndices.push(i);
                        }
                    });
                }
                // ğŸ”¥ğŸ”¥ [æ ¸å¿ƒä¿®æ”¹ç‚¹ç»“æŸ] ğŸ”¥ğŸ”¥

                if(idxName === -1) { alert('ä¸Šä¼ å¤±è´¥ï¼šæ— æ³•è¯†åˆ«â€œå§“åâ€åˆ—ã€‚'); return; }
                
                // 3. å¼€å§‹è§£ææ•°æ®
                PREV_DATA = [];
                for(let i=1; i<json.length; i++) {
                    const r = json[i]; 
                    if(!r[idxName]) continue;
                    
                    const school = idxSchool !== -1 ? r[idxSchool] : 'é»˜è®¤å­¦æ ¡'; 
                    const className = idxClass !== -1 ? normalizeClass(r[idxClass]) : ''; 
                    
                    let score = 0;
                    
                    // ç­–ç•¥A: ä¼˜å…ˆä¿¡èµ–Excelè‡ªå¸¦çš„æ€»åˆ†
                    if (idxTotal !== -1) {
                        score = parseFloat(r[idxTotal]);
                    } 
                    // ç­–ç•¥B: è‡ªåŠ¨æ±‚å’Œ (å—æ§äºä¸Šé¢çš„ 9å¹´çº§ é€»è¾‘)
                    else if (subjectIndices.length > 0) {
                        let tempSum = 0;
                        let hasVal = false;
                        subjectIndices.forEach(idx => {
                            const val = parseFloat(r[idx]);
                            if (!isNaN(val)) {
                                tempSum += val;
                                hasVal = true;
                            }
                        });
                        if (hasVal) score = tempSum;
                        else score = NaN; 
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥ï¼šæœªæ‰¾åˆ°æ€»åˆ†åˆ—ï¼Œä¹ŸæœªåŒ¹é…åˆ°å½“å‰æ¨¡å¼æ‰€éœ€çš„å­¦ç§‘åˆ—ã€‚');
                        return;
                    }

                    if(!isNaN(score)) { 
                        PREV_DATA.push({ name: r[idxName], school: school, class: className, total: score }); 
                    }
                }
                
                if(PREV_DATA.length === 0) { alert('æœªè¯»å–åˆ°æœ‰æ•ˆæ•°æ®'); return; }

                // 4. é‡æ–°è®¡ç®—æ’å
                PREV_DATA.sort((a,b) => b.total - a.total);
                PREV_DATA.forEach((s, i) => { 
                    if(i > 0 && Math.abs(s.total - PREV_DATA[i-1].total) < 0.001) { 
                        s.rank = PREV_DATA[i-1].rank; 
                    } else { 
                        s.rank = i + 1; 
                    } 
                });
                
                let msg = `âœ… ä¸Šæ¬¡è€ƒè¯•æ•°æ®åŠ è½½æˆåŠŸï¼å…± ${PREV_DATA.length} æ¡ã€‚`;
                if(idxTotal === -1) msg += `\n(æ³¨ï¼šæœªæä¾›æ€»åˆ†ï¼Œå·²æŒ‰ã€${calcModeInfo}ã€‘æ¨¡å¼è‡ªåŠ¨ç´¯åŠ  ${subjectIndices.length} ç§‘æˆç»©)`;
                
                alert(msg);
                
                // åˆ·æ–°å¯èƒ½å­˜åœ¨çš„çŠ¶æ€æç¤º
                const statusDiv = document.getElementById('va-data-status');
                if (statusDiv) statusDiv.innerHTML = 'âœ… æ•°æ®å°±ç»ª (å·²æ›´æ–°)';

            } catch(err) {
                console.error(err);
                alert("è§£æå‡ºé”™ï¼š" + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
     // --- è¿›é€€æ­¥åˆ†æ (å«åŒå/è½¬ç­æ™ºèƒ½æ‹¦æˆª) ---
    
    // 1. å…¥å£å‡½æ•°ï¼šå…ˆæ£€æŸ¥æ­§ä¹‰
    function renderProgressAnalysis() {
        if(!RAW_DATA.length) return alert("è¯·å…ˆä¸Šä¼ ã€æœ¬æ¬¡è€ƒè¯•ã€‘æ•°æ®");
        if(!PREV_DATA.length) return alert("è¯·å…ˆä¸Šä¼ ã€ä¸Šæ¬¡è€ƒè¯•ã€‘æ•°æ®");
        
        const schoolName = document.getElementById('progressSchoolSelect').value;
        if(!schoolName) return alert("è¯·é€‰æ‹©è¦åˆ†æçš„å­¦æ ¡");
        
        const currentStudents = SCHOOLS[schoolName].students;
        const ambiguousCases = []; // å­˜å‚¨éœ€è¦ç”¨æˆ·ç¡®è®¤çš„æƒ…å†µ

        // é¢„æ‰«æ
        currentStudents.forEach(curr => {
            // 1. å°è¯•ä¸¥æ ¼åŒ¹é… (å§“å+ç­çº§+å­¦æ ¡)
            const strictMatch = PREV_DATA.find(p => p.name === curr.name && p.school === curr.school && p.class === curr.class);
            
            // 2. å¦‚æœä¸¥æ ¼åŒ¹é…å¤±è´¥ï¼Œä½†åœ¨ä¸Šæ¬¡æ•°æ®é‡Œèƒ½æ‰¾åˆ°â€œåŒååŒæ ¡â€çš„äºº (è¯´æ˜å¯èƒ½è½¬ç­äº†ï¼Œæˆ–è€…åªæ˜¯åŒå)
            if (!strictMatch) {
                // æ‰¾å‡ºæ‰€æœ‰åŒååŒæ ¡çš„å€™é€‰äºº
                const candidates = PREV_DATA.filter(p => p.name === curr.name && p.school === curr.school);
                
                if (candidates.length > 0) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰‹åŠ¨æ˜ å°„è¿‡
                    const mapKey = `${curr.school}_${curr.class}_${curr.name}`;
                    if (!MANUAL_ID_MAPPINGS[mapKey]) {
                        ambiguousCases.push({
                            curr: curr,
                            candidates: candidates
                        });
                    }
                }
            }
        });

        // å†³ç­–ï¼šå¦‚æœæœ‰æ­§ä¹‰ï¼Œå¼¹çª—ï¼›å¦åˆ™ç›´æ¥è®¡ç®—
        if (ambiguousCases.length > 0) {
            showMappingModal(ambiguousCases);
        } else {
            performProgressCalculation(); // ç›´æ¥è®¡ç®—
        }
    }

    // 2. æ˜¾ç¤ºæ˜ å°„å¼¹çª—
    function showMappingModal(cases) {
        const modal = document.getElementById('mappingModal');
        const tbody = document.querySelector('#mappingModal tbody');
        tbody.innerHTML = '';

        cases.forEach((item, idx) => {
            const curr = item.curr;
            let optionsHtml = `<option value="">-- è¯·é€‰æ‹©å¯¹åº”çš„ä¸Šæ¬¡è®°å½• --</option>`;
            // é»˜è®¤é€‰é¡¹ï¼šå¦‚æœåªæœ‰ä¸€ä¸ªå€™é€‰äººï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œé»˜è®¤é€‰ä¸­å®ƒï¼Ÿè¿˜æ˜¯å¼ºåˆ¶è®©ç”¨æˆ·é€‰ï¼Ÿ
            // å»ºè®®ï¼šå¼ºåˆ¶é€‰ï¼Œæˆ–è€…æä¾›ä¸€ä¸ª"ä¸åŒ¹é…(è§†ä¸ºæ–°ç”Ÿ)"é€‰é¡¹
            item.candidates.forEach(cand => {
                optionsHtml += `<option value="${cand.class}">ä¸Šæ¬¡åœ¨ï¼š${cand.class} (æ’å:${cand.rank})</option>`;
            });
            optionsHtml += `<option value="__IGNORE__">âŒ ä¸æ˜¯åŒä¸€ä¸ªäºº (è§†ä¸ºæ–°ç”Ÿ)</option>`;

            const row = `
                <tr data-school="${curr.school}" data-class="${curr.class}" data-name="${curr.name}">
                    <td style="padding:10px;">
                        <div style="font-weight:bold;">${curr.name}</div>
                        <div style="font-size:12px; color:#666;">æœ¬æ¬¡ï¼š${curr.class}</div>
                    </td>
                    <td style="padding:10px;">
                        <select class="mapping-select" style="width:100%; padding:5px; border:1px solid #d97706; border-radius:4px;">
                            ${optionsHtml}
                        </select>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        modal.style.display = 'flex';
    }

    // 3. ç”¨æˆ·ç‚¹å‡»ç¡®è®¤å
    function confirmMappingsAndRun() {
        const rows = document.querySelectorAll('#mappingModal tbody tr');
        let allSelected = true;

        rows.forEach(row => {
            const select = row.querySelector('select');
            const val = select.value;
            if (!val) {
                allSelected = false;
                select.style.border = "2px solid red";
            } else {
                // ä¿å­˜æ˜ å°„å…³ç³»
                const s = row.dataset.school;
                const c = row.dataset.class;
                const n = row.dataset.name;
                const key = `${s}_${c}_${n}`; // å”¯ä¸€é”®
                MANUAL_ID_MAPPINGS[key] = val; // value æ˜¯ä¸Šæ¬¡çš„ç­çº§åï¼Œæˆ–è€… __IGNORE__
            }
        });

        if (!allSelected) return alert("è¯·ä¸ºæ‰€æœ‰ç–‘ä¼¼å­¦ç”Ÿé€‰æ‹©å¯¹åº”å…³ç³»ï¼ˆå¦‚æœæ˜¯æ–°ç”Ÿï¼Œè¯·é€‰â€œä¸æ˜¯åŒä¸€ä¸ªäººâ€ï¼‰");

        document.getElementById('mappingModal').style.display = 'none';
        performProgressCalculation(); // ç»§ç»­è®¡ç®—
    }

    // 4. çœŸæ­£çš„è®¡ç®—é€»è¾‘ (æ‹†åˆ†å‡ºæ¥çš„)
    // ğŸŸ¢ [ä¿®æ”¹]ï¼šå®Œå…¨é‡å†™æ­¤å‡½æ•°ï¼Œæ”¯æŒâ€œæ ¡å†…æ’åâ€é‡ç®—å¯¹æ¯”ï¼Œè§£å†³å•æ ¡æœˆè€ƒ vs å…¨é•‡è”è€ƒçš„å¯¹æ¯”éš¾é¢˜
    function performProgressCalculation() {
        const schoolName = document.getElementById('progressSchoolSelect').value;
        
        if (!schoolName || !SCHOOLS[schoolName]) return alert("è¯·é€‰æ‹©å­¦æ ¡");

        const currentStudents = SCHOOLS[schoolName].students; 
        PROGRESS_CACHE = [];
        const cleanName = (n) => String(n).replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');

        // ==========================================
        // ğŸš€ æ ¸å¿ƒæ”¹è¿›ï¼šæ„å»ºâ€œä¸Šæ¬¡è€ƒè¯•â€çš„ã€æ ¡å†…æ’åã€‘ç´¢å¼•
        // è§£å†³ç—›ç‚¹ï¼šæœ¬æ¬¡æ˜¯å•æ ¡(åˆ†æ¯å°)ï¼Œä¸Šæ¬¡æ˜¯å…¨é•‡(åˆ†æ¯å¤§)ï¼Œç›´æ¥æ¯”æ’åä¸ç§‘å­¦ã€‚
        // æ–¹æ¡ˆï¼šæŠŠä¸Šæ¬¡å…¨é•‡æ•°æ®é‡Œçš„æœ¬æ ¡å­¦ç”Ÿæ‹å‡ºæ¥ï¼Œé‡æ–°æ’ä¸ªåº§æ¬¡ï¼Œç”¨â€œä¸Šæ¬¡æ ¡æ’â€vsâ€œæœ¬æ¬¡æ ¡æ’â€ã€‚
        // ==========================================
        
        // 1. ä»ä¸Šæ¬¡å…¨é•‡æ•°æ®ä¸­ï¼Œç­›é€‰å‡ºå±äºè¯¥æ ¡çš„å­¦ç”Ÿ
        let prevSchoolSubset = PREV_DATA.filter(p => p.school === schoolName);

        // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœä¸Šæ¬¡æ•°æ®æ²¡å¡«å­¦æ ¡ï¼Œæˆ–è€…å­¦æ ¡åå†™çš„ä¸ä¸€æ ·ï¼Œå°è¯•ç”¨æœ¬æ¬¡åå•åæŸ¥
        if (prevSchoolSubset.length < currentStudents.length * 0.5) { 
            console.log("æ™ºèƒ½ä¿®æ­£ï¼šä¸Šæ¬¡æ•°æ®ä¸­å­¦æ ¡åç§°å¯èƒ½ä¸åŒ¹é…ï¼Œå¯ç”¨ã€åå•åæŸ¥æ¨¡å¼ã€‘...");
            const currentNames = new Set(currentStudents.map(s => cleanName(s.name)));
            prevSchoolSubset = PREV_DATA.filter(p => currentNames.has(cleanName(p.name)));
        }

        // 2. å¯¹ä¸Šæ¬¡çš„æœ¬æ ¡å­é›†è¿›è¡Œé‡æ–°æ’åº (æŒ‰åˆ†æ•°é™åº)
        prevSchoolSubset.sort((a,b) => b.total - a.total);

        // 3. å»ºç«‹æ˜ å°„è¡¨: å§“å -> ä¸Šæ¬¡æ ¡å†…æ’å
        const prevLocalRankMap = {};
        prevSchoolSubset.forEach((p, index) => {
            // å¤„ç†åŒåˆ†åŒåæ¬¡é€»è¾‘
            let rank = index + 1;
            if (index > 0 && Math.abs(p.total - prevSchoolSubset[index-1].total) < 0.01) {
                // ç»§æ‰¿ä¸Šä¸€å
                rank = prevLocalRankMap[cleanName(prevSchoolSubset[index-1].name) + "_rank"]; 
            }
            
            prevLocalRankMap[cleanName(p.name)] = {
                localRank: rank,      // ğŸ’¡ å½±å­æ’åï¼šä¸Šæ¬¡åœ¨æ ¡å†…çš„åæ¬¡
                townRank: p.rank,     // åŸå§‹æ’åï¼šä¸Šæ¬¡åœ¨å…¨é•‡çš„åæ¬¡
                total: p.total
            };
            // è¾…åŠ©é”®é˜²æ­¢è¦†ç›–
            prevLocalRankMap[cleanName(p.name) + "_rank"] = rank; 
        });

        console.log(`[è¿›é€€æ­¥åˆ†æ] å·²é‡æ„ä¸Šæ¬¡æ ¡å†…æ’åï¼ŒåŸºæ•°: ${prevSchoolSubset.length} äºº`);

        // ==========================================
        // å¼€å§‹å¯¹æ¯”
        // ==========================================

        currentStudents.forEach(curr => {
            const currNameClean = cleanName(curr.name);
            
            // å°è¯•è·å–ç”¨æˆ·æ‰‹åŠ¨æ˜ å°„ (å¤„ç†åŒå/è½¬ç­)
            const mapKey = `${curr.school}_${curr.class}_${curr.name}`;
            const mappedPrevClass = MANUAL_ID_MAPPINGS[mapKey];

            // è·å–è¯¥ç”Ÿåœ¨ä¸Šæ¬¡è€ƒè¯•ä¸­çš„ä¿¡æ¯
            let prevInfo = prevLocalRankMap[currNameClean];

            // ç®€å•è¿‡æ»¤ï¼šå¦‚æœæŒ‡å®šäº†æ˜ å°„ä½†ä¸æ˜¯å¿½ç•¥ï¼Œæˆ–è€…æ²¡æŒ‡å®šä½†æ‰¾åˆ°äº†
            if (mappedPrevClass === '__IGNORE__') prevInfo = null;

            if(prevInfo) {
                // ğŸ’¡ æ ¸å¿ƒå¯¹æ¯”ï¼šæœ¬æ¬¡æ ¡æ’ vs ä¸Šæ¬¡æ ¡æ’
                // curr.ranks.total.school æ˜¯ç³»ç»Ÿåœ¨ processData é‡Œç®—å¥½çš„æœ¬æ¬¡æ ¡å†…æ’å
                const currLocalRank = safeGet(curr, 'ranks.total.school', 0);
                const prevLocalRank = prevInfo.localRank;

                // åªæœ‰å½“ä¸¤è€…éƒ½æœ‰æ•ˆæ—¶æ‰è®¡ç®—
                if (currLocalRank > 0 && prevLocalRank > 0) {
                    const change = prevLocalRank - currLocalRank; // æ­£æ•°ä¸ºè¿›æ­¥ (åæ¬¡å˜å°)
                    
                    let status = ""; 
                    if(change > 0) status = `<span class="trend-up"><i class="ti ti-arrow-up trend-icon"></i>æ ¡æ’è¿› ${change} å</span>`; 
                    else if(change < 0) status = `<span class="trend-down"><i class="ti ti-arrow-down trend-icon"></i>æ ¡æ’é€€ ${Math.abs(change)} å</span>`; 
                    else status = `<span style="color:#666;">ğŸ”µ æ’åæŒå¹³</span>`;
                    
                    // å¢åŠ æç¤ºï¼šå¦‚æœæ˜¯å•æ ¡æ¨¡å¼ï¼Œç‰¹åˆ«æ ‡æ³¨è¿™æ˜¯æ ¡å†…å¯¹æ¯”
                    const note = `<div style="font-size:10px; color:#999;">(ä¸Šæ¬¡æ ¡æ’: ${prevLocalRank})</div>`;

                    PROGRESS_CACHE.push({ 
                        class: curr.class, 
                        name: curr.name, 
                        currTotal: curr.total, 
                        currRank: currLocalRank, // æ˜¾ç¤ºæ ¡å†…æ’å
                        prevTotal: prevInfo.total, 
                        prevRank: prevLocalRank, // æ˜¾ç¤ºé‡ç®—åçš„ä¸Šæ¬¡æ ¡å†…æ’å
                        change: change, 
                        statusHTML: status + note
                    });
                }
            }
        });

        // ä¿å­˜å…¨é‡ç¼“å­˜å¹¶åº”ç”¨ç­›é€‰
        window.PROGRESS_CACHE_FULL = PROGRESS_CACHE.slice();
        applyProgressFilter();
    }

    // è¿›é€€æ­¥ç­›é€‰ä¸è¡¨æ ¼æ¸²æŸ“
    function applyProgressFilter() {
        const typeEl = document.getElementById('progressFilterType');
        const thresholdEl = document.getElementById('progressFilterThreshold');
        const type = typeEl ? typeEl.value : 'all';
        const threshold = thresholdEl ? parseInt(thresholdEl.value || '0') : 0;

        let list = (window.PROGRESS_CACHE_FULL || []).slice();
        list = list.filter(r => Math.abs(r.change) >= threshold);
        if (type === 'up') list = list.filter(r => r.change > 0);
        if (type === 'down') list = list.filter(r => r.change < 0);

        // æ›´æ–°å…¨å±€ç”¨äºå›¾è¡¨
        PROGRESS_CACHE = list;
        renderProgressTable(list);

        if (list.length > 0) {
            renderTrendChart();
            renderSankeyDiagram();
        }
    }

    function resetProgressFilter() {
        const typeEl = document.getElementById('progressFilterType');
        const thresholdEl = document.getElementById('progressFilterThreshold');
        if (typeEl) typeEl.value = 'all';
        if (thresholdEl) thresholdEl.value = 20;
        applyProgressFilter();
    }

    function renderProgressTable(list) {
        const tbody = document.querySelector('#progressTable tbody'); 
        const thead = document.querySelector('#progressTable thead tr');
        if (!tbody || !thead) return;

        thead.innerHTML = `<th>ç­çº§</th><th>å§“å</th><th>æœ¬æ¬¡æ€»åˆ†</th><th>æœ¬æ¬¡æ ¡æ’</th><th>ä¸Šæ¬¡æ€»åˆ†</th><th>ä¸Šæ¬¡æ ¡æ’(é‡ç®—)</th><th>è¿›é€€æ­¥</th><th>çŠ¶æ€è¯„ä»·</th>`;

        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">æš‚æ— ç¬¦åˆç­›é€‰æ¡ä»¶çš„å­¦ç”Ÿ</td></tr>';
            return;
        }

        list.sort((a,b) => b.change - a.change);
        let html = '';
        list.forEach(row => {
            const rewardBtn = row.change > 30 
                ? `<button class="btn btn-orange" style="padding:2px 8px; font-size:11px;" onclick="showCertificate('${row.name}', 'è¿›æ­¥ä¹‹æ˜Ÿ')">ğŸ… é¢å¥–</button>` 
                : (row.currRank <= 10 ? `<button class="btn btn-purple" style="padding:2px 8px; font-size:11px;" onclick="showCertificate('${row.name}', 'å­¦ä¹ æ ‡å…µ')">ğŸ† é¢å¥–</button>` : '');

            html += `<tr>
                <td>${row.class}</td>
                <td><strong>${row.name}</strong></td>
                <td>${row.currTotal}</td>
                <td style="font-weight:bold;">${row.currRank}</td>
                <td style="color:#999">${row.prevTotal}</td>
                <td style="color:#999">${row.prevRank}</td>
                <td style="font-weight:bold; ${row.change>0?'color:var(--success)':'color:var(--danger)'}">${row.change>0?'+':''}${row.change}</td>
                <td>${row.statusHTML} ${rewardBtn}</td>
            </tr>`;  
        });
        tbody.innerHTML = html;
    }

    // è¾…åŠ©ï¼šé‡ç»˜å›¾è¡¨ (æŠŠåŸæ¥çš„å›¾è¡¨é€»è¾‘å°è£…åœ¨è¿™é‡Œ)
    function renderTrendChart() {
        const ctx = document.getElementById('trendChart');
        if (trendChartInstance) trendChartInstance.destroy();

        const improved = [], regressed = [], stable = [];
        PROGRESS_CACHE.forEach(p => {
            const point = { x: p.prevRank, y: p.currRank, name: p.name, cls: p.class, change: p.change };
            if (p.change > 0) improved.push(point);
            else if (p.change < 0) regressed.push(point);
            else stable.push(point);
        });
        const maxRank = Math.max(...PROGRESS_CACHE.map(p => Math.max(p.prevRank, p.currRank))) + 10;

        trendChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'è¿›æ­¥', data: improved, backgroundColor: 'rgba(22, 163, 74, 0.6)', borderColor: 'rgba(22, 163, 74, 1)' },
                    { label: 'é€€æ­¥', data: regressed, backgroundColor: 'rgba(220, 38, 38, 0.6)', borderColor: 'rgba(220, 38, 38, 1)' },
                    { label: 'æŒå¹³', data: stable, backgroundColor: 'rgba(71, 85, 105, 0.4)' },
                    { label: 'åŸºå‡†çº¿', data: [{x: 0, y: 0}, {x: maxRank, y: maxRank}], showLine: true, borderColor: '#94a3b8', borderDash: [5, 5], pointRadius: 0, fill: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { tooltip: { callbacks: { label: (ctx) => { const p = ctx.raw; return p.name ? `${p.cls} ${p.name}: ${p.x} -> ${p.y} (${p.change>0?'+':''}${p.change})` : ''; } } } },
                scales: { x: { title:{display:true, text:'ä¸Šæ¬¡æ’å'}, min:0, max:maxRank }, y: { title:{display:true, text:'æœ¬æ¬¡æ’å'}, min:0, max:maxRank, reverse:true } }
            }
        });
    }

    let sankeyChartInstance = null;

    function renderSankeyDiagram() {
        const ctx = document.getElementById('sankeyChart');
        if (!ctx) return;
        if (sankeyChartInstance) sankeyChartInstance.destroy();

        if (PROGRESS_CACHE.length === 0) return;

        // 1. å‡†å¤‡åŸºæ•°
        const totalStudents = RAW_DATA.length; // æœ¬æ¬¡å…¨é•‡æ€»äººæ•°
        const prevTotalStudents = PREV_DATA.length; // ä¸Šæ¬¡å…¨é•‡æ€»äººæ•°

        // 2. èšåˆæµåŠ¨æ•°æ®
        const flows = {};
        
        PROGRESS_CACHE.forEach(p => {
            // è®¡ç®—ä¸Šæ¬¡å±‚çº§ (æŒ‰å…¨é•‡ç™¾åˆ†æ¯”)
            const prevPct = p.prevRank / prevTotalStudents;
            let fromTier = 'ä¸Šæ¬¡ ';
            if (prevPct <= 0.25) fromTier += 'A (ä¼˜)';
            else if (prevPct <= 0.50) fromTier += 'B (è‰¯)';
            else if (prevPct <= 0.75) fromTier += 'C (ä¸­)';
            else fromTier += 'D (æ½œ)';

            // è®¡ç®—æœ¬æ¬¡å±‚çº§
            const currPct = p.currRank / totalStudents;
            let toTier = 'æœ¬æ¬¡ ';
            if (currPct <= 0.25) toTier += 'A (ä¼˜)';
            else if (currPct <= 0.50) toTier += 'B (è‰¯)';
            else if (currPct <= 0.75) toTier += 'C (ä¸­)';
            else toTier += 'D (æ½œ)';

            const key = `${fromTier}||${toTier}`;
            if (!flows[key]) flows[key] = 0;
            flows[key]++;
        });

        // 3. è½¬æ¢ä¸º Chart.js Sankey æ•°æ®æ ¼å¼
        const dataPoints = Object.keys(flows).map(key => {
            const [from, to] = key.split('||');
            return { from, to, flow: flows[key] };
        });

        // 4. é¢œè‰²æ˜ å°„é€»è¾‘
        const getColor = (from, to) => {
            const f = from.charAt(3); // å–å­—ç¬¦ A, B, C, D
            const t = to.charAt(3);
            const map = {'A':0, 'B':1, 'C':2, 'D':3};
            const fi = map[f];
            const ti = map[t];

            if (fi === ti) return '#94a3b8'; // ç°è‰²ï¼šä¿æŒ
            if (ti < fi) return '#16a34a';  // ç»¿è‰²ï¼šè¿›æ­¥ (Aæ˜¯0ï¼Œå˜å°äº†å°±æ˜¯è¿›æ­¥)
            return '#dc2626';             // çº¢è‰²ï¼šé€€æ­¥
        };

        sankeyChartInstance = new Chart(ctx, {
            type: 'sankey',
            data: {
                datasets: [{
                    label: 'ç”ŸæºæµåŠ¨',
                    data: dataPoints,
                    colorFrom: (c) => getColor(c.dataset.data[c.dataIndex].from, c.dataset.data[c.dataIndex].to),
                    colorTo: (c) => getColor(c.dataset.data[c.dataIndex].from, c.dataset.data[c.dataIndex].to),
                    colorMode: 'gradient', // æ¸å˜è‰²
                    labels: { font: { size: 12, weight: 'bold' }, color: 'black' },
                    nodeWidth: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = context.raw;
                                return `${item.from} -> ${item.to}: ${item.flow}äºº`;
                            }
                        }
                    }
                }
            }
        });
    }

    function toggleAIChat() {
        const box = document.getElementById('ai-chat-box');
        box.classList.toggle('hidden');
        if(!box.classList.contains('hidden')) document.getElementById('ai-chat-input').focus();
    }

    function addChatBubble(html, type) {
        const container = document.getElementById('ai-chat-messages');
        const div = document.createElement('div');
        div.className = `ai-msg-bubble ${type}`;
        div.innerHTML = html;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // 1. å‡†å¤‡æ•°æ®ä¸Šä¸‹æ–‡ (åˆå¹¶ æˆç»© + è¿›é€€æ­¥ + æ’å)
    function prepareDataForAI() {
        if (!RAW_DATA.length) return [];
        // å»ºç«‹è¿›é€€æ­¥ç´¢å¼•
        const progressMap = {};
        if (PROGRESS_CACHE && PROGRESS_CACHE.length) {
            PROGRESS_CACHE.forEach(p => {
                progressMap[p.name + '_' + p.class] = p.change; // æ­£æ•°=è¿›æ­¥
            });
        }

        return RAW_DATA.map(s => {
            return {
                name: s.name,
                school: s.school,
                class: s.class,
                total: s.total,
                scores: s.scores, // {è¯­æ–‡:90, æ•°å­¦:80...}
                townRank: safeGet(s, 'ranks.total.township', 9999),
                classRank: safeGet(s, 'ranks.total.class', 999),
                progress: progressMap[s.name + '_' + s.class] || 0 // è¿›é€€æ­¥
            };
        });
    }

    async function sendAIChat() {
        const input = document.getElementById('ai-chat-input');
        const query = input.value.trim();
        if (!query) return;
        
        if (!LLM_CONFIG.apiKey) {
            addChatBubble("âš ï¸ è¯·å…ˆåœ¨ã€æ•°æ®ä¸­å¿ƒã€‘é…ç½® AI API Key æ‰èƒ½ä½¿ç”¨æ™ºèƒ½æŸ¥è¯¢ã€‚", "system");
            return;
        }

        addChatBubble(query, "user");
        input.value = '';
        addChatBubble("ğŸ¤– æ­£åœ¨åˆ†ææ•°æ®...", "system");

        // 2. æ„å»º Promptï¼šå‘Šè¯‰ AI æ•°æ®ç»“æ„ï¼Œè®©å®ƒå†™ä»£ç 
        const dataContext = prepareDataForAI();
        if (dataContext.length === 0) {
            addChatBubble("âŒ å½“å‰æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æˆç»©ã€‚", "system");
            return;
        }

        const subjectsStr = SUBJECTS.join(',');
        const prompt = `
        ä½ æ˜¯ä¸€ä¸ªæ•°æ®æŸ¥è¯¢ç”Ÿæˆå™¨ã€‚
        ã€æ•°æ®ç»“æ„ã€‘
        å˜é‡å: data
        ç±»å‹: Array<Student>
        Studentç»“æ„: {
            name: String,
            school: String,
            class: String, // ä¾‹å¦‚ "701", "802"
            total: Number, // æ€»åˆ†
            scores: { "${subjectsStr}": Number }, // å„ç§‘æˆç»©
            townRank: Number, // å…¨é•‡æ’å (è¶Šå°è¶Šå¥½)
            progress: Number // è¿›é€€æ­¥ (æ­£æ•°=è¿›æ­¥, è´Ÿæ•°=é€€æ­¥, 0=æ— æ•°æ®)
        }
        
        ã€ä»»åŠ¡ã€‘
        æ ¹æ®ç”¨æˆ·é—®é¢˜ï¼š"${query}"
        ç¼–å†™ä¸€æ®µ JavaScript ä»£ç ï¼Œä» \`data\` æ•°ç»„ä¸­ç­›é€‰å¹¶æ’åºï¼Œè¿”å›ç»“æœæ•°ç»„ã€‚
        
        ã€è¦æ±‚ã€‘
        1. ä»…è¿”å›ä»£ç ï¼Œä¸è¦Markdownæ ‡è®°ï¼Œä¸è¦è§£é‡Šã€‚
        2. ä»£ç å¿…é¡»ä»¥ \`return data.filter(...).sort(...).slice(0, N)\` çš„å½¢å¼ç»“æŸã€‚
        3. å¦‚æœç”¨æˆ·é—®â€œä¸åŠæ ¼â€ï¼Œé»˜è®¤æŒ‡åˆ†æ•° < 60%æ»¡åˆ†ï¼ˆå‡è®¾æ»¡åˆ†100åˆ™<60ï¼Œæ»¡åˆ†120åˆ™<72ï¼‰ã€‚ä½ å¯è‡ªè¡Œè®¾å®šé˜ˆå€¼æˆ–ç®€å•æŒ‰ < 60 å¤„ç†ã€‚
        4. ç»“æœæœ€å¤šè¿”å› 20 æ¡ã€‚
        5. åªèƒ½ä½¿ç”¨ JS æ ‡å‡†æ•°ç»„æ–¹æ³• (filter, sort, slice, map)ã€‚
        `;

        try {
            // 3. è°ƒç”¨ LLM
            let jsCode = "";
            await new Promise((resolve) => {
                callLLM(prompt, null, (fullText) => { jsCode = fullText; resolve(); });
            });

            // æ¸…æ´—ä»£ç  (å»æ‰ ```javascript ç­‰)
            jsCode = jsCode.replace(/```javascript/g, '').replace(/```/g, '').trim();
            console.log("AI Generated Code:", jsCode);

            // 4. æ²™ç®±æ‰§è¡Œä»£ç 
            const result = executeAICode(jsCode, dataContext);
            
            // 5. æ¸²æŸ“ç»“æœ
            renderAIChatResult(result, query);

        } catch (err) {
            console.error(err);
            addChatBubble(`âŒ æŸ¥è¯¢å¤±è´¥: ${err.message}`, "system");
        }
    }

    function executeAICode(code, data) {
        try {
            // ä½¿ç”¨ new Function åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„æ‰§è¡Œç¯å¢ƒ
            // ä¼ å…¥ data å˜é‡
            const func = new Function('data', code);
            const res = func(data);
            if (!Array.isArray(res)) throw new Error("AI ç”Ÿæˆçš„ä»£ç æœªè¿”å›æ•°ç»„");
            return res;
        } catch (e) {
            throw new Error("ä»£ç æ‰§è¡Œé”™è¯¯: " + e.message);
        }
    }

    function renderAIChatResult(list, query) {
        const lastMsg = document.querySelector('#ai-chat-messages .ai-msg-bubble.system:last-child');
        
        if (!list || list.length === 0) {
            lastMsg.innerHTML = `ğŸ” æŸ¥è¯¢ "${query}"<br>ç»“æœï¼šæœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿã€‚`;
            return;
        }

        let tableHtml = `<div style="margin-bottom:5px; font-weight:bold;">âœ… æ‰¾åˆ° ${list.length} æ¡ç»“æœ:</div>
        <div class="table-wrap" style="max-height:200px; overflow-y:auto; box-shadow:none; margin:0;">
        <table class="ai-chat-table">
            <thead><tr><th>ç­çº§</th><th>å§“å</th><th>æ€»åˆ†</th><th>è¯¦æƒ…</th></tr></thead>
            <tbody>`;
        
        list.forEach(s => {
            // æ™ºèƒ½å±•ç¤ºè¯¦æƒ…ï¼šå¦‚æœæŸ¥è¯¢æåˆ°äº†æŸç§‘ï¼Œå°±æ˜¾ç¤ºæŸç§‘æˆç»©ï¼›æåˆ°äº†è¿›æ­¥ï¼Œæ˜¾ç¤ºè¿›æ­¥
            let detail = `æ’:${s.townRank}`;
            if (query.includes("è¿›æ­¥") || query.includes("é€€æ­¥")) {
                const p = s.progress > 0 ? `+${s.progress}` : s.progress;
                detail = `<span style="color:${s.progress>0?'green':'red'}">å˜${p}</span>`;
            } else {
                // ç®€å•çš„å°è¯•æ‰¾ä¸€ä¸‹åç§‘æˆ–è€…å•ç§‘
                SUBJECTS.forEach(sub => {
                    if (query.includes(sub)) detail = `${sub}:${s.scores[sub]}`;
                });
            }

            tableHtml += `<tr>
                <td>${s.class}</td>
                <td>${s.name}</td>
                <td>${s.total}</td>
                <td>${detail}</td>
            </tr>`;
        });
        tableHtml += `</tbody></table></div>`;
        
        lastMsg.innerHTML = tableHtml;
    }

    function exportProgressAnalysis() {
        if(!PROGRESS_CACHE.length) return alert("æš‚æ— åˆ†æç»“æœï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ");
        const wb = XLSX.utils.book_new(); const data = [['ç­çº§', 'å§“å', 'æœ¬æ¬¡æ€»åˆ†', 'æœ¬æ¬¡é•‡æ’', 'ä¸Šæ¬¡æ€»åˆ†', 'ä¸Šæ¬¡é•‡æ’', 'åæ¬¡å˜åŒ–(æ­£è¿›è´Ÿé€€)']];
        PROGRESS_CACHE.forEach(r => { data.push([r.class, r.name, r.currTotal, r.currRank, r.prevTotal, r.prevRank, r.change]); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "è¿›é€€æ­¥åˆ†æ"); XLSX.writeFile(wb, "å­¦ç”Ÿè¿›é€€æ­¥è¿½è¸ªåˆ†æè¡¨.xlsx");
    }

    // å…¨å±€çŠ¶æ€ç®¡ç†
    let STD_STATE = {
        page: 1,
        size: 100,
        sortCol: null,     // å½“å‰æ’åºåˆ—
        sortDir: 'desc',   // desc æˆ– asc
        activeFilters: {}, // å­˜å‚¨ç­›é€‰çŠ¶æ€: { 'school': new Set(['å®éªŒä¸­å­¦', 'äºŒä¸­']), 'è¯­æ–‡': ... }
        cacheData: []      // æœ€ç»ˆå±•ç¤ºçš„æ•°æ®
    };

    // 1. ä¸»æ¸²æŸ“å‡½æ•°
    function renderStudentDetails(reset = true) {
        // éšè—å¯èƒ½å­˜åœ¨çš„ç­›é€‰èœå•
        closeAllMenus();

        if (reset) {
            STD_STATE.page = 1;
            let data = [...RAW_DATA]; // ä»åŸå§‹æ•°æ®å‰¯æœ¬å¼€å§‹

            // --- A. æƒé™è¿‡æ»¤ (ä¿æŒä¸å˜) ---
            if (typeof Auth !== 'undefined' && Auth.currentUser) {
                 const user = Auth.currentUser;
                 if (user.role !== 'admin' && user.role !== 'director' && user.school) {
                     data = data.filter(s => s.school === user.school);
                 }
                 if (user.role === 'class_teacher') {
                     // ç­ä¸»ä»»åªèƒ½çœ‹æœ¬ç­æˆ–ä»»æ•™ç­çº§ (ç®€åŒ–é€»è¾‘ï¼Œè¯¦ç»†é€»è¾‘è§åŸä»£ç )
                     data = data.filter(s => s.class == user.class);
                 }
            }

            // --- B. é¡¶éƒ¨ä¸‹æ‹‰æ¡†è¿‡æ»¤ (ä¾ç„¶ä¿ç•™ï¼Œä½œä¸ºä¸€çº§ç­›é€‰) ---
            const selectedSchool = document.getElementById('studentSchoolSelect')?.value; 
            const selectedClass = document.getElementById('studentClassSelect')?.value;
            
            if (selectedSchool && !selectedSchool.includes('è¯·é€‰æ‹©')) {
                data = data.filter(s => s.school === selectedSchool);
                if (selectedClass && selectedClass !== 'å…¨éƒ¨') {
                    data = data.filter(s => s.class === selectedClass);
                }
            }

            // --- C. Excel åˆ—ç­›é€‰ (æ ¸å¿ƒé€»è¾‘) ---
            // éå†æ‰€æœ‰å·²æ¿€æ´»çš„ç­›é€‰å™¨
            Object.keys(STD_STATE.activeFilters).forEach(colKey => {
                const allowedValues = STD_STATE.activeFilters[colKey]; // Set å¯¹è±¡
                if (!allowedValues || allowedValues.size === 0) return; 

                data = data.filter(s => {
                    let val = getCellValue(s, colKey);
                    // å°†å€¼ç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”å¯¹
                    return allowedValues.has(String(val));
                });
            });

            // --- D. æ’åº ---
            if (STD_STATE.sortCol) {
                const key = STD_STATE.sortCol;
                const dir = STD_STATE.sortDir === 'asc' ? 1 : -1;
                
                data.sort((a, b) => {
                    let valA = getCellValue(a, key);
                    let valB = getCellValue(b, key);
                    
                    // å¤„ç†ç©ºå€¼
                    if (valA === '-' || valA === undefined) valA = -9999;
                    if (valB === '-' || valB === undefined) valB = -9999;

                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return (valA - valB) * dir;
                    }
                    return String(valA).localeCompare(String(valB), 'zh-CN', {numeric: true}) * dir;
                });
            } else {
                // é»˜è®¤æŒ‰æ€»åˆ†é™åº
                data.sort((a, b) => b.total - a.total);
            }

            STD_STATE.cacheData = data;
        }

        // --- E. åˆ†é¡µä¸æ¸²æŸ“ ---
        const totalItems = STD_STATE.cacheData.length;
        const totalPages = Math.ceil(totalItems / STD_STATE.size) || 1;
        if (STD_STATE.page > totalPages) STD_STATE.page = totalPages;
        if (STD_STATE.page < 1) STD_STATE.page = 1;

        const startIdx = (STD_STATE.page - 1) * STD_STATE.size;
        const endIdx = startIdx + STD_STATE.size;
        const displayList = STD_STATE.cacheData.slice(startIdx, endIdx);

        const thead = document.querySelector('#studentDetailTable thead tr'); 
        const tbody = document.querySelector('#studentDetailTable tbody');

        // ç”Ÿæˆè¡¨å¤´ (å¸¦æ¼æ–—å›¾æ ‡)
        let headerHTML = '';
        
        // è¾…åŠ©ï¼šç”Ÿæˆè¡¨å¤´å•å…ƒæ ¼
        const buildTh = (label, colKey, width='auto') => {
            // åˆ¤æ–­è¯¥åˆ—æ˜¯å¦æœ‰æ¿€æ´»çš„ç­›é€‰
            const isFiltered = STD_STATE.activeFilters[colKey] && STD_STATE.activeFilters[colKey].size > 0;
            // åˆ¤æ–­è¯¥åˆ—æ˜¯å¦æ­£åœ¨æ’åº
            const isSorted = STD_STATE.sortCol === colKey;
            const sortIcon = isSorted ? (STD_STATE.sortDir === 'asc' ? 'â†‘' : 'â†“') : '';
            
            const activeClass = (isFiltered || isSorted) ? 'active' : '';
            
            return `
                <th style="min-width:${width}">
                    <div class="excel-header" onclick="toggleExcelMenu('${colKey}', event)">
                        <div class="header-text">${label} <span style="color:#2563eb">${sortIcon}</span></div>
                        <div class="filter-icon-btn ${activeClass}">
                            <i class="ti ti-filter"></i>
                        </div>
                        <!-- ä¸‹æ‹‰èœå•å®¹å™¨ï¼Œç‚¹å‡»æ—¶åŠ¨æ€å¡«å…… -->
                        <div id="menu-${colKey}" class="excel-filter-menu" onclick="event.stopPropagation()"></div>
                    </div>
                </th>
            `;
        };

        headerHTML += buildTh('å­¦æ ¡', 'school', '120px');
        headerHTML += buildTh('ç­çº§', 'class', '80px');
        headerHTML += buildTh('å§“å', 'name', '100px');
        headerHTML += buildTh('è€ƒå·', 'id', '100px');
        headerHTML += buildTh('è€ƒåœº', 'examRoom', '80px');
        headerHTML += buildTh('Tåˆ†', 'totalTScore', '60px');

                // åŠ¨æ€åˆ¤æ–­å½“å‰æ•°æ®æ˜¯å¦åªæœ‰ä¸€æ‰€å­¦æ ¡
        const isSingleSchool = Object.keys(SCHOOLS).length === 1;
        const townHeaderStyle = isSingleSchool ? 'display:none;' : ''; // å¦‚æœå•æ ¡ï¼Œéšè—åˆ—

        SUBJECTS.forEach(sub => {
            headerHTML += buildTh(sub, sub, '80px');
            // æ ¡å†…æ’åå§‹ç»ˆæ˜¾ç¤ºï¼Œå…¨é•‡æ’åæŒ‰éœ€éšè—
            headerHTML += `<th>T</th><th>æ ¡</th><th>ç­</th><th style="${townHeaderStyle}">é•‡</th>`; 
        });

        const totalLabel = CONFIG.name === '9å¹´çº§' ? 'äº”ç§‘æ€»åˆ†' : 'æ€»åˆ†';
        headerHTML += buildTh(totalLabel, 'total', '80px');
        headerHTML += `<th>æ ¡</th><th>ç­</th><th style="${townHeaderStyle}">é•‡</th>`;

        thead.innerHTML = headerHTML;

        // ç”Ÿæˆæ•°æ®è¡Œ
        let rowsHTML = displayList.map(student => {
            const nameLink = `<a href="javascript:void(0)" onclick="jumpToStudent('${student.name}', '${student.school}', '${student.class}')" style="color:var(--primary); font-weight:800;">${student.name}</a>`;
            
            let row = `<tr>
                <td>${student.school}</td>
                <td>${student.class}</td>
                <td>${nameLink}</td>
                <td>${student.id}</td>
                <td>${student.examRoom || '-'}</td>
                <td style="color:#b45309; font-weight:bold;">${student.totalTScore || '-'}</td>`;

            SUBJECTS.forEach(sub => {
                const score = student.scores[sub] !== undefined ? student.scores[sub] : '-';
                const t = student.tScores ? (student.tScores[sub] || '-') : '-';
                
                // ä¿®æ”¹åŠŸèƒ½é“¾æ¥
                const clickAttr = `onclick="updateStudentScore('${student.name}', '${student.class}', '${sub}', ${score})"`;
                
                row += `<td ${clickAttr} style="cursor:pointer;" title="ç‚¹å‡»ä¿®æ”¹">${score}</td>
                        <td class="text-gray">${t}</td>
                        <td class="text-gray">${safeGet(student, `ranks.${sub}.school`, '-')}</td>
                        <td class="text-gray">${safeGet(student, `ranks.${sub}.class`, '-')}</td>
                        <td class="text-gray" style="${townHeaderStyle}">${safeGet(student, `ranks.${sub}.township`, '-')}</td>`;
            });

            row += `<td style="color:#2563eb; font-weight:bold;">${student.total}</td>
                    <td>${safeGet(student, 'ranks.total.school', '-')}</td>
                    <td>${safeGet(student, 'ranks.total.class', '-')}</td>
                    <td>${safeGet(student, 'ranks.total.township', '-')}</td>
                </tr>`;
            return row;
        }).join('');

        // åˆ†é¡µæ¡
        const paginationHTML = `
            <tr style="background:#f8fafc; font-weight:bold; position:sticky; bottom:0; z-index:150; border-top:2px solid #cbd5e1;">
                <td colspan="100" style="text-align:center; padding:8px;">
                    <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                        <span style="font-size:12px; color:#666;">å…± ${totalItems} æ¡ Â· ${STD_STATE.page}/${totalPages} é¡µ</span>
                        <button class="btn btn-sm" onclick="changeStdPage(-1)" ${STD_STATE.page===1?'disabled':''}>â—€</button>
                        <button class="btn btn-sm" onclick="changeStdPage(1)" ${STD_STATE.page===totalPages?'disabled':''}>â–¶</button>
                    </div>
                </td>
            </tr>`;

        if(totalItems === 0) tbody.innerHTML = `<tr><td colspan="100" style="text-align:center; padding:30px; color:#999;">æ— æ•°æ®</td></tr>`;
        else tbody.innerHTML = rowsHTML + paginationHTML;
    }

    // è¾…åŠ©ï¼šè·å–å•å…ƒæ ¼å€¼
    function getCellValue(student, colKey) {
        if (colKey === 'total') return student.total;
        if (colKey === 'totalTScore') return student.totalTScore;
        if (['school','class','name','id','examRoom'].includes(colKey)) return student[colKey];
        return student.scores[colKey] !== undefined ? student.scores[colKey] : '-';
    }

    // 2. åˆ‡æ¢æ˜¾ç¤º Excel èœå•
    function toggleExcelMenu(colKey, event) {
        // é˜»æ­¢å†’æ³¡
        event.stopPropagation();
        
        const menuId = `menu-${colKey}`;
        const menu = document.getElementById(menuId);
        
        // å¦‚æœè¯¥èœå•å·²æ‰“å¼€ï¼Œåˆ™å…³é—­
        if (menu.classList.contains('show')) {
            menu.classList.remove('show');
            return;
        }

        // å…³é—­å…¶ä»–æ‰€æœ‰èœå•
        closeAllMenus();

        // å¡«å……èœå•å†…å®¹
        buildFilterMenuContent(colKey, menu);
        
        // æ˜¾ç¤º
        menu.classList.add('show');
    }

    // 3. æ„å»ºèœå•å†…å®¹ (æ ¸å¿ƒï¼šæå–å”¯ä¸€å€¼)
    function buildFilterMenuContent(colKey, container) {
        // ç®€å•ç­–ç•¥ï¼šä»å½“å‰æ˜¾ç¤ºçš„ cacheData ä¸­æå–å”¯ä¸€å€¼
        const uniqueValues = new Set();
        STD_STATE.cacheData.forEach(s => {
            let val = getCellValue(s, colKey);
            uniqueValues.add(String(val));
        });

        // è½¬ä¸ºæ•°ç»„å¹¶æ’åº
        const sortedValues = Array.from(uniqueValues).sort((a,b) => {
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
            return a.localeCompare(b, 'zh-CN', {numeric:true});
        });

        // æ£€æŸ¥å“ªäº›è¢«é€‰ä¸­äº†
        const currentSet = STD_STATE.activeFilters[colKey]; 
        const isAllChecked = !currentSet; 
        
        let listHtml = '';
        sortedValues.forEach(v => {
            const checked = isAllChecked || currentSet.has(v) ? 'checked' : '';
            listHtml += `
                <label class="menu-item">
                    <input type="checkbox" value="${v}" ${checked} class="filter-cb-${colKey}"> ${v}
                </label>`;
        });

        container.innerHTML = `
            <div class="menu-actions">
                <button class="btn btn-sm btn-gray" style="width:100%" onclick="applySort('${colKey}', 'asc')">â¬†ï¸ å‡åºæ’åˆ—</button>
                <button class="btn btn-sm btn-gray" style="width:100%" onclick="applySort('${colKey}', 'desc')">â¬‡ï¸ é™åºæ’åˆ—</button>
                <input type="text" class="menu-search" placeholder="æœç´¢..." oninput="filterCheckboxList(this)">
            </div>
            <div class="menu-list">
                <label class="menu-item" style="font-weight:bold; border-bottom:1px solid #eee;">
                    <input type="checkbox" id="cb-all-${colKey}" ${isAllChecked?'checked':''} onchange="toggleAllCheckboxes('${colKey}', this)"> (å…¨é€‰)
                </label>
                ${listHtml}
            </div>
            <div class="menu-footer">
                <button class="btn btn-sm btn-primary" onclick="confirmFilter('${colKey}')">ç¡®å®š</button>
                <button class="btn btn-sm btn-gray" onclick="clearFilter('${colKey}')">é‡ç½®</button>
            </div>
        `;
    }

    // 4. èœå•å†…éƒ¨äº¤äº’å‡½æ•°
    window.applySort = function(colKey, dir) {
        STD_STATE.sortCol = colKey;
        STD_STATE.sortDir = dir;
        renderStudentDetails(true); // é‡ç»˜
    };

    window.filterCheckboxList = function(input) {
        const text = input.value.toLowerCase();
        const list = input.closest('.menu-actions').nextElementSibling;
        const items = list.querySelectorAll('.menu-item');
        // è·³è¿‡ç¬¬ä¸€ä¸ª(å…¨é€‰)
        for (let i = 1; i < items.length; i++) {
            const itemText = items[i].innerText.toLowerCase();
            items[i].style.display = itemText.includes(text) ? 'flex' : 'none';
        }
    };

    window.toggleAllCheckboxes = function(colKey, source) {
        const cbs = document.querySelectorAll(`.filter-cb-${colKey}`);
        cbs.forEach(cb => {
            if(cb.parentElement.style.display !== 'none') {
                cb.checked = source.checked;
            }
        });
    };

    window.confirmFilter = function(colKey) {
        const cbs = document.querySelectorAll(`.filter-cb-${colKey}:checked`);
        const allCbs = document.querySelectorAll(`.filter-cb-${colKey}`);
        
        if (cbs.length === allCbs.length) {
            delete STD_STATE.activeFilters[colKey];
        } else {
            const selectedValues = new Set();
            cbs.forEach(cb => selectedValues.add(cb.value));
            STD_STATE.activeFilters[colKey] = selectedValues;
        }
        
        renderStudentDetails(true);
    };

    window.clearFilter = function(colKey) {
        delete STD_STATE.activeFilters[colKey];
        renderStudentDetails(true);
    };

    function closeAllMenus() {
        document.querySelectorAll('.excel-filter-menu').forEach(el => el.classList.remove('show'));
    }

    // ç‚¹å‡»ç©ºç™½å…³é—­èœå•
    document.addEventListener('click', closeAllMenus);

    // è¾…åŠ©ï¼šç¿»é¡µ
    window.changeStdPage = function(delta) {
        STD_STATE.page += delta;
        renderStudentDetails(false); 
        document.querySelector('#student-details .table-wrap').scrollTop = 0;
    };


    function exportStudentDetails() {
        if (!RAW_DATA.length) { alert('è¯·å…ˆä¸Šä¼ æ•°æ®'); return; }
        
        const selectedSchool = document.getElementById('studentSchoolSelect').value; 
        const selectedClass = document.getElementById('studentClassSelect').value;
        
        // 1. åˆ¤æ–­æ˜¯å¦ä¸ºå•æ ¡æ¨¡å¼ (åªæœ‰1æ‰€å­¦æ ¡)
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;

        const wb = XLSX.utils.book_new(); 
        
        // 2. åŠ¨æ€æ„å»ºè¡¨å¤´
        const headers = ['å­¦æ ¡', 'ç­çº§', 'å§“å', 'è€ƒå·', 'è€ƒåœº', 'æ ‡å‡†åˆ†æ€»å’Œ(Tåˆ†)'];
        
        SUBJECTS.forEach(subject => {
            headers.push(`${subject} åˆ†æ•°`, `${subject} Tåˆ†`, `${subject} æ ¡æ’`, `${subject} ç­æ’`);
            // ğŸŸ¢ å¦‚æœä¸æ˜¯å•æ ¡ï¼Œæ‰åŠ é•‡æ’
            if (!isSingleSchool) headers.push(`${subject} é•‡æ’`);
        });

        if (CONFIG.name === '9å¹´çº§') {
            headers.push('äº”ç§‘æ€»åˆ†', 'äº”ç§‘æ ¡æ’', 'äº”ç§‘ç­æ’');
            if (!isSingleSchool) headers.push('äº”ç§‘é•‡æ’');
        } else {
            headers.push('æ€»åˆ†', 'æ€»åˆ†æ ¡æ’', 'æ€»åˆ†ç­æ’');
            if (!isSingleSchool) headers.push('æ€»åˆ†é•‡æ’');
        }
        
        const data = [headers]; 
        
        let studentsToShow = [...RAW_DATA]; 
        if(selectedSchool && !selectedSchool.includes('è¯·é€‰æ‹©')) { 
            studentsToShow = studentsToShow.filter(s => s.school === selectedSchool); 
            if(selectedClass && selectedClass !== 'å…¨éƒ¨') studentsToShow = studentsToShow.filter(s => s.class === selectedClass); 
        } 
        studentsToShow.sort((a, b) => b.total - a.total);
        
        // 3. å¡«å……æ•°æ®è¡Œ (éœ€ä¸è¡¨å¤´é€»è¾‘ä¸¥æ ¼å¯¹åº”)
        studentsToShow.forEach(student => {
            const row = [student.school, student.class, student.name, student.id, student.examRoom, student.totalTScore || 0]; 
            
            SUBJECTS.forEach(subject => {
                const tVal = student.tScores && student.tScores[subject] ? student.tScores[subject] : '-';
                
                row.push(
                    student.scores[subject] || '-', 
                    tVal, 
                    safeGet(student, `ranks.${subject}.school`, '-'), 
                    safeGet(student, `ranks.${subject}.class`, '-')
                );
                // ğŸŸ¢ å¦‚æœä¸æ˜¯å•æ ¡ï¼Œæ‰åŠ é•‡æ’æ•°æ®
                if (!isSingleSchool) {
                    row.push(safeGet(student, `ranks.${subject}.township`, '-'));
                }
            });

            row.push(
                student.total, 
                safeGet(student, 'ranks.total.school', '-'), 
                safeGet(student, 'ranks.total.class', '-')
            );
            // ğŸŸ¢ å¦‚æœä¸æ˜¯å•æ ¡ï¼Œæ‰åŠ é•‡æ’æ•°æ®
            if (!isSingleSchool) {
                row.push(safeGet(student, 'ranks.total.township', '-'));
            }

            data.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // è°ƒç”¨è£…é¥°å‡½æ•°ç¾åŒ– Excel
        decorateExcelSheet(ws, headers);
        
        XLSX.utils.book_append_sheet(wb, ws, 'å­¦ç”Ÿè€ƒè¯•æ˜ç»†'); 
        XLSX.writeFile(wb, 'å­¦ç”Ÿè€ƒè¯•æ˜ç»†.xlsx');
    }

// ğŸŸ¢ [æ–°å¢] æ ¸å¿ƒåŠŸèƒ½ï¼šç®¡ç†å‘˜/çº§éƒ¨ä¸»ä»»ä¿®æ”¹æˆç»©å¹¶åŒæ­¥äº‘ç«¯
    async function updateStudentScore(name, cls, subject, oldScore) {
        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ ä¿®æ”¹ï¼šæƒé™æ ¡éªŒé€»è¾‘ (æ”¯æŒçº§éƒ¨ä¸»ä»») ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
        // 1. æƒé™ä¸èº«ä»½æ ¡éªŒ
        const user = typeof Auth !== 'undefined' ? Auth.currentUser : null;
        if (!user) return alert("è¯·å…ˆç™»å½•ç³»ç»Ÿ");

        const role = user.role;
        
        // å…è®¸: ç®¡ç†å‘˜(admin) å’Œ çº§éƒ¨ä¸»ä»»(grade_director)
        if (role !== 'admin' && role !== 'grade_director') {
            return alert("â›” æƒé™ä¸è¶³ï¼šåªæœ‰ã€ç®¡ç†å‘˜ã€‘æˆ–ã€çº§éƒ¨ä¸»ä»»ã€‘å¯ä»¥ä¿®æ”¹åŸå§‹æˆç»©ã€‚\n\n(ç§‘ä»»æ•™å¸ˆæˆ–ç­ä¸»ä»»å¦‚éœ€ä¿®æ”¹ï¼Œè¯·è”ç³»ä¸Šçº§æˆ–é‡æ–°ä¸Šä¼ Excel)");
        }

        // çº§éƒ¨ä¸»ä»»ç‰¹æœ‰æ£€æŸ¥ï¼šåªèƒ½ä¿®æ”¹æœ¬å¹´çº§çš„ç­çº§
        if (role === 'grade_director') {
            // æ•°æ®åº“ä¸­ class_name å­˜çš„æ˜¯çº§éƒ¨åç§°(å¦‚ "7" æˆ– "ä¸ƒ")
            const myGrade = String(user.class || "").trim(); 
            const targetClass = String(cls).trim();

            // ç®€å•é€»è¾‘ï¼šç­çº§åå¿…é¡»ä»¥çº§éƒ¨åå¼€å¤´ (ä¾‹å¦‚ "7" åŒ¹é… "701", "705")
            // å¦‚æœçº§éƒ¨æ˜¯ä¸­æ–‡ "ä¸ƒ"ï¼Œè€Œç­çº§æ˜¯ "701"ï¼Œå¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ˜ å°„ï¼Œè¿™é‡Œå‡è®¾è¾“å…¥ä¸€è‡´
            if (!myGrade || !targetClass.startsWith(myGrade)) {
                return alert(`â›” è¶Šæƒæ“ä½œæ‹¦æˆªï¼\n\næ‚¨æ˜¯ã€${myGrade}å¹´çº§ã€‘ä¸»ä»»ï¼Œæ— æƒä¿®æ”¹ã€${targetClass}ç­ã€‘çš„æˆç»©ã€‚`);
            }
        }
        /* ğŸ‘†ğŸ‘†ğŸ‘† ğŸŸ¢ ç»“æŸ ğŸŸ¢ ğŸ‘†ğŸ‘†ğŸ‘† */

        // 2. å¼¹å‡ºè¾“å…¥æ¡†
        const newScoreStr = prompt(`ğŸ“ æ­£åœ¨ä¿®æ”¹æˆç»©\n\nå­¦ç”Ÿï¼š${cls}ç­ ${name}\nç§‘ç›®ï¼š${subject}\n\nå½“å‰åˆ†æ•°ï¼š${oldScore}\nè¯·è¾“å…¥æ–°åˆ†æ•°ï¼š`, oldScore);
        
        // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
        if (newScoreStr === null) return; 
        
        const newScore = parseFloat(newScoreStr);
        if (isNaN(newScore)) return alert("âŒ è¾“å…¥é”™è¯¯ï¼šè¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼");
        if (newScore === oldScore) return; // åˆ†æ•°æ²¡å˜ï¼Œä¸åšå¤„ç†

        // 3. åœ¨å†…å­˜æ•°æ®ä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
        // ä½¿ç”¨ å§“å + ç­çº§ + å­¦æ ¡ ç»„åˆé”®è¿›è¡Œç²¾ç¡®æŸ¥æ‰¾
        const student = RAW_DATA.find(s => s.name === name && s.class === cls && s.school === (window.MY_SCHOOL || s.school));
        
        if (!student) {
            return alert("âŒ é”™è¯¯ï¼šæœªåœ¨å†…å­˜ä¸­æ‰¾åˆ°è¯¥å­¦ç”Ÿæ•°æ®ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚");
        }

        // æ›´æ–°å•ç§‘æˆç»©
        student.scores[subject] = newScore;
        
        // 4. é‡æ–°è®¡ç®—è¯¥å­¦ç”Ÿçš„æ€»åˆ†
        // é€»è¾‘ï¼šåˆ¤æ–­å½“å‰æ¨¡å¼ï¼ˆ9å¹´çº§äº”ç§‘æ¨¡å¼ vs å…¨ç§‘æ¨¡å¼ï¼‰
        let newTotal = 0;
        let subjectsToCount = [];

        if (CONFIG && CONFIG.name && CONFIG.name.includes('9')) {
            // 9å¹´çº§æ¨¡å¼ï¼šåªç´¯åŠ è¯­æ•°è‹±ç‰©åŒ–
            subjectsToCount = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦'];
        } else {
            // å…¶ä»–æ¨¡å¼ï¼šCONFIG.totalSubs å¦‚æœæ˜¯ 'auto' åˆ™ç´¯åŠ æ‰€æœ‰ç§‘ç›®
            subjectsToCount = (CONFIG.totalSubs === 'auto') ? SUBJECTS : CONFIG.totalSubs;
        }
        
        // æ‰§è¡Œç´¯åŠ 
        subjectsToCount.forEach(sub => {
            const val = student.scores[sub];
            if (typeof val === 'number') {
                newTotal += val;
            }
        });
        
        student.total = parseFloat(newTotal.toFixed(2)); // ä¿æŒ2ä½å°æ•°

        // 5. å…¨å±€é‡ç®— (è§¦å‘ Worker é‡æ–°æ’åã€è®¡ç®—ä¸¤ç‡ä¸€åˆ†)
        UI.loading(true, "æ­£åœ¨é‡æ–°æ’åå¹¶åŒæ­¥äº‘ç«¯...");
        
        try {
            await processData(); // ç­‰å¾… Worker è®¡ç®—å®Œæˆ
            
            // 6. ä¿å­˜åˆ° Supabase äº‘ç«¯ (å…³é”®æ­¥éª¤)
            await saveCloudData();
            
            // 7. åˆ·æ–°ç•Œé¢
            renderStudentDetails(false); // åˆ·æ–°åˆ—è¡¨ï¼Œfalseè¡¨ç¤ºä¸é‡ç½®é¡µç 
            renderTables(); // åˆ·æ–°å®è§‚åˆ†æè¡¨
            
            UI.loading(false);
            UI.toast(`âœ… ä¿®æ”¹æˆåŠŸï¼\n${name} çš„ ${subject} å·²æ›´æ–°ä¸º ${newScore}\næ€»åˆ†æ›´æ–°ä¸º ${student.total}`, "success");
 
            // ğŸ›¡ï¸ [æ—¥å¿—åŸ‹ç‚¹] è®°å½•æˆç»©ä¿®æ”¹æ“ä½œ
            Logger.log('ä¿®æ”¹æˆç»©', `${cls}ç­ ${name} - ${subject}: ${oldScore} -> ${newScore} (æ€»åˆ†:${student.total}) [æ“ä½œäºº:${user.name}]`);
           
        } catch (err) {
            UI.loading(false);
            console.error(err);
            alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + err.message);
        }
    }
    function generateMobileLongImage() {
        const sch = document.getElementById('studentSchoolSelect').value;
        const cls = document.getElementById('studentClassSelect').value;
        if (!sch || !cls || cls === 'å…¨éƒ¨' || sch.includes('è¯·é€‰æ‹©')) return alert("è¯·å…ˆé€‰æ‹©å…·ä½“çš„ã€å­¦æ ¡ã€‘å’Œã€ç­çº§ã€‘ï¼");

        const students = RAW_DATA.filter(s => s.school === sch && s.class === cls);
        if (students.length === 0) return alert("è¯¥ç­çº§æ— æ•°æ®");
        
        // 1. æ•°æ®å‡†å¤‡
        students.sort((a, b) => b.total - a.total);
        const avg = students.reduce((a, b) => a + b.total, 0) / students.length;
        const max = students[0].total;
        
        // 2. æ¸²æŸ“å®¹å™¨
        const container = document.getElementById('mobile-share-render-area');
        const dateStr = new Date().toLocaleDateString();
        
        // åªå±•ç¤ºå‰ 15 åï¼Œé¿å…å›¾ç‰‡è¿‡é•¿ï¼Œæˆ–è€…å…¨éƒ¨å±•ç¤ºï¼ˆè§†éœ€æ±‚è€Œå®šï¼Œè¿™é‡Œå±•ç¤ºå‰15+åº•éƒ¨æç¤ºï¼‰
        const displayLimit = 15;
        let topListHtml = '';
        
        students.slice(0, displayLimit).forEach((s, i) => {
            let rankClass = 'background:#f1f5f9; color:#64748b;'; // é»˜è®¤æ™®é€šæ’å
            let rankIcon = i + 1;
            
            // å‰ä¸‰åç‰¹æ®Šæ ·å¼
            if (i === 0) { rankClass = 'background:#fee2e2; color:#dc2626; border:1px solid #fecaca;'; rankIcon = 'ğŸ¥‡'; } 
            else if (i === 1) { rankClass = 'background:#ffedd5; color:#c2410c; border:1px solid #fed7aa;'; rankIcon = 'ğŸ¥ˆ'; } 
            else if (i === 2) { rankClass = 'background:#fef9c3; color:#b45309; border:1px solid #fde047;'; rankIcon = 'ğŸ¥‰'; }

            topListHtml += `
                <div class="m-list-row" style="display:flex; justify-content:space-between; padding:12px 10px; border-bottom:1px dashed #eee; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; ${rankClass}">${rankIcon}</span>
                        <span style="font-weight:bold; font-size:15px; color:#333;">${s.name}</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:800; color:#2563eb; font-size:16px;">${s.total}</div>
                        <div style="font-size:10px; color:#94a3b8;">é•‡æ’: ${safeGet(s, 'ranks.total.township', '-')}</div>
                    </div>
                </div>`;
        });

        // å¦‚æœäººæ•°è¶…è¿‡å±•ç¤ºé™åˆ¶ï¼ŒåŠ ä¸ªæç¤º
        if (students.length > displayLimit) {
            topListHtml += `<div style="text-align:center; padding:10px; color:#94a3b8; font-size:12px;">... åç»­ ${students.length - displayLimit} åå­¦ç”Ÿç•¥ ...</div>`;
        }

        // 3. æ„å»º HTML (å†…è”æ ·å¼ç¡®ä¿ html2canvas æ¸²æŸ“å‡†ç¡®)
        container.innerHTML = `
            <div style="background:white; padding-bottom:20px;">
                <!-- å¤´éƒ¨æµ·æŠ¥åŒº -->
                <div style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 30px 30px; margin-bottom: 20px; position:relative; overflow:hidden;">
                    <!-- è£…é¥°èƒŒæ™¯åœ† -->
                    <div style="position:absolute; top:-20px; left:-20px; width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:50%;"></div>
                    <div style="position:absolute; bottom:-10px; right:-10px; width:80px; height:80px; background:rgba(255,255,255,0.1); border-radius:50%;"></div>
                    
                    <div style="font-size: 12px; opacity: 0.9; letter-spacing: 2px; margin-bottom: 5px; text-transform:uppercase;">Academic Report</div>
                    <div style="font-size: 24px; font-weight: 800; margin-bottom: 5px; text-shadow:0 2px 4px rgba(0,0,0,0.2);">${sch} Â· ${cls}</div>
                    <div style="font-size: 14px; opacity: 0.9; background:rgba(255,255,255,0.2); display:inline-block; padding:4px 12px; border-radius:20px;">
                        ${CONFIG.name} æˆç»©å¿«æŠ¥
                    </div>
                </div>
                
                <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ -->
                <div style="margin: 0 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; margin-bottom: 20px;">
                    <div style="background:#f8fafc; padding:15px 5px; border-radius:12px; border:1px solid #e2e8f0;">
                        <div style="font-size:20px; font-weight:800; color:#334155;">${students.length}</div>
                        <div style="font-size:10px; color:#64748b; margin-top:2px;">å‚è€ƒäººæ•°</div>
                    </div>
                    <div style="background:#f0f9ff; padding:15px 5px; border-radius:12px; border:1px solid #bae6fd;">
                        <div style="font-size:20px; font-weight:800; color:#0284c7;">${avg.toFixed(1)}</div>
                        <div style="font-size:10px; color:#0369a1; margin-top:2px;">ç­çº§å‡åˆ†</div>
                    </div>
                    <div style="background:#fffbeb; padding:15px 5px; border-radius:12px; border:1px solid #fde68a;">
                        <div style="font-size:20px; font-weight:800; color:#d97706;">${max}</div>
                        <div style="font-size:10px; color:#b45309; margin-top:2px;">æœ€é«˜åˆ†</div>
                    </div>
                </div>

                <!-- æ¦œå•åˆ—è¡¨ -->
                <div style="margin: 0 15px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; overflow: hidden;">
                    <div style="background:#f8fafc; padding:12px 15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; color:#333; display:flex; align-items:center; gap:5px;">
                            <span style="color:#eab308;">ğŸ†</span> å…‰è£æ¦œ (Top ${displayLimit})
                        </span>
                        <span style="font-size:10px; color:#94a3b8;">æŒ‰æ€»åˆ†æ’åº</span>
                    </div>
                    <div style="padding: 0 10px;">
                        ${topListHtml}
                    </div>
                </div>

                <!-- åº•éƒ¨è½æ¬¾ -->
                <div style="text-align: center; margin-top: 30px; color: #cbd5e1; font-size: 10px; line-height: 1.5;">
                    <div style="margin-bottom:5px;">ğŸ“… ç”Ÿæˆæ—¥æœŸ: ${dateStr}</div>
                    <div>æœ¬æ•°æ®ç”± [æ™ºèƒ½æ•™åŠ¡åˆ†æç³»ç»Ÿ] è‡ªåŠ¨ç”Ÿæˆ</div>
                    <div>ä»…ä¾›ç­çº§å†…éƒ¨å­¦æƒ…åˆ†æä½¿ç”¨</div>
                </div>
            </div>
        `;

        // 4. è°ƒç”¨ html2canvas
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="ti ti-loader"></i> ç”Ÿæˆä¸­...';
        btn.disabled = true;

        setTimeout(() => {
            html2canvas(container, { 
                scale: 2, // 2å€é«˜æ¸…
                useCORS: true, 
                backgroundColor: '#f3f4f6' // èƒŒæ™¯è‰²
            }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const resultBox = document.getElementById('mobile-img-result');
                // é™åˆ¶é«˜åº¦ï¼Œå…è®¸æ»šåŠ¨æŸ¥çœ‹
                resultBox.innerHTML = `<img src="${imgData}" style="width:100%; display:block; border-radius:8px;">`;
                
                document.getElementById('mobileShareModal').style.display = 'flex';
                
                // æ¢å¤æŒ‰é’®
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                alert("ç”Ÿæˆå¤±è´¥: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }, 300); // ç¨å¾®å»¶æ—¶ç­‰å¾… DOM æ¸²æŸ“
    }

    // è¾…åŠ©ï¼šè·å–è¿›æ­¥ä¹‹æ˜Ÿ HTML
    function getProgressStarsHtml(school, className) {
        if (!PROGRESS_CACHE || PROGRESS_CACHE.length === 0) return "æš‚æ— è¿›é€€æ­¥æ•°æ® (éœ€åœ¨'è¿›é€€æ­¥è¿½è¸ª'æ¨¡å—åˆ†æ)";
        
        // ç­›é€‰æœ¬ç­è¿›æ­¥æœ€å¤§çš„å‰5å
        const stars = PROGRESS_CACHE.filter(p => p.class === className && p.change > 0)
                                    .sort((a, b) => b.change - a.change)
                                    .slice(0, 5);
        
        if (stars.length === 0) return "æœ¬æ¬¡æ— æ˜æ˜¾è¿›æ­¥è®°å½•";
        
        return stars.map(s => 
            `<span style="display:inline-block; margin:3px; padding:2px 6px; background:#dcfce7; color:#166534; border-radius:10px;">
                ${s.name} â†‘${s.change}
             </span>`
        ).join("");
    }

    function downloadMobileImage() {
        const img = document.querySelector('#mobile-img-result img');
        if (img) {
            const link = document.createElement('a');
            link.download = `ç­çº§æˆç»©é•¿å›¾_${new Date().getTime()}.png`;
            link.href = img.src;
            link.click();
        }
    }

    function analyzeMarginalStudents() {
        const selectedSchool = document.getElementById('marginalSchoolSelect').value; if (!selectedSchool) { alert('è¯·é€‰æ‹©æœ¬æ ¡'); return; }
        const mySchoolStudents = RAW_DATA.filter(student => student.school === selectedSchool); if (mySchoolStudents.length === 0) { alert('è¯¥å­¦æ ¡æ²¡æœ‰å­¦ç”Ÿæ•°æ®'); return; }
        MARGINAL_STUDENTS = {}; const classes = {}; mySchoolStudents.forEach(student => { if (!classes[student.class]) classes[student.class] = []; classes[student.class].push(student); });
        Object.keys(classes).forEach(className => {
            const classStudents = classes[className];
            SUBJECTS.forEach(subject => {
                const excThreshold = THRESHOLDS[subject]?.exc || 0; const passThreshold = THRESHOLDS[subject]?.pass || 0;
                const excellentMarginal = classStudents.filter(student => { const score = student.scores[subject]; return score !== undefined && score < excThreshold && score >= excThreshold * 0.9; });
                const passMarginal = classStudents.filter(student => { const score = student.scores[subject]; return score !== undefined && score < passThreshold && score >= passThreshold * 0.8; });
                if (!MARGINAL_STUDENTS[className]) MARGINAL_STUDENTS[className] = {}; MARGINAL_STUDENTS[className][subject] = { excellentMarginal, passMarginal };
            });
        });
        renderMarginalStudents(selectedSchool);
    }

    function renderMarginalStudents(schoolName) {
        const container = document.getElementById('marginal-student-results'); container.innerHTML = '';
        Object.keys(MARGINAL_STUDENTS).sort().forEach(className => {
            let html = `<div class="sub-header">${className}ç­ - è¾¹ç¼˜ç”Ÿåˆ†æ</div><div class="table-wrap"><table><thead><tr><th>å­¦ç§‘</th><th>ä¼˜ç§€è¾¹ç¼˜ç”Ÿ</th><th>åŠæ ¼è¾¹ç¼˜ç”Ÿ</th></tr></thead><tbody>`;
            SUBJECTS.forEach(subject => {
                const subjectData = MARGINAL_STUDENTS[className][subject]; if (!subjectData) return;
                const formatList = (list, thresh) => list.length ? list.map(s => `<strong>${s.name}</strong> <span style="font-size:12px;color:#666">(${s.scores[subject]},å·®${(thresh-s.scores[subject]).toFixed(1)})</span>`).join('ï¼Œ ') : 'æ— ';
                html += `<tr><td>${subject}</td><td style="background:#f0fdf4;">${formatList(subjectData.excellentMarginal, THRESHOLDS[subject].exc)}</td><td style="background:#fffbeb;">${formatList(subjectData.passMarginal, THRESHOLDS[subject].pass)}</td></tr>`;
            });
            html += '</tbody></table></div>'; container.innerHTML += html;
        });
    }

    function exportMarginalStudents() {
        if (Object.keys(MARGINAL_STUDENTS).length === 0) { alert('è¯·å…ˆè¿›è¡Œè¾¹ç¼˜ç”Ÿåˆ†æ'); return; }
        const wb = XLSX.utils.book_new(); const headers = ['ç­çº§', 'å­¦ç§‘', 'ç±»å‹', 'å­¦ç”Ÿå§“å', 'åˆ†æ•°', 'ä¸æ ‡å‡†çº¿å·®è·']; const data = [headers];
        Object.keys(MARGINAL_STUDENTS).sort().forEach(className => {
            Object.keys(MARGINAL_STUDENTS[className]).forEach(subject => {
                const subjectData = MARGINAL_STUDENTS[className][subject];
                subjectData.excellentMarginal.forEach(student => data.push([className, subject, 'ä¼˜ç§€è¾¹ç¼˜ç”Ÿ', student.name, student.scores[subject].toFixed(1), (THRESHOLDS[subject].exc - student.scores[subject]).toFixed(1)]));
                subjectData.passMarginal.forEach(student => data.push([className, subject, 'åŠæ ¼è¾¹ç¼˜ç”Ÿ', student.name, student.scores[subject].toFixed(1), (THRESHOLDS[subject].pass - student.scores[subject]).toFixed(1)]));
            });
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'è¾¹ç¼˜ç”Ÿåˆ†æ'); XLSX.writeFile(wb, 'è¾¹ç¼˜ç”Ÿåˆ†æ.xlsx');
    }

    function renderHorizontalTable() {
        const mySchoolName = document.getElementById('mySchool').value;
        let html = '<table class="comparison-table"><thead><tr><th>ç»Ÿè®¡é¡¹ç›®/ç§‘ç›®</th>'; let mySchoolIndex = -1;
        const schoolNames = Object.keys(SCHOOLS);
        schoolNames.forEach((school, index) => { if(school === mySchoolName) mySchoolIndex = index; const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<th class="${highlightClass}">${school}</th>`; });
        html += '</tr></thead><tbody>';
        SUBJECTS.forEach(subject => {
            html += `<tr><td>${subject}å¹³å‡åˆ†</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics[subject] ? formatRankDisplay(SCHOOLS[school].metrics[subject].avg, SCHOOLS[school].rankings[subject]?.avg || 0) : '-'}</td>`; });
            html += `</tr><tr><td>${subject}ä¼˜ç§€ç‡</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics[subject] ? formatRankDisplay(SCHOOLS[school].metrics[subject].excRate, SCHOOLS[school].rankings[subject]?.excRate || 0, 'school', true) : '-'}</td>`; });
            html += `</tr><tr><td>${subject}åŠæ ¼ç‡</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics[subject] ? formatRankDisplay(SCHOOLS[school].metrics[subject].passRate, SCHOOLS[school].rankings[subject]?.passRate || 0, 'school', true) : '-'}</td>`; });
            html += '</tr>';
        });
        html += `<tr><td>${CONFIG.label}å¹³å‡åˆ†</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics.total ? formatRankDisplay(SCHOOLS[school].metrics.total.avg, SCHOOLS[school].rankings.total?.avg || 0) : '-'}</td>`; });
        html += `<tr><td>${CONFIG.label}ä¼˜ç§€ç‡</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics.total ? formatRankDisplay(SCHOOLS[school].metrics.total.excRate, SCHOOLS[school].rankings.total?.excRate || 0, 'school', true) : '-'}</td>`; });
        html += `<tr><td>${CONFIG.label}åŠæ ¼ç‡</td>`; schoolNames.forEach(school => { const highlightClass = (school === mySchoolName) ? 'bg-highlight' : ''; html += `<td class="${highlightClass}">${SCHOOLS[school].metrics.total ? formatRankDisplay(SCHOOLS[school].metrics.total.passRate, SCHOOLS[school].rankings.total?.passRate || 0, 'school', true) : '-'}</td>`; });
        html += '</tr></tbody></table>';
        document.getElementById('horizontal-table').innerHTML = html; document.getElementById('horizontal-box').classList.remove('hidden');
    }

    // ================= å¢å¼ºç‰ˆï¼šæ¨ªå‘å¯¹æ¯”Excelå¯¼å‡º =================
    function exportHorizontalExcel() {
        const mySchoolName = document.getElementById('mySchool').value.trim();
        const schoolNames = Object.keys(SCHOOLS);
        if (schoolNames.length === 0) return alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");

        const wb = XLSX.utils.book_new();
        const wsData = []; 
        const merges = []; 
        let rowIndex = 0;  

        const borderStyle = { top: { style: "thin", color: { rgb: "E2E8F0" } }, bottom: { style: "thin", color: { rgb: "E2E8F0" } }, left: { style: "thin", color: { rgb: "E2E8F0" } }, right: { style: "thin", color: { rgb: "E2E8F0" } } };
        const styleHeader = { font: { bold: true, color: { rgb: "333333" }, sz: 11 }, fill: { fgColor: { rgb: "F3F4F6" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
        const styleSubjectBar = { font: { bold: true, color: { rgb: "1E40AF" }, sz: 12 }, fill: { fgColor: { rgb: "DBEAFE" } }, alignment: { horizontal: "left", vertical: "center" }, border: { top: { style: "medium", color: { rgb: "3B82F6" } }, bottom: { style: "thin" } } };
        const styleNormal = { alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
        const styleHighlight = { fill: { fgColor: { rgb: "FEF9C3" } }, font: { bold: true, color: { rgb: "B45309" } }, alignment: { horizontal: "center", vertical: "center" }, border: { ...borderStyle, left: { style: "medium", color: { rgb: "FACC15" } }, right: { style: "medium", color: { rgb: "FACC15" } } } };
        const styleRankRow = { font: { color: { rgb: "94A3B8" }, sz: 9 }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
        const styleHighlightRank = Object.assign({}, styleHighlight, { font: { color: { rgb: "B45309" }, sz: 9 } });

        const headerRow = [{ v: "ç»Ÿè®¡é¡¹ç›® / å­¦æ ¡", t: 's', s: styleHeader }];
        let mySchoolIndex = -1;

        schoolNames.forEach((name, index) => {
            const isMySchool = (name === mySchoolName);
            if (isMySchool) mySchoolIndex = index;
            headerRow.push({ v: name, t: 's', s: isMySchool ? styleHighlight : styleHeader });
        });
        wsData.push(headerRow);
        rowIndex++; 

        const createCell = (val, type, format, isRankRow, colIndex) => {
            const isMyCol = (colIndex === mySchoolIndex);
            let style = isRankRow ? styleRankRow : styleNormal;
            if (isMyCol) style = isRankRow ? styleHighlightRank : styleHighlight;
            if (val === '-' || val === undefined || val === null) { return { v: '-', t: 's', s: style }; }
            return { v: val, t: type, z: format, s: style };
        };

        const allItems = [...SUBJECTS, 'total']; 
        const totalCols = schoolNames.length + 1;

        allItems.forEach(sub => {
            const label = sub === 'total' ? CONFIG.label : sub;
            const sepRowData = [];
            for(let c=0; c<totalCols; c++) { sepRowData.push({ v: c===0 ? `ğŸ“˜ ${label} æ•°æ®åˆ†æ` : "", t: 's', s: styleSubjectBar }); }
            wsData.push(sepRowData);
            merges.push({ s: { r: rowIndex, c: 0 }, e: { r: rowIndex, c: totalCols - 1 } });
            rowIndex++; 

            const labelStyle = (color) => ({ font: { color: { rgb: color }, bold:true }, fill: { fgColor: { rgb: "F9FAFB" } }, border: borderStyle });
            const rowAvg = [{ v: "å¹³å‡åˆ†", t: 's', s: labelStyle("2563EB") }]; const rowAvgR = [{ v: "   â†³ æ’å", t: 's', s: styleRankRow }];
            const rowExc = [{ v: "ä¼˜ç§€ç‡", t: 's', s: labelStyle("16A34A") }]; const rowExcR = [{ v: "   â†³ æ’å", t: 's', s: styleRankRow }];
            const rowPass = [{ v: "åŠæ ¼ç‡", t: 's', s: labelStyle("D97706") }]; const rowPassR = [{ v: "   â†³ æ’å", t: 's', s: styleRankRow }];

            schoolNames.forEach((school, idx) => {
                const metrics = SCHOOLS[school].metrics[sub]; const rankings = SCHOOLS[school].rankings[sub] || {};
                if (metrics) {
                    rowAvg.push(createCell(parseFloat(metrics.avg.toFixed(2)), 'n', '0.00', false, idx));
                    rowAvgR.push(createCell(rankings.avg, 'n', '0', true, idx));
                    rowExc.push(createCell(metrics.excRate, 'n', '0.00%', false, idx));
                    rowExcR.push(createCell(rankings.excRate, 'n', '0', true, idx));
                    rowPass.push(createCell(metrics.passRate, 'n', '0.00%', false, idx));
                    rowPassR.push(createCell(rankings.passRate, 'n', '0', true, idx));
                } else {
                    [rowAvg, rowAvgR, rowExc, rowExcR, rowPass, rowPassR].forEach(r => r.push(createCell('-', 's', null, false, idx)));
                }
            });
            wsData.push(rowAvg, rowAvgR, rowExc, rowExcR, rowPass, rowPassR);
            rowIndex += 6; 
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!merges'] = merges;
        const cols = [{ wch: 20 }]; schoolNames.forEach(() => cols.push({ wch: 11 })); ws['!cols'] = cols;
        ws['!freeze'] = { xSplit: 1, ySplit: 1 };

        XLSX.utils.book_append_sheet(wb, ws, "æ¨ªå‘å¯¹æ¯”åˆ†æ");
        XLSX.writeFile(wb, `ä¹¡é•‡å­¦æ ¡æ¨ªå‘å¯¹æ¯”è¡¨_${mySchoolName || 'å…¨é•‡'}.xlsx`);
    }

    function exportMacroTables() {
        if (!Object.keys(SCHOOLS).length) return alert("è¯·å…ˆä¸Šä¼ æ•°æ®");
        
        const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
        const wb = XLSX.utils.book_new();
        
        // 1. æ„å»ºåŠ¨æ€è¡¨å¤´
        let headerRow = ["å­¦æ ¡åç§°", "å®è€ƒäººæ•°", "å¹³å‡åˆ†", "ä¼˜ç§€ç‡", "åŠæ ¼ç‡"];
        if (isGrade9) {
            headerRow.push("é«˜åˆ†äººæ•°(â‰¥490)", "é«˜åˆ†ç‡", "é«˜åˆ†èµ‹åˆ†");
        }
        headerRow.push("èµ‹åˆ†-å‡åˆ†", "èµ‹åˆ†-ä¼˜ç‡", "èµ‹åˆ†-åŠæ ¼", "ä¸¤ç‡ä¸€åˆ†æ€»åˆ†", "æ’å");

        const summaryData = [headerRow];
        const list = Object.values(SCHOOLS).sort((a,b)=>a.rank2Rate - b.rank2Rate);
        
        // 2. æ„å»ºæ•°æ®è¡Œ
        list.forEach(s => {
            const m = s.metrics.total || {};
            let row = [
                s.name, 
                m.count || 0, 
                getExcelNum(m.avg), 
                getExcelPercent(m.excRate), 
                getExcelPercent(m.passRate)
            ];

            // æ’å…¥é«˜åˆ†æ•°æ®
            if (isGrade9) {
                const hs = s.highScoreStats || { count: 0, ratio: 0, score: 0 };
                row.push(hs.count, getExcelPercent(hs.ratio), getExcelNum(hs.score));
            }

            // æ’å…¥åŸæœ‰èµ‹åˆ†æ•°æ®
            row.push(
                getExcelNum(m.ratedAvg), 
                getExcelNum(m.ratedExc), 
                getExcelNum(m.ratedPass), 
                getExcelNum(s.score2Rate), 
                s.rank2Rate
            );
            
            summaryData.push(row);
        });

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        // è°ƒç”¨è£…é¥°å‡½æ•°ï¼Œä¼ å…¥ Worksheet å’Œ è¡¨å¤´æ•°ç»„
        decorateExcelSheet(wsSummary, headerRow); 
        XLSX.utils.book_append_sheet(wb, wsSummary, "ç»¼åˆæ€»è¡¨");
        
       // éå†æ‰€æœ‰å­¦ç§‘å¯¼å‡ºè¯¦æƒ…
        SUBJECTS.forEach(sub => {
            // 1. å…ˆæ˜¾å¼å®šä¹‰è¡¨å¤´æ•°ç»„ (ä¹‹å‰æŠ¥é”™æ˜¯å› ä¸ºè¿™è¡Œå¯èƒ½è¢«æ¼æ‰æˆ–å†™åœ¨äº†æ•°ç»„é‡Œ)
            const subHeaders = ["å­¦æ ¡åç§°", "å®è€ƒäººæ•°", "å¹³å‡åˆ†", "ä¼˜ç§€ç‡", "åŠæ ¼ç‡", "å‡åˆ†æ’å", "ä¼˜ç‡æ’å", "åŠæ ¼æ’å"];
            
            // 2. ä½¿ç”¨å®šä¹‰çš„è¡¨å¤´åˆå§‹åŒ–æ•°æ®æ•°ç»„
            const subData = [subHeaders]; 
            
            const subList = Object.values(SCHOOLS).filter(s=>s.metrics[sub]).sort((a,b)=>(a.rankings[sub].avg - b.rankings[sub].avg));
            
            subList.forEach(s => { 
                const m = s.metrics[sub]; 
                const r = s.rankings[sub]; 
                subData.push([
                    s.name, 
                    m.count, 
                    getExcelNum(m.avg), 
                    getExcelPercent(m.excRate), 
                    getExcelPercent(m.passRate), 
                    r.avg, 
                    r.excRate, 
                    r.passRate
                ]); 
            });
            
            const wsSub = XLSX.utils.aoa_to_sheet(subData);
            
            // 3. åº”ç”¨æ ·å¼ (ç°åœ¨ subHeaders å·²ç»æœ‰å®šä¹‰äº†ï¼Œä¸ä¼šæŠ¥é”™)
            decorateExcelSheet(wsSub, subHeaders);
            
            XLSX.utils.book_append_sheet(wb, wsSub, sub);
        });
        
        XLSX.writeFile(wb, `ä¹¡é•‡å®è§‚åˆ†æ_${CONFIG.name}.xlsx`);
    }

    // --- å¢å€¼æ€§è¯„ä»·é€»è¾‘ ---

    let VA_VIEW_MODE = 'school'; // school | class

    function switchValueAddedView(mode, btn) {
        VA_VIEW_MODE = mode;
        
        // 1. åˆ‡æ¢æŒ‰é’®è‡ªèº«çš„æ¿€æ´»çŠ¶æ€ (è§†è§‰åé¦ˆ)
        // æ‰¾åˆ°åŒä¸€ç»„çš„æ‰€æœ‰æŒ‰é’® (å®ƒä»¬éƒ½åœ¨åŒä¸€ä¸ªçˆ¶å®¹å™¨é‡Œ)
        const siblings = btn.parentNode.querySelectorAll('.btn');
        siblings.forEach(b => {
            b.classList.remove('active');
            // æ¢å¤é»˜è®¤æ ·å¼ (ç™½åº•ç°å­—)
            b.style.backgroundColor = 'white';
            b.style.color = '#64748b';
        });
        
        // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºæ¿€æ´»æ ·å¼ (è“åº•ç™½å­—)
        btn.classList.add('active');
        btn.style.backgroundColor = '#e0f2fe';
        btn.style.color = '#0369a1';
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderValueAddedReport(true);
    }

    function renderValueAddedReport(isSwitching = false) {
        // 1. æ£€æŸ¥æ•°æ®æº
        if (!PROGRESS_CACHE || PROGRESS_CACHE.length === 0) {
            // å°è¯•è‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
            if (PREV_DATA.length > 0 && RAW_DATA.length > 0) {
                 // å¦‚æœæœ‰æ•°æ®ä½†æ²¡ç”Ÿæˆç¼“å­˜ï¼Œæç¤ºç”¨æˆ·å»é‚£ä¸ªæ¨¡å—ç‚¹ä¸€ä¸‹ï¼Œæˆ–è€…è¿™é‡Œè‡ªåŠ¨è°ƒç”¨ï¼ˆä¸ºäº†å®‰å…¨èµ·è§ï¼Œæç¤ºç”¨æˆ·ï¼‰
                 document.getElementById('va-data-status').innerHTML = 'âš ï¸ å·²æœ‰æ•°æ®ï¼Œæ­£åœ¨åå°è®¡ç®—...';
                 // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡åŒ¹é…é€»è¾‘ (å€Ÿç”¨ renderProgressAnalysis çš„é€»è¾‘ï¼Œä½†ä¸ç”»å›¾)
                 // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥åŸºäº PREV_DATA å’Œ RAW_DATA ç°åœºç®—ä¸€éæ ¸å¿ƒæ•°æ®
                 performSilentMatching();
            } else {
                 if(!isSwitching) alert("âŒ æ— æ³•ç”Ÿæˆï¼šè¯·å…ˆåœ¨ã€è¿›é€€æ­¥è¿½è¸ªã€‘æ¨¡å—ä¸Šä¼ â€œä¸Šæ¬¡è€ƒè¯•â€æ•°æ®ï¼");
                 document.getElementById('va-data-status').innerHTML = 'âŒ ç¼ºä¸Šæ¬¡è€ƒè¯•æ•°æ®';
                 return;
            }
        }
        document.getElementById('va-data-status').innerHTML = 'âœ… æ•°æ®å°±ç»ª';

        // 2. èšåˆæ•°æ®
        const stats = {};
        
        PROGRESS_CACHE.forEach(p => {
            // ç¡®å®šåˆ†ç»„é”®ï¼šæ˜¯æŒ‰å­¦æ ¡è¿˜æ˜¯æŒ‰ç­çº§
            let key = "";
            let name = "";
            if (VA_VIEW_MODE === 'school') {
                // æ ¹æ®å½“å‰å­¦ç”Ÿæ‰¾å­¦æ ¡å
                // PROGRESS_CACHE é‡Œå¯èƒ½æ²¡æœ‰å­˜ school å­—æ®µï¼Œéœ€è¦å›æº¯ RAW_DATA æ‰¾ï¼Œæˆ–è€…æˆ‘ä»¬åœ¨ performSilentMatching é‡Œè¡¥å…¨
                const stuObj = RAW_DATA.find(r => r.name === p.name && r.class === p.class); 
                if (stuObj) key = stuObj.school;
                else key = "æœªçŸ¥å­¦æ ¡";
                name = key;
            } else {
                key = p.class; // ç­çº§
                // å°è¯•é™„åŠ å­¦æ ¡åä»¥é˜²ç­çº§é‡å
                const stuObj = RAW_DATA.find(r => r.name === p.name && r.class === p.class);
                if (stuObj) name = `${stuObj.school} ${p.class}`;
                else name = p.class;
            }

            if (!stats[name]) {
                stats[name] = { name: name, count: 0, sumPrev: 0, sumCurr: 0 };
            }
            stats[name].count++;
            stats[name].sumPrev += p.prevRank;
            stats[name].sumCurr += p.currRank;
        });

        // 3. è®¡ç®—å¢å€¼æŒ‡æ ‡
        const reportData = Object.values(stats).map(item => {
            const avgPrev = item.sumPrev / item.count;
            const avgCurr = item.sumCurr / item.count;
            const valueAdded = avgPrev - avgCurr; // æ­£æ•°è¡¨ç¤ºæ’åå‘å‰ç§»åŠ¨ï¼ˆå˜å°ï¼‰
            return {
                name: item.name,
                count: item.count,
                entryAvg: avgPrev,
                exitAvg: avgCurr,
                valueAdded: valueAdded
            };
        });

        // 4. æ’åº (æŒ‰å¢å€¼ä»é«˜åˆ°ä½)
        reportData.sort((a, b) => b.valueAdded - a.valueAdded);
        reportData.forEach((d, i) => d.rank = i + 1);

        // 5. æ¸²æŸ“è¡¨æ ¼
        const tbody = document.querySelector('#tb-value-added tbody');
        let html = '';
        reportData.forEach(d => {
            const vaFixed = d.valueAdded.toFixed(1);
            let colorClass = d.valueAdded > 0 ? 'text-green' : (d.valueAdded < 0 ? 'text-red' : '');
            let sign = d.valueAdded > 0 ? '+' : '';
            
            // è¯„ä»·æ ‡ç­¾
            let evalTag = '';
            if (d.valueAdded >= 50) evalTag = '<span class="badge" style="background:#16a34a">ğŸš€ å“è¶Šå¢å€¼</span>';
            else if (d.valueAdded >= 10) evalTag = '<span class="badge" style="background:#2563eb">ğŸ“ˆ æœ‰æ•ˆæå‡</span>';
            else if (d.valueAdded <= -50) evalTag = '<span class="badge" style="background:#dc2626">ğŸ“‰ ä¸¥é‡æ»‘å¡</span>';
            else evalTag = '<span class="badge" style="background:#94a3b8">â– ä¿æŒç¨³å®š</span>';

            html += `
                <tr>
                    <td style="font-weight:bold;">${d.name}</td>
                    <td>${d.count}</td>
                    <td style="color:#666;">${d.entryAvg.toFixed(1)}</td>
                    <td style="color:#333;">${d.exitAvg.toFixed(1)}</td>
                    <td style="font-size:16px; font-weight:bold;" class="${colorClass}">${sign}${vaFixed}</td>
                    <td>${evalTag}</td>
                    <td class="rank-cell ${d.rank<=3 ? 'r-'+d.rank : ''}">${d.rank}</td>
                </tr>
            `;
        });
        
        if (reportData.length === 0) html = '<tr><td colspan="7" style="text-align:center;">æš‚æ— åŒ¹é…æ•°æ®</td></tr>';
        tbody.innerHTML = html;
        
        // ç¼“å­˜ä¾›å¯¼å‡ºç”¨
        window.LAST_VA_DATA = reportData;
    }

    // åå°é™é»˜åŒ¹é… (å¦‚æœç”¨æˆ·æ²¡ç‚¹è¿›é€€æ­¥åˆ†æï¼Œè¿™é‡Œè¡¥åšä¸€æ¬¡åŒ¹é…)
    function performSilentMatching() {
        if (!PREV_DATA.length || !RAW_DATA.length) return;
        PROGRESS_CACHE = [];
        // ç®€å•çš„å§“ååŒ¹é…é€»è¾‘
        RAW_DATA.forEach(curr => {
            // å°è¯•åŒ¹é…ï¼šä¼˜å…ˆå…¨å+å­¦æ ¡ï¼Œå…¶æ¬¡å…¨å
            let prev = PREV_DATA.find(p => p.name === curr.name && p.school === curr.school);
            if (!prev) prev = PREV_DATA.find(p => p.name === curr.name); // å®½æ¾åŒ¹é…
            
            if (prev) {
                const currRank = safeGet(curr, 'ranks.total.township', 0);
                // åªæœ‰å½“ä¸¤è€…éƒ½æœ‰æœ‰æ•ˆæ’åæ—¶æ‰ç®—
                if (currRank > 0 && prev.rank > 0) {
                    PROGRESS_CACHE.push({
                        school: curr.school, // è¡¥å…¨å­¦æ ¡ä¿¡æ¯
                        class: curr.class,
                        name: curr.name,
                        currRank: currRank,
                        prevRank: prev.rank,
                        change: prev.rank - currRank
                    });
                }
            }
        });
    }

    function exportValueAddedExcel() {
        if (!window.LAST_VA_DATA || window.LAST_VA_DATA.length === 0) return alert("è¯·å…ˆç”ŸæˆæŠ¥è¡¨");
        
        const wb = XLSX.utils.book_new();
        const data = [['å•ä½åç§°', 'åŒ¹é…äººæ•°', 'å…¥å£å‡ä½(ä¸Šæ¬¡æ’å)', 'å‡ºå£å‡ä½(æœ¬æ¬¡æ’å)', 'å¹³å‡å¢å€¼(åæ¬¡)', 'å¢å€¼æ’å']];
        
        window.LAST_VA_DATA.forEach(d => {
            data.push([d.name, d.count, d.entryAvg.toFixed(2), d.exitAvg.toFixed(2), d.valueAdded.toFixed(2), d.rank]);
        });

        // åˆ—å®½è®¾ç½®
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = [{wch:20}, {wch:10}, {wch:15}, {wch:15}, {wch:15}, {wch:10}];
        
        XLSX.utils.book_append_sheet(wb, ws, "å¢å€¼æ€§è¯„ä»·è¡¨");
        XLSX.writeFile(wb, `å¢å€¼æ€§è¯„ä»·æŠ¥è¡¨_${VA_VIEW_MODE === 'school' ? 'å­¦æ ¡' : 'ç­çº§'}.xlsx`);
    }

    function exportSummaryTable() {
        if(!Object.keys(SCHOOLS).length) return alert("æ— æ•°æ®");
        
        const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
        
        // 1. å‡†å¤‡æ•°æ®
        const list = Object.values(SCHOOLS).map(s => {
            const s1 = s.score2Rate || 0;
            const s2 = s.scoreBottom || 0;
            const s3 = s.scoreInd || 0;
            // è·å–é«˜åˆ†èµ‹åˆ†
            const s4 = (isGrade9 && s.highScoreStats) ? (s.highScoreStats.score || 0) : 0;
            // è®¡ç®—åŒ…å«é«˜åˆ†èµ‹åˆ†çš„æ€»åˆ†
            const total = s1 + s2 + s3 + s4;
            
            return { name: s.name, s1, s2, s3, s4, total };
        });
        
        // 2. æ’åº
        list.sort((a,b) => b.total - a.total).forEach((d,i) => d.rank = i+1);
        
        const wb = XLSX.utils.book_new();
        
        // 3. æ„å»ºè¡¨å¤´
        const headers = ["å­¦æ ¡åç§°", "ä¸¤ç‡ä¸€åˆ†å¾—åˆ†", "å1/3å¾—åˆ†", "æŒ‡æ ‡ç”Ÿå¾—åˆ†"];
        if (isGrade9) headers.push("é«˜åˆ†æ®µèµ‹åˆ†(70)");
        headers.push("ç»¼åˆæ€»åˆ†", "æ€»æ’å");
        
        const wsData = [headers];
        
        // 4. å¡«å……æ•°æ®
        list.forEach(d => { 
            const row = [
                d.name, 
                getExcelNum(d.s1), 
                getExcelNum(d.s2), 
                getExcelNum(d.s3)
            ];
            
            // å¦‚æœæ˜¯9å¹´çº§ï¼Œæ’å…¥é«˜åˆ†èµ‹åˆ†åˆ—æ•°æ®
            if (isGrade9) row.push(getExcelNum(d.s4));
            
            row.push(getExcelNum(d.total), d.rank);
            
            wsData.push(row); 
        });
        
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "ç»¼åˆåˆ†ææŠ¥å‘Š");
        XLSX.writeFile(wb, `ç»¼åˆåˆ†ææŠ¥å‘Š_${CONFIG.name}.xlsx`);
    }

async function exportPPTReport() {
        if (!Object.keys(SCHOOLS).length || !Object.values(SCHOOLS)[0].score2Rate) {
            alert("è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶ç‚¹å‡»ã€ç”Ÿæˆæ€»æ’åã€‘æŒ‰é’®ï¼Œç¡®ä¿æ‰€æœ‰æŒ‡æ ‡å·²è®¡ç®—ã€‚"); return;
        }
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9'; pptx.author = 'æˆç»©åˆ†æç³»ç»Ÿ'; pptx.title = `${CONFIG.name} æˆç»©åˆ†ææŠ¥å‘Š`;
        const COLORS = { primary: "2563EB", light: "EFF6FF", header: "1E293B", text: "333333" };

        // æ¯ç‰ˆ
        pptx.defineSlideMaster({
            title: 'MASTER_SLIDE', background: { color: "FFFFFF" },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.15, fill: COLORS.primary } },
                { text: { text: "å†…éƒ¨èµ„æ–™ Â· ä»…ä¾›æ•™ç ”", x: 0.5, y: 7.2, w: 3, h: 0.3, fontSize: 10, color: "94A3B8" } },
                { text: { text: "ç”Ÿæˆæ—¥æœŸ: " + new Date().toLocaleDateString(), x: 10.5, y: 7.2, w: 2.5, h: 0.3, fontSize: 10, color: "94A3B8", align: 'right' } }
            ], slideNumber: { x: 12.8, y: 7.2, fontSize: 10, color: "94A3B8" }
        });

        // 1. å°é¢
        let slide = pptx.addSlide(); slide.background = { color: COLORS.light };
        slide.addText(`${CONFIG.name} æ•™å­¦è´¨é‡åˆ†ææŠ¥å‘Š`, { x: 1, y: 2.5, w: "80%", h: 1, fontSize: 36, bold: true, color: COLORS.primary, align: 'center', fontFace: "å¾®è½¯é›…é»‘" });
        slide.addText(`æ•°æ®èŒƒå›´ï¼š${Object.keys(SCHOOLS).length} æ‰€å­¦æ ¡ | ${RAW_DATA.length} åå­¦ç”Ÿ`, { x: 1, y: 3.5, w: "80%", h: 0.5, fontSize: 18, color: COLORS.header, align: 'center' });
        slide.addText("æ•™åŠ¡å¤„ / è‡ªåŠ¨ç”Ÿæˆ", { x: 1, y: 6, w: "80%", h: 0.5, fontSize: 14, color: "64748b", align: 'center' });

        // 2. æ€»æ’åè¡¨
        slide = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
        slide.addText("ğŸ† ç»¼åˆè€ƒæ ¸æ€»æ’å", { x: 0.5, y: 0.5, fontSize: 20, bold: true, color: COLORS.primary });
        const summaryList = Object.values(SCHOOLS).sort((a,b) => (a.rank2Rate||999) - (b.rank2Rate||999));
        const headers = [
            { text: "æ’å", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "å­¦æ ¡", options: { fill: COLORS.primary, color: "FFFFFF", bold: true } },
            { text: "å‚è€ƒäººæ•°", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "ç»¼åˆå‡åˆ†", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "ä¼˜ç§€ç‡", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "åŠæ ¼ç‡", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } },
            { text: "æ€»è€ƒæ ¸åˆ†", options: { fill: COLORS.primary, color: "FFFFFF", bold: true, align: 'center' } }
        ];
        const rows = [headers];
        summaryList.forEach((s, i) => {
            const m = s.metrics.total || {}; const bg = (i % 2 !== 0) ? "F8FAFC" : "FFFFFF"; const rankColor = i < 3 ? "DC2626" : "333333";
            rows.push([
                { text: i + 1, options: { fill: bg, color: rankColor, bold: i < 3, align: 'center' } },
                { text: s.name, options: { fill: bg, color: "333333", bold: true } },
                { text: m.count || 0, options: { fill: bg, align: 'center' } },
                { text: m.avg ? m.avg.toFixed(2) : '-', options: { fill: bg, align: 'center' } },
                { text: m.excRate ? (m.excRate * 100).toFixed(2) + '%' : '-', options: { fill: bg, align: 'center' } },
                { text: m.passRate ? (m.passRate * 100).toFixed(2) + '%' : '-', options: { fill: bg, align: 'center' } },
                { text: (s.score2Rate || 0).toFixed(2), options: { fill: bg, color: "B45309", bold: true, align: 'center' } }
            ]);
        });
        slide.addTable(rows, { x: 0.5, y: 1.2, w: 12.3, fontSize: 11, border: { pt: 1, color: "E2E8F0" } });

        // 3. å…¨ç§‘å¯¹æ¯”å›¾
        slide = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
        slide.addText("ğŸ“Š å…¨é•‡å„æ ¡å¹³å‡åˆ†å¯¹æ¯”", { x: 0.5, y: 0.5, fontSize: 20, bold: true, color: COLORS.primary });
        slide.addChart(pptx.ChartType.bar, [{ name: "å¹³å‡åˆ†", labels: summaryList.map(s => s.name), values: summaryList.map(s => s.metrics.total ? Number(s.metrics.total.avg.toFixed(2)) : 0) }], { x: 0.5, y: 1.2, w: 12.3, h: 5.5, barDir: 'col', barGapWidthPct: 50, chartColors: [COLORS.primary], dataLabelFormatCode: "0.0", dataLabelPosition: "outEnd", showValue: true, showLegend: false });

        // 4. å„ç§‘å¾ªç¯
        SUBJECTS.forEach(sub => {
            const subSlide = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
            subSlide.addText(`ğŸ“˜ å­¦ç§‘åˆ†æï¼š${sub}`, { x: 0.5, y: 0.5, fontSize: 20, bold: true, color: COLORS.primary });
            const subData = Object.values(SCHOOLS).filter(s => s.metrics[sub]).sort((a, b) => b.metrics[sub].avg - a.metrics[sub].avg);
            if(subData.length === 0) return;
            // è¡¨æ ¼
            const subHeaders = [{ text: "æ’å", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "å­¦æ ¡", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "å‡åˆ†", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "ä¼˜ç‡%", options: { fill: "E0F2FE", color: "0369A1", bold: true } }, { text: "åŠæ ¼%", options: { fill: "E0F2FE", color: "0369A1", bold: true } }];
            const subRows = [subHeaders];
            subData.forEach((s, i) => { const m = s.metrics[sub]; subRows.push([i + 1, s.name, m.avg.toFixed(1), (m.excRate * 100).toFixed(1), (m.passRate * 100).toFixed(1)]); });
            subSlide.addTable(subRows, { x: 0.5, y: 1.2, w: 6, fontSize: 10, rowH: 0.4, border: { color: "CBD5E1" } });
            // å›¾è¡¨
            subSlide.addChart(pptx.ChartType.bar, [{ name: "å‡åˆ†", labels: subData.map(s => s.name), values: subData.map(s => s.metrics[sub].avg) }], { x: 7, y: 1.2, w: 5.8, h: 5, barDir: 'bar', chartColors: ["16A34A"], showValue: true, dataLabelPosition: "outEnd", showLegend: false, title: { text: `${sub} - æ ¡é™…æ’å`, fontSize: 12 } });
            // è¯Šæ–­
            const top = subData[0], bot = subData[subData.length - 1];
            subSlide.addText(`è¯Šæ–­ï¼š${sub}æœ€é«˜åˆ† ${top.name}(${top.metrics[sub].avg.toFixed(1)})ï¼Œæœ€ä½åˆ† ${bot.name}ï¼Œæå·® ${(top.metrics[sub].avg - bot.metrics[sub].avg).toFixed(1)}åˆ†ã€‚`, { x: 0.5, y: 6.5, w: 12, h: 0.5, fontSize: 11, color: "666666", italic: true, fill: "F1F5F9" });
        });

        pptx.writeFile({ fileName: `${CONFIG.name}_æˆç»©æ±‡æŠ¥_${new Date().toISOString().slice(0,10)}.pptx` });
    }

    function exportTeacherComparisonExcel() {
        if (Object.keys(TEACHER_STATS).length === 0) return alert("è¯·å…ˆè¿›è¡Œæ•™å¸ˆåˆ†æ");
        const gradeAverages = {}; SUBJECTS.forEach(subject => { if (SCHOOLS[MY_SCHOOL] && SCHOOLS[MY_SCHOOL].metrics[subject]) { gradeAverages[subject] = SCHOOLS[MY_SCHOOL].metrics[subject]; } });
        const wb = XLSX.utils.book_new();
        const wsData = [["æ•™å¸ˆå§“å", "å­¦ç§‘", "ä»»æ•™ç­çº§", "äººæ•°", "å¹³å‡åˆ†(å®é™…)", "ä¸çº§æ¯”", "æ ¡æ’", "ä¼˜ç§€ç‡(å®é™…)", "ä¸çº§æ¯”", "æ ¡æ’", "åŠæ ¼ç‡(å®é™…)", "ä¸çº§æ¯”", "æ ¡æ’", "ç»¼åˆå¾—åˆ†", "ç»¼åˆæ’å"]];
        const subjectTeachers = {};
        Object.keys(TEACHER_STATS).forEach(teacher => {
            Object.keys(TEACHER_STATS[teacher]).forEach(subject => {
                if (!subjectTeachers[subject]) subjectTeachers[subject] = [];
                const data = TEACHER_STATS[teacher][subject]; const gradeAvg = gradeAverages[subject] || { avg: 0, excRate: 0, passRate: 0 };
                const avgComparison = gradeAvg.avg ? ((parseFloat(data.avg) - gradeAvg.avg) / gradeAvg.avg) : 0; 
                const excComparison = gradeAvg.excRate ? ((data.excellentRate - gradeAvg.excRate) / gradeAvg.excRate) : 0;
                const passComparison = gradeAvg.passRate ? ((data.passRate - gradeAvg.passRate) / gradeAvg.passRate) : 0;
                subjectTeachers[subject].push({ teacher, data, avgComparison, excComparison, passComparison });
            });
        });
        Object.keys(subjectTeachers).sort(sortSubjects).forEach(subject => {
            const arr = subjectTeachers[subject];
            const setRank = (key, rankKey) => { arr.sort((a,b)=> parseFloat(b.data[key]) - parseFloat(a.data[key])).forEach((item,i)=>item[rankKey]=i+1); };
            setRank('avg','avgRank'); setRank('excellentRate','excRank'); setRank('passRate','passRank');
            arr.forEach(item => { item.compositeScore = ((1-(item.avgRank-1)/arr.length)*50 + (1-(item.excRank-1)/arr.length)*30 + (1-(item.passRank-1)/arr.length)*20); });
            arr.sort((a, b) => b.compositeScore - a.compositeScore).forEach((item, index) => { item.compositeRank = index + 1; });
            arr.forEach(item => {
                const data = item.data;
                wsData.push([item.teacher, subject, data.classes, data.studentCount, getExcelNum(parseFloat(data.avg)), getExcelPercent(item.avgComparison), item.avgRank, getExcelPercent(data.excellentRate), getExcelPercent(item.excComparison), item.excRank, getExcelPercent(data.passRate), getExcelPercent(item.passComparison), item.passRank, getExcelNum(item.compositeScore), item.compositeRank]);
            });
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "æ•™å¸ˆè¯¦ç»†å¯¹æ¯”");
        XLSX.writeFile(wb, "æ•™å¸ˆè¯¦ç»†æ•°æ®å¯¹æ¯”è¡¨.xlsx");
    }

    function exportTeacherTownshipRankExcel() {
        if(!Object.keys(TOWNSHIP_RANKING_DATA).length) return alert("æ— æ’åæ•°æ®");
        const wb = XLSX.utils.book_new();
        SUBJECTS.forEach(sub => {
            const data = TOWNSHIP_RANKING_DATA[sub];
            if(!data) return;
            const wsData = [["æ•™å¸ˆ/å­¦æ ¡", "ç±»å‹", "å¹³å‡åˆ†", "é•‡æ’", "ä¼˜ç§€ç‡", "é•‡æ’", "åŠæ ¼ç‡", "é•‡æ’"]];
            data.forEach(item => { wsData.push([item.name, item.type === 'teacher' ? 'æ•™å¸ˆ' : 'å­¦æ ¡', getExcelNum(item.avg), item.rankAvg, getExcelPercent(item.excellentRate), item.rankExc, getExcelPercent(item.passRate), item.rankPass]); });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), sub);
        });
        XLSX.writeFile(wb, "æ•™å¸ˆä¹¡é•‡æ’å.xlsx");
    }

    // ================= æŠ¥å‘ŠæŸ¥è¯¢é€»è¾‘ï¼ˆæ‰“å°å¢å¼ºï¼‰ =================
    function doQuery() {
        const name = document.getElementById('inp-name').value; 
        const sch = document.getElementById('sel-school').value; 
        const cls = document.getElementById('sel-class').value;
        
        let stu = SCHOOLS[sch]?.students.find(s => s.name === name && (cls === '--è¯·å…ˆé€‰æ‹©å­¦æ ¡--' || s.class === cls));
        if(!stu) return alert("æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿ");
        CURRENT_REPORT_STUDENT = stu;
        
        document.getElementById('single-report-result').classList.remove('hidden'); 
        const container = document.getElementById('report-card-capture-area');
        
        // å¼ºåˆ¶ä½¿ç”¨ 'A4' æ¨¡å¼è¿›è¡Œæ¸²æŸ“ï¼Œè¿™æ ·æ‰“å°å‡ºæ¥çš„æ•ˆæœæœ€å¥½
        container.innerHTML = renderSingleReportCardHTML(stu, 'A4');
        
        setTimeout(() => { renderRadarChart(stu); renderVarianceChart(stu);}, 100); 
        analyzeStrengthsAndWeaknesses(stu);
    }

    function updateMutualAidSelects() {
        const source = document.getElementById('aid_source').value;
        const schSel = document.getElementById('aidSchoolSelect'); 
        const clsSel = document.getElementById('aidClassSelect');
        const subSel = document.getElementById('aidSubjectSelect');
        schSel.innerHTML = ''; clsSel.innerHTML = '<option value="">--ç­çº§--</option>'; subSel.innerHTML = '';
        if (source === 'freshman') {
            schSel.disabled = true; schSel.innerHTML = '<option value="SIM">ğŸš€ æ–°ç”Ÿæ¨¡æ‹Ÿæ•°æ®</option>';
            subSel.innerHTML = '<option value="total">å…¥å­¦æ€»åˆ†</option>'; subSel.disabled = true;
            if (Object.keys(FB_SIMULATED_DATA).length > 0) { Object.keys(FB_SIMULATED_DATA).sort().forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`); } else { clsSel.innerHTML = '<option value="">(æš‚æ— æ•°æ®)</option>'; }
        } else {
            schSel.disabled = false; schSel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>'; 
            Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`);
            schSel.onchange = () => { clsSel.innerHTML = '<option value="">--ç­çº§--</option>'; if(schSel.value && SCHOOLS[schSel.value]) { const classes = [...new Set(SCHOOLS[schSel.value].students.map(s => s.class))].sort(); classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`); } };
            subSel.disabled = false; subSel.innerHTML = '<option value="total">æ€»åˆ†(ç»¼åˆ)</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
        }
    }

    function renderMutualAidGroups() {
        const source = document.getElementById('aid_source').value;
        const sch = document.getElementById('aidSchoolSelect').value; 
        const cls = document.getElementById('aidClassSelect').value;
        const sub = document.getElementById('aidSubjectSelect').value;
        const groupSize = parseInt(document.getElementById('aidGroupSize').value) || 4;
        let students = [];
        if (source === 'freshman') {
            if(!cls || !FB_SIMULATED_DATA[cls]) return alert("æ— åˆ†ç­æ•°æ®");
            students = FB_SIMULATED_DATA[cls].map(s => ({...s, class: cls, total: s.score, scores: {total: s.score}, ranks: {total: {class: 0}}}));
        } else {
            if(!sch || !cls) return alert("è¯·é€‰æ‹©å­¦æ ¡å’Œç­çº§");
            students = JSON.parse(JSON.stringify(SCHOOLS[sch].students.filter(s => s.class === cls)));
        }
        if(students.length < groupSize) return alert("ç­çº§äººæ•°ä¸è¶³ä»¥åˆ†ç»„");
        const getScore = (s) => (sub === 'total' ? s.total : (s.scores[sub] || 0));
        students.sort((a, b) => getScore(b) - getScore(a));
        students.forEach((s, i) => s._subRankPct = (i + 1) / students.length);
        let totalSorted = [...students].sort((a, b) => b.total - a.total);
        totalSorted.forEach((s, i) => { let target = students.find(x => x.name === s.name); if(target) target._totalRankPct = (i + 1) / students.length; });
        let mentors = students.filter(s => s._subRankPct <= 0.25 && s._totalRankPct <= 0.40);
        if (mentors.length < (students.length / groupSize) * 0.5) { mentors = students.filter(s => s._subRankPct <= 0.25 && s._totalRankPct <= 0.50); }
        const targetGroupCount = Math.ceil(students.length / groupSize);
        if (mentors.length < targetGroupCount) { mentors = students.slice(0, targetGroupCount); }
        mentors = mentors.slice(0, targetGroupCount);
        let remaining = students.filter(s => !mentors.includes(s));
        let groups = mentors.map((m, i) => ({ id: i + 1, leader: m, members: [] }));
        remaining.sort((a, b) => getScore(b) - getScore(a));
        let direction = 1; let gIdx = 0;
        while(remaining.length > 0) {
            let student = remaining.shift(); groups[gIdx].members.push(student);
            gIdx += direction;
            if (gIdx >= groups.length) { gIdx = groups.length - 1; direction = -1; } else if (gIdx < 0) { gIdx = 0; direction = 1; }
        }
        AID_GROUPS_CACHE = groups;
        renderAidGroupsHTML(groups, sub);
    }

    function renderAidGroupsHTML(groups, sub) {
        const container = document.getElementById('aid-groups-container'); container.innerHTML = '';
        groups.forEach(g => {
            const allScores = [g.leader, ...g.members].map(s => sub==='total'?s.total:(s.scores[sub]||0)); const avg = allScores.reduce((a,b)=>a+b,0) / allScores.length;
            let membersHtml = '';
            g.members.forEach(m => {
                const score = sub==='total'?m.total:(m.scores[sub]||0); let tag = ''; if (m._subRankPct > 0.8) tag = `<span class="aid-tag tag-weak">éœ€å¸®æ‰¶</span>`;
                membersHtml += `<div class="aid-role-row aid-member"><div class="aid-avatar">${m.name[0]}</div><div class="aid-info"><div class="aid-name">${m.name} ${tag}</div><div class="aid-score">${sub}: ${score}</div></div></div>`;
            });
            const leaderScore = sub==='total'?g.leader.total:(g.leader.scores[sub]||0);
            const card = document.createElement('div'); card.className = 'aid-card';
            card.innerHTML = `<div class="aid-header"><span>ç¬¬ ${g.id} ç»„</span><span style="font-weight:normal; color:#666;">å‡åˆ†: ${avg.toFixed(1)}</span></div><div class="aid-body"><div class="aid-role-row aid-leader"><div class="aid-avatar">ç»„</div><div class="aid-info"><div class="aid-name">${g.leader.name} <span class="aid-tag tag-strong">ç»„é•¿</span></div><div class="aid-score">${sub}: ${leaderScore}</div></div></div>${membersHtml}</div>`; container.appendChild(card);
        });
    }

    function exportMutualAidGroups() {
        if(AID_GROUPS_CACHE.length === 0) return alert("è¯·å…ˆç”Ÿæˆåˆ†ç»„");
        const wb = XLSX.utils.book_new(); const data = [['ç»„å·', 'è§’è‰²', 'å§“å', 'å‚è€ƒåˆ†æ•°']];
        AID_GROUPS_CACHE.forEach(g => {
            const sub = document.getElementById('aidSubjectSelect').value; const getS = (s) => sub==='total'?s.total:(s.scores[sub]||0);
            data.push([g.id, 'ç»„é•¿', g.leader.name, getS(g.leader)]);
            g.members.forEach(m => { data.push([g.id, 'ç»„å‘˜', m.name, getS(m)]); });
            data.push(['', '', '', '']);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "å­¦ç§‘äº’åŠ©åˆ†ç»„"); XLSX.writeFile(wb, "äº’åŠ©åˆ†ç»„åå•.xlsx");
    }

    function generateAIComment(student) {
        const style = 'encouraging'; 
        const teacherName = 'è€å¸ˆ'; // é»˜è®¤ç§°å‘¼
        const totalRank = safeGet(student, 'ranks.total.township', 99999); const totalStudents = RAW_DATA.length || 1; const percentile = totalRank / totalStudents;
        let progress = 0; if(PROGRESS_CACHE.length > 0) { const progRecord = PROGRESS_CACHE.find(p => p.name === student.name && p.class === student.class); if(progRecord) progress = progRecord.change; }
        let bestSub = { name: '', rank: 99999 }; let worstSub = { name: '', rank: 0 };
        SUBJECTS.forEach(sub => { const r = safeGet(student, `ranks.${sub}.township`, 0); if(r > 0) { if(r < bestSub.rank) bestSub = { name: sub, rank: r }; if(r > worstSub.rank) worstSub = { name: sub, rank: r }; } });
        const isPartial = (worstSub.rank - bestSub.rank) > (totalStudents * 0.4);
        const phrases = {
            opening: { top: [`${student.name}åŒå­¦ï¼Œä½ ä¸€ç›´æ˜¯ç­çº§çš„é¢†å¤´ç¾Šã€‚`, `ä½ ä¼˜ç§€çš„æˆç»©è¯æ˜äº†ä½ çš„åŠªåŠ›å’Œå¤©èµ‹ã€‚`], mid: [`${student.name}åŒå­¦ï¼Œä½ æ˜¯ä¸€ä¸ªæ½œåŠ›å·¨å¤§çš„å­¦ç”Ÿã€‚`, `ä½ çš„æˆç»©ä¿æŒåœ¨ç­çº§ä¸­æ¸¸ï¼ŒåŸºç¡€æ¯”è¾ƒæ‰å®ã€‚`], low: [`${student.name}åŒå­¦ï¼Œè€å¸ˆçœ‹åˆ°äº†ä½ èº«ä¸Šçš„é—ªå…‰ç‚¹ã€‚`, `è™½ç„¶ç›®å‰çš„æˆç»©ä¸å°½å¦‚äººæ„ï¼Œä½†åªè¦ä¸æ”¾å¼ƒï¼Œæ€»æœ‰å¸Œæœ›ã€‚`] },
            progress: { up: [`æœ¬æ¬¡è€ƒè¯•ä½ è¿›æ­¥äº†${progress}åï¼Œè¿™æ˜¯ä½ è¾›å‹¤ä»˜å‡ºçš„å›æŠ¥ï¼`, `æ¬£å–œåœ°çœ‹åˆ°ä½ çš„æ’ååœ¨ç¨³æ­¥ä¸Šå‡ï¼Œç»§ç»­ä¿æŒï¼`], down: [`æœ¬æ¬¡æ’åæœ‰æ‰€ä¸‹æ»‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€èµ·æ‰¾æ‰¾åŸå› ã€‚`, `æœ€è¿‘æ˜¯ä¸æ˜¯æœ‰äº›åˆ†å¿ƒï¼Ÿæˆç»©å‡ºç°äº†ä¸€ç‚¹æ³¢åŠ¨ã€‚`], flat: [`ä½ çš„æˆç»©éå¸¸ç¨³å®šï¼Œä¿æŒè¿™ç§çŠ¶æ€å¾ˆéš¾å¾—ã€‚`] },
            subjects: { partial: [`ä½ çš„${bestSub.name}éå¸¸æœ‰ä¼˜åŠ¿ï¼Œä½†${worstSub.name}ç¨å¾®æ‹–äº†åè…¿ï¼Œå¦‚æœèƒ½å¹³è¡¡ä¸€ä¸‹ï¼Œæ€»åˆ†ä¼šæ›´é«˜ã€‚`, `è¦è­¦æƒ•åç§‘ç°è±¡ï¼Œ${worstSub.name}å­¦ç§‘éœ€è¦æŠ•å…¥æ›´å¤šç²¾åŠ›ã€‚`], balanced: [`å„ç§‘å‘å±•æ¯”è¾ƒå‡è¡¡ï¼Œæ²¡æœ‰æ˜æ˜¾çš„çŸ­æ¿ï¼Œè¿™æ˜¯ä½ çš„æ ¸å¿ƒç«äº‰åŠ›ã€‚`, `å…¨é¢å‘å±•æ˜¯ä½ æœ€å¤§çš„ä¼˜åŠ¿ï¼Œè¯·ç»§ç»­ä¿æŒè¿™ç§è‰¯å¥½çš„å­¦ä¹ èŠ‚å¥ã€‚`] },
            advice: { encouraging: [`ç›¸ä¿¡è‡ªå·±ï¼Œä½ ä¸€å®šè¡Œï¼${teacherName}è€å¸ˆä¼šä¸€ç›´æ”¯æŒä½ ã€‚`, `æœŸå¾…åœ¨ä¸‹æ¬¡å…‰è£æ¦œä¸Šçœ‹åˆ°æ›´è€€çœ¼çš„ä½ ï¼`] }
        };
        let parts = []; let tier = 'mid'; if(percentile <= 0.15) tier = 'top'; else if(percentile >= 0.75) tier = 'low';
        parts.push(phrases.opening[tier][Math.floor(Math.random() * phrases.opening[tier].length)]);
        if(Math.abs(progress) >= 10) { let pType = progress > 0 ? 'up' : 'down'; parts.push(phrases.progress[pType][Math.floor(Math.random() * phrases.progress[pType].length)]); } else { if(Math.random() > 0.5) parts.push(phrases.progress.flat[Math.floor(Math.random() * phrases.progress.flat.length)]); }
        if(isPartial) { parts.push(phrases.subjects.partial[Math.floor(Math.random() * phrases.subjects.partial.length)]); } else { parts.push(phrases.subjects.balanced[Math.floor(Math.random() * phrases.subjects.balanced.length)]); }
        parts.push(phrases.advice[style][Math.floor(Math.random() * phrases.advice[style].length)]);
        return parts.join("");
    }

    function findPreviousRecord(student) {
        // 1. åŸºç¡€æ£€æŸ¥
        if (!window.PREV_DATA || window.PREV_DATA.length === 0) {
            console.warn("å†å²æ•°æ®(PREV_DATA)ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œå¯¹æ¯”ã€‚è¯·å…ˆä¸Šä¼ å†å²æˆç»©ã€‚");
            return null;
        }

        // 2. æ ‡å‡†åŒ–å·¥å…·å‡½æ•° (æ¸…æ´—æ•°æ®)
        const cleanStr = (str) => String(str || "").trim().replace(/\s+/g, ""); // å»ç©ºæ ¼
        const normalizeClass = (cls) => {
            let s = String(cls || "").trim();
            // ç§»é™¤ "ç­", "çº§", "(", ")", ".", "-", "grade", "class"
            return s.replace(/[ç­çº§\(\)\.\-gradeclass]/gi, "");
        };

        const targetName = cleanStr(student.name);
        const targetClass = normalizeClass(student.class);
        const targetSchool = student.school;

        // 3. åœ¨å†å²åº“ä¸­æŸ¥æ‰¾
        const match = window.PREV_DATA.find(p => {
            // A. æ ¡å†…æ¨¡å¼ï¼šå¿…é¡»åŒ¹é…å­¦æ ¡ (å¦‚æœå†å²æ•°æ®æœ‰å­¦æ ¡å­—æ®µ)
            if (p.school && targetSchool && p.school !== targetSchool) return false;

            // B. å§“ååŒ¹é… (ä¸¥æ ¼åŒ¹é…æ¸…æ´—åçš„å§“å)
            if (cleanStr(p.name) !== targetName) return false;

            // C. ç­çº§æ™ºèƒ½åŒ¹é… (æ ¸å¿ƒä¿®å¤ç‚¹)
            // å°† "7.1", "701", "7å¹´çº§1ç­" éƒ½æ¸…æ´—ä¸º "71" æˆ– "701" è¿›è¡Œæ¯”å¯¹
            const histClass = normalizeClass(p.class);
            
            // è§„åˆ™1: å®Œå…¨ç›¸ç­‰
            if (histClass === targetClass) return true;
            
            // è§„åˆ™2: å¤„ç† "0" çš„å·®å¼‚ (ä¾‹å¦‚ 71 vs 701)
            // å¦‚æœä¸¤ä¸ªç­çº§å·éƒ½åŒ…å«æ•°å­—ï¼Œä¸”å»æ‰0åç›¸ç­‰ï¼Œè§†ä¸ºåŒ¹é… (å­˜åœ¨é£é™©ï¼Œä½†åœ¨åŒä¸€å¹´çº§å†…é€šå¸¸å®‰å…¨)
            const numC1 = histClass.replace(/0/g, '');
            const numC2 = targetClass.replace(/0/g, '');
            if (numC1 === numC2 && numC1.length > 0) return true;

            return false;
        });

        if (!match) {
            // è°ƒè¯•æ—¥å¿—ï¼šå¦‚æœä½ å‘ç°æŸäººæ²¡åŒ¹é…ä¸Šï¼ŒæŒ‰F12çœ‹æ§åˆ¶å°ä¼šæ˜¾ç¤ºåŸå› 
            // console.log(`æœªæ‰¾åˆ°å†å²è®°å½•: ${student.name} (ç­çº§:${targetClass})`);
        } else {
            // console.log(`åŒ¹é…æˆåŠŸ: ${student.name} -> ä¸Šæ¬¡åˆ†: ${match.total}`);
        }

        return match;
    }

    // ğŸŸ¢ [æ–°å¢]ï¼šç”Ÿæˆè¿›é€€æ­¥èƒ¶å›Šæ ‡ç­¾ (Windows é£æ ¼)
    function getTrendBadge(current, previous, type = 'score') {
        if (previous === undefined || previous === null || previous === '-' || previous === '') return '';
        
        // ç¡®ä¿æ•°å€¼ç±»å‹
        const currVal = parseFloat(current);
        const prevVal = parseFloat(previous);
        if (isNaN(currVal) || isNaN(prevVal)) return '';

        const diff = currVal - prevVal;
        if (Math.abs(diff) < 0.01) return `<span style="color:#94a3b8; font-size:11px; margin-left:4px; font-weight:normal;">(æŒå¹³)</span>`;

        let color = '';
        let icon = '';
        let bg = '';
        
        if (type === 'score') {
            // åˆ†æ•°ï¼šæ­£æ•°=è¿›æ­¥(ç»¿), è´Ÿæ•°=é€€æ­¥(çº¢/æ©™)
            if (diff > 0) { color = '#15803d'; bg = '#dcfce7'; icon = 'â–²'; } 
            else { color = '#b91c1c'; bg = '#fee2e2'; icon = 'â–¼'; }
        } else {
            // æ’åï¼šè´Ÿæ•°=è¿›æ­¥(åæ¬¡å˜å°), æ­£æ•°=é€€æ­¥(åæ¬¡å˜å¤§)
            if (diff < 0) { color = '#15803d'; bg = '#dcfce7'; icon = 'â–²'; } // æ’åä¸Šå‡
            else { color = '#b91c1c'; bg = '#fee2e2'; icon = 'â–¼'; }          // æ’åä¸‹é™
        }

        const absDiff = Math.abs(diff);
        // Windows 11 é£æ ¼åœ†è§’èƒ¶å›Š
        return `<span style="display:inline-flex; align-items:center; background:${bg}; color:${color}; padding:1px 6px; border-radius:10px; font-size:11px; font-weight:bold; margin-left:5px; vertical-align:middle;">
            ${icon} ${type==='score' ? absDiff.toFixed(1) : absDiff}
        </span>`;
    }
    
    // 1. ç»¼åˆæ¸²æŸ“å…¥å£ï¼šæ ¹æ®è®¾å¤‡ç±»å‹è‡ªåŠ¨é€‰æ‹©æ¨¡æ¿
    function renderSingleReportCardHTML(stu, mode) {
        // 1. å®‰å“ Canvas å…¼å®¹æ€§å…œåº• (éƒ¨åˆ†ä½ç‰ˆæœ¬å®‰å“ WebView æ— æ³•æ¸²æŸ“ Chart.js)
        // å¦‚æœæ˜¯å®‰å“ä¸”å±å¹•å°ï¼Œä¸”æ²¡æœ‰ window.Chart å¯¹è±¡(æå°‘æ•°æƒ…å†µ)ï¼Œå¼ºåˆ¶å›é€€åˆ° PC ç‰ˆ HTML è¡¨æ ¼
        const ua = navigator.userAgent.toLowerCase();
        const isAndroid = ua.includes('android');
        const isProblemAndroid = isAndroid && window.innerWidth <= 768 && !window.Chart;

        if (isProblemAndroid) {
            console.warn('âš ï¸ Android Canvas å¼‚å¸¸ï¼Œå¼ºåˆ¶åˆ‡æ¢ PC æ¨¡å¼');
            // é€’å½’è°ƒç”¨è‡ªå·±ï¼Œä¼ å…¥ 'PC' æ¨¡å¼ä»¥è·³è¿‡ä¸‹æ–¹çš„ Mobile åˆ¤æ–­
            return renderSingleReportCardHTML(stu, 'PC');
        }

        // 2. åˆ¤æ–­æ˜¯å¦ä¸ºæ‰‹æœºç«¯ (æˆ–æ˜¾å¼è¯·æ±‚ IG æ¨¡å¼)
        const isMobile = window.innerWidth <= 768; 
        
        if (isMobile || mode === 'IG') {
            // A. è·å– HTML å­—ç¬¦ä¸²
            const html = renderInstagramCard(stu);
            
            // B. å…³é”®ï¼šè®¾ç½®å»¶æ—¶å›è°ƒï¼Œåœ¨ HTML æ’å…¥ DOM åç»˜åˆ¶ Canvas å›¾è¡¨
            // å¿…é¡»ä½¿ç”¨ setTimeoutï¼Œå¦åˆ™æ­¤æ—¶ canvas å…ƒç´ è¿˜ä¸å­˜åœ¨äºé¡µé¢ä¸Š
            setTimeout(() => {
                if (typeof renderIGCharts === 'function') {
                    renderIGCharts(stu);
                }
            }, 50);

            // C. è¿”å› HTML å­—ç¬¦ä¸²
            return html;
        }

        // --- å¦åˆ™ï¼šæ¸²æŸ“åŸæœ‰çš„ PC ç«¯ Fluent Design é£æ ¼ (A4æ‰“å°ç‰ˆ) ---
        const totalStudentsCount = RAW_DATA.length; 
        const genDate = new Date().toLocaleDateString(); 
        
        // è·å–å¯¹æ¯”æ•°æ®
        const prevStu = findPreviousRecord(stu); 
        
        // æ’åæ•°æ®å‡†å¤‡
        const curTownRank = safeGet(stu, 'ranks.total.township', '-');
        const prevTownRank = prevStu ? (prevStu.townRank || '-') : '-';
        const curClassRank = safeGet(stu, 'ranks.total.class', '-');
        const prevClassRank = prevStu ? (prevStu.classRank || '-') : '-';
        const curSchoolRank = safeGet(stu, 'ranks.total.school', '-');
        const prevSchoolRank = prevStu ? (prevStu.schoolRank || '-') : '-';

        // å•æ ¡åˆ¤æ–­
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;
        const townColStyle = isSingleSchool ? 'display:none !important;' : '';

        // æ„å»ºè¡¨æ ¼è¡Œ
        let tableRows = '';

        // A. 9å¹´çº§äº”ç§‘æ€»åˆ†è¡Œ (é€»è¾‘ä¿æŒä¸å˜)
        if (CONFIG.name === '9å¹´çº§') { 
            let fiveTotal = 0, count = 0; 
            ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦'].forEach(sub => { 
                if (stu.scores[sub] !== undefined) { fiveTotal += stu.scores[sub]; count++; }
            }); 
            if (count > 0) { 
                tableRows += `<tr style="background:rgba(248,250,252,0.5);">
                    <td style="font-weight:bold; color:#475569;">ğŸ æ ¸å¿ƒäº”ç§‘</td>
                    <td style="font-weight:bold; color:#2563eb;">${fiveTotal.toFixed(1)}</td>
                    <td>-</td><td>-</td><td style="${townColStyle}">-</td>
                </tr>`; 
            } 
        }

        // B. æ€»åˆ†è¡Œ
        const prevTotal = prevStu ? prevStu.total : '-';
        const trendTotal = getTrendBadge(stu.total, prevTotal, 'score');
        const trendClass = getTrendBadge(curClassRank, prevClassRank, 'rank');
        const trendSchool = getTrendBadge(curSchoolRank, prevSchoolRank, 'rank');
        const trendTown = getTrendBadge(curTownRank, prevTownRank, 'rank');

        tableRows += `<tr style="background:rgba(239,246,255,0.7); backdrop-filter:blur(4px); border-bottom:2px solid #fff;">
            <td style="font-weight:bold; color:#1e3a8a;">ğŸ† ${CONFIG.label}</td>
            <td style="font-weight:800; font-size:16px; color:#1e40af;">${stu.total.toFixed(2)} ${trendTotal}</td>
            <td style="font-weight:bold; color:#334155;">${curClassRank} ${trendClass}</td>
            <td style="font-weight:bold; color:#334155;">${curSchoolRank} ${trendSchool}</td>
            <td style="${townColStyle} font-weight:bold; color:#334155;">${curTownRank} ${trendTown}</td>
        </tr>`;

        // C. å•ç§‘è¡Œ
        const uniqueSubjects = [...new Set(SUBJECTS)];
        uniqueSubjects.forEach(sub => {
            if (stu.scores[sub] !== undefined) {
                const prevSubScore = (prevStu && prevStu.scores) ? prevStu.scores[sub] : '-';
                const subTrend = getTrendBadge(stu.scores[sub], prevSubScore, 'score');
                
                let prevRanks = {};
                if (prevStu && prevStu.ranks && prevStu.ranks[sub]) prevRanks = prevStu.ranks[sub];
                
                const curCR = safeGet(stu, `ranks.${sub}.class`, '-');
                const tC = getTrendBadge(curCR, prevRanks.class || '-', 'rank');
                const curSR = safeGet(stu, `ranks.${sub}.school`, '-');
                const tS = getTrendBadge(curSR, prevRanks.school || '-', 'rank');
                const curTR = safeGet(stu, `ranks.${sub}.township`, '-');
                const tT = getTrendBadge(curTR, prevRanks.township || '-', 'rank');
                
                tableRows += `<tr style="transition:0.2s;" onmouseover="this.style.background='rgba(241,245,249,0.5)'" onmouseout="this.style.background='transparent'">
                    <td style="font-weight:600; color:#475569;">${sub}</td>
                    <td style="font-weight:bold; color:#334155;">${stu.scores[sub]} ${subTrend}</td>
                    <td style="color:#64748b;">${curCR} ${tC}</td>
                    <td style="color:#64748b;">${curSR} ${tS}</td>
                    <td style="color:#64748b; ${townColStyle}">${curTR} ${tT}</td>
                </tr>`;
            }
        });

        const fluentStyle = `
            <style>
                .fluent-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
                .fluent-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
                .fluent-title { font-size: 15px; font-weight: 700; color: #1e293b; }
                .fluent-subtitle { font-size: 11px; color: #94a3b8; margin-left: auto; }
                .fluent-table { width: 100%; border-collapse: separate; border-spacing: 0; }
                .fluent-table th { text-align: center; padding: 10px 5px; color: #64748b; font-size: 12px; font-weight: 600; border-bottom: 1px solid #e2e8f0; background: rgba(248, 250, 252, 0.5); }
                .fluent-table td { text-align: center; padding: 12px 5px; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 14px; }
                .fluent-table tr:last-child td { border-bottom: none; }
                @media print { .fluent-card { box-shadow: none; border: 1px solid #ccc; backdrop-filter: none; } }
            </style>
        `;

        return `
        ${fluentStyle}
        <div class="report-header" style="border-bottom:none; margin-bottom:10px; text-align:center;">
            <h3 style="font-family:'Microsoft YaHei', sans-serif; font-weight:800; color:#1e293b; letter-spacing:1px; margin:0;">${stu.school} å­¦ç”Ÿå­¦ä¸šå‘å±•æŠ¥å‘Š</h3>
            <p style="color:#94a3b8; font-size:12px; margin-top:5px;">ç”Ÿæˆæ—¥æœŸ: ${genDate}</p>
        </div>
        <div class="fluent-card" style="padding:15px 25px; background:linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; align-items:baseline; gap:15px;">
                    <span style="font-size:24px; font-weight:800; color:#1e3a8a;">${stu.name}</span>
                    <span style="font-size:14px; color:#475569; background:#fff; padding:2px 8px; border-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">${stu.class}</span>
                </div>
                <div style="font-size:13px; color:#64748b; font-family:monospace;">è€ƒå·: ${stu.id}</div>
            </div>
        </div>
        <div class="fluent-card" style="padding:0; overflow:hidden;">
            <table class="fluent-table" id="tb-query">
                <thead><tr><th style="text-align:left; padding-left:20px;">ç§‘ç›®</th><th>æˆç»© (å¯¹æ¯”)</th><th>ç­æ’</th><th>æ ¡æ’</th><th style="${townColStyle}">å…¨é•‡æ’å</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
        <div style="display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
            <div class="fluent-card" style="flex:1; min-width:300px; margin-bottom:0; display:flex; flex-direction:column;">
                <div class="fluent-header"><i class="ti ti-radar" style="color:#2563eb;"></i><span class="fluent-title">ç»¼åˆç´ è´¨è¯„ä»· (ç™¾åˆ†ä½)</span></div>
                <div style="flex:1; position:relative; min-height:220px;"><canvas id="radarChart"></canvas></div>
            </div>            
            <div class="fluent-card" style="flex:1; min-width:300px; margin-bottom:0; display:flex; flex-direction:column;">
                <div class="fluent-header"><i class="ti ti-scale" style="color:#059669;"></i><span class="fluent-title">å­¦ç§‘å‡è¡¡åº¦è¯Šæ–­ (Z-Score)</span></div>
                <div style="flex:1; position:relative; min-height:220px;"><canvas id="varianceChart"></canvas></div>
            </div> 
        </div>
        <div style="text-align:center; font-size:11px; color:#cbd5e1; margin-top:20px;">ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ Â· ä»…ä¾›å®¶æ ¡æ²Ÿé€šå‚è€ƒ</div>`;
    }

    // 2. ğŸŸ¢ æ–°å¢ï¼šç”Ÿæˆ Instagram é£æ ¼å¡ç‰‡çš„å‡½æ•° (Mobile Only)
    function renderInstagramCard(stu) {
        const genDate = new Date().toLocaleDateString();
        const totalStudents = RAW_DATA.length;
        const rank = safeGet(stu, 'ranks.total.township', '-');
        const pct = (typeof rank === 'number') ? ((1 - rank/totalStudents)*100).toFixed(0) : '-';
        const avatarLetter = stu.name.charAt(0); // å¤´åƒå–é¦–å­—
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå•æ ¡æ¨¡å¼
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;
        const scopeText = isSingleSchool ? "å…¨æ ¡" : "å…¨é•‡";

        let statusTag = '';
        if (pct >= 90) statusTag = 'ğŸŒŸ å“è¶Šä¹‹æ˜Ÿ';
        else if (pct >= 75) statusTag = 'ğŸ”¥ è¿›æ­¥é£é€Ÿ';
        else statusTag = 'ğŸ“š æŒç»­åŠªåŠ›';

        // 3. æ„å»ºå•ç§‘è¯„è®ºè¡Œ
        let commentsHtml = '';
        SUBJECTS.forEach(sub => {
            if (stu.scores[sub] !== undefined) {
                const score = stu.scores[sub];
                
                // ä¿®æ”¹ç‚¹ 1ï¼šè·å–æ ¡å†…æ’å (å³å¹´çº§æ’å/çº§æ’) è€Œä¸æ˜¯ç­çº§æ’å (.class)
                const subRank = safeGet(stu, `ranks.${sub}.school`, '-');
                
                commentsHtml += `
                    <div class="insta-comment-row">
                        <div>
                            <span class="insta-comm-user">${sub}</span>
                            <span class="insta-comm-text">æˆç»©å•</span>
                        </div>
                        <div>
                            <span class="insta-comm-score">${score}</span>
                            <!-- ä¿®æ”¹ç‚¹ 2ï¼šæ˜¾ç¤ºæ–‡å­—æ”¹ä¸º çº§æ’ -->
                            <span class="insta-comm-rank">çº§æ’#${subRank}</span>
                        </div>
                    </div>
                `;
            }
        });

// æ–°å¢ï¼šé›·è¾¾å›¾å’Œå‡è¡¡åº¦å›¾è¡¨çš„ Canvas å®¹å™¨
        // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯å ä½ï¼Œå…·ä½“çš„å›¾è¡¨å°†åœ¨ renderIGCharts å‡½æ•°ä¸­ç»˜åˆ¶
        const chartsHtml = `
            <div style="margin-top: 20px; padding: 0 14px;">
                <!-- é›·è¾¾å›¾å®¹å™¨ -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; margin-bottom: 15px;">
                    <div style="font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 10px; border-left: 4px solid #2563eb; padding-left: 8px;">
                        ğŸ“Š å­¦ç§‘èƒ½åŠ›é›·è¾¾å›¾
                    </div>
                    <div style="height: 250px; position: relative;">
                        <canvas id="igRadarChart"></canvas>
                    </div>
                </div>

                <!-- å‡è¡¡åº¦å®¹å™¨ -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0;">
                    <div style="font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 10px; border-left: 4px solid #059669; padding-left: 8px;">
                        âš–ï¸ å­¦ç§‘å‡è¡¡åº¦è¯Šæ–­
                    </div>
                    <div style="height: 200px; position: relative;">
                        <canvas id="igVarianceChart"></canvas>
                    </div>
                    <div style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 5px;">
                        æ³¨ï¼šå‘å³(ç»¿)ä¸ºä¼˜åŠ¿å­¦ç§‘ï¼Œå‘å·¦(çº¢)ä¸ºè–„å¼±å­¦ç§‘
                    </div>
                </div>
            </div>
        `;

        // 1. å®šä¹‰ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œç”¨äºè®¡ç®— Z-Score å¹¶å¯¹ç§‘ç›®è¿›è¡Œåˆ†å±‚ (å¼º/ä¸­/å¼±)
        // ç›®çš„ï¼šä¸ºåç»­çš„â€œä¸€å¥è¯è¯Šæ–­â€ã€â€œä¼˜åŠ¿æ¸…å•â€ã€â€œå®¶é•¿å»ºè®®â€æä¾›æ•°æ®æ”¯æ’‘
        const getSubjectLevels = () => {
            let strong = [], weak = [], mid = [], zScores = [];

            SUBJECTS.forEach(sub => {
                if (stu.scores[sub] !== undefined) {
                    // A. è·å–è¯¥ç§‘å…¨é•‡æ•°æ® (ç”¨äºè®¡ç®—æ ‡å‡†åˆ†)
                    const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                    if (allScores.length < 2) return;

                    // B. è®¡ç®—å‡å€¼ä¸æ ‡å‡†å·® (Standard Deviation)
                    const avg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                    const variance = allScores.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / allScores.length;
                    const sd = Math.sqrt(variance) || 1; // é˜²æ­¢é™¤ä»¥0

                    // C. è®¡ç®—æ ‡å‡†åˆ† Z-Score (åæ˜ è¯¥ç”Ÿåœ¨å…¨ä½“è€ƒç”Ÿä¸­çš„ç›¸å¯¹ä½ç½®)
                    const z = (stu.scores[sub] - avg) / sd;
                    zScores.push(z);

                    // D. åˆ†ç±» (é˜ˆå€¼ 0.8ï¼Œçº¦ç­‰äºå‰20%å’Œå20%)
                    const item = `${sub}`; // ä»…å­˜ç§‘ç›®å
                    if (z >= 0.8) strong.push(item);      // å¼ºç§‘
                    else if (z <= -0.8) weak.push(item);  // å¼±ç§‘
                    else mid.push(item);                  // ä¸­ç­‰
                }
            });

            // è®¡ç®—æå·® (Range)ï¼Œç”¨äºåˆ¤æ–­æ•´ä½“ç»“æ„æ˜¯â€œå‡è¡¡â€è¿˜æ˜¯â€œåç§‘â€
            const maxZ = zScores.length ? Math.max(...zScores) : 0;
            const minZ = zScores.length ? Math.min(...zScores) : 0;
            const range = maxZ - minZ;

            return { strong, weak, mid, range };
        };

        // 2. æ‰§è¡Œè®¡ç®—ï¼Œè·å–åˆ†å±‚ç»“æœ
        const levels = getSubjectLevels();

        // 3. ç”Ÿæˆã€æ¨¡å—â‘£ã€‘ä¸€å¥è¯è¯Šæ–­æ–‡æ¡ˆ
        const getDiagnosisText = (range) => {
            if (range >= 2.5) {
                // æå·®å¤§ï¼šä¸¥é‡åç§‘
                return {
                    tag: 'âš ï¸ ä¸¥é‡åç§‘',
                    color: '#b91c1c', bg: '#fee2e2',
                    text: 'ä¸åŒå­¦ç§‘æˆç»©å·®å¼‚æå¤§ï¼Œå­˜åœ¨æ˜æ˜¾ä¼˜åŠ¿ç§‘ç›®ä¸è–„å¼±ç§‘ç›®ï¼Œéœ€è¦é’ˆå¯¹æ€§è°ƒæ•´å­¦ä¹ é‡å¿ƒï¼Œè¡¥é½çŸ­æ¿ã€‚'
                };
            } else if (range >= 1.2) {
                // æå·®ä¸­ï¼šç›¸å¯¹å‡è¡¡
                return {
                    tag: 'âš–ï¸ ç›¸å¯¹å‡è¡¡',
                    color: '#0369a1', bg: '#e0f2fe',
                    text: 'å„å­¦ç§‘æˆç»©æ•´ä½“è¾ƒä¸ºå‡è¡¡ï¼Œä¸ªåˆ«å­¦ç§‘ç•¥æœ‰æ³¢åŠ¨ï¼Œä¿æŒç¨³å®šå‘æŒ¥æ˜¯å…³é”®ã€‚'
                };
            } else {
                // æå·®å°ï¼šç»“æ„ä¼˜ç§€
                return {
                    tag: 'ğŸŒŸ ç»“æ„ä¼˜ç§€',
                    color: '#15803d', bg: '#dcfce7',
                    text: 'å„å­¦ç§‘å‘å±•æå…¶å‡è¡¡ï¼Œæ— æ˜æ˜¾çŸ­æ¿ï¼Œå¿ƒç†ç´ è´¨ç¨³å®šï¼Œæ˜¯å†²åˆºæ›´é«˜ç›®æ ‡çš„ç†æƒ³çŠ¶æ€ã€‚'
                };
            }
        };

        const diag = getDiagnosisText(levels.range);

        // --- ç”Ÿæˆã€æ¨¡å—â‘£ã€‘HTMLï¼šä¸€å¥è¯è¯Šæ–­ ---
        const igDiagnosisHtml = `
            <div style="margin: 15px 14px 0 14px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-weight:bold; color:#334155; font-size:14px;">ğŸ§  å­¦æƒ…ç»“æ„è¯Šæ–­</span>
                    <span style="font-size:12px; background:${diag.bg}; color:${diag.color}; padding:2px 8px; border-radius:12px; font-weight:bold;">
                        ${diag.tag}
                    </span>
                </div>
                <div style="font-size:13px; color:#64748b; line-height:1.5;">
                    ${diag.text}
                </div>
            </div>
        `;

        // --- ç”Ÿæˆã€æ¨¡å—â‘¤ã€‘HTMLï¼šä¼˜åŠ¿/çŸ­æ¿æŠ˜å æ¸…å• ---
        // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆåˆ—è¡¨é¡¹
        const renderListItems = (arr, emptyText) => {
            if (!arr || arr.length === 0) return `<div style="font-size:12px; color:#ccc; padding:5px;">${emptyText}</div>`;
            return arr.map(sub => 
                `<span style="display:inline-block; background:#f1f5f9; color:#334155; font-size:12px; padding:4px 10px; border-radius:4px; margin:0 5px 5px 0;">${sub}</span>`
            ).join('');
        };

        const igSubjectListHtml = `
            <div style="margin: 15px 14px 0 14px;">
                <!-- ä¼˜åŠ¿ç§‘ç›® -->
                <details open style="margin-bottom:10px; background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
                    <summary style="padding:10px 15px; font-size:13px; font-weight:bold; color:#333; cursor:pointer; background:#f8fafc; list-style:none; display:flex; align-items:center;">
                        <span style="margin-right:8px;">â˜€ï¸</span> ä¼˜åŠ¿å­¦ç§‘ (Zâ‰¥0.8)
                        <span style="margin-left:auto; font-size:10px; color:#999;">${levels.strong.length}ç§‘</span>
                    </summary>
                    <div style="padding:15px;">
                        ${renderListItems(levels.strong, 'æš‚æ— æ˜æ˜¾ä¼˜åŠ¿å­¦ç§‘ï¼Œç»§ç»­åŠ æ²¹')}
                    </div>
                </details>

                <!-- è–„å¼±ç§‘ç›® -->
                <details ${levels.weak.length > 0 ? 'open' : ''} style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
                    <summary style="padding:10px 15px; font-size:13px; font-weight:bold; color:#333; cursor:pointer; background:#fff1f2; list-style:none; display:flex; align-items:center;">
                        <span style="margin-right:8px;">ğŸŒ§ï¸</span> éœ€å…³æ³¨å­¦ç§‘ (Zâ‰¤-0.8)
                        <span style="margin-left:auto; font-size:10px; color:#dc2626;">${levels.weak.length}ç§‘</span>
                    </summary>
                    <div style="padding:15px;">
                        ${renderListItems(levels.weak, 'æš‚æ— æ˜æ˜¾çŸ­æ¿ï¼Œä¿æŒå‡è¡¡')}
                    </div>
                </details>
            </div>
        `;

        // --- ç”Ÿæˆã€æ¨¡å—â‘¥ã€‘HTMLï¼šå®¶é•¿æ‰§è¡Œå»ºè®® ---
        const getParentAdvice = () => {
            const adv = [];
            // ç­–ç•¥1ï¼šæœ‰å¼±ç§‘
            if (levels.weak.length > 0) {
                const subStr = levels.weak.join('ã€');
                adv.push(`ğŸ¯ <strong>ç²¾å‡†æ”»åšï¼š</strong>é’ˆå¯¹ ${subStr}ï¼Œå»ºè®®æ¯å¤©å®‰æ’ 15 åˆ†é’Ÿå›å½’è¯¾æœ¬åŸºç¡€æ¦‚å¿µï¼Œä¸ç›²ç›®åˆ·é¢˜ã€‚`);
            }
            // ç­–ç•¥2ï¼šæœ‰å¼ºç§‘
            if (levels.strong.length > 0) {
                const subStr = levels.strong.join('ã€');
                adv.push(`ğŸ›¡ï¸ <strong>ä¿æŒè‡ªä¿¡ï¼š</strong>${subStr} æ˜¯å­©å­çš„ä¿¡å¿ƒæ¥æºï¼Œè¯·å¤šç»™äºˆå…·ä½“è¡¨æ‰¬ï¼Œç¨³ä½ä¼˜åŠ¿ã€‚`);
            }
            // ç­–ç•¥3ï¼šå…¨æ˜¯ä¸­é—´ (å‡è¡¡)
            if (levels.strong.length === 0 && levels.weak.length === 0) {
                adv.push(`ğŸš€ <strong>å¯»æ‰¾çªç ´ï¼š</strong>ç›®å‰æˆç»©éå¸¸ç¨³å®šã€‚å»ºè®®é€‰å®šä¸€é—¨å­©å­æœ€æ„Ÿå…´è¶£çš„å­¦ç§‘ï¼Œå°è¯•å¢åŠ  5% çš„æŠ•å…¥ï¼ŒåŸ¹å…»æˆä¼˜åŠ¿å­¦ç§‘ã€‚`);
            }
            // é€šç”¨å»ºè®®
            adv.push(`ğŸ“… <strong>ä¹ æƒ¯å…»æˆï¼š</strong>æ£€æŸ¥å­©å­æ˜¯å¦å…»æˆäº†â€œå…ˆå¤ä¹ ï¼Œåä½œä¸šâ€çš„ä¹ æƒ¯ã€‚`);
            
            return adv.map(t => `<li style="margin-bottom:8px; line-height:1.5;">${t}</li>`).join('');
        };

        const igAdviceHtml = `
            <div style="margin: 15px 14px 20px 14px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px;">
                <div style="font-size:13px; font-weight:bold; color:#b45309; margin-bottom:10px; display:flex; align-items:center;">
                    <i class="ti ti-bulb" style="margin-right:5px; font-size:16px;"></i> å®¶é•¿è¡ŒåŠ¨æŒ‡å—
                </div>
                <ul style="padding-left:15px; margin:0; font-size:12px; color:#78350f;">
                    ${getParentAdvice()}
                </ul>
            </div>
        `;

        // æ¨¡æ‹Ÿå›¾è¡¨åŒºåŸŸ (ä½¿ç”¨CSSæ¸å˜èƒŒæ™¯ä»£æ›¿ Canvasï¼Œç¡®ä¿æ¸²æŸ“ç¨³å®š)
        const visualAreaHtml = `
            <div class="insta-visual-area">
                <div style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); border-radius:8px; color:white; padding:40px 0;">
                    <div style="font-size:16px; opacity:0.9; text-transform:uppercase; letter-spacing:2px;">Total Score</div>
                    <div style="font-size:64px; font-weight:800; text-shadow:0 4px 10px rgba(0,0,0,0.2);">${stu.total}</div>
                    <div style="margin-top:10px; font-size:18px; font-weight:bold; background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px;">
                        å…¨æ ¡æ’å: ${safeGet(stu, 'ranks.total.school', '-')}
                    </div>
                    <div style="margin-top:20px; font-size:12px; opacity:0.8;">å‡»è´¥äº†${scopeText} ${pct}% çš„è€ƒç”Ÿ</div>
                </div>
            </div>
        `;

        return `
            <div class="insta-view-container" style="background:#fafafa; padding-top:20px;">
                <div class="insta-card">
                    <!-- Header -->
                    <div class="insta-header">
                        <div class="insta-avatar-ring"><div class="insta-avatar">${avatarLetter}</div></div>
                        <div class="insta-user-info">
                            <div class="insta-username">${stu.name} <i class="ti ti-discount-check-filled insta-verified"></i></div>
                            <div class="insta-location">${stu.school} Â· ${stu.class}</div>
                        </div>
                        <i class="ti ti-dots"></i>
                    </div>
                    
                    <!-- 1. æ ¸å¿ƒæ€»åˆ†å¤§å¡ç‰‡ (Visual Area - æ—§æ¨¡å—) -->
                    ${visualAreaHtml}
                    
                    <!-- Actions (ç‚¹èµæ  - æ—§æ¨¡å—) -->
                    <div class="insta-actions">
                        <div class="insta-action-left">
                            <i class="ti ti-heart insta-icon liked"></i>
                            <i class="ti ti-message-circle-2 insta-icon"></i>
                            <i class="ti ti-send insta-icon"></i>
                        </div>
                        <i class="ti ti-bookmark insta-icon"></i>
                    </div>
                    
                    <!-- Likes -->
                    <div class="insta-likes">${(Math.random()*100 + 50).toFixed(0)} likes</div>
                    
                    <!-- Caption (æ–‡æ¡ˆ - æ—§æ¨¡å—) -->
                    <div class="insta-caption">
                        <span class="insta-caption-name">${CONFIG.name}æ•™åŠ¡å¤„</span>
                        æœ¬æ¬¡è€ƒè¯•æˆç»©å·²å‡ºç‚‰ï¼${statusTag}ï¼Œè¯·æŸ¥æ”¶æ‚¨çš„å­¦ä¹ æŠ¥å‘Šã€‚
                        <span class="insta-tags">#æœŸæœ«è€ƒè¯• #${stu.school} #å­¦ä¹ æŠ¥å‘Š</span>
                    </div>

                    <!-- 2. ğŸŸ¢ æ–°å¢ï¼šæ¨¡å—â‘£ å­¦æƒ…ç»“æ„ä¸€å¥è¯è¯Šæ–­ -->
                    ${typeof igDiagnosisHtml !== 'undefined' ? igDiagnosisHtml : ''}

                    <!-- 3. ğŸŸ¢ æ–°å¢ï¼šæ¨¡å—â‘¤ ä¼˜åŠ¿/çŸ­æ¿å­¦ç§‘æŠ˜å æ¸…å• -->
                    ${typeof igSubjectListHtml !== 'undefined' ? igSubjectListHtml : ''}

                    <!-- 4. ğŸŸ¢ æ–°å¢ï¼šå›¾è¡¨å®¹å™¨ (é›·è¾¾å›¾/å‡è¡¡åº¦ - ä¹‹å‰å®šä¹‰çš„ chartsHtml) -->
                    ${chartsHtml}

                    <!-- 5. å•ç§‘æˆç»©åˆ—è¡¨ (æ—§æ¨¡å—) -->
                    <div class="insta-comments" style="margin-top:15px;">
                        <div style="color:#8e8e8e; margin-bottom:5px; font-size:12px; font-weight:bold;">ğŸ“„ å•ç§‘æˆç»©è¯¦æƒ…</div>
                        ${commentsHtml}
                    </div>

                    <!-- 6. ğŸŸ¢ æ–°å¢ï¼šæ¨¡å—â‘¥ å®¶é•¿æ‰§è¡Œå»ºè®® -->
                    ${typeof igAdviceHtml !== 'undefined' ? igAdviceHtml : ''}

                    <!-- Timestamp -->
                    <div class="insta-timestamp">${genDate}</div>
                </div>
                
                <div style="text-align:center; padding:20px; color:#999; font-size:12px;">
                    <p>å·²æ˜¾ç¤ºå…¨éƒ¨æ•°æ®</p>
                    <button class="btn btn-sm btn-gray" onclick="Auth.logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        `;
    } 

    // 3. ğŸŸ¢ æ–°å¢ï¼šä¸“é—¨ç”¨äºæ¸²æŸ“ IG é£æ ¼å¡ç‰‡å†… Canvas çš„å‡½æ•° (æ‰‹æœºç«¯å›¾è¡¨æ ¸å¿ƒé€»è¾‘)
    function renderIGCharts(stu) {
        // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å…ƒç´ å·²ç»æ’å…¥é¡µé¢
        setTimeout(() => {
            // === ç»˜åˆ¶é›·è¾¾å›¾ ===
            const radarCtx = document.getElementById('igRadarChart');
            if (radarCtx) {
                // é˜²æ­¢é‡å¤æ¸²æŸ“ï¼Œå…ˆé”€æ¯æ—§å®ä¾‹
                if (window.igRadarInstance) window.igRadarInstance.destroy();

                const labels = [];
                const data = [];

                SUBJECTS.forEach(sub => {
                    if (stu.scores[sub] !== undefined) {
                        labels.push(sub);
                        
                        // è®¡ç®—ç™¾åˆ†ä½
                        const all = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number').sort((a, b) => b - a);
                        const rank = all.indexOf(stu.scores[sub]) + 1;
                        // (1 - æ’å/æ€»æ•°) * 100
                        data.push(((1 - rank / all.length) * 100).toFixed(1));
                    }
                });

                window.igRadarInstance = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'èƒ½åŠ›å€¼',
                            data: data,
                            backgroundColor: 'rgba(37, 99, 235, 0.2)', // è“è‰²å¡«å……
                            borderColor: '#2563eb',
                            pointBackgroundColor: '#2563eb',
                            pointBorderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 100,
                                ticks: { display: false }, // éšè—åˆ»åº¦
                                pointLabels: { 
                                    font: { size: 11, weight: 'bold' },
                                    color: '#333'
                                },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // === ç»˜åˆ¶å‡è¡¡åº¦å›¾ (Z-Score) ===
            const varCtx = document.getElementById('igVarianceChart');
            if (varCtx) {
                if (window.igVarianceInstance) window.igVarianceInstance.destroy();

                const labels = [];
                const zData = [];
                const colors = [];

                // ç®€å•çš„æ ‡å‡†å·®è®¡ç®—å‡½æ•°
                const calcStats = (arr) => {
                    const n = arr.length;
                    if (n === 0) return { mean: 0, sd: 1 };
                    const mean = arr.reduce((a, b) => a + b, 0) / n;
                    const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
                    return { mean, sd: Math.sqrt(variance) };
                };

                SUBJECTS.forEach(sub => {
                    if (stu.scores[sub] !== undefined) {
                        const allArr = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                        const stats = calcStats(allArr);
                        
                        let z = 0;
                        if (stats.sd > 0) z = (stu.scores[sub] - stats.mean) / stats.sd;
                        
                        labels.push(sub);
                        zData.push(z);
                        // æ­£æ•°ç»¿è‰²ï¼Œè´Ÿæ•°çº¢è‰²
                        colors.push(z >= 0 ? '#16a34a' : '#dc2626');
                    }
                });

                window.igVarianceInstance = new Chart(varCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ ‡å‡†åˆ† (Z-Score)',
                            data: zData,
                            backgroundColor: colors,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // æ¨ªå‘æŸ±çŠ¶å›¾
                        scales: {
                            x: { 
                                grid: { display: true, color: '#f1f5f9' },
                                title: { display: true, text: 'â† å¼±åŠ¿ | å¼ºåŠ¿ â†’', font: {size: 10}, color:'#94a3b8' }
                            },
                            y: { 
                                grid: { display: false } 
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

        }, 150); // å»¶æ—¶ 150ms ç¡®ä¿ HTML æ¸²æŸ“å®Œæ¯•
    }

    // 3. ğŸŸ¢ æ–°å¢ï¼šæ‰‹æœºç«¯ç®¡ç†å™¨é€»è¾‘å¯¹è±¡ (MobMgr)
    const MobMgr = {
        currentTab: 'home',

        // 1. åˆå§‹åŒ–æ‰‹æœºç®¡ç†ç•Œé¢
        init: function() {
            // éšè— PC ç«¯çš„å¤§å®¹å™¨åŠå¯¼èˆª
            document.getElementById('app').classList.add('hidden');
            const header = document.querySelector('header');
            if(header) header.style.display = 'none';
            const nav = document.querySelector('.nav-wrapper');
            if(nav) nav.style.display = 'none';
            
            // æ˜¾ç¤ºæ‰‹æœºç«¯å®¹å™¨
            const mobApp = document.getElementById('mobile-manager-app');
            mobApp.style.display = 'block';
            
            // å¡«å……ç”¨æˆ·ä¿¡æ¯
            const user = Auth.currentUser;
            if(user) {
                document.getElementById('mob-user-name').innerText = user.name;
                const roleMap = { 'admin':'ç®¡ç†å‘˜', 'teacher':'æ•™å¸ˆ', 'class_teacher':'ç­ä¸»ä»»', 'grade_director':'çº§éƒ¨ä¸»ä»»', 'director':'æ•™åŠ¡ä¸»ä»»' };
                document.getElementById('mob-user-role').innerText = roleMap[user.role] || user.role;
            }

            this.switchTab('home');
        },

        // 2. åˆ‡æ¢ Tab
        switchTab: function(tabId) {
            this.currentTab = tabId;
            
            // éšè—æ‰€æœ‰ view
            document.querySelectorAll('.mob-view').forEach(el => el.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡ view
            const targetView = document.getElementById(`mob-view-${tabId}`);
            if(targetView) targetView.classList.add('active');
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆªé«˜äº®
            document.querySelectorAll('.mob-nav-btn').forEach(btn => btn.classList.remove('active'));
            // åŒ¹é… onclick å­—ç¬¦ä¸²æ¥æ¿€æ´»æŒ‰é’®
            const activeBtn = Array.from(document.querySelectorAll('.mob-nav-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(activeBtn) activeBtn.classList.add('active');

            // è§¦å‘ç‰¹å®šé¡µé¢çš„æ¸²æŸ“é€»è¾‘
            if(tabId === 'students') this.renderStudentList();
            if(tabId === 'analysis') this.renderAnalysis();
        },

        // 3. æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨ (æ”¯æŒæœç´¢)
        renderStudentList: function() {
            const container = document.getElementById('mob-student-list');
            const keyword = document.getElementById('mob-search-input').value.toLowerCase();
            const user = Auth.currentUser;
            
            let list = RAW_DATA;
            
            // æƒé™è¿‡æ»¤
            if(user) {
                if(user.school) list = list.filter(s => s.school === user.school);
                if(user.role === 'class_teacher' && user.class) {
                    list = list.filter(s => s.class === user.class);
                }
            }

            if(keyword) {
                list = list.filter(s => s.name.toLowerCase().includes(keyword) || String(s.id).includes(keyword));
            }

            // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé˜²æ­¢æ‰‹æœº DOM è¿‡å¤šå¡é¡¿
            const displayList = list.slice(0, 50);
            
            if(displayList.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">æ— åŒ¹é…å­¦ç”Ÿ<br><small>è¯·å°è¯•æœç´¢å§“å</small></div>';
                return;
            }

            let html = '';
            displayList.forEach(s => {
                // æ ¹æ®æ€»åˆ†ç»™ä¸ªé¢œè‰²åŒºåˆ†
                const badgeColor = s.total >= 500 ? '#16a34a' : (s.total >= 360 ? '#2563eb' : '#d97706');
                html += `
                    <div class="mob-list-item" onclick="MobMgr.showStudentDetail('${s.name}')">
                        <div class="mob-avatar">${s.name[0]}</div>
                        <div class="mob-info">
                            <div class="mob-name">${s.name}</div>
                            <div class="mob-detail">${s.class} | è€ƒå·:${s.id}</div>
                        </div>
                        <div class="mob-score-badge" style="color:${badgeColor}">${s.total}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        },

        // 4. æ˜¾ç¤ºå­¦ç”Ÿè¯¦æƒ… (å¤ç”¨ IG é£æ ¼å¡ç‰‡ + å…¨å±æ¨¡æ€)
        showStudentDetail: function(name) {
            // ç®€å•æŸ¥æ‰¾ (å®é™…åº”è€ƒè™‘åŒåé—®é¢˜ï¼Œè¿™é‡Œä¼˜å…ˆå–ç¬¬ä¸€ä¸ª)
            const stu = RAW_DATA.find(s => s.name === name);
            if(!stu) return;
            
            const html = renderInstagramCard(stu);
            
            // åˆ›å»ºä¸´æ—¶å…¨å±å®¹å™¨
            let modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0'; modal.style.left = '0';
            modal.style.width = '100%'; modal.style.height = '100%';
            modal.style.background = '#fafafa';
            modal.style.zIndex = '20000';
            modal.style.overflowY = 'auto';
            // åŠ¨ç”»
            modal.style.animation = 'fadeIn 0.2s ease-out';
            
            modal.innerHTML = `
                <div style="position:fixed; top:0; width:100%; padding:10px; background:white; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; z-index:20001;">
                    <div style="font-weight:bold; color:#333;">å­¦ç”Ÿè¯¦æƒ…</div>
                    <button onclick="this.closest('div').parentElement.remove()" style="padding:6px 15px; background:#f3f4f6; border:none; border-radius:4px; font-weight:bold; color:#333;">å…³é—­</button>
                </div>
                <div style="padding-top:60px; padding-bottom:40px;">${html}</div>
            `;
            document.body.appendChild(modal);
        },

        // 5. æ¸²æŸ“ç®€å•åˆ†æ (æ€»è§ˆ)
        renderAnalysis: function() {
            const container = document.getElementById('mob-analysis-content');
            
            let list = RAW_DATA;
            const user = Auth.currentUser;
            if(user && user.school) {
                list = list.filter(s => s.school === user.school);
            }
            
            if(!list.length) {
                container.innerHTML = '<div style="padding:20px;text-align:center;">æš‚æ— æ•°æ®</div>'; return;
            }
            
            const total = list.length;
            const allTotal = list.map(s=>s.total).reduce((a,b)=>a+b,0);
            const avg = (allTotal / total).toFixed(1);
            
            let html = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
                    <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                        <div style="font-size:24px; font-weight:bold; color:#333;">${total}</div>
                        <div style="font-size:12px; color:#64748b;">æœ¬æ ¡äººæ•°</div>
                    </div>
                    <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd;">
                        <div style="font-size:24px; font-weight:bold; color:#2563eb;">${avg}</div>
                        <div style="font-size:12px; color:#0369a1;">å¹´çº§å‡åˆ†</div>
                    </div>
                </div>
                <div style="margin-top:20px; text-align:center; font-size:12px; color:#999;">
                    <i class="ti ti-device-desktop"></i><br>æ›´å¤šå¤æ‚åˆ†æï¼ˆå¦‚è¿›é€€æ­¥ã€ç­çº§å¯¹æ¯”ï¼‰<br>è¯·ç™»å½•ç”µè„‘ç«¯æŸ¥çœ‹
                </div>
            `;
            container.innerHTML = html;
        }
    };

    // 4. Hook: æ‹¦æˆª Auth.applyRoleViewï¼Œå®ç°æ‰‹æœºç«¯è‡ªåŠ¨è·³è½¬
    // å¿…é¡»ç¡®ä¿åœ¨ Auth å¯¹è±¡å®šä¹‰ä¹‹åæ‰§è¡Œæ­¤ä»£ç  (é€šå¸¸æ”¾åœ¨è„šæœ¬æœ«å°¾å³å¯)
    const originalApplyRoleView = Auth.applyRoleView;
    Auth.applyRoleView = function() {
        const isMobile = window.innerWidth <= 768;
        const role = this.currentUser.role;

        // A. å®¶é•¿è§’è‰²ï¼šå§‹ç»ˆè¿›å…¥ä¸“å±çš„ Parent View (ä¼šè‡ªåŠ¨è°ƒç”¨ renderInstagramCard)
        if (role === 'parent') {
            this.renderParentView();
            return;
        }

        // B. æ•™å¸ˆ/ç®¡ç†å‘˜ + æ‰‹æœºç«¯ï¼šè¿›å…¥ Mobile Manager App
        if (role !== 'parent' && isMobile) {
            MobMgr.init();
            return; // é˜»æ–­åç»­ PC é€»è¾‘
        }

        // C. å…¶ä»–æƒ…å†µ (PCç«¯)ï¼šæ‰§è¡ŒåŸæœ‰é€»è¾‘
        originalApplyRoleView.call(this);
    };




    function printSingleReport() {
        const reportContent = document.getElementById('report-card-capture-area');
        if (!reportContent || reportContent.innerHTML.trim() === "") return alert("è¯·å…ˆæŸ¥è¯¢ç”ŸæˆæŠ¥å‘Š");
        const printContainer = document.createElement('div'); printContainer.id = 'temp-print-wrapper';
        const originalCanvas = reportContent.querySelector('canvas');
        let canvasImg = ''; if (originalCanvas) { canvasImg = `<img src="${originalCanvas.toDataURL()}" style="width:100%; height:100%; object-fit:contain;">`; }
        printContainer.innerHTML = reportContent.innerHTML;
        if (originalCanvas) { const tempCanvasContainer = printContainer.querySelector('.chart-wrapper'); if(tempCanvasContainer) tempCanvasContainer.innerHTML = canvasImg; }
        printContainer.className = 'exam-print-page'; document.body.appendChild(printContainer);
        const style = document.createElement('style'); style.id = 'temp-print-style';
        style.innerHTML = `@media print { body > *:not(#temp-print-wrapper) { display: none !important; } #temp-print-wrapper { display: block !important; width: 100%; position: absolute; top: 0; left: 0; } .report-card-container { box-shadow: none; border: 1px solid #ccc; } -webkit-print-color-adjust: exact; print-color-adjust: exact; }`;
        document.head.appendChild(style); window.print();
        setTimeout(() => { document.body.removeChild(printContainer); document.head.removeChild(style); }, 500);
    }

    function batchGeneratePDF() {
        const sch = document.getElementById('sel-school').value; const cls = document.getElementById('sel-class').value;
        if (!sch || sch === '--è¯·å…ˆé€‰æ‹©å­¦æ ¡--' || !cls || cls === '--è¯·å…ˆé€‰æ‹©å­¦æ ¡--') { return alert("è¯·å…ˆé€‰æ‹©å­¦æ ¡å’Œç­çº§ï¼"); }
        const students = SCHOOLS[sch].students.filter(s => s.class === cls); if (students.length === 0) { return alert("è¯¥ç­çº§æ²¡æœ‰å­¦ç”Ÿæ•°æ®"); }
        students.sort((a, b) => b.total - a.total);
        if(!confirm(`å³å°†ç”Ÿæˆ ${students.length} ä»½ A4 æŠ¥å‘Šã€‚\n\nç³»ç»Ÿå°†è°ƒç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ï¼Œè¯·åœ¨æ‰“å°é¢„è§ˆé¡µé€‰æ‹©ï¼š\n1. ç›®æ ‡æ‰“å°æœºï¼šå¦å­˜ä¸º PDF\n2. æ›´å¤šè®¾ç½® -> å‹¾é€‰â€œèƒŒæ™¯å›¾å½¢â€\n\nç¡®å®šç»§ç»­å—ï¼Ÿ`)) return;
        const container = document.getElementById('batch-print-container'); container.innerHTML = ''; let batchHtml = '';
        students.forEach(stu => { 
            let reportHtml = renderSingleReportCardHTML(stu, 'A4');
            reportHtml = reportHtml.replace(/<div class="chart-wrapper"[\s\S]*?<\/div>/, '<div style="height:50px; text-align:center; color:#999; line-height:50px; border:1px dashed #eee; margin:10px 0;">(æ‰¹é‡æ‰“å°æ¨¡å¼æš‚ä¸æ˜¾ç¤ºé›·è¾¾å›¾)</div>');
            batchHtml += `<div style="page-break-after: always; padding: 20px; height: 100vh;">${reportHtml}</div>`; 
        });
        container.innerHTML = batchHtml; container.style.display = 'block';
        const style = document.createElement('style'); style.id = 'batch-print-style';
        style.innerHTML = `@media print { body > *:not(#batch-print-container) { display: none !important; } #batch-print-container { display: block !important; } .report-card-container { box-shadow: none !important; border: 2px solid #333 !important; } -webkit-print-color-adjust: exact; print-color-adjust: exact; }`;
        document.head.appendChild(style);
        setTimeout(() => { window.print(); setTimeout(() => { container.style.display = 'none'; container.innerHTML = ''; document.head.removeChild(style); }, 2000); }, 500);
    }
   // è¾…åŠ©ï¼šå°† Blob/File è½¬ä¸º Base64 å¹¶è‡ªåŠ¨å­˜å…¥ç¼“å­˜
       async function loadHistoricalArchives(input) {
        const files = input.files; 
        if (!files.length) return;
        
        let loadedCount = 0;
        
        // éå†æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const examName = file.name.replace('.xlsx', '').replace('.xls', ''); // ç”¨æ–‡ä»¶åä½œä¸ºè€ƒè¯•å
            
            await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet); // è¯»å–ä¸ºå¯¹è±¡æ•°ç»„
                    
                    // è‡ªåŠ¨è¯†åˆ«åˆ—å
                    if (json.length > 0) {
                        const sample = json[0];
                        // å¯»æ‰¾å…³é”®åˆ—ï¼šå§“åã€å­¦æ ¡ã€æ€»åˆ†/æ’å
                        const keyName = Object.keys(sample).find(k => k.includes('å§“å') || k.toLowerCase() === 'name');
                        const keySchool = Object.keys(sample).find(k => k.includes('å­¦æ ¡') || k.toLowerCase() === 'school');
                        // ä¼˜å…ˆæ‰¾æ’ååˆ—ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‰¾æ€»åˆ†åˆ—åç»­è‡ªåŠ¨ç®—æ’å(ç®€åŒ–èµ·è§è¿™é‡Œå‡è®¾æœ‰æ€»åˆ†)
                        const keyRank = Object.keys(sample).find(k => k.includes('æ’å') || k.includes('åæ¬¡') || k.includes('Rank'));
                        const keyScore = Object.keys(sample).find(k => k.includes('æ€»åˆ†') || k.includes('Total') || k === 'å¾—åˆ†');

                        if (keyName && (keyRank || keyScore)) {
                            // å¦‚æœåªæœ‰åˆ†æ•°æ²¡æœ‰æ’åï¼Œå…ˆè¿›è¡Œä¸€æ¬¡ç®€å•çš„æ’åºè®¡ç®—
                            if (!keyRank && keyScore) {
                                json.sort((a, b) => (b[keyScore]||0) - (a[keyScore]||0));
                                json.forEach((row, idx) => row._tempRank = idx + 1);
                            }

                            json.forEach(row => {
                                const name = row[keyName];
                                const school = keySchool ? row[keySchool] : 'é»˜è®¤å­¦æ ¡'; // å¦‚æœæ²¡æœ‰å­¦æ ¡åˆ—ï¼Œè§†ä¸ºå•æ ¡
                                const rank = keyRank ? parseInt(row[keyRank]) : row._tempRank;
                                
                                // å°è¯•åœ¨è¡Œæ•°æ®ä¸­æ‰¾â€œç­çº§â€
                                let className = "";
                                const keyClass = Object.keys(row).find(k => k.includes('ç­') || k.toLowerCase().includes('class'));
                                if (keyClass) className = normalizeClass(row[keyClass]);

                                if (name && rank) {
                                    // å”¯ä¸€æ ‡è¯†åŠ å…¥ç­çº§ï¼šå­¦æ ¡_ç­çº§_å§“å (ä¾‹å¦‚: å®éªŒä¸­å­¦_701_å¼ ä¸‰)
                                    // è¿™æ · 701çš„å¼ ä¸‰ å’Œ 702çš„å¼ ä¸‰ å°±ä¼šæ‹¥æœ‰ä¸¤ä»½ä¸åŒçš„æ¡£æ¡ˆ
                                    const uid = school + "_" + className + "_" + name; 
                                    if (!HISTORY_ARCHIVE[uid]) HISTORY_ARCHIVE[uid] = [];
                                    
                                    // é¿å…é‡å¤æ·»åŠ åŒä¸€åœºè€ƒè¯•
                                    if (!HISTORY_ARCHIVE[uid].find(x => x.exam === examName)) {
                                        HISTORY_ARCHIVE[uid].push({ exam: examName, rank: rank });
                                    }
                                }
                            });
                            loadedCount++;
                        }
                    }
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // è®¡ç®—ç¨³å®šæ€§å¹¶æ ‡è®°è¿‡å±±è½¦å­¦ç”Ÿ
        analyzeStability();
        
        document.getElementById('history-status').innerText = `âœ… å·²å»ºç«‹ ${Object.keys(HISTORY_ARCHIVE).length} ä»½å­¦ç”Ÿæ¡£æ¡ˆï¼ŒåŒ…å« ${loadedCount} æ¬¡å†å²è€ƒè¯•ã€‚`;
        input.value = ''; // æ¸…ç©ºä»¥å…è®¸é‡å¤ä¸Šä¼ 
    }

    function analyzeStability() {
        ROLLER_COASTER_STUDENTS = [];
        Object.keys(HISTORY_ARCHIVE).forEach(uid => {
            const records = HISTORY_ARCHIVE[uid];
            if (records.length < 3) return; // è‡³å°‘3æ¬¡è€ƒè¯•æ‰ç®—æ³¢åŠ¨

            const ranks = records.map(r => r.rank);
            const n = ranks.length;
            const mean = ranks.reduce((a, b) => a + b, 0) / n;
            // è®¡ç®—æ ‡å‡†å·® (Standard Deviation)
            const variance = ranks.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            const sd = Math.sqrt(variance);

            // é˜ˆå€¼è®¾å®šï¼šå¦‚æœæ ‡å‡†å·®è¶…è¿‡ 50 (æ„å‘³ç€å¹³å‡æ¯æ¬¡æ’åæ³¢åŠ¨å¹…åº¦å¾ˆå¤§)ï¼Œæ ‡è®°ä¸ºè¿‡å±±è½¦
            // *ä¹Ÿå¯ä»¥æ ¹æ®å…¨é•‡äººæ•°åŠ¨æ€è°ƒæ•´ï¼Œè¿™é‡Œå…ˆè®¾å›ºå®šå€¼æˆ–å…¨æ ¡äººæ•°çš„10%
            if (sd > 50) {
                ROLLER_COASTER_STUDENTS.push(uid);
            }
        });
        console.log("æ£€æµ‹åˆ°æ³¢åŠ¨å‰§çƒˆå­¦ç”Ÿæ•°:", ROLLER_COASTER_STUDENTS.length);
    }
    // 1. ä¿å­˜é…ç½®
    function saveLLMConfig() {
        const key = document.getElementById('llm_apikey').value;
        const url = document.getElementById('llm_baseurl').value;
        const model = document.getElementById('llm_model').value;
        
        if (!key) return alert("API Key ä¸èƒ½ä¸ºç©º");
        
        localStorage.setItem('LLM_API_KEY', key);
        localStorage.setItem('LLM_BASE_URL', url);
        localStorage.setItem('LLM_MODEL', model);
        
        LLM_CONFIG.apiKey = key;
        LLM_CONFIG.baseURL = url;
        LLM_CONFIG.model = model;
        
        alert("âœ… AI é…ç½®å·²ä¿å­˜ï¼");
    }

    // é¡µé¢åŠ è½½æ—¶å¡«å……é…ç½®æ¡†
    window.addEventListener('load', () => {
        if(LLM_CONFIG.apiKey) document.getElementById('llm_apikey').value = LLM_CONFIG.apiKey;
        document.getElementById('llm_baseurl').value = LLM_CONFIG.baseURL;
        document.getElementById('llm_model').value = LLM_CONFIG.model;
    });

    // 2. é€šç”¨ LLM è¯·æ±‚å‡½æ•°
    async function callLLM(prompt, onChunk, onFinish) {
        if (!LLM_CONFIG.apiKey) return alert("è¯·å…ˆåœ¨ã€æ•°æ®ä¸­å¿ƒã€‘è®¾ç½® AI API Key");
        
        try {
            const response = await fetch(`${LLM_CONFIG.baseURL}/v1/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${LLM_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: LLM_CONFIG.model,
                    messages: [
                        { role: "system", content: LLM_CONFIG.systemPrompt },
                        { role: "user", content: prompt }
                    ],
                    stream: true // å¼€å¯æµå¼è¾“å‡º
                })
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                // å¤„ç† SSE æ•°æ®æµ (data: {...})
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const content = json.choices[0].delta.content || "";
                            fullText += content;
                            if (onChunk) onChunk(content);
                        } catch (e) { }
                    }
                }
            }
            if (onFinish) onFinish(fullText);

        } catch (error) {
            console.error(error);
            alert("AI è¯·æ±‚å¤±è´¥: " + error.message);
            if (onFinish) onFinish(" (è¯·æ±‚å¤±è´¥)");
        }
    }

    // 3. ç”Ÿæˆå•ä¸ªå­¦ç”Ÿè¯„è¯­
    function callAIForComment() {
        const stu = CURRENT_REPORT_STUDENT;
        if (!stu) return alert("è¯·å…ˆæŸ¥è¯¢ä¸€åå­¦ç”Ÿ");
        
        const box = document.getElementById('ai-comment-box');
        // å¢åŠ ä¸€ä¸ª Loading åŠ¨ç”»æ•ˆæœ
        box.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <span class="loader-spinner" style="width:20px;height:20px;display:inline-block;vertical-align:middle;"></span>
                <span style="color:#4f46e5; font-weight:bold; margin-left:10px;">AI æ­£åœ¨æ ¹æ®å…¨é•‡æ•°æ®æ·±åº¦åˆ†æ ${stu.name} çš„å­¦æƒ…...</span>
            </div>`;
        
        // ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„å¢å¼ºç‰ˆ Prompt æ„å»ºå™¨
        const prompt = buildStudentPrompt(stu);

        let isFirstChunk = true;
        
        callLLM(prompt, (chunk) => {
            if (isFirstChunk) {
                box.innerHTML = ""; // æ¸…é™¤ Loading
                // å¢åŠ  Markdown æ ·å¼çš„ç®€å•å¤„ç†å®¹å™¨
                box.style.fontFamily = '"Segoe UI", system-ui, sans-serif';
                box.style.whiteSpace = 'pre-wrap'; 
                isFirstChunk = false;
            }
            
            // ç®€å•çš„æµå¼è¿½åŠ 
            box.innerText += chunk;
            
        }, (fullText) => {
            // (å¯é€‰) ç”Ÿæˆç»“æŸåï¼Œå¯ä»¥å¯¹æ–‡æœ¬è¿›è¡Œç®€å•çš„ Markdown é«˜äº®å¤„ç†
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬æŠŠ [å°æ ‡é¢˜] åŠ ç²—
            const formatted = fullText
                .replace(/\[(.*?)\]/g, '<br><strong style="color:#b45309; background:#fff7ed; padding:2px 5px; border-radius:4px;">$1</strong>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // å¤„ç† Markdown åŠ ç²—
            
            box.innerHTML = formatted;
        });
    }

    // 4. ç”Ÿæˆå¹´çº§è´¨é‡åˆ†ææŠ¥å‘Š (é•¿æ–‡) - æ™ºèƒ½å¢å¼ºç‰ˆ (æœ¬æ ¡ VS ä¹¡é•‡)
    // åŠŸèƒ½ï¼šä¸“æ³¨äºæœ¬æ ¡ä¸å…¨é•‡å¯¹æ¯”ï¼Œæä¾›åˆ†å±‚çº§ã€åˆ†ç§‘ç›®çš„æ·±åº¦è¯Šæ–­ä¸å®æ“å»ºè®®
    function generateAIMacroReport() {
        if (!Object.keys(SCHOOLS).length) return alert("æ— æ•°æ®");
        
        // 1. å¼ºåˆ¶æ£€æŸ¥æœ¬æ ¡è®¾ç½® (å…³é”®é€»è¾‘ï¼šæ²¡æœ‰æœ¬æ ¡å°±æ— æ³•åšå¯¹æ¯”)
        if (!MY_SCHOOL || !SCHOOLS[MY_SCHOOL]) {
            return alert("âš ï¸ æ— æ³•ç”Ÿæˆé’ˆå¯¹æ€§æŠ¥å‘Šï¼\n\nè¯·å…ˆåœ¨é¡µé¢é¡¶éƒ¨çš„ã€é€‰æ‹©æœ¬æ ¡ã€‘ä¸‹æ‹‰æ¡†ä¸­é€‰ä¸­æ‚¨çš„å­¦æ ¡ï¼Œç³»ç»Ÿæ‰èƒ½è¿›è¡Œâ€œæœ¬æ ¡ vs ä»–æ ¡â€çš„æ·±åº¦å¯¹æ¯”åˆ†æã€‚");
        }

        // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºæŠ¥å‘Š
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="width:95%; max-width:1600px; height:90vh; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <h3>ğŸ¤– AI æ·±åº¦è´¨é‡è¯Šæ–­: ${MY_SCHOOL} (å¯¹æ¯”åˆ†æç‰ˆ)</h3>
                    <button onclick="this.closest('.modal').remove()" style="border:none; bg:none; cursor:pointer; font-size:20px;">&times;</button>
                </div>
                <div id="ai-report-content" style="flex:1; overflow-y:auto; padding:20px; white-space:pre-wrap; line-height:1.8; font-family:serif; font-size:16px;">
                    æ­£åœ¨è°ƒå– ${MY_SCHOOL} ä¸å…¨é•‡å…¶ä»– ${Object.keys(SCHOOLS).length - 1} æ‰€å­¦æ ¡çš„å¯¹æ¯”æ•°æ®...
                    <br>æ­£åœ¨åˆ†æå­¦ç§‘çŸ­æ¿ä¸æåˆ†ç©ºé—´...
                    <br>æ­£åœ¨ç”Ÿæˆé’ˆå¯¹ ${CONFIG.name} çš„å¤‡è€ƒå»ºè®®...
                    <br><br>
                    <span class="loader-spinner" style="width:20px;height:20px;display:inline-block;"></span> AI æ­£åœ¨å¥‹ç¬”ç–¾ä¹¦ï¼Œè¯·ç¨å€™ (çº¦30ç§’)...
                </div>
                <div style="border-top:1px solid #eee; padding-top:10px; text-align:right;">
                    <button class="btn btn-blue" onclick="copyReport()">ğŸ“‹ å¤åˆ¶å…¨æ–‡</button>
                    <button class="btn btn-primary" onclick="exportToWord()" style="background:#2b579a; margin-left:10px;">
                        <i class="ti ti-file-word"></i> å¯¼å‡ºä¸º Word
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // --- A. æ•°æ®å‡†å¤‡ (Data Context) ---
        const myData = SCHOOLS[MY_SCHOOL];
        const totalSchools = Object.keys(SCHOOLS).length;
        const myRank = myData.rank2Rate || '-';
        
        // è®¡ç®—å…¨é•‡åŸºå‡†æ•°æ®
        let subjectComparison = []; // å­˜å‚¨å•ç§‘å¯¹æ¯”è¯¦æƒ…

        // éå†æ‰€æœ‰ç§‘ç›®è¿›è¡Œå¯¹æ¯”
        SUBJECTS.forEach(sub => {
            if (!myData.metrics[sub]) return;
            
            // å…¨é•‡è¯¥ç§‘æ•°æ®æ”¶é›†
            const allSchoolsMetrics = Object.values(SCHOOLS).map(s => s.metrics[sub]).filter(m => m);
            const townSubAvg = allSchoolsMetrics.reduce((a,b) => a + b.avg, 0) / allSchoolsMetrics.length;
            const maxSubAvg = Math.max(...allSchoolsMetrics.map(m => m.avg)); // ç¬¬ä¸€åå‡åˆ†
            
            // æœ¬æ ¡æ•°æ®
            const mySub = myData.metrics[sub];
            const diff = mySub.avg - townSubAvg; // ä¸å…¨é•‡å¹³å‡å·®
            const diffMax = mySub.avg - maxSubAvg; // ä¸ç¬¬ä¸€åå·®
            const rank = myData.rankings[sub]?.avg || '-';

            subjectComparison.push({
                subject: sub,
                myAvg: mySub.avg.toFixed(1),
                townAvg: townSubAvg.toFixed(1),
                diff: diff.toFixed(1), // ä¸å‡å€¼å·®
                diffMax: diffMax.toFixed(1), // ä¸ç¬¬ä¸€åå·®
                rank: rank,
                excRate: (mySub.excRate * 100).toFixed(1) + '%',
                passRate: (mySub.passRate * 100).toFixed(1) + '%'
            });
        });

        // åŒºåˆ†ä¼˜åŠ¿ä¸åŠ£åŠ¿å­¦ç§‘ (ç®€å•ç®—æ³•ï¼šæ’åå‰30%ä¸ºä¼˜ï¼Œå40%ä¸ºåŠ£)
        const strongSubjects = subjectComparison.filter(s => s.rank <= Math.ceil(totalSchools * 0.3)).map(s => s.subject).join('ã€');
        const weakSubjects = subjectComparison.filter(s => s.rank > Math.ceil(totalSchools * 0.6)).map(s => s.subject).join('ã€');

        // æ„å»ºä¸Šä¸‹æ–‡æ–‡æœ¬ï¼Œå–‚ç»™ AI
        const contextText = `
        ã€åŸºæœ¬ä¿¡æ¯ã€‘
        å¹´çº§æ¨¡å¼ï¼š${CONFIG.name} (ç‰¹åˆ«æ³¨æ„ï¼šå¦‚æœæ˜¯9å¹´çº§åˆ™é¢ä¸´ä¸­è€ƒï¼Œå¦‚æœæ˜¯7/8å¹´çº§åˆ™å¤„äºåŸºç¡€é˜¶æ®µ)
        æœ¬æ ¡ï¼š${MY_SCHOOL}
        å…¨é•‡å­¦æ ¡æ•°ï¼š${totalSchools}
        æœ¬æ ¡ç»¼åˆæ’åï¼šç¬¬ ${myRank} å
        æœ¬æ ¡ç»¼åˆå¾—åˆ†ï¼š${myData.score2Rate ? myData.score2Rate.toFixed(2) : '-'}

        ã€å­¦ç§‘è¯¦ç»†å¯¹æ¯”æ•°æ®ã€‘(æ­£æ•°ä»£è¡¨é«˜äºå…¨é•‡å‡åˆ†ï¼Œè´Ÿæ•°ä»£è¡¨ä½äº)ï¼š
        ${subjectComparison.map(s => `- ${s.subject}: å‡åˆ†${s.myAvg} (ä¸å…¨é•‡å·®${s.diff}, ä¸ç¬¬ä¸€åå·®${s.diffMax}), æ’å${s.rank}, ä¼˜ç‡${s.excRate}, åŠæ ¼ç‡${s.passRate}`).join('\n')}
        
        ã€åˆæ­¥è¯Šæ–­ã€‘
        ä¼˜åŠ¿å­¦ç§‘ï¼š${strongSubjects || 'æ— æ˜æ˜¾ä¼˜åŠ¿'}
        è–„å¼±å­¦ç§‘ï¼š${weakSubjects || 'æ— æ˜æ˜¾çŸ­æ¿'}
        `;

       // --- B. æ„å»º Prompt (è¦æ±‚ AI è¿”å› JSON æ ¼å¼) ---
        const prompt = `
        ä½ æ˜¯ä¸€ä½èµ„æ·±æ•™è‚²æ•°æ®åˆ†æå¸ˆã€‚è¯·åŸºäºä»¥ä¸‹ **${MY_SCHOOL}** çš„è€ƒè¯•æ•°æ®ï¼Œè¿›è¡Œæ·±åº¦è¯Šæ–­ã€‚

        ã€æ•°æ®ä¸Šä¸‹æ–‡ã€‘ï¼š
        ${contextText}

        ã€è¾“å‡ºæŒ‡ä»¤ã€‘ï¼š
        è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ **JSON** æ ¼å¼è¿”å›åˆ†æç»“æœï¼Œä¸è¦åŒ…å«ä»»ä½• Markdown æ ‡è®°ï¼ˆå¦‚ \`\`\`jsonï¼‰ï¼Œä¹Ÿä¸è¦åŒ…å«ä»»ä½•å¼€åœºç™½æˆ–ç»“æŸè¯­ï¼Œç›´æ¥è¿”å› JSON å¯¹è±¡ï¼š
        {
            "summary": "ä¸€å¥è¯è€ƒæƒ…ç»¼è¿°ï¼ˆä¾‹å¦‚ï¼šæ•´ä½“ç¨³ä¸­æœ‰è¿›ï¼Œä½†ä¼˜ç”Ÿæ–­å±‚ä¸¥é‡ï¼Œéœ€è­¦æƒ•ä¸¤æåˆ†åŒ–ï¼‰",
            "score": 85, 
            "highlights": ["äº®ç‚¹1ï¼šXXå­¦ç§‘å‡åˆ†è¶…å…¨é•‡å¹³å‡5åˆ†", "äº®ç‚¹2ï¼šåŠæ ¼ç‡ç¨³æ­¥æå‡"], 
            "warnings": ["é¢„è­¦1ï¼š903ç­æ•°å­¦å‡ºç°ä¸¥é‡æ»‘å¡", "é¢„è­¦2ï¼šå…¨æ ¡å‰100åäººæ•°åå°‘"], 
            "strategies": [
                { "title": "å­¦ç§‘æ”»åš", "action": "é’ˆå¯¹è‹±è¯­è–„å¼±é—®é¢˜ï¼Œå»ºè®®æ—©è¯»å¢åŠ 20åˆ†é’Ÿå•è¯å¬å†™..." },
                { "title": "åŸ¹ä¼˜è¾…å·®", "action": "å»ºç«‹ä¸´ç•Œç”Ÿæ¡£æ¡ˆï¼Œå®è¡Œå¯¼å¸ˆåˆ¶..." },
                { "title": "è¯¾å ‚å¸¸è§„", "action": "ä¸¥æŠ“æ™šè‡ªä¹ çºªå¾‹ï¼Œæé«˜ä½œä¸šå®Œæˆç‡..." }
            ],
            "slogan": "ä¸€å¥é¼“èˆäººå¿ƒçš„çŸ­å¥ï¼ˆ10å­—ä»¥å†…ï¼‰"
        }
        `;

        const contentDiv = document.getElementById('ai-report-content');
        // åˆå§‹åŒ– Loading ç•Œé¢
        contentDiv.innerHTML = `
            <div style="text-align:center; padding:50px;">
                <div class="loader-spinner" style="width:40px;height:40px;margin:0 auto 15px;display:block;"></div>
                <div style="font-size:16px; color:#4f46e5; font-weight:bold;">ğŸ¤– AI æ­£åœ¨è¿›è¡Œå¤šç»´åº¦æ¨ç†...</div>
                <div style="font-size:12px; color:#64748b; margin-top:5px;">æ­£åœ¨å¯¹æ¯”å…¨é•‡æ•°æ® / è®¡ç®—å­¦ç§‘å·®å¼‚ / ç”Ÿæˆæåˆ†ç­–ç•¥</div>
            </div>`;
        
        // è°ƒç”¨ AI æ¥å£ (ä½¿ç”¨ç´¯ç§¯æ¨¡å¼å¤„ç† JSON)
        let jsonBuffer = "";
        
        callLLM(prompt, (chunk) => {
            // æµå¼æ¥æ”¶æ•°æ®ï¼Œæš‚ä¸æ¸²æŸ“ï¼Œåªå­˜å…¥ buffer
            jsonBuffer += chunk;
        }, (fullText) => {
            // ç”Ÿæˆç»“æŸï¼Œå¼€å§‹è§£æä¸æ¸²æŸ“
            try {
                // 1. æ¸…æ´—æ•°æ®ï¼šå»é™¤å¯èƒ½å­˜åœ¨çš„ Markdown ä»£ç å—æ ‡è®°
                const cleanJson = jsonBuffer.replace(/```json/g, '').replace(/```/g, '').trim();
                
                // 2. è§£æ JSON
                const data = JSON.parse(cleanJson);
                
                // 3. æ¸²æŸ“æ¼‚äº®çš„ UI
                contentDiv.innerHTML = `
                    <div style="padding:10px;">
                        <!-- å¤´éƒ¨è¯„åˆ† -->
                        <div style="text-align:center; margin-bottom:30px; border-bottom:1px dashed #eee; padding-bottom:20px;">
                            <h2 style="color:#1e293b; margin:0 0 10px 0; font-size:24px;">${data.summary}</h2>
                            <div style="display:inline-flex; align-items:center; background:#fefce8; border:1px solid #facc15; padding:5px 15px; border-radius:20px;">
                                <span style="color:#854d0e; font-size:12px;">AI ç»¼åˆå¥åº·æŒ‡æ•°ï¼š</span>
                                <span style="font-size:28px; font-weight:800; color:#d97706; margin-left:8px;">${data.score}</span>
                            </div>
                        </div>

                        <!-- çº¢ç»¿æ¦œå¯¹æ¯” -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px;">
                            <div style="background:#f0fdf4; padding:20px; border-radius:12px; border:1px solid #bbf7d0;">
                                <h4 style="color:#166534; margin:0 0 10px 0; display:flex; align-items:center;">
                                    <i class="ti ti-thumb-up" style="margin-right:5px;"></i> äº®ç‚¹ä¸ä¼˜åŠ¿
                                </h4>
                                <ul style="padding-left:20px; color:#14532d; font-size:14px; margin:0; line-height:1.6;">
                                    ${data.highlights.map(h => `<li>${h}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background:#fef2f2; padding:20px; border-radius:12px; border:1px solid #fecaca;">
                                <h4 style="color:#991b1b; margin:0 0 10px 0; display:flex; align-items:center;">
                                    <i class="ti ti-alert-triangle" style="margin-right:5px;"></i> é£é™©ä¸é¢„è­¦
                                </h4>
                                <ul style="padding-left:20px; color:#7f1d1d; font-size:14px; margin:0; line-height:1.6;">
                                    ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- ç­–ç•¥æ¸…å• -->
                        <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                            <h4 style="color:#334155; margin:0 0 15px 0; border-left:4px solid var(--primary); padding-left:10px;">
                                ğŸš€ æè´¨å¢æ•ˆè¡ŒåŠ¨æ–¹æ¡ˆ
                            </h4>
                            <div style="display:flex; flex-direction:column; gap:15px;">
                                ${data.strategies.map((s, i) => `
                                    <div style="display:flex; align-items:flex-start; gap:12px;">
                                        <div style="background:#eff6ff; color:#1d4ed8; width:28px; height:28px; border-radius:6px; text-align:center; line-height:28px; font-weight:bold; flex-shrink:0;">${i+1}</div>
                                        <div>
                                            <div style="font-weight:bold; color:#1e293b; font-size:15px;">${s.title}</div>
                                            <div style="font-size:14px; color:#475569; margin-top:4px; line-height:1.5;">${s.action}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- åº•éƒ¨å£å· -->
                        <div style="margin-top:30px; text-align:center;">
                            <span style="background:#f1f5f9; color:#64748b; padding:8px 20px; border-radius:50px; font-style:italic; font-size:14px;">
                                â€œ ${data.slogan} â€
                            </span>
                        </div>
                    </div>
                `;
            } catch (e) {
                // å¦‚æœ AI è¿”å›çš„ä¸æ˜¯åˆæ³• JSONï¼Œå›é€€æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
                console.error("AI JSON è§£æå¤±è´¥", e);
                contentDiv.innerHTML = `
                    <div style="padding:20px; color:#333;">
                        <h3 style="color:#d97706;">âš ï¸ è§£ææ¨¡å¼é™çº§</h3>
                        <p style="font-size:12px; color:#666;">AI æœªè¿”å›æ ‡å‡† JSON æ ¼å¼ï¼Œå·²åˆ‡æ¢ä¸ºçº¯æ–‡æœ¬æ˜¾ç¤ºã€‚</p>
                        <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                        <pre style="white-space:pre-wrap; font-family:sans-serif; line-height:1.6;">${jsonBuffer}</pre>
                    </div>
                `;
            }
        });
    }
    
    function copyReport() {
        const text = document.getElementById('ai-report-content').innerText;
        navigator.clipboard.writeText(text).then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
    }
    function exportToWord() {
        const content = document.getElementById('ai-report-content').innerText;
        // ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å°è£…çš„ UI.toast æ›¿ä»£ alertï¼Œå¦‚æœè¿˜æ²¡åŠ  UI æ¨¡å—ï¼Œè¿™é‡Œä¾ç„¶å¯ä»¥ç”¨ alert
        if (!content || content.includes("æ­£åœ¨æ±‡æ€»")) return (window.UI ? UI.toast : alert)("è¯·ç­‰å¾…æŠ¥å‘Šç”Ÿæˆå®Œæ¯•åå†å¯¼å‡º");

        const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel } = docx;

        // 1. è§£ææ–‡æœ¬ï¼šç®€å•æŒ‰æ¢è¡Œç¬¦åˆ†å‰²
        const lines = content.split('\n').filter(line => line.trim() !== '');
        const docChildren = [];

        // 1.1 æ·»åŠ å¤§æ ‡é¢˜
        docChildren.push(
            new Paragraph({
                text: `${CONFIG.name} æ•™å­¦è´¨é‡åˆ†ææŠ¥å‘Š`,
                heading: HeadingLevel.TITLE,
                alignment: AlignmentType.CENTER,
                spacing: { after: 300 } 
            })
        );

        // 1.2 æ·»åŠ ç”Ÿæˆæ—¥æœŸ
        docChildren.push(
            new Paragraph({
                children: [
                    new TextRun({
                        text: `ç”Ÿæˆæ—¥æœŸï¼š${new Date().toLocaleDateString()}`,
                        italics: true,
                        color: "666666",
                        size: 20 // 10pt
                    })
                ],
                alignment: AlignmentType.CENTER,
                spacing: { after: 500 }
            })
        );

        // 1.3 æ™ºèƒ½è¯†åˆ«æ­£æ–‡æ®µè½ç»“æ„
        lines.forEach(line => {
            const trimmed = line.trim();
            
            // ç®€å•çš„æ ‡é¢˜è¯†åˆ«é€»è¾‘ï¼šä»¥ "ä¸€ã€" "1." ç­‰å¼€å¤´ï¼Œæˆ–è€…åŒ…å« "ã€"
            const isHeading = /^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]ã€/.test(trimmed) || 
                              /^\d+\./.test(trimmed) || 
                              /^ã€.*ã€‘$/.test(trimmed);

            if (isHeading) {
                // å°æ ‡é¢˜æ ¼å¼ï¼šåŠ ç²—ï¼Œå­—å·ç¨å¤§ï¼Œæ®µå‰æ®µåé—´è·
                docChildren.push(
                    new Paragraph({
                        children: [ new TextRun({ text: trimmed, bold: true, size: 28 }) ], // 14pt
                        spacing: { before: 400, after: 200 }
                    })
                );
            } else {
                // æ™®é€šæ­£æ–‡ï¼šé¦–è¡Œç¼©è¿› 2 å­—ç¬¦ï¼Œ1.5å€è¡Œè·
                docChildren.push(
                    new Paragraph({
                        children: [ new TextRun({ text: trimmed, size: 24 }) ], // 12pt
                        indent: { firstLine: 480 }, 
                        spacing: { line: 360 } 
                    })
                );
            }
        });

        // 1.4 åº•éƒ¨è½æ¬¾
        docChildren.push(
            new Paragraph({
                children: [ new TextRun({ text: "ï¼ˆæœ¬æŠ¥å‘Šç”±æ™ºèƒ½æ•™åŠ¡ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼‰", color: "999999", size: 18 }) ],
                alignment: AlignmentType.CENTER,
                spacing: { before: 800 }
            })
        );

        // 2. åˆ›å»ºæ–‡æ¡£å¯¹è±¡
        const doc = new Document({
            sections: [{ properties: {}, children: docChildren }],
        });

        // 3. ç”Ÿæˆå¹¶ä¸‹è½½
        Packer.toBlob(doc).then((blob) => {
            const fileName = `${CONFIG.name}_è´¨é‡åˆ†ææŠ¥å‘Š_${new Date().getTime()}.docx`;
            saveAs(blob, fileName);
            if(window.UI) UI.toast(`âœ… å·²å¯¼å‡º Word æ–‡æ¡£ï¼š${fileName}`, "success");
        }).catch(err => {
            console.error(err);
            alert("å¯¼å‡º Word å¤±è´¥ï¼š" + err.message);
        });
    }
    function loadTeacherStamp(input) {
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = function(e) { TEACHER_STAMP_BASE64 = e.target.result; alert("ç­¾å/ç« å›¾ç‰‡å·²å¯¼å…¥"); }; reader.readAsDataURL(file);
    }
    function renderHistoryChart(student) {
        const ctx = document.getElementById('historyChart'); 
        if(!ctx) return;
        if (historyChartInstance) historyChartInstance.destroy();

        // 1. å°è¯•ä»å†å²æ¡£æ¡ˆä¸­è·å–æ•°æ®
        const uid = student.school + "_" + student.name;
        // æ·±åº¦æ‹·è´ä¸€ä»½ï¼Œä»¥å…ä¿®æ”¹åŸæ•°æ®
        let history = HISTORY_ARCHIVE[uid] ? JSON.parse(JSON.stringify(HISTORY_ARCHIVE[uid])) : [];
        
        // 2. å°†â€œæœ¬æ¬¡â€è€ƒè¯•æ•°æ®åŠ å…¥è¶‹åŠ¿å›¾
        const currentRank = safeGet(student, 'ranks.total.township', 0);
        if(currentRank) {
            history.push({ exam: 'æœ¬æ¬¡æœŸæœ«', rank: currentRank });
        }

        // å¦‚æœå®Œå…¨æ²¡æœ‰æ•°æ®
        if(history.length === 0) {
            // ç”»ä¸€ä¸ªç©ºå›¾æˆ–è€…æ˜¾ç¤ºæ–‡å­—
            return;
        }

        // --- A. ç®€å•çº¿æ€§å›å½’é¢„æµ‹ (Simple Linear Regression) ---
        let prediction = null;
        
        // åªæœ‰å½“å†å²æ•°æ® >= 3 æ¬¡æ—¶æ‰è¿›è¡Œé¢„æµ‹ï¼Œå¦åˆ™æ ·æœ¬å¤ªå°‘ä¸å‡†ç¡®
        if (history.length >= 3) { 
            const n = history.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            
            // Xè½´ä¸ºæ—¶é—´åºåˆ—ç´¢å¼• (0, 1, 2...), Yè½´ä¸ºæ’å
            history.forEach((h, i) => {
                sumX += i;
                sumY += h.rank;
                sumXY += i * h.rank;
                sumXX += i * i;
            });

            // è®¡ç®—æ–œç‡ (Slope) å’Œ æˆªè· (Intercept)
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // é¢„æµ‹ä¸‹ä¸€æ¬¡ (ç´¢å¼•ä¸º n)
            const nextRank = Math.round(slope * n + intercept);
            
            // é™åˆ¶é¢„æµ‹å€¼åˆç†èŒƒå›´ (æ’åä¸èƒ½å°äº1)
            const predictedRank = Math.max(1, nextRank);
            
            // åˆ¤æ–­è¶‹åŠ¿æ–¹å‘
            const trend = slope < 0 ? 'ğŸ“ˆ æŒç»­è¿›æ­¥' : (slope > 0 ? 'ğŸ“‰ æœ‰ä¸‹æ»‘é£é™©' : 'â¡ï¸ ä¿æŒç¨³å®š');
            
            prediction = { 
                rank: predictedRank, 
                label: "ä¸‹æœŸé¢„æµ‹",
                trendText: trend
            };
        }

        // --- B. å‡†å¤‡å›¾è¡¨æ•°æ® ---
        const labels = history.map(h => h.exam);
        const data = history.map(h => h.rank);
        
        // å®šä¹‰ç‚¹çš„é¢œè‰²å’Œå¤§å° (çœŸå®æ•°æ®ç”¨è“è‰²)
        const pointColors = data.map(() => '#2563eb'); 
        const pointRadii = data.map(() => 5);

        // å¦‚æœæœ‰é¢„æµ‹æ•°æ®ï¼Œè¿½åŠ åˆ°æ•°ç»„æœ«å°¾
        if (prediction) {
            labels.push(prediction.label);
            data.push(prediction.rank);
            // é¢„æµ‹ç‚¹ç”¨æ©™è‰²ï¼Œä¸”ç¨å¾®å¤§ä¸€ç‚¹
            pointColors.push('#f59e0b'); 
            pointRadii.push(6); 
        }

        // --- C. ç»˜åˆ¶å›¾è¡¨ ---
        // åˆ¤æ–­æ˜¯å¦ä¸ºæ³¢åŠ¨ç”Ÿ (åŸæœ‰é€»è¾‘)
        const isUnstable = ROLLER_COASTER_STUDENTS.includes(uid);
        
        historyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å…¨é•‡æ’å (è¶Šä½è¶Šå¥½)',
                    data: data,
                    // æ ·å¼é…ç½®
                    backgroundColor: isUnstable ? 'rgba(220, 38, 38, 0.1)' : 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: pointColors, // ä½¿ç”¨åŠ¨æ€é¢œè‰²æ•°ç»„
                    pointRadius: pointRadii,       // ä½¿ç”¨åŠ¨æ€å¤§å°æ•°ç»„
                    fill: true,
                    tension: 0.3,
                    
                    // å…³é”®ï¼šåˆ©ç”¨ segment é…ç½®å®ç°è™šçº¿è¿æ¥é¢„æµ‹ç‚¹
                    segment: {
                        borderDash: ctx => {
                            // å¦‚æœæ˜¯è¿æ¥åˆ°æœ€åä¸€ç‚¹(ä¸”æœ‰é¢„æµ‹)ï¼Œåˆ™è®¾ä¸ºè™šçº¿ [5, 5]
                            if (prediction && ctx.p1DataIndex === data.length - 1) return [6, 4];
                            return undefined; // å®çº¿
                        },
                        borderColor: ctx => {
                            // é¢„æµ‹çº¿æ®µç”¨æ©™è‰²
                            if (prediction && ctx.p1DataIndex === data.length - 1) return '#f59e0b';
                            // æ³¢åŠ¨ç”Ÿç”¨çº¢è‰²ï¼Œæ™®é€šç”Ÿç”¨è“è‰²
                            return isUnstable ? '#dc2626' : '#2563eb';
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (prediction && context.dataIndex === data.length - 1) {
                                    return label + context.raw + " (AIé¢„æµ‹å€¼)";
                                }
                                return label + context.raw;
                            }
                        }
                    },
                    // åŠ¨æ€æ ‡é¢˜æ˜¾ç¤ºé¢„æµ‹ç»“æœ
                    title: { 
                        display: true, 
                        text: prediction 
                            ? `å†å²èµ°åŠ¿ | ğŸ¤– é¢„æµ‹ä¸‹æ¬¡: ç¬¬ ${prediction.rank} å (${prediction.trendText})`
                            : (isUnstable ? 'âš ï¸ æ’åæ³¢åŠ¨å‰§çƒˆï¼Œéœ€å…³æ³¨' : 'å†å²æ’åèµ°åŠ¿'),
                        color: (prediction && prediction.trendText.includes('é£é™©')) || isUnstable ? '#dc2626' : '#333',
                        font: { size: 13 }
                    }
                },
                scales: {
                    y: {
                        reverse: true, // æ’ååè½¬ï¼Œè¶Šé ä¸Šè¶Šå¥½
                        title: { display: true, text: 'åæ¬¡' },
                        suggestedMin: 1 // ä¿è¯Yè½´ä¸ä¸ºè´Ÿ
                    }
                }
            }
        });
    }

    function renderRadarChart(student) {
        const ctx = document.getElementById('radarChart'); if(!ctx) return;
        if (radarChartInstance) { radarChartInstance.destroy(); }

        const labels = []; 
        const currentData = [];
        const prevData = []; 

        const prevStu = findPreviousRecord(student);

        SUBJECTS.forEach(sub => {
            if(student.scores[sub] !== undefined) {
                labels.push(sub); 
                
                // æœ¬æ¬¡ç™¾åˆ†ä½
                const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => v !== undefined).sort((a, b) => b - a); 
                const rank = allScores.indexOf(student.scores[sub]) + 1; 
                const total = allScores.length; 
                const percentile = ((1 - (rank / total)) * 100).toFixed(1); 
                currentData.push(percentile);

                // ä¸Šæ¬¡ç™¾åˆ†ä½
                let prevPercentile = null;
                if (prevStu && prevStu.scores && prevStu.scores[sub] !== undefined && window.PREV_DATA) {
                    const prevAllScores = window.PREV_DATA
                        .map(s => s.scores ? s.scores[sub] : undefined)
                        .filter(v => typeof v === 'number')
                        .sort((a, b) => b - a);
                    
                    if (prevAllScores.length > 0) {
                        const prevRank = prevAllScores.indexOf(prevStu.scores[sub]) + 1;
                        const prevTotal = prevAllScores.length;
                        prevPercentile = ((1 - (prevRank / prevTotal)) * 100).toFixed(1);
                    }
                }
                prevData.push(prevPercentile);
            }
        });

        const datasets = [{ 
            label: 'æœ¬æ¬¡', 
            data: currentData, 
            fill: true, 
            backgroundColor: 'rgba(37, 99, 235, 0.2)', // è“è‰²å¡«å……
            borderColor: '#2563eb', // è“è‰²å®çº¿
            pointBackgroundColor: '#2563eb',
            pointBorderColor: '#fff',
            pointRadius: 4,
            order: 1
        }];

        // å¦‚æœæœ‰æœ‰æ•ˆå†å²æ•°æ®ï¼Œæ·»åŠ æ©™è‰²è™šçº¿
        if (prevData.some(d => d !== null)) {
             datasets.push({
                label: 'ä¸Šæ¬¡',
                data: prevData,
                fill: false, // ä¸å¡«å……ï¼Œé¿å…é¢œè‰²æ··æ‚
                borderDash: [6, 4], // æ˜æ˜¾çš„è™šçº¿
                // ğŸ‘‡ æ”¹ä¸ºé†’ç›®çš„æ©™è‰²
                borderColor: '#f97316', 
                pointBackgroundColor: '#fff', 
                pointBorderColor: '#f97316',
                pointRadius: 4,
                pointStyle: 'rectRot', // ç‚¹å½¢çŠ¶æ”¹ä¸ºè±å½¢ï¼ŒåŒºåˆ†æ›´æ˜æ˜¾
                order: 0 // ç½®äºåº•å±‚
             });
        }

        radarChartInstance = new Chart(ctx, { 
            type: 'radar', 
            data: { labels: labels, datasets: datasets }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    r: { 
                        min: 0, max: 100, 
                        ticks: { display: false }, 
                        pointLabels: { font: { size: 12, family: 'Microsoft YaHei', weight: 'bold' }, color: '#475569' },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        angleLines: { color: 'rgba(0,0,0,0.05)' }
                    } 
                }, 
                plugins: { 
                    legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 15 } } 
                } 
            } 
        });
    }

    let varianceChartInstance = null;
    
    function renderVarianceChart(student) {
        const ctx = document.getElementById('varianceChart'); 
        if(!ctx) return;
        if (varianceChartInstance) varianceChartInstance.destroy();

        const labels = [];
        const zScoresCurr = [];
        const zScoresPrev = []; 
        const bgColors = [];

        const prevStu = findPreviousRecord(student);

        const calcStats = (arr) => {
            const n = arr.length;
            if (n === 0) return { mean: 0, sd: 1 };
            const mean = arr.reduce((a, b) => a + b, 0) / n;
            const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            return { mean, sd: Math.sqrt(variance) };
        };

        SUBJECTS.forEach(sub => {
            if(student.scores[sub] !== undefined) {
                // æœ¬æ¬¡ Z-Score
                const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const stats = calcStats(allScores);
                let z = 0;
                if (stats.sd > 0) z = (student.scores[sub] - stats.mean) / stats.sd;
                
                labels.push(sub);
                zScoresCurr.push(z);

                // é¢œè‰²åˆ¤å®š
                if (z >= 0.8) bgColors.push('#16a34a');      // å¼º (ç»¿)
                else if (z <= -0.8) bgColors.push('#dc2626'); // å¼± (çº¢)
                else bgColors.push('#3b82f6');                // ä¸­ (è“)

                // ä¸Šæ¬¡ Z-Score
                let prevZ = null;
                if (prevStu && prevStu.scores && prevStu.scores[sub] !== undefined && window.PREV_DATA) {
                    const prevAllScores = window.PREV_DATA
                        .map(s => s.scores ? s.scores[sub] : undefined)
                        .filter(v => typeof v === 'number');
                    const prevStats = calcStats(prevAllScores);
                    if (prevStats.sd > 0) {
                        prevZ = (prevStu.scores[sub] - prevStats.mean) / prevStats.sd;
                    }
                }
                zScoresPrev.push(prevZ); 
            }
        });

        const datasets = [{
            label: 'æœ¬æ¬¡',
            data: zScoresCurr,
            backgroundColor: bgColors,
            borderRadius: 3,
            barPercentage: 0.5,
            categoryPercentage: 0.8,
            order: 1
        }];

        // å¦‚æœæœ‰å†å²æ•°æ®ï¼Œæ·»åŠ æ©™è‰²åŠé€æ˜æŸ±
        if (zScoresPrev.some(d => d !== null)) {
            datasets.push({
                label: 'ä¸Šæ¬¡',
                data: zScoresPrev,
                // ğŸ‘‡ æ”¹ä¸ºé†’ç›®çš„æ©™è‰² (åŠé€æ˜å¡«å…… + å®çº¿è¾¹æ¡†)
                backgroundColor: 'rgba(249, 115, 22, 0.4)', // Orange
                borderColor: '#f97316',
                borderWidth: 1,
                borderRadius: 3,
                barPercentage: 0.5,
                categoryPercentage: 0.8,
                order: 2 // ç¨å¾®é”™å¼€æˆ–é‡å å‡å¯ï¼Œbarå›¾è¡¨é»˜è®¤æ˜¯å¹¶åˆ—
            });
        }

        varianceChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // æ¨ªå‘æŸ±çŠ¶å›¾
                plugins: {
                    legend: { display: true, position: 'bottom' }, 
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label} Z-Score: ${ctx.raw ? ctx.raw.toFixed(2) : '-'}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { 
                            color: (ctx) => ctx.tick.value === 0 ? '#475569' : '#f1f5f9', 
                            lineWidth: (ctx) => ctx.tick.value === 0 ? 1.5 : 1 
                        },
                        suggestedMin: -2.5,
                        suggestedMax: 2.5,
                        ticks: { display: false } 
                    },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    function analyzeStrengthsAndWeaknesses(student) {
        const strengthsContainer = document.getElementById('strengths-container'); const weaknessesContainer = document.getElementById('weaknesses-container'); const suggestionsContainer = document.getElementById('suggestions-container');
        if(!strengthsContainer || !weaknessesContainer || !suggestionsContainer) return;
        const allTotals = RAW_DATA.map(s => s.total).sort((a, b) => b - a); const totalPercentile = (allTotals.indexOf(student.total) + 1) / allTotals.length;
        const strengths = [], weaknesses = [];
        SUBJECTS.forEach(subject => {
            if (student.scores[subject] !== undefined) {
                const allScores = RAW_DATA.map(s => s.scores[subject]).filter(v => v !== undefined).sort((a, b) => b - a); const percentile = (allScores.indexOf(student.scores[subject]) + 1) / allScores.length; if (percentile < totalPercentile - 0.2) strengths.push({ subject, percentile, score: student.scores[subject] }); else if (percentile > totalPercentile + 0.2) weaknesses.push({ subject, percentile, score: student.scores[subject] });
            }
        });
        strengthsContainer.innerHTML = strengths.length ? strengths.map(s => `<span>${s.subject} <small>(${s.score})</small></span>`).join('ã€') : 'æ— æ˜æ˜¾ä¼˜åŠ¿å­¦ç§‘'; weaknessesContainer.innerHTML = weaknesses.length ? weaknesses.map(w => `<span>${w.subject} <small>(${w.score})</small></span>`).join('ã€') : 'æ— æ˜æ˜¾åŠ£åŠ¿å­¦ç§‘';
        let suggestions = weaknesses.length ? `<p>å»ºè®®é‡ç‚¹å…³æ³¨ï¼š${weaknesses.map(w=>w.subject).join('ã€')}ï¼Œåˆ¶å®šé’ˆå¯¹æ€§å¤ä¹ è®¡åˆ’ã€‚</p>` : '<p>å„ç§‘å‘å±•å‡è¡¡ï¼Œè¯·ç»§ç»­ä¿æŒå½“å‰çš„è‰¯å¥½çŠ¶æ€ã€‚</p>'; suggestionsContainer.innerHTML = suggestions;
    }

    function getIndicatorContext() {
        let meta = null;
        try { meta = JSON.parse(localStorage.getItem('ARCHIVE_META') || 'null'); } catch(e) {}
        if (!meta) meta = getExamMetaFromUI();
        const grade = String(meta?.grade || computeCohortGrade(CURRENT_COHORT_META, meta) || '');
        const type = meta?.type || '';
        return { grade, type, meta };
    }

    function isIndicatorPromptAllowed() {
        const ctx = getIndicatorContext();
        return ctx.grade === '9';
    }

    function isIndicatorCalcAllowed() {
        const ctx = getIndicatorContext();
        return ctx.grade === '9' && (ctx.type === 'æœŸä¸­' || ctx.type === 'æœŸæœ«');
    }

    function updateIndicatorUIState() {
        const promptAllowed = isIndicatorPromptAllowed();
        const calcAllowed = isIndicatorCalcAllowed();
        const btn = document.getElementById('btn-indicator-calc');
        if (btn) btn.disabled = !promptAllowed;
        const paramsArea = document.getElementById('dm-params-area');
        if (paramsArea) paramsArea.style.display = promptAllowed ? 'block' : 'none';
        const i1 = document.getElementById('dm_ind1_input');
        const i2 = document.getElementById('dm_ind2_input');
        if (i1) i1.disabled = !promptAllowed;
        if (i2) i2.disabled = !promptAllowed;
        const tip = document.getElementById('dm-params-tip');
        if (tip) tip.style.display = calcAllowed ? 'none' : (promptAllowed ? 'block' : 'none');
    }

    function calcIndicators() {
        if (!isIndicatorPromptAllowed()) return;
        // 1. ä¼˜å…ˆè¯»å–å…¨å±€å˜é‡ SYS_VARS (è¿™æ˜¯æœ€å¯é çš„æ•°æ®æº)
        // å¦‚æœå…¨å±€å˜é‡æ˜¯ç©ºçš„ï¼Œå°è¯•è¯»å–ç®¡ç†é¢æ¿é‡Œçš„è¾“å…¥æ¡† (dm_ind...)
        let val1 = window.SYS_VARS?.indicator?.ind1;
        let val2 = window.SYS_VARS?.indicator?.ind2;

        if (!val1) val1 = document.getElementById('dm_ind1_input')?.value;
        if (!val2) val2 = document.getElementById('dm_ind2_input')?.value;

        const r1 = parseInt(val1);
        const r2 = parseInt(val2);
        
        // 2. æ£€æŸ¥ï¼šå¦‚æœå‚æ•°æœªè®¾ç½®ï¼Œè‡ªåŠ¨æ‰“å¼€ç®¡ç†é¢æ¿å¹¶è·³è½¬åˆ°ã€å¹´çº§æŒ‡æ ‡å‚æ•°ã€‘é¡µ
        if(!r1 || !r2) {
            if(confirm("âŒ æ£€æµ‹åˆ°ã€åˆ’çº¿åæ¬¡ã€‘å°šæœªè®¾ç½®ï¼\n\næ˜¯å¦ç«‹å³æ‰“å¼€ã€Œæ•™åŠ¡æ•°æ®ç»¼åˆæ§åˆ¶å°ã€è¿›è¡Œè®¾ç½®ï¼Ÿ")) {
                DataManager.open(); // æ‰“å¼€å¼¹çª—
                DataManager.switchTab('params'); // è‡ªåŠ¨åˆ‡æ¢åˆ°å‚æ•°è®¾ç½®Tab
            }
            return;
        }

        if (!isIndicatorCalcAllowed()) return;

        // 3. æ£€æŸ¥ï¼šå¦‚æœç›®æ ‡äººæ•°æœªå¯¼å…¥ï¼Œè‡ªåŠ¨æ‰“å¼€ç®¡ç†é¢æ¿å¹¶è·³è½¬åˆ°ã€ç›®æ ‡äººæ•°ç®¡ç†ã€‘é¡µ
        // window.TARGETS æ˜¯åœ¨ loadCloudData æˆ– DataManager ä¸­åŠ è½½çš„
        if(!window.TARGETS || Object.keys(window.TARGETS).length === 0) {
            if(confirm("âŒ æ£€æµ‹åˆ°ã€ç›®æ ‡äººæ•°ã€‘å°šæœªå¯¼å…¥ï¼\n\næ˜¯å¦ç«‹å³æ‰“å¼€ã€Œæ•™åŠ¡æ•°æ®ç»¼åˆæ§åˆ¶å°ã€è¿›è¡Œå¯¼å…¥ï¼Ÿ")) {
                DataManager.open(); // æ‰“å¼€å¼¹çª—
                DataManager.switchTab('targets'); // è‡ªåŠ¨åˆ‡æ¢åˆ°ç›®æ ‡ç®¡ç†Tab
            }
            return;
        }

        // 1. ç¡®å®šå…¨é•‡åˆ’çº¿åˆ†æ•°
        // 9å¹´çº§æ¨¡å¼ä¸‹ s.total å³ä¸ºäº”ç§‘æ€»åˆ†
        const allScores = RAW_DATA.map(s => s.total).sort((a,b)=>b-a); 
        const line1 = allScores[r1-1] || 0; 
        const line2 = allScores[r2-1] || 0;

        // 2. ç¬¬ä¸€è½®éå†ï¼šè®¡ç®—è¾¾æ ‡äººæ•°ã€åŸºç¡€åˆ†ã€è¶…é¢æ•°
        let calcData = [];
        let maxExcess1 = 0; // æŒ‡æ ‡ä¸€æœ€å¤§è¶…é¢æ•°
        let maxExcess2 = 0; // æŒ‡æ ‡äºŒæœ€å¤§è¶…é¢æ•°

        Object.values(SCHOOLS).forEach(s => {
            const scores = s.students.map(stu => stu.total);
            const reach1 = scores.filter(v => v >= line1).length; // å®é™…è¾¾æ ‡1
            const reach2 = scores.filter(v => v >= line2).length; // å®é™…è¾¾æ ‡2
            
            const t = window.TARGETS[s.name] || {t1: 10000, t2: 10000}; // é˜²æ­¢é™¤ä»¥0
            
            // --- æŒ‡æ ‡ä¸€è®¡ç®— ---
            // åŸºç¡€åˆ† (æ»¡åˆ†30)
            let base1 = 0;
            if (reach1 >= t.t1) base1 = 30;
            else base1 = (t.t1 > 0) ? (reach1 / t.t1 * 30) : 0;
            
            // è¶…é¢æ•°
            const excess1 = Math.max(0, reach1 - t.t1);
            if (excess1 > maxExcess1) maxExcess1 = excess1;

            // --- æŒ‡æ ‡äºŒè®¡ç®— ---
            // åŸºç¡€åˆ† (æ»¡åˆ†30)
            let base2 = 0;
            if (reach2 >= t.t2) base2 = 30;
            else base2 = (t.t2 > 0) ? (reach2 / t.t2 * 30) : 0;

            // è¶…é¢æ•°
            const excess2 = Math.max(0, reach2 - t.t2);
            if (excess2 > maxExcess2) maxExcess2 = excess2;

            calcData.push({
                name: s.name,
                t1: t.t1, r1: reach1, base1: base1, excess1: excess1,
                t2: t.t2, r2: reach2, base2: base2, excess2: excess2
            });
        });

        // 3. ç¬¬äºŒè½®éå†ï¼šè®¡ç®—é™„åŠ åˆ†ã€æ€»åˆ†å¹¶æ’åº
        calcData.forEach(d => {
            // é™„åŠ åˆ†å…¬å¼ï¼š(æŸæ ¡è¶…é¢ / æœ€å¤§è¶…é¢) * 5
            d.bonus1 = (maxExcess1 > 0) ? (d.excess1 / maxExcess1 * 5) : 0;
            d.score1 = d.base1 + d.bonus1;

            d.bonus2 = (maxExcess2 > 0) ? (d.excess2 / maxExcess2 * 5) : 0;
            d.score2 = d.base2 + d.bonus2;

            d.finalScore = d.score1 + d.score2;
            
            // åŒæ­¥åˆ°å…¨å±€å¯¹è±¡ä¾›ç»¼åˆæ’åä½¿ç”¨
            if(SCHOOLS[d.name]) SCHOOLS[d.name].scoreInd = d.finalScore;
        });

        // æ’åº
        calcData.sort((a,b) => b.finalScore - a.finalScore).forEach((d, i) => d.rank = i + 1);

        // 4. æ¸²æŸ“è¡¨æ ¼ (è¡¨å¤´å¢åŠ åŸºç¡€åˆ†/é™„åŠ åˆ†åˆ—)
        const thead = document.querySelector('#tb-indicator thead');
        thead.innerHTML = `
            <tr>
                <th rowspan="2">å­¦æ ¡</th>
                <th colspan="4" style="background:#e0f2fe; color:#0369a1;">æŒ‡æ ‡ä¸€ (å‚è€ƒåˆ†:${line1})</th>
                <th colspan="4" style="background:#fff7ed; color:#b45309;">æŒ‡æ ‡äºŒ (å‚è€ƒåˆ†:${line2})</th>
                <th rowspan="2">æŒ‡æ ‡æ€»åˆ†</th>
                <th rowspan="2">æ’å</th>
            </tr>
            <tr>
                <th>ç›®æ ‡/è¾¾æ ‡</th><th>åŸºç¡€åˆ†</th><th>é™„åŠ åˆ†</th><th>å°è®¡</th>
                <th>ç›®æ ‡/è¾¾æ ‡</th><th>åŸºç¡€åˆ†</th><th>é™„åŠ åˆ†</th><th>å°è®¡</th>
            </tr>
        `;

        let html = ''; 
        calcData.forEach(d => { 
            const isMySchool = d.name === MY_SCHOOL; 
            html += `
            <tr class="${isMySchool?'bg-highlight':''}">
                <td style="font-weight:bold;">${d.name}</td>
                
                <!-- æŒ‡æ ‡ä¸€ -->
                <td>
                    <!-- ğŸ‘‡ æ–°å¢ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ç›®æ ‡äººæ•°ï¼Œåˆ†æå¦‚ä½•è¾¾æ ‡ -->
                    <span class="clickable-num" style="color:#d97706; border-bottom:1px dashed #d97706;" 
                          onclick="analyzeTargetGap('${d.name}', 'ind1', ${line1})" 
                          title="ç‚¹å‡»åˆ†æï¼šå“ªäº›å­¦ç”Ÿå·®ä¸€ç‚¹å°±è¾¾æ ‡ï¼Ÿè¡¥å“ªç§‘ï¼Ÿ">
                        ${d.t1}
                    </span> / 
                    <strong class="clickable-num" onclick="handleIndicatorClick('${d.name}', 'ind1')">${d.r1}</strong>
                </td>
                <td>${d.base1.toFixed(2)}</td>
                <td style="color:${d.bonus1>0?'green':'#ccc'}; font-weight:bold;">${d.bonus1>0?'+':''}${d.bonus1.toFixed(2)}</td>
                <td style="background:#f0f9ff; font-weight:bold;">${d.score1.toFixed(2)}</td>
                
                <!-- æŒ‡æ ‡äºŒ -->
                <td>
                    
                    <span class="clickable-num" style="color:#d97706; border-bottom:1px dashed #d97706;" 
                          onclick="analyzeTargetGap('${d.name}', 'ind2', ${line2})" 
                          title="ç‚¹å‡»åˆ†æï¼šå“ªäº›å­¦ç”Ÿå·®ä¸€ç‚¹å°±è¾¾æ ‡ï¼Ÿè¡¥å“ªç§‘ï¼Ÿ">
                        ${d.t2}
                    </span> / 
                    <strong class="clickable-num" onclick="handleIndicatorClick('${d.name}', 'ind2')">${d.r2}</strong>
                </td>
                <td>${d.base2.toFixed(2)}</td>
                <td style="color:${d.bonus2>0?'green':'#ccc'}; font-weight:bold;">${d.bonus2>0?'+':''}${d.bonus2.toFixed(2)}</td>
                <td style="background:#fffaf0; font-weight:bold;">${d.score2.toFixed(2)}</td>
                
                <!-- æ€»åˆ† -->
                <td class="text-red" style="font-size:1.1em; font-weight:bold;">${d.finalScore.toFixed(2)}</td>
                ${getRankHTML(d.rank)}
            </tr>`; 
        });
        document.querySelector('#tb-indicator tbody').innerHTML = html;
        
        UI.toast("âœ… æŒ‡æ ‡ç”Ÿæ ¸ç®—å®Œæˆ (å«é™„åŠ åˆ†)", "success");
    }

    function analyzeTargetGap(schoolName, type, lineScore) {
        if (!SCHOOLS[schoolName]) return;
        const schoolData = SCHOOLS[schoolName];
        
        // 1. è·å–è¯¥æ ¡çš„ç›®æ ‡äººæ•°è®¾å®š
        // æ³¨æ„ï¼šTARGETS æ˜¯å…¨å±€å˜é‡ï¼Œå­˜å‚¨äº†å¯¼å…¥çš„ç›®æ ‡é…ç½®
        const targetConfig = TARGETS[schoolName] || { t1: 0, t2: 0 };
        const targetCount = type === 'ind1' ? parseInt(targetConfig.t1) : parseInt(targetConfig.t2);
        
        if (!targetCount) return alert(`æœªæ‰¾åˆ° ${schoolName} çš„ç›®æ ‡è®¾å®šï¼Œè¯·å…ˆå¯¼å…¥ç›®æ ‡äººæ•°Excelã€‚`);

        // 2. å°†å­¦ç”Ÿåˆ†ä¸ºâ€œå·²è¾¾æ ‡â€å’Œâ€œæœªè¾¾æ ‡â€ä¸¤ç»„
        // æŒ‰æ€»åˆ†é™åºæ’åˆ—ï¼Œä¿è¯æœªè¾¾æ ‡ç»„çš„ç¬¬ä¸€ä¸ªå°±æ˜¯ç¦»çº¿æœ€è¿‘çš„
        const allStudents = [...schoolData.students].sort((a,b) => b.total - a.total);
        const reached = allStudents.filter(s => s.total >= lineScore);
        const below = allStudents.filter(s => s.total < lineScore);

        // 3. è®¡ç®—éœ€è¦æŠ“å–çš„äººæ•° (ç­–ç•¥ï¼šè¡¥é½ç¼ºå£ + é€‚å½“å¯Œä½™ä»¥ä¾¿åŸ¹ä¼˜)
        const currentCount = reached.length;
        const gap = targetCount - currentCount; // ç¼ºå£äººæ•°
        
        // è®¾ç½®â€œç¼“å†²é‡â€ï¼šæ¯”å¦‚ä¸ºäº†ä¿é™©èµ·è§ï¼Œå¤šæŠ“å–ç›®æ ‡æ•°çš„ 10% æˆ–è‡³å°‘ 5 äºº
        const buffer = Math.ceil(targetCount * 0.1) || 5; 
        
        let countToFetch = 0;
        let strategyText = "";

        if (gap > 0) {
            // æƒ…å†µA: å°šæœªè¾¾æ ‡ -> æŠ“å– (ç¼ºå£ + ç¼“å†²) äºº
            countToFetch = gap + buffer;
            strategyText = `å½“å‰å·® <strong style="color:red">${gap}</strong> äººè¾¾æ ‡ã€‚å·²ä¸ºæ‚¨ç­›é€‰æœ€æ¥è¿‘ç›®æ ‡çš„ <strong>${countToFetch}</strong> åæ½œåŠ›ç”Ÿï¼ˆå« ${buffer} åä¿é™©å¤‡ä»½ï¼‰ã€‚`;
        } else {
            // æƒ…å†µB: å·²ç»è¾¾æ ‡ -> ä¾ç„¶æ¨è (ç¼“å†²) äººï¼Œç”¨äºå·©å›ºé˜²å®ˆ
            countToFetch = buffer;
            strategyText = `å½“å‰å·²è¾¾æ ‡ (è¶… ${Math.abs(gap)} äºº)ã€‚å»ºè®®ç»§ç»­å…³æ³¨çº¿ä¸‹å‰ <strong>${countToFetch}</strong> åå­¦ç”Ÿï¼Œé˜²æ­¢ä¸Šçº¿ç”Ÿæ³¢åŠ¨ä¸‹æ»‘ã€‚`;
        }

        // 4. æˆªå–åå•
        let candidates = below.slice(0, countToFetch);

        if (candidates.length === 0) {
            return alert("çº¿ä¸‹æ²¡æœ‰æ›´å¤šå­¦ç”Ÿå¯ä¾›æŒ–æ˜äº†ã€‚");
        }

        // 5. è®¡ç®—å…¨é•‡å„ç§‘å‡åˆ† (ä½œä¸ºè¯Šæ–­å¼±ç§‘çš„åŸºå‡†)
        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            gradeStats[sub] = allScores.reduce((a,b)=>a+b,0) / (allScores.length||1);
        });

        // 6. æ·±åº¦åˆ†ææ¯ä¸€ä½å€™é€‰äºº (è®¡ç®—å·®è· + æ‰¾å¼±ç§‘)
        candidates = candidates.map(s => {
            // A. è®¡ç®—å·®è·
            const scoreGap = lineScore - s.total;
            
           // 1. ç¡®å®šè®¡åˆ†ç§‘ç›®èŒƒå›´ (é¿å…æ”¿æ²»ç­‰ä¸è®¡å…¥æ€»åˆ†çš„ç§‘ç›®è¢«é”™è¯¯æ¨è)
            // é€»è¾‘ï¼šå¦‚æœæ˜¯9å¹´çº§æ¨¡å¼ï¼ŒCONFIG.totalSubs åªæœ‰[è¯­,æ•°,è‹±,ç‰©,åŒ–]
            let validSubjects = SUBJECTS;
            if (CONFIG && Array.isArray(CONFIG.totalSubs)) {
                validSubjects = CONFIG.totalSubs;
            }

            // 2. è¾…åŠ©å‡½æ•°ï¼šè·å–å¸¦è€å¸ˆå§“åçš„å­¦ç§‘å (ä¾‹å¦‚: "ç‰©ç†(å¼ å¸ˆ)")
            const getSubWithTeacher = (sub) => {
                // é”®åæ ¼å¼å‚è€ƒ generateTeacherInputs å‡½æ•°: "ç­çº§_å­¦ç§‘"
                const teacherKey = `${s.class}_${sub}`;
                let teacher = TEACHER_MAP[teacherKey];
                if (teacher) {
                    // åªå–å§“æ°ä»¥èŠ‚çœç©ºé—´ï¼Œå¦‚ "å¼ è€å¸ˆ" -> "å¼ "
                    const surname = teacher.charAt(0); 
                    return `${sub}<small style="color:#666; font-size:0.9em;">(${surname}å¸ˆ)</small>`;
                }
                return sub;
            };

            // 3. éå†è®¡ç®—æ‰€æœ‰æœ‰æ•ˆç§‘ç›®çš„åˆ†å·®
            let allDiffs = [];  // å­˜å‚¨æ‰€æœ‰ç§‘ç›®å·®å€¼ (ç”¨äºæŒ–æ˜æ½œåŠ›)
            let hardWeakness = []; // å­˜å‚¨æ˜æ˜¾å¼±é¡¹ (ä½äºå‡åˆ†5åˆ†)

            validSubjects.forEach(sub => {
                if (s.scores[sub] !== undefined) {
                    // æ ¸å¿ƒç®—æ³•ï¼šå­¦ç”Ÿåˆ†æ•° - å¹´çº§å‡åˆ† (æ­£æ•°=ä¼˜åŠ¿ï¼Œè´Ÿæ•°=åŠ£åŠ¿)
                    const diff = s.scores[sub] - gradeStats[sub]; 
                    const item = { name: sub, diff: diff };
                    
                    allDiffs.push(item);
                    
                    // é˜ˆå€¼åˆ¤å®šï¼šä½äºå‡åˆ† 5 åˆ†ç®—â€œç¡¬ä¼¤â€ï¼Œéœ€è¦ä¼˜å…ˆè¡¥æ•‘
                    if (diff < -5) {
                        hardWeakness.push(item);
                    }
                }
            });

            // æŒ‰å·®å€¼å‡åºæ’åº (æ•°å€¼è¶Šå°/è¶Šè´Ÿï¼Œæ’åœ¨è¶Šå‰é¢ï¼Œä»£è¡¨è¶Šéœ€è¦è¡¥)
            allDiffs.sort((a, b) => a.diff - b.diff);
            hardWeakness.sort((a, b) => a.diff - b.diff);

            let worstSubName = "";
            let worstSubDiff = "";

            // 4. å†³ç­–é€»è¾‘ï¼šæ˜¯è¡¥çŸ­æ¿ï¼Œè¿˜æ˜¯æŒ–æ½œåŠ›ï¼Ÿ
            if (hardWeakness.length > 0) {
                // ğŸ›‘ æƒ…å†µAï¼šæœ‰æ˜æ˜¾å¼±ç§‘ (æœ‰ç§‘ç›®ä½äºå‡åˆ†5åˆ†) -> æ˜¾ç¤ºæœ€å·®çš„ 2 ç§‘
                const targets = hardWeakness.slice(0, 2);
                
                worstSubName = targets.map(t => getSubWithTeacher(t.name)).join("ã€");
                worstSubDiff = targets.map(t => t.diff.toFixed(1)).join(" / ");
            } else {
                // ğŸ’¡ æƒ…å†µBï¼šæ— æ˜æ˜¾å¼±ç§‘ (å„ç§‘éƒ½è¿˜è¡Œï¼Œä½†æ€»åˆ†æœªè¾¾æ ‡) -> å¼ºåˆ¶æŒ–æ˜ç›¸å¯¹æœ€å¼±çš„ 2 ç§‘ä½œä¸ºæ½œåŠ›ç‚¹
                const targets = allDiffs.slice(0, 2);
                
                if (targets.length > 0) {
                    // åŠ ä¸ª "æ½œåŠ›:" å‰ç¼€æç¤ºç­ä¸»ä»»è¿™æ˜¯ç›¸å¯¹å¼±é¡¹ï¼Œä¸æ˜¯ç»å¯¹å·®
                    worstSubName = "<span style='font-size:10px; color:#666; border:1px solid #ccc; padding:0 2px; border-radius:2px; margin-right:2px;'>æ½œåŠ›</span>" + 
                                   targets.map(t => getSubWithTeacher(t.name)).join("ã€");
                    
                    // æ˜¾ç¤ºåˆ†å·® (æ­£æ•°åŠ +å·ï¼Œæç¤ºè€å¸ˆå…¶å®è¿™ç§‘å¯èƒ½å·²ç»é«˜äºå‡åˆ†äº†ï¼Œåªæ˜¯åœ¨ä¸ªäººç»´åº¦é‡Œç®—çŸ­æ¿)
                    worstSubDiff = targets.map(t => (t.diff > 0 ? '+' : '') + t.diff.toFixed(1)).join(" / ");
                } else {
                    worstSubName = "æ•°æ®ä¸è¶³";
                    worstSubDiff = "-";
                }
            }

            return {
                name: s.name,
                class: s.class,
                total: s.total,
                scoreGap: scoreGap, // è·ç¦»ç›®æ ‡çš„æ€»åˆ†å·®è·
                worstSub: worstSubName, // å»ºè®®å­¦ç§‘ (å·²å¸¦è€å¸ˆå)
                worstDiff: worstSubDiff // ä¸å¹´çº§å‡åˆ†å·®
            };
        });

        // 7. æ„å»ºå¼¹çª—å†…å®¹
        const typeName = type === 'ind1' ? 'æŒ‡æ ‡ä¸€' : 'æŒ‡æ ‡äºŒ';
        const title = `${schoolName} - ${typeName} å†²åˆºåå• (ç›®æ ‡:${targetCount}äºº)`;
        
        let html = `
            <div class="info-bar">
                <div>ğŸ¯ <strong>åˆ’çº¿åˆ†æ•°ï¼š${lineScore} åˆ†</strong></div>
                <div style="margin-top:4px;">ğŸ“Š ç°çŠ¶ï¼šå·²è¾¾æ ‡ ${currentCount} äºº / ç›®æ ‡ ${targetCount} äººã€‚</div>
                <div style="margin-top:4px; color:#0369a1;">ğŸ’¡ ç­–ç•¥ï¼š${strategyText}</div>
            </div>
            <div class="table-wrap">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>ç­çº§</th>
                            <th>å§“å</th>
                            <th>å½“å‰æ€»åˆ†</th>
                            <th>è·åˆ’çº¿å·®</th>
                            <th style="background:#fee2e2; color:#b91c1c;">ğŸ†˜ å»ºè®®è¡¥æ•‘å­¦ç§‘</th>
                            <th>ä¸å¹´çº§å‡åˆ†å·®</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        candidates.forEach(c => {
            // æ ·å¼é€»è¾‘
            const isBalanced = c.worstSub.includes("æ½œåŠ›"); // åŒ¹é…"æ½œåŠ›"å…³é”®å­—
            const subStyle = isBalanced ? "color:#64748b; font-size:12px;" : "color:#b91c1c; font-weight:bold;";
            const diffStyle = isBalanced ? "color:#64748b;" : "color:#b91c1c; font-weight:bold;";
            
            // ğŸŸ¢ è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯” (ç”¨äºç”»è¿›åº¦æ¡)
            // æ¯”å¦‚ ç›®æ ‡490ï¼Œè€ƒäº†485 -> è¿›åº¦ 98.9%
            const percent = Math.min(100, (c.total / lineScore) * 100).toFixed(1);
            
            // ğŸŸ¢ è¿›åº¦æ¡é¢œè‰²ï¼šè¶Šæ¥è¿‘ç›®æ ‡è¶Šçº¢(è­¦ç¤º/å†²åˆº)ï¼Œæˆ–è€…ç”¨ç»¿è‰²è¡¨ç¤ºå¥åº·åº¦ï¼Ÿ
            // è¿™é‡Œç”¨é»„è‰²åˆ°ç»¿è‰²çš„æ¸å˜æ¦‚å¿µï¼š>98% ç”¨æ©™è‰²(åªå·®ä¸€å£æ°”)ï¼Œ<95% ç”¨è“è‰²
            const barColor = percent >= 98 ? '#f59e0b' : '#3b82f6';

            html += `
                <tr>
                    <td style="vertical-align:middle;">${c.class}</td>
                    <td style="vertical-align:middle;">
                        <div style="font-weight:bold; font-size:14px;">${c.name}</div>
                    </td>
                    
                    <!-- ğŸŸ¢ æ”¹é€ ï¼šå½“å‰æ€»åˆ† + å¯è§†åŒ–è¿›åº¦æ¡ -->
                    <td style="vertical-align:middle;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end; font-size:12px; margin-bottom:2px;">
                            <span style="font-weight:800; font-size:15px; color:#333;">${c.total}</span>
                            <span style="color:#94a3b8; transform:scale(0.9);">ç›®æ ‡:${lineScore}</span>
                        </div>
                        <div style="width:100%; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;" title="è¾¾æˆç‡: ${percent}%">
                            <div style="width:${percent}%; height:100%; background:${barColor}; border-radius:3px;"></div>
                        </div>
                    </td>

                    <td style="vertical-align:middle;">
                        <span class="badge" style="background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe; font-size:12px;">
                            -${c.scoreGap.toFixed(1)}
                        </span>
                    </td>
                    
                    <td style="vertical-align:middle; ${subStyle}">
                        ${c.worstSub}
                    </td>
                    
                    <td style="vertical-align:middle; ${diffStyle}">
                        ${c.worstDiff}
                    </td>
                </tr>
            `;
        });

        html += `</tbody></table></div>`;

        // 8. è°ƒç”¨é€šç”¨å¼¹çª—æ˜¾ç¤º
        document.getElementById('drill-title').innerText = title;
        document.getElementById('drill-back-btn').classList.add('hidden');
        document.getElementById('drill-content').innerHTML = html;
        
        // åº•éƒ¨ç»Ÿè®¡ï¼šæŒ‰ç­çº§æ±‡æ€»æ½œåŠ›ç”Ÿäººæ•°ï¼Œæ–¹ä¾¿ä¸»ä»»å¹³è¡¡å„ç­æŒ‡æ ‡
        // ç®€å•çš„ reduce ç»Ÿè®¡
        const classCount = {};
        candidates.forEach(c => { classCount[c.class] = (classCount[c.class] || 0) + 1; });
        const classSummary = Object.entries(classCount)
            .map(([cls, cnt]) => `${cls}ç­:${cnt}äºº`)
            .join('ï¼Œ ');

        document.getElementById('drill-footer').innerText = `å„ç­æ½œåŠ›ç”Ÿåˆ†å¸ƒï¼š${classSummary} (è¯·å¹³è¡¡å„ç­æŒ‡æ ‡å‹åŠ›)`;
        
        // ğŸŸ¢ å…³é”®ï¼šå°†è®¡ç®—å¥½çš„ candidates æ•°ç»„ä¼ ç»™ DrillSystemï¼Œå¹¶æ ‡è®°ç±»å‹ä¸º 'gap'
        DrillSystem.exportData = {
            type: 'gap',
            fileName: title, // ä½¿ç”¨å¼¹çª—æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
            data: candidates
        };
        
        // ğŸŸ¢ ç¡®ä¿å¯¼å‡ºæŒ‰é’®æ˜¾ç¤º
        const exportBtn = document.getElementById('drill-export-btn');
        if(exportBtn) exportBtn.classList.remove('hidden');

        document.getElementById('drill-modal').style.display = 'flex';
    }

   function calcSummary(isSilent = false) {
        const isGrade9 = CONFIG.name && CONFIG.name.includes('9');
        
        // 1. æ±‡æ€»å„é¡¹å¾—åˆ† (Object.values(SCHOOLS) åŒ…å«æ‰€æœ‰å­¦æ ¡)
        const list = Object.values(SCHOOLS).map(s => {
            const s1 = s.score2Rate || 0;  // ä¸¤ç‡ä¸€åˆ†
            const s2 = s.scoreBottom || 0; // å1/3
            const s3 = s.scoreInd || 0;    // æŒ‡æ ‡ç”Ÿ
            
            let s4 = 0; // é«˜åˆ†æ®µèµ‹åˆ†
            if (isGrade9 && s.highScoreStats) {
                s4 = s.highScoreStats.score || 0;
            }

            const total = s1 + s2 + s3 + s4;
            return { name: s.name, s1, s2, s3, s4, total };
        });

        // 2. æ’åº (æŒ‰ç»¼åˆæ€»åˆ†é™åº)
        list.sort((a,b) => b.total - a.total).forEach((d,i) => d.rank = i+1);

        // 3. åŠ¨æ€ç”Ÿæˆè¡¨å¤´
        const thead = document.querySelector('#tb-summary thead');
        let theadHtml = `<tr><th>å­¦æ ¡åç§°</th><th>ä¸¤ç‡ä¸€åˆ†å¾—åˆ†</th><th>å1/3å¾—åˆ†</th><th>æŒ‡æ ‡ç”Ÿå¾—åˆ†</th>`;
        if (isGrade9) theadHtml += `<th style="color:#b45309; background:#fff7ed;">é«˜åˆ†æ®µèµ‹åˆ†(70)</th>`;
        theadHtml += `<th>ç»¼åˆæ€»åˆ†</th><th>æ€»æ’å</th></tr>`;
        thead.innerHTML = theadHtml;

        // 4. ç”Ÿæˆè¡¨æ ¼å†…å®¹ (éå†æ‰€æœ‰ï¼Œæ— æˆªæ–­)
        let html = ''; 
        list.forEach(d => { 
            const isMySchool = d.name === MY_SCHOOL; 
            let highScoreCell = '';
            if (isGrade9) highScoreCell = `<td style="color:#b45309; background:#fff7ed; font-weight:bold;">${d.s4.toFixed(2)}</td>`;

            html += `<tr class="${isMySchool?'bg-highlight':''}">
                <td>${d.name}</td>
                <td>${d.s1.toFixed(2)}</td>
                <td>${d.s2.toFixed(2)}</td>
                <td>${d.s3.toFixed(2)}</td>
                ${highScoreCell}
                <td class="text-red" style="font-size:16px; font-weight:bold;">${d.total.toFixed(2)}</td>
                ${getRankHTML(d.rank)}
            </tr>`;
        });
        document.querySelector('#tb-summary tbody').innerHTML = html;
               
        console.log(`ç»¼åˆæ’åå·²ç”Ÿæˆï¼Œå…± ${list.length} æ‰€å­¦æ ¡`);
    }

    async function exportPPTReport() {
        // --- 0. åŸºç¡€æ•°æ®æ ¡éªŒ ---
        if (Object.keys(SCHOOLS).length === 0) { 
            alert("æš‚æ— æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆæ±‡æŠ¥ã€‚"); 
            return; 
        }
        var checkSchool = Object.values(SCHOOLS)[0];
        if (!checkSchool.score2Rate) { 
            alert("è¯·å…ˆç‚¹å‡»ã€ç”Ÿæˆæ€»æ’åã€‘æŒ‰é’®ï¼Œè®¡ç®—å®Œå„é¡¹æŒ‡æ ‡åå†å¯¼å‡ºã€‚"); 
            return; 
        }

        // --- 1. PPT åˆå§‹åŒ– ---
        var pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9'; 
        pptx.title = CONFIG.name + " è´¨é‡åˆ†ææ±‡æŠ¥";
        
        // é¢œè‰²å®šä¹‰
        var colorMain = "1E3A8A";    // æ·±è“
        var colorSub = "3B82F6";     // äº®è“
        var colorAccent = "D97706";  // é‡‘è‰²
        var colorBg = "F8FAFC";      // æµ…ç°èƒŒæ™¯
        var colorDanger = "DC2626";  // çº¢è‰²
        var colorSuccess = "166534"; // ç»¿è‰²

        // --- 2. æ¯ç‰ˆå®šä¹‰ ---
        pptx.defineSlideMaster({
            title: 'EXEC_REPORT',
            background: { color: colorBg },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.6, fill: colorMain } },
                { text: { text: CONFIG.name + " æ•™å­¦è´¨é‡ç›‘æµ‹", x: 0.3, y: 0.15, w: 5, h: 0.3, fontSize: 14, color: "FFFFFF", bold: true } },
                { line: { x: 0.5, y: 6.8, w: 9.0, h: 0, line: { color: "CBD5E1", width: 1 } } },
                { text: { text: "å†…éƒ¨æ•™ç ”æ•°æ® Â· è¯·å‹¿å¤–ä¼ ", x: 0.5, y: 6.9, w: 4, h: 0.3, fontSize: 9, color: "94A3B8" } }
            ],
            slideNumber: { x: 9.5, y: 6.9, fontSize: 9, color: "94A3B8" } // å³ä¸‹è§’é¡µç 
        });

        // è¾…åŠ©å‡½æ•°ï¼šå°†é•¿è¡¨æ ¼æ•°æ®åˆ†é¡µ
        // rows: è¡¨æ ¼æ•°æ®æ•°ç»„ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
        // maxRowsPerPage: æ¯é¡µæœ€å¤§è¡Œæ•°ï¼ˆå«è¡¨å¤´ï¼‰
        function splitTableToSlides(rows, maxRowsPerPage, titleText) {
            var header = rows[0];
            var dataRows = rows.slice(1);
            var chunks = [];
            // ç¬¬ä¸€é¡µèƒ½æ”¾ maxRowsPerPage - 1 è¡Œæ•°æ®
            var i = 0;
            while (i < dataRows.length) {
                chunks.push(dataRows.slice(i, i + maxRowsPerPage - 1));
                i += (maxRowsPerPage - 1);
            }
            
            chunks.forEach(function(chunk, index) {
                var slide = pptx.addSlide({ masterName: 'EXEC_REPORT' });
                var pageTitle = titleText + (chunks.length > 1 ? " (" + (index + 1) + "/" + chunks.length + ")" : "");
                slide.addText(pageTitle, { x: 0.5, y: 0.8, fontSize: 18, bold: true, color: colorMain });
                
                // ç»„åˆè¡¨å¤´å’Œå½“å‰é¡µæ•°æ®
                var currentTable = [header].concat(chunk);
                // æ¸²æŸ“è¡¨æ ¼
                slide.addTable(currentTable, { 
                    x: 0.5, y: 1.3, w: 9.0, // å®½åº¦è°ƒæ•´é€‚åº” 16:9
                    fontSize: 9, rowH: 0.35, // å­—ä½“ç¼©å°ï¼Œè¡Œé«˜ç¼©å°
                    border: { color: "E2E8F0", pt:0, pb:0 },
                    autoPage: false // æ‰‹åŠ¨åˆ†é¡µ
                });
            });
        }

        // --- 3. å°é¢é¡µ ---
        var slide1 = pptx.addSlide();
        slide1.background = { color: "FFFFFF" };
        slide1.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: "100%", h: 2.5, fill: colorMain });
        slide1.addText("æ•™å­¦è´¨é‡åˆ†ææ±‡æŠ¥", { x: 0.5, y: 1.2, w: "90%", h: 1, fontSize: 44, bold: true, color: "FFFFFF", fontFace: "é»‘ä½“" });
        slide1.addText(CONFIG.name + " Â· " + new Date().getFullYear() + "å¹´", { x: 0.5, y: 0.8, fontSize: 18, color: "93C5FD" });
        
        slide1.addText("æ±‡æŠ¥æ¦‚è¦", { x: 0.5, y: 3.5, fontSize: 14, color: colorMain, bold: true });
        slide1.addShape(pptx.ShapeType.line, { x: 0.5, y: 3.8, w: 0.5, h: 0, line: {color: colorAccent, width: 2} });
        var summaryText = "æœ¬æ¬¡è€ƒè¯•å…±è¦†ç›– " + Object.keys(SCHOOLS).length + " æ‰€å­¦æ ¡ï¼Œå‚è€ƒå­¦ç”Ÿ " + RAW_DATA.length + " äººã€‚\n" +
                          "åˆ†æç»´åº¦åŒ…å«ï¼šä¸¤ç‡ä¸€åˆ†ã€å1/3è½¬åŒ–ã€æŒ‡æ ‡ç”Ÿå®Œæˆåº¦åŠå­¦ç§‘å‡è¡¡æ€§è¯Šæ–­ã€‚";
        slide1.addText(summaryText, { x: 0.5, y: 4.0, w: 8, h: 1.5, fontSize: 12, color: "64748B", lineSpacing: 18 });

        // --- 4. é¢†å¯¼çœ‹æ¿é¡µ ---
        var slide2 = pptx.addSlide({ masterName: 'EXEC_REPORT' });
        slide2.addText("æ ¸å¿ƒæŒ‡æ ‡çœ‹æ¿", { x: 0.5, y: 0.8, fontSize: 20, bold: true, color: colorMain });
        
        var allScores = RAW_DATA.map(function(s) { return s.total; });
        var totalSum = allScores.reduce(function(a, b) { return a + b; }, 0);
        var townAvg = totalSum / allScores.length;
        var townMax = Math.max.apply(null, allScores);
        var sortedSchools = Object.values(SCHOOLS).sort(function(a, b) { return (a.rank2Rate || 999) - (b.rank2Rate || 999); });
        var topSchool = sortedSchools[0];

        // è°ƒæ•´å¡ç‰‡å¸ƒå±€ä»¥é€‚åº”æ›´å¤šå­¦æ ¡ï¼ˆç¨å¾®ç´§å‡‘ä¸€ç‚¹ï¼‰
        // å¡ç‰‡1: äººæ•°
        slide2.addShape(pptx.ShapeType.roundRect, { x: 0.5, y: 1.5, w: 2.0, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(RAW_DATA.length, { x: 0.5, y: 1.7, w: 2.0, h: 0.6, fontSize: 24, bold: true, color: colorMain, align: 'center' });
        slide2.addText("å‚è€ƒäººæ•°", { x: 0.5, y: 2.3, w: 2.0, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // å¡ç‰‡2: å­¦æ ¡æ•°
        slide2.addShape(pptx.ShapeType.roundRect, { x: 2.8, y: 1.5, w: 2.0, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(Object.keys(SCHOOLS).length, { x: 2.8, y: 1.7, w: 2.0, h: 0.6, fontSize: 24, bold: true, color: colorSub, align: 'center' });
        slide2.addText("å­¦æ ¡æ€»æ•°", { x: 2.8, y: 2.3, w: 2.0, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // å¡ç‰‡3: å‡åˆ†
        slide2.addShape(pptx.ShapeType.roundRect, { x: 5.1, y: 1.5, w: 2.0, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(townAvg.toFixed(1), { x: 5.1, y: 1.7, w: 2.0, h: 0.6, fontSize: 24, bold: true, color: colorSub, align: 'center' });
        slide2.addText("å…¨é•‡å‡åˆ†", { x: 5.1, y: 2.3, w: 2.0, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // å¡ç‰‡4: æ¦œé¦– (ç¨å¾®åŠ å®½)
        slide2.addShape(pptx.ShapeType.roundRect, { x: 7.4, y: 1.5, w: 2.2, h: 1.5, fill: "FFFFFF", line: {color: "E2E8F0"}, rectRadius: 0.1 });
        slide2.addText(topSchool.name.substring(0,6), { x: 7.4, y: 1.7, w: 2.2, h: 0.6, fontSize: 18, bold: true, color: colorAccent, align: 'center' });
        slide2.addText("ç»¼åˆNO.1", { x: 7.4, y: 2.3, w: 2.2, h: 0.3, fontSize: 10, color: "64748B", align: 'center' });

        // å›¾è¡¨ï¼šæ”¹ä¸ºæ˜¾ç¤ºæ‰€æœ‰å­¦æ ¡
        slide2.addText("ğŸ† ç»¼åˆè€ƒæ ¸å¾—åˆ†æ’å", { x: 0.5, y: 3.5, fontSize: 14, bold: true, color: "1E293B" });
        
        // ç§»é™¤ slice(0,10)ï¼Œæ˜¾ç¤ºæ‰€æœ‰å­¦æ ¡
        var chartSchools = sortedSchools; 
        
        var chartLabels = chartSchools.map(function(s) { return s.name; });
        var chartValues = chartSchools.map(function(s) { return ((s.score2Rate||0) + (s.scoreBottom||0) + (s.scoreInd||0) + ((s.highScoreStats?s.highScoreStats.score:0)||0)).toFixed(1); });

        slide2.addChart(pptx.ChartType.bar, [{
            name: "è€ƒæ ¸æ€»åˆ†", labels: chartLabels, values: chartValues
        }], {
            x: 0.5, y: 4.0, w: 9.0, h: 3.0, 
            barDir: 'col', chartColors: [colorMain], barGapWidthPct: 40,
            dataLabelPosition: "outEnd", showValue: true, showLegend: false,
            valAxisHidden: true, gridLineNone: true,
            // åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°ï¼šå­¦æ ¡è¶Šå¤šå­—ä½“è¶Šå°ï¼Œé˜²æ­¢é‡å 
            catAxisLabelFontSize: chartSchools.length > 15 ? 7 : 9 
        });

        // --- 5. ç¬¬ä¸‰é¡µï¼šç»¼åˆæ€»è¡¨ (è‡ªåŠ¨åˆ†é¡µ) ---
        var headers = [
            { text: "æ’å", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 0.6 } },
            { text: "å­¦æ ¡", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'left', w: 1.8 } },
            { text: "äººæ•°", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 0.8 } },
            { text: "ä¸¤ç‡ä¸€åˆ†", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } },
            { text: "å1/3å¾—åˆ†", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } },
            { text: "æŒ‡æ ‡ç”Ÿå¾—åˆ†", options: { fill: colorMain, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } },
            { text: "ç»¼åˆæ€»åˆ†", options: { fill: colorAccent, color: "FFFFFF", bold: true, align: 'center', w: 1.2 } }
        ];

        var tableRows = [headers];
        sortedSchools.forEach(function(s, i) {
            var isTop3 = i < 3;
            var bgColor = (i % 2 === 0) ? "FFFFFF" : "F1F5F9";
            var boldOpts = isTop3 ? { bold: true, color: colorDanger } : { color: "1E293B" };
            var totalScore = (s.score2Rate||0) + (s.scoreBottom||0) + (s.scoreInd||0);

            tableRows.push([
                { text: i + 1, options: { fill: bgColor, align: 'center', bold: boldOpts.bold, color: boldOpts.color } },
                { text: s.name, options: { fill: bgColor, align: 'left', bold: boldOpts.bold, color: boldOpts.color } },
                { text: s.metrics.total ? s.metrics.total.count : 0, options: { fill: bgColor, align: 'center', color: "64748B" } },
                { text: (s.score2Rate || 0).toFixed(1), options: { fill: bgColor, align: 'center' } },
                { text: (s.scoreBottom || 0).toFixed(1), options: { fill: bgColor, align: 'center' } },
                { text: (s.scoreInd || 0).toFixed(1), options: { fill: bgColor, align: 'center' } },
                { text: totalScore.toFixed(2), options: { fill: bgColor, align: 'center', bold: true, color: colorMain } }
            ]);
        });
        
        // è°ƒç”¨åˆ†é¡µå‡½æ•°ï¼šæ¯é¡µæœ€å¤š 12 è¡Œ (å«è¡¨å¤´)
        splitTableToSlides(tableRows, 12, "ç»¼åˆè€ƒæ ¸æ€»è¡¨");

        // --- 6. å¾ªç¯ç”Ÿæˆå­¦ç§‘é¡µ (åˆ†é¡µè¡¨æ ¼ + åˆ†é¡µå›¾è¡¨) ---
        SUBJECTS.forEach(function(sub) {
            // è·å–è¯¥å­¦ç§‘æ•°æ®å¹¶æ’åº
            var subData = Object.values(SCHOOLS).filter(function(s) { return s.metrics[sub] !== undefined; })
                .sort(function(a, b) { return b.metrics[sub].avg - a.metrics[sub].avg; });

            if(subData.length === 0) return;

            // 6.1 ç”Ÿæˆå­¦ç§‘è¡¨æ ¼é¡µ (å¯èƒ½æœ‰å¤šé¡µ)
            var subHeaders = [
                { text: "æ’å", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 0.6 } },
                { text: "å­¦æ ¡", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'left', w: 1.8 } },
                { text: "å‡åˆ†", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 1.0 } },
                { text: "ä¼˜ç§€ç‡", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 1.0 } },
                { text: "åŠæ ¼ç‡", options: { fill: "DBEAFE", color: colorMain, bold: true, align: 'center', w: 1.0 } }
            ];
            
            var subRows = [subHeaders];
            subData.forEach(function(s, i) {
                var m = s.metrics[sub];
                subRows.push([
                    i + 1, 
                    s.name, 
                    m.avg.toFixed(1), 
                    (m.excRate * 100).toFixed(1) + "%",
                    (m.passRate * 100).toFixed(1) + "%"
                ]);
            });
            // æ¯é¡µ 12 è¡Œè¡¨æ ¼
            splitTableToSlides(subRows, 12, "ğŸ“˜ " + sub + " Â· æ•°æ®è¯¦æƒ…");

            // 6.2 ç”Ÿæˆå­¦ç§‘å›¾è¡¨é¡µ (ä¸€é¡µå±•ç¤ºå‰10ï¼Œå¦‚æœè¶…å¤šå†åŠ é¡µï¼Œè¿™é‡Œä¸ºäº†PPTç®€æ´ï¼Œåªå±•ç¤ºä¸€é¡µæ¦‚è§ˆå›¾è¡¨)
            var subChartSlide = pptx.addSlide({ masterName: 'EXEC_REPORT' });
            subChartSlide.addText("ğŸ“˜ " + sub + " Â· æ ¡é™…æ¨ªå‘å¯¹æ¯”", { x: 0.5, y: 0.8, fontSize: 18, bold: true, color: colorMain });

            // å›¾è¡¨æ•°æ® (å¦‚æœè¶…è¿‡14ä¸ªå­¦æ ¡ï¼ŒXè½´å­—ä½“è‡ªåŠ¨ç¼©å°)
            var chartNames = subData.map(function(s) { return s.name; });
            var chartAvgs = subData.map(function(s) { return s.metrics[sub].avg; });
            
            // è®¡ç®—æå·®ç”¨äºè¯Šæ–­
            var topSc = subData[0];
            var botSc = subData[subData.length - 1];
            var gap = (topSc.metrics[sub].avg - botSc.metrics[sub].avg).toFixed(1);
            var gapColor = parseFloat(gap) > 10 ? colorDanger : colorSuccess;

            // ç»˜åˆ¶æ¨ªå‘æ¡å½¢å›¾
            subChartSlide.addChart(pptx.ChartType.bar, [{
                name: "å¹³å‡åˆ†", labels: chartNames, values: chartAvgs
            }], {
                x: 0.5, y: 1.3, w: 9.0, h: 4.5, // å æ»¡å®½åº¦
                barDir: 'col', // æ”¹ä¸ºçºµå‘æŸ±çŠ¶å›¾ï¼Œèƒ½æ”¾ä¸‹æ›´å¤šå­¦æ ¡
                chartColors: [colorSub],
                dataLabelPosition: "outEnd", showValue: true, showLegend: false,
                catAxisLabelFontSize: chartNames.length > 10 ? 8 : 10, // è‡ªé€‚åº”å­—ä½“
                title: { text: "æ ¡é™…å‡åˆ†æ’å", fontSize: 11, color: "64748B" }
            });

            // åº•éƒ¨è¯Šæ–­
            subChartSlide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 6.0, w: 9.0, h: 0.8, fill: "FFFBEB", line: { color: "FCD34D", width: 1 } });
            subChartSlide.addText("ğŸ’¡ æ™ºèƒ½è¯Šæ–­ç»“è®ºï¼š", { x: 0.6, y: 6.1, fontSize: 10, bold: true, color: colorAccent });
            subChartSlide.addText([
                { text: "æœ¬å­¦ç§‘ç¬¬ä¸€åä¸º ", options: { color: "475569" } },
                { text: topSc.name, options: { bold: true, color: colorMain } },
                { text: "ï¼Œæœ€åä¸€åä¸º " + botSc.name + "ã€‚æ ¡é™…æå·®è¾¾ ", options: { color: "475569" } },
                { text: gap + "åˆ†", options: { bold: true, color: gapColor } },
                { text: "ã€‚å»ºè®®å…³æ³¨åè¿›å­¦æ ¡çš„ " + sub + " å­¦ç§‘æ•™å­¦æ•´æ”¹ã€‚", options: { color: "475569" } }
            ], { x: 0.6, y: 6.4, w: 8.5, h: 0.4, fontSize: 10 });
        });

        // --- 7. å¯¼å‡º ---
        var dateStr = new Date().toISOString().slice(0,10);
        pptx.writeFile({ fileName: CONFIG.name + "_æ±‡æŠ¥ææ–™_" + dateStr + ".pptx" });
    }
    function exportTeacherAnalysis() {
        if (!MY_SCHOOL || Object.keys(TEACHER_STATS).length === 0) { alert('è¯·å…ˆé€‰æ‹©æœ¬æ ¡å¹¶é…ç½®æ•™å¸ˆä¿¡æ¯'); return; }
        analyzeTeachers();
        alert('æ•™å¸ˆåˆ†ææ•°æ®å·²å‡†å¤‡å°±ç»ªï¼Œè¯·æŸ¥çœ‹"æœ¬æ ¡æ•™å¸ˆåˆ†æ"æ ‡ç­¾é¡µ');
    }

    function updateSegmentSelects() {
        const schSel = document.getElementById('segSchoolSelect'); const subSel = document.getElementById('segSubjectSelect'); const oldSch = schSel.value;
        schSel.innerHTML = '<option value="ALL">å…¨ä¹¡é•‡</option>'; Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSch && (oldSch === 'ALL' || SCHOOLS[oldSch])) schSel.value = oldSch;
        const oldSub = subSel.value; subSel.innerHTML = '<option value="total">æ€»åˆ†</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSub) subSel.value = oldSub;
    }

    function renderSegmentAnalysis() {
        const school = document.getElementById('segSchoolSelect').value; 
        const subject = document.getElementById('segSubjectSelect').value; 
        const step = parseInt(document.getElementById('segStep').value) || 10;
        
        let students = school === 'ALL' ? RAW_DATA : (SCHOOLS[school] ? SCHOOLS[school].students : []);
       const validStudents = students.filter(s => {
            const v = subject === 'total' ? s.total : s.scores[subject];
            return typeof v === 'number';
        }).map(s => ({
            ...s, // æµ…æ‹·è´å­¦ç”Ÿä¿¡æ¯
            _filterScore: subject === 'total' ? s.total : s.scores[subject] 
        }));

        const scores = validStudents.map(s => s._filterScore); // å…¼å®¹æ—§é€»è¾‘çš„ scores æ•°ç»„ç”¨äºè®¡ç®— max/total
        
        if(!scores.length) { alert('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æˆç»©æ•°æ®'); return; }
        
        const maxScore = Math.ceil(Math.max(...scores)); 
        const topCeil = Math.ceil(maxScore / step) * step;
        
        let html = `<thead><tr><th>åˆ†æ•°æ®µ</th><th>äººæ•°</th><th>ç´¯è®¡äººæ•°</th><th>æ¯”ä¾‹</th><th>ç´¯è®¡æ¯”ä¾‹</th></tr></thead><tbody>`; 
        let cumulative = 0, total = scores.length;
        
        // ğŸŸ¢ å‡†å¤‡å›¾è¡¨æ•°æ®å®¹å™¨
        const rowsData = []; // ä¸´æ—¶å­˜å‚¨æ•°æ®ä»¥ä¾¿åç»­ç»™å›¾è¡¨ä½¿ç”¨

        // ä»é«˜åˆ°ä½éå†ç”Ÿæˆè¡¨æ ¼
        for(let high = topCeil; high > 0; high -= step) {
            const low = high - step; 
            const isTopBucket = high === topCeil; 
            const bucketList = validStudents.filter(s => {
                const val = s._filterScore;
                return val >= low && (isTopBucket ? val <= high : val < high);
            });
            const count = bucketList.length;
            
            // ä¼˜åŒ–ï¼šå»æ‰ä¸¤å¤´å‡ä¸º0çš„ç©ºè¡Œï¼Œä½†ä¿ç•™ä¸­é—´çš„0ä»¥ä½“ç°æ–­å±‚
            if(count === 0 && cumulative === 0) continue; 
            
            cumulative += count; 
            
            const label = `${low}-${high}`;
            
            html += `<tr><td>${label} åˆ†</td><td>${count}</td><td>${cumulative}</td><td>${(count/total*100).toFixed(2)}%</td><td>${(cumulative/total*100).toFixed(2)}%</td></tr>`;
            
            // æ”¶é›†å›¾è¡¨æ•°æ® (ä½¿ç”¨ unshift å­˜å…¥å¤´éƒ¨ï¼Œä¿è¯å›¾è¡¨æ˜¯ä»ä½åˆ†åˆ°é«˜åˆ†æ’åˆ—ï¼Œç¬¦åˆç›´æ–¹å›¾ä¹ æƒ¯)
            rowsData.unshift({ 
                label: label, 
                count: count,
                studentList: bucketList // ğŸ‘ˆ å…³é”®ï¼šä¿å­˜è¯¥åˆ†æ•°æ®µçš„å­¦ç”Ÿåå•
            });
        }
        
        document.getElementById('tb-segment').innerHTML = html + `</tbody>`;

        // ğŸŸ¢ ç»˜åˆ¶å›¾è¡¨æ ¸å¿ƒé€»è¾‘
        const ctx = document.getElementById('segmentChart');
        if (ctx) {
            // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯ï¼Œé˜²æ­¢é‡å½±
            if (segmentChartInstance) segmentChartInstance.destroy();
            
            segmentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rowsData.map(d => d.label),
                    datasets: [{
                        label: 'äººæ•°åˆ†å¸ƒ',
                        data: rowsData.map(d => d.count),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // è“è‰²æŸ±ä½“
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.9, // è®©æŸ±å­å®½ä¸€ç‚¹ï¼Œæ›´æœ‰ç›´æ–¹å›¾çš„æ„Ÿè§‰
                        categoryPercentage: 0.9,
                        order: 2
                    }, {
                        // å¢åŠ ä¸€æ¡å¹³æ»‘æ›²çº¿ (è¶‹åŠ¿çº¿)
                        type: 'line',
                        label: 'åˆ†å¸ƒè¶‹åŠ¿',
                        data: rowsData.map(d => d.count),
                        borderColor: '#f59e0b', // æ©™è‰²çº¿æ¡
                        borderWidth: 2,
                        tension: 0.4, // å¹³æ»‘æ›²çº¿
                        pointRadius: 0,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (!elements || elements.length === 0) return;
                        
                        // è·å–è¢«ç‚¹å‡»çš„æ•°æ®ç‚¹ç´¢å¼•
                        const index = elements[0].index;
                        const dataItem = rowsData[index];
                        
                        if (dataItem && dataItem.count > 0) {
                            // è°ƒç”¨ DrillSystem (é’»å–ç³»ç»Ÿ) æ˜¾ç¤ºè¯¥åˆ†æ•°æ®µçš„å­¦ç”Ÿåå•
                            // æ ‡é¢˜å¦‚ï¼šå…¨é•‡ è¯­æ–‡ åˆ†æ•°æ®µè¯¦æƒ… (110-120)
                            const title = `${school === 'ALL' ? 'å…¨é•‡' : school} ${subject} åˆ†æ•°æ®µè¯¦æƒ… (${dataItem.label})`;
                            DrillSystem.open(title, dataItem.studentList);
                        } else {
                            UI.toast('è¯¥åˆ†æ•°æ®µæš‚æ— å­¦ç”Ÿ', 'info');
                        }
                    },
                    onHover: (event, chartElement) => {
                        // é¼ æ ‡æ‚¬åœæ—¶å˜æˆå°æ‰‹å›¾æ ‡ï¼Œæç¤ºå¯ç‚¹å‡»
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    plugins: {
                        legend: { display: true },
                        title: { 
                            display: true, 
                            text: `${school === 'ALL' ? 'å…¨é•‡' : school} ${subject} æˆç»©åˆ†å¸ƒç›´æ–¹å›¾ (ğŸ’¡ç‚¹å‡»æŸ±å­å¯æŸ¥çœ‹åå•)`,
                            font: { size: 16 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'äººæ•°' } 
                        },
                        x: {
                            title: { display: true, text: 'åˆ†æ•°æ®µ (ä½ â†’ é«˜)' }
                        }
                    }
                }
            });
        }
    }

    function exportSegmentExcel() {
        const table = document.getElementById('tb-segment');
        if(!table || !table.rows.length) return alert("è¯·å…ˆç”Ÿæˆç»Ÿè®¡è¡¨");
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, "åˆ†æ•°æ®µç»Ÿè®¡.xlsx");
    }

    function updateClassCompSchoolSelect() {
        const sel = document.getElementById('classCompSchoolSelect'); sel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>'; Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
    }

    function renderClassComparison() {
        const schoolName = document.getElementById('classCompSchoolSelect').value; if(!schoolName || !SCHOOLS[schoolName]) { alert('è¯·é€‰æ‹©æœ‰æ•ˆå­¦æ ¡'); return; }
        const sch = SCHOOLS[schoolName]; const classes = {}; sch.students.forEach(s => { if(!classes[s.class]) classes[s.class] = []; classes[s.class].push(s); });
        const classList = Object.keys(classes).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        const classSubjectRanks = {}; // å­˜å‚¨ç»“æ„: { "701ç­": { "è¯­æ–‡": 1, "æ•°å­¦": 5 } }
        SUBJECTS.forEach(sub => {
            const subStats = classList.map(c => {
                const scores = classes[c].map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const avg = scores.length > 0 ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
                return { name: c, avg };
            });
            subStats.sort((a, b) => b.avg - a.avg);
            subStats.forEach((stat, index) => {
                if(!classSubjectRanks[stat.name]) classSubjectRanks[stat.name] = {};
                classSubjectRanks[stat.name][sub] = index + 1;
            });
        });
        const container = document.getElementById('class-comp-results'); const sideNavClassSubjects = document.getElementById('side-nav-class-subjects'); container.innerHTML = ''; sideNavClassSubjects.innerHTML = ''; 
        let html = '';
        // 1. å‡†å¤‡çŸ©é˜µæ•°æ®
        // classSubjectRanks ç»“æ„: { "701ç­": { "è¯­æ–‡": 1, "æ•°å­¦": 5 } }
        // classList æ˜¯æ‰€æœ‰ç­çº§åçš„æ•°ç»„
        
        let matrixHtml = `
            <div class="anchor-target" id="anchor-matrix">
                <div class="sub-header" style="background:linear-gradient(to right, #fdf4ff, transparent); border-left-color:#d946ef; color:#86198f;">
                    ğŸ§© ç­çº§å­¦ç§‘å‡è¡¡æ€§å…¨æ™¯çŸ©é˜µ (æ•°å­—ä¸ºæ ¡å†…æ’å)
                </div>
                <div class="table-wrap">
                    <table class="comparison-table" style="text-align:center;">
                        <thead>
                            <tr>
                                <th style="width:80px; background:#faf5ff;">ç­çº§</th>
                                <!-- åŠ¨æ€ç”Ÿæˆå­¦ç§‘è¡¨å¤´ -->
                                ${SUBJECTS.map(s => `<th>${s}</th>`).join('')}
                                <th style="border-left:2px solid #eee;">ç»¼åˆ</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        // 1. åˆ¤æ–­å½“å‰æ˜¯å¦ä¸º 9 å¹´çº§æ¨¡å¼
        const isGrade9Mode = CONFIG.name && CONFIG.name.includes('9');

        classList.forEach(cls => {
            const ranks = classSubjectRanks[cls] || {};
            // è®¡ç®—è¯¥ç­æ‰€æœ‰å­¦ç§‘æ’åçš„å¹³å‡å€¼ (è¡¡é‡æ•´ä½“å®åŠ›)
            let rankSum = 0;
            let validCount = 0;
            
            let rowCells = SUBJECTS.map(sub => {
                const r = ranks[sub] || '-';
                if (typeof r === 'number') {
                    
                    // ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯ 9 å¹´çº§æ¨¡å¼ä¸”ç§‘ç›®æ˜¯æ”¿æ²»ï¼Œåˆ™ä¸è®¡å…¥ç»¼åˆåˆ†
                    let shouldCount = true;
                    if (isGrade9Mode && (sub === 'æ”¿æ²»' || sub === 'é“æ³•' || sub === 'é“å¾·ä¸æ³•æ²»')) {
                        shouldCount = false; 
                    }

                    if (shouldCount) {
                        rankSum += r;
                        validCount++;
                    }
                    
                    // æ ·å¼é€»è¾‘ï¼šå‰3åç»¿ï¼Œå3åçº¢ (å‡è®¾ç­çº§æ•°>5)
                    let style = "";
                    if (classList.length >= 5) {
                        if (r <= 3) style = "color:#16a34a; font-weight:bold; background:#dcfce7;";
                        else if (r > classList.length - 3) style = "color:#dc2626; font-weight:bold; background:#fee2e2;";
                    } else {
                        // ç­çº§å°‘æ—¶ï¼Œç¬¬1åç»¿ï¼Œæœ€å1åçº¢
                        if (r === 1) style = "color:#16a34a; font-weight:bold; background:#dcfce7;";
                        else if (r === classList.length) style = "color:#dc2626; font-weight:bold; background:#fee2e2;";
                    }
                    return `<td style="${style}">${r}</td>`;
                }
                return `<td style="color:#ccc;">-</td>`;
            }).join('');

            // è®¡ç®—å¹³å‡æ’å (æ’é™¤æ”¿æ²»åçš„)
            const avgRank = validCount > 0 ? (rankSum / validCount).toFixed(1) : '-';

            matrixHtml += `
                <tr>
                    <td style="font-weight:bold; background:#faf5ff;">${cls}</td>
                    ${rowCells}
                    <td style="border-left:2px solid #eee; font-weight:bold;">${avgRank}</td>
                </tr>
            `;
        });

        matrixHtml += `</tbody></table></div>
            <div style="font-size:12px; color:#666; margin-top:5px; margin-bottom:20px; padding:5px;">
                ğŸ’¡ <strong>è¯»å›¾æŒ‡å—ï¼š</strong> 
                <span style="background:#dcfce7; color:#16a34a; padding:0 4px;">ç»¿è‰²</span> ä»£è¡¨è¯¥ç§‘è¿›å…¥å‰3å (ä¼˜åŠ¿)ï¼Œ
                <span style="background:#fee2e2; color:#dc2626; padding:0 4px;">çº¢è‰²</span> ä»£è¡¨è¯¥ç§‘å¤„äºå3å (çŸ­æ¿)ã€‚
                æ¨ªå‘çœ‹ç­çº§åç§‘æƒ…å†µï¼Œçºµå‘çœ‹å­¦ç§‘æ•´ä½“æ°´å¹³ã€‚
            </div>
        </div>`;

        // å°†çŸ©é˜µæ·»åŠ åˆ°æ€» HTML çš„æœ€å‰é¢
        html += matrixHtml;
        const rankIt = (arr, key) => { const sorted = [...arr].sort((a,b) => b[key] - a[key]); arr.forEach(item => item[key+'Rank'] = sorted.indexOf(item) + 1); };
        const allStudents = sch.students;
        const gradeTotalScores = allStudents.map(s => s.total); const gradeTotalLen = gradeTotalScores.length || 1; const gradeTotalAvg = gradeTotalScores.reduce((a,b)=>a+b,0) / gradeTotalLen; const gradeTotalExc = gradeTotalScores.filter(v => v >= (THRESHOLDS.total?.exc||0)).length / gradeTotalLen; const gradeTotalPass = gradeTotalScores.filter(v => v >= (THRESHOLDS.total?.pass||0)).length / gradeTotalLen;
        const anchorTotal = 'anchor-class-total';
        html += `<div id="${anchorTotal}" class="anchor-target"><div class="sub-header">ğŸ“Š ${CONFIG.label}</div><div class="table-wrap"><table class="comparison-table"><thead><tr><th>ç­çº§</th><th>äººæ•°</th><th>å¹³å‡åˆ†</th><th>æ ¡æ’</th><th>ä¼˜ç§€ç‡</th><th>åŠæ ¼ç‡</th><th style="background:#fff7ed; color:#c2410c; min-width:150px;">ğŸ—ï¸ æœ¨æ¡¶æ•ˆåº”è¯Šæ–­ (å­¦ç§‘å‡è¡¡æ€§)</th></tr></thead><tbody>`;
        const totalStats = classList.map(c => {
            const scores = classes[c].map(s => s.total); const len = scores.length || 1; const avg = scores.reduce((a,b)=>a+b,0)/len; const exc = scores.filter(v => v >= (THRESHOLDS.total?.exc||0)).length / len; const pass = scores.filter(v => v >= (THRESHOLDS.total?.pass||0)).length / len;
            const avgDiff = gradeTotalAvg ? (avg - gradeTotalAvg)/gradeTotalAvg : 0; const excDiff = gradeTotalExc ? (exc - gradeTotalExc)/gradeTotalExc : 0; const passDiff = gradeTotalPass ? (pass - gradeTotalPass)/gradeTotalPass : 0;
            return { name: c, count: scores.length, avg, exc, pass, avgDiff, excDiff, passDiff };
        });
        rankIt(totalStats, 'avg'); rankIt(totalStats, 'exc'); rankIt(totalStats, 'pass');
        totalStats.forEach(stat => {let diagnosisHtml = '';
            const totalRank = stat.avgRank; // ç­çº§æ€»åˆ†æ’å
            
            SUBJECTS.forEach(sub => {
                const subRank = classSubjectRanks[stat.name][sub];
                // é€»è¾‘ï¼šå¦‚æœå•ç§‘æ’åæ¯”æ€»æ’åè½å 2 åä»¥ä¸Šï¼Œè§†ä¸ºâ€œçŸ­æ¿â€ï¼›é¢†å…ˆ 2 åä»¥ä¸Šè§†ä¸ºâ€œä¼˜åŠ¿â€
                if (subRank >= totalRank + 2) {
                    diagnosisHtml += `<span class="plank-badge plank-drag" title="${sub}æ’å(${subRank})æ˜¾è‘—ä½äºæ€»åˆ†æ’å(${totalRank})">ğŸ”»${sub}</span>`;
                } else if (subRank <= totalRank - 2) {
                    diagnosisHtml += `<span class="plank-badge plank-lift" title="${sub}æ’å(${subRank})æ˜¾è‘—é«˜äºæ€»åˆ†æ’å(${totalRank})">â–²${sub}</span>`;
                }
            });
            if(!diagnosisHtml) diagnosisHtml = '<span style="color:#94a3b8; font-size:11px;">å„ç§‘å‡è¡¡</span>';html += `<tr>
                <td><strong>${stat.name}</strong></td>
                <td>${stat.count}</td>
                <td>${stat.avg.toFixed(2)}</td>
                <td>${getRankHTML(stat.avgRank)}</td>
                <td>${(stat.exc*100).toFixed(1)}%</td>
                <td>${(stat.pass*100).toFixed(1)}%</td>
                <td style="text-align:left; background:#fffaf5;">${diagnosisHtml}</td>
            </tr>`;  });
        html += `</tbody></table></div></div>`;
        SUBJECTS.forEach(sub => {
            const gradeSubScores = allStudents.map(s => s.scores[sub]).filter(v => typeof v === 'number'); const gradeSubLen = gradeSubScores.length || 1; const gradeSubAvg = gradeSubScores.reduce((a,b)=>a+b,0) / gradeSubLen; const gradeSubExc = gradeSubScores.filter(v => v >= THRESHOLDS[sub].exc).length / gradeSubLen; const gradeSubPass = gradeSubScores.filter(v => v >= THRESHOLDS[sub].pass).length / gradeSubLen;
            const anchorSub = `anchor-class-${sub}`;
            html += `<div id="${anchorSub}" class="anchor-target" style="padding-top:20px;"><div class="sub-header">ğŸ“˜ ${sub}</div><div class="table-wrap"><table class="comparison-table"><thead><tr><th>ç­çº§</th><th>äººæ•°</th><th>å¹³å‡åˆ†</th><th>ä¸çº§æ¯”</th><th>æ ¡æ’</th><th>ä¼˜ç§€ç‡</th><th>ä¸çº§æ¯”</th><th>æ ¡æ’</th><th>åŠæ ¼ç‡</th><th>ä¸çº§æ¯”</th><th>æ ¡æ’</th></tr></thead><tbody>`;
            const subStats = classList.map(c => {
                const scores = classes[c].map(s => s.scores[sub]).filter(v => typeof v === 'number'); const len = scores.length || 1; const avg = len > 0 ? scores.reduce((a,b)=>a+b,0)/len : 0; const exc = len > 0 ? scores.filter(v => v >= THRESHOLDS[sub].exc).length / len : 0; const pass = len > 0 ? scores.filter(v => v >= THRESHOLDS[sub].pass).length / len : 0;
                const avgDiff = (gradeSubAvg && avg) ? (avg - gradeSubAvg)/gradeSubAvg : 0; const excDiff = (gradeSubExc && exc) ? (exc - gradeSubExc)/gradeSubExc : 0; const passDiff = (gradeSubPass && pass) ? (pass - gradeSubPass)/gradeSubPass : 0;
                return { name: c, count: scores.length, avg, exc, pass, avgDiff, excDiff, passDiff };
            });
            rankIt(subStats, 'avg'); rankIt(subStats, 'exc'); rankIt(subStats, 'pass');
            subStats.forEach(stat => { html += `<tr><td>${stat.name}</td><td>${stat.count}</td><td>${stat.avg.toFixed(2)}</td><td class="${stat.avgDiff>=0?'positive-percent':'negative-percent'}">${stat.avgDiff>=0?'+':''}${(stat.avgDiff*100).toFixed(2)}%</td><td>${stat.avgRank}</td><td>${(stat.exc*100).toFixed(2)}%</td><td class="${stat.excDiff>=0?'positive-percent':'negative-percent'}">${stat.excDiff>=0?'+':''}${(stat.excDiff*100).toFixed(2)}%</td><td>${stat.excRank}</td><td>${(stat.pass*100).toFixed(2)}%</td><td class="${stat.passDiff>=0?'positive-percent':'negative-percent'}">${stat.passDiff>=0?'+':''}${(stat.passDiff*100).toFixed(2)}%</td><td>${stat.passRank}</td></tr>`; });
            html += `</tbody></table></div></div>`;
            const navLink = document.createElement('a'); navLink.className = 'side-nav-sub-link'; navLink.innerText = sub; navLink.onclick = () => scrollToSubAnchor(anchorSub, navLink); sideNavClassSubjects.appendChild(navLink);
        });
        container.innerHTML = html;
    }

    function exportClassComparisonExcel() {
        const schoolName = document.getElementById('classCompSchoolSelect').value;
        if(!schoolName || !SCHOOLS[schoolName]) return alert("è¯·å…ˆè¿›è¡Œå¯¹æ¯”åˆ†æ");
        const sch = SCHOOLS[schoolName];
        const classes = {}; sch.students.forEach(s => { if(!classes[s.class]) classes[s.class] = []; classes[s.class].push(s); });
        const classList = Object.keys(classes).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        
        const wb = XLSX.utils.book_new();
        const rankIt = (arr, key) => { const sorted = [...arr].sort((a,b) => b[key] - a[key]); arr.forEach(item => item[key+'Rank'] = sorted.indexOf(item) + 1); };

        const allStudents = sch.students;
        const gAvg = allStudents.reduce((a,b)=>a+b.total,0) / allStudents.length;
        const gExc = allStudents.filter(v => v.total >= (THRESHOLDS.total?.exc||0)).length / allStudents.length;
        const gPass = allStudents.filter(v => v.total >= (THRESHOLDS.total?.pass||0)).length / allStudents.length;

        const totalStats = classList.map(c => {
            const scores = classes[c].map(s => s.total); const len = scores.length;
            const avg = scores.reduce((a,b)=>a+b,0)/len; 
            const exc = scores.filter(v => v >= (THRESHOLDS.total?.exc||0)).length / len; 
            const pass = scores.filter(v => v >= (THRESHOLDS.total?.pass||0)).length / len;
            return { name: c, count: len, avg, exc, pass, 
                     avgDiff: gAvg ? (avg-gAvg)/gAvg : 0, 
                     excDiff: gExc ? (exc-gExc)/gExc : 0, 
                     passDiff: gPass ? (pass-gPass)/gPass : 0 };
        });
        rankIt(totalStats, 'avg'); rankIt(totalStats, 'exc'); rankIt(totalStats, 'pass');

        const wsTotalData = [["ç­çº§", "äººæ•°", "å¹³å‡åˆ†", "ä¸çº§æ¯”", "æ ¡æ’", "ä¼˜ç§€ç‡", "ä¸çº§æ¯”", "æ ¡æ’", "åŠæ ¼ç‡", "ä¸çº§æ¯”", "æ ¡æ’"]];
        totalStats.forEach(s => {
            wsData = [s.name, s.count, getExcelNum(s.avg), getExcelPercent(s.avgDiff), s.avgRank, getExcelPercent(s.exc), getExcelPercent(s.excDiff), s.excRank, getExcelPercent(s.pass), getExcelPercent(s.passDiff), s.passRank];
            wsTotalData.push(wsData);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsTotalData), CONFIG.label);

        SUBJECTS.forEach(sub => {
            const gScores = allStudents.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            const subAvg = gScores.length ? gScores.reduce((a,b)=>a+b,0)/gScores.length : 0;
            const subExc = gScores.length ? gScores.filter(v => v >= THRESHOLDS[sub].exc).length / gScores.length : 0;
            const subPass = gScores.length ? gScores.filter(v => v >= THRESHOLDS[sub].pass).length / gScores.length : 0;

            const subStats = classList.map(c => {
                const scores = classes[c].map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const len = scores.length || 1; 
                const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/len : 0;
                const exc = scores.length ? scores.filter(v => v >= THRESHOLDS[sub].exc).length / len : 0;
                const pass = scores.length ? scores.filter(v => v >= THRESHOLDS[sub].pass).length / len : 0;
                return { name: c, count: scores.length, avg, exc, pass,
                         avgDiff: subAvg ? (avg-subAvg)/subAvg : 0,
                         excDiff: subExc ? (exc-subExc)/subExc : 0,
                         passDiff: subPass ? (pass-subPass)/subPass : 0 };
            });
            rankIt(subStats, 'avg'); rankIt(subStats, 'exc'); rankIt(subStats, 'pass');

            const wsSubData = [["ç­çº§", "äººæ•°", "å¹³å‡åˆ†", "ä¸çº§æ¯”", "æ ¡æ’", "ä¼˜ç§€ç‡", "ä¸çº§æ¯”", "æ ¡æ’", "åŠæ ¼ç‡", "ä¸çº§æ¯”", "æ ¡æ’"]];
            subStats.forEach(s => {
                wsData = [s.name, s.count, getExcelNum(s.avg), getExcelPercent(s.avgDiff), s.avgRank, getExcelPercent(s.exc), getExcelPercent(s.excDiff), s.excRank, getExcelPercent(s.pass), getExcelPercent(s.passDiff), s.passRank];
                wsSubData.push(wsData);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsSubData), sub);
        });
        XLSX.writeFile(wb, "ç­çº§æ¨ªå‘å¯¹æ¯”åˆ†æ.xlsx");
    }

    // 1. åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
    function updateSubjectBalanceSelects() {
        const schSel = document.getElementById('sbSchoolSelect');
        const clsSel = document.getElementById('sbClassSelect');
        
        schSel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>';
        Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`);
        
        // è”åŠ¨æ›´æ–°ç­çº§
        schSel.onchange = () => {
            clsSel.innerHTML = '<option value="">å…¨éƒ¨</option>';
            if(schSel.value && SCHOOLS[schSel.value]) {
                const classes = [...new Set(SCHOOLS[schSel.value].students.map(s => s.class))].sort();
                classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`);
            }
        };
    }

    let SB_CACHE_DATA = []; // ç¼“å­˜ç”¨äºå¯¼å‡º

    // 2. æ¸²æŸ“ä¸»è¡¨æ ¼
    function SB_renderTable() {
        const sch = document.getElementById('sbSchoolSelect').value;
        const cls = document.getElementById('sbClassSelect').value;
        const sortType = document.getElementById('sbSortBy').value;

        if(!sch) return alert("è¯·å…ˆé€‰æ‹©å­¦æ ¡");

        // A. ç­›é€‰å­¦ç”Ÿ
        let students = SCHOOLS[sch].students;
        if(cls && cls !== 'å…¨éƒ¨') students = students.filter(s => s.class === cls);

        // B. è®¡ç®—å…¨é•‡å„ç§‘å‡åˆ† (ä½œä¸ºåŸºå‡†çº¿)
        const gradeStats = SB_getGradeStats();

        // C. å¤„ç†æ¯ä¸ªå­¦ç”Ÿçš„æ•°æ®
        const renderList = students.map(s => {
            const items = [];
            let maxDiff = -999;
            let minDiff = 999;

            SUBJECTS.forEach(sub => {
                if(s.scores[sub] === undefined) return;
                const diff = s.scores[sub] - gradeStats[sub]; // å·®å€¼
                items.push({ sub, score: s.scores[sub], diff });
                
                if(diff > maxDiff) maxDiff = diff;
                if(diff < minDiff) minDiff = diff;
            });

            // æŒ‰å·®å€¼æ’åºï¼šä¼˜åŠ¿åœ¨å‰ï¼ŒåŠ£åŠ¿åœ¨å
            items.sort((a,b) => b.diff - a.diff);

            // è®¡ç®—åç§‘æŒ‡æ•° (æå·®)
            const balanceScore = maxDiff - minDiff;

            return {
                name: s.name,
                class: s.class,
                total: s.total,
                rank: safeGet(s, 'ranks.total.township', '-'),
                items,
                balanceScore
            };
        });

        // D. æ’åº
        if(sortType === 'total') {
            renderList.sort((a,b) => b.total - a.total);
        } else {
            renderList.sort((a,b) => b.balanceScore - a.balanceScore); // è¶Šä¸å‡è¡¡æ’è¶Šå‰
        }
        
        SB_CACHE_DATA = renderList; // å­˜å…¥ç¼“å­˜

        // E. ç”Ÿæˆ HTML
        const tbody = document.querySelector('#sb-table tbody');
        let html = '';

        renderList.forEach(row => {
            // æ„å»ºå¯è§†åŒ–æ¡
            // æˆ‘ä»¬åªå±•ç¤ºæœ€å¼ºçš„2ç§‘å’Œæœ€å¼±çš„2ç§‘ï¼Œé¿å…å¤ªé•¿ï¼Œæˆ–è€…å±•ç¤ºå…¨éƒ¨ä½†ç¼©å°
            // ä¸ºäº†â€œä¸€çœ‹å°±æ‡‚â€ï¼Œæˆ‘ä»¬å±•ç¤ºå…¨éƒ¨ï¼Œä½†ç”¨ Flex å¸ƒå±€ä¸€è¡Œæ˜¾ç¤º
            
            let barsHtml = `<div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">`;
            
            row.items.forEach(item => {
                const isStrong = item.diff >= 0;
                const color = isStrong ? '#16a34a' : '#dc2626';
                const bg = isStrong ? '#dcfce7' : '#fee2e2';
                const icon = isStrong ? 'ğŸ“ˆ' : 'ğŸ“‰';
                
                // ä»…å½“å·®å€¼ç»å¯¹å€¼å¤§äº 5 åˆ†æ—¶æ‰æ˜¾è‘—å±•ç¤ºï¼Œå¦åˆ™ä½œä¸ºâ€œå¹³â€
                const absDiff = Math.abs(item.diff);
                const barWidth = Math.min(absDiff * 2, 50); // é™åˆ¶æœ€å¤§å®½åº¦
                
                // å°å­©æ˜“è¯»çš„èƒ¶å›Šæ ·å¼
                barsHtml += `
                    <div style="display:flex; flex-direction:column; align-items:center; width:50px;">
                        <div style="font-size:10px; font-weight:bold; color:#333;">${item.sub}</div>
                        <div style="display:flex; align-items:flex-end; height:40px; justify-content:center; width:100%;">
                            <div style="
                                width: 12px; 
                                height: ${Math.max(barWidth, 2)}px; 
                                background-color: ${color}; 
                                border-radius: 2px;
                                opacity: ${absDiff < 2 ? 0.3 : 1};
                            " title="åˆ†æ•°: ${item.score} (æ¯”å¹³å‡${item.diff>0?'+':''}${item.diff.toFixed(1)})"></div>
                        </div>
                        <div style="font-size:10px; color:${color}; font-weight:bold;">
                            ${item.diff > 0 ? '+' : ''}${item.diff.toFixed(0)}
                        </div>
                    </div>
                `;
            });
            barsHtml += `</div>`;

            // ç”Ÿæˆç®€è¯„
            const strongSub = row.items[0];
            const weakSub = row.items[row.items.length - 1];
            let comment = "";
            if (row.balanceScore < 15) comment = `<span class="badge" style="background:#3b82f6">âš–ï¸ éå¸¸å‡è¡¡</span>`;
            else {
                comment = `<div style="font-size:12px; line-height:1.4;">
                    <div>ğŸ‘ å¼º: <strong>${strongSub.sub}</strong> (+${strongSub.diff.toFixed(0)})</div>
                    <div style="color:#dc2626;">ğŸ†˜ å¼±: <strong>${weakSub.sub}</strong> (${weakSub.diff.toFixed(0)})</div>
                </div>`;
            }

            html += `
                <tr>
                    <td>
                        <div style="font-weight:bold;">${row.name}</div>
                        <div style="font-size:10px; color:#999;">${row.class}</div>
                    </td>
                    <td style="font-weight:bold; font-size:14px;">${row.total}</td>
                    <td>${row.rank}</td>
                    <td style="padding:10px 5px;">${barsHtml}</td>
                    <td>${comment}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        if(renderList.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">æ— æ•°æ®</td></tr>';
    }

    function SB_getGradeStats() {
        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            const avg = allScores.length ? allScores.reduce((a,b)=>a+b,0)/allScores.length : 0;
            gradeStats[sub] = avg;
        });
        return gradeStats;
    }

    function SB_runCluster() {
        const sch = document.getElementById('sbSchoolSelect').value;
        const cls = document.getElementById('sbClassSelect').value;
        if (!sch) return alert("è¯·å…ˆé€‰æ‹©å­¦æ ¡");

        let students = SCHOOLS[sch].students;
        if (cls && cls !== 'å…¨éƒ¨') students = students.filter(s => s.class === cls);
        if (!students.length) return alert("æ— å¯ç”¨å­¦ç”Ÿæ•°æ®");

        const gradeStats = SB_getGradeStats();
        const humanities = ['è¯­æ–‡','è‹±è¯­','æ”¿æ²»','å†å²','åœ°ç†'];
        const sciences = ['æ•°å­¦','ç‰©ç†','åŒ–å­¦','ç”Ÿç‰©','ç§‘å­¦'];

        const vectors = [];
        const meta = [];

        students.forEach(s => {
            const diffs = [];
            SUBJECTS.forEach(sub => {
                const v = s.scores[sub];
                if (typeof v === 'number') diffs.push({ sub, diff: v - (gradeStats[sub] || 0) });
            });
            if (diffs.length === 0) return;

            const hList = diffs.filter(d => humanities.includes(d.sub));
            const sList = diffs.filter(d => sciences.includes(d.sub));
            const hAvg = hList.length ? hList.reduce((a,b)=>a+b.diff,0)/hList.length : 0;
            const sAvg = sList.length ? sList.reduce((a,b)=>a+b.diff,0)/sList.length : 0;
            const maxAbs = Math.max(...diffs.map(d => Math.abs(d.diff)));
            const balance = Math.max(...diffs.map(d => d.diff)) - Math.min(...diffs.map(d => d.diff));

            vectors.push([hAvg, sAvg, maxAbs, balance]);
            meta.push({ name: s.name, class: s.class, hAvg, sAvg, maxAbs, balance });
        });

        const { labels, centroids } = kmeans(vectors, 4, 12);
        const clusterMap = {};
        labels.forEach((c, i) => {
            if (!clusterMap[c]) clusterMap[c] = [];
            clusterMap[c].push(meta[i]);
        });

        // ç»™æ¯ä¸ªç°‡å‘½å
        const clusterLabels = {};
        centroids.forEach((centroid, idx) => {
            const [hAvg, sAvg, maxAbs, balance] = centroid;
            let tag = 'å…¨ç§‘å‡è¡¡å‹';
            if (balance < 8 && Math.abs(hAvg - sAvg) < 6) tag = 'å…¨ç§‘å‡è¡¡å‹';
            else if (hAvg - sAvg > 6) tag = 'æ–‡å¼ºç†å¼±å‹';
            else if (sAvg - hAvg > 6) tag = 'ç†å¼ºæ–‡å¼±å‹';
            else if (maxAbs > 12 || balance > 18) tag = 'å•ç§‘çªå›´å‹';
            clusterLabels[idx] = tag;
        });

        SB_renderClusterResults(clusterMap, clusterLabels);
    }

    function SB_renderClusterResults(clusterMap, clusterLabels) {
        const container = document.getElementById('sb-cluster-results');
        if (!container) return;

        const strategy = {
            'å…¨ç§‘å‡è¡¡å‹': 'ç­–ç•¥ï¼šä¿æŒèŠ‚å¥ï¼Œé€‚åº¦å¼ºåŒ–æ‹”é«˜é¢˜ï¼›æ¯å‘¨1æ¬¡ç»¼åˆè®­ç»ƒï¼Œé¿å…çŸ­æ¿å‡ºç°ã€‚',
            'æ–‡å¼ºç†å¼±å‹': 'ç­–ç•¥ï¼šè¡¥æ•°å­¦/ç‰©ç†åŸºç¡€æ¦‚å¿µä¸é¢˜å‹å¥—è·¯ï¼Œæ¯å¤©å›ºå®š15-20åˆ†é’Ÿç†ç§‘è®­ç»ƒã€‚',
            'ç†å¼ºæ–‡å¼±å‹': 'ç­–ç•¥ï¼šè¯­æ–‡/è‹±è¯­ä»¥â€œé˜…è¯»+è¯æ±‡+å†™ä½œâ€ä¸‰æ¿æ–§æ¨è¿›ï¼Œé‡ç‚¹æå‡è¯­æ„Ÿä¸è¡¨è¾¾ã€‚',
            'å•ç§‘çªå›´å‹': 'ç­–ç•¥ï¼šä¿ä¼˜åŠ¿å­¦ç§‘çš„åŒæ—¶è¡¥é½æœ€å¼±ç§‘ï¼Œåˆ¶å®šâ€œä¸»æ”»+è¡¥å¼±â€åŒè½¨è®¡åˆ’ã€‚'
        };

        let html = '';
        Object.keys(clusterMap).forEach(k => {
            const label = clusterLabels[k] || 'æœªå‘½å';
            const list = clusterMap[k] || [];
            html += `<div style="margin-bottom:12px; padding:10px; border:1px dashed #fed7aa; border-radius:8px; background:#fff;">
                <div style="font-weight:bold; color:#9a3412;">${label}ï¼ˆ${list.length}äººï¼‰</div>
                <div style="margin:6px 0; color:#7c2d12;">${strategy[label] || ''}</div>
                <div style="font-size:11px; color:#64748b;">ç¤ºä¾‹åå•ï¼š${list.slice(0, 8).map(s => `${s.name}(${s.class})`).join('ã€')}${list.length>8?' â€¦':''}</div>
            </div>`;
        });
        container.innerHTML = html || 'æš‚æ— èšç±»ç»“æœ';
    }

    // ç®€å• K-Means å®ç°
    function kmeans(data, k = 4, maxIter = 10) {
        if (!data.length) return { labels: [], centroids: [] };
        const dim = data[0].length;
        const centroids = [];
        const used = new Set();
        while (centroids.length < k && used.size < data.length) {
            const idx = Math.floor(Math.random() * data.length);
            if (!used.has(idx)) { used.add(idx); centroids.push([...data[idx]]); }
        }
        const labels = new Array(data.length).fill(0);

        for (let iter = 0; iter < maxIter; iter++) {
            // assignment
            for (let i = 0; i < data.length; i++) {
                let best = 0, bestDist = Infinity;
                for (let c = 0; c < centroids.length; c++) {
                    const dist = euclid(data[i], centroids[c]);
                    if (dist < bestDist) { bestDist = dist; best = c; }
                }
                labels[i] = best;
            }
            // update
            const sums = Array.from({ length: centroids.length }, () => new Array(dim).fill(0));
            const counts = new Array(centroids.length).fill(0);
            for (let i = 0; i < data.length; i++) {
                const c = labels[i];
                counts[c]++;
                for (let d = 0; d < dim; d++) sums[c][d] += data[i][d];
            }
            for (let c = 0; c < centroids.length; c++) {
                if (counts[c] === 0) continue;
                for (let d = 0; d < dim; d++) centroids[c][d] = sums[c][d] / counts[c];
            }
        }
        return { labels, centroids };
    }

    function euclid(a, b) {
        let s = 0;
        for (let i = 0; i < a.length; i++) s += Math.pow(a[i] - b[i], 2);
        return Math.sqrt(s);
    }

    // 3. å¯¼å‡º Excel
    function SB_exportExcel() {
        if(!SB_CACHE_DATA.length) return alert("è¯·å…ˆç”Ÿæˆåˆ†ææ•°æ®");
        
        const wb = XLSX.utils.book_new();
        const headers = ["ç­çº§", "å§“å", "æ€»åˆ†", "å…¨é•‡æ’å", "æœ€å¼ºå­¦ç§‘", "æœ€å¼ºåˆ†å·®", "æœ€å¼±å­¦ç§‘", "æœ€å¼±åˆ†å·®"];
        
        // åŠ¨æ€æ·»åŠ æ‰€æœ‰å­¦ç§‘åˆ—
        SUBJECTS.forEach(s => headers.push(`${s}åˆ†å·®`));
        
        const data = [headers];
        
        SB_CACHE_DATA.forEach(r => {
            const strong = r.items[0];
            const weak = r.items[r.items.length-1];
            
            const row = [
                r.class, r.name, r.total, r.rank,
                strong.sub, `+${strong.diff.toFixed(1)}`,
                weak.sub, weak.diff.toFixed(1)
            ];
            
            // å¡«å……å„ç§‘åˆ†å·®
            SUBJECTS.forEach(s => {
                const item = r.items.find(i => i.sub === s);
                row.push(item ? item.diff.toFixed(1) : '-');
            });
            
            data.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "å­¦ç”Ÿä¼˜åŠ£åŠ¿åˆ†æ");
        XLSX.writeFile(wb, `ä¼˜åŠ£åŠ¿å­¦ç§‘åˆ†æ_${document.getElementById('sbSchoolSelect').value}.xlsx`);
    }

    function updatePotentialSchoolSelect() {
        const sel = document.getElementById('potSchoolSelect'); 
        const old = sel.value; 
        
        sel.innerHTML = '<option value="ALL">å…¨ä¹¡é•‡</option>'; 
        
        // ä¿®å¤ï¼šç¡®ä¿ value å±æ€§è¢«å¼•å·åŒ…è£¹ï¼Œé˜²æ­¢å­¦æ ¡åä¸­æœ‰ç©ºæ ¼å¯¼è‡´æˆªæ–­
        Object.keys(SCHOOLS).forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });
        
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        if(old && (old==='ALL' || SCHOOLS[old])) sel.value = old;
    }

    function renderPotentialAnalysis() {
        if(!RAW_DATA.length) return alert('è¯·å…ˆä¸Šä¼ æ•°æ®');
        const scope = document.getElementById('potSchoolSelect').value; 
        const topRatio = parseFloat(document.getElementById('potTopSelect').value); 
        
        let candidates = []; 
        let scopeStudents = (scope === 'ALL') ? RAW_DATA : (SCHOOLS[scope]?.students || []);
        
        // 1. ç­›é€‰æ€»åˆ†ä¼˜ç”Ÿ
        const totalCount = RAW_DATA.length;
        const topRankThreshold = Math.floor(totalCount * topRatio);
        
        // 2. éå†ä¼˜ç”Ÿï¼Œè®¡ç®—åç§‘æŒ‡æ•°
        scopeStudents.forEach(stu => {
            const tRank = safeGet(stu, 'ranks.total.township', 99999); 
            if (tRank === '-' || tRank > topRankThreshold) return;

            // è·å–è¯¥ç”Ÿçš„æ€»åˆ† Tå€¼ (å¦‚æœæ²¡æœ‰è®¡ç®—è¿‡ï¼Œç”¨æ’åç™¾åˆ†æ¯”ä¼°ç®—)
            // ä¹‹å‰çš„ processData å·²ç»è®¡ç®—äº† stu.totalTScore å’Œ stu.tScores
            
            // å¦‚æœåªæœ‰æ’åæ•°æ®ï¼Œå›é€€åˆ° Rank Gap æ¨¡å¼
            // å¦‚æœæœ‰ T åˆ†æ•°æ®ï¼Œä½¿ç”¨ T åˆ†å·® (æ›´ç§‘å­¦)
            const useAdvancedMetrics = (stu.tScores && stu.totalTScore);
            
            SUBJECTS.forEach(sub => {
                const subRank = safeGet(stu, `ranks.${sub}.township`, 0);
                if (!subRank) return;

                let isPotential = false;
                let gapVal = 0;
                let gapLabel = '';

                if (useAdvancedMetrics) {
                    // ä¸šåŠ¡é€»è¾‘æ·±åŒ–ï¼šä½¿ç”¨ T åˆ†å·®
                    // å‡è®¾å„ç§‘ T åˆ†å‡å€¼ä¸º 50ã€‚å¦‚æœæŸç§‘ T åˆ† < 40 (ä½äºå‡å€¼1ä¸ªæ ‡å‡†å·®)ï¼Œä¸”æ€» T åˆ†è¾ƒé«˜
                    // æˆ–è€…ï¼šè¯¥ç§‘ T åˆ† æ¯” è‡ªèº«å¹³å‡ T åˆ† ä½ 10 åˆ†ä»¥ä¸Š
                    const subT = stu.tScores[sub];
                    // ä¼°ç®—å­¦ç”Ÿè‡ªèº«çš„å¹³å‡æ°´å¹³ (æ€»Tåˆ† / ç§‘ç›®æ•°)
                    const validSubCount = Object.values(stu.tScores).filter(v=>v>0).length || 1;
                    const selfAvgT = stu.totalTScore / validSubCount; 
                    
                    // åˆ¤å®šï¼šè¯¥ç§‘æ¯”è‡ªå·±å¹³å‡æ°´å¹³ä½ 8 åˆ†ä»¥ä¸Šï¼Œä¸”è¯¥ç§‘ç»å¯¹å€¼ < 45 (ç¨å¾®åå¼±)
                    if ((selfAvgT - subT) > 8) {
                        isPotential = true;
                        gapVal = (selfAvgT - subT).toFixed(1);
                        gapLabel = `Tåˆ†åç¦» -${gapVal}`;
                    }
                } else {
                    // å›é€€é€»è¾‘ï¼šæ’åè½å·®æ³•
                    // å¦‚æœå•ç§‘æ’åæ¯”æ€»æ’å è½å 30% çš„æ€»äººæ•°
                    const gap = subRank - tRank;
                    if (gap > (totalCount * 0.3)) {
                        isPotential = true;
                        gapVal = gap;
                        gapLabel = `åæ¬¡è½å·® ${gap}`;
                    }
                }

                if (isPotential) {
                    candidates.push({ 
                        school: stu.school, class: stu.class, name: stu.name, 
                        totalScore: stu.total, totalRank: tRank, 
                        subject: sub, subScore: stu.scores[sub], subRank: subRank, 
                        gap: gapLabel, // æ˜¾ç¤ºæ–‡æœ¬
                        sortVal: parseFloat(gapVal) // ç”¨äºæ’åº
                    }); 
                }
            });
        });

        // æŒ‰åç§‘ä¸¥é‡ç¨‹åº¦æ’åº
        candidates.sort((a,b) => b.sortVal - a.sortVal); 
        POTENTIAL_STUDENTS_CACHE = candidates;

        let html = `<div class="info-bar">
            <strong>ğŸ’¡ åˆ†ææ¨¡å‹å‡çº§ï¼š</strong> 
            ç³»ç»Ÿå·²è‡ªåŠ¨å¯ç”¨ <b>${candidates.length > 0 && candidates[0].gap.includes('Tåˆ†') ? 'Z-Scoreæ ‡å‡†åˆ†åç¦»æ¨¡å‹' : 'åæ¬¡è½å·®æ¨¡å‹'}</b>ã€‚
            <br>ç­›é€‰èŒƒå›´ï¼šæ€»åˆ†å‰ ${(topRatio*100).toFixed(0)}% çš„å­¦ç”Ÿä¸­ï¼Œå•ç§‘æ˜¾è‘—â€œæ‹–åè…¿â€çš„æ½œåŠ›è‚¡ã€‚
        </div>
        <div class="table-wrap"><table><thead><tr><th>å­¦æ ¡</th><th>ç­çº§</th><th>å§“å</th><th>æ€»åˆ†æ’å</th><th>è·›è„šå­¦ç§‘</th><th>å­¦ç§‘åˆ†æ•°</th><th>å­¦ç§‘æ’å</th><th>åç§‘æŒ‡æ•°</th></tr></thead><tbody>`;
        
        if(candidates.length === 0) {
            html += `<tr><td colspan="8" style="padding:30px; text-align:center;">ğŸ‰ æ­å–œï¼åœ¨å‰ ${(topRatio*100)}% å­¦ç”Ÿä¸­æœªå‘ç°ä¸¥é‡åç§‘ç°è±¡ã€‚</td></tr>`; 
        } else {
            candidates.forEach(c => {
                html += `<tr>
                    <td>${c.school}</td>
                    <td>${c.class}</td>
                    <td><strong>${c.name}</strong></td>
                    <td class="text-green">${c.totalRank}</td>
                    <td style="color:var(--primary); font-weight:bold;">${c.subject}</td>
                    <td>${formatVal(c.subScore)}</td>
                    <td class="text-red">${c.subRank}</td>
                    <td style="color:red; font-weight:bold;">ğŸ“‰ ${c.gap}</td>
                </tr>`;
            });
        }
        document.getElementById('potential-results').innerHTML = html + `</tbody></table></div>`;
    }

    function exportPotentialAnalysis() {
        if(!POTENTIAL_STUDENTS_CACHE.length) { alert('è¯·å…ˆç”Ÿæˆæ•°æ®æˆ–ç»“æœä¸ºç©º'); return; }
        const wb = XLSX.utils.book_new(); const data = [['å­¦æ ¡', 'ç­çº§', 'å§“å', 'æ€»åˆ†', 'æ€»åˆ†å…¨é•‡æ’å', 'è·›è„šå­¦ç§‘', 'å­¦ç§‘åˆ†æ•°', 'å­¦ç§‘å…¨é•‡æ’å', 'åæ¬¡è½å·®']];
        POTENTIAL_STUDENTS_CACHE.forEach(c => data.push([c.school, c.class, c.name, c.totalScore, c.totalRank, c.subject, c.subScore, c.subRank, c.gap]));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "åç§‘ç”Ÿåå•"); XLSX.writeFile(wb, "åç§‘æ½œåŠ›ç”ŸæŒ–æ˜åå•.xlsx");
    }

    function updateDiagnosisSelects() {
        const schSel = document.getElementById('diagSchoolSelect'); const subSel = document.getElementById('diagSubjectSelect'); const oldSch = schSel.value; schSel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>'; Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSch && SCHOOLS[oldSch]) schSel.value = oldSch;
        const oldSub = subSel.value; subSel.innerHTML = '<option value="total">æ€»åˆ†</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`); if(oldSub) subSel.value = oldSub;
    }

    function renderClassDiagnosis() {
        const schoolName = document.getElementById('diagSchoolSelect').value; const subject = document.getElementById('diagSubjectSelect').value; const step = parseInt(document.getElementById('diagStep').value) || 10;
        if(!schoolName || !SCHOOLS[schoolName]) return alert('è¯·é€‰æ‹©å­¦æ ¡');
        const sch = SCHOOLS[schoolName]; const classData = {}; sch.students.forEach(s => { if(!classData[s.class]) classData[s.class] = []; const val = (subject === 'total') ? s.total : s.scores[subject]; if(typeof val === 'number') classData[s.class].push(val); });
        const classes = Object.keys(classData).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
        let maxScoreAll = 0;
        const stats = classes.map(cls => {
            const scores = classData[cls]; const count = scores.length; const avg = count ? scores.reduce((a,b)=>a+b,0)/count : 0; const variance = count > 1 ? scores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / count : 0; if(count) maxScoreAll = Math.max(maxScoreAll, ...scores);
            return { cls, count, avg, sd: Math.sqrt(variance), scores };
        });
        const allScores = stats.flatMap(s => s.scores); const gradeAvg = allScores.length ? allScores.reduce((a,b)=>a+b,0)/allScores.length : 0; const gradeVariance = allScores.length ? allScores.reduce((sum, score) => sum + Math.pow(score - gradeAvg, 2), 0) / allScores.length : 0; const gradeSD = Math.sqrt(gradeVariance);
        const maxBinCount = Math.max(...stats.map(s => { const bins = {}; s.scores.forEach(v => { const bin = Math.floor(v/step); bins[bin] = (bins[bin]||0)+1; }); return Math.max(...Object.values(bins)) || 1; }));
        let html = `<div class="info-bar" style="margin-bottom:10px;"><span style="font-weight:bold;">å‚è€ƒåŸºå‡†ï¼š</span> å…¨æ ¡å¹³å‡åˆ† ${gradeAvg.toFixed(1)}ï¼Œå…¨æ ¡æ ‡å‡†å·® (SD) <span style="font-weight:bold;">${gradeSD.toFixed(2)}</span></div><div class="table-wrap" id="diagnosisTable"><table><thead><tr><th>ç­çº§</th><th>äººæ•°</th><th>å¹³å‡åˆ†</th><th>æ ‡å‡†å·®(SD)</th><th>è¯Šæ–­ç»“è®º</th><th>æˆç»©åˆ†å¸ƒ (åŒºé—´: ${step}åˆ†)</th></tr></thead><tbody>`;
        stats.forEach(st => {
            let diagHtml = ''; const ratio = gradeSD ? st.sd / gradeSD : 1; if (ratio > 1.1) diagHtml = `<span class="diagnosis-tag diagnosis-bad">ä¸¤æåˆ†åŒ– (éœ€æŠ“ä¸¤å¤´)</span>`; else if (ratio < 0.9) diagHtml = `<span class="diagnosis-tag diagnosis-flat">é«˜åº¦é›†ä¸­ (éœ€æ•´ä½“æ‹”é«˜)</span>`; else diagHtml = `<span class="diagnosis-tag diagnosis-good">åˆ†å¸ƒæ­£å¸¸</span>`;
            const minVal = st.scores.length ? Math.min(...st.scores) : 0; const maxVal = st.scores.length ? Math.max(...st.scores) : 0; const minBin = Math.floor(minVal/step); const maxBin = Math.floor(maxVal/step); const bins = new Array(maxBin - minBin + 1).fill(0);
            st.scores.forEach(v => { const b = Math.floor(v/step) - minBin; if(b>=0 && b<bins.length) bins[b]++; });
            let barsHtml = `<div class="dist-bar-container">`; bins.forEach(count => { const h = Math.max((count / maxBinCount) * 100, 5); barsHtml += `<div class="dist-bar" style="height:${h}%;" title="äººæ•°: ${count}" data-count="${count}"></div>`; }); barsHtml += `</div><div style="font-size:10px; color:#999; text-align:center;">${minBin*step} - ${(maxBin+1)*step}åˆ†</div>`;
            html += `<tr><td>${st.cls}</td><td>${st.count}</td><td>${st.avg.toFixed(2)}</td><td style="font-family:monospace;font-weight:bold;">${st.sd.toFixed(2)}</td><td>${diagHtml}</td><td style="min-width:150px;">${barsHtml}</td></tr>`;
        });
        document.getElementById('diagnosis-results').innerHTML = html + `</tbody></table></div>`;
    }
    
    function exportDiagnosisExcel() {
        const table = document.querySelector('#diagnosisTable table'); if(!table) return alert("è¯·å…ˆç”Ÿæˆè¯Šæ–­è¡¨");
        const wb = XLSX.utils.book_new(); const wsData = [["ç­çº§", "äººæ•°", "å¹³å‡åˆ†", "æ ‡å‡†å·®(SD)", "è¯Šæ–­ç»“è®º"]];
        const rows = table.querySelectorAll('tbody tr'); rows.forEach(r => { const cols = r.querySelectorAll('td'); wsData.push([cols[0].innerText, parseInt(cols[1].innerText), parseFloat(cols[3].innerText), cols[4].innerText]); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "ç­æƒ…è¯Šæ–­"); XLSX.writeFile(wb, "ç­æƒ…è¯Šæ–­åˆ†æ.xlsx");
    }

    function exportCorrelationExcel() {
        const matrixTable = document.getElementById('corrMatrixTable'); const liftDragTable = document.getElementById('liftDragTable');
        if(!matrixTable || matrixTable.rows.length === 0) return alert("è¯·å…ˆç”Ÿæˆåˆ†æç»“æœ");
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(matrixTable), "ç›¸å…³æ€§çŸ©é˜µ"); XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(liftDragTable), "æåˆ†ä¸æ‹–åˆ†åˆ†æ"); XLSX.writeFile(wb, "å­¦ç§‘å…³è”æ·±åº¦åˆ†æ.xlsx");
    }

   function exportExcel(type) {
        if (!RAW_DATA.length) { alert('è¯·å…ˆä¸Šä¼ æ•°æ®'); return; }
        
        // 1. å¯¼å‡ºå1/3 (é€»è¾‘ä¸å˜)
        if (type === 'bottom3') {
            const table = document.getElementById('tb-bottom3'); 
            const wb = XLSX.utils.book_new(); 
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, "æ ¸ç®—ç»“æœ"); 
            XLSX.writeFile(wb, 'å1_3æ ¸ç®—ç»“æœ.xlsx');
            return;
        }

        // 2. å¯¼å‡ºæŒ‡æ ‡ç”Ÿ (é€»è¾‘æ›´æ–°ï¼šä»ç•Œé¢è¡¨æ ¼è·å–å¤ªéº»çƒ¦ï¼Œç›´æ¥é‡ç®—ä¸€éæˆ–è€…ä»DOMè§£æ)
        // ä¸ºäº†å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬è¿™é‡Œè§£æåˆšæ‰ç”Ÿæˆçš„è¡¨æ ¼ DOMï¼Œè¿™æ ·æ‰€è§å³æ‰€å¾—
        if (type === 'indicator') {
            const table = document.getElementById('tb-indicator');
            if(table.rows.length < 3) return alert("è¯·å…ˆç‚¹å‡»ã€å¼€å§‹è®¡ç®—ã€‘");

            const wb = XLSX.utils.book_new();
            
            // è‡ªå®šä¹‰è¡¨å¤´æ•°æ®ï¼Œå› ä¸ºDOMè¡¨å¤´æ˜¯åŒå±‚çš„ï¼Œç›´æ¥è½¬æ¢å¯èƒ½æ ¼å¼ä¸å¥½çœ‹
            const wsData = [];
            //è¿™ä¸€è¡Œæ˜¯åˆå¹¶åçš„é€»è¾‘è¡¨å¤´
            wsData.push(["å­¦æ ¡", 
                         "æŒ‡æ ‡ä¸€ç›®æ ‡", "æŒ‡æ ‡ä¸€è¾¾æ ‡", "æŒ‡æ ‡ä¸€åŸºç¡€åˆ†", "æŒ‡æ ‡ä¸€é™„åŠ åˆ†", "æŒ‡æ ‡ä¸€å°è®¡",
                         "æŒ‡æ ‡äºŒç›®æ ‡", "æŒ‡æ ‡äºŒè¾¾æ ‡", "æŒ‡æ ‡äºŒåŸºç¡€åˆ†", "æŒ‡æ ‡äºŒé™„åŠ åˆ†", "æŒ‡æ ‡äºŒå°è®¡",
                         "æŒ‡æ ‡æ€»åˆ†", "æ’å"]);

            // éå† tbody è·å–æ•°æ®
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const tds = tr.querySelectorAll('td');
                // è§£æ "ç›®æ ‡/è¾¾æ ‡" è¿™ç§æ ¼å¼
                const parseTargetReach = (str) => {
                    const parts = str.split('/');
                    return { t: parts[0].trim(), r: parts[1].trim() };
                };

                const ind1 = parseTargetReach(tds[1].innerText);
                const ind2 = parseTargetReach(tds[5].innerText);

                wsData.push([
                    tds[0].innerText, // å­¦æ ¡
                    ind1.t, ind1.r, tds[2].innerText, tds[3].innerText, tds[4].innerText, // æŒ‡æ ‡ä¸€
                    ind2.t, ind2.r, tds[6].innerText, tds[7].innerText, tds[8].innerText, // æŒ‡æ ‡äºŒ
                    tds[9].innerText, // æ€»åˆ†
                    tds[10].innerText // æ’å
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "æŒ‡æ ‡ç”Ÿæ ¸ç®—è¯¦ç»†");
            XLSX.writeFile(wb, 'æŒ‡æ ‡ç”Ÿæ ¸ç®—ç»“æœ(å«é™„åŠ åˆ†).xlsx');
        }
    }
    function downloadTemplate(type) {
        const wb = XLSX.utils.book_new();
        let headers = [];
        let sampleData = [];
        let filename = "æ¨¡æ¿.xlsx";
        let sheetName = "æˆç»©è¡¨";

        switch(type) {
            case 'primary':
                headers = ["å­¦æ ¡", "ç­çº§", "å§“å", "è€ƒå·", "è¯­æ–‡", "æ•°å­¦", "è‹±è¯­"];
                sampleData = [
                    ["å®éªŒå°å­¦", "601", "å¼ ä¸‰", "2024001", 95, 98, 92],
                    ["å®éªŒå°å­¦", "601", "æå››", "2024002", 88, 90, 85]
                ];
                filename = "å°å­¦æœŸæœ«è€ƒè¯•_æ ‡å‡†æ¨¡æ¿.xlsx";
                break;
            case 'junior':
                headers = ["å­¦æ ¡", "ç­çº§", "å§“å", "è€ƒå·", "è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "å†å²", "åœ°ç†", "ç”Ÿç‰©", "æ”¿æ²»"];
                sampleData = [
                    ["é•‡ä¸­", "801", "ç‹äº”", "2024101", 105, 110, 108, 85, 90, 88, 92, 80],
                    ["é•‡ä¸­", "801", "èµµå…­", "2024102", 98, 102, 95, 78, 85, 80, 88, 75]
                ];
                filename = "åˆä¸­æœˆè€ƒ_æ ‡å‡†æ¨¡æ¿.xlsx";
                break;
            case 'grade9':
                headers = ["å­¦æ ¡", "ç­çº§", "å§“å", "è€ƒå·", "è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "åŒ–å­¦", "æ”¿æ²»", "å†å²", "ä½“è‚²"];
                sampleData = [
                    ["ä¸€ä¸­", "901", "å­™ä¸ƒ", "2024901", 112, 115, 110, 68, 48, 55, 58, 40],
                    ["ä¸€ä¸­", "901", "å‘¨å…«", "2024902", 105, 108, 102, 60, 42, 50, 52, 38]
                ];
                filename = "ä¸­è€ƒä¸€æ¨¡_æ ‡å‡†æ¨¡æ¿.xlsx";
                break;
            case 'teacher':
                headers = ["ç­çº§", "å­¦ç§‘", "æ•™å¸ˆå§“å"];
                sampleData = [
                    ["701", "è¯­æ–‡", "å¼ è€å¸ˆ"],
                    ["701", "æ•°å­¦", "æè€å¸ˆ"],
                    ["702", "è¯­æ–‡", "å¼ è€å¸ˆ"],
                    ["702", "æ•°å­¦", "ç‹è€å¸ˆ"]
                ];
                filename = "æ•™å¸ˆä»»è¯¾ä¿¡æ¯_å¯¼å…¥æ¨¡æ¿.xlsx";
                sheetName = "ä»»è¯¾è¡¨";
                break;
        }

        const wsData = [headers, ...sampleData];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // è®¾ç½®åˆ—å®½ï¼Œè®©æ¨¡æ¿ç¨å¾®å¥½çœ‹ç‚¹
        ws['!cols'] = headers.map(() => ({ wch: 15 }));

        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, filename);
        
        if(window.UI) UI.toast(`âœ… å·²ä¸‹è½½ï¼š${filename}`, "success");
    }    
    // ================== æ–°ç”Ÿåˆ†ç­ & åº§ä½ç¼–æ’ ==================
    function FB_loadData(input) {
        const file = input.files[0]; if(!file) return; const reader= new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, {type: 'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(!json.length) throw new Error("Excelæ²¡æœ‰æ•°æ®");
                FB_STUDENTS = json.map((r, i) => {
                    const remarks = String(r['å¤‡æ³¨']||r['è¯´æ˜']||""); const sameMatch = remarks.match(/(?:å’Œ|ä¸|è·Ÿ)([\u4e00-\u9fa5\w]+)(?:åŒç­|ä¸€èµ·|ä¸€ç­)/); const diffMatch = remarks.match(/(?:å’Œ|ä¸|è·Ÿ)([\u4e00-\u9fa5\w]+)(?:åˆ†å¼€|ä¸åŒç­|ä¸åœ¨ä¸€èµ·)/);
                    return { _id: i, name: r['å§“å'] || 'æœªçŸ¥', gender: (r['æ€§åˆ«'] === 'ç”·' || r['Gender'] === 'M') ? 'M' : 'F', score: parseFloat(r['æ€»åˆ†'] || r['è¯­æ•°è‹±'] || 0), height: parseFloat(r['èº«é«˜'] || 160), vision: parseFloat(r['è§†åŠ›'] || r['å·¦çœ¼'] || 5.0), isDiff: (String(r['éš¾ç®¡']||"").includes('æ˜¯') || remarks.includes('éš¾ç®¡') || remarks.includes('è°ƒçš®')), remarks: remarks, constraints: { same: sameMatch ? [sameMatch[1]] : [], diff: diffMatch ? [diffMatch[1]] : [] }, classIdx: -1 };
                });
                alert(`âœ… å¯¼å…¥æˆåŠŸï¼å…± ${FB_STUDENTS.length} äººã€‚`); document.getElementById('fb-results-area').classList.add('hidden'); 
            } catch(err) { alert("è¯»å–å¤±è´¥ï¼š" + err.message); }
        }; reader.readAsArrayBuffer(file);
    }

    function calculateQuartiles(sortedData) {
        const q2 = calculateMedian(sortedData); const midIndex = Math.floor(sortedData.length / 2); const lowerHalf = sortedData.slice(0, midIndex); const upperHalf = sortedData.slice((sortedData.length % 2 === 0) ? midIndex : midIndex + 1); const q1 = calculateMedian(lowerHalf); const q3 = calculateMedian(upperHalf); return { q1, q2, q3 };
    }
    function calculateMedian(sortedData) { const mid = Math.floor(sortedData.length / 2); return sortedData.length % 2 !== 0 ? sortedData[mid] : (sortedData[mid - 1] + sortedData[mid]) / 2; }
    function calculateSD(data) { const n = data.length; if (n === 0) return 0; const mean = data.reduce((a, b) => a + b, 0) / n; const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n; return Math.sqrt(variance); }

     // 1. ä¸»å…¥å£ï¼šè¿è¡Œåˆ†ç­
    function FB_runDivision() {
        if(!FB_STUDENTS.length) return alert("è¯·å…ˆå¯¼å…¥æ•°æ®");
        
        // è·å–å‚æ•°
        const k = parseInt(document.getElementById('fb_cls_num').value) || 6; 
        const algo = document.getElementById('fb_algorithm').value;
        const btn = document.querySelector('button[onclick="FB_runDivision()"]');
        
        // UI åé¦ˆ
        btn.innerHTML = 'â³ æ­£åœ¨è¿ç®—å¤šå¥—æ–¹æ¡ˆ...';
        btn.disabled = true;

        // ä½¿ç”¨ setTimeout è®© UI æœ‰æœºä¼šæ¸²æŸ“ Loading çŠ¶æ€
        setTimeout(() => {
            FB_SCHEMES_CACHE = [];
            
            // å¦‚æœæ˜¯è›‡å½¢åˆ†ç­ï¼Œå› ä¸ºæ˜¯å›ºå®šçš„ï¼Œåªç”Ÿæˆ 1 å¥—
            // å¦‚æœæ˜¯æ™ºèƒ½ä¼˜åŒ–ï¼Œç”Ÿæˆ 3 å¥—ä¾›é€‰æ‹©
            const runs = (algo === 'snake') ? 1 : 3;

            for(let i = 0; i < runs; i++) {
                const classes = FB_generateSingleScheme(k, algo);
                // è®¡ç®—è¯¥æ–¹æ¡ˆçš„è¯„åˆ† (æå·®)
                const avgs = classes.map(c => c.stats.avg);
                const range = Math.max(...avgs) - Math.min(...avgs);
                const sd = calculateSD(avgs);
                
                FB_SCHEMES_CACHE.push({
                    id: i,
                    name: runs === 1 ? 'æ ‡å‡†æ–¹æ¡ˆ' : `æ–¹æ¡ˆ ${String.fromCharCode(65+i)}`, // æ–¹æ¡ˆA, æ–¹æ¡ˆB...
                    data: classes,
                    range: range,
                    sd: sd,
                    desc: `å‡åˆ†æå·® ${range.toFixed(2)}`
                });
            }

            // æ¢å¤æŒ‰é’®
            btn.innerHTML = 'ğŸš€ å¼€å§‹æ™ºèƒ½åˆ†ç­';
            btn.disabled = false;

            // æ¸²æŸ“æ–¹æ¡ˆé€‰æ‹©å™¨
            FB_renderSchemeSelector();
            
            // é»˜è®¤åº”ç”¨å‡åˆ†æå·®æœ€å°ï¼ˆæœ€å‡è¡¡ï¼‰çš„æ–¹æ¡ˆ
            const bestScheme = FB_SCHEMES_CACHE.sort((a,b) => a.range - b.range)[0];
            FB_applyScheme(bestScheme.id);
            
            // æ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('fb-results-area').classList.remove('hidden');
            if(runs > 1) {
                document.getElementById('fb-scheme-panel').classList.remove('hidden');
            } else {
                document.getElementById('fb-scheme-panel').classList.add('hidden');
            }

        }, 100);
    }

    // 2. æ ¸å¿ƒç®—æ³•ï¼šç”Ÿæˆå•æ¬¡æ–¹æ¡ˆ (æå–å‡ºæ¥çš„çº¯é€»è¾‘)
    function FB_generateSingleScheme(k, algo) {
        // åˆå§‹åŒ–ç©ºç­çº§
        let classes = Array.from({length: k}, (_, i) => ({ id: i, name: (i+1)+"ç­", students: [], stats: {} }));
        let pool = JSON.parse(JSON.stringify(FB_STUDENTS)); // æ·±æ‹·è´ï¼Œé˜²æ­¢æ±¡æŸ“
        
        // é¢„å¤„ç†ï¼šæŒ‰åˆ†æ•°æ’åº
        pool.sort((a,b) => b.score - a.score);

        if(algo === 'snake') {
            // --- è›‡å½¢åˆ†ç­ ---
            pool.forEach((s, i) => { 
                const round = Math.floor(i / k); 
                const target = (round % 2 === 0) ? (i % k) : (k - 1 - (i % k)); 
                classes[target].students.push(s); 
                s.classIdx = target; 
            });
        } else {
            // --- æ™ºèƒ½ä¼˜åŒ–åˆ†ç­ (åŸºäºæ¨¡æ‹Ÿé€€ç«æ€æƒ³çš„ç®€åŒ–ç‰ˆ) ---
            // A. åˆæ­¥è›‡å½¢åˆ†é…ä½œä¸ºåŸºå‡†
            pool.forEach((s, i) => { 
                const target = (Math.floor(i/k) % 2 === 0) ? (i % k) : (k - 1 - (i % k)); 
                classes[target].students.push(s); 
                s.classIdx = target; 
            });

            // B. éšæœºäº¤æ¢ä¼˜åŒ–
            const iterations = 8000; // å¢åŠ è¿­ä»£æ¬¡æ•°ä»¥è·å¾—ä¸åŒç»“æœ
            const globalAvg = pool.reduce((a,b)=>a+b.score,0) / pool.length;
            
            for(let i=0; i<iterations; i++) {
                const c1 = Math.floor(Math.random() * k); 
                const c2 = Math.floor(Math.random() * k); 
                if(c1 === c2) continue;
                
                const cls1 = classes[c1];
                const cls2 = classes[c2];
                if(!cls1.students.length || !cls2.students.length) continue;

                const idx1 = Math.floor(Math.random() * cls1.students.length); 
                const idx2 = Math.floor(Math.random() * cls2.students.length);

                const s1 = cls1.students[idx1]; 
                const s2 = cls2.students[idx2];

                // è®¡ç®—äº¤æ¢å‰çš„ä»£ä»· (æ–¹å·® + æ€§åˆ«å¹³è¡¡ + éš¾ç®¡åˆ†å¸ƒ)
                const costBefore = FB_calcClassCost(cls1, globalAvg) + FB_calcClassCost(cls2, globalAvg);
                
                // è¯•æ¢æ€§äº¤æ¢
                cls1.students[idx1] = s2; s2.classIdx = c1; 
                cls2.students[idx2] = s1; s1.classIdx = c2;

                const costAfter = FB_calcClassCost(cls1, globalAvg) + FB_calcClassCost(cls2, globalAvg);
                
                // æ£€æŸ¥ç¡¬æ€§çº¦æŸ (å¦‚: äº’æ–¥)
                let violate = false; 
                if(FB_checkConflict(s1, cls2.students) || FB_checkConflict(s2, cls1.students)) violate = true;

                // å†³ç­–ï¼šå¦‚æœä»£ä»·å˜é«˜äº†(æ›´ä¸å¹³è¡¡) æˆ–è€… è¿åçº¦æŸï¼Œåˆ™æ’¤é”€äº¤æ¢
                // (åŠ å…¥ä¸€ç‚¹ç‚¹éšæœºæ¥å—æ¦‚ç‡ä»¥è·³å‡ºå±€éƒ¨æœ€ä¼˜ï¼Œä½†è¿™é‡Œä¸ºäº†ç¨³å®šç®€åŒ–å¤„ç†)
                if(violate || costAfter > costBefore) { 
                    // æ’¤é”€
                    cls1.students[idx1] = s1; s1.classIdx = c1; 
                    cls2.students[idx2] = s2; s2.classIdx = c2; 
                }
            }
        }

        // è¿™é‡Œçš„è®¡ç®—æ˜¯ä¸ºäº† statsï¼Œæ–¹ä¾¿å¤–éƒ¨ç­›é€‰
        classes.forEach(c => {
            const n = c.students.length;
            const total = c.students.reduce((a,b)=>a+b.score,0);
            c.stats.avg = n ? total/n : 0;
            c.stats.male = c.students.filter(s=>s.gender==='M').length;
            c.stats.count = n;
        });

        return classes;
    }

    // 3. æ¸²æŸ“æ–¹æ¡ˆé€‰æ‹©å¡ç‰‡
    function FB_renderSchemeSelector() {
        const container = document.getElementById('fb-scheme-cards');
        container.innerHTML = '';
        
        FB_SCHEMES_CACHE.forEach(scheme => {
            // ç®€å•çš„è¯„åˆ†é€»è¾‘
            const isBest = (scheme.range <= FB_SCHEMES_CACHE[0].range); // å‡è®¾å·²æ’åº
            const borderStyle = isBest ? 'border:2px solid #16a34a; background:#fff;' : 'border:1px solid #ddd; background:#fff;';
            
            // æ‰¾å‡ºè¯¥æ–¹æ¡ˆä¸­ç”·å¥³æ¯”ä¾‹æå·®
            const males = scheme.data.map(c => c.stats.male);
            const maleRange = Math.max(...males) - Math.min(...males);

            container.innerHTML += `
                <div onclick="FB_applyScheme(${scheme.id})" style="cursor:pointer; padding:10px; border-radius:6px; ${borderStyle} transition:0.2s;" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background='#fff'">
                    <div style="font-weight:bold; color:#333; display:flex; justify-content:space-between;">
                        <span>${scheme.name}</span>
                        ${isBest ? '<span style="color:red; font-size:10px;">â˜… æ¨è</span>' : ''}
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:5px;">
                        <div>å‡åˆ†æå·®: <strong>${scheme.range.toFixed(2)}</strong></div>
                        <div>ç”·å¥³æå·®: ${maleRange} äºº</div>
                    </div>
                </div>
            `;
        });
    }

    // 4. åº”ç”¨é€‰ä¸­çš„æ–¹æ¡ˆ
    function FB_applyScheme(id) {
        const scheme = FB_SCHEMES_CACHE.find(s => s.id === id);
        if(!scheme) return;
        
        // æ›´æ–°å…¨å±€å˜é‡
        FB_CLASSES = scheme.data;
        FB_SIMULATED_DATA = {}; 
        FB_CLASSES.forEach(c => FB_SIMULATED_DATA[c.name] = c.students);
        
        // æ¸²æŸ“åŸæœ‰ä»ªè¡¨ç›˜
        FB_renderDashboard();
        
        // é«˜äº®é€‰ä¸­çš„å¡ç‰‡
        const cards = document.getElementById('fb-scheme-cards').children;
        Array.from(cards).forEach((card, idx) => {
            if(scheme.id === FB_SCHEMES_CACHE[idx].id) { // æ³¨æ„ï¼šè¿™é‡Œç®€å•æŒ‰ç´¢å¼•å¯¹åº”ï¼Œå®é™…ä¸ŠæŒ‰IDåŒ¹é…æ›´ç¨³
                card.style.borderColor = '#16a34a';
                card.style.boxShadow = '0 0 0 3px rgba(22, 163, 74, 0.2)';
            } else {
                card.style.borderColor = '#ddd';
                card.style.boxShadow = 'none';
            }
        });
    }

    function FB_calcClassCost(cls, gAvg) {
        const n = cls.students.length; if(n===0) return 10000; const avg = cls.students.reduce((a,b)=>a+b.score,0) / n; const male = cls.students.filter(s=>s.gender==='M').length; 
        const diff = cls.students.filter(s=>(s.isDiff || s._isDiff)).length;
        let cost = Math.pow(avg - gAvg, 2) * 100; cost += Math.pow((male/n) - 0.5, 2) * 5000; 
        if(document.getElementById('fb_rule_diff').value === 'spread') { cost += Math.pow(diff, 2) * 500; } return cost;
    }

    function FB_checkConflict(stu, targetArr) { 
        if(!stu.constraints) return false;
        for(let name of stu.constraints.diff) { if(targetArr.find(s => s.name === name)) return true; } 
        return false; 
    }

    function FB_renderDashboard() {
        document.getElementById('fb-results-area').classList.remove('hidden'); const container = document.getElementById('fb_class_container'); container.innerHTML = '';
        let allAvgs = [], tMale = 0, tFemale = 0, totalDiffCnt = 0;
        FB_CLASSES.forEach(c => {
            const n = c.students.length; const total = c.students.reduce((a,b)=>a+b.score,0); const avg = n ? total/n : 0; const male = c.students.filter(s=>s.gender==='M').length; 
            const diffCnt = c.students.filter(s=>(s.isDiff || s._isDiff)).length;
            allAvgs.push(avg); tMale += male; tFemale += (n-male); totalDiffCnt += diffCnt; c.stats = { avg, male, female: n-male, count: n }; const isWarn = diffCnt > 3; 
            container.innerHTML += `<div class="fb-class-box ${isWarn?'fb-warn-bg':''}" onclick="FB_openSeatMap(${c.id})"><div class="fb-c-head"><span style="font-weight:bold; font-size:16px;">${c.name}</span><span class="fb-tag fb-tag-red" style="${diffCnt>0?'':'display:none'}">éš¾ç®¡: ${diffCnt}</span></div><div class="fb-c-body"><div>äººæ•°: <strong>${n}</strong></div><div>å‡åˆ†: <strong>${avg.toFixed(1)}</strong></div><div>ç”·ç”Ÿ: ${male}</div><div>å¥³ç”Ÿ: ${n-male}</div><div style="grid-column:span 2; font-size:11px; color:#999; margin-top:5px;">ç‚¹å‡»è¿›å…¥åº§ä½ç¼–æ’ â†’</div></div></div>`;
        });
        const range = Math.max(...allAvgs) - Math.min(...allAvgs);
        document.getElementById('fb_res_total').innerText = FB_STUDENTS.length; document.getElementById('fb_res_male').innerText = tMale; document.getElementById('fb_res_female').innerText = tFemale; document.getElementById('fb_res_diff').innerText = range.toFixed(2); document.getElementById('fb_res_diff_cnt').innerText = totalDiffCnt;
        const evalEl = document.getElementById('fb_res_eval');
        if(range <= 1.0) evalEl.innerHTML = '<span style="color:green;font-weight:bold;">âœ… å®Œç¾å‡è¡¡</span>'; else if(range <= 3.0) evalEl.innerHTML = '<span style="color:#d97706;font-weight:bold;">âš ï¸ åŸºæœ¬å‡è¡¡</span>'; else evalEl.innerHTML = '<span style="color:red;font-weight:bold;">âŒ å·®å¼‚è¿‡å¤§</span>';
        FB_renderBalanceChart();
    }

    function FB_renderBalanceChart() {
        const ctx = document.getElementById('balanceChart'); const tableContainer = document.getElementById('balanceTableContainer'); const labels = FB_CLASSES.map(c => c.name);
        const statsData = FB_CLASSES.map(c => { const scores = c.students.map(s => s.score).sort((a,b)=>a-b); const qs = calculateQuartiles(scores); return { min: scores[0], max: scores[scores.length-1], q1: qs.q1, median: qs.q2, q3: qs.q3, avg: c.stats.avg, sd: calculateSD(scores) }; });
        if (balanceChartInstance) balanceChartInstance.destroy();
        balanceChartInstance = new Chart(ctx, {
            type: 'bar', data: { labels: labels, datasets: [ { label: 'å¹³å‡åˆ†', data: statsData.map(s => s.avg), type: 'scatter', backgroundColor: '#2563eb', borderColor: '#2563eb', pointStyle: 'rectRot', pointRadius: 6 }, { label: 'åˆ†æ•°åŒºé—´ (Min-Max)', data: statsData.map(s => [s.min, s.max]), backgroundColor: 'rgba(156, 163, 175, 0.2)', borderColor: 'rgba(156, 163, 175, 0.5)', borderWidth: 1, barPercentage: 0.1 }, { label: 'æ ¸å¿ƒåˆ†å¸ƒ (Q1-Q3)', data: statsData.map(s => [s.q1, s.q3]), backgroundColor: 'rgba(37, 99, 235, 0.5)', borderColor: '#1e40af', borderWidth: 1, barPercentage: 0.6 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: function(context) { const s = statsData[context.dataIndex]; if(context.dataset.type === 'scatter') return `å¹³å‡åˆ†: ${s.avg.toFixed(2)}`; if(context.datasetIndex === 1) return `èŒƒå›´: ${s.min} - ${s.max}`; if(context.datasetIndex === 2) return `æ ¸å¿ƒåŒºé—´: ${s.q1} - ${s.q3}`; } } }, title: { display: true, text: 'ç­çº§åˆ†æ•°ç»“æ„å¯¹æ¯” (ç®±çº¿å›¾)' } }, scales: { y: { beginAtZero: false, title: { display: true, text: 'åˆ†æ•°' } } } }
        });
        let tableHtml = `<table class="comparison-table" style="font-size:12px;"><thead><tr><th>ç­çº§</th><th>äººæ•°</th><th>å¹³å‡åˆ†</th><th>æ ‡å‡†å·® (SD)</th><th>æå·® (Max-Min)</th><th>å‰25%çº¿ (Q3)</th><th>å25%çº¿ (Q1)</th></tr></thead><tbody>`;
        statsData.forEach((s, i) => { tableHtml += `<tr><td>${labels[i]}</td><td>${FB_CLASSES[i].students.length}</td><td>${s.avg.toFixed(2)}</td><td>${s.sd.toFixed(2)}</td><td>${(s.max - s.min).toFixed(1)}</td><td>${s.q3}</td><td>${s.q1}</td></tr>`; });
        tableContainer.innerHTML = tableHtml + `</tbody></table>`;
    }

    const HistoryManager = {
        past: [],   // è¿‡å»çš„çŠ¶æ€æ ˆ
        future: [], // æœªæ¥çš„çŠ¶æ€æ ˆ (ä¾›é‡åš)
        limit: 20,  // æœ€å¤šè®°å½•20æ­¥ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º

        // 1. è®°å½•å½“å‰çŠ¶æ€ (åœ¨ä¿®æ”¹æ•°æ®å‰è°ƒç”¨)
        record: function() {
            // æ·±æ‹·è´å½“å‰ç­çº§æ•°æ® (FB_CLASSES)
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªè®°å½•å½“å‰æ­£åœ¨æ“ä½œçš„ç­çº§ï¼Œä»¥èŠ‚çœå†…å­˜
            if (FB_CUR_CLASS_IDX === -1) return;
            
            const currentClassData = FB_CLASSES[FB_CUR_CLASS_IDX];
            const snapshot = JSON.parse(JSON.stringify(currentClassData));
            
            this.past.push(snapshot);
            if (this.past.length > this.limit) this.past.shift(); // è¶…è¿‡é™åˆ¶åˆ æœ€æ—©çš„
            
            this.future = []; // ä¸€æ—¦æœ‰æ–°æ“ä½œï¼Œæ¸…ç©ºæœªæ¥æ ˆ
            this.updateUI();
        },

        // 2. æ‰§è¡Œæ’¤é”€
        undo: function() {
            if (this.past.length === 0) return;
            
            // A. æŠŠå½“å‰çŠ¶æ€æ¨å…¥æœªæ¥æ ˆ
            const current = JSON.parse(JSON.stringify(FB_CLASSES[FB_CUR_CLASS_IDX]));
            this.future.push(current);
            
            // B. ä»è¿‡å»æ ˆå–å‡ºä¸Šä¸€ä¸ªçŠ¶æ€
            const previous = this.past.pop();
            FB_CLASSES[FB_CUR_CLASS_IDX] = previous;
            
            // C. åˆ·æ–°è§†å›¾
            this.refreshView("å·²æ’¤é”€ â†©");
        },

        // 3. æ‰§è¡Œé‡åš
        redo: function() {
            if (this.future.length === 0) return;
            
            // A. æŠŠå½“å‰çŠ¶æ€æ¨å…¥è¿‡å»æ ˆ
            const current = JSON.parse(JSON.stringify(FB_CLASSES[FB_CUR_CLASS_IDX]));
            this.past.push(current);
            
            // B. ä»æœªæ¥æ ˆå–å‡ºä¸‹ä¸€ä¸ªçŠ¶æ€
            const next = this.future.pop();
            FB_CLASSES[FB_CUR_CLASS_IDX] = next;
            
            // C. åˆ·æ–°è§†å›¾
            this.refreshView("å·²é‡åš â†ª");
        },

        // 4. è¾…åŠ©ï¼šåˆ·æ–°ç•Œé¢å’ŒæŒ‰é’®çŠ¶æ€
        refreshView: function(msg) {
            FB_renderSeatMap(); // é‡ç»˜åº§ä½è¡¨
            this.updateUI();
            UI.toast(msg, 'info'); // æç¤ºç”¨æˆ·
        },

        updateUI: function() {
            const btnUndo = document.getElementById('btn_undo');
            const btnRedo = document.getElementById('btn_redo');
            if(btnUndo) {
                btnUndo.disabled = (this.past.length === 0);
                btnUndo.className = this.past.length > 0 ? "btn btn-primary" : "btn btn-gray";
            }
            if(btnRedo) {
                btnRedo.disabled = (this.future.length === 0);
                btnRedo.className = this.future.length > 0 ? "btn btn-primary" : "btn btn-gray";
            }
        },
        
        // 5. åˆå§‹åŒ–/æ¸…ç©º
        reset: function() {
            this.past = [];
            this.future = [];
            this.updateUI();
        }
    };

    function FB_openSeatMap(clsId) {
        HistoryManager.reset(); 
        FB_CUR_CLASS_IDX = clsId; const cls = FB_CLASSES[clsId]; document.getElementById('seat_class_title').innerText = cls.name;
        document.getElementById('fb_seat_view').classList.remove('hidden'); document.getElementById('fb_seat_view').scrollIntoView({behavior:'smooth'});
        updateConstraintWidgetsContext('fb'); // è”åŠ¨æ›´æ–°
        if(!cls.seatLayout) { FB_autoSeatAlgo(); } else { FB_renderSeatMap(); }
          FB_initScenarioSelect(); // <--- è®°å¾—åŠ ä¸Šè¿™å¥
    }

   // --- å®¶é•¿æŸ¥åˆ†è½»é‡åŒ…ç”Ÿæˆå™¨ (ä¸¥æ ¼éªŒè¯ç‰ˆï¼šå¿…é¡»è¾“å…¥ å¯†ç +ç­çº§+å§“å) ---
    function generateInquiryPackage() {
        const sch = document.getElementById('studentSchoolSelect').value;
        if (!sch || sch.includes('è¯·é€‰æ‹©')) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­¦æ ¡ï¼Œç³»ç»Ÿå°†ç”Ÿæˆè¯¥æ ¡çš„æŸ¥åˆ†åŒ…ã€‚");
        
        // 1. å‡†å¤‡æ•°æ®
        const schoolStudents = SCHOOLS[sch].students;
        if (!schoolStudents || schoolStudents.length === 0) return alert("è¯¥å­¦æ ¡æ— æ•°æ®");

        // åˆ¤æ–­æ˜¯å¦åªæœ‰ä¸€æ‰€å­¦æ ¡ (ç”¨äºæ§åˆ¶æ˜¾ç¤ºçš„æ’åç±»å‹)
        const isSingleSchool = Object.keys(SCHOOLS).length <= 1;

        const gradeStats = {};
        SUBJECTS.forEach(sub => {
            const scores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            if (scores.length > 0) {
                const sum = scores.reduce((a, b) => a + b, 0);
                const avg = sum / scores.length;
                const variance = scores.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / scores.length;
                gradeStats[sub] = { avg: avg, sd: Math.sqrt(variance) };
            } else {
                gradeStats[sub] = { avg: 0, sd: 1 };
            }
        });

        // 2. æ•°æ®æ‰“åŒ…
        const secureData = {};
        
        schoolStudents.forEach(stu => {
            // ç”Ÿæˆå”¯ä¸€ Key: ç­çº§_å§“å (ä¾‹å¦‚: 701_å¼ ä¸‰)
            // å»é™¤æ‰€æœ‰ç©ºæ ¼ï¼Œç¡®ä¿åŒ¹é…å‡†ç¡®
            const key = (stu.class + "_" + stu.name).replace(/\s+/g, "");
            
            const scoresSimple = {};

            const radarData = { labels: [], data: [] }; // é›·è¾¾å›¾æ•°æ®
            const varianceData = { labels: [], data: [] }; // å‡è¡¡åº¦æ•°æ®
            
            SUBJECTS.forEach(sub => {
                if(stu.scores[sub] !== undefined) {
                    scoresSimple[sub] = [
                        stu.scores[sub],
                        safeGet(stu, `ranks.${sub}.school`, '-'),
                        safeGet(stu, `ranks.${sub}.township`, '-')
                    ];

                    // A. è®¡ç®—é›·è¾¾å›¾æ•°æ® (ç™¾åˆ†ä½)
                    // é€»è¾‘å¤ç”¨ renderRadarChart ä¸­çš„ç®—æ³•
                    const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => v !== undefined).sort((a, b) => b - a);
                    const rank = allScores.indexOf(stu.scores[sub]) + 1;
                    const total = allScores.length;
                    const percentile = ((1 - (rank / total)) * 100).toFixed(1);
                    radarData.labels.push(sub);
                    radarData.data.push(percentile);

                    // B. è®¡ç®—å‡è¡¡åº¦æ•°æ® (Z-Score)
                    const stats = gradeStats[sub];
                    let z = 0;
                    if (stats && stats.sd > 0) {
                        z = (stu.scores[sub] - stats.avg) / stats.sd;
                    }
                    varianceData.labels.push(sub);
                    varianceData.data.push(parseFloat(z.toFixed(2)));
                }
            });

            // C. è·å–æˆ–ç”Ÿæˆè¯„è¯­
            // ä¼˜å…ˆä»æ‰¹é‡ç”Ÿæˆç¼“å­˜ä¸­å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç°åœºç”Ÿæˆä¸€æ¡ç®€å•çš„
            const cacheKey = `${stu.school}_${stu.class}_${stu.name}`;
            const aiComment = BATCH_AI_CACHE[cacheKey] || generateAIComment(stu);
            
            secureData[key] = {
                cls: stu.class,  // å­˜å‚¨ç­çº§
                name: stu.name,  // å­˜å‚¨å§“å
                s: scoresSimple, 
                t: stu.total,    
                tr: safeGet(stu, 'ranks.total.township', '-'), 
                sr: safeGet(stu, 'ranks.total.school', '-'),   
                cr: safeGet(stu, 'ranks.total.class', '-'), 

                rd: radarData,   // Radar Data
                vd: varianceData,// Variance Data
                cm: aiComment    // Comment

            };
        });

        // 3. æç¤ºè®¾ç½®è®¿é—®å¯†ç 
        const password = prompt(`ğŸ” å®‰å…¨è®¾ç½®\n\nè¯·è®¾ç½®ä¸€ä¸ªâ€œè®¿é—®å¯†ç â€ (ä¾‹å¦‚: 123456)ã€‚\n\nå®¶é•¿æŸ¥è¯¢æ—¶è¦æ±‚ï¼š\n1. è¾“å…¥æ­¤å¯†ç \n2. è¾“å…¥å‡†ç¡®çš„ç­çº§\n3. è¾“å…¥å‡†ç¡®çš„å§“å`, "123456");
        
        if (password === null) return; 
        if (!password) return alert("âŒ å¿…é¡»è®¾ç½®å¯†ç æ‰èƒ½ç”Ÿæˆå®‰å…¨æŸ¥åˆ†åŒ…ï¼");

        // ä½¿ç”¨ CryptoJS è¿›è¡Œ AES åŠ å¯†
        const jsonStr = JSON.stringify(secureData);
        const encryptedData = CryptoJS.AES.encrypt(jsonStr, password).toString();

        // 4. æ„å»ºç‹¬ç«‹çš„ HTML æ¨¡æ¿ (åŒ…å«ç­çº§è¾“å…¥æ¡†)
        const examName = CONFIG.name || "æœŸä¸­è€ƒè¯•";
        const genDate = new Date().toLocaleDateString();
        
        const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${sch} - æˆç»©æŸ¥è¯¢</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    .container { max-width: 420px; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #2563eb; margin-bottom: 5px; font-size: 20px; }
    .sub-title { text-align: center; color: #666; font-size: 12px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
    input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition:0.3s; }
    input:focus { border-color: #2563eb; outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    button { width: 100%; background: #2563eb; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:active { transform: scale(0.98); }
    
    .password-section { background: #fffbeb; padding: 10px; border-radius: 8px; border: 1px solid #fcd34d; margin-bottom: 15px; }
    .password-section label { color: #b45309; }

    /* ç»“æœå¡ç‰‡æ ·å¼ */
    .result-box { margin-top: 20px; display: none; animation: fadeIn 0.3s; }
    .score-card { background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .head-section { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 20px; text-align: center; }
    .total-val { font-size: 36px; font-weight: 800; line-height: 1; margin-bottom: 5px; }
    .total-lbl { font-size: 12px; opacity: 0.9; }
    .stu-info-bar { background: rgba(0,0,0,0.1); padding: 4px 10px; border-radius: 20px; font-size: 12px; display: inline-block; margin-bottom: 10px; }
    .rank-bar { display: flex; background: #eff6ff; border-bottom: 1px solid #dbeafe; padding: 10px 0; }
    .rank-item { flex: 1; text-align: center; border-right: 1px solid #dbeafe; }
    .rank-item:last-child { border-right: none; }
    .rank-val { font-weight: bold; color: #1e40af; font-size: 15px; }
    .rank-lbl { font-size: 10px; color: #64748b; }
    .sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #f8fafc; }
    .sub-item { background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .sub-main { display: flex; flex-direction: column; }
    .sub-name { font-size: 13px; color: #64748b; font-weight: bold; }
    .sub-val { font-size: 18px; font-weight: 800; color: #333; margin-top: 2px; }
    .sub-ranks { text-align: right; font-size: 11px; color: #94a3b8; display: flex; flex-direction: column; gap: 2px; }
    .tag-rank { background: #f1f5f9; padding: 1px 4px; border-radius: 3px; }
    .footer { text-align: center; margin-top: 30px; font-size: 11px; color: #ccc; }

    .chart-box { background:white; border-radius:10px; padding:15px; margin-bottom:15px; border:1px solid #e2e8f0; position:relative; min-height:220px; }
    .chart-title { font-size:13px; font-weight:bold; color:#475569; margin-bottom:10px; border-left:4px solid #2563eb; padding-left:8px; }
    .comment-box { background:#f0fdf4; border:1px solid #bbf7d0; border-radius:10px; padding:15px; margin-bottom:15px; position:relative; }
    .comment-title { font-weight:bold; color:#166534; font-size:14px; margin-bottom:8px; display:flex; align-items:center; gap:5px; }
    .comment-text { font-size:13px; color:#333; line-height:1.6; white-space: pre-wrap; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div class="container">
    <h2>${sch} æˆç»©æŸ¥è¯¢</h2>
    <div class="sub-title">${examName} | å‘å¸ƒæ—¥æœŸ: ${genDate}</div>
    
    <div class="password-section">
        <label>ğŸ” è®¿é—®å¯†ç  (ç”±è€å¸ˆæä¾›)</label>
        <input type="password" id="inpPass" placeholder="è¯·è¾“å…¥æŸ¥çœ‹å¯†ç ">
    </div>

    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ æ¢å¤ï¼šç­çº§è¾“å…¥æ¡† (å¿…å¡«) ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
    <div class="form-group">
        <label>ç­çº§</label>
        <input type="text" id="inpClass" placeholder="è¯·è¾“å…¥ç­çº§ (å¦‚: 701)">
    </div>

    <div class="form-group">
        <label>å­¦ç”Ÿå§“å</label>
        <input type="text" id="inpName" placeholder="è¯·è¾“å…¥å§“å (å¦‚: å¼ ä¸‰)">
    </div>
    
    <button onclick="doSearch()">ğŸ”“ è§£å¯†å¹¶æŸ¥è¯¢</button>

    <div id="resultArea" class="result-box"></div>
</div>
<div class="footer">AES 256ä½ç«¯å¯¹ç«¯åŠ å¯†<br>ä»…é™æŸ¥è¯¢æœ¬äººæˆç»©</div>

<script>
    const PAYLOAD = "${encryptedData}";
    const IS_SINGLE_SCHOOL = ${isSingleSchool}; 

    let radarInst = null;
    let varInst = null;
    
    function doSearch() {
        const pass = document.getElementById('inpPass').value.trim();
        const cls = document.getElementById('inpClass').value.trim();
        const name = document.getElementById('inpName').value.trim();
        const resBox = document.getElementById('resultArea');
        
        if(!pass) return alert("âŒ è¯·è¾“å…¥è®¿é—®å¯†ç ");
        if(!cls) return alert("âŒ è¯·è¾“å…¥ç­çº§");
        if(!name) return alert("âŒ è¯·è¾“å…¥å­¦ç”Ÿå§“å");
        
        let allData = null;

        // 1. è§£å¯†æ•°æ®
        try {
            if (typeof CryptoJS === 'undefined') return alert("âš ï¸ åŠ è½½ä¸­ï¼Œè¯·ç¨åé‡è¯•...");
            const bytes = CryptoJS.AES.decrypt(PAYLOAD, pass);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            if (!originalText) throw new Error("å¯†ç é”™è¯¯");
            allData = JSON.parse(originalText);
        } catch(e) {
            return alert("â›” è®¿é—®æ‹’ç»ï¼šå¯†ç é”™è¯¯ï¼");
        }

        // 2. ç²¾ç¡®æŸ¥æ‰¾ (ç­çº§ + å§“å å¿…é¡»å®Œå…¨åŒ¹é…)
        // æ„é€  Keyï¼šå°†ç”¨æˆ·è¾“å…¥çš„ç­çº§å’Œå§“åæ‹¼æ¥ï¼Œå¹¶å»é™¤ç©ºæ ¼ (ä¾‹å¦‚ "701_å¼ ä¸‰")
        const key = (cls + "_" + name).replace(/\\s+/g, "");
        const res = allData[key];

        // 3. æ¸²æŸ“ç»“æœ
        resBox.innerHTML = '';
        
        if(!res) {
            alert("âŒ æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯ï¼\\nè¯·æ£€æŸ¥ã€ç­çº§ã€‘å’Œã€å§“åã€‘æ˜¯å¦è¾“å…¥æ­£ç¡®ã€‚\\n(ç­çº§å¦‚ï¼š701)");
        } else {
            let subHtml = '';
            for(let sub in res.s) {
                const item = res.s[sub];
                let rankHtml = '<span class="tag-rank">æ ¡: ' + item[1] + '</span>';
                if (!IS_SINGLE_SCHOOL) rankHtml += '<span class="tag-rank">é•‡: ' + item[2] + '</span>';
                subHtml += 
                    '<div class="sub-item">' +
                        '<div class="sub-main"><div class="sub-name">' + sub + '</div><div class="sub-val">' + item[0] + '</div></div>' +
                        '<div class="sub-ranks">' + rankHtml + '</div>' +
                    '</div>';
            }
            
            let totalRankHtml = 
                '<div class="rank-item"><div class="rank-val">' + res.cr + '</div><div class="rank-lbl">ç­æ’</div></div>' +
                '<div class="rank-item"><div class="rank-val">' + res.sr + '</div><div class="rank-lbl">æ ¡æ’</div></div>';
            if (!IS_SINGLE_SCHOOL) totalRankHtml += '<div class="rank-item"><div class="rank-val">' + res.tr + '</div><div class="rank-lbl">é•‡æ’</div></div>';

            // æ³¨æ„ï¼šCanvas éœ€è¦å›ºå®šé«˜åº¦
            const chartsHtml = \`
                <div class="comment-box">
                    <div class="comment-title">ğŸ‘©â€ğŸ« ç­ä¸»ä»»è¯„è¯­</div>
                    <div class="comment-text">\${res.cm || 'æš‚æ— è¯„è¯­'}</div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-title">ğŸ“Š å­¦ç§‘èƒ½åŠ›åˆ†å¸ƒ (é›·è¾¾å›¾)</div>
                    <div style="height:200px; position:relative;">
                        <canvas id="mobRadarChart"></canvas>
                    </div>
                </div>

                <div class="chart-box">
                    <div class="chart-title">âš–ï¸ å­¦ç§‘å‡è¡¡åº¦è¯Šæ–­ (æ ‡å‡†åˆ†)</div>
                    <div style="height:200px; position:relative;">
                        <canvas id="mobVarChart"></canvas>
                    </div>
                    <div style="font-size:10px; color:#999; text-align:center; margin-top:5px;">
                        æ³¨: æŸ±å­æœä¸Šä¸ºä¼˜åŠ¿ç§‘ç›®ï¼Œæœä¸‹ä¸ºå¼±åŠ¿ç§‘ç›®
                    </div>
                </div>
            \`;

            resBox.innerHTML = 
                '<div class="score-card">' +
                    '<div class="head-section">' +
                        '<div class="stu-info-bar">' + res.cls + 'ç­ Â· ' + res.name + '</div>' +
                        '<div class="total-val">' + res.t + '</div>' +
                        '<div class="total-lbl">æ€»åˆ†</div>' +
                    '</div>' +
                    '<div class="rank-bar">' + totalRankHtml + '</div>' +
                    '<div class="sub-grid">' + subHtml + '</div>' +
                '</div>' + 
                '<div style="text-align:center; color:green; font-size:12px; margin-top:10px;">âœ… æŸ¥è¯¢æˆåŠŸ</div>';
            
            resBox.style.display = 'block';

            setTimeout(() => {
                // 1. ç»˜åˆ¶é›·è¾¾å›¾
                if (radarInst) radarInst.destroy();
                const ctxRadar = document.getElementById('mobRadarChart');
                if (ctxRadar && res.rd) {
                    radarInst = new Chart(ctxRadar, {
                        type: 'radar',
                        data: {
                            labels: res.rd.labels,
                            datasets: [{
                                label: 'èƒ½åŠ›å€¼',
                                data: res.rd.data,
                                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                borderColor: '#2563eb',
                                pointBackgroundColor: '#2563eb'
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: { r: { min: 0, max: 100, ticks: { display: false }, pointLabels: { font: { size: 10 } } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                // 2. ç»˜åˆ¶å‡è¡¡åº¦æŸ±çŠ¶å›¾
                if (varInst) varInst.destroy();
                const ctxVar = document.getElementById('mobVarChart');
                if (ctxVar && res.vd) {
                    const colors = res.vd.data.map(v => v >= 0 ? '#16a34a' : '#dc2626');
                    varInst = new Chart(ctxVar, {
                        type: 'bar',
                        data: {
                            labels: res.vd.labels,
                            datasets: [{
                                label: 'æ ‡å‡†åˆ†',
                                data: res.vd.data,
                                backgroundColor: colors,
                                borderRadius: 3
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y', // æ¨ªå‘æŸ±çŠ¶å›¾æ›´é€‚åˆæ‰‹æœºæŸ¥çœ‹é•¿æ ‡ç­¾
                            scales: { 
                                x: { grid: { display: true }, title: {display:true, text:'â† å¼±åŠ¿ | å¼ºåŠ¿ â†’'} },
                                y: { grid: { display: false } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, 100);

        }
    }
<\/script>
</body>
</html>`;

        // 5. ä¸‹è½½æ–‡ä»¶
        const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${sch}_æŸ¥åˆ†åŒ…_${new Date().getTime()}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert("âœ… åŠ å¯†æŸ¥åˆ†åŒ…å·²ç”Ÿæˆï¼\næ–‡ä»¶åï¼š" + link.download + "\nè®¿é—®å¯†ç ï¼š" + password + "\n\nè¯·å°†æ–‡ä»¶å‘ç»™å®¶é•¿ï¼Œå‘ŠçŸ¥å¯†ç ã€‚\nå®¶é•¿å¿…é¡»è¾“å…¥æ­£ç¡®çš„ [ç­çº§] å’Œ [å§“å] æ‰èƒ½æŸ¥è¯¢ã€‚");
    }
    
     // --- ç­çº§åˆ†æä¼š PPT ç”Ÿæˆå™¨ (ä¿®å¤å›¾è¡¨æ•°æ®ç»“æ„) ---
    async function generateClassPPT() {
        // 1. æ£€æŸ¥åº“
        if (typeof PptxGenJS === 'undefined') {
            return alert("âŒ é”™è¯¯ï¼šç¼ºå°‘ PPT ç”Ÿæˆåº“ã€‚\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½åŠ è½½ cdn.jsdelivr.netã€‚");
        }

        const sch = document.getElementById('studentSchoolSelect').value;
        const cls = document.getElementById('studentClassSelect').value;
        
        if (!sch || sch.includes('è¯·é€‰æ‹©')) return alert("è¯·å…ˆé€‰æ‹©ã€å­¦æ ¡ã€‘ï¼");
        if (!cls || cls === 'å…¨éƒ¨' || cls.includes('è¯·é€‰æ‹©')) return alert("è¯·å…ˆé€‰æ‹©ã€å…·ä½“ç­çº§ã€‘ï¼");

        const students = RAW_DATA.filter(s => s.school === sch && s.class === cls);
        if (students.length === 0) return alert("è¯¥ç­çº§æ²¡æœ‰æ•°æ®ï¼");

        try {
            // --- æ•°æ®å‡†å¤‡ ---
            students.sort((a,b) => b.total - a.total);
            const count = students.length;
            const avg = students.reduce((a,b) => a + b.total, 0) / count;
            const maxScore = students[0].total;
            const minScore = students[students.length - 1].total;
            
            // è·å–å¹´çº§æ•°æ® (ç”¨äºå¯¹æ¯”)
            const schoolData = SCHOOLS[sch];
            const gradeStats = schoolData.metrics.total || { avg: 0, excRate: 0, passRate: 0 };

            // è®¡ç®—ç­çº§ä¸¤ç‡
            const excLine = THRESHOLDS.total?.exc || 0;
            const passLine = THRESHOLDS.total?.pass || 0;
            const clsExcCount = students.filter(s => s.total >= excLine).length;
            const clsPassCount = students.filter(s => s.total >= passLine).length;
            const clsExcRate = clsExcCount / count;
            const clsPassRate = clsPassCount / count;

            // --- PPT åˆå§‹åŒ– ---
            let pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            pptx.title = `${cls}ç­ å­¦æƒ…åˆ†ææŠ¥å‘Š`;
            
            // é…è‰²æ–¹æ¡ˆ
            const C_MAIN = "1E3A8A";  // æ·±è“
            const C_ACCENT = "F59E0B"; // é‡‘è‰²
            const C_TEXT = "374151";   // æ·±ç°

            // æ¯ç‰ˆ
            pptx.defineSlideMaster({
                title: 'MASTER',
                background: { color: "FFFFFF" },
                objects: [
                    { rect: { x: 0, y: 0, w: "100%", h: 0.6, fill: C_MAIN } },
                    { text: { text: `${sch} ${cls}ç­ | ${CONFIG.name} å­¦æƒ…åˆ†æ`, x: 0.2, y: 0.15, fontSize: 14, color: "FFFFFF", bold: true } },
                    { line: { x: 0.5, y: 6.8, w: 9, h: 0, line: { color: "E5E7EB", width: 1 } } },
                    { text: { text: "å†…éƒ¨æ•™ç ”èµ„æ–™ Â· è¯·å‹¿å¤–ä¼ ", x: 0.5, y: 6.9, fontSize: 10, color: "9CA3AF" } },
                    { text: { text: "ç”Ÿæˆæ—¥æœŸ: " + new Date().toLocaleDateString(), x: 9, y: 6.9, w:3, align:'right', fontSize: 10, color: "9CA3AF" } }
                ],
                slideNumber: { x: 12.3, y: 6.9, fontSize: 10, color: "9CA3AF" }
            });

            // ================= ç¬¬1é¡µï¼šå°é¢ =================
            let slide = pptx.addSlide();
            slide.background = { color: C_MAIN };
            slide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: 4, h: 7.5, fill: "172554" });
            slide.addText("æˆç»©åˆ†æä¸\næ•™å­¦è¯Šæ–­æŠ¥å‘Š", { x: 0.8, y: 2.5, w: 6, fontSize: 40, bold: true, color: "FFFFFF", fontFace: "å¾®è½¯é›…é»‘" });
            slide.addText(`${CONFIG.name}`, { x: 0.8, y: 4.5, fontSize: 20, color: C_ACCENT, bold: true });
            slide.addText(`æ±‡æŠ¥ç­çº§ï¼š${cls}ç­`, { x: 0.8, y: 5.2, fontSize: 16, color: "E0F2FE" });
            slide.addText("æ•°æ®é©±åŠ¨ Â· ç²¾å‡†æ–½æ•™ Â· ç§‘å­¦æå‡", { x: 5, y: 3.5, w: 7, align: 'center', fontSize: 24, color: "FFFFFF", bold: true, letterSpacing: 3, shadow: {type:'outer', color:'000000', opacity:0.3} });

            // ================= ç¬¬2é¡µï¼šç›®å½• =================
            slide = pptx.addSlide({ masterName: 'MASTER' });
            slide.addText("æ±‡æŠ¥ç›®å½• / Contents", { x: 0.5, y: 1, fontSize: 24, bold: true, color: C_MAIN });
            const chapters = ["ç­çº§æ•´ä½“æ¦‚å†µ (å‡åˆ†/ä¸¤ç‡)", "åˆ†æ•°æ®µåˆ†å¸ƒä¸æå·®åˆ†æ", "å­¦ç§‘ä¼˜åŠ£åŠ¿æ·±åº¦è¯Šæ–­", "å…³é”®å­¦ç”Ÿåå• (å…‰è£æ¦œ/ä¸´ç•Œç”Ÿ)", "æ•™å­¦å»ºè®®ä¸æ”¹è¿›æªæ–½"];
            chapters.forEach((t, i) => {
                let y = 2.2 + i * 0.9;
                slide.addShape(pptx.ShapeType.roundRect, { x: 1.5, y: y, w: 0.6, h: 0.6, fill: C_MAIN, rectRadius: 0.1 });
                slide.addText("0"+(i+1), { x: 1.5, y: y, w: 0.6, h: 0.6, align: 'center', fontSize: 14, color: "FFFFFF", bold: true });
                slide.addText(t, { x: 2.3, y: y, w: 8, h: 0.6, fontSize: 16, color: C_TEXT, bold: true });
                slide.addShape(pptx.ShapeType.line, { x: 2.3, y: y+0.7, w: 8, h: 0, line: { color: "E5E7EB", dashType: 'dash' } });
            });

            // ================= ç¬¬3é¡µï¼šç­çº§æ ¸å¿ƒæŒ‡æ ‡ =================
            slide = pptx.addSlide({ masterName: 'MASTER' });
            slide.addText("01 ç­çº§æ•´ä½“æ¦‚å†µ", { x: 0.5, y: 1, fontSize: 20, bold: true, color: C_MAIN });

            const kpiStyle = { w: 2.8, h: 1.6, fill: "FFFFFF", border: { color: "E5E7EB" }, shadow: {type:'outer', blur:3, offset:2, opacity:0.1} };
            const kpiY = 1.8;
            
            // KPI å¡ç‰‡ç»˜åˆ¶å‡½æ•°
            const drawKPI = (x, val, label, diff=null) => {
                slide.addShape(pptx.ShapeType.roundRect, { x: x, y: kpiY, ...kpiStyle });
                slide.addText(val, { x: x, y: kpiY+0.3, w: 2.8, align:'center', fontSize: 32, bold:true, color:C_MAIN });
                slide.addText(label, { x: x, y: kpiY+1.1, w: 2.8, align:'center', fontSize: 10, color:"6B7280" });
                if(diff !== null) {
                    slide.addText(`${diff>=0?'+':''}${diff.toFixed(1)}`, { x: x+2, y: kpiY+0.1, fontSize:10, bold:true, color: diff>=0?"16A34A":"DC2626" });
                }
            };

            drawKPI(0.5, avg.toFixed(1), `ç­çº§å‡åˆ† (å¹´çº§${gradeStats.avg.toFixed(1)})`, avg - gradeStats.avg);
            drawKPI(3.5, `${(clsExcRate*100).toFixed(1)}%`, `ä¼˜ç§€ç‡ (å¹´çº§${(gradeStats.excRate*100).toFixed(1)}%)`, (clsExcRate-gradeStats.excRate)*100);
            drawKPI(6.5, `${(clsPassRate*100).toFixed(1)}%`, `åŠæ ¼ç‡ (å¹´çº§${(gradeStats.passRate*100).toFixed(1)}%)`, (clsPassRate-gradeStats.passRate)*100);
            drawKPI(9.5, (maxScore-minScore).toFixed(0), `åˆ†å·® (æœ€é«˜${maxScore}-æœ€ä½${minScore})`);

            // [ä¿®å¤] å›¾è¡¨æ•°æ®ç»“æ„ï¼šå¿…é¡»åŒ…å« labels å’Œ values
            const chartLabels = ["å¹³å‡åˆ†", "ä¼˜ç§€ç‡%", "åŠæ ¼ç‡%"];
            const chartData = [
                { name: "æœ¬ç­", labels: chartLabels, values: [avg, clsExcRate*100, clsPassRate*100] },
                { name: "å¹´çº§", labels: chartLabels, values: [gradeStats.avg, gradeStats.excRate*100, gradeStats.passRate*100] }
            ];

            slide.addChart(pptx.ChartType.bar, chartData, {
                x: 2, y: 4, w: 9, h: 3,
                barDir: 'col', barGrouping: 'clustered',
                chartColors: [C_MAIN, "9CA3AF"],
                catAxisLabelColor: C_TEXT, valAxisHidden: true,
                showValue: true, showLegend: true,
                title: { text: "æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”å›¾", fontSize: 11, color: "6B7280" }
            });

            // ================= ç¬¬4é¡µï¼šåˆ†æ•°æ®µåˆ†å¸ƒ =================
            slide = pptx.addSlide({ masterName: 'MASTER' });
            slide.addText("02 åˆ†æ•°æ®µåˆ†å¸ƒ (æ•´ä½“ç»“æ„)", { x: 0.5, y: 1, fontSize: 20, bold: true, color: C_MAIN });

            const step = 50; 
            const maxCeil = Math.ceil(maxScore / step) * step;
            const segmentLabels = [];
            const segmentValues = [];
            
            for (let i = maxCeil; i > 0; i -= step) {
                const low = i - step;
                const high = i;
                const c = students.filter(s => s.total > low && s.total <= high).length;
                if (c > 0 || segmentValues.length > 0) {
                    segmentLabels.push(`${low}-${high}`);
                    segmentValues.push(c);
                }
            }

            if (segmentLabels.length > 0) {
                slide.addChart(pptx.ChartType.bar, [
                    { name: "äººæ•°", labels: segmentLabels, values: segmentValues }
                ], {
                    x: 0.5, y: 1.8, w: 7.5, h: 4.5,
                    barDir: 'col', chartColors: [C_MAIN],
                    showValue: true, title: { text: "ç­çº§åˆ†æ•°åˆ†å¸ƒå›¾", fontSize: 12 }
                });
            }

            // å³ä¾§æ–‡å­—
            slide.addText("ğŸ’¡ ç»“æ„è¯Šæ–­ï¼š", { x: 8.5, y: 2, fontSize: 14, bold: true, color: C_ACCENT });
            const topRatio = (students.slice(0, Math.ceil(count*0.2)).reduce((a,b)=>a+b.total,0) / Math.ceil(count*0.2)).toFixed(0);
            slide.addText([
                { text: "â— å°–å­ç”Ÿç¾¤ä½“ï¼š", options: { bold:true, color:C_TEXT } },
                { text: `å‰20%å­¦ç”Ÿå‡åˆ†ä¸º ${topRatio} åˆ†ã€‚\n\n`, options: { fontSize:12, color:"666666" } },
                { text: "â— ä¸­é—´å±‚æ–­æ¡£ï¼š", options: { bold:true, color:C_TEXT } },
                { text: `è¯·å…³æ³¨ ${Math.floor(avg-30)}-${Math.floor(avg+30)} åˆ†æ®µçš„å­¦ç”Ÿã€‚`, options: { fontSize:12, color:"666666" } }
            ], { x: 8.5, y: 2.5, w: 4, h: 3, fill: "F9FAFB", inset:0.2 });

            // ================= ç¬¬5é¡µï¼šå­¦ç§‘æ·±åº¦è¯Šæ–­ =================
            slide = pptx.addSlide({ masterName: 'MASTER' });
            slide.addText("03 å­¦ç§‘ä¼˜åŠ£åŠ¿æ·±åº¦è¯Šæ–­", { x: 0.5, y: 1, fontSize: 20, bold: true, color: C_MAIN });

            const subHeaders = [
                { text: "å­¦ç§‘", options: { fill: C_MAIN, color: "FFFFFF", bold: true, align: 'center', w:1.2 } },
                { text: "ç­çº§å‡åˆ†", options: { fill: "DBEAFE", color: C_TEXT, bold: true, align: 'center' } },
                { text: "å¹´çº§å‡åˆ†", options: { fill: "DBEAFE", color: C_TEXT, bold: true, align: 'center' } },
                { text: "å·®å€¼", options: { fill: "DBEAFE", color: C_TEXT, bold: true, align: 'center' } },
                { text: "ç­çº§ä¼˜ç‡%", options: { fill: "FEF3C7", color: C_TEXT, bold: true, align: 'center' } },
                { text: "ç­çº§åŠæ ¼%", options: { fill: "D1FAE5", color: C_TEXT, bold: true, align: 'center' } }
            ];

            const subRows = [subHeaders];
            
            SUBJECTS.forEach(sub => {
                const m = schoolData.metrics[sub]; 
                if (!m) return;
                
                const subScores = students.map(s => s.scores[sub]).filter(v => typeof v === 'number');
                const cnt = subScores.length || 1;
                const sAvg = subScores.reduce((a,b)=>a+b,0) / cnt;
                const sExc = subScores.filter(v => v >= THRESHOLDS[sub].exc).length / cnt;
                const sPass = subScores.filter(v => v >= THRESHOLDS[sub].pass).length / cnt;
                const diff = sAvg - m.avg;

                subRows.push([
                    { text: sub, options: { bold: true, align: 'center' } },
                    { text: sAvg.toFixed(1), options: { align: 'center' } },
                    { text: m.avg.toFixed(1), options: { align: 'center', color: "666666" } },
                    { text: (diff>=0?'+':'') + diff.toFixed(1), options: { align: 'center', bold: true, color: diff>=0?"16A34A":"DC2626" } },
                    { text: (sExc*100).toFixed(1), options: { align: 'center' } },
                    { text: (sPass*100).toFixed(1), options: { align: 'center' } }
                ]);
            });

            slide.addTable(subRows, { x: 0.5, y: 1.8, w: 12.3, fontSize: 10, rowH: 0.5, border: { color: "E5E7EB" } });

            // ================= ç¬¬6é¡µï¼šå…‰è£æ¦œ =================
            slide = pptx.addSlide({ masterName: 'MASTER' });
            slide.addText("04 æ¦œæ ·åŠ›é‡", { x: 0.5, y: 1, fontSize: 20, bold: true, color: C_MAIN });

            slide.addText("ğŸ† å­¦ä¹ æ ‡å…µ (Top 10)", { x: 0.8, y: 1.8, fontSize: 14, bold: true, color: C_ACCENT });
            const top10Names = students.slice(0, 10).map((s,i) => `${i+1}.${s.name}(${s.total})`).join("  ");
            slide.addText(top10Names, { x: 0.8, y: 2.2, w: 11.5, h: 1.2, fill: "FFFBEB", color: "B45309", fontSize: 14, inset: 0.2, border: {color:"FCD34D"} });

            if (PROGRESS_CACHE && PROGRESS_CACHE.length > 0) {
                slide.addText("ğŸ“ˆ è¿›æ­¥ä¹‹æ˜Ÿ (è¾ƒä¸Šæ¬¡è€ƒè¯•)", { x: 0.8, y: 3.8, fontSize: 14, bold: true, color: "16A34A" });
                const stars = PROGRESS_CACHE.filter(p => p.class === cls && p.change > 0).sort((a,b) => b.change - a.change).slice(0, 12);
                const starNames = stars.map(p => `${p.name}â†‘${p.change}`).join("  ");
                slide.addText(starNames || "æš‚æ— æ˜¾è‘—è¿›æ­¥æ•°æ®", { x: 0.8, y: 4.2, w: 11.5, h: 1.2, fill: "DCFCE7", color: "166534", fontSize: 14, inset: 0.2, border: {color:"86EFAC"} });
            }

            // ================= ç¬¬7é¡µï¼šä¸´ç•Œç”Ÿ =================
            slide = pptx.addSlide({ masterName: 'MASTER' });
            slide.addText("ğŸ¯ é‡ç‚¹å…³æ³¨ (ä¸´ç•Œç”Ÿ)", { x: 0.5, y: 1, fontSize: 20, bold: true, color: C_MAIN });
            
            const marginalGap = 5;
            let marginalHtml = [];
            SUBJECTS.forEach(sub => {
                const excLine = THRESHOLDS[sub].exc;
                const passLine = THRESHOLDS[sub].pass;
                const excMarginal = students.filter(s => s.scores[sub] >= excLine - marginalGap && s.scores[sub] < excLine).map(s => s.name);
                const passMarginal = students.filter(s => s.scores[sub] >= passLine - marginalGap && s.scores[sub] < passLine).map(s => s.name);
                
                if(excMarginal.length > 0 || passMarginal.length > 0) {
                    marginalHtml.push([
                        { text: sub, options: { bold:true, fill: "F3F4F6" } },
                        { text: "å†²åˆºä¼˜: " + (excMarginal.join("ã€") || "-"), options: { color: "0369A1", fontSize: 9 } },
                        { text: "ä¿åŠæ ¼: " + (passMarginal.join("ã€") || "-"), options: { color: "B45309", fontSize: 9 } }
                    ]);
                }
            });

            if(marginalHtml.length > 0) {
                // è¡¨å¤´
                const mHeader = [{ text:"å­¦ç§‘", options:{bold:true, w:1.2} }, { text:"å†²åˆºä¼˜ç§€ (å·®<5åˆ†)", options:{bold:true, w:5.4} }, { text:"ä¿åŠæ ¼ (å·®<5åˆ†)", options:{bold:true, w:5.4} }];
                slide.addTable([mHeader, ...marginalHtml], { x: 0.5, y: 1.8, w: 12, border: { color: "E5E7EB" }, rowH: 0.6, fontSize:10 });
            } else {
                slide.addText("æš‚æ— æ˜æ˜¾ä¸´ç•Œç”Ÿã€‚", { x: 0.5, y: 3, color: "9CA3AF" });
            }

            // ================= ç¬¬8é¡µï¼šç»“æŸè¯­ =================
            slide = pptx.addSlide();
            slide.background = { color: C_MAIN };
            slide.addText("æ„Ÿè°¢å„ä½å®¶é•¿çš„é…åˆï¼", { x: 0, y: 2.5, w: "100%", align: 'center', fontSize: 36, bold: true, color: "FFFFFF" });
            slide.addText("å®¶æ ¡å…±è‚² Â· é™å¾…èŠ±å¼€", { x: 0, y: 3.5, w: "100%", align: 'center', fontSize: 20, color: C_ACCENT });

            pptx.writeFile({ fileName: `${sch}_${cls}ç­_æ·±åº¦åˆ†ææŠ¥å‘Š.pptx` });

        } catch (e) {
            console.error(e);
            alert("ç”Ÿæˆå‡ºé”™ï¼š" + e.message);
        }
    }

    function parseConstraintStr(str) {
        if(!str) return [];
        return str.replace(/ï¼Œ/g, ',').replace(/ï¼›/g, ';').split(/[,;]/).map(s => s.trim()).filter(s => s);
    }

    function parseConflictStr(str) {
        if(!str) return [];
        return str.replace(/ï¼Œ/g, ',').split(',').map(pair => {
            const parts = pair.split('&').map(s => s.trim());
            if(parts.length === 2) return parts;
            return null;
        }).filter(p => p);
    }
    
    // ================== æ–°ç”Ÿåˆ†ç­-åº§ä½ç”Ÿæˆé€»è¾‘ ==================
     function FB_autoSeatAlgo() {
        HistoryManager.record();
        const cls = FB_CLASSES[FB_CUR_CLASS_IDX]; 
        
        // 1. è·å–ç°æœ‰å¸ƒå±€ï¼ˆå¦‚æœæ˜¯åˆæ¬¡ç”Ÿæˆï¼Œåˆ™åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼‰
        let currentLayout = cls.seatLayout || [];
        // å¦‚æœé•¿åº¦ä¸å¤Ÿï¼ˆæ¯”å¦‚äººæ•°å˜å¤šäº†ï¼‰ï¼Œè¡¥é½
        if(currentLayout.length < cls.students.length) {
            currentLayout = [...cls.students];
        }

        // 2. åˆ†ç¦»â€œé”å®šâ€å­¦ç”Ÿå’Œâ€œè‡ªç”±â€å­¦ç”Ÿ
        let lockedSlots = {}; // è®°å½• { ç´¢å¼•: å­¦ç”Ÿå¯¹è±¡ }
        let freeStudents = [];

        // éå†å½“å‰å¸ƒå±€ï¼ŒæŠŠè¢«é”å®šçš„é’‰åœ¨åŸä½ï¼Œæ²¡é”å®šçš„æ‰”è¿›æ± å­é‡æ’
        currentLayout.forEach((s, idx) => {
            if(s && s.locked) {
                lockedSlots[idx] = s;
            } else {
                if(s) freeStudents.push(s); // æ”¶é›†æ‰€æœ‰éé”å®šå­¦ç”Ÿ
            }
        });

        // 3. å¤„ç†çº¦æŸæ¡ä»¶ (ä»…é’ˆå¯¹è‡ªç”±å­¦ç”Ÿ)
        // ä½¿ç”¨éšè—Inputçš„å€¼ï¼Œå…¼å®¹ Tag Widget
        const diffInput = parseConstraintStr(document.getElementById('fb_c_diff').value);
        const visionInput = parseConstraintStr(document.getElementById('fb_c_vision').value);
        const talkInput = parseConstraintStr(document.getElementById('fb_c_talk').value);
        const conflictInput = parseConflictStr(document.getElementById('fb_c_conflict').value);

        // è·å–ç»‘å®šé…ç½®
        const bindInput = parseConflictStr(document.getElementById('fb_c_bind').value); // å¤ç”¨è§£æå‡½æ•°ï¼Œæ ¼å¼ä¹Ÿæ˜¯ A&B
        const bindMap = new Map(); // name -> partnerName
        bindInput.forEach(pair => {
            bindMap.set(pair[0], pair[1]);
            bindMap.set(pair[1], pair[0]);
        });
        
        // é‡æ–°æ ‡è®°ä¸´æ—¶å±æ€§ï¼ˆåªé’ˆå¯¹è‡ªç”±å­¦ç”Ÿï¼Œé”å®šçš„ä¸ç®¡ï¼‰
        freeStudents.forEach(s => {
             s._isDiff = false; s._isVision = false; 
             if(diffInput.includes(s.name) || talkInput.includes(s.name)) s._isDiff = true;
             if(visionInput.includes(s.name)) s._isVision = true;
                  s._bindPartner = bindMap.get(s.name); // æ ‡è®°æ­æ¡£
        });

        const useH = document.getElementById('rule_s_height').checked; 
        const useV = document.getElementById('rule_s_vision').checked; 
        const useG = document.getElementById('rule_s_gender').checked; 
        const useD = document.getElementById('rule_s_diff').checked;

        // --- æ’åºé€»è¾‘ (ä»…å¯¹è‡ªç”±æ± ) ---
        if(useH) freeStudents.sort((a,b) => a.height - b.height); 
        // æ ¸å¿ƒé€»è¾‘ï¼šå¤„ç†ç»‘å®šå…³ç³»ï¼Œä½¿å…¶åœ¨åˆ—è¡¨ä¸­ç´§é‚»
        // 1. æå–æ‰€æœ‰æœ‰ç»‘å®šå…³ç³»çš„ä¸”åœ¨è‡ªç”±æ± ä¸­çš„å­¦ç”Ÿ
        let boundPairs = [];
        let processedBindNames = new Set();
        let singleStudents = [];

        freeStudents.forEach(s => {
            if (s._bindPartner && !processedBindNames.has(s.name)) {
                // æ‰¾æ­æ¡£
                const partner = freeStudents.find(p => p.name === s._bindPartner);
                if (partner) {
                    // æ‰¾åˆ°ä¸€å¯¹ï¼Œæ”¾å…¥ Pairs
                    processedBindNames.add(s.name);
                    processedBindNames.add(partner.name);
                    // ä¸¤äººæŒ‰èº«é«˜æ’åºï¼ŒçŸ®çš„åœ¨å‰
                    const pair = [s, partner].sort((a,b) => a.height - b.height);
                    boundPairs.push(pair);
                } else {
                    // æ­æ¡£å¯èƒ½è¢«é”å®šäº†æˆ–è€…ä¸åœ¨ç­é‡Œï¼Œé™çº§ä¸ºå•äºº
                    singleStudents.push(s);
                }
            } else if (!processedBindNames.has(s.name)) {
                singleStudents.push(s);
            }
        });

        // 2. å°† Pairs è§†ä¸ºä¸€ä¸ªæ•´ä½“ (ç”¨ä¸¤äººå¹³å‡èº«é«˜) ä¸ Singles æ··æ’
        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥æŠŠ Pairs æ’åœ¨ Singles é˜Ÿåˆ—ä¸­å¯¹åº”èº«é«˜ä½ç½®
        // è§†åŠ›ä¼˜å…ˆåŸåˆ™ï¼šå¦‚æœ Pair ä¸­æœ‰äººè§†åŠ›ä¸å¥½ï¼Œæ•´ä¸ª Pair æè‡³æœ€å‰
        
        let finalQueue = [];
        let visionQueue = [];
        let normalQueue = [];

        // åˆ†æµå•äºº
        singleStudents.forEach(s => {
            if(visionInput.length > 0 && s._isVision) visionQueue.push(s);
            else normalQueue.push(s);
        });
        
        // åˆ†æµ Pair
        boundPairs.forEach(pair => {
            const isVisionPair = pair.some(s => s._isVision);
            if(visionInput.length > 0 && isVisionPair) {
                // æ‹†å¼€æ’å…¥åˆ°è§†åŠ›é˜Ÿåˆ—å¤´éƒ¨ï¼ˆä¿æŒç›¸é‚»ï¼‰
                visionQueue.push(pair[0], pair[1]);
            } else {
                // æ’å…¥åˆ°æ™®é€šé˜Ÿåˆ—ï¼Œæ ¹æ®å¹³å‡èº«é«˜æ‰¾åˆ°ä½ç½®
                const pairAvgHeight = (pair[0].height + pair[1].height) / 2;
                // ç®€å•çš„äºŒåˆ†æŸ¥æ‰¾æˆ–è€…ç›´æ¥éå†æ’å…¥ï¼Œè¿™é‡Œç”¨ç®€å•éå†
                let inserted = false;
                for(let i=0; i<normalQueue.length; i++) {
                     // å¦‚æœå½“å‰ä½ç½®æ˜¯æ™®é€šå­¦ç”Ÿï¼Œä¸”èº«é«˜æ¯” Pair é«˜ï¼Œæ’åœ¨å‰é¢
                     if (normalQueue[i].height > pairAvgHeight) {
                         normalQueue.splice(i, 0, pair[0], pair[1]);
                         inserted = true;
                         break;
                     }
                }
                if(!inserted) {
                    normalQueue.push(pair[0], pair[1]);
                }
            }
        });

        freeStudents = [...visionQueue, ...normalQueue];

        // 3. å¤„ç†éš¾ç®¡æ’ç©º (å°½é‡é¿å¼€ç ´å Pairï¼Œç®€åŒ–å¤„ç†ï¼šå¦‚æœæ’ç©ºä½ç½®æ­£å¥½æ‹†æ•£ Pairï¼Œå¾€åæŒªä¸€ä½)
        // (ç”±äº Pair åœ¨æ•°ç»„ä¸­æ˜¯ç›¸é‚»çš„ï¼Œåªè¦å¡«å……é€»è¾‘æ˜¯çº¿æ€§çš„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¼šåŒæ¡Œ)
        // ... åŸæœ‰çš„éš¾ç®¡é€»è¾‘ç•¥å¾®å¤æ‚ï¼Œè¿™é‡Œæš‚ä¸”ä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä½†è¦æ³¨æ„å®ƒå¯èƒ½ä¼šæ‰“ä¹± Pair
        // ä¸ºä¿è¯â€œå¼ºç»‘å®šâ€ï¼Œå»ºè®®åœ¨æ­¤å¤„ç¦ç”¨â€œéš¾ç®¡æ’ç©ºâ€å¯¹ Pair çš„ç ´åï¼Œæˆ–è€…ç®€å•è·³è¿‡ã€‚
        // (æ­¤å¤„ä»£ç å¤ç”¨ä¸Šæ–‡æ—§ä»£ç çš„é€»è¾‘ï¼Œæš‚ä¸ä¿®æ”¹éš¾ç®¡éƒ¨åˆ†ï¼Œé€šå¸¸åªä¼šè½»å¾®å½±å“)

        // è§†åŠ›ç”Ÿæå‰ (æ”¾åœ¨æ•°ç»„å‰é¢)
        if(visionInput.length > 0 || useV) {
            const visions = freeStudents.filter(s => s._isVision || (useV && s.vision < 4.8));
            const others = freeStudents.filter(s => !s._isVision && !(useV && s.vision < 4.8));
            freeStudents = [...visions, ...others];
        }

        // éš¾ç®¡ç”Ÿæ’ç©º (å‡åŒ€åˆ†å¸ƒ)
        const diffs = freeStudents.filter(s => s._isDiff || (useD && s.isDiff));
        if(diffs.length > 0) {
            const cleanList = freeStudents.filter(s => !s._isDiff && !(useD && s.isDiff));
            const step = Math.floor(cleanList.length / (diffs.length + 1));
            let currentPos = step;
            diffs.forEach(d => { 
                if(currentPos < cleanList.length) cleanList.splice(currentPos, 0, d); 
                else cleanList.push(d);
                currentPos += step + 1; 
            });
            freeStudents = cleanList;
        }

        // ç”·å¥³æ··æ’ (ç®€å•çš„ç›¸é‚»äº’æ–¥)
        if(useG) { 
            for(let i=0; i<freeStudents.length-1; i+=2) { 
                if(freeStudents[i].gender === freeStudents[i+1].gender) { 
                    for(let j=i+2; j<freeStudents.length; j++) { 
                        if(freeStudents[j].gender !== freeStudents[i].gender) { 
                            [freeStudents[i+1], freeStudents[j]] = [freeStudents[j], freeStudents[i+1]]; 
                            break; 
                        } 
                    } 
                } 
            } 
        }
        
        // 4. é‡ç»„å¸ƒå±€ï¼šå°†è‡ªç”±å­¦ç”Ÿå¡«å›éé”å®šçš„å‘ä½
        let newLayout = [];
        let freeIdx = 0;
        // æ€»åº§ä½æ•°å– å­¦ç”Ÿæ€»æ•° å’Œ ç°æœ‰å¸ƒå±€é•¿åº¦ çš„æœ€å¤§å€¼
        const totalSeats = Math.max(cls.students.length, currentLayout.length);

        for(let i=0; i<totalSeats; i++) {
            if(lockedSlots[i]) {
                newLayout[i] = lockedSlots[i]; // æ”¾å›é”å®šå­¦ç”Ÿ
            } else {
                if(freeIdx < freeStudents.length) {
                    newLayout[i] = freeStudents[freeIdx++]; // å¡«å…¥è‡ªç”±å­¦ç”Ÿ
                } else {
                    newLayout[i] = null; // ç©ºä½
                }
            }
        }

        cls.seatLayout = newLayout; 
        FB_renderSeatMap();
    }

        function FB_renderSeatMap() {
        const cls = FB_CLASSES[FB_CUR_CLASS_IDX]; 
        const container = document.getElementById('seat_map_container'); 
        container.innerHTML = '';
        
        const groups = parseInt(document.getElementById('seat_opt_groups').value); 
        const colsPerGroup = parseInt(document.getElementById('seat_opt_cols').value); 
        
        container.style.display = 'grid'; 
        container.style.gridTemplateColumns = `repeat(${groups}, 1fr)`; 
        container.style.gap = '50px'; 
        container.style.alignItems = 'start';
        container.style.padding = '20px'; // å¢åŠ å†…è¾¹è·é˜²æ­¢æ—‹è½¬æº¢å‡º
        
        const list = cls.seatLayout || cls.students; 
        const rowCapacity = groups * colsPerGroup; 
        const totalRows = Math.ceil(list.length / rowCapacity);
        
        const groupEls = []; 
        for(let g=0; g<groups; g++) { 
            const gel = document.createElement('div'); gel.className = 'seat-group'; 
            gel.style.display = 'grid'; gel.style.gridTemplateColumns = `repeat(${colsPerGroup}, 1fr)`; 
            gel.style.gap = '10px'; gel.style.position = 'relative';
            groupEls.push(gel); container.appendChild(gel); 
        }
        
        for(let r=0; r<totalRows; r++) {
            for(let g=0; g<groups; g++) {
                for(let c=0; c<colsPerGroup; c++) {
                    const stuIdx = r * rowCapacity + g * colsPerGroup + c; 
                    const stu = list[stuIdx]; 
                    const desk = document.createElement('div'); 
                    desk.className = 'desk';
                    
                    if(stu) {
                        if(stu.gender==='M') desk.classList.add('is-male'); 
                        if(stu.gender==='F') desk.classList.add('is-female'); 
                        if(stu.isDiff || stu._isDiff) desk.classList.add('is-diff');
                        
                        // å¤„ç†é”å®šçŠ¶æ€
                        if(stu.locked) desk.classList.add('locked');

                        desk.draggable = !stu.locked; // é”å®šçš„ä¸èƒ½æ‹–
                        desk.dataset.idx = stuIdx; 
                        desk.innerHTML = `<div class="desk-name">${stu.name}</div><div class="desk-info"><span>${stu.height}cm</span><span>${stu.score}</span></div><div class="desk-popover">è§†åŠ›:${stu.vision} | å¤‡æ³¨:${stu.remarks}</div>`;
                        
                        // ç»‘å®šå³é”®äº‹ä»¶
                        desk.oncontextmenu = (e) => { 
                            e.preventDefault(); 
                            FB_toggleLock(stuIdx); 
                        };

                        // æ‹–æ‹½äº‹ä»¶ (ä»…æœªé”å®šæ—¶æœ‰æ•ˆ)
                        if(!stu.locked) {
                            desk.ondragstart = (e) => { e.dataTransfer.setData('text/plain', stuIdx); desk.classList.add('dragging'); }; 
                            desk.ondragend = () => desk.classList.remove('dragging'); 
                            desk.ondragover = (e) => { e.preventDefault(); desk.classList.add('drag-over'); }; 
                            desk.ondragleave = () => desk.classList.remove('drag-over');
                            desk.ondrop = (e) => { 
                                e.preventDefault(); 
                            const fromIdx = parseInt(e.dataTransfer.getData('text/plain')); 
                            const toIdx = stuIdx;
                            // åªæœ‰å½“ä½ç½®çœŸçš„å‘ç”Ÿå˜åŒ–ï¼Œä¸”åŒæ–¹éƒ½æ²¡é”å®šæ—¶ï¼Œæ‰è®°å½•å†å²
                            if (fromIdx !== toIdx && !list[toIdx].locked && !list[fromIdx].locked) {
                                HistoryManager.record(); // ğŸ“¸ è®°å½•ï¼å› ä¸ºé©¬ä¸Šè¦äº¤æ¢äº†
                            }
                                    if (!list[toIdx].locked && !list[fromIdx].locked) {
                                    [cls.seatLayout[fromIdx], cls.seatLayout[toIdx]] = [cls.seatLayout[toIdx], cls.seatLayout[fromIdx]]; 
                                    FB_renderSeatMap(); 
                                }
                            };
                        }
                    } else { 
                        desk.style.visibility = 'hidden'; 
                    }
                    groupEls[g].appendChild(desk);
                }
            }
        }
        
        // æ¸²æŸ“å­¦ä¹ å°ç»„æ¡† (ä¿æŒä¸å˜)
        for(let g=0; g<groups; g++) {
            const gel = groupEls[g];
            if(colsPerGroup % 2 === 0) {
                for(let r=0; r<totalRows; r+=2) {
                    for(let c=0; c<colsPerGroup; c+=2) {
                        const box = document.createElement('div'); box.className = 'learning-group-box';
                        box.style.left = `${c * 90 - 5}px`; box.style.top = `${r * 65 - 5}px`; box.style.width = `175px`; box.style.height = `125px`;
                        const groupsPerBigRow = colsPerGroup / 2; const groupNum = (g * (Math.ceil(totalRows/2) * groupsPerBigRow)) + ((r/2) * groupsPerBigRow) + (c/2) + 1;
                        box.innerHTML = `<div class="learning-group-label">å°ç»„ ${groupNum}</div>`; gel.appendChild(box);
                    }
                }
            }
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ‡æ¢é”å®šçŠ¶æ€
    function FB_toggleLock(idx) {
        const cls = FB_CLASSES[FB_CUR_CLASS_IDX];
        const stu = cls.seatLayout[idx];
        if(stu) {
            stu.locked = !stu.locked; // åˆ‡æ¢çŠ¶æ€
            FB_renderSeatMap(); // é‡ç»˜
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ‡æ¢è§†è§’æ—‹è½¬
    function FB_toggleViewRotation() {
        const canvas = document.querySelector('.seat-canvas');
        canvas.classList.toggle('view-rotated');
    }

    function FB_saveToLocal() { if(!FB_CLASSES.length) return alert("æš‚æ— æ•°æ®"); localStorage.setItem('FB_DATA_BACKUP', JSON.stringify(FB_CLASSES)); alert("æ–¹æ¡ˆå·²ä¿å­˜è‡³æµè§ˆå™¨ç¼“å­˜"); }
    function FB_exportResult() {
        if(!FB_CLASSES.length) return alert("æ— æ•°æ®"); const wb = XLSX.utils.book_new(); const data = [['ç­çº§','åº§ä½å·','å§“å','æ€§åˆ«','æ€»åˆ†','èº«é«˜','è§†åŠ›','å¤‡æ³¨']];
        FB_CLASSES.forEach(c => { const list = c.seatLayout || c.students; list.forEach((s, i) => { data.push([c.name, i+1, s.name, s.gender, s.score, s.height, s.vision, s.remarks]); }); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "åˆ†ç­ä¸åº§ä½è¡¨"); XLSX.writeFile(wb, "æ–°ç”Ÿåˆ†ç­ç»“æœ.xlsx");
    }

    // --- å›ºå®šæ­æ¡£ (ç»‘å®š) è¾…åŠ©å‡½æ•° ---
    function addBindPair(type) {
        const idA = 'fb_bind_sel_a';
        const idB = 'fb_bind_sel_b';
        const wrapperId = 'widget_fb_bind'; 
        const hiddenId = 'fb_c_bind';

        const selA = document.getElementById(idA);
        const selB = document.getElementById(idB);

        if(!selA || !selB) return;
        if(!selA.value || !selB.value) return alert("è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªå­¦ç”Ÿ");
        if(selA.value === selB.value) return alert("ä¸èƒ½é€‰æ‹©åŒä¸€ä¸ªå­¦ç”Ÿ");

        addTagToWidget(wrapperId, hiddenId, `${selA.value}&${selB.value}`); 
        selA.value = ""; selB.value = "";
    }

    // --- æ–¹æ¡ˆç®¡ç† (ä¿å­˜/è¯»å–) ---
    function FB_initScenarioSelect() {
        const cls = FB_CLASSES[FB_CUR_CLASS_IDX];
        const sel = document.getElementById('seat_scenario_select');
        sel.innerHTML = '<option value="">-- é€‰æ‹©æ–¹æ¡ˆ --</option>';
        
        if (!cls.scenarios) cls.scenarios = {}; // åˆå§‹åŒ–å­˜å‚¨ç»“æ„
        
        Object.keys(cls.scenarios).forEach(name => {
            sel.innerHTML += `<option value="${name}">${name}</option>`;
        });
    }

    function FB_saveScenario() {
        const cls = FB_CLASSES[FB_CUR_CLASS_IDX];
        if (!cls.seatLayout || cls.seatLayout.length === 0) return alert("å½“å‰åº§ä½è¡¨ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜");
        
        const name = prompt("è¯·è¾“å…¥æ–¹æ¡ˆåç§° (å¦‚ï¼šæœŸä¸­è€ƒè¯•ã€æ—¥å¸¸ã€äº’åŠ©ç»„)", `æ–¹æ¡ˆ ${Object.keys(cls.scenarios || {}).length + 1}`);
        if (!name) return;
        
        if (!cls.scenarios) cls.scenarios = {};
        // æ·±åº¦æ‹·è´å½“å‰å¸ƒå±€
        cls.scenarios[name] = JSON.parse(JSON.stringify(cls.seatLayout));
        
        alert(`æ–¹æ¡ˆ [${name}] ä¿å­˜æˆåŠŸï¼`);
        FB_initScenarioSelect(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
        document.getElementById('seat_scenario_select').value = name;
    }

    function FB_loadScenario() {
        const name = document.getElementById('seat_scenario_select').value;
        if (!name) return;
        
        const cls = FB_CLASSES[FB_CUR_CLASS_IDX];
        if (cls.scenarios && cls.scenarios[name]) {
            if(!confirm(`ç¡®å®šè¦åŠ è½½ [${name}] æ–¹æ¡ˆå—ï¼Ÿ\nå½“å‰æœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚`)) {
                document.getElementById('seat_scenario_select').value = "";
                return;
            }
            // æ¢å¤å¸ƒå±€
            cls.seatLayout = JSON.parse(JSON.stringify(cls.scenarios[name]));
            FB_renderSeatMap();
        }
    }

    function FB_deleteScenario() {
        const name = document.getElementById('seat_scenario_select').value;
        if (!name) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„æ–¹æ¡ˆ");
        
        if(confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ–¹æ¡ˆ [${name}] å—ï¼Ÿ`)) {
            const cls = FB_CLASSES[FB_CUR_CLASS_IDX];
            delete cls.scenarios[name];
            FB_initScenarioSelect();
        }
    }

    // Hook: åœ¨æ‰“å¼€åº§ä½è¡¨æ—¶åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
    // éœ€è¦ä¿®æ”¹ FB_openSeatMap å‡½æ•°ï¼Œè¿™é‡Œé€šè¿‡é‡å†™æˆ–åœ¨åŸå‡½æ•°åè¿½åŠ é€»è¾‘
    // ä¸ºäº†ç®€å•ï¼Œè¯·åœ¨ FB_openSeatMap å‡½æ•°å†…éƒ¨æœ«å°¾æ·»åŠ  FB_initScenarioSelect();

    // ================== æ™ºèƒ½è€ƒåœºç¼–æ’é€»è¾‘ ==================
    function EXAM_loadData(input) {
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, {type: 'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(!json.length) throw new Error("Excelæ²¡æœ‰æ•°æ®");
                EXAM_DATA = json.map(r => ({ name: r['å§“å'] || 'æœªçŸ¥', class: r['ç­çº§'] || r['ç­'] || 'æœªçŸ¥', school: r['å­¦æ ¡'] || '', score: parseFloat(r['æ€»åˆ†'] || r['score'] || 0) }));
                alert(`âœ… å·²å¯¼å…¥ ${EXAM_DATA.length} åå­¦ç”Ÿï¼Œå‡†å¤‡è¿›è¡Œè€ƒåœºç¼–æ’ã€‚`);
            } catch(err) { alert("è¯»å–å¤±è´¥ï¼š" + err.message); }
        }; reader.readAsArrayBuffer(file);
    }

    function EXAM_generate() {
        if(!EXAM_DATA.length) return alert("è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•"); 
        
        const prefix = document.getElementById('exam_prefix').value; 
        const seatsPerRoom = parseInt(document.getElementById('exam_seats_per_room').value) || 30;
        const useSeparate = document.getElementById('exam_opt_separate').checked;
        const useSnake = document.getElementById('exam_opt_snake').checked;

        // 1. åˆæ­¥æ’åºï¼šæŒ‰æˆç»©é™åº (ä¿è¯è€ƒåœºåˆ†å±‚)
        let list = [...EXAM_DATA].sort((a,b) => b.score - a.score);
        
        // 2. åŒç­äº’æ–¥é€»è¾‘ (æ ¸å¿ƒä¸šåŠ¡å‡çº§)
        // åŸç†ï¼šéå†åˆ—è¡¨ï¼Œå¦‚æœå‘ç°å½“å‰å­¦ç”Ÿä¸ä¸Šä¸€ä¸ªå­¦ç”ŸåŒç­ï¼Œåˆ™å‘åå¯»æ‰¾éåŒç­å­¦ç”Ÿè¿›è¡Œäº¤æ¢
        // é™åˆ¶ï¼šä»…åœ¨å°èŒƒå›´å†…(å¦‚å10å)å¯»æ‰¾ï¼Œé¿å…ç ´åæˆç»©åˆ†å±‚å¤ªä¸¥é‡
        if (useSeparate) {
            let swapCount = 0;
            for (let i = 1; i < list.length - 1; i++) {
                // å¦‚æœå½“å‰å­¦ç”Ÿä¸å‰ä¸€ä¸ªåŒç­
                if (list[i].class === list[i-1].class) {
                    // å‘åå¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªä¸åŒç­åŒå­¦
                    let swapped = false;
                    for (let j = i + 1; j < Math.min(i + 15, list.length); j++) {
                        if (list[j].class !== list[i].class && list[j].class !== list[i-1].class) {
                            // äº¤æ¢ä½ç½®
                            [list[i], list[j]] = [list[j], list[i]];
                            swapped = true;
                            swapCount++;
                            break;
                        }
                    }
                }
            }
            if(swapCount > 0) UI.toast(`å·²æ™ºèƒ½å¾®è°ƒ ${swapCount} äººæ¬¡ä»¥æ‰“æ•£åŒç­åŒå­¦`, 'success');
        }

        EXAM_ROOMS = [];
        const cols = 4; // å‡è®¾æ¯è¡Œ4åˆ— (ç”¨äºè®¡ç®—è›‡å½¢)

        list.forEach((s, i) => {
            // åŸºç¡€è€ƒå·é€»è¾‘
            s.examNo = prefix + String(i+1).padStart(3, '0'); 
            s.roomNo = Math.floor(i / seatsPerRoom) + 1; 
            
            // 3. åº§ä½å·è®¡ç®—
            let seatIdx = (i % seatsPerRoom); // 0 ~ 29
            
            // è›‡å½¢æ’åˆ—é€»è¾‘ (Så‹)
            // å‡è®¾æ’åˆ—æ˜¯ï¼š
            // 1 2 3 4
            // 8 7 6 5 (åå‘)
            // 9 10 11 12
            if (useSnake) {
                const row = Math.floor(seatIdx / cols);
                // å¦‚æœæ˜¯å¥‡æ•°è¡Œ(ç¬¬2è¡Œ, idx=1)ï¼Œåˆ™åˆ—å·åè½¬
                if (row % 2 !== 0) {
                    const col = seatIdx % cols;
                    const reversedCol = (cols - 1) - col;
                    // é‡æ–°è®¡ç®— seatIdx
                    seatIdx = (row * cols) + reversedCol;
                }
            }
            
            s.seatNo = seatIdx + 1;

            if(!EXAM_ROOMS[s.roomNo-1]) { 
                EXAM_ROOMS[s.roomNo-1] = { id: s.roomNo, students: [] }; 
            } 
            EXAM_ROOMS[s.roomNo-1].students.push(s);
        });

        // å¦‚æœç”¨äº†è›‡å½¢ï¼ŒæŒ‰åº§å·é‡æ–°æ’åºä¸€ä¸‹ï¼Œæ–¹ä¾¿æ‰“å°æŸ¥çœ‹
        if (useSnake) {
            EXAM_ROOMS.forEach(r => r.students.sort((a,b) => a.seatNo - b.seatNo));
        }

        document.getElementById('exam-results-area').classList.remove('hidden'); 
        EXAM_renderOverview(); 
        EXAM_renderStudentList(); 
        EXAM_renderProctorTable(); 
        EXAM_renderPrintView();
    }

    function EXAM_switchView(view, btn) {
        document.querySelectorAll('#exam-results-area .nav-link').forEach(l => l.classList.remove('active')); btn.classList.add('active');
        document.getElementById('exam-view-overview').classList.add('hidden'); document.getElementById('exam-view-students').classList.add('hidden'); document.getElementById('exam-view-proctor').classList.add('hidden'); document.getElementById('exam-view-'+view).classList.remove('hidden');
    }

    function EXAM_renderOverview() {
        const container = document.getElementById('exam_room_grid'); container.innerHTML = '';
        EXAM_ROOMS.forEach(room => { const first = room.students[0].examNo; const last = room.students[room.students.length-1].examNo; container.innerHTML += `<div class="exam-room-card" onclick="alert('æç¤ºï¼šè¯·ä½¿ç”¨â€œæ‰“å°æ¡Œè´´â€åŠŸèƒ½æŸ¥çœ‹è¯¥è€ƒåœºçš„è¯¦ç»†åº§æ¬¡è¡¨')"><div class="exam-room-title">ç¬¬ ${String(room.id).padStart(2,'0')} è€ƒåœº</div><div class="exam-room-info"><span>äººæ•°: ${room.students.length}</span></div><div class="exam-room-range">${first} - ${last}</div></div>`; });
    }

    function EXAM_renderStudentList() {
        const tbody = document.querySelector('#exam_student_table tbody'); let html = '';
        const sorted = [...EXAM_DATA].sort((a,b) => { if(a.class !== b.class) return String(a.class).localeCompare(String(b.class), undefined, {numeric:true}); return a.examNo.localeCompare(b.examNo); });
        sorted.slice(0, 500).forEach(s => { html += `<tr><td>${s.examNo}</td><td>${s.name}</td><td>${s.class}</td><td>${String(s.roomNo).padStart(2,'0')}</td><td>${String(s.seatNo).padStart(2,'0')}</td><td>${s.score}</td></tr>`; });
        if(sorted.length > 500) html += `<tr><td colspan="6" style="text-align:center">...æ›´å¤šæ•°æ®è¯·å¯¼å‡ºExcelæŸ¥çœ‹...</td></tr>`; tbody.innerHTML = html;
    }

    function EXAM_renderProctorTable() {
        const tbody = document.querySelector('#exam_proctor_table tbody'); let html = '';
        EXAM_ROOMS.forEach(room => { const first = room.students[0].examNo; const last = room.students[room.students.length-1].examNo; html += `<tr><td>ç¬¬ ${String(room.id).padStart(2,'0')} è€ƒåœº</td><td>${room.students.length}</td><td>${first} - ${last}</td><td></td><td></td></tr>`; });
        tbody.innerHTML = html;
    }

    function EXAM_renderPrintView() {
        const container = document.getElementById('batch-print-area-wrapper'); if(!container) return; container.innerHTML = ''; let html = '';
        EXAM_ROOMS.forEach(room => {
            let seatsHtml = ''; room.students.forEach(s => { seatsHtml += `<div class="exam-print-seat"><div class="exam-print-seat-num">ç¬¬${String(s.seatNo).padStart(2,'0')}å·</div><div class="exam-print-seat-name">${s.name}</div><div class="exam-print-seat-id">è€ƒå·: ${s.examNo}</div><div style="font-size:10px;">${s.class}</div></div>`; });
            html += `<div class="exam-print-page"><div class="exam-print-header">ç¬¬ ${String(room.id).padStart(2,'0')} è€ƒåœºåº§ä½è¡¨ (å…±${room.students.length}äºº)</div><div class="exam-print-grid">${seatsHtml}</div><div style="margin-top:20px; font-size:12px;">ç›‘è€ƒå‘˜ç­¾å­—ï¼š_________________   &nbsp;&nbsp;&nbsp; å·¡è€ƒå‘˜ç­¾å­—ï¼š_________________</div></div>`;
        });
        container.innerHTML = html;
    }

    function EXAM_generateDeskLabels() {
        if (!EXAM_ROOMS || EXAM_ROOMS.length === 0) return alert("è¯·å…ˆç‚¹å‡»â€œä¸€é”®ç”Ÿæˆè€ƒåœºå®‰æ’â€");
        
        const container = document.getElementById('desk-labels-print-area');
        container.innerHTML = ''; 
        let html = '';

        EXAM_ROOMS.forEach(room => {
            html += `<div class="desk-label-page">`; 
            
            room.students.forEach(s => {
                html += `
                    <div class="desk-label-card">
                        <!-- 1. é¡¶éƒ¨ï¼šè€ƒå· (æœ€å¤§) -->
                        <div class="dl-exam-no">${s.examNo}</div>
                        
                        <!-- 2. ä¸­é—´ï¼šç­çº§(å·¦) + å§“å(å³) (ä¸­ç­‰) -->
                        <div class="dl-main-row">
                            <span>${s.class}</span>
                            <span>${s.name}</span>
                        </div>
                        
                        <!-- 3. åº•éƒ¨ï¼šè€ƒåœº + åº§å· (æœ€å°) -->
                        <div class="dl-footer-row">
                            <span class="dl-room-box">${String(room.id).padStart(2,'0')}åœº</span>
                            <span class="dl-seat-box">${String(s.seatNo).padStart(2,'0')}åº§</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`; 
        });

        container.innerHTML = html;
        UI.toast("âœ… æ¡Œè´´ç”Ÿæˆå®Œæ¯• (è€ƒå·æœ€å¤§åŒ–)", "success");

        const app = document.getElementById('app');
        const labelsArea = document.getElementById('desk-labels-print-area');
        const originalDisplay = app.style.display;
        
        app.style.display = 'none';
        labelsArea.style.display = 'block';

        setTimeout(() => {
            window.print();
            app.style.display = originalDisplay;
            labelsArea.style.display = 'none';
            container.innerHTML = ''; 
        }, 500);
    }

    // åˆå§‹åŒ–æ•™å¸ˆå‹¾é€‰åˆ—è¡¨å’Œä¸‹æ‹‰æ¡†
    function EXAM_initProctorUI() {
        const teachers = [...new Set(Object.values(TEACHER_MAP))].sort();
        const poolContainer = document.getElementById('proctor-teacher-pool');
        const patrolSel = document.getElementById('proctor-role-patrol');
        const affairsSel = document.getElementById('proctor-role-affairs');
        
        if (!teachers.length) return;

        // æ¸²æŸ“é»‘åå•å‹¾é€‰
        poolContainer.innerHTML = teachers.map(name => `
            <label class="teacher-item">
                <input type="checkbox" class="exclude-check" value="${name}"> ${name}
            </label>
        `).join('');

        // æ¸²æŸ“å¤šé€‰ä¸‹æ‹‰æ¡†
        const options = teachers.map(name => `<option value="${name}">${name}</option>`).join('');
        patrolSel.innerHTML = options;
        affairsSel.innerHTML = options;
    }

    // æ‰§è¡Œç¼–æ’é€»è¾‘
    function EXAM_assignProctors() {
        if (!EXAM_ROOMS.length) return alert("è¯·å…ˆç”Ÿæˆè€ƒåœºå®‰æ’");

        const allTeachers = [...new Set(Object.values(TEACHER_MAP))];
        
        // è·å–æ’é™¤äººå‘˜
        const excluded = Array.from(document.querySelectorAll('.exclude-check:checked')).map(el => el.value);
        
        // è·å–ç‰¹æ®Šå²—ä½äººå‘˜
        const patrols = Array.from(document.getElementById('proctor-role-patrol').selectedOptions).map(o => o.value);
        const affairs = Array.from(document.getElementById('proctor-role-affairs').selectedOptions).map(o => o.value);

        // å¯ç”¨ç›‘è€ƒæ±  = æ€»äººå‘˜ - æ’é™¤ - ç‰¹æ®Šå²—ä½
        let availablePool = allTeachers.filter(t => 
            !excluded.includes(t) && !patrols.includes(t) && !affairs.includes(t)
        );

        const needed = EXAM_ROOMS.length * 2;
        if (availablePool.length < needed) {
            return alert(`âŒ äººå‘˜ä¸è¶³ï¼\nå½“å‰è€ƒåœºéœ€è¦ ${needed} åç›‘è€ƒï¼Œä½†æ’é™¤åä»…å‰© ${availablePool.length} äººã€‚\nè¯·å‡å°‘æ’é™¤é¡¹æˆ–åˆå¹¶å²—ä½ã€‚`);
        }

        // æ´—ç‰Œç®—æ³•ä¹±åº
        availablePool.sort(() => Math.random() - 0.5);

        // å¡«å……ç›‘è€ƒæ±‡æ€»è¡¨
        const tbody = document.querySelector('#exam_proctor_table tbody');
        let html = '';
        EXAM_ROOMS.forEach((room, i) => {
            const p1 = availablePool[i * 2];
            const p2 = availablePool[i * 2 + 1];
            const first = room.students[0].examNo;
            const last = room.students[room.students.length-1].examNo;
            
            html += `
                <tr>
                    <td><strong>ç¬¬ ${String(room.id).padStart(2,'0')} è€ƒåœº</strong></td>
                    <td>${room.students.length}</td>
                    <td>${first} - ${last}</td>
                    <td style="background:#eff6ff; font-weight:bold;">${p1}</td>
                    <td style="background:#eff6ff; font-weight:bold;">${p2}</td>
                </tr>
            `;
        });

        // åº•éƒ¨è¿½åŠ è€ƒåŠ¡ç»„
        html += `
            <tr style="background:#f8fafc; border-top: 2px solid #333;">
                <td colspan="3" style="text-align:right; font-weight:bold;">âš–ï¸ çºªå¾‹å·¡è€ƒäººå‘˜ï¼š</td>
                <td colspan="2" style="text-align:left; color:var(--danger); font-weight:bold;">${patrols.join('ã€') || 'æœªæŒ‡å®š'}</td>
            </tr>
            <tr style="background:#f8fafc;">
                <td colspan="3" style="text-align:right; font-weight:bold;">ğŸ§¹ å«ç”Ÿè€ƒåŠ¡ä¿éšœï¼š</td>
                <td colspan="2" style="text-align:left; color:var(--success); font-weight:bold;">${affairs.join('ã€') || 'æœªæŒ‡å®š'}</td>
            </tr>
        `;

        tbody.innerHTML = html;
        UI.toast("âœ… ç›‘è€ƒäººå‘˜åˆ†é…å®Œæˆï¼Œè¯·æŸ¥çœ‹â€œç›‘è€ƒæ±‡æ€»è¡¨â€", "success");
        // è‡ªåŠ¨åˆ‡åˆ°æ±‡æ€»è¡¨çœ‹ç»“æœ
        EXAM_switchView('proctor', document.querySelector('.nav-link[onclick*="proctor"]'));
    }

    function EXAM_exportResult() {
        if(!EXAM_DATA.length) return alert("æ— è€ƒç”Ÿæ•°æ®"); 
        if(!EXAM_ROOMS.length) return alert("è¯·å…ˆç”Ÿæˆè€ƒåœºå®‰æ’");

        const wb = XLSX.utils.book_new();
        
        // 1. è€ƒç”Ÿæ€»è¡¨
        const sheet1Data = [['è€ƒå·','å§“å','å­¦æ ¡','ç­çº§','è€ƒåœºå·','åº§å·','å‚è€ƒåˆ†']]; 
        EXAM_DATA.forEach(s => sheet1Data.push([s.examNo, s.name, s.school, s.class, s.roomNo, s.seatNo, s.score]));
        
        // 2. ç›‘è€ƒäººå‘˜å®‰æ’è¡¨ (æ ¸å¿ƒï¼šç›´æ¥è¯»å–ç•Œé¢è¡¨æ ¼ï¼Œæ‰€è§å³æ‰€å¾—)
        const sheet2Data = [['å•ä½/è€ƒåœº','åº”è€ƒäººæ•°','èµ·æ­¢è€ƒå·','ç›‘è€ƒè€å¸ˆ A','ç›‘è€ƒè€å¸ˆ B']];
        const proctorRows = document.querySelectorAll('#exam_proctor_table tbody tr');
        
        if (proctorRows.length === 0) {
            alert("âš ï¸ æç¤ºï¼šæ‚¨å°šæœªè¿›è¡Œâ€œäººå‘˜é…ç½®â€æˆ–ç‚¹å‡»â€œä¸€é”®ç¼–æ’â€ã€‚ç›‘è€ƒè¡¨å°†åªåŒ…å«è€ƒç”Ÿä¿¡æ¯ã€‚");
        } else {
            proctorRows.forEach(tr => {
                const tds = tr.querySelectorAll('td');
                const rowData = [];
                tds.forEach(td => rowData.push(td.innerText));
                sheet2Data.push(rowData);
            });
        }

        // 3. è€ƒåœºå‚è€ƒè¡¨
        const sheet3Data = [['è€ƒåœº','åº§å·','å§“å','è€ƒå·','ç­çº§']]; 
        EXAM_DATA.forEach(s => sheet3Data.push([s.roomNo, s.seatNo, s.name, s.examNo, s.class]));
        
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet1Data), "è€ƒç”Ÿåº§æ¬¡æ€»è¡¨"); 
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet2Data), "å…¨æ ¡ç›‘è€ƒè€ƒåŠ¡è¡¨"); 
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet3Data), "æ¡Œè´´æ‰“å°å¤‡ä»½"); 
        
        XLSX.writeFile(wb, `${CONFIG.name || 'å­¦æ ¡'}è€ƒåŠ¡ç¼–æ’ç»“æœå…¨é›†.xlsx`);
    }

    const SCHEDULER = {
        data: [], // å­˜å‚¨å¯¼å…¥çš„ {teacher, subject, classes:[], hours}
        schedule: {}, // ç»“æœ
        classes: [], // æ‰€æœ‰ç­çº§åˆ—è¡¨
        
        // å­˜å‚¨åŠ¨æ€æ·»åŠ çš„è§„åˆ™
        rules: {
            meetings: [], // ç­ä¼š [{day:1, slot:'pm_3'}]
            busy: [],     // æ•™å¸ˆå¿™
            activities: [], // æ´»åŠ¨
            combined: []  // ğŸŸ¢ æ–°å¢ï¼šåˆå ‚è§„åˆ™ [{subject:'ç‰©ç†', slot:'eve_3'}]
        },

        // --- 1. çº¦æŸè§„åˆ™ç®¡ç† (æ›´æ–°) ---
        addConstraint: function(type) {
            // ğŸŸ¢ æ–°å¢ combined ç±»å‹çš„å¤„ç†
            if (type === 'combined') {
                const subject = document.getElementById('sch_comb_subject').value;
                const slot = document.getElementById('sch_comb_slot').value; // 'eve_3'
                
                // æŸ¥é‡ï¼šåŒä¸€ä¸ªå­¦ç§‘ä¸èƒ½é‡å¤æ·»åŠ è§„åˆ™
                if(this.rules.combined.some(r => r.subject === subject)) {
                    return alert(`å­¦ç§‘ [${subject}] å·²å­˜åœ¨åˆå ‚è§„åˆ™ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ã€‚`);
                }
                
                this.rules.combined.push({ subject, slot, id: Date.now() });
                this.renderTags('combined', this.rules.combined, r => `ğŸ”— ${r.subject} (${this.getSlotName(r.slot)} åˆå ‚)`);
            }
            else if (type === 'meeting') {
                const day = document.getElementById('sch_meet_day').value;
                const slot = document.getElementById('sch_meet_slot').value;
                const key = `${day}_${slot}`;
                if(this.rules.meetings.some(m => `${m.day}_${m.slot}` === key)) return;
                
                this.rules.meetings.push({ day, slot, id: Date.now() });
                this.renderTags('meeting', this.rules.meetings, m => `å‘¨${m.day} ${this.getSlotName(m.slot)} (ç­ä¼š)`);
            }
            else if (type === 'busy') {
                const day = document.getElementById('sch_busy_day').value;
                const name = document.getElementById('sch_busy_name').value.trim();
                const slotsRaw = document.getElementById('sch_busy_slots').value.trim();
                if(!name || !slotsRaw) return alert("è¯·å¡«å†™æ•™å¸ˆå§“åå’ŒèŠ‚æ¬¡");
                
                this.rules.busy.push({ day, slotsStr: slotsRaw, name, id: Date.now() });
                this.renderTags('busy', this.rules.busy, b => `${b.name}: å‘¨${b.day} [${b.slotsStr}] ä¸æ’`);
                document.getElementById('sch_busy_name').value = '';
            }
            else if (type === 'activity') {
                const day = document.getElementById('sch_act_day').value;
                const range = document.getElementById('sch_act_range').value;
                const subject = document.getElementById('sch_act_subject').value;
                let labelRange = range === 'pm_all' ? 'ä¸‹åˆ' : (range === 'am_all' ? 'ä¸Šåˆ' : 'æŒ‡å®šèŠ‚');
                
                this.rules.activities.push({ day, range, subject, id: Date.now() });
                this.renderTags('activity', this.rules.activities, a => `å‘¨${a.day} ${labelRange} (${a.subject==="ALL"?"å…¨çº§æ— è¯¾":a.subject+"æ•™ç ”"})`);
            }
        },

        removeConstraint: function(type, id) {
            if(type === 'meeting') this.rules.meetings = this.rules.meetings.filter(x => x.id !== id);
            if(type === 'busy') this.rules.busy = this.rules.busy.filter(x => x.id !== id);
            if(type === 'activity') this.rules.activities = this.rules.activities.filter(x => x.id !== id);
            // ğŸŸ¢ æ–°å¢ combined åˆ é™¤
            if(type === 'combined') this.rules.combined = this.rules.combined.filter(x => x.id !== id);
            
            // é‡æ–°æ¸²æŸ“å¯¹åº”åŒºåŸŸ
            if(type === 'meeting') this.renderTags('meeting', this.rules.meetings, m => `å‘¨${m.day} ${this.getSlotName(m.slot)} (ç­ä¼š)`);
            if(type === 'busy') this.renderTags('busy', this.rules.busy, b => `${b.name}: å‘¨${b.day} [${b.slotsStr}] ä¸æ’`);
            if(type === 'activity') this.renderTags('activity', this.rules.activities, a => `å‘¨${a.day} ${a.range} (${a.subject})`);
            // ğŸŸ¢ æ–°å¢ combined æ¸²æŸ“
            if(type === 'combined') this.renderTags('combined', this.rules.combined, r => `ğŸ”— ${r.subject} (${this.getSlotName(r.slot)} åˆå ‚)`);
        },

        renderTags: function(type, list, labelFn) {
            const container = document.getElementById(`sch_tags_${type}`);
            if(!container) return; // é˜²å¾¡æ€§æ£€æŸ¥
            container.innerHTML = '';
            list.forEach(item => {
                const tag = document.createElement('div');
                tag.className = 'tag-chip';
                // æ ¹æ®ç±»å‹ç»™ä¸åŒé¢œè‰²
                if(type === 'meeting') tag.style.background = '#e0e7ff';
                if(type === 'busy') tag.style.background = '#fff7ed';
                if(type === 'activity') tag.style.background = '#dcfce7';
                if(type === 'combined') { tag.style.background = '#ffedd5'; tag.style.color = '#9a3412'; }
                tag.innerHTML = `${labelFn(item)} <span class="tag-chip-remove" onclick="SCHEDULER.removeConstraint('${type}', ${item.id})">&times;</span>`;
                container.appendChild(tag);
            });
        },

        getSlotName: function(code) {
            const map = { 'am': 'ä¸Šåˆ', 'pm': 'ä¸‹åˆ', 'eve': 'æ™š' };
            const parts = code.split('_');
            if(parts.length >= 2) return `${map[parts[0]] || ''}ç¬¬${parts[parts.length-1]}èŠ‚`;
            return code;
        },

        // ... (downloadTemplate, loadData, renderPreview ä¿æŒä¸å˜) ...

        // --- æ ¸å¿ƒæ’è¯¾é€»è¾‘ (Run) ---
        run: function() {
            if(!this.data.length) return alert("è¯·å…ˆå¯¼å…¥æ•™å¸ˆä»»è¯¾æ•°æ®");
            
            const btn = document.querySelector('#grade-scheduler .btn-primary');
            btn.innerHTML = '<i class="ti ti-loader"></i> æ­£åœ¨è¿›è¡Œå¤šç»´çº¦æŸè¿ç®—...';
            btn.disabled = true;

            setTimeout(() => {
                try {
                    // åˆå§‹åŒ–
                    this.schedule = {};
                    this.classes.forEach(c => this.schedule[c] = {});
                    
                    const days = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'];
                    const am = parseInt(document.getElementById('sch_am_count').value);
                    const pm = parseInt(document.getElementById('sch_pm_count').value);
                    const eve = parseInt(document.getElementById('sch_eve_count').value);
                    
                    // ç”Ÿæˆæ‰€æœ‰æ—¶é—´æ§½
                    const allSlots = [];
                    // ... (ä¿æŒåŸæœ‰çš„ slot ç”Ÿæˆé€»è¾‘) ...
                    days.forEach((d, dIdx) => {
                        const dayNum = dIdx + 1;
                        for(let i=1; i<=am; i++) allSlots.push({id: `d${dayNum}_am_${i}`, day: dayNum, period: i, type: 'am'});
                        for(let i=1; i<=pm; i++) allSlots.push({id: `d${dayNum}_pm_${i}`, day: dayNum, period: i, type: 'pm'});
                        for(let i=1; i<=eve; i++) allSlots.push({id: `d${dayNum}_eve_${i}`, day: dayNum, period: i, type: 'eve'});
                    });

                    // --- é˜¶æ®µ A & B (ä¿æŒä¸å˜ï¼Œç•¥) ---
                    // A. å…¨å±€å°é” (æ´»åŠ¨)
                    this.rules.activities.forEach(act => {
                        const targetSlots = this.resolveTimeRange(act.day, act.range, am, pm, eve);
                        this.classes.forEach(cls => {
                            targetSlots.forEach(slotId => {
                                if(act.subject === 'ALL') {
                                    this.schedule[cls][slotId] = { subject: 'ğŸš« æ— è¯¾', teacher: '-', fixed: true };
                                }
                                if(!this.schedule[cls]._blackList) this.schedule[cls]._blackList = {};
                                if(!this.schedule[cls]._blackList[slotId]) this.schedule[cls]._blackList[slotId] = [];
                                this.schedule[cls]._blackList[slotId].push(act.subject);
                            });
                        });
                    });

                    // B. å›ºå®šç­ä¼š
                    this.rules.meetings.forEach(meet => {
                        const slotId = `d${meet.day}_${meet.slot.replace(/pm|am|eve/, (m)=>m+'_')}`; // am_3 -> am_3
                        this.classes.forEach(cls => {
                            if(!this.schedule[cls][slotId]) {
                                this.schedule[cls][slotId] = { subject: 'ç­ä¼š', teacher: 'ç­ä¸»ä»»', fixed: true };
                            }
                        });
                    });

                    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ [æ ¸å¿ƒä¿®æ”¹] é˜¶æ®µ C: åº”ç”¨åŠ¨æ€åˆå ‚è¯¾ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                    // é€»è¾‘ï¼šéå†ç”¨æˆ·è®¾ç½®çš„åˆå ‚è§„åˆ™ (ä¾‹å¦‚: ç‰©ç† -> eve_3)
                    this.rules.combined.forEach(rule => {
                        const targetSubject = rule.subject;
                        const targetSlotSuffix = rule.slot.replace(/pm|am|eve/, (m)=>m+'_'); // e.g. "eve_3" -> "eve_3"
                        
                        // 1. æ‰¾å‡ºæ‰€æœ‰æ•™è¯¥å­¦ç§‘ä¸”æ•™å¤šä¸ªç­çš„è€å¸ˆ
                        const eligibleTeachers = this.data.filter(t => t.subject === targetSubject && t.classes.length > 1);
                        
                        eligibleTeachers.forEach(t => {
                            // 2. å¯»æ‰¾åˆé€‚çš„æ—¶é—´ (å‘¨1-5)
                            // å¿…é¡»ä¿è¯ï¼šè¯¥è€å¸ˆçš„æ‰€æœ‰ç­çº§ï¼Œåœ¨æŸä¸€å¤©çš„ targetSlot éƒ½æ˜¯ç©ºçš„
                            let allocatedDay = -1;
                            
                            // éšæœºå°è¯•å‘¨ä¸€åˆ°å‘¨äº” (å‡è¡¡åˆ†å¸ƒ)
                            const tryDays = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5);
                            
                            for (let dayNum of tryDays) {
                                const fullSlotId = `d${dayNum}_${targetSlotSuffix}`;
                                
                                // æ£€æŸ¥æ‰€æœ‰ç›¸å…³ç­çº§æ˜¯å¦ç©ºé—²
                                const allFree = t.classes.every(cls => {
                                    const cell = this.schedule[cls]?.[fullSlotId];
                                    // å¿…é¡»æ²¡è¯¾ï¼Œä¸”ä¸åœ¨é»‘åå•ä¸­
                                    const notBlocked = !cell && (!this.schedule[cls]._blackList?.[fullSlotId]?.includes(targetSubject));
                                    return notBlocked;
                                });

                                // æ£€æŸ¥è¯¥è€å¸ˆå½“å¤©è¯¥æ—¶æ®µæ˜¯å¦ç©ºé—² (é˜²æ­¢å’Œå…¶ä»–åˆå ‚æ’è½¦)
                                const teacherFree = !this.isTeacherBusyInOtherClass(t.name, fullSlotId);

                                if (allFree && teacherFree) {
                                    allocatedDay = dayNum;
                                    
                                    // 3. æ‰§è¡Œé”å®š
                                    t.classes.forEach(cls => {
                                        this.schedule[cls][fullSlotId] = { 
                                            subject: t.subject, 
                                            teacher: t.name + '(åˆ)', 
                                            fixed: true,
                                            isCombined: true
                                        };
                                    });
                                    
                                    // 4. æ‰£å‡è¯¥è€å¸ˆçš„å¾…æ’è¯¾æ—¶
                                    t.hours = Math.max(0, t.hours - 1);
                                    
                                    break; // è¯¥è€å¸ˆå®‰æ’å®Œæ¯•ï¼Œè·³å‡ºå¤©æ•°å¾ªç¯
                                }
                            }
                            
                            if (allocatedDay === -1) {
                                console.warn(`âš ï¸ è­¦å‘Šï¼šæ— æ³•ä¸º ${t.name} (${t.subject}) å®‰æ’åˆå ‚ï¼Œæ‰€æœ‰æ™šè‡ªä¹ æ—¶æ®µå‡å†²çªã€‚`);
                            }
                        });
                    });
                    // ğŸ‘†ğŸ‘†ğŸ‘† ğŸŸ¢ [ä¿®æ”¹ç»“æŸ] ğŸŸ¢ ğŸ‘†ğŸ‘†ğŸ‘†

                    // --- é˜¶æ®µ D: æ™ºèƒ½å¡«å…… (ä¿æŒä¸å˜) ---
                    // ...
                    const teacherBusyMap = {};
                    this.rules.busy.forEach(b => {
                        const slots = this.parseBusySlots(b.day, b.slotsStr, am, pm);
                        slots.forEach(sid => teacherBusyMap[`${b.name}_${sid}`] = true);
                    });

                    const queue = JSON.parse(JSON.stringify(this.data)).sort((a,b) => b.hours - a.hours);

                    queue.forEach(t => {
                        let remaining = t.hours;
                        t.classes.forEach(cls => {
                            if(!this.schedule[cls]) return;
                            let placedCount = 0;
                            const shuffledSlots = allSlots.sort(() => Math.random() - 0.5);

                            for(let sObj of shuffledSlots) {
                                if(remaining <= 0) break;
                                if(placedCount >= Math.ceil(t.hours / t.classes.length)) break; 

                                const sid = sObj.id;
                                if(this.schedule[cls][sid]) continue;
                                if(this.schedule[cls]._blackList && 
                                   this.schedule[cls]._blackList[sid] && 
                                   this.schedule[cls]._blackList[sid].includes(t.subject)) continue;
                                if(teacherBusyMap[`${t.name}_${sid}`]) continue;
                                if(this.isTeacherBusyInOtherClass(t.name, sid)) continue;
                                
                                const isFriEve = (sObj.day === 5 && sObj.type === 'eve' && document.getElementById('sch_rule_fri_eve').checked);
                                if(isFriEve) continue;

                                this.schedule[cls][sid] = { subject: t.subject, teacher: t.name };
                                remaining--;
                                placedCount++;
                            }
                        });
                    });

                    this.renderTable();
                    document.getElementById('sch_result_area').classList.remove('hidden');
                    UI.toast("âœ… æ’è¯¾å®Œæˆï¼å·²åº”ç”¨æ‰€æœ‰å¤æ‚çº¦æŸã€‚", "success");

                } catch(e) {
                    console.error(e);
                    alert("æ’è¯¾è¿ç®—å‡ºé”™: " + e.message);
                } finally {
                    btn.innerHTML = 'ğŸš€ å¼€å§‹æ™ºèƒ½æ’è¯¾';
                    btn.disabled = false;
                }
            }, 200);
        },

        // --- ğŸ§  AI ç–²åŠ³å®¡è®¡ ---
        auditFatigue: async function() {
            if (!this.schedule || !this.classes || !this.classes.length) return alert("è¯·å…ˆå®Œæˆæ’è¯¾");
            const area = document.getElementById('sch_audit_area');
            const summaryEl = document.getElementById('sch_audit_summary');
            const listEl = document.getElementById('sch_audit_list');
            if (!area || !summaryEl || !listEl) return;

            area.classList.remove('hidden');
            listEl.innerHTML = '';
            summaryEl.innerText = 'AI æ­£åœ¨åˆ†ææ’è¯¾ç–²åŠ³é£é™©...';

            const analysis = this.buildFatigueAnalysis();

            try {
                const prompt = this.buildFatiguePrompt(analysis);
                const aiText = await callUnifiedAI(prompt);
                const bullets = this.extractAuditBullets(aiText);
                this.renderAuditList(bullets.length ? bullets : [aiText.trim()]);
                summaryEl.innerText = `å·²å®Œæˆå®¡è®¡ï¼ˆ${analysis.meta.classCount} ä¸ªç­çº§ / ${analysis.meta.teacherCount} ä½æ•™å¸ˆï¼‰`;
            } catch (e) {
                console.error(e);
                const fallback = this.buildFallbackAuditList(analysis);
                this.renderAuditList(fallback);
                summaryEl.innerText = 'AI å®¡è®¡å¤±è´¥ï¼Œå·²å±•ç¤ºè§„åˆ™åŒ–é£é™©æç¤º';
            }
        },

        buildFatigueAnalysis: function() {
            const am = parseInt(document.getElementById('sch_am_count').value);
            const pm = parseInt(document.getElementById('sch_pm_count').value);
            const eve = parseInt(document.getElementById('sch_eve_count').value);

            const slotOrder = [];
            for (let i = 1; i <= am; i++) slotOrder.push({ type: 'am', code: `am_${i}` });
            for (let i = 1; i <= pm; i++) slotOrder.push({ type: 'pm', code: `pm_${i}` });
            for (let i = 1; i <= eve; i++) slotOrder.push({ type: 'eve', code: `eve_${i}` });

            const classStats = [];
            const teacherMap = {};

            this.classes.forEach(cls => {
                for (let day = 1; day <= 5; day++) {
                    let run = 0;
                    let maxRun = 0;
                    let total = 0;
                    let eveCount = 0;

                    slotOrder.forEach(slot => {
                        const slotId = `d${day}_${slot.code}`;
                        const cell = this.schedule[cls]?.[slotId];
                        const hasLesson = cell && cell.subject && cell.subject !== 'ğŸš« æ— è¯¾';

                        if (hasLesson) {
                            total++;
                            run++;
                            if (slot.type === 'eve') eveCount++;
                        } else {
                            run = 0;
                        }

                        if (run > maxRun) maxRun = run;

                        if (cell && cell.teacher && cell.teacher !== '-') {
                            const tName = String(cell.teacher).replace('(åˆ)', '').trim();
                            if (tName) {
                                if (!teacherMap[tName]) teacherMap[tName] = {};
                                if (!teacherMap[tName][day]) teacherMap[tName][day] = new Set();
                                teacherMap[tName][day].add(slot.code);
                            }
                        }
                    });

                    classStats.push({
                        class: cls,
                        day,
                        maxConsecutive: maxRun,
                        totalLessons: total,
                        eveningLessons: eveCount
                    });
                }
            });

            const teacherStats = [];
            Object.keys(teacherMap).forEach(teacher => {
                for (let day = 1; day <= 5; day++) {
                    const set = teacherMap[teacher][day];
                    if (!set || set.size === 0) continue;
                    let run = 0;
                    let maxRun = 0;
                    let total = 0;
                    let eveCount = 0;

                    slotOrder.forEach(slot => {
                        if (set.has(slot.code)) {
                            total++;
                            run++;
                            if (slot.type === 'eve') eveCount++;
                        } else {
                            run = 0;
                        }
                        if (run > maxRun) maxRun = run;
                    });

                    teacherStats.push({
                        teacher,
                        day,
                        maxConsecutive: maxRun,
                        totalLessons: total,
                        eveningLessons: eveCount
                    });
                }
            });

            const flags = {
                classConsecutiveOver4: classStats.filter(x => x.maxConsecutive >= 4).slice(0, 10),
                teacherConsecutiveOver3: teacherStats.filter(x => x.maxConsecutive >= 3).slice(0, 10),
                classEveningOver2: classStats.filter(x => x.eveningLessons >= 2).slice(0, 10),
                teacherEveningOver2: teacherStats.filter(x => x.eveningLessons >= 2).slice(0, 10)
            };

            return {
                meta: {
                    am, pm, eve,
                    classCount: this.classes.length,
                    teacherCount: Object.keys(teacherMap).length
                },
                classStats,
                teacherStats,
                flags
            };
        },

        buildFatiguePrompt: function(analysis) {
            const dayName = d => `å‘¨${['ä¸€','äºŒ','ä¸‰','å››','äº”'][d-1] || d}`;
            const topClasses = analysis.flags.classConsecutiveOver4
                .map(x => `${x.class}ç­ ${dayName(x.day)} è¿ç»­${x.maxConsecutive}èŠ‚`).join('ï¼›') || 'æ— ';
            const topTeachers = analysis.flags.teacherConsecutiveOver3
                .map(x => `${x.teacher} ${dayName(x.day)} è¿ç»­${x.maxConsecutive}èŠ‚`).join('ï¼›') || 'æ— ';
            const eveClasses = analysis.flags.classEveningOver2
                .map(x => `${x.class}ç­ ${dayName(x.day)} æ™šä¸Š${x.eveningLessons}èŠ‚`).join('ï¼›') || 'æ— ';
            const eveTeachers = analysis.flags.teacherEveningOver2
                .map(x => `${x.teacher} ${dayName(x.day)} æ™šä¸Š${x.eveningLessons}èŠ‚`).join('ï¼›') || 'æ— ';

            return `ä½ æ˜¯èµ„æ·±æ•™åŠ¡ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ’è¯¾ç–²åŠ³æ‘˜è¦ç»™å‡ºå®¡è®¡è¦ç‚¹ã€‚\n` +
                `è¦æ±‚ï¼šè¾“å‡º 5-8 æ¡è¦ç‚¹ï¼Œæ¯æ¡ä»¥â€œâ€¢ â€å¼€å¤´ï¼ŒåŒ…å«å…·ä½“å¯¹è±¡(ç­çº§/æ•™å¸ˆ/æ—¥æœŸ)+é£é™©+æ”¹è¿›å»ºè®®ã€‚ä¸è¦è¾“å‡ºä»£ç æˆ–Markdownä»£ç å—ã€‚\n\n` +
                `ã€æ‘˜è¦ã€‘\n` +
                `ç­çº§æ•°:${analysis.meta.classCount} æ•™å¸ˆæ•°:${analysis.meta.teacherCount} è¯¾æ—¶ç»“æ„: ä¸Šåˆ${analysis.meta.am} ä¸‹åˆ${analysis.meta.pm} æ™šè‡ªä¹ ${analysis.meta.eve}\n` +
                `è¿ç»­4èŠ‚åŠä»¥ä¸Šçš„ç­çº§: ${topClasses}\n` +
                `è¿ç»­3èŠ‚åŠä»¥ä¸Šçš„æ•™å¸ˆ: ${topTeachers}\n` +
                `å•æ—¥æ™šè‡ªä¹ â‰¥2èŠ‚çš„ç­çº§: ${eveClasses}\n` +
                `å•æ—¥æ™šè‡ªä¹ â‰¥2èŠ‚çš„æ•™å¸ˆ: ${eveTeachers}\n`;
        },

        buildFallbackAuditList: function(analysis) {
            const dayName = d => `å‘¨${['ä¸€','äºŒ','ä¸‰','å››','äº”'][d-1] || d}`;
            const list = [];
            analysis.flags.classConsecutiveOver4.forEach(x => {
                list.push(`ç­çº§${x.class} ${dayName(x.day)} è¿ç»­${x.maxConsecutive}èŠ‚ï¼Œå»ºè®®æ‰“æ•£ä¸»è¯¾å¹¶æ’å…¥è½»è´Ÿæ‹…è¯¾ã€‚`);
            });
            analysis.flags.teacherConsecutiveOver3.forEach(x => {
                list.push(`æ•™å¸ˆ${x.teacher} ${dayName(x.day)} è¿ç»­${x.maxConsecutive}èŠ‚ï¼Œå»ºè®®è°ƒæ•´ä¸ºé”™å³°æˆ–å¢åŠ ç©ºæ¡£ã€‚`);
            });
            analysis.flags.classEveningOver2.forEach(x => {
                list.push(`ç­çº§${x.class} ${dayName(x.day)} æ™šè‡ªä¹ ${x.eveningLessons}èŠ‚ï¼Œå»ºè®®å‡å°‘æ™šè‡ªä¹ å¼ºåº¦ã€‚`);
            });
            analysis.flags.teacherEveningOver2.forEach(x => {
                list.push(`æ•™å¸ˆ${x.teacher} ${dayName(x.day)} æ™šè‡ªä¹ ${x.eveningLessons}èŠ‚ï¼Œå»ºè®®é¿å…è¿ç»­æ™šè‡ªä¹ æ’ç­ã€‚`);
            });
            if (!list.length) list.push('æœªå‘ç°æ˜æ˜¾ç–²åŠ³é£é™©ï¼Œå¯ç»´æŒå½“å‰æ’è¯¾ç»“æ„ã€‚');
            return list.slice(0, 10);
        },

        extractAuditBullets: function(text) {
            if (!text) return [];
            let cleaned = text.replace(/```[\s\S]*?```/g, '').trim();
            const lines = cleaned.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            const bullets = [];
            lines.forEach(l => {
                const item = l.replace(/^[-*â€¢\d\.\)\s]+/g, '').trim();
                if (item) bullets.push(item);
            });
            if (!bullets.length && cleaned) bullets.push(cleaned);
            return bullets.slice(0, 10);
        },

        renderAuditList: function(items) {
            const listEl = document.getElementById('sch_audit_list');
            if (!listEl) return;
            listEl.innerHTML = '';
            items.forEach(text => {
                const tag = document.createElement('div');
                tag.className = 'tag-chip';
                tag.style.background = '#e0f2fe';
                tag.style.color = '#0c4a6e';
                tag.innerText = text;
                listEl.appendChild(tag);
            });
        },

        // --- è¾…åŠ©å‡½æ•° ---

        resolveTimeRange: function(day, rangeType, am, pm, eve) {
            const slots = [];
            const prefix = `d${day}`;
            if(rangeType === 'am_all') {
                for(let i=1; i<=am; i++) slots.push(`${prefix}_am_${i}`);
            } else if(rangeType === 'pm_all') {
                for(let i=1; i<=pm; i++) slots.push(`${prefix}_pm_${i}`);
            }
            return slots;
        },

        parseBusySlots: function(day, str, amLimit, pmLimit) {
            const res = [];
            const parts = str.split(/[,ï¼Œ]/);
            parts.forEach(p => {
                p = p.trim();
                if(!p) return;
                if(/^\d+$/.test(p)) {
                    let n = parseInt(p);
                    if(n <= amLimit) res.push(`d${day}_am_${n}`);
                    else if(n <= amLimit + pmLimit) res.push(`d${day}_pm_${n - amLimit}`);
                } else {
                    res.push(`d${day}_${p}`);
                }
            });
            return res;
        },

        isTeacherBusyInOtherClass: function(teacherName, slotId) {
            for(let cls of this.classes) {
                const cell = this.schedule[cls][slotId];
                if(cell && cell.teacher === teacherName) return true;
            }
            return false;
        },

        renderTable: function() {
            const mode = document.getElementById('sch_view_mode').value;
            let target = document.getElementById('sch_view_target').value;
            
            // åˆ‡æ¢ä¸‹æ‹‰æ¡†å†…å®¹
            const sel = document.getElementById('sch_view_target');
            if (mode === 'teacher') {
                const teachers = [...new Set(this.data.map(d=>d.name))];
                if(!teachers.includes(target)) {
                    sel.innerHTML = teachers.map(t => `<option value="${t}">${t}</option>`).join('');
                    target = teachers[0];
                }
            } else {
                if(!this.classes.includes(target)) {
                    sel.innerHTML = this.classes.map(c => `<option value="${c}">${c}ç­</option>`).join('');
                    target = this.classes[0];
                }
            }

            const table = document.getElementById('sch_table');
            const am = parseInt(document.getElementById('sch_am_count').value);
            const pm = parseInt(document.getElementById('sch_pm_count').value);
            const eve = parseInt(document.getElementById('sch_eve_count').value);
            const days = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'];

            let html = `<thead><tr><th style="width:80px;background:#f3f4f6;">èŠ‚æ¬¡</th>${days.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;

            // è¾…åŠ©ï¼šè·å–å•å…ƒæ ¼
            const getCellHtml = (day, slotStr) => {
                const slotId = `d${day}_${slotStr}`;
                let cellData = null;

                if (mode === 'class') {
                    cellData = this.schedule[target]?.[slotId];
                    if(!cellData) return '';
                    return `<div style="font-weight:bold; color:#1e3a8a;">${cellData.subject}</div><div style="font-size:10px; color:#666;">${cellData.teacher}</div>`;
                } else {
                    const foundCls = [];
                    this.classes.forEach(c => {
                        const s = this.schedule[c][slotId];
                        if(s && s.teacher.includes(target)) foundCls.push(c);
                    });
                    if(foundCls.length) return `<div style="font-weight:bold; color:#059669;">${foundCls.join(',')}ç­</div><div style="font-size:10px;">ä¸Šè¯¾</div>`;
                }
                return `<span style="color:#eee;">-</span>`;
            };

            // æ™¨è¯»
            if(document.getElementById('sch_rule_morning_read').checked) {
                html += `<tr style="background:#ecfdf5;"><td style="font-weight:bold; color:#047857;">æ—©è¯»</td>${[1,2,3,4,5].map(d=>`<td>${mode==='class'?'è¯­æ–‡/è‹±è¯­':'-'}</td>`).join('')}</tr>`;
            }

            // ä¸Šåˆ
            for(let i=1; i<=am; i++) {
                html += `<tr><td style="font-weight:bold;">ä¸Šåˆ${i}</td>`;
                for(let d=1; d<=5; d++) html += `<td>${getCellHtml(d, `am_${i}`)}</td>`;
                html += `</tr>`;
                if(i == document.getElementById('sch_big_break_pos').value) {
                    html += `<tr style="background:#fffbeb;"><td colspan="6" style="font-size:11px; color:#b45309; letter-spacing:1px;">ğŸƒ å¤§è¯¾é—´æ´»åŠ¨</td></tr>`;
                }
            }
            
            html += `<tr style="background:#f1f5f9;"><td colspan="6" style="font-size:11px; color:#64748b;">ğŸ½ï¸ åˆä¼‘ / åˆç»ƒ (13:30)</td></tr>`;

            // åˆç»ƒ
            if(document.getElementById('sch_rule_noon_write').checked) {
                html += `<tr style="background:#f0fdf4;"><td style="font-weight:bold;">åˆç»ƒ</td>`;
                for(let d=1; d<=5; d++) html += `<td>${mode==='class'?'ç»ƒå­—':'-'}</td>`;
                html += `</tr>`;
            }

            // ä¸‹åˆ
            for(let i=1; i<=pm; i++) {
                const isFriLimit = document.getElementById('sch_rule_fri_pm').checked;
                const friLimitVal = parseInt(document.getElementById('sch_fri_pm_val').value);
                
                html += `<tr><td style="font-weight:bold;">ä¸‹åˆ${i}</td>`;
                for(let d=1; d<=5; d++) {
                    if (d===5 && isFriLimit && i > friLimitVal) {
                        html += `<td style="background:#f1f1f1; color:#ccc;">(æ”¾å‡)</td>`;
                    } else {
                        html += `<td>${getCellHtml(d, `pm_${i}`)}</td>`;
                    }
                }
                html += `</tr>`;
            }

            html += `<tr style="background:#f1f5f9;"><td colspan="6" style="font-size:11px; color:#64748b;">ğŸŒ™ æ™šé¤</td></tr>`;

            // æ™šè‡ªä¹ 
            for(let i=1; i<=eve; i++) {
                const noFriEve = document.getElementById('sch_rule_fri_eve').checked;
                html += `<tr><td style="font-weight:bold;">æ™š${i}</td>`;
                for(let d=1; d<=5; d++) {
                    if(d===5 && noFriEve) html += `<td style="background:#f1f1f1;">-</td>`;
                    else html += `<td>${getCellHtml(d, `eve_${i}`)}</td>`;
                }
                html += `</tr>`;
            }

            html += `</tbody>`;
            table.innerHTML = html;
        },
        
        exportResult: function() {
            if(Object.keys(this.schedule).length === 0) return alert("æš‚æ— è¯¾è¡¨æ•°æ®");
            const wb = XLSX.utils.book_new();
            const data = [['ç­çº§', 'æ—¶æ®µ', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”']];
            const am = parseInt(document.getElementById('sch_am_count').value);
            
            this.classes.forEach(c => {
                for(let i=1; i<=am; i++) {
                    const row = [`${c}ç­`, `ä¸Šåˆ${i}`];
                    for(let d=1; d<=5; d++) {
                        const cell = this.schedule[c][`d${d}_am_${i}`];
                        row.push(cell ? `${cell.subject}\n(${cell.teacher})` : '');
                    }
                    data.push(row);
                }
                data.push(['---','---','---','---','---','---','---']);
            });
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "çº§éƒ¨æ€»è¯¾è¡¨");
            XLSX.writeFile(wb, "æ™ºèƒ½æ’è¯¾ç»“æœ.xlsx");
        },
        
        importExisting: function() { alert("åŠŸèƒ½å¼€å‘ä¸­ï¼šæ”¯æŒä¸Šä¼  Excel åå‘è§£æè¯¾è¡¨"); }
    };

    // åˆå§‹åŒ–ä¸‹æ‹‰æ¡† (å½“åˆ‡æ¢åˆ°æ­¤ Tab æ—¶è°ƒç”¨)
    function updatePosterSelects() {
        const schSel = document.getElementById('posterSchoolSelect');
        const subSel = document.getElementById('posterSubjectSelect');
        
        schSel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>';
        Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`);
        
        // å¡«å……ç§‘ç›® (ä¿ç•™æ€»åˆ†é€‰é¡¹)
        subSel.innerHTML = '<option value="total">ğŸ† æ€»åˆ†å…‰è£æ¦œ</option>';
        SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">ğŸ“˜ ${s}å•ç§‘çŠ¶å…ƒ</option>`);
        
        // é»˜è®¤è§¦å‘ä¸€æ¬¡ç­çº§æ›´æ–°
        updatePosterClassSelect();
    }

    function updatePosterClassSelect() {
        const sch = document.getElementById('posterSchoolSelect').value;
        const clsSel = document.getElementById('posterClassSelect');
        clsSel.innerHTML = '<option value="">å…¨æ ¡æ’å</option>';
        
        if(sch && SCHOOLS[sch]) {
            const classes = [...new Set(SCHOOLS[sch].students.map(s => s.class))].sort();
            classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`);
        }
    }

    function setPosterTheme(themeName, btn) {
        const canvas = document.getElementById('poster-canvas');
        // ç§»é™¤æ—§ä¸»é¢˜
        canvas.classList.remove('theme-red', 'theme-blue', 'theme-tech');
        // æ·»åŠ æ–°ä¸»é¢˜
        canvas.classList.add(`theme-${themeName}`);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const btns = btn.parentNode.querySelectorAll('.thumb-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function renderPoster() {
        const sch = document.getElementById('posterSchoolSelect').value;
        const cls = document.getElementById('posterClassSelect').value;
        const sub = document.getElementById('posterSubjectSelect').value;
        const limit = parseInt(document.getElementById('posterCount').value) || 10;
        const customTitle = document.getElementById('posterTitleInput').value;
        const customSub = document.getElementById('posterSubInput').value;

        if(!sch) return alert("è¯·å…ˆé€‰æ‹©å­¦æ ¡");

        // 1. ç­›é€‰æ•°æ®
        let students = SCHOOLS[sch].students;
        if(cls) students = students.filter(s => s.class === cls);
        
        // 2. æ’åºæ•°æ®
        const getScore = (s) => (sub === 'total') ? s.total : (s.scores[sub] || -1);
        
        // è¿‡æ»¤æ‰æ²¡æˆç»©çš„
        let list = students.filter(s => getScore(s) >= 0);
        list.sort((a,b) => getScore(b) - getScore(a));
        
        // æˆªå–å‰Nå
        list = list.slice(0, limit);

        // 3. æ›´æ–°æ ‡é¢˜
        const canvas = document.getElementById('poster-canvas');
        canvas.querySelector('.p-title').innerText = customTitle;
        canvas.querySelector('.p-sub').innerText = customSub || `${sch} ${cls||'å…¨å¹´çº§'} ${sub==='total'?'æ€»åˆ†':sub}å‰${limit}å`;

        // 4. æ¸²æŸ“åˆ—è¡¨
        const container = document.getElementById('poster-list-container');
        let html = '';
        
        if(list.length === 0) {
            html = '<div style="text-align:center; padding:50px;">æš‚æ— æ•°æ®</div>';
        } else {
            list.forEach((s, i) => {
                const scoreVal = getScore(s);
                // ä»…åœ¨å‰3åæ˜¾ç¤ºç‰¹æ®Šå›¾æ ‡ï¼Œå…¶ä»–æ˜¾ç¤ºæ•°å­—
                let rankDisplay = i + 1;
                // ä¸ºäº†é€šç”¨æ€§ï¼Œè¿™é‡Œç”¨çº¯æ•°å­—+CSSæ ·å¼æ§åˆ¶
                
                html += `
                <div class="p-item">
                    <div class="p-rank">${rankDisplay}</div>
                    <div class="p-name">
                        ${s.name} <span style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${s.class})</span>
                    </div>
                    <div class="p-score">${scoreVal}</div>
                </div>`;
            });
        }
        container.innerHTML = html;
    }

    function downloadPoster() {
        const canvasDiv = document.getElementById('poster-canvas');
        if(!canvasDiv) return;
        
        // é˜²æ­¢æˆªå›¾æ—¶æ–‡å­—è¢«æˆªæ–­æˆ–é”™ä½ï¼Œå…ˆä¸´æ—¶é”å®šå®½é«˜
        const originalTransform = canvasDiv.style.transform;
        canvasDiv.style.transform = "none"; // ç¡®ä¿æ— ç¼©æ”¾
        
        alert("ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡ï¼Œè¯·ç¨å€™...");
        
        setTimeout(() => {
            html2canvas(canvasDiv, {
                scale: 2, // 2å€é«˜æ¸…
                useCORS: true,
                backgroundColor: null, // é€æ˜èƒŒæ™¯
                logging: false
            }).then(canvas => {
                // æ¢å¤æ ·å¼
                if(originalTransform) canvasDiv.style.transform = originalTransform;
                
                // ä¸‹è½½
                const link = document.createElement('a');
                link.download = `å…‰è£æ¦œ_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL("image/png");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(err => {
                alert("ç”Ÿæˆå¤±è´¥: " + err.message);
            });
        }, 200);
    }

    // ================== ä¸´ç•Œç”Ÿç²¾å‡†æ¨é€é€»è¾‘ ==================
    function updateMpSchoolSelect() {
        const sel = document.getElementById('mpSchoolSelect'); const old = sel.value;
        sel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>'; Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        if(old && SCHOOLS[old]) sel.value = old;
        updateMpClassSelect();
        const subSel = document.getElementById('mpSubjectSelect'); const oldSub = subSel.value;
        subSel.innerHTML = '<option value="ALL">å…¨éƒ¨å­¦ç§‘</option>'; SUBJECTS.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
        if(oldSub) subSel.value = oldSub;
    }

    function updateMpClassSelect() {
        const sch = document.getElementById('mpSchoolSelect').value; const clsSel = document.getElementById('mpClassSelect');
        clsSel.innerHTML = '<option value="">å…¨éƒ¨ç­çº§</option>';
        if(sch && SCHOOLS[sch]) { const classes = [...new Set(SCHOOLS[sch].students.map(s => s.class))].sort(); classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`); }
    }

    function generateMarginalTickets() {
        const sch = document.getElementById('mpSchoolSelect').value; const clsLimit = document.getElementById('mpClassSelect').value; const subLimit = document.getElementById('mpSubjectSelect').value; const gap = parseFloat(document.getElementById('mpGap').value) || 5; const type = document.getElementById('mpType').value;
        if(!sch || !SCHOOLS[sch]) return alert("è¯·å…ˆé€‰æ‹©å­¦æ ¡");
        MP_DATA_CACHE = []; const container = document.getElementById('mp-tickets-container'); container.innerHTML = '';
        let students = SCHOOLS[sch].students; if(clsLimit) students = students.filter(s => s.class === clsLimit);
        let subjectsToAnalyze = (subLimit === 'ALL') ? SUBJECTS : [subLimit]; let taskMap = {};
        students.forEach(stu => {
            subjectsToAnalyze.forEach(sub => {
                if(stu.scores[sub] === undefined) return;
                const excLine = THRESHOLDS[sub].exc; const passLine = THRESHOLDS[sub].pass; const score = stu.scores[sub];
                let category = null; let targetScore = 0; let diff = 0;
                if (type !== 'pass') { if (score >= (excLine - gap) && score < excLine) { category = 'æ‹Ÿä¼˜'; targetScore = excLine; diff = excLine - score; } }
                if (!category && type !== 'exc') { if (score >= (passLine - gap) && score < passLine) { category = 'æ‹Ÿåˆæ ¼'; targetScore = passLine; diff = passLine - score; } }
                if (category) {
                    if (!taskMap[stu.class]) taskMap[stu.class] = {}; if (!taskMap[stu.class][sub]) taskMap[stu.class][sub] = [];
                    taskMap[stu.class][sub].push({ name: stu.name, score: score, category: category, target: targetScore, diff: parseFloat(diff.toFixed(1)), rank: safeGet(stu, `ranks.${sub}.class`, '-') });
                }
            });
        });
        let hasData = false;
        Object.keys(taskMap).sort().forEach(className => {
            Object.keys(taskMap[className]).forEach(subject => {
                const list = taskMap[className][subject]; if(list.length === 0) return; hasData = true;
                list.sort((a,b) => a.diff - b.diff);
                list.forEach(item => { MP_DATA_CACHE.push({ school: sch, class: className, subject: subject, name: item.name, score: item.score, category: item.category, target: item.target.toFixed(1), diff: item.diff }); });
                const teacherKey = `${className}_${subject}`; const teacherName = TEACHER_MAP[teacherKey] || "ç§‘ä»»è€å¸ˆ";
                let rows = ''; list.forEach(item => {
                    let gapClass = 'gap-green'; if(item.diff > gap/2) gapClass = 'gap-orange'; if(item.diff > gap*0.8) gapClass = 'gap-red';
                    let catStyle = item.category === 'æ‹Ÿä¼˜' ? 'color:var(--primary);font-weight:bold;' : 'color:#b45309;';
                    let warningTag = '';
                    const uid = sch + "_" + item.name;
                    if (ROLLER_COASTER_STUDENTS.includes(uid)) {
                        warningTag = '<br><span style="background:#fee2e2; color:#b91c1c; font-size:10px; padding:1px 3px; border-radius:3px;">âš ï¸ éœ€å¿ƒç†å¹²é¢„</span>';
                    }
                    rows += `<tr><td style="text-align:left; font-weight:bold;">${item.name}${warningTag}</td><td>${item.score}</td><td style="${catStyle}">${item.category}</td><td><span class="tag-gap ${gapClass}">å·® ${item.diff}åˆ†</span></td><td style="color:#999;">${item.rank}</td><td><div class="chk-box"></div></td></tr>`;
                });
                container.innerHTML += `<div class="task-ticket"><div class="ticket-header"><div><div class="ticket-title">${subject} Â· ${className}</div><div class="ticket-sub">æ•™å¸ˆ: ${teacherName} | ç›®æ ‡äººæ•°: ${list.length}äºº</div></div><div style="text-align:right;"><i class="ti ti-clipboard-check" style="font-size:24px; color:#cbd5e1;"></i></div></div><div class="ticket-body"><table class="ticket-table"><thead><tr><th style="text-align:left;">å­¦ç”Ÿå§“å</th><th>å½“å‰åˆ†</th><th>ç›®æ ‡</th><th>å·®è·</th><th>ç­æ’</th><th>è¾…å¯¼</th></tr></thead><tbody>${rows}</tbody></table><div style="padding:8px; font-size:11px; color:#999; border-top:1px dashed #eee; text-align:center;">ğŸ¯ ç›®æ ‡çº¿å‚è€ƒ: ä¼˜ç§€â‰¥${THRESHOLDS[subject].exc.toFixed(1)} / åŠæ ¼â‰¥${THRESHOLDS[subject].pass.toFixed(1)}</div></div></div>`;
            });
        });
        if(!hasData) container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px;"><p>ğŸ” åœ¨å½“å‰è®¾å®šèŒƒå›´å†…ï¼ˆ${gap}åˆ†ï¼‰æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¸´ç•Œç”Ÿã€‚</p><p style="color:#999;">è¯·å°è¯•å¢å¤§â€œä¸´ç•Œåˆ†å€¼â€æˆ–åˆ‡æ¢ç›®æ ‡ç±»å‹ã€‚</p></div>`;
    }

    function printMarginalTickets() { if(document.getElementById('mp-tickets-container').children.length === 0) return alert("è¯·å…ˆç”Ÿæˆä»»åŠ¡å•"); window.print(); }
    function exportMarginalTasks() {
        if(MP_DATA_CACHE.length === 0) return alert("è¯·å…ˆç”Ÿæˆæ•°æ®");
        const wb = XLSX.utils.book_new(); const data = [['å­¦æ ¡', 'ç­çº§', 'å­¦ç§‘', 'å§“å', 'å½“å‰åˆ†æ•°', 'ä¸´ç•Œç±»å‹', 'ç›®æ ‡åˆ†æ•°', 'åˆ†å·®']];
        MP_DATA_CACHE.forEach(d => { data.push([d.school, d.class, d.subject, d.name, d.score, d.category, d.target, d.diff]); });
        const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{wch:15}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}];
        XLSX.utils.book_append_sheet(wb, ws, "ä¸´ç•Œç”Ÿè¾…å¯¼åå•"); XLSX.writeFile(wb, "ä¸´ç•Œç”Ÿç²¾å‡†è¾…å¯¼ä»»åŠ¡å•.xlsx");
    }

    // --- ä¸´ç•Œç”Ÿé—­ç¯ç®¡ç†é€»è¾‘ ---

    // 1. åˆå§‹åŒ–ä¸‹æ‹‰æ¡† (é¡µé¢åŠ è½½æˆ–æ•°æ®å˜åŠ¨æ—¶è°ƒç”¨)
    function MP_initSnapshotSelect() {
        const sel = document.getElementById('mp_snapshot_select');
        if(!sel) return;
        sel.innerHTML = '<option value="">-- é€‰æ‹©å†å²ä»»åŠ¡ --</option>';
        Object.keys(MP_SNAPSHOTS).forEach(key => {
            const snap = MP_SNAPSHOTS[key];
            const date = new Date(snap.timestamp).toLocaleDateString();
            sel.innerHTML += `<option value="${key}">${key} (${snap.count}äºº, ${date})</option>`;
        });
    }
    // Hook: åœ¨ switchTab åˆ‡æ¢åˆ° marginal-push æ—¶åˆå§‹åŒ–
    // (ç”±äºæ— æ³•ç›´æ¥ä¿®æ”¹ switchTabï¼Œæˆ‘ä»¬åœ¨ä¿å­˜/åˆ é™¤åæ‰‹åŠ¨è°ƒç”¨ä¸€æ¬¡å³å¯ï¼Œé¦–æ¬¡åŠ è½½éœ€è¦ç”¨æˆ·ç‚¹å‡»ä¸€ä¸‹æˆ–è¢«åŠ¨è§¦å‘)
    // ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨ä¿å­˜åç›´æ¥åˆ·æ–°UI

    // 2. å­˜æ¡£å½“å‰ç”Ÿæˆçš„ä¸´ç•Œç”Ÿåå•
    function MP_saveSnapshot() {
        if (!MP_DATA_CACHE || MP_DATA_CACHE.length === 0) return alert("å½“å‰æ²¡æœ‰ç”Ÿæˆçš„ä¸´ç•Œç”Ÿåå•ï¼Œè¯·å…ˆè®¾ç½®å‚æ•°å¹¶ç‚¹å‡»'ç”Ÿæˆè¾…å¯¼å•'");
        
        const name = document.getElementById('mp_save_name').value.trim();
        if (!name) return alert("è¯·è¾“å…¥ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šåˆä¸€ä¸ŠæœŸä¸­ä¸´ç•Œç”Ÿï¼‰");
        
        if (MP_SNAPSHOTS[name] && !confirm(`ä»»åŠ¡å [${name}] å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) return;

        MP_SNAPSHOTS[name] = {
            timestamp: new Date().getTime(),
            count: MP_DATA_CACHE.length,
            data: MP_DATA_CACHE // ç»“æ„: {school, class, subject, name, category...}
        };
        
        localStorage.setItem('MP_SNAPSHOTS', JSON.stringify(MP_SNAPSHOTS));
        alert("âœ… å­˜æ¡£æˆåŠŸï¼ä¸‹æ¬¡è€ƒè¯•å¯¼å…¥æ•°æ®åï¼Œå¯é€‰æ‹©æ­¤ä»»åŠ¡è¿›è¡Œè½¬åŒ–ç‡åˆ†æã€‚");
        MP_initSnapshotSelect();
        document.getElementById('mp_save_name').value = '';
    }

    // 3. åˆ é™¤å­˜æ¡£
    function MP_deleteSnapshot() {
        const key = document.getElementById('mp_snapshot_select').value;
        if (!key) return;
        if (!confirm(`ç¡®å®šåˆ é™¤å†å²ä»»åŠ¡ [${key}] å—ï¼Ÿ`)) return;
        
        delete MP_SNAPSHOTS[key];
        localStorage.setItem('MP_SNAPSHOTS', JSON.stringify(MP_SNAPSHOTS));
        MP_initSnapshotSelect();
    }

    // 4. è®¡ç®—è½¬åŒ–ç‡ (æ ¸å¿ƒ)
    function MP_analyzeConversion() {
        const key = document.getElementById('mp_snapshot_select').value;
        if (!key) return alert("è¯·é€‰æ‹©ä¸€ä¸ªå†å²ä»»åŠ¡è¿›è¡Œå¯¹æ¯”");
        if (RAW_DATA.length === 0) return alert("è¯·å…ˆä¸Šä¼ ã€æœ¬æ¬¡è€ƒè¯•ã€‘çš„æˆç»©æ•°æ®");

        const snapshot = MP_SNAPSHOTS[key];
        const oldList = snapshot.data;
        
        // ç»Ÿè®¡å®¹å™¨: key = "School_Class_Subject_Category"
        const stats = {}; 

        oldList.forEach(task => {
            // å”¯ä¸€æ ‡è¯†ï¼šç­çº§+å­¦ç§‘+ç±»å‹ (å¦‚: 701_æ•°å­¦_æ‹ŸåŠæ ¼)
            // å°è¯•è·å–æ•™å¸ˆå
            const teacherKey = `${task.class}_${task.subject}`;
            const teacherName = TEACHER_MAP[teacherKey] || "æœªé…ç½®";
            
            const groupKey = `${task.school}::${task.class}::${teacherName}::${task.subject}::${task.category}`;
            
            if (!stats[groupKey]) {
                stats[groupKey] = { 
                    school: task.school, className: task.class, teacher: teacherName, 
                    subject: task.subject, category: task.category, 
                    total: 0, success: 0 
                };
            }
            
            stats[groupKey].total++;

            // åœ¨æœ¬æ¬¡æ•°æ®ä¸­å¯»æ‰¾è¯¥å­¦ç”Ÿ
            // åŒ¹é…é€»è¾‘ï¼šå§“å + å­¦æ ¡ (é˜²æ­¢åŒå)
            const currStudent = SCHOOLS[task.school]?.students.find(s => s.name === task.name);
            
            if (currStudent && currStudent.scores[task.subject] !== undefined) {
                const currScore = currStudent.scores[task.subject];
                const thresholds = THRESHOLDS[task.subject]; // æœ¬æ¬¡è€ƒè¯•çš„åˆ’çº¿
                
                let isSuccess = false;
                // åˆ¤æ–­é€»è¾‘ï¼š
                // å¦‚æœå½“åˆæ˜¯â€œæ‹Ÿä¼˜â€ï¼Œç°åœ¨æ˜¯å¦è¾¾åˆ°â€œä¼˜ç§€çº¿â€ï¼Ÿ
                // å¦‚æœå½“åˆæ˜¯â€œæ‹Ÿåˆæ ¼â€ï¼Œç°åœ¨æ˜¯å¦è¾¾åˆ°â€œåŠæ ¼çº¿â€ï¼Ÿ
                if (task.category === 'æ‹Ÿä¼˜' && currScore >= thresholds.exc) isSuccess = true;
                if (task.category === 'æ‹Ÿåˆæ ¼' && currScore >= thresholds.pass) isSuccess = true;
                
                if (isSuccess) stats[groupKey].success++;
            }
        });

        // æ¸²æŸ“ç»“æœ
        const tbody = document.querySelector('#mp_conversion_table tbody');
        let html = '';
        const sortedKeys = Object.keys(stats).sort();
        
        sortedKeys.forEach(k => {
            const d = stats[k];
            const rate = d.total > 0 ? (d.success / d.total) : 0;
            const ratePct = (rate * 100).toFixed(1) + '%';
            
            // è¯„ä»·å¾½ç« 
            let badge = '';
            if (rate >= 0.8) badge = '<span class="badge" style="background:#16a34a">â­â­â­ å“è¶Š</span>';
            else if (rate >= 0.5) badge = '<span class="badge" style="background:#2563eb">â­â­ è‰¯å¥½</span>';
            else if (rate >= 0.2) badge = '<span class="badge" style="background:#f59e0b">â­ ä¸€èˆ¬</span>';
            else badge = '<span class="badge" style="background:#dc2626">âš ï¸ éœ€åæ€</span>';

            html += `<tr>
                <td><div style="font-weight:bold;">${d.teacher}</div><div style="font-size:10px;color:#666">${d.className}</div></td>
                <td>${d.subject}</td>
                <td><span style="padding:2px 5px; background:${d.category==='æ‹Ÿä¼˜'?'#dbeafe':'#fef9c3'}; border-radius:4px; font-size:11px;">${d.category}</span></td>
                <td>${d.total}</td>
                <td style="font-weight:bold; color:#166534;">${d.success}</td>
                <td style="font-weight:bold; font-size:14px;">${ratePct}</td>
                <td>${badge}</td>
            </tr>`;
        });

        if (!html) html = '<tr><td colspan="7" style="text-align:center; padding:20px;">æœªåŒ¹é…åˆ°ä»»ä½•å­¦ç”Ÿï¼Œè¯·æ£€æŸ¥å§“åæ˜¯å¦ä¸€è‡´ã€‚</td></tr>';
        
        tbody.innerHTML = html;
        document.getElementById('mp-conversion-result').classList.remove('hidden');
    }
    
    // åˆå§‹åŒ–ä¸€æ¬¡
    window.addEventListener('load', MP_initSnapshotSelect);

    // ================== è€ƒååº§ä½å¾®è°ƒ (è”åŠ¨ç‰ˆ) ==================
    function updateSeatAdjSelects() {
        const schSel = document.getElementById('seatAdjSchoolSelect'); 
        const clsSel = document.getElementById('seatAdjClassSelect');
        
        // åˆå§‹åŒ–å­¦æ ¡ä¸‹æ‹‰æ¡†
        schSel.innerHTML = '<option value="">--è¯·é€‰æ‹©å­¦æ ¡--</option>';
        clsSel.innerHTML = '<option value="">--è¯·é€‰æ‹©ç­çº§--</option>';
        
        Object.keys(SCHOOLS).forEach(s => schSel.innerHTML += `<option value="${s}">${s}</option>`);
        
        // å­¦æ ¡å˜æ›´ -> æ›´æ–°ç­çº§
        schSel.onchange = () => {
            clsSel.innerHTML = '<option value="">--ç­çº§--</option>';
            if(schSel.value && SCHOOLS[schSel.value]) {
                const classes = [...new Set(SCHOOLS[schSel.value].students.map(s => s.class))].sort();
                classes.forEach(c => clsSel.innerHTML += `<option value="${c}">${c}</option>`);
            }
            // æ¸…ç©ºå­¦ç”Ÿåˆ—è¡¨
            CURRENT_CONTEXT_STUDENTS = []; 
            updateConstraintWidgetsContext('adj'); // ç«‹å³æ›´æ–°ä¸€æ¬¡ï¼Œæ¸…ç©ºä¸‹æ‹‰æ¡†
        };
        
        // ç­çº§å˜æ›´ -> æ›´æ–°å­¦ç”Ÿåå• (æ ¸å¿ƒä¿®å¤ç‚¹)
        clsSel.onchange = () => { 
            updateConstraintWidgetsContext('adj'); 
        };
    }
    function renderSeatGrid() { } // Placeholder

    function generateSeatSuggestions() {
        const sch = document.getElementById('seatAdjSchoolSelect').value; 
        const cls = document.getElementById('seatAdjClassSelect').value;
        if(!sch || !cls) return alert("è¯·å…ˆé€‰æ‹©å­¦æ ¡å’Œç­çº§");
        
        let students = [];
        if(SCHOOLS[sch] && SCHOOLS[sch].students) {
            students = JSON.parse(JSON.stringify(SCHOOLS[sch].students.filter(s => s.class === cls)));
        }
        if(!students.length) return alert("è¯¥ç­çº§æ— å­¦ç”Ÿæ•°æ®");

        const diffInput = parseConstraintStr(document.getElementById('adj_c_diff').value);
        const visionInput = parseConstraintStr(document.getElementById('adj_c_vision').value);
        const psyInput = parseConstraintStr(document.getElementById('adj_c_psy').value);
        const talkInput = parseConstraintStr(document.getElementById('adj_c_talk').value);
        const conflictInput = parseConflictStr(document.getElementById('adj_c_conflict').value);

        const hasInputs = (diffInput.length || visionInput.length || psyInput.length || talkInput.length || conflictInput.length);
        if(!hasInputs) {
            if(!confirm("æ‚¨æœªè¾“å…¥ä»»ä½•ç‰¹æ®Šæƒ…å†µçº¦æŸï¼ˆå¦‚è§†åŠ›ã€éš¾ç®¡ã€çŸ›ç›¾ç­‰ï¼‰ã€‚\nç¡®å®šè¦æŒ‰çº¯æˆç»©ç”Ÿæˆåº§æ¬¡å—ï¼Ÿ")) return;
        }

        students.forEach(s => {
            s._isDiff = false; s._isVision = false; s._isPsy = false; // Reset
            if(diffInput.includes(s.name) || talkInput.includes(s.name)) s._isDiff = true;
            if(psyInput.includes(s.name)) s._isPsy = true;
            if(visionInput.includes(s.name)) s._isVision = true;
        });
        
        students.sort((a,b) => b.total - a.total);
        const total = students.length;
        const strategy = document.getElementById('seatAdjStrategy').value;
        const groupsCount = parseInt(document.getElementById('seatAdjGroups').value) || 2;
        const colsPerGroup = parseInt(document.getElementById('seatAdjCols').value) || 4;
        
        let seatList = [];
        let strategyText = "";

        if(strategy === 'conversion') {
            strategyText = "ã€Aå¸¦Cï¼ŒBå¸¦Dã€‘å°†å­¦ç”ŸæŒ‰æˆç»©åˆ†ä¸º4å±‚ã€‚Aå±‚(ä¼˜)ä¸Cå±‚(æ½œ)åŒæ¡Œï¼ŒBå±‚(è‰¯)ä¸Då±‚(å)åŒæ¡Œã€‚æ—¨åœ¨é€šè¿‡ä¼˜ç”Ÿæ‹‰åŠ¨ä¸´ç•Œç”Ÿã€‚";
            let quarter = Math.ceil(total / 4);
            let A = students.slice(0, quarter);
            let B = students.slice(quarter, quarter*2);
            let C = students.slice(quarter*2, quarter*3);
            let D = students.slice(quarter*3);
            
            let maxLen = Math.max(A.length, B.length, C.length, D.length);
            for(let i=0; i<maxLen; i++) {
                if(i < A.length) seatList.push(A[i]);
                if(i < C.length) seatList.push(C[i]);
                if(i < B.length) seatList.push(B[i]);
                if(i < D.length) seatList.push(D[i]);
            }
        } else if (strategy === 'balanced') {
            strategyText = "ã€4äººå‡åˆ†å¹³è¡¡ã€‘Så‹è›‡å½¢æ’åˆ—ï¼Œç¡®ä¿æ¯4äººå°ç»„ï¼ˆ2x2åŒºåŸŸï¼‰çš„å¹³å‡åˆ†å°½å¯èƒ½ä¸€è‡´ï¼Œé€‚åˆå¼€å±•å°ç»„PKæœºåˆ¶ã€‚";
            seatList = [...students]; 
        } else {
            strategyText = "ã€ä¼ ç»Ÿäº’åŠ©ã€‘ç¬¬1åä¸æœ€å1ååŒæ¡Œã€‚";
            let left = 0, right = total - 1;
            while(left <= right) {
                if (left === right) { seatList.push(students[left]); } 
                else { seatList.push(students[left]); seatList.push(students[right]); }
                left++; right--;
            }
        }

        if(visionInput.length > 0) {
            const visions = seatList.filter(s => s._isVision);
            const others = seatList.filter(s => !s._isVision);
            seatList = [...visions, ...others];
        }

        if(conflictInput.length > 0) {
            for(let k=0; k<3; k++) { 
                conflictInput.forEach(pair => {
                    const idx1 = seatList.findIndex(s => s.name === pair[0]);
                    const idx2 = seatList.findIndex(s => s.name === pair[1]);
                    if(idx1 !== -1 && idx2 !== -1 && Math.abs(idx1 - idx2) <= 1) {
                        const safeIdx = Math.floor(seatList.length * 0.75);
                        if(safeIdx < seatList.length && safeIdx !== idx1) {
                            [seatList[idx2], seatList[safeIdx]] = [seatList[safeIdx], seatList[idx2]];
                        }
                    }
                });
            }
        }

        document.getElementById('seat-strategy-desc').innerText = strategyText;
        const container = document.getElementById('seat-adj-container');
        const countDisplay = document.getElementById('seat-count-display');
        container.innerHTML = '';
        document.getElementById('seat-adj-workspace').classList.remove('hidden');
        countDisplay.innerHTML = `å½“å‰ç­çº§ï¼š${cls} | æ€»äººæ•°ï¼š${total} äºº`;

        container.style.display = 'grid';
        container.style.gridTemplateColumns = `repeat(${groupsCount}, 1fr)`;
        container.style.gap = '50px';
        container.style.alignItems = 'start';
        
        const rowCapacity = groupsCount * colsPerGroup;
        const totalRows = Math.ceil(seatList.length / rowCapacity);
        
        const groupEls = []; 
        for(let g=0; g<groupsCount; g++) { 
            const gel = document.createElement('div'); gel.className = 'seat-group'; 
            gel.style.display = 'grid'; gel.style.gridTemplateColumns = `repeat(${colsPerGroup}, 1fr)`; 
            gel.style.gap = '10px'; gel.style.position = 'relative';
            groupEls.push(gel); container.appendChild(gel); 
        }
        
        for(let r=0; r<totalRows; r++) {
            for(let g=0; g<groupsCount; g++) {
                for(let c=0; c<colsPerGroup; c++) {
                    let idx = r * rowCapacity + g * colsPerGroup + c;
                    if(strategy === 'balanced' && r % 2 !== 0) { idx = r * rowCapacity + g * colsPerGroup + (colsPerGroup - 1 - c); }

                    if (idx < seatList.length) {
                        const stu = seatList[idx];
                        const desk = document.createElement('div');
                        desk.className = 'desk';
                        
                        const originalRank = students.findIndex(x => x.name === stu.name);
                        const rankPct = (originalRank + 1) / total;
                        if(rankPct <= 0.25) desk.classList.add('desk-rank-A'); else if(rankPct <= 0.5) desk.classList.add('desk-rank-B'); else if(rankPct <= 0.75) desk.classList.add('desk-rank-C'); else desk.classList.add('desk-rank-D');

                        if(stu._isDiff) desk.classList.add('is-diff'); 
                        if(stu._isVision) desk.style.border = "2px solid #3b82f6"; 
                        if(stu._isPsy) desk.style.border = "2px dashed #ec4899"; 

                        desk.draggable = true;
                        desk.innerHTML = `<div class="desk-name">${stu.name}</div><div class="desk-info">${stu.total}åˆ†</div>`;
                        
                        desk.ondragstart = (e) => { e.dataTransfer.setData('text/html', desk.outerHTML); desk.classList.add('dragging'); window.dragSrcEl = desk; };
                        desk.ondragover = (e) => { e.preventDefault(); };
                        desk.ondrop = (e) => {
                            e.preventDefault();
                            if (window.dragSrcEl !== desk) {
                                const srcHTML = window.dragSrcEl.innerHTML; const srcClass = window.dragSrcEl.className; const srcStyle = window.dragSrcEl.style.cssText;
                                window.dragSrcEl.innerHTML = desk.innerHTML; window.dragSrcEl.className = desk.className; window.dragSrcEl.style.cssText = desk.style.cssText;
                                desk.innerHTML = srcHTML; desk.className = srcClass; desk.style.cssText = srcStyle;
                            }
                            window.dragSrcEl.classList.remove('dragging');
                        };
                        groupEls[g].appendChild(desk);
                    } else {
                        const emptyDesk = document.createElement('div'); emptyDesk.style.visibility = 'hidden'; groupEls[g].appendChild(emptyDesk);
                    }
                }
            }
        }

        for(let g=0; g<groupsCount; g++) {
            const gel = groupEls[g];
            if(colsPerGroup % 2 === 0) {
                for(let r=0; r<totalRows; r+=2) {
                    for(let c=0; c<colsPerGroup; c+=2) {
                        const box = document.createElement('div'); box.className = 'learning-group-box';
                        box.style.left = `${c * 90 - 5}px`; box.style.top = `${r * 65 - 5}px`; box.style.width = `175px`; box.style.height = `125px`;
                        box.innerHTML = `<div class="learning-group-label">å°ç»„ ${g+1}-${Math.ceil((c+1)/2) + (r/2)*(colsPerGroup/2)}</div>`;
                        gel.appendChild(box);
                    }
                }
            }
        }
        
        if(strategy === 'balanced') document.getElementById('seat-stats').innerText = "æç¤ºï¼šè™šçº¿æ¡†å†…ä¸º4äººå­¦ä¹ å…±åŒä½“ï¼Œå»ºè®®è®¾ç«‹ç»„é•¿è´Ÿè´£åˆ¶ï¼Œå®è¡Œç»„é—´ç§¯åˆ†PKã€‚";
        else document.getElementById('seat-stats').innerText = "";
    }

    function applyPrintSettings() {
        const size = document.getElementById('ps-size').value;
        const orient = document.getElementById('ps-orient').value;
        const scale = document.getElementById('ps-scale').value;
        const compact = document.getElementById('ps-compact').checked;
        const hideHeader = document.getElementById('ps-hide-header').checked;
        const hideNav = document.getElementById('ps-hide-nav').checked;
        const hideCharts = document.getElementById('ps-hide-charts').checked;
        const watermarkText = document.getElementById('ps-watermark-text').value;
        const watermarkOpacity = document.getElementById('ps-watermark-opacity').value;

        document.documentElement.style.setProperty('--p-size', size);
        document.documentElement.style.setProperty('--p-orient', orient);
        document.documentElement.style.setProperty('--p-scale', scale);
        document.documentElement.style.setProperty('--p-watermark-text', `"${watermarkText}"`);
        document.documentElement.style.setProperty('--p-watermark-opacity', watermarkOpacity);

        const body = document.body;
        if (watermarkText.trim()) body.classList.add('print-watermarked'); else body.classList.remove('print-watermarked');
        if (hideHeader) body.classList.add('p-hide-header'); else body.classList.remove('p-hide-header');
        if (hideNav) body.classList.add('p-hide-nav'); else body.classList.remove('p-hide-nav');
        if (hideCharts) body.classList.add('p-hide-charts'); else body.classList.remove('p-hide-charts');
        if (compact) body.classList.add('p-compact-table'); else body.classList.remove('p-compact-table');

        alert("âœ… æ‰“å°é…ç½®å·²åº”ç”¨ï¼\n\nè¯·ç‚¹å‡»â€œè°ƒç”¨æ‰“å°æœºâ€æŒ‰é’®æŸ¥çœ‹é¢„è§ˆæ•ˆæœã€‚\næç¤ºï¼šæµè§ˆå™¨æ‰“å°è®¾ç½®ä¸­è¯·å‹¾é€‰â€œèƒŒæ™¯å›¾å½¢â€ä»¥æ˜¾ç¤ºé¢œè‰²ã€‚");
    }

    // ================== [æ–°å¢] æ™ºèƒ½æ ‡ç­¾è¾“å…¥ç»„ä»¶é€»è¾‘ ==================
    function initTagWidget(wrapperId, hiddenInputId) {
        const wrapper = document.getElementById(wrapperId); if(!wrapper) return;
        const input = wrapper.querySelector('.tag-input-field'); const dropdown = wrapper.querySelector('.suggestion-dropdown');
        wrapper.addEventListener('click', (e) => { if(e.target === wrapper) input.focus(); });
        if(input) {
            input.addEventListener('input', function() {
                const val = this.value.trim().toLowerCase();
                if(!val) { dropdown.style.display = 'none'; return; }
                const matches = CURRENT_CONTEXT_STUDENTS.filter(s => s.name.includes(val)).slice(0, 8);
                if(matches.length) { dropdown.innerHTML = matches.map(s => `<div class="suggestion-item" onclick="addTagToWidget('${wrapperId}', '${hiddenInputId}', '${s.name}')">${s.name} <small>${s.score||s.total}åˆ†</small></div>`).join(''); dropdown.style.display = 'block'; } 
                else { dropdown.style.display = 'none'; }
            });
            input.addEventListener('blur', () => { setTimeout(() => dropdown.style.display = 'none', 200); });
        }
    }
    function addTagToWidget(wrapperId, hiddenInputId, name) {
        const currentTags = getTagsFromHidden(hiddenInputId);
        if(currentTags.includes(name)) { const input = document.getElementById(wrapperId).querySelector('.tag-input-field'); if(input) input.value = ''; return; }
        currentTags.push(name); document.getElementById(hiddenInputId).value = currentTags.join(', ');
        renderTagsUI(wrapperId, hiddenInputId);
        const input = document.getElementById(wrapperId).querySelector('.tag-input-field'); if(input) { input.value = ''; input.focus(); }
    }
    function removeTagFromWidget(wrapperId, hiddenInputId, name) {
        const currentTags = getTagsFromHidden(hiddenInputId); const newTags = currentTags.filter(t => t !== name);
        document.getElementById(hiddenInputId).value = newTags.join(', '); renderTagsUI(wrapperId, hiddenInputId);
    }
    function getTagsFromHidden(id) { const val = document.getElementById(id).value; return val ? val.split(/[,;]/).map(s => s.trim()).filter(s => s) : []; }
    function renderTagsUI(wrapperId, hiddenInputId) {
        const wrapper = document.getElementById(wrapperId); const tags = getTagsFromHidden(hiddenInputId);
        wrapper.querySelectorAll('.tag-chip').forEach(c => c.remove());
        const input = wrapper.querySelector('.tag-input-field');
        tags.forEach(tag => {
            const chip = document.createElement('div'); chip.className = 'tag-chip';
            chip.innerHTML = `${tag} <span class="tag-chip-remove" onclick="removeTagFromWidget('${wrapperId}', '${hiddenInputId}', '${tag}')">&times;</span>`;
            if(input) wrapper.insertBefore(chip, input); else wrapper.appendChild(chip);
        });
    }
    function addConflictPair(type) {
        // æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ä¸‹æ‹‰æ¡† ID
        const idA = type === 'adj' ? 'conflict_sel_a' : 'fb_conflict_sel_a';
        const idB = type === 'adj' ? 'conflict_sel_b' : 'fb_conflict_sel_b';
        const wrapperId = type === 'adj' ? 'widget_adj_conflict' : 'widget_fb_conflict'; 
        const hiddenId = type === 'adj' ? 'adj_c_conflict' : 'fb_c_conflict';

        const selA = document.getElementById(idA);
        const selB = document.getElementById(idB);

        // æ ¡éªŒé€‰æ‹©
        if(!selA || !selB) return console.error("æ‰¾ä¸åˆ°ä¸‹æ‹‰æ¡†å…ƒç´ ");
        if(!selA.value || !selB.value) return alert("è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªå­¦ç”Ÿ");
        if(selA.value === selB.value) return alert("ä¸èƒ½é€‰æ‹©åŒä¸€ä¸ªå­¦ç”Ÿ");

        // æ·»åŠ åˆ°æ ‡ç­¾æ 
        addTagToWidget(wrapperId, hiddenId, `${selA.value}&${selB.value}`); 
        
        // é‡ç½®é€‰é¡¹
        selA.value = ""; 
        selB.value = "";
    }

    function updateConstraintWidgetsContext(type) {
        let students = [];

        // 1. è·å–å½“å‰ä¸Šä¸‹æ–‡çš„å­¦ç”Ÿåˆ—è¡¨
        if(type === 'adj') {
            // è€ƒåæ’åº§æ¨¡å¼ï¼šä»å­¦æ ¡å’Œç­çº§ä¸‹æ‹‰æ¡†è·å–æ•°æ®
            const sch = document.getElementById('seatAdjSchoolSelect').value; 
            const cls = document.getElementById('seatAdjClassSelect').value;

            if(sch && cls && SCHOOLS[sch]) {
                // è¿‡æ»¤å‡ºè¯¥ç­å­¦ç”Ÿ
                students = SCHOOLS[sch].students.filter(s => s.class === cls);
            }
            
            // æ›´æ–°å…¨å±€ä¸Šä¸‹æ–‡
            CURRENT_CONTEXT_STUDENTS = students;
            
            // åˆå§‹åŒ–å…¶ä»–æ ‡ç­¾ç»„ä»¶
            ['diff', 'vision', 'psy', 'talk'].forEach(f => { 
                initTagWidget(`widget_adj_${f}`, `adj_c_${f}`); 
                renderTagsUI(`widget_adj_${f}`, `adj_c_${f}`); 
            });
            renderTagsUI('widget_adj_conflict', 'adj_c_conflict');

        } else if(type === 'fb') {
            // æ–°ç”Ÿåˆ†ç­æ¨¡å¼ï¼šä»å½“å‰é€‰ä¸­çš„ç­çº§å¯¹è±¡è·å–æ•°æ®
            if(FB_CUR_CLASS_IDX !== -1 && FB_CLASSES[FB_CUR_CLASS_IDX]) {
                students = FB_CLASSES[FB_CUR_CLASS_IDX].students;
            }

            CURRENT_CONTEXT_STUDENTS = students;
            
            ['diff', 'vision', 'talk'].forEach(f => { 
                initTagWidget(`widget_fb_${f}`, `fb_c_${f}`); 
                renderTagsUI(`widget_fb_${f}`, `fb_c_${f}`); 
            });
            renderTagsUI('widget_fb_conflict', 'fb_c_conflict');
            
            // â˜…â˜…â˜… æ–°å¢ï¼šåˆå§‹åŒ–â€œå¼ºè¡Œç»‘å®šâ€ç»„ä»¶ â˜…â˜…â˜…
            renderTagsUI('widget_fb_bind', 'fb_c_bind');
        }

        // 2. ç”Ÿæˆä¸‹æ‹‰æ¡†é€‰é¡¹ HTML (ç»Ÿä¸€å¤„ç†)
        let opts = '<option value="">--ç‚¹å‡»é€‰æ‹©--</option>';
        if (students.length > 0) {
            // æŒ‰å§“åæ’åºï¼Œæ–¹ä¾¿æŸ¥æ‰¾
            students.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hans-CN'));
            opts += students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        } else {
            opts = '<option value="">(æš‚æ— å­¦ç”Ÿæ•°æ®)</option>';
        }

        // 3. å°†é€‰é¡¹å¡«å……åˆ°å¯¹åº”çš„ä¸‹æ‹‰æ¡†ä¸­
        if (type === 'fb') {
             // æ›´æ–°æ–°ç”Ÿåˆ†ç­çš„â€œçŸ›ç›¾â€ä¸‹æ‹‰æ¡†
             const cA = document.getElementById('fb_conflict_sel_a'); 
             const cB = document.getElementById('fb_conflict_sel_b');
             if(cA && cB) { cA.innerHTML = opts; cB.innerHTML = opts; }
             
             // â˜…â˜…â˜… æ–°å¢ï¼šæ›´æ–°æ–°ç”Ÿåˆ†ç­çš„â€œç»‘å®šâ€ä¸‹æ‹‰æ¡† â˜…â˜…â˜…
             const bA = document.getElementById('fb_bind_sel_a'); 
             const bB = document.getElementById('fb_bind_sel_b');
             if(bA && bB) { bA.innerHTML = opts; bB.innerHTML = opts; }
             
        } else if (type === 'adj') {
             // æ›´æ–°è€ƒåæ’åº§çš„â€œçŸ›ç›¾â€ä¸‹æ‹‰æ¡†
             const elA = document.getElementById('conflict_sel_a'); 
             const elB = document.getElementById('conflict_sel_b');
             if(elA && elB) { elA.innerHTML = opts; elB.innerHTML = opts; }
        }
    }


    

    // 1. æ‰“å¼€é¢æ¿å¹¶åˆå§‹åŒ–
    function openBatchAIModal() {
        const sch = document.getElementById('sel-school').value; 
        const cls = document.getElementById('sel-class').value;
        if (!sch || sch.includes('è¯·é€‰æ‹©') || !cls || cls.includes('è¯·é€‰æ‹©')) {
            return alert("è¯·å…ˆåœ¨ä¸Šæ–¹ã€æˆç»©å•ç”Ÿæˆå™¨ã€‘åŒºåŸŸé€‰æ‹©å…·ä½“çš„ã€å­¦æ ¡ã€‘å’Œã€ç­çº§ã€‘ï¼");
        }
        document.getElementById('batch-ai-workspace').classList.remove('hidden');
        document.getElementById('batch-ai-workspace').scrollIntoView({behavior: "smooth"});
        
        // åˆå§‹åŒ–åˆ—è¡¨é¢„è§ˆ
        const students = SCHOOLS[sch].students.filter(s => s.class === cls).sort((a,b)=>b.total - a.total);
        const tbody = document.querySelector('#batch-ai-table tbody');
        tbody.innerHTML = '';
        
        students.forEach(s => {
            const key = `${s.school}_${s.class}_${s.name}`;
            const hasComment = BATCH_AI_CACHE[key];
            const statusIcon = hasComment ? 'âœ…' : 'âšª';
            const commentPreview = hasComment ? hasComment : '<span style="color:#ccc">ç­‰å¾…ç”Ÿæˆ...</span>';
            
            tbody.innerHTML += `
                <tr id="row-${key.replace(/\s+/g, '')}">
                    <td class="status-cell">${statusIcon}</td>
                    <td>${s.name}</td>
                    <td>${safeGet(s, 'ranks.total.township', '-')}</td>
                    <td class="comment-cell" style="text-align:left; white-space:normal;">${commentPreview}</td>
                    <td><button class="btn btn-gray btn-sm" style="padding:2px 5px; font-size:10px;" onclick="regenerateOneAI('${key}')">é‡è¯•</button></td>
                </tr>
            `;
        });
        updateBatchProgress(0, students.length);
    }

    // 2. æ›´æ–°è¿›åº¦æ¡
    function updateBatchProgress(current, total) {
        const pct = total === 0 ? 0 : (current / total) * 100;
        document.getElementById('batch-ai-progress').style.width = `${pct}%`;
        document.getElementById('batch-ai-progress-text').innerText = `${current} / ${total}`;
    }

    function buildStudentPrompt(stu) {
        // 1. è·å–åŸºç¡€ä¸Šä¸‹æ–‡
        const totalStudents = RAW_DATA.length;
        const rank = safeGet(stu, 'ranks.total.township', 0);
        
        // é˜²æ­¢é™¤ä»¥0
        const pct = totalStudents > 0 ? (rank / totalStudents * 100).toFixed(1) : 0;
        
        // 2. è¿›é€€æ­¥æ•°æ® (RAG: æ£€ç´¢å†å²)
        // ä½¿ç”¨ä¹‹å‰å®šä¹‰çš„æ–°è¾…åŠ©å‡½æ•° findPreviousRecord
        const prevStu = findPreviousRecord(stu); 
        let trendInfo = "ï¼ˆæœ¬æ¬¡æ— å†å²å¯¹æ¯”æ•°æ®ï¼‰";
        
        if (prevStu) {
            const rankDiff = prevStu.townRank - rank; // æ­£æ•°=è¿›æ­¥ (åæ¬¡å˜å°)
            const scoreDiff = stu.total - prevStu.total; // æ­£æ•°=æ¶¨åˆ†
            
            // æ„é€ ä¸€æ®µè‡ªç„¶è¯­è¨€æè¿°ï¼Œå–‚ç»™ AI
            let evalStr = "";
            if (Math.abs(rankDiff) < 10) evalStr = "å‘æŒ¥ååˆ†ç¨³å®š";
            else if (rankDiff >= 10) evalStr = "è¿›æ­¥éå¸¸æ˜¾è‘—ï¼";
            else evalStr = "åæ¬¡å‡ºç°æ»‘å¡ï¼Œéœ€æŸ¥æ‰¾åŸå› ";

            trendInfo = `
            ã€å†å²å¯¹æ¯”æƒ…å†µã€‘ï¼š
            - ç›¸æ¯”ä¸Šæ¬¡è€ƒè¯•ï¼Œæ€»åˆ†å˜åŒ–ï¼š${scoreDiff > 0 ? '+' : ''}${scoreDiff.toFixed(1)}åˆ†ã€‚
            - æ’åå˜åŒ–ï¼š${rankDiff > 0 ? 'è¿›æ­¥äº†' : 'é€€æ­¥äº†'} ${Math.abs(rankDiff)} åã€‚
            - ç¨³å®šæ€§è¯„ä»·ï¼š${evalStr}ã€‚
            `;
        }

        // 3. æ„å»ºå­¦ç§‘å¼ºå¼±é¡¹ (åŸºäº Z-Score æˆ– å‡åˆ†å·®)
        let strengths = [];
        let weaknesses = [];
        
        SUBJECTS.forEach(sub => {
            const score = stu.scores[sub];
            if (score === undefined) return;
            
            // ç®€å•è®¡ç®—å…¨é•‡å‡åˆ†
            const allScores = RAW_DATA.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            const avg = allScores.length ? (allScores.reduce((a,b)=>a+b,0)/allScores.length) : 0;
            
            const diff = score - avg;
            // é˜ˆå€¼ï¼šé«˜äºå‡åˆ†15åˆ†ç®—å¼ºï¼Œä½äº10åˆ†ç®—å¼±
            if (diff >= 15) strengths.push(sub);
            else if (diff <= -10) weaknesses.push(sub);
        });

        const strengthStr = strengths.length > 0 ? strengths.join("ã€") : "å„ç§‘è¾ƒå‡è¡¡";
        const weakStr = weaknesses.length > 0 ? weaknesses.join("ã€") : "æ— æ˜æ˜¾çŸ­æ¿";

        // 4. ç»„åˆæœ€ç»ˆ Prompt
        return `
        # Role
        ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œã€æ•°æ®é©±åŠ¨ä¸”å……æ»¡äººæ–‡å…³æ€€çš„åˆä¸­ç­ä¸»ä»»ã€‚è¯·æ ¹æ®å­¦ç”Ÿçš„æˆç»©å•å’Œè¿›é€€æ­¥æƒ…å†µï¼Œå†™ä¸€æ®µç®€çŸ­çš„å­¦æƒ…è¯Šæ–­ã€‚

        # Data Context
        å§“åï¼š${stu.name}
        å½“å‰æ’åï¼š${rank}/${totalStudents} (å‰${pct}%)
        ä¼˜åŠ¿å­¦ç§‘ï¼š${strengthStr}
        å¾…æå‡å­¦ç§‘ï¼š${weakStr}
        ${trendInfo}
        
        # Requirements
        1. **ç›´é¢è¿›é€€æ­¥**ï¼šå¦‚æœå­˜åœ¨å†å²æ•°æ®ï¼Œè¯„è¯­çš„ç¬¬ä¸€å¥å¿…é¡»ç‚¹è¯„è¿›é€€æ­¥æƒ…å†µï¼ˆå¦‚â€œæ­å–œä½ ï¼Œæ’åå¤§å¹…ä¸Šå‡â€æˆ–â€œæœ¬æ¬¡è€ƒè¯•ç¨æœ‰é—æ†¾ï¼Œåæ¬¡æœ‰æ‰€ä¸‹æ»‘â€ï¼‰ã€‚
        2. **å½’å› åˆ†æ**ï¼š
           - å¦‚æœé€€æ­¥ï¼Œè¯·æ¸©å’Œåœ°å»ºè®®å…³æ³¨[å¾…æå‡å­¦ç§‘]ã€‚
           - å¦‚æœè¿›æ­¥ï¼Œè¯·è‚¯å®š[ä¼˜åŠ¿å­¦ç§‘]çš„è´¡çŒ®ã€‚
        3. **è¯­æ°”é£æ ¼**ï¼šç±»ä¼¼ Windows Fluent Design çš„ç†å¿µâ€”â€”æ¸…æ™°ã€ç°ä»£ã€ä¸å•°å—¦ï¼Œä½†å……æ»¡æ¸©åº¦ã€‚
        4. **å­—æ•°é™åˆ¶**ï¼š150å­—å·¦å³ï¼Œåˆ†æ®µæ˜¾ç¤ºï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
        `;
    }

    // 4. åœæ­¢ç”Ÿæˆ
    function stopBatchAI() {
        IS_BATCH_AI_RUNNING = false;
        document.getElementById('btn-start-batch-ai').classList.remove('hidden');
        document.getElementById('btn-stop-batch-ai').classList.add('hidden');
    }

    // 5. å¼€å§‹æ‰¹é‡ç”Ÿæˆ (æ ¸å¿ƒå¾ªç¯)
    async function startBatchAIComments() {
        if (!LLM_CONFIG.apiKey) return alert("è¯·å…ˆåœ¨ã€æ•°æ®ä¸­å¿ƒ -> AI é…ç½®ã€‘ä¸­è®¾ç½® API Key");
        const sch = document.getElementById('sel-school').value; 
        const cls = document.getElementById('sel-class').value;
        const students = SCHOOLS[sch].students.filter(s => s.class === cls).sort((a,b)=>b.total - a.total);
        const interval = (parseFloat(document.getElementById('batch-ai-interval').value) || 3) * 1000;

        IS_BATCH_AI_RUNNING = true;
        document.getElementById('btn-start-batch-ai').classList.add('hidden');
        document.getElementById('btn-stop-batch-ai').classList.remove('hidden');

        let processedCount = 0;
        for (let i = 0; i < students.length; i++) {
            if (!IS_BATCH_AI_RUNNING) break;
            const s = students[i];
            const key = `${s.school}_${s.class}_${s.name}`;
            const rowId = `row-${key.replace(/\s+/g, '')}`;
            const row = document.getElementById(rowId);
            
            if (BATCH_AI_CACHE[key]) { processedCount++; updateBatchProgress(processedCount, students.length); continue; }

            if(row) { row.querySelector('.status-cell').innerHTML = 'â³'; row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }

            const prompt = buildStudentPrompt(s);
            try {
                let aiResponse = "";
                await new Promise((resolve) => {
                    callLLM(prompt, null, (fullText) => { aiResponse = fullText; resolve(); });
                });
                if (aiResponse && !aiResponse.includes("å¤±è´¥")) {
                    BATCH_AI_CACHE[key] = aiResponse;
                    if(row) { row.querySelector('.status-cell').innerHTML = 'âœ…'; row.querySelector('.comment-cell').innerText = aiResponse; }
                } else { if(row) row.querySelector('.status-cell').innerHTML = 'âŒ'; }
            } catch (e) { if(row) row.querySelector('.status-cell').innerHTML = 'âŒ'; }

            processedCount++; updateBatchProgress(processedCount, students.length);
            if (i < students.length - 1 && IS_BATCH_AI_RUNNING) await new Promise(r => setTimeout(r, interval));
        }
        stopBatchAI(); alert("æ‰¹é‡ç”Ÿæˆä»»åŠ¡ç»“æŸï¼");
    }

    // 6. å•ä¸ªé‡è¯•
    function regenerateOneAI(key) {
        const [sch, cls, name] = key.split('_');
        const stu = SCHOOLS[sch].students.find(s => s.name === name && s.class === cls);
        if(!stu) return;
        delete BATCH_AI_CACHE[key];
        const rowId = `row-${key.replace(/\s+/g, '')}`;
        const row = document.getElementById(rowId);
        if(row) { row.querySelector('.status-cell').innerHTML = 'â³'; row.querySelector('.comment-cell').innerText = "é‡è¯•ä¸­..."; }
        callLLM(buildStudentPrompt(stu), null, (fullText) => {
            if(fullText && !fullText.includes("å¤±è´¥")) {
                BATCH_AI_CACHE[key] = fullText;
                if(row) { row.querySelector('.status-cell').innerHTML = 'âœ…'; row.querySelector('.comment-cell').innerText = fullText; }
            } else { if(row) row.querySelector('.comment-cell').innerText = "ç”Ÿæˆå¤±è´¥"; }
        });
    }

    // 7. å¯¼å‡ºè¯„è¯­ Excel
    function exportAICommentsExcel() {
        const sch = document.getElementById('sel-school').value; 
        const cls = document.getElementById('sel-class').value;
        if (!sch || !cls) return alert("æ— é€‰ä¸­ç­çº§");
        const wb = XLSX.utils.book_new();
        const data = [['å­¦æ ¡', 'ç­çº§', 'å§“å', 'æ€»åˆ†', 'è¯„è¯­']];
        const students = SCHOOLS[sch].students.filter(s => s.class === cls).sort((a,b)=>b.total - a.total);
        students.forEach(s => {
            const key = `${s.school}_${s.class}_${s.name}`;
            data.push([s.school, s.class, s.name, s.total, BATCH_AI_CACHE[key] || ""]);
        });
        const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{wch:15}, {wch:10}, {wch:10}, {wch:8}, {wch:80}];
        XLSX.utils.book_append_sheet(wb, ws, "AIè¯„è¯­å¯¼å‡º");
        XLSX.writeFile(wb, `${sch}_${cls}_AIè¯„è¯­.xlsx`);
    }

      // --- 1. è¡¨æ ¼çƒ­åŠ›å›¾åŠŸèƒ½ (æ™ºèƒ½è¯†åˆ«æ¨ªå‘/çºµå‘ + å¼ºåˆ¶è¦†ç›–æœ¬æ ¡é«˜äº®) ---
    function toggleTableHeatmap(containerId) {
        const container = document.getElementById(containerId);
        if(!container) return;
        const tables = container.querySelectorAll('table');
        if(!tables.length) return alert("è¯·å…ˆç”Ÿæˆè¡¨æ ¼");

        // åˆ‡æ¢çŠ¶æ€æ ‡è®°
        const isHeatmapOn = container.classList.toggle('heatmap-mode');
        // åˆ¤æ–­æ˜¯å¦ä¸ºâ€œä¹¡é•‡æ¨ªå‘å¯¹æ¯”è¡¨â€ (è¯¥è¡¨ç»“æ„ç‰¹æ®Šï¼šè¡Œæ˜¯æŒ‡æ ‡ï¼Œåˆ—æ˜¯å­¦æ ¡ï¼Œéœ€è¡Œå†…å¯¹æ¯”)
        const isHorizontalMode = (containerId === 'horizontal-table');
        
        tables.forEach(table => {
            if (!isHeatmapOn) {
                // å…³é—­ï¼šæ¸…é™¤èƒŒæ™¯è‰² (ä½¿ç”¨ removeProperty ä»¥ç¡®ä¿æ¸…é™¤ important æ ·å¼)
                table.querySelectorAll('td').forEach(td => td.style.removeProperty('background-color'));
                return;
            }

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if(rows.length === 0) return;

            // æå–æ•°å€¼çš„è¾…åŠ©å‡½æ•°
            const getVal = (cell) => {
                // ç§»é™¤ %, +, (æ’å) ç­‰ç¬¦å·ï¼Œåªå–ä¸»æ•°å€¼
                const txt = cell.innerText.split('(')[0].replace(/[%+]/g, '').trim(); 
                return parseFloat(txt);
            };

            // é¢œè‰²è®¡ç®—è¾…åŠ©å‡½æ•°
            const applyColorToGroup = (cells, isRankType) => {
                const values = cells.map(c => c.val);
                const max = Math.max(...values);
                const min = Math.min(...values);
                const range = max - min;
                if (range === 0) return;

                cells.forEach(item => {
                    let ratio = (item.val - min) / range;
                    // æ’å(Rank)ç±»æ•°æ®ï¼Œæ•°å€¼è¶Šå°è¶Šå¥½(ç»¿) -> ratioåº”å¤§
                    if (isRankType) ratio = 1 - ratio; 

                    // ä»¿Excelè‰²é˜¶ï¼šä½=çº¢, ä¸­=é»„, é«˜=ç»¿
                    let r, g, b;
                    if (ratio < 0.5) { // çº¢ -> é»„
                        r = 255; 
                        g = Math.round(200 + (ratio * 2) * 55); 
                        b = 200;
                    } else { // é»„ -> ç»¿
                        r = Math.round(255 - ((ratio - 0.5) * 2) * 55); 
                        g = 255; 
                        b = 200;
                    }
                    
                    // [ä¿®æ”¹ç‚¹] ä½¿ç”¨ setProperty(..., 'important') å¼ºåˆ¶è¦†ç›– .bg-highlight çš„ !important æ ·å¼
                    // è¿™æ ·çƒ­åŠ›å›¾é¢œè‰²ä¼šä¼˜å…ˆæ˜¾ç¤ºï¼Œä½†æœ¬æ ¡çš„æ–‡å­—é¢œè‰²å’Œè¾¹æ¡†ä¾ç„¶ä¿ç•™
                    item.el.style.setProperty('background-color', `rgb(${r}, ${g}, ${b})`, 'important');
                });
            };

            if (isHorizontalMode) {
                // === æ¨¡å¼ Aï¼šè¡Œå†…å¯¹æ¯” (é€‚ç”¨äºä¹¡é•‡æ¨ªå‘å¯¹æ¯”è¡¨) ===
                rows.forEach(tr => {
                    let cells = [];
                    const label = tr.children[0].innerText;
                    const isRank = label.includes('æ’å') || label.includes('åæ¬¡');

                    for (let c = 1; c < tr.children.length; c++) {
                        const cell = tr.children[c];
                        const val = getVal(cell);
                        if (!isNaN(val)) cells.push({ el: cell, val: val });
                    }
                    applyColorToGroup(cells, isRank);
                });

            } else {
                // === æ¨¡å¼ Bï¼šåˆ—å†…å¯¹æ¯” (é€‚ç”¨äºç­çº§å¯¹æ¯”ç­‰) ===
                const colCount = rows[0].children.length;
                for (let c = 1; c < colCount; c++) { 
                    let cells = [];
                    const headerText = table.querySelector(`thead th:nth-child(${c+1})`)?.innerText || "";
                    const isRank = headerText.includes('æ’') || headerText.includes('å'); 

                    rows.forEach(r => {
                        const cell = r.children[c];
                        const val = getVal(cell);
                        if (!isNaN(val)) cells.push({ el: cell, val: val });
                    });
                    applyColorToGroup(cells, isRank);
                }
            }
        });
    }

    // --- 2. å­¦ç§‘åˆ—ç­›é€‰åŠŸèƒ½ ---
    let COL_FILTER_STATE = {}; // å­˜å‚¨é€‰ä¸­çŠ¶æ€

    function toggleColFilterMenu() {
        const popover = document.getElementById('col-filter-popover');
        if (popover.style.display === 'grid') {
            popover.style.display = 'none';
        } else {
            initColFilterUI();
            popover.style.display = 'grid';
        }
    }

    function initColFilterUI() {
        const popover = document.getElementById('col-filter-popover');
        if(popover.children.length > 0 && SUBJECTS.length === popover.children.length) return; // å·²åˆå§‹åŒ–

        popover.innerHTML = '';
        // é»˜è®¤å…¨é€‰
        SUBJECTS.forEach(sub => {
            if(COL_FILTER_STATE[sub] === undefined) COL_FILTER_STATE[sub] = true;
            
            const label = document.createElement('label');
            label.className = 'filter-check-label';
            label.innerHTML = `<input type="checkbox" value="${sub}" ${COL_FILTER_STATE[sub] ? 'checked' : ''} onchange="applyColFilter(this)"> ${sub}`;
            popover.appendChild(label);
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', function closeMenu(e) {
            if (!e.target.closest('#col-filter-popover') && !e.target.closest('#btn-col-filter')) {
                document.getElementById('col-filter-popover').style.display = 'none';
                document.removeEventListener('click', closeMenu);
            }
        });
    }

    function applyColFilter(checkbox) {
        const sub = checkbox.value;
        const isChecked = checkbox.checked;
        COL_FILTER_STATE[sub] = isChecked;

        // æŸ¥æ‰¾ç­çº§å¯¹æ¯”åŒºåŸŸçš„æ‰€æœ‰è¡¨æ ¼
        const container = document.getElementById('class-comp-results');
        const tables = container.querySelectorAll('table');
        
        // é€»è¾‘ï¼š
        // 1. æ€»åˆ†è¡¨æ ¼ ("ä¸¤ç‡ä¸€åˆ†"ç­‰) ä¸å—å½±å“ï¼Œé€šå¸¸ä¿ç•™
        // 2. å•ç§‘è¡¨æ ¼ï¼šå¦‚æœè¯¥è¡¨æ ¼çš„æ ‡é¢˜ï¼ˆæˆ–ä¸Šæ–¹çš„å°æ ‡é¢˜ï¼‰åŒ…å«æœªé€‰ä¸­çš„å­¦ç§‘åï¼Œåˆ™éšè—æ•´ä¸ªè¡¨æ ¼å—
        
        // é’ˆå¯¹å½“å‰ç³»ç»Ÿçš„ DOM ç»“æ„ï¼š
        // æ¯ä¸ªå­¦ç§‘æ˜¯ä¸€ä¸ª <div id="anchor-class-æ•°å­¦">...<table>...</table></div>
        
        SUBJECTS.forEach(s => {
            const anchorDiv = document.getElementById(`anchor-class-${s}`);
            if (anchorDiv) {
                if (COL_FILTER_STATE[s]) {
                    anchorDiv.classList.remove('hidden');
                } else {
                    anchorDiv.classList.add('hidden');
                }
            }
        });

        // å¦å¤–ï¼Œå¦‚æœæ˜¯é’ˆå¯¹é•¿è¡¨æ ¼ï¼ˆå¦‚å­¦ç”Ÿæ˜ç»†è¡¨ï¼‰çš„åˆ—ç­›é€‰ï¼Œé€»è¾‘å¦‚ä¸‹ï¼ˆé€šç”¨åŒ–ï¼‰ï¼š
        // éå†æ‰€æœ‰ thï¼Œå¦‚æœ th æ–‡æœ¬åŒ…å«æœªé€‰ä¸­çš„å­¦ç§‘ï¼Œåˆ™éšè—è¯¥åˆ—
        // è¿™é‡Œä¸»è¦é’ˆå¯¹ç­çº§å¯¹æ¯”çš„å•ç§‘å¡ç‰‡æ˜¾éšï¼Œå·²æ»¡è¶³â€œåªçœ‹è¯­æ•°è‹±â€çš„éœ€æ±‚ã€‚
    }

    function resetSystem() {
        if (isArchiveLocked()) {
            return alert("â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œä»…æ”¯æŒåªè¯»æŸ¥çœ‹");
        }
        Swal.fire({
            title: 'âš ï¸ ç¡®å®šè¦é‡ç½®ç³»ç»Ÿå—ï¼Ÿ',
            text: "æ­¤æ“ä½œå°†æ¸…ç©ºå½“å‰æ‰€æœ‰å¯¼å…¥çš„æ•°æ®ã€æ•™å¸ˆè®¾ç½®ä»¥åŠè‡ªåŠ¨å­˜æ¡£ï¼Œä¸”æ— æ³•æ’¤é”€ï¼ç³»ç»Ÿå°†å›åˆ°åˆå§‹â€œæ¨¡å¼é€‰æ‹©â€ç•Œé¢ã€‚",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626', // çº¢è‰²è­¦ç¤º
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ç¡®å®šæ¸…ç©ºé‡ç½®',
            cancelButtonText: 'å–æ¶ˆ'
        }).then(async (result) => {
            if (result.isConfirmed) {
                // 1. æ¸…ç©º IndexedDB å­˜å‚¨
                await DB.clear('autosave_backup');
                
                // 2. æ¸…ç©º LocalStorage (å¦‚æœæœ‰ç›¸å…³çš„)
                localStorage.removeItem('FB_DATA_BACKUP');
                localStorage.removeItem('MP_SNAPSHOTS');
                
                // 3. åˆ·æ–°é¡µé¢ -> è§¦å‘ onload -> å‘ç°æ— æ•°æ® -> æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©
                location.reload();
            }
        });
    }

    // ================== æ ¡å†…ç»©æ•ˆå…¬å¹³è€ƒæ ¸æ¨¡å— (SSE) - æœ€ç»ˆå…¨åŠŸèƒ½ç‰ˆ ==================
    // åŠŸèƒ½ç‰¹æ€§ï¼š
    // 1. è‡ªåŠ¨åŒºåˆ†ã€åœ¨ç±äººæ•°ã€‘(Excelåå•æ€»æ•°) å’Œã€å®è€ƒäººæ•°ã€‘(æœ‰åˆ†æ•°çš„)
    // 2. åŒå‘è¡¥å¿ï¼šäººæ•° > å¹³å‡åŠ åˆ†ï¼Œäººæ•° < å¹³å‡æ‰£åˆ†
    // 3. åŠ¨æ€æƒé‡ï¼šå–æ¶ˆå‹¾é€‰â€œç”Ÿæºå¢å€¼â€æ—¶ï¼Œæƒé‡è‡ªåŠ¨åŠ ç»™â€œå‡åˆ†â€ï¼Œæ— éœ€å†å²æ•°æ®

    // 1. åˆå§‹åŒ–ä¸‹æ‹‰æ¡† (åˆ‡æ¢Tabæ—¶è°ƒç”¨)
    function updateSSESchoolSelect() {
        const sel = document.getElementById('sse_school_select');
        if(!sel) return;
        const old = sel.value;
        sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©è€ƒæ ¸å­¦æ ¡ --</option>';
        Object.keys(SCHOOLS).forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        if(old && SCHOOLS[old]) sel.value = old;
    }

    // Hook: åŠ«æŒ switchTab å‡½æ•°ï¼Œåœ¨åˆ‡æ¢åˆ°è¯¥é¡µé¢æ—¶è‡ªåŠ¨åˆ·æ–°ä¸‹æ‹‰æ¡†
    const originalSwitchTabSSE = switchTab;
    switchTab = function(id) {
        originalSwitchTabSSE(id);
        if(id === 'single-school-eval') {
            updateSSESchoolSelect();
        }
    };

    // è¾…åŠ©ï¼šåŠ¨æ€æ›´æ–°è¡¨å¤´æ˜¾ç¤ºæƒé‡
    function SSE_updateHeaderLabels(wExc, wPass, wAvg, wProg) {
        const thead = document.querySelector('#sse_table thead');
        if(!thead) return;
        const ths = thead.querySelectorAll('th');
        // å¯¹åº”åˆ—ç´¢å¼•ï¼š5=ä¼˜ç§€, 6=åŠæ ¼, 7=å‡åˆ†, 8=å¢å€¼
        if(ths[5]) ths[5].innerHTML = `ä¼˜ç§€ç‡(25%)<br><small style="color:#999">æƒé‡${wExc}</small>`;
        if(ths[6]) ths[6].innerHTML = `åŠæ ¼ç‡(80%)<br><small style="color:#999">æƒé‡${wPass}</small>`;
        if(ths[7]) ths[7].innerHTML = `å‡åˆ†å¯¹æ¯”<br><small style="color:#999">æƒé‡${wAvg}</small>`;
        
        // åŠ¨æ€æ˜¾ç¤º/éšè—â€œç”Ÿæºå¢å€¼â€åˆ—
        if(ths[8]) {
            if(wProg === 0) {
                ths[8].style.display = 'none'; 
            } else {
                ths[8].style.display = 'table-cell';
                ths[8].innerHTML = `ç”Ÿæºå¢å€¼<br><small style="color:#999">æƒé‡${wProg}</small>`;
            }
        }
    }

    // 2. æ ¸å¿ƒè®¡ç®—é€»è¾‘
    let SSE_CACHE = []; // ç¼“å­˜è®¡ç®—ç»“æœä¾›å¯¼å‡º

    function SSE_calculate() {
        const schName = document.getElementById('sse_school_select').value;
        if(!schName) return alert("è¯·å…ˆé€‰æ‹©è¦è€ƒæ ¸çš„å­¦æ ¡");
        
        const schoolData = SCHOOLS[schName];
        if(!schoolData.metrics || !schoolData.metrics.total) return alert("è¯¥å­¦æ ¡æ•°æ®ä¸å®Œæ•´");

        // ğŸ”¥ 1. è·å–ç”¨æˆ·å¼€å…³çŠ¶æ€ (å†³å®šæ˜¯å¦å¯ç”¨å•æ¬¡æ¨¡å¼)
        const useProgress = document.getElementById('sse_check_prog').checked;
        const useExc = document.getElementById('sse_check_exc').checked;
        const usePass = document.getElementById('sse_check_pass').checked;
        const useAvg = document.getElementById('sse_check_avg').checked;

        // ğŸ”¥ 2. åŠ¨æ€åˆ†é…æƒé‡
        // é»˜è®¤æ¨¡å‹ï¼šä¼˜ç§€35 + åŠæ ¼35 + å‡åˆ†20 + å¢å€¼10 = 100
        let wExc = 35, wPass = 35, wAvg = 20, wProg = 10;

        // å¦‚æœç”¨æˆ·ã€å–æ¶ˆå‹¾é€‰ã€‘ç”Ÿæºå¢å€¼ï¼ˆå•æ¬¡æ¨¡å¼ï¼‰ï¼š
        // å°†å¢å€¼çš„ 10 åˆ†æƒé‡è½¬ç§»ç»™â€œå‡åˆ†â€
        if (!useProgress) {
            wProg = 0;
            wAvg = 30; // 20 + 10
        }
        
        // æç«¯æƒ…å†µå¤„ç†ï¼šå¦‚æœæœ‰å…¶ä»–é¡¹ä¹Ÿè¢«å…³é—­ï¼Œåˆ™å½’é›¶
        if (!useExc) wExc = 0;
        if (!usePass) wPass = 0;
        if (!useAvg) wAvg = 0;

        // æ›´æ–°è¡¨å¤´æ–‡å­—
        SSE_updateHeaderLabels(wExc, wPass, wAvg, wProg);

        // 3. å‡†å¤‡æ•°æ® (ä»…åœ¨å‹¾é€‰äº†å¢å€¼æ—¶æ‰è¯·æ±‚å†å²æ•°æ®)
        if (useProgress) {
            if (PREV_DATA.length > 0 && (!PROGRESS_CACHE || PROGRESS_CACHE.length === 0)) {
                performSilentMatching();
            }
            if (PROGRESS_CACHE.length === 0) {
                // ä»…åšè½»æç¤ºï¼Œä¸é˜»æ–­è®¡ç®—
                UI.toast("âš ï¸ æœªæ£€æµ‹åˆ°å†å²æ•°æ®ï¼Œå¢å€¼é¡¹å°†è®°ä¸º0åˆ†ã€‚å¦‚åªéœ€æœ¬æ¬¡æˆç»©ï¼Œè¯·å–æ¶ˆå‹¾é€‰â€œç”Ÿæºå¢å€¼â€ã€‚", "warning");
            }
        }
        
        // 4. åˆ†ç­å¹¶åŒºåˆ†ã€åœ¨ç±ã€‘ä¸ã€å®è€ƒã€‘
        const classes = {};
        let totalEnrollment = 0; // å…¨æ ¡åœ¨ç±æ€»æ•° (ç”¨äºç®—å¹³å‡ç­é¢)
        
        schoolData.students.forEach(s => {
            if(!classes[s.class]) classes[s.class] = { name: s.class, allStudents: [], validStudents: [] };
            
            // A. åªè¦Excelé‡Œæœ‰è¿™ä¸€è¡Œï¼Œå°±ç®—ã€åœ¨ç±ã€‘(ç”¨äºç®—è¾›è‹¦åˆ†)
            classes[s.class].allStudents.push(s);
            
            // B. åªæœ‰çœŸçš„æœ‰åˆ†æ•°ï¼Œæ‰ç®—ã€å®è€ƒã€‘(ç”¨äºç®—å¹³å‡åˆ†/ä¼˜ç§€ç‡)
            if(s.hasValidScore || s.total > 0) {
                classes[s.class].validStudents.push(s);
            }
        });

        const classNames = Object.keys(classes);
        classNames.forEach(c => {
            totalEnrollment += classes[c].allStudents.length;
        });

        // è®¡ç®—å¹´çº§å¹³å‡ç­é¢ (å«ç¼ºè€ƒ)
        const avgClassSize = totalEnrollment / classNames.length;
        
        // è®¡ç®—å¹´çº§åŸºå‡†çº¿ (ç”¨å®è€ƒåˆ†æ•°çš„åˆ†å¸ƒç®—ï¼Œé¿å…0åˆ†æ‹‰ä½ä¼˜ç§€çº¿)
        const allValidScores = [];
        classNames.forEach(c => classes[c].validStudents.forEach(s => allValidScores.push(s.total)));
        allValidScores.sort((a,b) => b-a);
        
        const excLine = allValidScores[Math.floor(allValidScores.length * 0.25)] || 0;
        const passLine = allValidScores[Math.floor(allValidScores.length * 0.80)] || 0; 
        const gradeAvgScore = allValidScores.reduce((a,b)=>a+b,0) / (allValidScores.length || 1);

        // 5. è®¡ç®—å„é¡¹æŒ‡æ ‡
        let metrics = [];
        
        Object.values(classes).forEach(cls => {
            const enrollment = cls.allStudents.length; // åœ¨ç±
            const n = cls.validStudents.length;        // å®è€ƒ
            
            const realN = n > 0 ? n : 1; 
            const scores = cls.validStudents.map(s => s.total);
            
            // æ•™å­¦æŒ‡æ ‡ (åŸºäºå®è€ƒ)
            const avg = scores.reduce((a,b)=>a+b,0) / realN;
            const excRate = scores.filter(v => v >= excLine).length / realN;
            const passRate = scores.filter(v => v >= passLine).length / realN;

            // å¤§ç­è¡¥å¿ (åŒå‘æµ®åŠ¨ï¼šå¤šé€€å°‘è¡¥)
            const sizeDiff = enrollment - avgClassSize;
            const sizeBonus = sizeDiff * 0.1; 

            // ç”Ÿæºå¢å€¼ (ä»…åœ¨å¼€å¯æ—¶è®¡ç®—)
            let avgProgress = 0;
            let matchedCount = 0;
            if (useProgress) {
                let progressSum = 0;
                cls.validStudents.forEach(stu => {
                    const rec = PROGRESS_CACHE.find(p => p.name === stu.name && p.class === stu.class);
                    if(rec) { progressSum += rec.change; matchedCount++; }
                });
                avgProgress = matchedCount > 0 ? (progressSum / matchedCount) : 0;
            }

            metrics.push({
                className: cls.name,
                count: n,          // å®è€ƒ
                enrollment: enrollment, // åœ¨ç±
                avg: avg,
                excRate: excRate,
                passRate: passRate,
                avgProgress: avgProgress,
                sizeBonus: sizeBonus,
                matchedCount: matchedCount
            });
        });

        // 6. å½’ä¸€åŒ–èµ‹åˆ†
        const maxExcRate = Math.max(...metrics.map(m => m.excRate)) || 1;
        const maxPassRate = Math.max(...metrics.map(m => m.passRate)) || 1;
        
        // å¢å€¼åˆ†å½’ä¸€åŒ–èŒƒå›´
        let minProg = 0, progRange = 1;
        if (useProgress) {
            const progressVals = metrics.map(m => m.avgProgress);
            const maxProg = Math.max(...progressVals);
            minProg = Math.min(...progressVals);
            progRange = maxProg - minProg;
        }

        metrics.forEach(m => {
            // ä½¿ç”¨åŠ¨æ€æƒé‡è®¡ç®—
            m.scoreExc = (m.excRate / maxExcRate) * wExc;
            m.scorePass = (m.passRate / maxPassRate) * wPass;
            m.scoreAvg = (m.avg / gradeAvgScore) * wAvg;
            
            m.scoreProg = 0;
            if (useProgress) {
                if (progRange === 0) m.scoreProg = wProg;
                else m.scoreProg = ((m.avgProgress - minProg) / progRange) * wProg;
            }
            
            // æœ€ç»ˆæ±‡æ€»
            m.finalScore = m.scoreExc + m.scorePass + m.scoreAvg + m.scoreProg + m.sizeBonus;
        });

        // 7. æ¸²æŸ“è¡¨æ ¼
        metrics.sort((a,b) => b.finalScore - a.finalScore);
        SSE_CACHE = metrics;

        const tbody = document.querySelector('#sse_table tbody');
        let html = '';
        
        metrics.forEach((m, i) => {
            const teacherName = TEACHER_MAP[`${m.className}_ç­ä¸»ä»»`] || '-';
            
            // è¡¥å¿åˆ†æ ·å¼
            let bonusBg = '#f3f4f6', bonusColor = '#666', bonusSign = '';
            if (m.sizeBonus > 0.001) { bonusBg = '#dcfce7'; bonusColor = '#166534'; bonusSign = '+'; }
            else if (m.sizeBonus < -0.001) { bonusBg = '#fee2e2'; bonusColor = '#991b1b'; }

            // å¢å€¼åˆ—æ˜¾ç¤ºé€»è¾‘ (æ ¹æ®å¼€å…³éšè—/æ˜¾ç¤ºå†…å®¹)
            let progHtml = '';
            if (useProgress) {
                progHtml = `<td><div style="font-weight:bold; color:${m.avgProgress>=0?'green':'red'}">${m.scoreProg.toFixed(1)}</div><div style="font-size:10px; color:#666">${m.matchedCount>0 ? (m.avgProgress>0?'+':'')+m.avgProgress.toFixed(1)+'å' : '-'}</div></td>`;
            } else {
                progHtml = `<td style="display:none"></td>`;
            }

            html += `
                <tr>
                    <td class="rank-cell ${i<3 ? 'r-'+(i+1) : ''}">${i+1}</td>
                    <td style="font-weight:bold; font-size:15px;">${m.className}</td>
                    <td>${teacherName}</td>
                    
                    <td>
                        <div style="font-size:13px; font-weight:bold; color:#333;">${m.count} <span style="font-size:10px; font-weight:normal; color:#999;">(å®è€ƒ)</span></div>
                        <div style="font-size:12px; color:#0369a1; background:#f0f9ff; display:inline-block; padding:0 4px; border-radius:3px;">${m.enrollment} <span style="font-size:10px; color:#64748b;">(åœ¨ç±)</span></div>
                    </td>
                    
                    <td>
                        <span class="badge" style="background:${bonusBg}; color:${bonusColor};">
                            ${bonusSign}${m.sizeBonus.toFixed(2)}
                        </span>
                        <div style="font-size:10px; color:#999; margin-top:2px;">(å·®å‡ ${(m.enrollment - avgClassSize).toFixed(1)}äºº)</div>
                    </td>
                    
                    <td><div style="font-weight:bold;">${m.scoreExc.toFixed(1)}</div><div style="font-size:10px; color:#666">ç‡:${(m.excRate*100).toFixed(1)}%</div></td>
                    <td><div style="font-weight:bold;">${m.scorePass.toFixed(1)}</div><div style="font-size:10px; color:#666">ç‡:${(m.passRate*100).toFixed(1)}%</div></td>
                    <td><div style="font-weight:bold;">${m.scoreAvg.toFixed(1)}</div><div style="font-size:10px; color:#666">${m.avg.toFixed(1)}</div></td>
                    
                    ${progHtml}
                    
                    <td style="background:#eff6ff; font-weight:800; font-size:18px; color:#1e3a8a;">${m.finalScore.toFixed(2)}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        const hintDiv = document.getElementById('sse_result_container').querySelector('.sub-header');
        if(hintDiv) hintDiv.innerHTML = `<span>ğŸ“Š ç»©æ•ˆèµ‹åˆ†æ’è¡Œæ¦œ</span> <span style="font-size:11px; margin-left:10px; color:#0369a1; background:#e0f2fe; padding:2px 5px; border-radius:4px;">ğŸ’¡ æ¨¡å¼ï¼š${useProgress?'å…¨ç»´åº¦(å«å¢å€¼)':'å•æ¬¡(æƒé‡é‡ç»„)'} | åœ¨ç±äººæ•°ç®—è¡¥è´´ï¼Œå®è€ƒäººæ•°ç®—æˆç»©ã€‚</span>`;
        document.getElementById('sse_result_container').classList.remove('hidden');
    }

    // 3. å¯¼å‡ºåŠŸèƒ½ (é€‚é…åŠ¨æ€åˆ—)
    function SSE_export() {
        if(!SSE_CACHE.length) return alert("è¯·å…ˆè¿›è¡Œè®¡ç®—");
        
        const useProgress = document.getElementById('sse_check_prog').checked;
        const wb = XLSX.utils.book_new();
        
        // åŠ¨æ€æ„å»ºè¡¨å¤´
        const headers = ['æ’å', 'ç­çº§', 'å®è€ƒäººæ•°', 'åœ¨ç±äººæ•°(åå•æ€»æ•°)', 'å¤§ç­è¡¥å¿åˆ†', 'ä¼˜ç§€ç‡%', 'ä¼˜ç§€å¾—åˆ†', 'åŠæ ¼ç‡%', 'åŠæ ¼å¾—åˆ†', 'å¹³å‡åˆ†', 'å‡åˆ†å¾—åˆ†'];
        if(useProgress) {
            headers.push('è¿›æ­¥åæ¬¡', 'å¢å€¼å¾—åˆ†');
        }
        headers.push('æœ€ç»ˆè€ƒæ ¸æ€»åˆ†');

        const data = [headers];
        
        SSE_CACHE.forEach((m, i) => {
            const row = [
                i+1, m.className, 
                m.count,      // å®è€ƒ
                m.enrollment, // åœ¨ç±
                m.sizeBonus.toFixed(2),
                (m.excRate*100).toFixed(2), m.scoreExc.toFixed(2),
                (m.passRate*100).toFixed(2), m.scorePass.toFixed(2),
                m.avg.toFixed(2), m.scoreAvg.toFixed(2)
            ];
            
            if(useProgress) {
                row.push(m.avgProgress.toFixed(1), m.scoreProg.toFixed(2));
            }
            
            row.push(m.finalScore.toFixed(2));
            data.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = [{wch:6}, {wch:10}, {wch:8}, {wch:12}, {wch:12}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:10}, {wch:15}];
        
        XLSX.utils.book_append_sheet(wb, ws, "ç»©æ•ˆè€ƒæ ¸è¡¨");
        XLSX.writeFile(wb, `${document.getElementById('sse_school_select').value}_ç»©æ•ˆè€ƒæ ¸è¡¨.xlsx`);
    }

    // æ‹¦æˆªé¡µé¢åˆ·æ–°æˆ–å…³é—­ï¼Œé˜²æ­¢æœªä¿å­˜çš„æ•°æ®ä¸¢å¤±
    window.addEventListener('beforeunload', (e) => {
        // å¦‚æœ RAW_DATA é‡Œæœ‰æ•°æ®ï¼Œè¯´æ˜è€å¸ˆå·²ç»å¯¼å…¥è¿‡æ–‡ä»¶
        if (RAW_DATA.length > 0) {
            const msg = "ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨æœ‰æ­£åœ¨å¤„ç†çš„æˆç»©æ•°æ®ï¼Œåˆ·æ–°æˆ–å…³é—­é¡µé¢å°†å¯¼è‡´é…ç½®ï¼ˆå¦‚æ•™å¸ˆåå•ï¼‰ä¸¢å¤±ã€‚ç¡®å®šç¦»å¼€å—ï¼Ÿ";
            e.preventDefault();
            e.returnValue = msg; // ç°ä»£æµè§ˆå™¨å¤§å¤šæ•°ä¼šå±•ç¤ºå…¶é»˜è®¤çš„æç¤ºè¯­ï¼Œä½†å¿…é¡»è®¾ç½®è¿™ä¸ªå€¼
            return msg;
        }
    });
    // ================== å¤–è§‚å®šåˆ¶é€»è¾‘ (æ¢è‚¤ & Logo) ==================
    const SKIN_CONFIG_KEY = 'app_skin_config';
    let currentSkin = {
        primaryColor: '#4f46e5', // é»˜è®¤é¢œè‰²
        logoBase64: '',
        customTitle: ''
    };

    // 1. æ‰“å¼€æ¨¡æ€æ¡†
    function openSkinModal() {
        document.getElementById('skin-modal').style.display = 'flex';
        // å¡«å……å½“å‰å€¼
        document.getElementById('custom-color-input').value = currentSkin.primaryColor || '#4f46e5';
        document.getElementById('custom-title-input').value = currentSkin.customTitle || '';
    }

    // 2. è®¾ç½®ä¸»é¢˜è‰² (åŠ¨æ€è®¡ç®—æ·±è‰²å˜ä½“)
    function setThemeColor(color) {
        currentSkin.primaryColor = color;
        // æ›´æ–° CSS å˜é‡
        document.documentElement.style.setProperty('--primary', color);
        
        // ç®€å•çš„é¢œè‰²å˜æš—é€»è¾‘ï¼Œç”¨äº --primary-dark
        const darkenColor = (hex, percent) => {
            let num = parseInt(hex.replace("#",""), 16),
            amt = Math.round(2.55 * percent),
            R = (num >> 16) - amt,
            B = ((num >> 8) & 0x00FF) - amt,
            G = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (B<255?B<1?0:B:255)*0x100 + (G<255?G<1?0:G:255)).toString(16).slice(1);
        };
        
        try {
            const darkColor = darkenColor(color, 30); // å˜æš— 30% å½¢æˆæ¸å˜
            const lightColor = color + '1A'; // å¢åŠ  10% é€æ˜åº¦ (Hex Alpha)
            document.documentElement.style.setProperty('--primary-dark', darkColor);
            document.documentElement.style.setProperty('--primary-light', lightColor); 
            
            // æ‰‹åŠ¨æ›´æ–° Header èƒŒæ™¯ (å› ä¸º CSS å˜é‡åœ¨ linear-gradient æœ‰æ—¶éœ€è¦å¼ºåˆ¶åˆ·æ–°)
            const header = document.querySelector('header');
            if(header) {
                header.style.background = `linear-gradient(135deg, ${color} 0%, ${darkColor} 100%)`;
            }
        } catch(e) { console.warn("é¢œè‰²è®¡ç®—é”™è¯¯", e); }
    }

    // 3. å¤„ç† Logo ä¸Šä¼ 
    function handleLogoUpload(input) {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 500 * 1024) return alert("Logo å›¾ç‰‡è¿‡å¤§ï¼Œè¯·ä½¿ç”¨ 500KB ä»¥å†…çš„å›¾ç‰‡");

        const reader = new FileReader();
        reader.onload = function(e) {
            currentSkin.logoBase64 = e.target.result;
            applyLogo(currentSkin.logoBase64);
            // alert("Logo ä¸Šä¼ æˆåŠŸï¼ç‚¹å‡»ä¸‹æ–¹ä¿å­˜æŒ‰é’®ç”Ÿæ•ˆã€‚");
        };
        reader.readAsDataURL(file);
    }

    function applyLogo(base64) {
        const img = document.getElementById('custom-logo-img');
        if (base64) {
            img.src = base64;
            img.style.display = 'block';
        } else {
            img.style.display = 'none';
            img.src = '';
        }
    }

    function clearLogo() {
        currentSkin.logoBase64 = '';
        applyLogo('');
    }

    // 4. æ ‡é¢˜å®æ—¶é¢„è§ˆ
    function updateTitlePreview(val) {
        const titleEl = document.getElementById('app-title');
        // ä¿ç•™é‡Œé¢çš„ span (badge)
        const badge = titleEl.querySelector('.badge');
        const badgeHtml = badge ? badge.outerHTML : '';
        
        if(val.trim()) {
            titleEl.innerHTML = val + ' ' + badgeHtml;
        } else {
            titleEl.innerHTML = 'ä¹¡é•‡å­¦æ ¡æˆç»©åˆ†æä¸æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ ' + badgeHtml;
        }
        currentSkin.customTitle = val;
    }

    // 5. ä¿å­˜è®¾ç½®åˆ° LocalStorage
    function saveSkinSettings() {
        localStorage.setItem(SKIN_CONFIG_KEY, JSON.stringify(currentSkin));
        document.getElementById('skin-modal').style.display = 'none';
        if(window.UI) window.UI.toast("âœ… å¤–è§‚è®¾ç½®å·²ä¿å­˜", "success");
        else alert("è®¾ç½®å·²ä¿å­˜");
    }

    // 6. åˆå§‹åŒ–åŠ è½½è®¾ç½®
    function loadSkinSettings() {
        const saved = localStorage.getItem(SKIN_CONFIG_KEY);
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                currentSkin = { ...currentSkin, ...parsed };
                if(currentSkin.primaryColor) setThemeColor(currentSkin.primaryColor);
                if(currentSkin.logoBase64) applyLogo(currentSkin.logoBase64);
                if(currentSkin.customTitle) updateTitlePreview(currentSkin.customTitle);
            } catch(e) { console.error("åŠ è½½çš®è‚¤é…ç½®å¤±è´¥", e); }
        }
    }
    // ================== è¯­éŸ³æ§åˆ¶ç³»ç»Ÿ (Web Speech API) ==================
    const VoiceControl = {
        recognition: null,
        isListening: false,
        hud: null,
        statusEl: null,
        resultEl: null,
        fab: null,

        // æŒ‡ä»¤æ˜ å°„è¡¨ (æ¨¡ç³ŠåŒ¹é…)
        commands: [
            { keywords: ['æ€»æ¦œ', 'æ€»æ’å', 'ç»¼åˆæ’å', 'å…¨ç§‘'], action: () => switchTab('summary') },
            { keywords: ['ä¸¤ç‡ä¸€åˆ†', 'æ¨ªå‘', 'å®è§‚'], action: () => switchTab('analysis') },
            { keywords: ['æ•™å¸ˆ', 'è€å¸ˆ', 'æ•™å­¦'], action: () => switchTab('teacher-analysis') },
            { keywords: ['æŒ‡æ ‡', 'è¾¾æ ‡'], action: () => switchTab('indicator') },
            { keywords: ['åè¿›', 'å1/3', 'ä¸‰åˆ†ä¹‹ä¸€'], action: () => switchTab('bottom3') },
            { keywords: ['è¿›é€€', 'è¿›æ­¥', 'é€€æ­¥', 'è¿½è¸ª'], action: () => switchTab('progress-analysis') },
            { keywords: ['ä¸´ç•Œ', 'è¾¹ç¼˜'], action: () => switchTab('marginal-push') },
            { keywords: ['è€ƒåœº', 'ç›‘è€ƒ'], action: () => switchTab('exam-arranger') },
            { keywords: ['åˆ†ç­', 'æ–°ç”Ÿ'], action: () => switchTab('freshman-simulator') },
            { keywords: ['å…¨å±', 'å¤§å±'], action: () => VoiceControl.toggleFullScreen(true) },
            { keywords: ['é€€å‡ºå…¨å±', 'æ™®é€š', 'æ¢å¤'], action: () => VoiceControl.toggleFullScreen(false) },
            { keywords: ['å…³é—­', 'é€€å‡º', 'åœæ­¢'], action: () => VoiceControl.stop() }
        ],

        init: function() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨ã€‚");
                document.getElementById('voice-fab').style.display = 'none';
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            this.recognition.continuous = true; // è¿ç»­ç›‘å¬
            this.recognition.interimResults = true; // å®æ—¶åé¦ˆ
            this.recognition.lang = 'zh-CN';

            this.hud = document.getElementById('voice-hud');
            this.statusEl = document.getElementById('voice-status');
            this.resultEl = document.getElementById('voice-result');
            this.fab = document.getElementById('voice-fab');

            // ç»‘å®šäº‹ä»¶
            this.recognition.onstart = () => {
                this.isListening = true;
                this.fab.classList.add('listening');
                this.hud.classList.add('active');
                this.statusEl.innerText = "æ­£åœ¨è†å¬...";
                this.statusEl.style.color = "white";
            };

            this.recognition.onend = () => {
                // å¦‚æœéæ‰‹åŠ¨åœæ­¢ï¼Œä¸”åŸæœ¬æ˜¯å¼€å¯çŠ¶æ€ï¼Œåˆ™è‡ªåŠ¨é‡å¯ï¼ˆä¿æŒå¸¸é©»ï¼‰
                if (this.isListening) {
                    try { this.recognition.start(); } catch(e){}
                } else {
                    this.fab.classList.remove('listening');
                    this.hud.classList.remove('active');
                }
            };

            this.recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                if (interimTranscript) {
                    this.statusEl.innerText = interimTranscript;
                    this.statusEl.style.color = "#38bdf8"; // è“è‰²è¡¨ç¤ºæ­£åœ¨è¾“å…¥
                }

                if (finalTranscript) {
                    console.log("è¯­éŸ³æŒ‡ä»¤:", finalTranscript);
                    this.statusEl.innerText = finalTranscript;
                    this.statusEl.style.color = "#4ade80"; // ç»¿è‰²è¡¨ç¤ºå·²ç¡®è®¤
                    this.processCommand(finalTranscript);
                }
            };

            this.recognition.onerror = (event) => {
                console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯", event.error);
                if (event.error === 'not-allowed') {
                    alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚");
                    this.stop();
                }
            };
        },

        toggle: function() {
            if (!this.recognition) this.init();
            if (!this.recognition) return;

            if (this.isListening) {
                this.stop();
            } else {
                this.isListening = true;
                this.recognition.start();
            }
        },

        stop: function() {
            this.isListening = false;
            if (this.recognition) this.recognition.stop();
            this.fab.classList.remove('listening');
            this.hud.classList.remove('active');
        },

        processCommand: function(text) {
            text = text.replace(/ã€‚|ï¼Ÿ|ï¼/g, ''); // å»æ ‡ç‚¹
            
            // 1. åŒ¹é…é¢„è®¾æŒ‡ä»¤
            const matchedCmd = this.commands.find(cmd => 
                cmd.keywords.some(key => text.includes(key))
            );

            if (matchedCmd) {
                this.resultEl.innerText = "âœ… æ‰§è¡ŒæŒ‡ä»¤...";
                setTimeout(() => {
                    matchedCmd.action();
                    // æ‰§è¡Œåä¸å…³é—­HUDï¼Œæ–¹ä¾¿è¿ç»­ä¸‹è¾¾æŒ‡ä»¤
                    // å¦‚æœå¸Œæœ›æ‰§è¡Œåå…³é—­ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Š
                    // this.stop(); 
                }, 500);
                return;
            }

            // 2. ç‰¹æ®ŠæŒ‡ä»¤ï¼šæœç´¢å­¦ç”Ÿ/å­¦æ ¡
            if (text.includes("æœç´¢") || text.includes("æŸ¥è¯¢") || text.includes("æŸ¥æ‰¾")) {
                const keyword = text.replace(/æœç´¢|æŸ¥è¯¢|æŸ¥æ‰¾/g, '').trim();
                if (keyword) {
                    this.resultEl.innerText = `ğŸ” æ­£åœ¨æœç´¢ "${keyword}"...`;
                    this.stop(); // æœç´¢éœ€è¦è·³è½¬å¼¹çª—ï¼Œå…³é—­ HUD
                    openSpotlight();
                    const input = document.getElementById('spotlight-input');
                    input.value = keyword;
                    // è§¦å‘ input äº‹ä»¶ä»¥è¿è¡Œæœç´¢
                    input.dispatchEvent(new Event('input'));
                }
                return;
            }
            
            // 3. ç‰¹æ®ŠæŒ‡ä»¤ï¼šåˆ‡æ¢æœ¬æ ¡
            if (text.startsWith("æœ¬æ ¡") || text.includes("åˆ‡æ¢åˆ°")) {
                const keyword = text.replace(/æœ¬æ ¡|åˆ‡æ¢åˆ°/g, '').trim();
                // åœ¨ SCHOOLS ä¸­æ¨¡ç³ŠåŒ¹é…
                const targetSchool = Object.keys(SCHOOLS).find(s => s.includes(keyword));
                if (targetSchool) {
                    this.resultEl.innerText = `ğŸ« åˆ‡æ¢æœ¬æ ¡ä¸ºï¼š${targetSchool}`;
                    document.getElementById('mySchoolSelect').value = targetSchool;
                    // è§¦å‘ change
                    document.getElementById('mySchoolSelect').dispatchEvent(new Event('change'));
                    
                    // å¦‚æœåœ¨æ•™å¸ˆåˆ†æé¡µï¼Œé‡åˆ·æ•°æ®
                    if(document.getElementById('teacher-analysis').classList.contains('active')) {
                        analyzeTeachers();
                    }
                } else {
                    this.resultEl.innerText = `âŒ æœªæ‰¾åˆ°å­¦æ ¡ï¼š${keyword}`;
                }
                return;
            }

            this.resultEl.innerText = "ğŸ¤” æœªè¯†åˆ«çš„æŒ‡ä»¤ï¼Œè¯·é‡è¯•";
        },

        // å¤§å±æ²‰æµ¸æ¨¡å¼ (éšè— Header å’Œ å¯¼èˆª)
        toggleFullScreen: function(enable) {
            const header = document.querySelector('header');
            const nav = document.querySelector('.nav-wrapper');
            const fab = document.getElementById('voice-fab');
            
            if (enable) {
                if(header) header.style.display = 'none';
                if(nav) nav.style.display = 'none';
                document.documentElement.requestFullscreen().catch(e=>{});
                UI.toast("ğŸ“º å·²è¿›å…¥å¤§å±æ¼”ç¤ºæ¨¡å¼", "success");
            } else {
                if(header) header.style.display = 'block';
                if(nav) nav.style.display = 'block';
                if(document.fullscreenElement) document.exitFullscreen().catch(e=>{});
                UI.toast("å·²é€€å‡ºå¤§å±æ¨¡å¼");
            }
        }
    };
    let schoolRadarInstance = null;
    let schoolDistInstance = null;
    let currentModalSchool = '';

    function showSchoolProfile(schoolName) {
        if(!SCHOOLS[schoolName]) return;
        currentModalSchool = schoolName;
        const s = SCHOOLS[schoolName];
        const m = s.metrics.total || {};
        
        // 1. å¡«å……åŸºç¡€æ•°æ®
        document.getElementById('sp-title').innerHTML = `ğŸ« ${schoolName} <small style="font-size:14px; color:#666;">(å‚è€ƒäººæ•°: ${m.count})</small>`;
        document.getElementById('sp-rank').innerText = s.rank2Rate || '-';
        document.getElementById('sp-score').innerText = (s.score2Rate || 0).toFixed(2);
        
        const avgScore = m.ratedAvg || 0;
        const rateScore = (m.ratedExc || 0) + (m.ratedPass || 0);
        document.getElementById('sp-s1').innerText = avgScore.toFixed(1);
        document.getElementById('sp-s2').innerText = rateScore.toFixed(1);

        // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šé›·è¾¾å›¾ (ä½¿ç”¨ subjectLabels) ---
        const subjectLabels = []; 
        const ratios = []; 
        
        SUBJECTS.forEach(sub => {
            if(s.metrics[sub] && s.metrics[sub].avg) {
                // è®¡ç®—å…¨é•‡è¯¥ç§‘å‡åˆ†
                const allAvgs = Object.values(SCHOOLS).map(sch => sch.metrics[sub]?.avg || 0).filter(v=>v>0);
                const townAvg = allAvgs.reduce((a,b)=>a+b,0) / allAvgs.length;
                
                const ratio = townAvg ? (s.metrics[sub].avg / townAvg) : 0;
                subjectLabels.push(sub);
                ratios.push(parseFloat(ratio.toFixed(2)));
            }
        });

        const ctxRadar = document.getElementById('schoolRadarChart');
        if(schoolRadarInstance) schoolRadarInstance.destroy();
        
        schoolRadarInstance = new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: subjectLabels, 
                datasets: [{
                    label: 'å­¦ç§‘æ•ˆèƒ½ (æœ¬æ ¡ Ã· å…¨é•‡)',
                    data: ratios,
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    borderColor: '#4f46e5',
                    pointBackgroundColor: '#4f46e5',
                    pointBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                onClick: (e, elements) => {
                    if (!elements.length) return;
                    const idx = elements[0].index;
                    const subject = subjectLabels[idx]; // è·å–ç‚¹å‡»çš„ç§‘ç›®
                    
                    // å…³é—­å½“å‰æ¨¡æ€æ¡†
                    document.getElementById('school-profile-modal').style.display = 'none';
                    
                    // è·³è½¬åˆ°â€œç­çº§æ¨ªå‘å¯¹æ¯”â€æ¨¡å—ï¼Œå¹¶ç­›é€‰è¯¥ç§‘ç›®
                    jumpToModule('class-comparison'); // åˆ©ç”¨å·²æœ‰çš„è·³è½¬å‡½æ•°
                    
                    // å»¶æ—¶æ»šåŠ¨åˆ°è¯¥ç§‘ç›®çš„å¯¹æ¯”è¡¨
                    setTimeout(() => {
                        // æ¨¡æ‹Ÿç‚¹å‡»è¯¥ç§‘ç›®çš„ä¾§è¾¹æ å¯¼èˆª (å¦‚æœæœ‰)
                        // æˆ–è€…ç›´æ¥æ»šåŠ¨åˆ°å¯¹åº”é”šç‚¹
                        const anchor = document.getElementById(`anchor-class-${subject}`);
                        if(anchor) {
                            anchor.scrollIntoView({behavior: "smooth", block: "center"});
                            // å±•å¼€å¯¹åº”çš„ä¾§è¾¹æ å­èœå•
                            const navLink = document.querySelector(`.side-nav-sub-link`); 
                            // ç®€å•æç¤ºç”¨æˆ·
                            UI.toast(`å·²å®šä½åˆ° ${subject} å¯¹æ¯”åˆ†æ`, 'success');
                        }
                    }, 600); // ç­‰å¾…é¡µé¢åˆ‡æ¢å’Œæ¸²æŸ“
                },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                },
                scales: {
                    r: { beginAtZero: false, min: 0.5, max: Math.max(...ratios, 1.1) + 0.1, ticks: { display: false }, pointLabels: { font: { size: 11, weight: 'bold' } } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // ç”Ÿæˆè¯Šæ–­è¯­ (ä¿®å¤ undefined é—®é¢˜)
        if (ratios.length > 0) {
            const maxIdx = ratios.indexOf(Math.max(...ratios));
            const minIdx = ratios.indexOf(Math.min(...ratios));
            const maxSub = subjectLabels[maxIdx]; 
            const minSub = subjectLabels[minIdx];
            document.getElementById('sp-diagnosis').innerHTML = `è¯¥æ ¡ä¼˜åŠ¿å­¦ç§‘ä¸º <strong style="color:#16a34a">${maxSub}</strong> (æ•ˆèƒ½${ratios[maxIdx]})ï¼Œç›¸å¯¹è–„å¼±å­¦ç§‘ä¸º <strong style="color:#dc2626">${minSub}</strong>ã€‚å»ºè®®ç‚¹å‡»â€œç­çº§å¯¹æ¯”â€æŸ¥çœ‹å…·ä½“å·®å¼‚ã€‚`;
        } else {
            document.getElementById('sp-diagnosis').innerHTML = "æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¯Šæ–­ã€‚";
        }

        // --- ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ†æ•°æ®µåˆ†å¸ƒå›¾ (ä½¿ç”¨ distLabels é¿å…å†²çª) ---
        const step = 50; 
        const allScores = RAW_DATA.map(s => s.total);
        const myScores = s.students.map(s => s.total);
        
        if (allScores.length > 0) {
            const maxScore = Math.ceil(Math.max(...allScores));
            const minScore = Math.floor(Math.min(...allScores));
            const startBin = Math.floor(minScore / step) * step;
            const endBin = Math.ceil(maxScore / step) * step;
            
            const distLabels = []; 
            const townData = [];
            const schoolData = [];
            const totalTown = allScores.length || 1;
            const totalSchool = myScores.length || 1;

            for (let i = startBin; i < endBin; i += step) {
                const low = i; const high = i + step;
                distLabels.push(`${low}-${high}`);
                const tCount = allScores.filter(v => v >= low && v < high).length;
                townData.push((tCount / totalTown * 100).toFixed(1)); 
                const sCount = myScores.filter(v => v >= low && v < high).length;
                schoolData.push((sCount / totalSchool * 100).toFixed(1));
            }

            const ctxDist = document.getElementById('schoolDistChart');
            if (schoolDistInstance) schoolDistInstance.destroy();

            schoolDistInstance = new Chart(ctxDist, {
                type: 'bar',
                data: {
                    labels: distLabels, // ä½¿ç”¨ç‹¬ç«‹å˜é‡
                    datasets: [
                        { type: 'line', label: 'å…¨é•‡å¹³å‡ (%)', data: townData, borderColor: '#f59e0b', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, tension: 0.4, order: 1 },
                        { type: 'bar', label: 'æœ¬æ ¡åˆ†å¸ƒ (%)', data: schoolData, backgroundColor: '#3b82f6', barPercentage: 0.6, order: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 10, font: { size: 10 } } }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}%` } } },
                    scales: { y: { display: false, beginAtZero: true }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } }
                }
            });
        }

        document.getElementById('school-profile-modal').style.display = 'flex';
    }

    function jumpToModule(moduleId) {
        document.getElementById('school-profile-modal').style.display = 'none';
        switchTab(moduleId);
        setTimeout(() => {
            let selectId = '';
            if(moduleId === 'class-comparison') selectId = 'classCompSchoolSelect';
            else if(moduleId === 'teacher-analysis') selectId = 'mySchoolSelect';
            else if(moduleId === 'student-details') selectId = 'studentSchoolSelect';
            const select = document.getElementById(selectId);
            if(select) { select.value = currentModalSchool; select.dispatchEvent(new Event('change')); if(moduleId === 'teacher-analysis') analyzeTeachers(); }
            if(window.UI) UI.toast(`å·²è·³è½¬è‡³ ${currentModalSchool}`, 'success');
        }, 100);
    }
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¼ºåˆ¶ç§»é™¤æ‰€æœ‰ max-height é™åˆ¶
    window.addEventListener('load', () => {
        const style = document.createElement('style');
        style.innerHTML = `
            .table-wrap { 
                max-height: none !important; 
                height: auto !important; 
                overflow-y: visible !important; 
                display: block !important;
            }
            /* é˜²æ­¢ rank2Rate è®¡ç®—é”™è¯¯å¯¼è‡´è¡Œéšè— */
            tr { display: table-row !important; }
        `;
        document.head.appendChild(style);
        console.log("âœ… å·²å¼ºåˆ¶è§£é™¤è¡¨æ ¼é«˜åº¦é™åˆ¶");
        applyExamMetaUI();
        applyArchiveLockUI();
        if (typeof CohortDB !== 'undefined') CohortDB.renderExamList();
        updateIndicatorUIState();
        ['exam-year','exam-term','exam-type','exam-name','exam-date','exam-reset-point'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', refreshExamGradePreview);
        });
        renderAutoSnapshotsUI();
        updateAdminOnlyButtons();
        initModuleDescToggles();
        updateWatermark();
        if (Auth?.currentUser && !localStorage.getItem('CURRENT_COHORT_ID')) {
            showCohortPicker();
        }
    });

    function initModuleDescToggles() {
        const collapsed = localStorage.getItem('desc_collapsed') !== 'false';
        document.querySelectorAll('.module-desc-bar').forEach(bar => {
            if (!bar.querySelector('.desc-toggle')) {
                const btn = document.createElement('button');
                btn.className = 'desc-toggle';
                btn.type = 'button';
                btn.textContent = collapsed ? 'å±•å¼€è¯´æ˜' : 'æ”¶èµ·è¯´æ˜';
                btn.onclick = () => {
                    bar.classList.toggle('desc-collapsed');
                    const isCollapsed = bar.classList.contains('desc-collapsed');
                    btn.textContent = isCollapsed ? 'å±•å¼€è¯´æ˜' : 'æ”¶èµ·è¯´æ˜';
                    localStorage.setItem('desc_collapsed', String(isCollapsed));
                };
                bar.appendChild(btn);
            }
            if (collapsed) bar.classList.add('desc-collapsed');
        });
    }

    function openCloudRollback() {
        const user = Auth?.currentUser;
        if (!user) return alert('è¯·å…ˆç™»å½•');
        if (user.role !== 'admin') return alert('â›” æƒé™ä¸è¶³');
        const modal = document.getElementById('data-manager-modal');
        if (modal) modal.style.display = 'flex';
        if (typeof DataManager !== 'undefined') {
            DataManager.switchTab('cloud');
            setTimeout(() => {
                const chkSnap = document.getElementById('cloud-filter-snapshots');
                const chkCur = document.getElementById('cloud-filter-current');
                if (chkSnap) chkSnap.checked = true;
                if (chkCur) chkCur.checked = true;
                DataManager.renderCloudBackups();
            }, 100);
        }
    }

    function updateAdminOnlyButtons() {
        const user = Auth?.currentUser;
        const btn = document.getElementById('btn-cloud-rollback');
        if (!btn) return;
        btn.style.display = (user && user.role === 'admin') ? 'inline-flex' : 'none';
    }

    function updateWatermark() {
        const layer = document.getElementById('watermark-layer');
        if (!layer) return;
        const user = Auth?.currentUser;
        const name = user?.name || 'æœªç™»å½•';
        const ts = new Date().toLocaleString();
        const text = `${name} | ${ts} | å†…éƒ¨èµ„æ–™`;

        // SVG èƒŒæ™¯æ°´å°
        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="320" height="220">
                <style>
                    text { font: 14px 'Microsoft YaHei', Arial, sans-serif; fill: rgba(0,0,0,0.6); }
                </style>
                <g transform="rotate(-20 160 110)">
                    <text x="10" y="80">${text}</text>
                    <text x="10" y="160">${text}</text>
                </g>
            </svg>
        `;
        const encoded = encodeURIComponent(svg).replace(/'/g, '%27').replace(/"/g, '%22');
        layer.style.backgroundImage = `url("data:image/svg+xml,${encoded}")`;
    }

    // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ—¶é—´æˆ³æ°´å°
    setInterval(updateWatermark, 60000);

    // === å±Šåˆ«ç®¡ç† (Cohort) ===
    const COHORT_STORAGE_KEY = 'COHORT_LIST';

    function getCohortKey(cohortId) {
        return `cohort::${cohortId}`;
    }

    function formatCohortLabel(meta) {
        if (!meta || !meta.year) return 'æœªé€‰æ‹©';
        return `${meta.year}çº§ (å…­å¹´çº§å…¥å­¦)`;
    }

    function computeCohortGrade(meta, examMeta) {
        if (!meta || !meta.year) return '';
        const startGrade = 6;
        const entryYear = parseInt(meta.year);
        const baseYear = getAcademicYearStart(examMeta);
        if (!baseYear || isNaN(entryYear)) return '';
        const offset = baseYear - entryYear;
        const grade = startGrade + offset;
        return grade < 1 ? '' : grade;
    }

    function getAcademicYearStart(examMeta) {
        if (!examMeta || !examMeta.year) return new Date().getMonth() + 1 >= 9 ? new Date().getFullYear() : new Date().getFullYear() - 1;
        const parts = String(examMeta.year).split('-');
        const start = parseInt(parts[0]);
        return isNaN(start) ? new Date().getFullYear() : start;
    }

    function getTermId(meta) {
        if (!meta) return '';
        const grade = meta.grade || computeCohortGrade(CURRENT_COHORT_META, meta) || '';
        const term = meta.term || '';
        return grade ? `${grade}å¹´çº§_${term}` : term;
    }

    function getExamLabelForKey(meta) {
        if (!meta) return '';
        const cohort = meta.cohortId ? `${meta.cohortId}çº§` : '';
        const grade = meta.grade ? `${meta.grade}å¹´çº§` : '';
        const year = meta.year || '';
        const term = meta.term || '';
        const type = meta.type || '';
        const date = meta.date || '';
        const name = meta.name || '';
        return [cohort, grade, year, term, type, date, name].filter(Boolean).join('_');
    }

    function refreshExamYearOptions(entryYear) {
        const sel = document.getElementById('exam-year');
        if (!sel) return;
        const yearNum = parseInt(entryYear);
        if (!yearNum) return;
        const years = [];
        for (let y = yearNum; y <= yearNum + 3; y++) {
            years.push(`${y}-${y + 1}`);
        }
        const current = sel.value;
        sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
        if (current && years.includes(current)) sel.value = current;
        else sel.value = years[0];
    }

    function getUserCohortPrefKey() {
        const user = Auth?.currentUser;
        if (!user) return '';
        return `LAST_COHORT_${user.name || 'user'}_${user.role || 'role'}`;
    }

    function rememberUserCohort(cohortId) {
        const key = getUserCohortPrefKey();
        if (!key) return;
        localStorage.setItem(key, cohortId);
    }

    function applyUserCohortPreference() {
        const key = getUserCohortPrefKey();
        if (!key) return;
        const saved = localStorage.getItem(key);
        if (saved) {
            CohortManager.switchTo(saved);
        } else {
            showCohortPicker();
        }
    }

    function showCohortPicker() {
        const mask = document.getElementById('mode-mask');
        const app = document.getElementById('app');
        if (mask) mask.style.display = 'flex';
        if (app) app.classList.add('hidden');
    }

    function resetCohortSelection() {
        localStorage.removeItem('CURRENT_COHORT_ID');
        localStorage.removeItem('CURRENT_COHORT_META');
        localStorage.removeItem('CURRENT_EXAM_ID');
        localStorage.removeItem('CURRENT_TERM_ID');
        CURRENT_COHORT_ID = '';
        CURRENT_COHORT_META = null;
        CURRENT_EXAM_ID = '';
        showCohortPicker();
    }

    function getActiveGrade() {
        const metaStr = localStorage.getItem('ARCHIVE_META');
        if (metaStr) {
            try {
                const meta = JSON.parse(metaStr);
                if (meta && meta.grade) return meta.grade;
            } catch (e) {}
        }
        if (CURRENT_COHORT_META) {
            const guess = computeCohortGrade(CURRENT_COHORT_META, getExamMetaFromUI());
            if (guess) return guess;
        }
        if (CONFIG.name && CONFIG.name.includes('9')) return 9;
        if (CONFIG.name && CONFIG.name.includes('8')) return 8;
        if (CONFIG.name && CONFIG.name.includes('7')) return 7;
        return 6;
    }

    function applyModeByGrade(grade) {
        const isGrade9 = String(grade) === '9';
        if (isGrade9) {
            CONFIG = { name: '9å¹´çº§', label: 'äº”ç§‘æ€»', excRate: 0.06, totalSubs: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦'], analysisSubs: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦','æ”¿æ²»'], showQuery: true };
        } else {
            CONFIG = { name: '6-8å¹´çº§', label: 'å…¨ç§‘æ€»', excRate: 0.05, totalSubs: 'auto', analysisSubs: 'auto', showQuery: true };
        }
        const badge = document.getElementById('mode-badge');
        if (badge) badge.innerText = CONFIG.name;
        const info = document.getElementById('mode-info');
        if (info) info.innerText = `${CONFIG.name}æ¨¡å¼ (æ€»åˆ†: ${CONFIG.label}, å1/3å‰”é™¤: ${CONFIG.excRate*100}%)`;
        document.querySelectorAll('.label-total').forEach(e => e.innerText = CONFIG.label);
        const excEl = document.getElementById('label-exc');
        if (excEl) excEl.innerText = (CONFIG.excRate*100) + '%';
        renderNavigation();
    }

    const CohortManager = {
        list: [],

        load: function() {
            try {
                this.list = JSON.parse(localStorage.getItem(COHORT_STORAGE_KEY) || '[]');
                this.list.forEach(c => { c.startGrade = 6; });
            } catch (e) {
                this.list = [];
            }
        },

        save: function() {
            localStorage.setItem(COHORT_STORAGE_KEY, JSON.stringify(this.list));
        },

        renderSelector: function() {
            const sel = document.getElementById('cohort-selector');
            if (!sel) return;
            const current = localStorage.getItem('CURRENT_COHORT_ID') || '';
            sel.innerHTML = '<option value="">ğŸ“‚ è¯·é€‰æ‹©å±Šåˆ«</option>' + this.list.map(c => {
                const label = formatCohortLabel(c);
                return `<option value="${c.id}">${label}</option>`;
            }).join('');
            if (current) sel.value = current;
        },

        addFromUI: function() {
            const year = parseYearFromInput('cohort-year');
            const startGrade = 6;
            if (!year || year < 2000) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å…¥å­¦å¹´ä»½');
            this.addCohort({ year, startGrade });
        },

        addCohort: function({ year, startGrade }) {
            const id = String(year);
            if (this.list.some(c => c.id === id)) {
                return this.switchTo(id);
            }
            const meta = { id, year, startGrade, createdAt: Date.now() };
            this.list.unshift(meta);
            this.save();
            this.renderSelector();
            this.switchTo(id);
        },

        switchTo: function(cohortId) {
            if (!cohortId) return;
            const meta = this.list.find(c => c.id === cohortId);
            if (!meta) return alert('æœªæ‰¾åˆ°è¯¥å±Šåˆ«');
            CURRENT_COHORT_ID = cohortId;
            CURRENT_COHORT_META = meta;
            localStorage.setItem('CURRENT_COHORT_ID', cohortId);
            localStorage.setItem('CURRENT_COHORT_META', JSON.stringify(meta));
            rememberUserCohort(cohortId);
            const label = formatCohortLabel(meta);
            const status = document.getElementById('cohort-status');
            if (status) status.innerText = `å·²åˆ‡æ¢è‡³ ${label}`;
            const currentLabel = document.getElementById('cohort-current-label');
            if (currentLabel) currentLabel.innerText = label;
            const examCohortLabel = document.getElementById('exam-cohort-label');
            if (examCohortLabel) examCohortLabel.innerText = label;
            refreshExamYearOptions(meta.year);
            this.renderSelector();
            switchCohort(cohortId);
        },

        init: function() {
            this.load();
            const saved = localStorage.getItem('CURRENT_COHORT_ID');
            if (saved) {
                const metaStr = localStorage.getItem('CURRENT_COHORT_META');
                if (metaStr) {
                    try { CURRENT_COHORT_META = JSON.parse(metaStr); } catch (e) {}
                }
                CURRENT_COHORT_ID = saved;
            }
            if (CURRENT_COHORT_META) CURRENT_COHORT_META.startGrade = 6;
            this.renderSelector();
            if (CURRENT_COHORT_META) {
                const currentLabel = document.getElementById('cohort-current-label');
                if (currentLabel) currentLabel.innerText = formatCohortLabel(CURRENT_COHORT_META);
                const examCohortLabel = document.getElementById('exam-cohort-label');
                if (examCohortLabel) examCohortLabel.innerText = formatCohortLabel(CURRENT_COHORT_META);
            }
        }
    };

    function enterCohortFromMask() {
        const year = parseYearFromInput('entry-cohort-year');
        const startGrade = 6;
        if (!year || year < 2000) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å…¥å­¦å¹´ä»½');
        CohortManager.addCohort({ year, startGrade });
        document.getElementById('mode-mask').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
    }

    function parseYearFromInput(id) {
        const val = document.getElementById(id)?.value || '';
        return parseInt(val, 10);
    }

    // === è€ƒè¯•æ¡£æ¡ˆåŒ–ä¸å°å­˜é€»è¾‘ ===
    function buildExamKey(meta) {
        const cohortLabel = meta.cohortId ? `${meta.cohortId}çº§` : 'æœªçŸ¥å±Šåˆ«';
        const gradeLabel = meta.grade ? `${meta.grade}å¹´çº§` : 'æœªçŸ¥å¹´çº§';
        const base = `${cohortLabel}-${gradeLabel}-${meta.year}-${meta.term}-${meta.type}` + (meta.date ? `-${meta.date}` : '');
        return meta.name ? `${base}-${meta.name}` : base;
    }

    function getExamMetaFromUI() {
        const year = document.getElementById('exam-year')?.value || '';
        const term = document.getElementById('exam-term')?.value || '';
        const type = document.getElementById('exam-type')?.value || '';
        const date = document.getElementById('exam-date')?.value || '';
        const name = (document.getElementById('exam-name')?.value || '').trim();
        const resetPoint = document.getElementById('exam-reset-point')?.checked || false;
        const cohortId = CURRENT_COHORT_ID || '';
        const cohortMeta = CURRENT_COHORT_META || null;
        const grade = computeCohortGrade(cohortMeta, { year, term, type, name, date });
        return { year, term, type, name, date, cohortId, grade, resetPoint };
    }

    function refreshExamGradePreview() {
        const meta = getExamMetaFromUI();
        const gradeEl = document.getElementById('exam-grade-label');
        if (gradeEl) gradeEl.textContent = meta.grade || '-';
    }

    function setCurrentExamMeta() {
        const meta = getExamMetaFromUI();
        if (!meta.cohortId) return alert("è¯·å…ˆé€‰æ‹©å±Šåˆ«");
        if (!meta.year || !meta.term || !meta.type) return alert("è¯·å®Œæ•´é€‰æ‹©å­¦å¹´/å­¦æœŸ/è€ƒè¯•ç±»å‹");
        if (!meta.date) return alert("è¯·å¡«å†™è€ƒè¯•æ—¥æœŸ");
        const key = buildExamKey(meta);
        CURRENT_EXAM_ID = key;
        localStorage.setItem('CURRENT_EXAM_ID', key);
        localStorage.setItem('ARCHIVE_META', JSON.stringify(meta));
        if (COHORT_DB) COHORT_DB.currentExamId = key;
        applyModeByGrade(meta.grade);
        applyExamMetaUI();
        CohortDB.renderExamList();
        if(window.UI) UI.toast(`âœ… å½“å‰è€ƒè¯•å·²è®¾ç½®: ${key}`, 'success');
    }

    function applyExamMetaUI() {
        const metaStr = localStorage.getItem('ARCHIVE_META');
        let meta = null;
        if (metaStr) {
            try {
                meta = JSON.parse(metaStr);
                const yearEl = document.getElementById('exam-year');
                const termEl = document.getElementById('exam-term');
                const typeEl = document.getElementById('exam-type');
                const dateEl = document.getElementById('exam-date');
                const nameEl = document.getElementById('exam-name');
                const resetEl = document.getElementById('exam-reset-point');
                if (yearEl && meta.year) yearEl.value = meta.year;
                if (termEl && meta.term) termEl.value = meta.term;
                if (typeEl && meta.type) typeEl.value = meta.type;
                if (dateEl && meta.date) dateEl.value = meta.date;
                if (nameEl && meta.name) nameEl.value = meta.name;
                if (resetEl) resetEl.checked = !!meta.resetPoint;
                if (CURRENT_COHORT_META) {
                    const recalculated = computeCohortGrade(CURRENT_COHORT_META, meta);
                    if (recalculated && meta.grade !== recalculated) {
                        meta.grade = recalculated;
                        localStorage.setItem('ARCHIVE_META', JSON.stringify(meta));
                    }
                }
            } catch(e) {}
        }
        const key = localStorage.getItem('CURRENT_EXAM_ID') || 'æœªè®¾ç½®';
        const keyEl = document.getElementById('exam-key-display');
        if (keyEl) keyEl.textContent = key;
        const gradeEl = document.getElementById('exam-grade-label');
        if (gradeEl) gradeEl.textContent = meta ? (meta.grade || '-') : '-';
        const cohortLabel = document.getElementById('exam-cohort-label');
        if (cohortLabel) {
            if (CURRENT_COHORT_META) cohortLabel.textContent = formatCohortLabel(CURRENT_COHORT_META);
            else if (meta && meta.cohortId) cohortLabel.textContent = `${meta.cohortId}çº§`;
            else cohortLabel.textContent = 'æœªé€‰æ‹©';
        }
        if (CURRENT_COHORT_META?.year) refreshExamYearOptions(CURRENT_COHORT_META.year);
        const statusEl = document.getElementById('exam-archive-status');
        if (statusEl) statusEl.textContent = isArchiveLocked() ? 'å·²å°å­˜(åªè¯»)' : 'æœªå°å­˜';
        refreshExamGradePreview();
        updateIndicatorUIState();
    }

    function isArchiveLocked() {
        const locked = localStorage.getItem('ARCHIVE_LOCKED') === 'true';
        const lockedKey = localStorage.getItem('ARCHIVE_LOCKED_KEY');
        const currentKey = localStorage.getItem('CURRENT_EXAM_ID');
        return locked && lockedKey && currentKey && lockedKey === currentKey;
    }

    async function archiveCurrentExam() {
        if (!RAW_DATA.length) return alert("å½“å‰æ— æˆç»©æ•°æ®ï¼Œæ— æ³•å°å­˜");
        if (isArchiveLocked()) return alert("å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œæ— éœ€é‡å¤æ“ä½œ");
        if (!confirm("âš ï¸ å°å­˜åå°†è¿›å…¥åªè¯»æ¨¡å¼ï¼Œé¿å…è¯¯æ”¹å†å²æ•°æ®ã€‚ç¡®å®šå°å­˜å—ï¼Ÿ")) return;

        const meta = getExamMetaFromUI();
        if (!meta.year || !meta.term || !meta.type) return alert("è¯·å…ˆè®¾ç½®å­¦å¹´/å­¦æœŸ/è€ƒè¯•ç±»å‹");
        const key = buildExamKey(meta);
        localStorage.setItem('CURRENT_EXAM_ID', key);
        localStorage.setItem('ARCHIVE_META', JSON.stringify(meta));
        if (COHORT_DB) COHORT_DB.currentExamId = key;

        // ä¿å­˜å¹¶ç”Ÿæˆå¿«ç…§
        await saveCloudData();
        createAutoSnapshot(getCurrentSnapshotPayload());

        localStorage.setItem('ARCHIVE_LOCKED', 'true');
        localStorage.setItem('ARCHIVE_LOCKED_KEY', key);
        applyExamMetaUI();
        applyArchiveLockUI();
        if(window.UI) UI.toast("âœ… å·²å°å­˜å¹¶è¿›å…¥åªè¯»æ¨¡å¼", "success");
        if(window.Logger) Logger.log('å°å­˜è€ƒè¯•', `å°å­˜è€ƒè¯• ${key}`);
    }

    function unlockArchive() {
        if (!isArchiveLocked()) return alert("å½“å‰æœªå°å­˜");
        if (!confirm("âš ï¸ è§£é™¤å°å­˜å°†å…è®¸ç¼–è¾‘å†å²æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) return;
        localStorage.setItem('ARCHIVE_LOCKED', 'false');
        localStorage.removeItem('ARCHIVE_LOCKED_KEY');
        applyExamMetaUI();
        applyArchiveLockUI();
        if(window.UI) UI.toast("âœ… å·²è§£é™¤å°å­˜", "success");
        if(window.Logger) Logger.log('è§£é™¤å°å­˜', 'è§£é™¤å°å­˜åªè¯»æ¨¡å¼');
    }

    function applyArchiveLockUI() {
        const locked = isArchiveLocked();
        const lockNotice = locked ? 'â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œåªè¯»æ¨¡å¼' : '';
        const statusEl = document.getElementById('exam-archive-status');
        if (statusEl) statusEl.textContent = locked ? 'å·²å°å­˜(åªè¯»)' : 'æœªå°å­˜';

        const uploadBox = document.getElementById('uploadBox');
        if (uploadBox) {
            uploadBox.style.pointerEvents = locked ? 'none' : 'auto';
            uploadBox.style.opacity = locked ? '0.6' : '1';
            uploadBox.title = lockNotice;
        }
        const ids = ['fileInput','teacherFileInput','projectFileInput','btn-reset-system','btn-save-project','btn-load-project'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = !!locked;
        });
    }

    // === Cohort DB & Smart Link ===
    const CohortDB = {
        ensure: function() {
            if (!COHORT_DB) {
                COHORT_DB = {
                    cohortId: CURRENT_COHORT_ID || '',
                    cohortMeta: CURRENT_COHORT_META || null,
                    students: {},
                    teachingHistory: {},
                    exams: {},
                    currentExamId: CURRENT_EXAM_ID || '',
                    resetPoints: []
                };
            }
            return COHORT_DB;
        },

        renderExamList: function() {
            const sel = document.getElementById('exam-history-select');
            if (!sel) return;
            const db = this.ensure();
            const exams = Object.values(db.exams || {});
            if (!exams.length) {
                sel.innerHTML = '<option value="">æš‚æ— å†å²è€ƒè¯•</option>';
                return;
            }
            exams.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            sel.innerHTML = exams.map(ex => `<option value="${ex.examId}">${ex.examId}</option>`).join('');
            if (db.currentExamId) sel.value = db.currentExamId;
        },

        loadExamFromSelect: function() {
            const sel = document.getElementById('exam-history-select');
            if (!sel || !sel.value) return;
            const examId = sel.value;
            const ok = this.applyExamToWorkspace(examId);
            if (ok) {
                applyExamMetaUI();
                renderTables();
                updateSchoolSelect();
                updateMySchoolSelect();
                updateStudentSchoolSelect();
                updateMarginalSchoolSelect();
                updateClassSelect();
                updateSegmentSelects();
                updateClassCompSchoolSelect();
                updatePotentialSchoolSelect();
                updateDiagnosisSelects();
                updateCorrelationSchoolSelect();
                updateSeatAdjSelects();
                updateProgressSchoolSelect();
                updateMutualAidSelects();
                updateMpSchoolSelect();
                UI.toast('âœ… å·²åˆ‡æ¢åˆ°å†å²è€ƒè¯•', 'success');
            }
        },

        syncCurrentExam: async function() {
            if (!CURRENT_COHORT_ID) return;
            if (!CURRENT_EXAM_ID) setCurrentExamMeta();
            if (!CURRENT_EXAM_ID) return;

            const meta = getExamMetaFromUI();
            const db = this.ensure();
            const examId = CURRENT_EXAM_ID;

            await this.smartLinkStudents(examId, meta);

            db.exams[examId] = {
                examId,
                meta,
                data: JSON.parse(JSON.stringify(RAW_DATA || [])),
                teacherMap: JSON.parse(JSON.stringify(TEACHER_MAP || {})),
                subjects: JSON.parse(JSON.stringify(SUBJECTS || [])),
                thresholds: JSON.parse(JSON.stringify(THRESHOLDS || {})),
                config: JSON.parse(JSON.stringify(CONFIG || {})),
                createdAt: Date.now()
            };
            db.currentExamId = examId;
            const termId = getTermId(meta);
            if (termId) {
                db.teachingHistory = db.teachingHistory || {};
                db.teachingHistory[termId] = JSON.parse(JSON.stringify(TEACHER_MAP || {}));
            }
            this.renderExamList();
            if (meta.resetPoint) {
                db.resetPoints = db.resetPoints || [];
                if (!db.resetPoints.includes(examId)) db.resetPoints.push(examId);
            }
        },

        applyExamToWorkspace: function(examId) {
            const db = this.ensure();
            const exam = db.exams?.[examId];
            if (!exam) return false;
            RAW_DATA = exam.data || [];
            SUBJECTS = exam.subjects || [];
            THRESHOLDS = exam.thresholds || {};
            CONFIG = exam.config || CONFIG;
            TEACHER_MAP = exam.teacherMap || {};
            CURRENT_EXAM_ID = examId;
            localStorage.setItem('CURRENT_EXAM_ID', examId);
            localStorage.setItem('ARCHIVE_META', JSON.stringify(exam.meta || {}));
            const termId = getTermId(exam.meta || {});
            if (termId) localStorage.setItem('CURRENT_TERM_ID', termId);
            applyModeByGrade(exam.meta?.grade);
            return true;
        },

        smartLinkStudents: async function(examId, meta) {
            const db = this.ensure();
            const roster = db.students || {};
            const nameIndex = {};

            Object.values(roster).forEach(stu => {
                if (!nameIndex[stu.name]) nameIndex[stu.name] = [];
                nameIndex[stu.name].push(stu);
            });

            const conflicts = [];

            RAW_DATA.forEach(stu => {
                const name = String(stu.name || '').trim();
                if (!name) return;
                const candidates = nameIndex[name] || [];
                if (candidates.length === 0) {
                    const uuid = this.createUUID();
                    const rec = {
                        uuid,
                        name,
                        status: 'transfer_in',
                        history: [],
                        lastScore: null,
                        lastExamId: null
                    };
                    roster[uuid] = rec;
                    stu.uuid = uuid;
                } else if (candidates.length === 1) {
                    const target = candidates[0];
                    stu.uuid = target.uuid;
                } else {
                    conflicts.push({ current: stu, candidates });
                }
            });

            if (conflicts.length) {
                await this.resolveConflicts(conflicts);
            }

            RAW_DATA.forEach(stu => {
                if (!stu.uuid) return;
                const rec = roster[stu.uuid];
                if (!rec) return;
                rec.name = stu.name;
                rec.lastScore = typeof stu.total === 'number' ? stu.total : null;
                rec.lastExamId = examId;
                rec.history = rec.history || [];
                rec.history.push({ examId, class: stu.class, school: stu.school, total: stu.total });
            });

            db.students = roster;
        },

        resolveConflicts: async function(conflicts) {
            const db = this.ensure();
            for (const item of conflicts) {
                const current = item.current;
                const candidates = item.candidates || [];
                const options = {};
                const currentScore = current.total || 0;
                const sorted = candidates.slice().sort((a, b) => {
                    const da = Math.abs((a.lastScore ?? 0) - currentScore);
                    const db = Math.abs((b.lastScore ?? 0) - currentScore);
                    return da - db;
                });

                sorted.forEach((c, idx) => {
                    const label = `åŸ${c.history?.slice(-1)[0]?.class || c.lastClass || '-'}ç­ ${c.name} (ä¸Šæ¬¡${c.lastScore ?? '-'})${idx === 0 ? ' â€”â€” ç³»ç»Ÿæ¨è' : ''}`;
                    options[c.uuid] = label;
                });
                options['NEW'] = 'ä»¥ä¸Šéƒ½ä¸æ˜¯ï¼ˆæ–°å¢è½¬å­¦ç”Ÿï¼‰';

                const result = await Swal.fire({
                    title: 'âš ï¸ æ£€æµ‹åˆ°é‡åå†²çª',
                    html: `æ‚¨ä¸Šä¼ äº† ${current.class || '-'}ç­ çš„ ${current.name} (æœ¬æ¬¡${currentScore}åˆ†)ï¼Œè¯·é€‰æ‹©å…¶å†å²èº«ä»½ï¼š`,
                    input: 'radio',
                    inputOptions: options,
                    inputValidator: value => !value ? 'è¯·é€‰æ‹©ä¸€ä¸ªåŒ¹é…é¡¹' : undefined,
                    confirmButtonText: 'ç¡®è®¤åŒ¹é…',
                    confirmButtonColor: '#4f46e5',
                    showCancelButton: true,
                    cancelButtonText: 'è®¾ä¸ºæ–°å¢'
                });

                const chosen = result.isConfirmed ? result.value : 'NEW';
                if (chosen === 'NEW') {
                    const uuid = this.createUUID();
                    db.students[uuid] = {
                        uuid,
                        name: current.name,
                        status: 'transfer_in',
                        history: [],
                        lastScore: null,
                        lastExamId: null
                    };
                    current.uuid = uuid;
                } else {
                    current.uuid = chosen;
                }
            }
        },

        createUUID: function() {
            return 'stu_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        }
    };

    const CohortGrowth = {
        cache: { volatility: [], growth: [] },

        render: function() {
            if (!COHORT_DB || !COHORT_DB.exams || Object.keys(COHORT_DB.exams).length === 0) {
                return alert('å½“å‰å±Šåˆ«æš‚æ— å†å²è€ƒè¯•æ•°æ®');
            }
            const result = this.compute();
            this.cache = result;
            this.renderVolatility(result.volatility);
            this.renderGrowth(result.growth);
        },

        compute: function() {
            const exams = Object.values(COHORT_DB.exams || {}).sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
            const studentSeries = {};

            exams.forEach(exam => {
                const data = exam.data || [];
                const totals = data.map(s => Number(s.total)).filter(v => !isNaN(v));
                if (!totals.length) return;
                const mean = totals.reduce((a, b) => a + b, 0) / totals.length;
                const variance = totals.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / totals.length;
                const std = Math.sqrt(variance) || 1;

                const sorted = data.slice().sort((a, b) => (b.total || 0) - (a.total || 0));
                const rankMap = new Map();
                sorted.forEach((s, idx) => {
                    const key = this.getStudentKey(s);
                    if (!rankMap.has(key)) rankMap.set(key, idx + 1);
                });

                data.forEach(s => {
                    const key = this.getStudentKey(s);
                    if (!studentSeries[key]) studentSeries[key] = { name: s.name, class: s.class, z: [], p: [] };
                    studentSeries[key].name = s.name || studentSeries[key].name;
                    studentSeries[key].class = s.class || studentSeries[key].class;
                    const z = (Number(s.total) - mean) / std;
                    const rank = rankMap.get(key) || null;
                    const p = rank && sorted.length > 1 ? (1 - (rank - 1) / (sorted.length - 1)) : 0.5;
                    studentSeries[key].z.push(z);
                    studentSeries[key].p.push(p);
                });
            });

            const volatility = [];
            const growth = [];

            Object.values(studentSeries).forEach(s => {
                if (s.z.length >= 4) {
                    const sigma = this.std(s.z);
                    volatility.push({ name: s.name, class: s.class, count: s.z.length, sigma });
                }
                if (s.p.length >= 2) {
                    const start = s.p[0];
                    const end = s.p[s.p.length - 1];
                    const delta = end - start;
                    growth.push({ name: s.name, class: s.class, start, end, delta });
                }
            });

            volatility.sort((a, b) => b.sigma - a.sigma);
            growth.sort((a, b) => b.delta - a.delta);

            return { volatility: volatility.slice(0, 50), growth: growth.slice(0, 50) };
        },

        renderVolatility: function(list) {
            const tbody = document.querySelector('#cohort-volatility-table tbody');
            if (!tbody) return;
            if (!list.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">æš‚æ— è¶³å¤Ÿæ•°æ®</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.class || '-'}</td>
                    <td>${s.count}</td>
                    <td style="font-weight:bold; color:#0ea5e9;">${s.sigma.toFixed(2)}</td>
                </tr>
            `).join('');
        },

        renderGrowth: function(list) {
            const tbody = document.querySelector('#cohort-growth-table tbody');
            if (!tbody) return;
            if (!list.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">æš‚æ— è¶³å¤Ÿæ•°æ®</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(s => {
                const delta = s.delta;
                const color = delta >= 0 ? '#16a34a' : '#dc2626';
                return `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.class || '-'}</td>
                    <td>${(s.start * 100).toFixed(1)}%</td>
                    <td>${(s.end * 100).toFixed(1)}%</td>
                    <td style="font-weight:bold; color:${color};">${(delta * 100).toFixed(1)}%</td>
                </tr>`;
            }).join('');
        },

        exportVolatility: function() {
            if (!this.cache.volatility || !this.cache.volatility.length) return alert('æš‚æ— å¯å¯¼å‡ºæ•°æ®');
            const wsData = [['å§“å', 'ç­çº§', 'è€ƒè¯•æ¬¡æ•°', 'æ³¢åŠ¨ç‡(Ïƒ)']];
            this.cache.volatility.forEach(s => wsData.push([s.name, s.class || '-', s.count, Number(s.sigma.toFixed(3))]));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Z-Scoreæ³¢åŠ¨ç‡');
            XLSX.writeFile(wb, `çºµå‘æˆé•¿æ¡£æ¡ˆ_æ³¢åŠ¨ç‡_${CURRENT_COHORT_ID || 'cohort'}.xlsx`);
        },

        std: function(arr) {
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
            return Math.sqrt(variance);
        },

        getStudentKey: function(s) {
            return s.uuid || `${s.name || ''}|${s.class || ''}|${s.school || ''}`;
        }
    };

    // === è‡ªåŠ¨å¿«ç…§/å›æ»š ===
    function getCurrentSnapshotPayload() {
        return {
            COHORT_DB: window.COHORT_DB || null,
            CURRENT_COHORT_ID: window.CURRENT_COHORT_ID || '',
            CURRENT_COHORT_META: window.CURRENT_COHORT_META || null,
            CURRENT_EXAM_ID: window.CURRENT_EXAM_ID || '',
            CURRENT_TERM_ID: localStorage.getItem('CURRENT_TERM_ID') || '',
            ARCHIVE_META: (() => {
                try { return JSON.parse(localStorage.getItem('ARCHIVE_META') || 'null'); } catch(e) { return null; }
            })(),
            RAW_DATA: window.RAW_DATA || [],
            SCHOOLS: window.SCHOOLS || {},
            SUBJECTS: window.SUBJECTS || [],
            THRESHOLDS: window.THRESHOLDS || {},
            TEACHER_MAP: window.TEACHER_MAP || {},
            CONFIG: window.CONFIG || {},
            MY_SCHOOL: window.MY_SCHOOL || "",
            TARGETS: window.SYS_VARS?.targets || window.TARGETS || {},
            INDICATOR_PARAMS: window.SYS_VARS?.indicator || { ind1: '', ind2: '' },
            PREV_DATA: window.PREV_DATA || [],
            TEACHER_STATS: window.TEACHER_STATS || {},
            HISTORY_ARCHIVE: window.HISTORY_ARCHIVE || {},
            FB_CLASSES: window.FB_CLASSES || [],
            MP_SNAPSHOTS: window.MP_SNAPSHOTS || {},
            timestamp: new Date().getTime()
        };
    }

    function createAutoSnapshot(payload) {
        try {
            if (!payload) return;
            const list = JSON.parse(localStorage.getItem('AUTO_SNAPSHOTS') || '[]');
            const item = {
                ts: Date.now(),
                key: localStorage.getItem('CURRENT_PROJECT_KEY') || 'autosave_backup',
                data: "LZ|" + LZString.compressToUTF16(JSON.stringify(payload))
            };
            list.unshift(item);
            const trimmed = list.slice(0, 5);
            localStorage.setItem('AUTO_SNAPSHOTS', JSON.stringify(trimmed));
            renderAutoSnapshotsUI();
        } catch(e) {
            console.warn('è‡ªåŠ¨å¿«ç…§å¤±è´¥:', e);
        }
    }

    function renderAutoSnapshotsUI() {
        const container = document.getElementById('auto-snapshot-list');
        if (!container) return;
        const list = JSON.parse(localStorage.getItem('AUTO_SNAPSHOTS') || '[]');
        if (list.length === 0) {
            container.innerHTML = 'æš‚æ— å¿«ç…§';
            return;
        }
        container.innerHTML = list.map((item, idx) => {
            const time = new Date(item.ts).toLocaleString();
            return `<div style="display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px dashed #fed7aa;">
                <span>â±ï¸ ${time} <span style="color:#64748b;">(${item.key})</span></span>
                <button class="btn btn-sm btn-gray" onclick="restoreAutoSnapshot(${idx})">å›æ»š</button>
            </div>`;
        }).join('');
    }

    function restoreAutoSnapshot(index) {
        if (!confirm('ç¡®å®šå›æ»šåˆ°è¯¥å¿«ç…§å—ï¼Ÿå½“å‰æœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) return;
        const list = JSON.parse(localStorage.getItem('AUTO_SNAPSHOTS') || '[]');
        const item = list[index];
        if (!item || !item.data) return;
        try {
            let dataStr = item.data;
            if (typeof dataStr === 'string' && dataStr.startsWith('LZ|')) {
                dataStr = LZString.decompressFromUTF16(dataStr.substring(3));
            }
            const db = JSON.parse(dataStr);
            applySnapshotPayload(db);
            if(window.UI) UI.toast('âœ… å·²å›æ»šåˆ°å¿«ç…§', 'success');
        } catch(e) {
            alert('å›æ»šå¤±è´¥: ' + e.message);
        }
    }

    function applySnapshotPayload(db) {
        window.COHORT_DB = db.COHORT_DB || window.COHORT_DB || null;
        window.CURRENT_COHORT_ID = db.CURRENT_COHORT_ID || window.CURRENT_COHORT_ID || '';
        window.CURRENT_COHORT_META = db.CURRENT_COHORT_META || window.CURRENT_COHORT_META || null;
        window.CURRENT_EXAM_ID = db.CURRENT_EXAM_ID || window.CURRENT_EXAM_ID || '';
        if (db.CURRENT_TERM_ID) localStorage.setItem('CURRENT_TERM_ID', db.CURRENT_TERM_ID);
        if (window.CURRENT_COHORT_ID) {
            localStorage.setItem('CURRENT_PROJECT_KEY', getCohortKey(window.CURRENT_COHORT_ID));
            localStorage.setItem('CURRENT_COHORT_ID', window.CURRENT_COHORT_ID);
        }
        if (window.CURRENT_EXAM_ID) {
            const metaStr = localStorage.getItem('ARCHIVE_META');
            try {
                const meta = metaStr ? JSON.parse(metaStr) : null;
                const termId = getTermId(meta || {});
                if (termId) localStorage.setItem('CURRENT_TERM_ID', termId);
            } catch(e) {}
        }
        window.RAW_DATA = db.RAW_DATA || [];
        window.SCHOOLS = db.SCHOOLS || {};
        window.SUBJECTS = db.SUBJECTS || [];
        window.THRESHOLDS = db.THRESHOLDS || {};
        window.TEACHER_MAP = db.TEACHER_MAP || {};
        window.CONFIG = db.CONFIG || {};
        window.MY_SCHOOL = db.MY_SCHOOL || "";
        window.TARGETS = db.TARGETS || {};
        window.SYS_VARS = window.SYS_VARS || { indicator: { ind1: '', ind2: '' }, targets: {} };
        window.SYS_VARS.targets = window.TARGETS;
        if (db.INDICATOR_PARAMS) {
            window.SYS_VARS.indicator.ind1 = db.INDICATOR_PARAMS.ind1 || '';
            window.SYS_VARS.indicator.ind2 = db.INDICATOR_PARAMS.ind2 || '';
            const dm1 = document.getElementById('dm_ind1_input');
            const dm2 = document.getElementById('dm_ind2_input');
            const main1 = document.getElementById('ind1');
            const main2 = document.getElementById('ind2');
            if(dm1) dm1.value = window.SYS_VARS.indicator.ind1;
            if(dm2) dm2.value = window.SYS_VARS.indicator.ind2;
            if(main1) main1.value = window.SYS_VARS.indicator.ind1;
            if(main2) main2.value = window.SYS_VARS.indicator.ind2;
        }
        if (db.PREV_DATA) window.PREV_DATA = db.PREV_DATA;
        if (db.TEACHER_STATS) window.TEACHER_STATS = db.TEACHER_STATS;
        if (db.HISTORY_ARCHIVE) window.HISTORY_ARCHIVE = db.HISTORY_ARCHIVE;
        if (db.FB_CLASSES) window.FB_CLASSES = db.FB_CLASSES;
        if (db.MP_SNAPSHOTS) window.MP_SNAPSHOTS = db.MP_SNAPSHOTS;

        if (window.COHORT_DB && window.COHORT_DB.currentExamId) {
            try { CohortDB.applyExamToWorkspace(window.COHORT_DB.currentExamId); } catch(e) {}
        }

        try { if(typeof renderTables === 'function') renderTables(); } catch(e) {}
        try { if(typeof updateSchoolSelect === 'function') updateSchoolSelect(); } catch(e) {}
        try { if (typeof renderAll === 'function') renderAll(); } catch(e) {}
        if (typeof DataManager !== 'undefined' && DataManager.renderHistoryPreview) DataManager.renderHistoryPreview();
    }
    // === é¡¹ç›®å¿«ç…§é€»è¾‘ ===
    function saveProjectSnapshot() {
        const hasData = RAW_DATA.length > 0 || Object.keys(TEACHER_MAP).length > 0;
        const hasConfig = localStorage.getItem('LLM_API_KEY') || localStorage.getItem('app_skin_config');

        if (!hasData && !hasConfig) { 
            return alert("å½“å‰ç³»ç»Ÿä¸ºç©ºï¼Œæ— éœ€å¤‡ä»½ï¼"); 
        }

        // è·å–å½“å‰ç•Œé¢ä¸Šçš„è¾“å…¥æ¡†æ•°å€¼
        const elInd1 = document.getElementById('ind1');
        const elInd2 = document.getElementById('ind2');

        const snapshot = {
            meta: { 
                version: "3.3", 
                timestamp: new Date().toISOString(), 
                desc: "å…¨é‡å¤‡ä»½(å«æŒ‡æ ‡å‚æ•°)" 
            },
            db: {
                // æ ¸å¿ƒå˜é‡
                CONFIG, MY_SCHOOL, RAW_DATA, SCHOOLS, SUBJECTS, THRESHOLDS, 
                TARGETS, // ğŸ‘ˆ ç¡®ä¿è¿™é‡ŒåŒ…å«ç›®æ ‡äººæ•°å¯¹è±¡
                TEACHER_MAP, TEACHER_STATS, TEACHER_TOWNSHIP_RANKINGS, TEACHER_STAMP_BASE64, 
                PREV_DATA, PROGRESS_CACHE, MARGINAL_STUDENTS, POTENTIAL_STUDENTS_CACHE, 
                MP_DATA_CACHE, FB_STUDENTS, FB_CLASSES, FB_SIMULATED_DATA, EXAM_DATA, 
                EXAM_ROOMS, AID_GROUPS_CACHE, HISTORY_ARCHIVE, ROLLER_COASTER_STUDENTS,
                MP_SNAPSHOTS,
                
                // ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šä¿å­˜è¾“å…¥æ¡†çš„å…·ä½“æ•°å€¼
                INDICATOR_PARAMS: {
                    ind1: elInd1 ? elInd1.value : '',
                    ind2: elInd2 ? elInd2.value : ''
                }
            },
            settings: {
                ai: {
                    key: localStorage.getItem('LLM_API_KEY'),
                    url: localStorage.getItem('LLM_BASE_URL'),
                    model: localStorage.getItem('LLM_MODEL')
                },
                skin: localStorage.getItem('app_skin_config'),
                themeDark: localStorage.getItem('theme-dark'),
                hasSeenTour: localStorage.getItem('hasSeenV3Tour')
            }
        };

        try {
            const jsonStr = JSON.stringify(snapshot);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const dateStr = new Date().toLocaleDateString().replace(/\//g, "-");
            const fileName = `å…¨ç«™å¤‡ä»½_${dateStr}.json`;

            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            UI.toast("âœ… å¤‡ä»½å·²ä¸‹è½½ (å«æŒ‡æ ‡å‚æ•°)", "success");
        } catch (e) {
            console.error(e);
            alert("å¤‡ä»½å¤±è´¥ï¼š" + e.message);
        }
    }

   function loadProjectSnapshot(input) {
       if (isArchiveLocked()) return alert("â›” å½“å‰è€ƒè¯•å·²å°å­˜ï¼Œç¦æ­¢æ¢å¤é¡¹ç›®");
        const file = input.files[0];
        if (!file) return;

        if(!confirm("âš ï¸ è­¦å‘Šï¼šå¯¼å…¥å¤‡ä»½å°†ã€è¦†ç›–ã€‘å½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®ï¼\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
            input.value = ''; return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                UI.loading(true, "æ­£åœ¨æ¢å¤å…¨ç«™æ•°æ®...");
                
                const jsonStr = e.target.result; 
                const snapshot = JSON.parse(jsonStr);

                // 1. æ ¡éªŒç‰ˆæœ¬ç»“æ„
                if (!snapshot.meta || (!snapshot.data && !snapshot.db)) { 
                    throw new Error("æ–‡ä»¶æ ¼å¼ä¸å…¼å®¹æˆ–å·²æŸå"); 
                }

                // å…¼å®¹æ—§ç‰ˆå¤‡ä»½ (æ—§ç‰ˆæ•°æ®åœ¨ .dataï¼Œæ–°ç‰ˆåœ¨ .db)
                const db = snapshot.db || snapshot.data || {};
                const settings = snapshot.settings || {};

                // 2. æ¢å¤ LocalStorage é…ç½®
                if (settings.ai) {
                    if(settings.ai.key) localStorage.setItem('LLM_API_KEY', settings.ai.key);
                    if(settings.ai.url) localStorage.setItem('LLM_BASE_URL', settings.ai.url);
                    if(settings.ai.model) localStorage.setItem('LLM_MODEL', settings.ai.model);
                }
                if (settings.skin) localStorage.setItem('app_skin_config', settings.skin);
                if (settings.themeDark) localStorage.setItem('theme-dark', settings.themeDark);
                if (settings.hasSeenTour) localStorage.setItem('hasSeenV3Tour', settings.hasSeenTour);

                // 3. æ¢å¤ IndexedDB æ•°æ® (å…³é”®æ­¥éª¤ï¼šå†™å…¥ååˆ·æ–°é¡µé¢)
                if (Object.keys(db).length > 0) {
                    /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ å…³é”®ï¼šæ¢å¤å…¨å±€å˜é‡ TARGETS (é˜²æ­¢åˆ·æ–°å‰ç‚¹å‡»æ— æ•ˆ) ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
                    window.TARGETS = db.TARGETS || {};
                    
                    await DB.save('autosave_backup', {
                        timestamp: Date.now(),
                        RAW_DATA: db.RAW_DATA || [],
                        SCHOOLS: db.SCHOOLS || {},
                        SUBJECTS: db.SUBJECTS || [],
                        THRESHOLDS: db.THRESHOLDS || {},
                        
                        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ å…³é”®ï¼šå†™å…¥ TARGETS åˆ°ç¼“å­˜ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
                        TARGETS: db.TARGETS || {}, 
                        
                        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ ğŸŸ¢ å…³é”®ï¼šå†™å…¥ æŒ‡æ ‡å‚æ•° åˆ°ç¼“å­˜ ğŸŸ¢ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
                        INDICATOR_PARAMS: db.INDICATOR_PARAMS || { ind1: '', ind2: '' },

                        TEACHER_MAP: db.TEACHER_MAP || {},
                        TEACHER_STATS: db.TEACHER_STATS || {},
                        FB_CLASSES: db.FB_CLASSES || [],
                        CONFIG: db.CONFIG || {},
                        MY_SCHOOL: db.MY_SCHOOL || "",
                        // å…¶ä»–å­—æ®µ...
                        TEACHER_TOWNSHIP_RANKINGS: db.TEACHER_TOWNSHIP_RANKINGS || {},
                        PREV_DATA: db.PREV_DATA || [],
                        PROGRESS_CACHE: db.PROGRESS_CACHE || [],
                        MARGINAL_STUDENTS: db.MARGINAL_STUDENTS || {},
                        POTENTIAL_STUDENTS_CACHE: db.POTENTIAL_STUDENTS_CACHE || [],
                        FB_STUDENTS: db.FB_STUDENTS || [],
                        FB_SIMULATED_DATA: db.FB_SIMULATED_DATA || {},
                        EXAM_DATA: db.EXAM_DATA || [],
                        EXAM_ROOMS: db.EXAM_ROOMS || [],
                        AID_GROUPS_CACHE: db.AID_GROUPS_CACHE || [],
                        HISTORY_ARCHIVE: db.HISTORY_ARCHIVE || {},
                        ROLLER_COASTER_STUDENTS: db.ROLLER_COASTER_STUDENTS || []
                    });
                    
                    // æ¢å¤ä¸´ç•Œç”Ÿå¿«ç…§åˆ° LocalStorage
                    if(db.MP_SNAPSHOTS) {
                        localStorage.setItem('MP_SNAPSHOTS', JSON.stringify(db.MP_SNAPSHOTS));
                    }
                }

                // æ ‡è®°å¼ºåˆ¶æ¢å¤
                localStorage.setItem('SYS_FORCE_RESTORE', 'true');

                UI.loading(false);
                
                // 4. æˆåŠŸæç¤ºå¹¶åˆ·æ–°
                Swal.fire({
                    title: 'æ¢å¤æˆåŠŸ',
                    text: 'æ•°æ®å·²å¯¼å…¥ï¼Œç³»ç»Ÿå³å°†é‡å¯ä»¥åº”ç”¨æ›´æ”¹...',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    location.reload(); 
                });

            } catch (err) { 
                UI.loading(false);
                console.error(err); 
                alert("âŒ æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶å¯èƒ½æŸåã€‚\nDEBUG: " + err.message); 
            }
        }; 
        reader.readAsText(file);
    }

    function openTargetEditor() {
        if (Object.keys(SCHOOLS).length === 0) return alert("è¯·å…ˆä¸Šä¼ æˆç»©æ•°æ®ï¼Œç³»ç»Ÿéœ€è¦è¯»å–å­¦æ ¡åˆ—è¡¨ã€‚");
        
        const tbody = document.querySelector('#target-editor-table tbody');
        tbody.innerHTML = '';

        // éå†æ‰€æœ‰å­¦æ ¡ï¼Œç”Ÿæˆè¾“å…¥æ¡†
        Object.keys(SCHOOLS).forEach(sch => {
            // è·å–ç°æœ‰ç›®æ ‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º 0
            const t = TARGETS[sch] || { t1: 0, t2: 0 };
            
            tbody.innerHTML += `
                <tr data-school="${sch}">
                    <td style="font-weight:bold;">${sch}</td>
                    <td>
                        <input type="number" class="inp-t1" value="${t.t1}" style="width:80px; text-align:center; border:1px solid #93c5fd;">
                    </td>
                    <td>
                        <input type="number" class="inp-t2" value="${t.t2}" style="width:80px; text-align:center; border:1px solid #fdba74;">
                    </td>
                </tr>
            `;
        });

        document.getElementById('target-editor-modal').style.display = 'flex';
    }

    function saveTargetEditor() {
        const rows = document.querySelectorAll('#target-editor-table tbody tr');
        let updateCount = 0;

        rows.forEach(tr => {
            const sch = tr.dataset.school;
            const t1 = parseInt(tr.querySelector('.inp-t1').value) || 0;
            const t2 = parseInt(tr.querySelector('.inp-t2').value) || 0;

            TARGETS[sch] = { t1: t1, t2: t2 };
            updateCount++;
        });

        document.getElementById('target-editor-modal').style.display = 'none';
        
        UI.toast(`âœ… å·²æ›´æ–° ${updateCount} æ‰€å­¦æ ¡çš„ç›®æ ‡è®¾å®š`, "success");
        
        // è‡ªåŠ¨è§¦å‘ä¸€æ¬¡è®¡ç®—ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å˜åŒ–
        if(document.getElementById('ind1').value && document.getElementById('ind2').value) {
            calcIndicators();
        } else {
            alert("ç›®æ ‡å·²ä¿å­˜ï¼\nè¯·è®°å¾—åœ¨ä¸Šæ–¹è¾“å…¥æ¡†è®¾ç½®ã€åˆ’çº¿åæ¬¡ã€‘ï¼Œç„¶åç‚¹å‡»ã€å¼€å§‹è®¡ç®—ã€‘ã€‚");
        }
    }

    // === å…¨å±€æœç´¢ (Spotlight) é€»è¾‘ ===
    // å¿«æ·é”®ç»‘å®š
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            openSpotlight();
        }
                // 1. å…¨å±€ ESC å…³é—­é€»è¾‘ (Portal æ€æƒ³)
        if (e.key === 'Escape') {
            // å…³é—­ Spotlight
            closeSpotlight();
            
            // å…³é—­æ‰€æœ‰æ˜¾ç¤ºçš„ Modal (æŒ‰ z-index å€’åºå…³é—­æœ€ä¸Šå±‚çš„)
            const modals = Array.from(document.querySelectorAll('.modal'))
                .filter(m => m.style.display !== 'none' && m.style.display !== '')
                .sort((a, b) => {
                    const zA = parseInt(window.getComputedStyle(a).zIndex) || 0;
                    const zB = parseInt(window.getComputedStyle(b).zIndex) || 0;
                    return zB - zA;
                });
            
            if (modals.length > 0) {
                modals[0].style.display = 'none'; // åªå…³é—­æœ€ä¸Šå±‚çš„ä¸€ä¸ª
                e.preventDefault(); // é˜»æ­¢å…¶ä»–é»˜è®¤è¡Œä¸º
                return;
            }
        }

        // 2. Spotlight é”®ç›˜å¯¼èˆª (ArrowUp / ArrowDown / Enter)
        const spotlightBox = document.getElementById('spotlight-mask');
        if (spotlightBox && spotlightBox.style.display === 'flex') {
            const resultsDiv = document.getElementById('spotlight-results');
            const items = resultsDiv.querySelectorAll('.spotlight-item');
            if (items.length === 0) return;

            // è·å–å½“å‰é€‰ä¸­é¡¹ç´¢å¼•
            let activeIdx = Array.from(items).findIndex(el => el.classList.contains('active'));

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIdx = (activeIdx + 1) % items.length;
                updateSpotlightSelection(items, activeIdx);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIdx = (activeIdx - 1 + items.length) % items.length;
                updateSpotlightSelection(items, activeIdx);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeIdx >= 0 && items[activeIdx]) {
                    items[activeIdx].click(); // è§¦å‘ç‚¹å‡»è·³è½¬
                }
            }
        }
    });

    // è¾…åŠ©ï¼šæ›´æ–° Spotlight é€‰ä¸­æ ·å¼
    function updateSpotlightSelection(items, index) {
        items.forEach(el => el.classList.remove('active'));
        if (items[index]) {
            items[index].classList.add('active');
            items[index].scrollIntoView({ block: 'nearest' }); // ç¡®ä¿å¯è§
            // æ ·å¼è¡¥ä¸ï¼šç¡®ä¿ .active æœ‰é«˜äº® (é…åˆ CSS)
            items[index].style.backgroundColor = 'var(--primary-light)';
        }
    }

    function openSpotlight() {
        document.getElementById('spotlight-mask').style.display = 'flex';
        document.getElementById('spotlight-input').focus();
    }
    function closeSpotlight() {
        document.getElementById('spotlight-mask').style.display = 'none';
    }

    let fuseInstance = null;

    function initFuse() {
        if (!window.Fuse || RAW_DATA.length === 0) return;
        
        // é…ç½® Fuse é€‰é¡¹
        const options = {
            keys: ['name', 'id', 'class', 'school'], // æœç´¢å­—æ®µ
            threshold: 0.3, // æ¨¡ç³Šé˜ˆå€¼ï¼š0.0å®Œå…¨åŒ¹é…ï¼Œ1.0åŒ¹é…ä»»ä½•ã€‚0.3é€‚åˆäººåå®¹é”™
            distance: 100,
            ignoreLocation: true, // å¿½ç•¥ä½ç½®ï¼Œåªè¦åŒ…å«å°±è¡Œ
            minMatchCharLength: 2
        };
        fuseInstance = new Fuse(RAW_DATA, options);
    }

    function doSpotlightSearch() {
        const val = document.getElementById('spotlight-input').value.trim();
        const resDiv = document.getElementById('spotlight-results');
        resDiv.innerHTML = '';
        if(!val) return;

        // 1. æœåŠŸèƒ½æ¨¡å— (ä¿æŒåŸæœ‰é€»è¾‘ï¼Œç®€å•åŒ…å«åŒ¹é…å³å¯)
        const modules = [
            {name: "æ–°ç”Ÿåˆ†ç­", id: "freshman-simulator"}, 
            {name: "è€ƒåœºç¼–æ’", id: "exam-arranger"},
            {name: "åº§ä½å¾®è°ƒ", id: "seat-adjustment"}, 
            {name: "æ•™å¸ˆåˆ†æ", id: "teacher-analysis"},
            {name: "è¿›é€€æ­¥è¿½è¸ª", id: "progress-analysis"}, 
            {name: "ä¸¤ç‡ä¸€åˆ†(å®è§‚)", id: "analysis"},
            {name: "ä¸´ç•Œç”Ÿä»»åŠ¡å•", id: "marginal-push"},
            {name: "å­¦ç”Ÿæˆç»©å•", id: "report-generator"}
        ];
        
        modules.forEach(m => {
            if(m.name.includes(val)) {
                resDiv.innerHTML += `
                    <div class="spotlight-item" onclick="switchTab('${m.id}');closeSpotlight()">
                        <span>ğŸ› ï¸ åŠŸèƒ½ï¼š${m.name}</span>
                        <span style="font-size:10px;color:#999">è·³è½¬</span>
                    </div>`;
            }
        });

        // 2. æœå­¦ç”Ÿ (ä½¿ç”¨ Fuse.js æ¨¡ç³Šæœç´¢)
        let matches = [];
        
        // å¦‚æœ Fuse è¿˜æ²¡åˆå§‹åŒ–æˆ–è€…æ•°æ®æ›´æ–°äº†ï¼Œé‡æ–°åˆå§‹åŒ–
        if (!fuseInstance && RAW_DATA.length > 0) initFuse();

        if (fuseInstance) {
            // ä½¿ç”¨ Fuse æœç´¢
            const results = fuseInstance.search(val);
            // Fuse è¿”å›æ ¼å¼æ˜¯ [{item: ...}, ...]
            matches = results.map(r => r.item).slice(0, 8); // å–å‰8ä¸ª
        } else {
            // é™çº§æ–¹æ¡ˆï¼šåŸæœ‰ç®€å•æœç´¢
            matches = RAW_DATA.filter(s => s.name.includes(val) || String(s.id).includes(val)).slice(0, 5);
        }

        if (matches.length === 0) {
             resDiv.innerHTML += `<div style="padding:10px; text-align:center; color:#999;">æ— åŒ¹é…ç»“æœ</div>`;
        } else {
            matches.forEach(s => {
                // é«˜äº®åŒ¹é…æ–‡å­—é€»è¾‘ç•¥å¤æ‚ï¼Œè¿™é‡Œç›´æ¥æ˜¾ç¤ºç»“æœ
                resDiv.innerHTML += `
                    <div class="spotlight-item" onclick="jumpToStudent('${s.name}', '${s.school}', '${s.class}')">
                        <span>ğŸ‘¤ ${s.name} <small style="color:#666">(${s.school} ${s.class})</small></span>
                        <span style="font-weight:bold;">${s.total}åˆ†</span>
                    </div>`;
            });
        }
    }
    const SYSTEM_MANUAL = {
        'upload': {
            title: 'ğŸ“ æ•°æ®ä¸Šä¼ ä¸è®¾ç½®Â·ä½¿ç”¨è¯´æ˜',
            fit: `ç”¨äº<strong>å¯¼å…¥å¹¶è§„èŒƒåŒ–æˆç»©æ•°æ®</strong>ï¼Œä¸ºåç»­æ‰€æœ‰åˆ†ææä¾›å¯é æ•°æ®åŸºç¡€ã€‚`,
            when: `æ¯æ¬¡è€ƒè¯•ç»“æŸåã€é¦–æ¬¡ä½¿ç”¨æˆ–æ›´æ¢æ•°æ®æ¥æºæ—¶ä½¿ç”¨ã€‚`,
            use: `<ul>
                    <li><strong>ä¸Šä¼ æ–‡ä»¶ï¼š</strong>ç‚¹å‡»è™šçº¿æ¡†ï¼Œé€‰æ‹©ä»è€ƒåŠ¡ç³»ç»Ÿå¯¼å‡ºçš„åŸå§‹Excelï¼ˆæ”¯æŒå¤šé€‰ï¼‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«â€œå§“åã€ç­çº§ã€ç§‘ç›®â€ã€‚</li>
                    <li><strong>æ•™å¸ˆé…ç½®ï¼š</strong>è‹¥è¦è¿›è¡Œâ€œæ•™å¸ˆæ•™å­¦è¯„ä»·â€ï¼Œè¯·åœ¨ä¸‹æ–¹â€œæ•™å¸ˆä¿¡æ¯é…ç½®â€å¤„ä¸Šä¼ ã€ç­çº§-å­¦ç§‘-æ•™å¸ˆã€‘å¯¹åº”è¡¨ã€‚</li>
                    <li><strong>è¿›é€€æ­¥åŸºå‡†ï¼š</strong>è‹¥è¦åˆ†æè¿›é€€æ­¥ï¼Œè¯·åœ¨â€œå†å²æˆç»©æ¡£æ¡ˆåº“â€ä¸Šä¼ ä¸Šæ¬¡è€ƒè¯•çš„æˆç»©æ–‡ä»¶ã€‚</li>
                  </ul>`,
            calc: `ç³»ç»Ÿè‡ªåŠ¨æ¸…æ´—æ•°æ®ï¼Œç¼ºè€ƒ/ä½œå¼Šè®°ä¸º0åˆ†ã€‚`
        },
        'macro': {
            title: 'ğŸ† é•‡åŸŸå®è§‚æ¨ªå‘è¯„ä»·Â·ç®—æ³•è¯´æ˜',
            fit: `ç”¨äº<strong>æ ¡é™…æ¨ªå‘å¯¹æ¯”</strong>ä¸é•‡åŸŸæ•´ä½“æ°´å¹³ç ”åˆ¤ã€‚`,
            when: `éœ€è¦å¯¹å„æ ¡è¿›è¡Œæ•´ä½“æ’åã€é˜¶æ®µæ€§è´¨é‡å¯¹æ¯”æˆ–è¿æ£€ææ–™æ±‡æ€»æ—¶ä½¿ç”¨ã€‚`,
            use: `ç”¨äºæ•™è‚²ç»„/æ•™ç ”å®¤æŸ¥çœ‹å…¨é•‡å„æ ¡æ’åã€‚ç‚¹å‡»â€œç”Ÿæˆæ¨ªå‘å¯¹æ¯”è¡¨â€å¯æŸ¥çœ‹è¯¦ç»†æ•°æ®ã€‚`,
            calc: `<strong>æ ¸å¿ƒå…¬å¼ï¼šä¸¤ç‡ä¸€åˆ†æ€»åˆ† = (å‡åˆ†èµ‹åˆ† + ä¼˜ç‡èµ‹åˆ† + åŠæ ¼èµ‹åˆ†)</strong>
                   <div class="formula-box">
                   å‡åˆ†èµ‹åˆ† = (æœ¬æ ¡å‡åˆ† Ã· å…¨é•‡æœ€é«˜å‡åˆ†) Ã— æƒé‡(60/40)<br>
                   ä¼˜ç‡èµ‹åˆ† = (æœ¬æ ¡ä¼˜ç‡ Ã· å…¨é•‡æœ€é«˜ä¼˜ç‡) Ã— æƒé‡(70/80)<br>
                   åŠæ ¼èµ‹åˆ† = (æœ¬æ ¡åŠæ ¼ Ã· å…¨é•‡æœ€é«˜åŠæ ¼) Ã— æƒé‡(70/40)
                   </div>
                   * 6-8å¹´çº§æƒé‡ï¼š60/70/70ï¼›9å¹´çº§æƒé‡ï¼š40/80/40ã€‚`
        },
        'high-score': {
            title: 'ğŸŒŸ 9å¹´çº§é«˜åˆ†æ®µæ ¸ç®—Â·ç®—æ³•è¯´æ˜',
            fit: `ç”¨äº<strong>å°–å­ç”ŸåŸ¹å…»</strong>ä¸æ‹”å°–äººæ‰ç›‘æµ‹ã€‚`,
            when: `ä¸­è€ƒå¤‡è€ƒé˜¶æ®µæˆ–é‡ç‚¹å…³æ³¨æ‹”å°–å­¦ç”Ÿç»“æ„æ—¶ä½¿ç”¨ã€‚`,
            use: `ä»…é’ˆå¯¹ 9 å¹´çº§ä¸­è€ƒå¤‡è€ƒã€‚ç»Ÿè®¡æ€»åˆ† â‰¥ 490åˆ† (å¯é…ç½®) çš„å°–å­ç”Ÿæƒ…å†µã€‚`,
            calc: `<div class="formula-box">å¾—åˆ† = (æœ¬æ ¡é«˜åˆ†ç‡ Ã· å…¨é•‡æœ€é«˜é«˜åˆ†ç‡) Ã— 70</div>
                   æ—¨åœ¨é¼“åŠ±å­¦æ ¡åŸ¹å…»æ‹”å°–äººæ‰ã€‚`
        },
        'value-added': {
            title: 'ğŸ“ˆ å¢å€¼æ€§è¯„ä»·Â·ç®—æ³•è¯´æ˜',
            fit: `ç”¨äº<strong>è¡¡é‡çœŸå®æ•™å­¦å¢å€¼</strong>ï¼Œé¿å…ä»…çœ‹å…¥å£ç”Ÿæºã€‚`,
            when: `æœ‰ä¸Šæ¬¡æˆç»©å¯å¯¹æ¯”ã€éœ€è¦è¯„ä»·æ•™å­¦è´¡çŒ®ä¸è¿›æ­¥ç©ºé—´æ—¶ä½¿ç”¨ã€‚`,
            use: `è§£å†³â€œç”Ÿæºå·®â€å­¦æ ¡çš„è¯„ä»·ä¸å…¬é—®é¢˜ã€‚éœ€å…ˆåœ¨ã€è¿›é€€æ­¥è¿½è¸ªã€‘æ¨¡å—ä¸Šä¼ â€œä¸Šæ¬¡æˆç»©â€ã€‚`,
            calc: `<div class="formula-box">å¹³å‡å¢å€¼ = (å…¥å£å¹³å‡æ’å - å‡ºå£å¹³å‡æ’å)</div>
                   æ­£æ•°ä»£è¡¨è¿›æ­¥ï¼Œè´Ÿæ•°ä»£è¡¨é€€æ­¥ã€‚ä¾‹å¦‚ï¼šæŸæ ¡å…¥å£å‡å500ï¼Œå‡ºå£å‡å450ï¼Œå¢å€¼ = +50 (å¤§è¿›æ­¥)ã€‚`
        },
        'bottom3': {
            title: 'ğŸ“‰ å1/3å­¦ç”Ÿæ ¸ç®—Â·è§„åˆ™è¯´æ˜',
            fit: `ç”¨äº<strong>ä½åˆ†ç‡ç›‘æ§</strong>ä¸åè¿›ç”Ÿè½¬åŒ–è·Ÿè¸ªã€‚`,
            when: `éœ€è¦è¯†åˆ«è–„å¼±å­¦æ ¡æˆ–ç­çº§ã€åˆ¶å®šæ‰¶å¼±è®¡åˆ’æ—¶ä½¿ç”¨ã€‚`,
            use: `å…³æ³¨â€œåè¿›ç”Ÿâ€è½¬åŒ–æƒ…å†µï¼Œé˜²æ­¢ä½åˆ†ç‡è¿‡é«˜ã€‚`,
            calc: `1. æ‰¾å‡ºå…¨æ ¡æ€»åˆ†å 1/3 çš„å­¦ç”Ÿã€‚<br>
                   2. å‰”é™¤å…¶ä¸­æœ€ä½åˆ†çš„ <strong>5% (æˆ–6%)</strong> (ä¸è®¡å…¥è€ƒæ ¸ï¼Œè§†ä¸ºç‰¹å›°ç”Ÿ)ã€‚<br>
                   3. è®¡ç®—å‰©ä½™åè¿›ç”Ÿçš„å¹³å‡åˆ†ä½œä¸ºè€ƒæ ¸ä¾æ®ã€‚`
        },
        'indicator': {
            title: 'ğŸ¯ æŒ‡æ ‡ç”Ÿè¾¾æ ‡æ ¸ç®—Â·ç®—æ³•è¯´æ˜',
            fit: `ç”¨äº<strong>ç›®æ ‡å®Œæˆåº¦</strong>ä¸æŒ‡æ ‡ç”Ÿè¾¾æ ‡è€ƒæ ¸ã€‚`,
            when: `æœ‰æ˜ç¡®æŒ‡æ ‡ç”Ÿä»»åŠ¡æ•°ï¼Œéœ€è€ƒæ ¸å®Œæˆåº¦æ—¶ä½¿ç”¨ã€‚`,
            use: `ç‚¹å‡»è“è‰²æŒ‰é’®â€œåœ¨çº¿è°ƒæ•´ç›®æ ‡â€è®¾å®šå„æ ¡ä»»åŠ¡æ•°ã€‚`,
            calc: `<div class="formula-box">
                   å¾—åˆ† = åŸºç¡€åˆ†(æ»¡åˆ†30) + é™„åŠ åˆ†<br>
                   åŸºç¡€åˆ† = (å®é™…è¾¾æ ‡ Ã· ç›®æ ‡äººæ•°) Ã— 30 (å°é¡¶30)<br>
                   é™„åŠ åˆ† = (è¶…é¢äººæ•° Ã· å…¨é•‡æœ€å¤§è¶…é¢æ•°) Ã— 5
                   </div>`
        },
        'summary': {
            title: 'ğŸ“‘ ç»¼åˆåˆ†ææŠ¥å‘ŠÂ·è®¡ç®—æ–¹å¼',
            fit: `ç”¨äº<strong>æ±‡æ€»å…¨æ¨¡å—æˆç»©</strong>å½¢æˆæ€»æ’åæŠ¥å‘Šã€‚`,
            when: `éœ€è¦ä¸€é”®å‡ºå…·ç»¼åˆæ±‡æŠ¥æˆ–å‘ä¸Šçº§æ±‡æŠ¥æ—¶ä½¿ç”¨ã€‚`,
            use: `ç‚¹å‡»â€œç”Ÿæˆæ€»æ’åâ€æ±‡æ€»æ‰€æœ‰æ¨¡å—å¾—åˆ†ã€‚`,
            calc: `<div class="formula-box">æ€»æ¦œå¾—åˆ† = ä¸¤ç‡ä¸€åˆ†å¾—åˆ† + å1/3å¾—åˆ† + æŒ‡æ ‡ç”Ÿå¾—åˆ† + (é«˜åˆ†æ®µå¾—åˆ†)</div>`
        },
        'teacher': {
            title: 'ğŸ‘©â€ğŸ« æ•™å¸ˆæ•™å­¦è´¨é‡ç”»åƒÂ·è¯„ä»·æ¨¡å‹',
            fit: `ç”¨äº<strong>æ•™å¸ˆæ•™å­¦æˆæ•ˆ</strong>ä¸ç­çº§è´¡çŒ®åº¦åˆ†æã€‚`,
            when: `å®Œæˆæ•™å¸ˆä»»è¯¾é…ç½®åï¼Œè¿›è¡Œæ ¡å†…ç»©æ•ˆè¯„ä¼°æ—¶ä½¿ç”¨ã€‚`,
            use: `æŸ¥çœ‹æ¯ä½è€å¸ˆçš„å®ç»©ã€‚éœ€å…ˆåœ¨æ•°æ®ä¸­å¿ƒé…ç½®ã€æ•™å¸ˆä»»è¯¾ã€‘ã€‚`,
            calc: `<strong>ç»¼åˆç»©æ•ˆåˆ† (é»˜è®¤æ¨¡å‹)ï¼š</strong><br>
                   <div class="formula-box">30(åŸºå‡†) + è´¡çŒ®å€¼ + ä¼˜ç‡åˆ† + åŠæ ¼åˆ† - ä½åˆ†æƒ©ç½š</div>
                   å…¶ä¸­â€œè´¡çŒ®å€¼â€ = ç­çº§å‡åˆ† - å¹´çº§å‡åˆ†ã€‚`
        },
        'sse': {
            title: 'âš–ï¸ æ ¡å†…ç»©æ•ˆå…¬å¹³è€ƒæ ¸Â·ç®—æ³•è¯´æ˜',
            fit: `ç”¨äº<strong>æ ¡å†…å…¬å¹³è€ƒæ ¸</strong>ä¸ç­çº§å·¥ä½œé‡è¡¥å¿ã€‚`,
            when: `éœ€è¦å…¼é¡¾åœ¨ç±äººæ•°ä¸å®è€ƒäººæ•°å·®å¼‚çš„ç»©æ•ˆè¯„ä»·æ—¶ä½¿ç”¨ã€‚`,
            use: `æ ¡é•¿å®¤ä¸“ç”¨ã€‚ç”¨äºè®¡ç®—ç­çº§æ´¥è´´ï¼Œè§£å†³ç”Ÿæºä¸å‡é—®é¢˜ã€‚`,
            calc: `<strong>æ ¸å¿ƒç†å¿µï¼šä¸è®©è€å®äººåƒäº</strong><br>
                   1. <strong>å®è€ƒ vs åœ¨ç±</strong>ï¼šåœ¨ç±äººæ•°ç®—å¤§ç­è¡¥è´´ï¼Œå®è€ƒäººæ•°ç®—å¹³å‡åˆ†ã€‚<br>
                   2. <strong>å¤§ç­è¡¥å¿</strong>ï¼šæ¯å¤šäºå¹´çº§å¹³å‡äººæ•°1äººï¼ŒåŠ 0.1åˆ†ã€‚<br>
                   3. <strong>ç”Ÿæºå¢å€¼</strong>ï¼šæ ¹æ®å­¦ç”Ÿæ’åè¿›æ­¥æƒ…å†µåŠ åˆ†ã€‚`
        },
        'class-comp': {
            title: 'ğŸ« ç­çº§æ¨ªå‘å¯¹æ¯”Â·è¯´æ˜',
            fit: `ç”¨äº<strong>ç­çº§é—´æ¨ªå‘å¯¹æ¯”</strong>ä¸å­¦ç§‘å·®è·å®šä½ã€‚`,
            when: `éœ€è¦è¯†åˆ«å¼ºå¼±ç­çº§ã€å®‰æ’åˆ†å±‚æ•™å­¦æˆ–é‡ç‚¹å¸®æ‰¶æ—¶ä½¿ç”¨ã€‚`,
            use: `æ¨ªå‘æ¯”è¾ƒå„ç­å„ç§‘å®åŠ›ã€‚å…¨æ™¯çŸ©é˜µä¸­ï¼Œç»¿è‰²ä»£è¡¨å‰3åï¼Œçº¢è‰²ä»£è¡¨å3åã€‚`,
            calc: `<strong>ç»¼åˆæ’åï¼š</strong> å„ç§‘æ ¡å†…æ’åçš„å¹³å‡å€¼ã€‚<br>
                   * æ³¨ï¼š9å¹´çº§æ¨¡å¼ä¸‹ï¼Œ"ç»¼åˆ"åˆ—ä¸è®¡å…¥æ”¿æ²»ç§‘ç›®ï¼Œä½†è¡¨æ ¼ä¸­ä»ä¼šåˆ—å‡ºã€‚`
        },
        'student-diag': {
            title: 'ğŸ” å­¦æƒ…æ·±åº¦è¯Šæ–­Â·åŸç†è¯´æ˜',
            fit: `ç”¨äº<strong>ä¸ªäººå±‚é¢è¯Šæ–­</strong>ä¸ç²¾å‡†æåˆ†ã€‚`,
            when: `æœŸä¸­/æœŸæœ«åéœ€è¦åˆ¶å®šä¸ªæ€§åŒ–æå‡æ–¹æ¡ˆæ—¶ä½¿ç”¨ã€‚`,
            use: `å¯»æ‰¾æåˆ†ç‚¹ã€‚`,
            calc: `<strong>1. ä¸´ç•Œç”Ÿ</strong>ï¼šè·ä¼˜ç”Ÿçº¿/åŠæ ¼çº¿å·® 5 åˆ†ä»¥å†…çš„å­¦ç”Ÿã€‚<br>
                   <strong>2. åç§‘æŒ–æ˜</strong>ï¼šæ€»åˆ†æ’åé å‰ï¼Œä½†å•ç§‘æ’åä¸¥é‡æ»åçš„å­¦ç”Ÿã€‚<br>
                   <strong>3. ä¼˜åŠ£åŠ¿é€è§†</strong>ï¼šåŸºäº Z-Score (æ ‡å‡†åˆ†) åˆ¤æ–­å­¦ç§‘å¼ºå¼±ã€‚`
        },
        'tools': {
            title: 'ğŸ› ï¸ æ•™åŠ¡è€ƒåŠ¡å·¥å…·Â·ç®—æ³•è¯´æ˜',
            fit: `ç”¨äº<strong>æ•™åŠ¡è€ƒåŠ¡æµç¨‹åŒ–</strong>ä¸æ—¥å¸¸å·¥ä½œé™æœ¬ã€‚`,
            when: `å¼€å­¦åˆã€è€ƒè¯•å‰åã€å®£ä¼ å±•ç¤ºæ—¶ä½¿ç”¨ã€‚`,
            use: `åŒ…å«æ–°ç”Ÿåˆ†ç­ã€è€ƒåœºç¼–æ’ã€çº¢æ¦œç”Ÿæˆã€‚`,
            calc: `<strong>åˆ†ç­ç®—æ³•</strong>ï¼šSå‹è›‡å½¢æ’åˆ— + å‡åˆ†æå·®ä¼˜åŒ– (æ¨¡æ‹Ÿé€€ç«)ã€‚<br>
                   <strong>è€ƒåœºç¼–æ’</strong>ï¼šåŒç­äº’æ–¥é€»è¾‘ (è‡ªåŠ¨æ£€æµ‹å¹¶è°ƒæ¢åŒç­ç›¸é‚»è€ƒç”Ÿ)ã€‚`
        }
    };

    function showModuleHelp(key) {
        const info = SYSTEM_MANUAL[key];
        if (!info) return;
        
        Swal.fire({
            title: info.title,
            html: `
                <div class="help-modal-content">
                    <h4>ğŸ¯ é€‚åˆå¹²ä»€ä¹ˆ</h4>
                    <div>${info.fit || info.use}</div>
                    <h4>â±ï¸ ä»€ä¹ˆæ—¶å€™ç”¨</h4>
                    <div>${info.when || 'é€‚ç”¨äºæ—¥å¸¸æ•™å­¦åˆ†æä¸é˜¶æ®µæ€§æ•™å­¦å¤ç›˜ã€‚'}</div>
                    <h4>ğŸ§® è®¡ç®—æ–¹å¼ / åº•å±‚é€»è¾‘</h4>
                    <div>${info.calc}</div>
                </div>
            `,
            width: 600,
            confirmButtonText: 'æˆ‘æ˜ç™½äº†',
            confirmButtonColor: '#4f46e5'
        });
    }
    function runDataDoctor() {
        if (!RAW_DATA.length) return alert("è¯·å…ˆä¸Šä¼ æ•°æ®ï¼ŒåŒ»ç”Ÿæ‰èƒ½è¿›è¡Œè¯Šæ–­ï¼");

        let issues = [];
        let warnings = [];
        let stats = { total: RAW_DATA.length, zeroCount: 0, highCount: 0, emptyFieldCount: 0 };

        // 1. åŸºç¡€å­—æ®µæ ¡éªŒ + æ”¶é›†é‡å¤ä¿¡æ¯
        const nameMap = {};
        RAW_DATA.forEach((s, idx) => {
            const rowNo = s.__row || (idx + 2); // é»˜è®¤ç¬¬2è¡Œå¼€å§‹æ˜¯æ•°æ®

            // å¿…å¡«å­—æ®µæ£€æŸ¥
            if (!s.school || !s.class || !s.name) {
                stats.emptyFieldCount++;
                issues.push(`ğŸ”´ <strong>å…³é”®å­—æ®µç¼ºå¤±ï¼š</strong> è¡Œ ${rowNo} å­¦æ ¡/ç­çº§/å§“åä¸ºç©º`);
                return;
            }

            const key = `${s.school}_${s.class}_${s.name}`;
            if (!nameMap[key]) nameMap[key] = [];
            nameMap[key].push(rowNo);
        });

        // 1.1 åŒç­åŒåæ£€æµ‹ (è‡´å‘½é”™è¯¯)
        Object.entries(nameMap).forEach(([key, rows]) => {
            if (rows.length > 1) {
                const [school, cls, name] = key.split('_');
                issues.push(`ğŸ”´ <strong>é‡å¤å½•å…¥/åŒåï¼š</strong> ${school} ${cls}ç­ "${name}" è¡Œå·: ${rows.join('ã€')}`);
            }
        });

        // 2. æ£€æŸ¥å¼‚å¸¸åˆ†å€¼ (é«˜åˆ†/è´Ÿåˆ†)
        // å‡è®¾å•ç§‘æ»¡åˆ†ä¸è¶…è¿‡ 150ï¼Œæ€»åˆ†æ ¹æ®ç§‘ç›®æ•°ä¼°ç®—
        RAW_DATA.forEach((s, idx) => {
            const rowNo = s.__row || (idx + 2);
            if (typeof s.total === 'number' && s.total <= 0) stats.zeroCount++;
            if (s.total !== undefined && s.total !== null && isNaN(Number(s.total))) {
                issues.push(`ğŸ”´ <strong>æ€»åˆ†éæ•°å€¼ï¼š</strong> è¡Œ ${rowNo} ${s.name || 'æœªçŸ¥å§“å'} (total = ${s.total})`);
            }
            
            SUBJECTS.forEach(sub => {
                const val = s.scores ? s.scores[sub] : undefined;
                if (val === undefined || val === null || val === '') {
                    warnings.push(`ğŸŸ  <strong>ç§‘ç›®ç¼ºå¤±ï¼š</strong> è¡Œ ${rowNo} ${s.name || 'æœªçŸ¥å§“å'} æœªå¡«å†™ ${sub}`);
                    return;
                }
                if (isNaN(Number(val))) {
                    issues.push(`ğŸ”´ <strong>åˆ†æ•°éæ•°å€¼ï¼š</strong> è¡Œ ${rowNo} ${s.name || 'æœªçŸ¥å§“å'} (${sub} = ${val})`);
                    return;
                }
                if (Number(val) < 0) issues.push(`ğŸ”´ <strong>è´Ÿåˆ†å¼‚å¸¸ï¼š</strong> è¡Œ ${rowNo} ${s.name || 'æœªçŸ¥å§“å'} (${sub} = ${val})`);
                if (Number(val) > 150) warnings.push(`ğŸŸ  <strong>è¶…é«˜åˆ†é¢„è­¦ï¼š</strong> è¡Œ ${rowNo} ${s.name || 'æœªçŸ¥å§“å'} (${sub} = ${val}) - è¯·ç¡®è®¤æ˜¯å¦å½•å…¥é”™è¯¯ï¼Ÿ`);
            });
        });

        // 3. æ£€æŸ¥ç­çº§äººæ•°æå€¼ (è¿‡å¤§æˆ–è¿‡å°)
        Object.values(SCHOOLS).forEach(sch => {
            // ç®€å•ç»Ÿè®¡è¯¥æ ¡ç­çº§äººæ•°
            const clsCounts = {};
            sch.students.forEach(s => clsCounts[s.class] = (clsCounts[s.class] || 0) + 1);
            Object.entries(clsCounts).forEach(([cls, count]) => {
                if (count < 10) warnings.push(`ğŸŸ  <strong>ç­çº§äººæ•°è¿‡å°‘ï¼š</strong> ${sch.name} ${cls} ä»… ${count} äººã€‚`);
                if (count > 70) warnings.push(`ğŸŸ  <strong>ç­çº§äººæ•°è¿‡å¤šï¼š</strong> ${sch.name} ${cls} è¾¾ ${count} äººã€‚`);
            });
        });

        // 4. ç”ŸæˆæŠ¥å‘Š HTML
        let reportHtml = `<div style="text-align:left; max-height:400px; overflow-y:auto;">`;
        
        if (issues.length === 0 && warnings.length === 0) {
            reportHtml += `<div style="text-align:center; padding:20px; color:#16a34a;">
                <i class="ti ti-heart-rate-monitor" style="font-size:48px;"></i><br>
                <h3>æ•°æ®éå¸¸å¥åº·ï¼</h3>
                <p>å…±æ£€æµ‹ ${stats.total} æ¡æ•°æ®ï¼Œæœªå‘ç°æ˜æ˜¾å¼‚å¸¸ã€‚</p>
            </div>`;
        } else {
            reportHtml += `<p>å…±æ£€æµ‹ <strong>${stats.total}</strong> åå­¦ç”Ÿã€‚</p>`;
            if (stats.emptyFieldCount > 0) {
                reportHtml += `<p style="color:#b91c1c;">å…³é”®å­—æ®µç¼ºå¤±ï¼š<strong>${stats.emptyFieldCount}</strong> æ¡</p>`;
            }
            
            if (issues.length > 0) {
                reportHtml += `<h4 style="color:#dc2626; margin-top:10px;">âŒ å¿…é¡»å¤„ç†çš„é”™è¯¯ (${issues.length})</h4>`;
                reportHtml += `<ul style="color:#b91c1c; background:#fee2e2; padding:10px 20px; border-radius:6px;">`;
                issues.slice(0, 10).forEach(i => reportHtml += `<li>${i}</li>`);
                if(issues.length > 10) reportHtml += `<li>...ç­‰å…± ${issues.length} é¡¹</li>`;
                reportHtml += `</ul>`;
            }

            if (warnings.length > 0) {
                reportHtml += `<h4 style="color:#b45309; margin-top:10px;">âš ï¸ å€¼å¾—æ³¨æ„çš„é¢„è­¦ (${warnings.length})</h4>`;
                reportHtml += `<ul style="color:#92400e; background:#fffbeb; padding:10px 20px; border-radius:6px;">`;
                warnings.slice(0, 10).forEach(w => reportHtml += `<li>${w}</li>`);
                if(warnings.length > 10) reportHtml += `<li>...ç­‰å…± ${warnings.length} é¡¹</li>`;
                reportHtml += `</ul>`;
            }
        }
        reportHtml += `</div>`;

        Swal.fire({
            title: 'ğŸ¥ æ•°æ®ä½“æ£€æŠ¥å‘Š',
            html: reportHtml,
            icon: issues.length > 0 ? 'error' : (warnings.length > 0 ? 'warning' : 'success'),
            confirmButtonText: 'ç¡®å®š',
            width: 600
        });
    }

    window.addEventListener('load', () => {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ DOM å·²ç»å®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            const modalIds = [
                'issue-submit-modal',   // æˆç»©æ ¸æŸ¥ç”³è¯‰å¼¹çª—
                'admin-issue-modal',    // ç®¡ç†å‘˜ç”³è¯‰å¤„ç†å¼¹çª—
                'user-password-modal',  // ä¿®æ”¹å¯†ç å¼¹çª—
                'account-manager-modal' // è´¦å·ç®¡ç†å¼¹çª—
            ];

            modalIds.forEach(id => {
                const el = document.getElementById(id);
                // å¦‚æœå…ƒç´ å­˜åœ¨ï¼Œä¸”å®ƒä¸æ˜¯ body çš„ç›´æ¥å­å…ƒç´ ï¼Œå°±ç§»åŠ¨å®ƒ
                if (el && el.parentNode !== document.body) {
                    console.log(`ğŸ”§ [AutoFix] æ­£åœ¨ä¿®å¤å¼¹çª— DOM ä½ç½®: ${id}`);
                    document.body.appendChild(el); // ç§»åŠ¨åˆ° body æœ«å°¾
                }
            });
        }, 1000); // å»¶è¿Ÿ 1 ç§’æ‰§è¡Œ
    });

</script>

<script>
    // âœ‹ ğŸ”´ [å·²ç§»é™¤]ï¼šåˆ é™¤äº†æ•´ä¸ª MobApp å¯¹è±¡åŠå…¶æ‰€æœ‰é€»è¾‘ï¼Œç¡®ä¿æ‰‹æœºç«¯ä¸å†åŠ è½½æç®€ç‰ˆä»£ç  ğŸ”´
</script>
<button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
        style="position: fixed; bottom: 30px; left: 30px; width: 45px; height: 45px; 
               border-radius: 50%; background: rgba(30, 41, 59, 0.8); color: white; 
               border: none; cursor: pointer; display: none; z-index: 999; 
               box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;">
    <i class="ti ti-arrow-up" style="font-size: 20px;"></i>
</button>

<script>
    // ç›‘å¬æ»šåŠ¨ï¼Œè‡ªåŠ¨æ˜¾ç¤º/éšè—æŒ‰é’®
    window.addEventListener('scroll', () => {
        const btn = document.getElementById('back-to-top');
        if (window.scrollY > 300) {
            btn.style.display = 'block';
            btn.style.opacity = '1';
        } else {
            btn.style.display = 'none';
        }
    });
</script>
<!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
<div id="user-password-modal" class="modal" style="display: none; z-index: 70000;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3 style="color:var(--primary); margin:0;"><i class="ti ti-lock"></i> ä¿®æ”¹ä¸ªäººå¯†ç </h3>
            <button onclick="document.getElementById('user-password-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <div style="display:flex; flex-direction:column; gap:15px;">
            <div>
                <label style="font-size:12px; font-weight:bold; color:#666;">å½“å‰æ—§å¯†ç </label>
                <input type="password" id="upm-old" placeholder="è¾“å…¥å½“å‰å¯†ç " style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold; color:#666;">æ–°å¯†ç  (å»ºè®®å­—æ¯+æ•°å­—)</label>
                <input type="password" id="upm-new" placeholder="è¾“å…¥æ–°å¯†ç " style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold; color:#666;">ç¡®è®¤æ–°å¯†ç </label>
                <input type="password" id="upm-confirm" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
            </div>
            
            <button class="btn btn-primary" onclick="submitUserPasswordChange()" style="padding:12px; margin-top:10px;">
                ç¡®è®¤ä¿®æ”¹å¹¶åŒæ­¥
            </button>
        </div>
    </div>
</div>

<!-- 1. å®¶é•¿ç«¯ï¼šç”³è¯‰æäº¤å¼¹çª— -->
<div id="issue-submit-modal" class="modal" style="display: none; z-index: 75000;">
    <div class="modal-content" style="max-width: 500px;">
        <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
            <h3 style="color:#b45309; margin:0; font-size:18px;">ğŸ“ æˆç»©æ ¸æŸ¥ç”³è¯·</h3>
            <p style="font-size:12px; color:#666; margin-top:5px;">è¯·å¡«å†™å…·ä½“é—®é¢˜ï¼Œæ•™åŠ¡å¤„å°†åœ¨æ ¸å®åå¤„ç†ã€‚</p>
        </div>
        
        <div style="display:grid; gap:15px;">
            <!-- éšè—åŸŸï¼šè‡ªåŠ¨å¡«å……å­¦ç”Ÿä¿¡æ¯ -->
            <div style="background:#f9fafb; padding:10px; border-radius:6px; font-size:13px; color:#374151; display:flex; gap:10px;">
                <input type="text" id="issue-student-school" readonly style="flex:1; border:none; background:transparent; font-weight:bold;">
                <input type="text" id="issue-student-class" readonly style="width:60px; border:none; background:transparent; font-weight:bold;">
                <input type="text" id="issue-student-name" readonly style="width:80px; border:none; background:transparent; font-weight:bold;">
            </div>

            <div>
                <label style="font-size:12px; font-weight:bold; color:#374151;">é—®é¢˜ç±»å‹</label>
                <select id="issue-type" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;">
                    <option value="ç¼ºè€ƒ/é›¶åˆ†">âŒ æ˜¾ç¤ºç¼ºè€ƒ/é›¶åˆ† (å®é™…å·²è€ƒ)</option>
                    <option value="åˆ†æ•°é”™è¯¯">ğŸ“‰ åˆ†æ•°ä¸é¢„ä¼°ä¸¥é‡ä¸ç¬¦</option>
                    <option value="ä¿¡æ¯æœ‰è¯¯">ğŸ†” å§“å/è€ƒå·é”™è¯¯</option>
                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–é—®é¢˜</option>
                </select>
            </div>

            <div>
                <label style="font-size:12px; font-weight:bold; color:#374151;">å…·ä½“è¯´æ˜ (å¿…å¡«)</label>
                <textarea id="issue-desc" rows="4" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦è¯•å·å·²äº¤ï¼Œä½†ç³»ç»Ÿæ˜¾ç¤º0åˆ†ã€‚å¤§è‡´é¢„ä¼°åˆ†æ•°ä¸º90åˆ†å·¦å³ã€‚" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px; font-size:14px;"></textarea>
            </div>

            <div>
                <label style="font-size:12px; font-weight:bold; color:#374151;">è”ç³»ç”µè¯ (é€‰å¡«)</label>
                <input type="text" id="issue-contact" placeholder="æ–¹ä¾¿è€å¸ˆå›è®¿" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-gray" style="flex:1;" onclick="document.getElementById('issue-submit-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1; background:#b45309;" onclick="IssueManager.submit()">ğŸš€ æäº¤ç”³è¯·</button>
            </div>
        </div>
    </div>
</div>

<!-- 2. ç®¡ç†å‘˜ç«¯ï¼šæ¶ˆæ¯å¤„ç†ä¸­å¿ƒ -->
<div id="admin-issue-modal" class="modal" style="display: none; z-index: 76000;">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <!-- åŠ¨æ€æ ‡é¢˜ ID -->
                <h3 style="color:var(--primary); margin:0;" id="issue-modal-title"><i class="ti ti-bell"></i> ç”³è¯‰åé¦ˆä¸­å¿ƒ</h3>
                <button class="btn btn-sm btn-gray" onclick="IssueManager.loadIssues()"><i class="ti ti-refresh"></i> åˆ·æ–°</button>
            </div>
            <button onclick="document.getElementById('admin-issue-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- æ“ä½œå·¥å…·æ  (åŒ…å«æ­£å¸¸æ¨¡å¼å’Œå†å²æ¨¡å¼ä¸¤å¥—æŒ‰é’®) -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            
            <!-- A. æ­£å¸¸æ¨¡å¼çš„æ“ä½œæŒ‰é’® -->
            <div style="display:flex; gap:10px;" id="issue-normal-actions">
                <button class="btn btn-sm btn-danger" onclick="IssueManager.batchSoftDelete()">
                    <i class="ti ti-trash"></i> æ‰¹é‡åˆ é™¤ (æ”¾å…¥å›æ”¶ç«™)
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="issue-check-all" onchange="IssueManager.toggleSelectAll(this)" style="margin-right:5px;"> å…¨é€‰
                </div>
            </div>
            
            <!-- B. å†å²è®°å½•æ¨¡å¼çš„æ“ä½œæŒ‰é’® (é»˜è®¤éšè—) -->
            <div style="display:none; gap:10px;" id="issue-history-actions">
                <button class="btn btn-sm btn-danger" style="background:#b91c1c; border-color:#991b1b;" onclick="IssueManager.batchHardDelete()">
                    <i class="ti ti-trash-x"></i> å½»åº•ç²‰ç¢é€‰ä¸­
                </button>
                <button class="btn btn-sm btn-green" onclick="IssueManager.batchRestore()">
                    <i class="ti ti-rotate"></i> è¿˜åŸé€‰ä¸­
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="issue-history-check-all" onchange="IssueManager.toggleSelectAll(this)" style="margin-right:5px;"> å…¨é€‰
                </div>
            </div>

            <!-- C. åˆ‡æ¢è§†å›¾æŒ‰é’® -->
            <div>
                <button class="btn btn-sm btn-gray" id="btn-issue-history" onclick="IssueManager.toggleHistoryView()">
                    <i class="ti ti-history"></i> æŸ¥çœ‹åˆ é™¤å†å²
                </button>
            </div>
        </div>

        <!-- æç¤ºæ¡ -->
        <div id="issue-tip-bar" style="background:#fffbeb; color:#92400e; padding:10px; border-radius:6px; font-size:12px; margin-bottom:10px;">
            <i class="ti ti-info-circle"></i> æç¤ºï¼šå¤„ç†å®Œé—®é¢˜åï¼Œè¯·ç‚¹å‡»â€œæ ‡è®°å·²é˜…/è§£å†³â€ã€‚ç‚¹å‡»â€œæ‰¹é‡åˆ é™¤â€ä¼šå°†è®°å½•ç§»å…¥å†å²è®°å½•ã€‚
        </div>

        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div id="admin-issue-list" style="flex:1; overflow-y:auto; background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #e5e7eb;">
            <!-- JS åŠ¨æ€åŠ è½½å†…å®¹ -->
        </div>
    </div>
</div>

<!-- 3. ç®¡ç†å‘˜ç«¯ï¼šæ“ä½œæ—¥å¿—ç®¡ç†ä¸­å¿ƒ -->
<div id="admin-log-modal" class="modal" style="display: none; z-index: 77000;">
    <div class="modal-content" style="max-width: 900px; height: 85vh; display: flex; flex-direction: column;">
        <!-- æ ‡é¢˜æ  -->
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="color:#333; margin:0;" id="log-modal-title"><i class="ti ti-history"></i> ç³»ç»Ÿæ“ä½œæ—¥å¿—</h3>
                <button class="btn btn-sm btn-gray" onclick="Logger.loadLogs()"><i class="ti ti-refresh"></i> åˆ·æ–°</button>
            </div>
            <button onclick="document.getElementById('admin-log-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- æ“ä½œæ  -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <!-- æ­£å¸¸æ¨¡å¼æŒ‰é’® -->
            <div style="display:flex; gap:10px;" id="log-normal-actions">
                <button class="btn btn-sm btn-danger" onclick="Logger.batchSoftDelete()">
                    <i class="ti ti-trash"></i> æ‰¹é‡åˆ é™¤
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="log-check-all" onchange="Logger.toggleSelectAll(this)" style="margin-right:5px;"> å…¨é€‰
                </div>
            </div>
            
            <!-- å†å²æ¨¡å¼æŒ‰é’® -->
            <div style="display:none; gap:10px;" id="log-history-actions">
                <button class="btn btn-sm btn-danger" style="background:#b91c1c;" onclick="Logger.batchHardDelete()">
                    <i class="ti ti-trash-x"></i> å½»åº•ç²‰ç¢é€‰ä¸­
                </button>
                <button class="btn btn-sm btn-green" onclick="Logger.batchRestore()">
                    <i class="ti ti-rotate"></i> è¿˜åŸé€‰ä¸­
                </button>
                <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                    <input type="checkbox" id="log-history-check-all" onchange="Logger.toggleSelectAll(this)" style="margin-right:5px;"> å…¨é€‰
                </div>
            </div>

            <!-- è§†å›¾åˆ‡æ¢ -->
            <div>
                <button class="btn btn-sm btn-gray" id="btn-log-history" onclick="Logger.toggleHistoryView()">
                    <i class="ti ti-recycle"></i> æ—¥å¿—å›æ”¶ç«™
                </button>
            </div>
        </div>

        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div id="admin-log-list" style="flex:1; overflow-y:auto; background:#f9fafb; padding:0; border:1px solid #e5e7eb; border-radius:4px;">
            <!-- è¡¨æ ¼å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
        
        <!-- åº•éƒ¨ç®€å•åˆ†é¡µæˆ–ç»Ÿè®¡ -->
        <div style="padding-top:10px; font-size:12px; color:#999; text-align:right;">
            æ˜¾ç¤ºæœ€è¿‘ 100 æ¡è®°å½•
        </div>
    </div>
</div>

<!-- 4. é€šç”¨ï¼šè´¦å·æœç´¢ä¸å¯†ç ç®¡ç† (å¤šè§’è‰²æƒé™) -->
<div id="account-manager-modal" class="modal" style="display: none; z-index: 78000;">
    <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3 style="color:var(--primary); margin:0;"><i class="ti ti-user-search"></i> è´¦å·æœç´¢ä¸ç®¡ç†</h3>
            <button onclick="document.getElementById('account-manager-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <!-- æœç´¢åŒº -->
        <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="acc-search-input" placeholder="è¾“å…¥å§“åæˆ–è´¦å·è¿›è¡ŒæŸ¥æ‰¾..." 
                       style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:6px;"
                       onkeydown="if(event.key==='Enter') AccountManager.search()">
                <button class="btn btn-primary" onclick="AccountManager.search()">
                    <i class="ti ti-search"></i> æœç´¢
                </button>
            </div>
            <div id="acc-permission-hint" style="font-size:12px; color:#64748b; margin-top:8px;">
                <!-- JS ä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„æƒé™èŒƒå›´æç¤º -->
            </div>
        </div>

        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div class="table-wrap" style="flex:1; overflow-y:auto; box-shadow:none; border:1px solid #e2e8f0;">
            <table id="acc-result-table">
                <thead>
                    <tr>
                        <th>è´¦å·/å§“å</th>
                        <th>è§’è‰²</th>
                        <th>ç­çº§/èŒƒå›´</th>
                        <th>å½“å‰å¯†ç </th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">è¯·è¾“å…¥å…³é”®å­—æœç´¢</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 5. æ•°æ®ç»¼åˆç®¡ç†åå° (æˆç»©/æ•™å¸ˆ/æ¡£æ¡ˆ) -->
<div id="data-manager-modal" class="modal" style="display: none; z-index: 79000;">
    <div class="modal-content" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <!-- âœ‹ ğŸ”´ [æ—§ä»£ç ]ï¼šæ ‡é¢˜ -->
            <h3 style="color:#0f172a; margin:0;"><i class="ti ti-database-edit"></i> æ•™åŠ¡æ•°æ®ç»¼åˆç®¡ç†</h3>
            <!-- ğŸŸ¢ [æ–°ä»£ç ]ï¼šä¿®æ”¹æ ‡é¢˜ï¼Œä½“ç°äº‘ç«¯å±æ€§ -->
            <h3 style="color:#0f172a; margin:0;"><i class="ti ti-cloud-cog"></i> äº‘ç«¯æ•™åŠ¡æ•°æ®ç»¼åˆæ§åˆ¶å°</h3>
            <!-- âœ‹ ğŸŸ¢ [ä¿®æ”¹ç»“æŸ] -->

            <div style="display:flex; gap:10px;">
                <button class="btn btn-sm btn-purple" onclick="DataManager.saveAndSync()">
                    <i class="ti ti-cloud-upload"></i> ä¿å­˜ä¿®æ”¹å¹¶åŒæ­¥äº‘ç«¯
                </button>
                <button onclick="document.getElementById('data-manager-modal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
        </div>

        <!-- é¡¶éƒ¨ Tab åˆ‡æ¢ -->
        <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px; overflow-x:auto;">
            <div class="login-tab active" id="tab-data-stu" onclick="DataManager.switchTab('student')">
                <i class="ti ti-users"></i> å­¦ç”Ÿæˆç»©
            </div>
            <div class="login-tab" id="tab-data-tea" onclick="DataManager.switchTab('teacher')">
                <i class="ti ti-id"></i> æ•™å¸ˆä»»è¯¾
            </div>
                        
            <div class="login-tab" id="tab-data-params" onclick="DataManager.switchTab('params')">
                <i class="ti ti-settings"></i> å¹´çº§æŒ‡æ ‡å‚æ•°
            </div>
            <div class="login-tab" id="tab-data-targets" onclick="DataManager.switchTab('targets')">
                <i class="ti ti-target"></i> ç›®æ ‡äººæ•°ç®¡ç†
            </div>
                      
            <div class="login-tab" id="tab-data-sql" onclick="DataManager.switchTab('sql')">
                <i class="ti ti-terminal-2"></i> SQL æé€ŸæŸ¥è¯¢
            </div>
            <div class="login-tab" id="tab-data-cloud" onclick="DataManager.switchTab('cloud')">
                <i class="ti ti-cloud"></i> äº‘ç«¯å­˜æ¡£ç®¡ç†
            </div>
            <div class="login-tab" id="tab-data-history" onclick="DataManager.switchTab('history')">
                <i class="ti ti-history"></i> å†å²æ•°æ®å¯¹æ¯”
            </div>
        </div>

        <!-- æœç´¢å·¥å…·æ  (ä»…åœ¨å­¦ç”Ÿ/æ•™å¸ˆ Tab æ˜¾ç¤º) -->
        <div id="dm-search-bar" style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px; display:flex; gap:10px;">
            <input type="text" id="dm-search-input" placeholder="è¾“å…¥å§“å/ç­çº§/è€ƒå·ç­›é€‰..." 
                   style="flex:1; padding:8px; border:1px solid #cbd5e1; border-radius:4px;"
                   oninput="DataManager.renderCurrentTab()">
            <button class="btn btn-sm btn-primary" onclick="DataManager.renderCurrentTab()">æœç´¢</button>
        </div>

        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div class="table-wrap" style="flex:1; overflow-y:auto; box-shadow:none; border:1px solid #e2e8f0;">
            <!-- å­¦ç”Ÿè¡¨ -->
            <table id="dm-student-table" style="font-size:12px;">
                <thead>
                    <tr><th>å­¦æ ¡</th><th>ç­çº§</th><th>å§“å</th><th>è€ƒå·</th><th>æ€»åˆ†</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <!-- æ•™å¸ˆä»»è¯¾ç®¡ç†åŒºåŸŸ -->
            <div id="dm-teacher-area" style="display:none;">
                <!-- æ§åˆ¶æ ï¼šå­¦æ ¡ç­›é€‰ + å¯¼å…¥æŒ‰é’® -->
                <div style="background:#f8fafc; padding:10px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; position:sticky; top:0; z-index:10;">
                    
                    <!-- å·¦ä¾§ï¼šå­¦æ ¡ç­›é€‰ -->
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label style="font-weight:bold; color:#334155; font-size:12px;">ğŸ§­ å­¦æœŸï¼š</label>
                        <select id="dm-teacher-term-select" style="padding:5px; width:180px; font-size:12px; border:1px solid #cbd5e1; border-radius:4px;" onchange="DataManager.switchTeacherTerm(this.value)"></select>
                        <label style="font-weight:bold; color:#334155; font-size:12px;">ğŸ« ç­›é€‰å­¦æ ¡ï¼š</label>
                        <select id="dm-teacher-school-select" style="padding:5px; width:150px; font-size:12px; border:1px solid #cbd5e1; border-radius:4px;" onchange="DataManager.renderTeachers()">
                            <option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>
                        </select>
                    </div>

                    <!-- å³ä¾§ï¼šå¯¼å…¥ä¸æ“ä½œ -->
                    <div style="display:flex; gap:8px; align-items:center;">
                        <!-- ğŸŸ¢ æ–°å¢ï¼šä¸€é”®äº‘ç«¯åŒæ­¥æŒ‰é’® -->
                        <button class="btn btn-sm btn-purple" onclick="CloudManager.loadTeachers()" style="padding:4px 8px; font-size:12px;">
                            <i class="ti ti-cloud-download"></i> ä»äº‘ç«¯åŒæ­¥æœ¬å­¦æœŸæ•°æ®
                        </button>

                        <button class="btn btn-sm btn-green" onclick="document.getElementById('dm-teacher-file').click()" style="padding:4px 8px; font-size:12px;">
                            <i class="ti ti-file-import"></i> Excelå¯¼å…¥
                        </button>
                        <input type="file" id="dm-teacher-file" accept=".xlsx,.xls" hidden onchange="DataManager.handleTeacherUpload(this)">
                        
                        <button class="btn btn-sm btn-primary" onclick="DataManager.addTeacher()" style="padding:4px 8px; font-size:12px;">
                            <i class="ti ti-plus"></i> æ‰‹åŠ¨æ–°å¢
                        </button>
                        
                        <a href="javascript:void(0)" style="font-size:11px; color:#666; text-decoration:underline;" onclick="downloadTemplate('teacher')">ä¸‹è½½æ¨¡æ¿</a>
                    </div>
                </div>

                <!-- æ•™å¸ˆè¡¨æ ¼ -->
                <table id="dm-teacher-table" style="font-size:12px; border-top:1px solid #e2e8f0;">
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th style="width:25%">å­¦æ ¡</th>
                            <th style="width:15%">ç­çº§</th>
                            <th style="width:15%">å­¦ç§‘</th>
                            <th style="width:20%">æ•™å¸ˆå§“å</th>
                            <th style="width:25%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- æ¡£æ¡ˆç®¡ç†åŒºåŸŸ -->                        
            <!-- D. å¹´çº§æŒ‡æ ‡å‚æ•°è®¾ç½®åŒºåŸŸ (ä¿æŒä¸å˜ï¼Œä»…ä¸ºäº†å®šä½) -->
            <div id="dm-params-area" style="display:none; padding:20px;">
                <div style="background:#f0f9ff; border:1px solid #bae6fd; padding:20px; border-radius:8px;">
                    <h4 style="color:#0369a1; margin-bottom:15px; border-bottom:1px dashed #bae6fd; padding-bottom:10px;">
                        <i class="ti ti-settings"></i> å¹´çº§åˆ’çº¿å‚æ•°é…ç½®
                    </h4>
                    <div id="dm-params-tip" style="display:none; background:#fff7ed; border:1px dashed #fdba74; color:#9a3412; padding:8px 10px; border-radius:6px; font-size:12px; margin-bottom:12px;">
                        æç¤ºï¼šå½“å‰é 9 å¹´çº§æœŸä¸­/æœŸæœ«ï¼Œå‚æ•°ä»…ç”¨äºé¢„è®¾ï¼Œä¸å‚ä¸è®¡ç®—ã€‚
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">æŒ‡æ ‡ä¸€ (ä¼˜ç”Ÿçº¿) åˆ’çº¿åæ¬¡ï¼š</label>
                            <input type="number" id="dm_ind1_input" class="mob-input" style="background:white;" placeholder="ä¾‹å¦‚: 500">
                            <p style="font-size:12px; color:#64748b; margin-top:5px;">å…¨é•‡æ€»åˆ†æ’åç¬¬ N åçš„åˆ†æ•°å°†ä½œä¸ºä¼˜ç”Ÿçº¿ã€‚</p>
                        </div>
                        <div>
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">æŒ‡æ ‡äºŒ (æ™®é«˜çº¿) åˆ’çº¿åæ¬¡ï¼š</label>
                            <input type="number" id="dm_ind2_input" class="mob-input" style="background:white;" placeholder="ä¾‹å¦‚: 1200">
                            <p style="font-size:12px; color:#64748b; margin-top:5px;">å…¨é•‡æ€»åˆ†æ’åç¬¬ N åçš„åˆ†æ•°å°†ä½œä¸ºåŠæ ¼/æ™®é«˜çº¿ã€‚</p>
                        </div>
                    </div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn btn-primary" onclick="DataManager.saveParamsLocally()">
                            <i class="ti ti-device-floppy"></i> æš‚å­˜å‚æ•° (éœ€ç‚¹å‡»å³ä¸Šè§’ä¿å­˜åŒæ­¥)
                        </button>
                    </div>
                </div>
            </div>

            <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ âœ‹ ğŸ”´ [ä¿®æ”¹å¼€å§‹]ï¼šä¿®æ”¹ç›®æ ‡ç®¡ç†åŒºåŸŸï¼Œæ”¹ä¸ºæ–‡ä»¶å¯¼å…¥æ¨¡å¼ ğŸ”´ âœ‹ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
            <!-- E. ç›®æ ‡äººæ•°ç®¡ç†åŒºåŸŸ -->
            <div id="dm-targets-area" style="display:none; padding:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; color:#166534;"><i class="ti ti-target"></i> å„æ ¡ç›®æ ‡äººæ•°ç®¡ç†</h4>
                    
                    <!-- ğŸŸ¢ [æ–°ä»£ç ]ï¼šæ”¹ä¸ºå¯¼å…¥æŒ‰é’® + éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                    <div>
                        <button class="btn btn-sm btn-green" onclick="document.getElementById('dm-target-file').click()">
                            <i class="ti ti-file-import"></i> å¯¼å…¥ç›®æ ‡äººæ•°æ–‡ä»¶ (.xlsx)
                        </button>
                        <input type="file" id="dm-target-file" accept=".xlsx,.xls" hidden onchange="DataManager.handleTargetUpload(this)">
                        
                        <a href="javascript:void(0)" style="font-size:12px; margin-left:10px; color:#666; text-decoration:underline;" onclick="alert('Excelæ ¼å¼è¦æ±‚ï¼š\nç¬¬ä¸€åˆ—ï¼šå­¦æ ¡åç§°\nç¬¬äºŒåˆ—ï¼šæŒ‡æ ‡ä¸€ç›®æ ‡äººæ•°\nç¬¬ä¸‰åˆ—ï¼šæŒ‡æ ‡äºŒç›®æ ‡äººæ•°')">æ ¼å¼è¯´æ˜</a>
                    </div>
                    <!-- ğŸ‘† ğŸŸ¢ [ä¿®æ”¹ç»“æŸ] -->
                </div>
                
                <div class="info-bar" style="margin-bottom:10px;">
                    ğŸ’¡ æç¤ºï¼šå¯¼å…¥åè¯·ç‚¹å‡»å³ä¸Šè§’ã€ä¿å­˜ä¿®æ”¹å¹¶åŒæ­¥äº‘ç«¯ã€‘æŒ‰é’®ï¼Œä»¥é˜²æ­¢åˆ·æ–°åä¸¢å¤±ã€‚
                </div>

                <div class="table-wrap" style="box-shadow:none; border:1px solid #e2e8f0; max-height: 60vh; overflow-y: auto;">
                    <table class="comparison-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>å­¦æ ¡åç§°</th>
                                <th style="background:#e0f2fe;">æŒ‡æ ‡ä¸€ç›®æ ‡ (äºº)</th>
                                <th style="background:#fff7ed;">æŒ‡æ ‡äºŒç›®æ ‡ (äºº)</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="dm-targets-tbody">
                            <!-- JS åŠ¨æ€æ¸²æŸ“ -->
                        </tbody>
                    </table>
                </div>
            </div>
        
        <div id="dm-sql-area" style="display:none; padding:15px; height:100%; flex-direction:column;">
            <!-- æç¤ºä¸å¸¸ç”¨è¯­å¥ -->
            <div style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('base')">ğŸ“‹ æŸ¥å‰10å</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('count')">ğŸ“Š å„æ ¡äººæ•°</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('avg')">ğŸ“ˆ å„ç­å‡åˆ†</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('failed')">ğŸ“‰ ä¸åŠæ ¼åå•</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('teacher')">ğŸ‘©â€ğŸ« æŸ¥ä»»è¯¾å­¦ç”Ÿ</button>
                <div style="flex:1; text-align:right; font-size:12px; color:#666; align-self:center;">
                    è¡¨å: <b>students</b> (æˆç»©), <b>teachers</b> (ä»»è¯¾)
                </div>
            </div>

            <!-- å†å²ä¸æ”¶è— -->
            <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <select id="dm-sql-history-select" style="min-width:220px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;" onchange="DataManager.applySQLHistory(this.value)">
                    <option value="">ğŸ•˜ æœ€è¿‘/æ”¶è—</option>
                </select>
                <input id="dm-sql-history-name" type="text" placeholder="æ”¶è—åç§°(å¯é€‰)" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px; width:180px;">
                <button class="btn btn-sm btn-green" onclick="DataManager.saveNamedSQL()">â­ ä¿å­˜æ”¶è—</button>
                <button class="btn btn-sm btn-gray" onclick="DataManager.clearSQLHistory()">ğŸ§¹ æ¸…ç©ºå†å²</button>
            </div>

            <!-- Talk to Data è‡ªç„¶è¯­è¨€æŸ¥æ•° -->
            <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; padding:8px;">
                <input id="dm-nlq-input" type="text" placeholder="ä¾‹å¦‚ï¼šæ‰¾å‡º701ç­ç‰©ç†ä¸åŠæ ¼ä½†æ•°å­¦å‰10åçš„å­¦ç”Ÿ" style="flex:1; min-width:280px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;">
                <button class="btn btn-sm btn-purple" onclick="talkToData()">ğŸ’¬ è‡ªç„¶è¯­è¨€æŸ¥æ•°</button>
                <span id="dm-nlq-status" style="font-size:12px; color:#64748b;"></span>
            </div>

            <!-- SQL è¾“å…¥æ¡† -->
            <textarea id="dm-sql-input" style="width:100%; height:120px; background:#1e293b; color:#a5b4fc; font-family:'Consolas', monospace; padding:10px; border-radius:6px; font-size:14px; border:1px solid #475569; resize:none;" placeholder="åœ¨æ­¤è¾“å…¥ SQL è¯­å¥..."></textarea>
            
            <!-- æ“ä½œæ  -->
            <div style="margin:10px 0; display:flex; justify-content:space-between;">
                <div id="sql-status-msg" style="font-size:12px; color:#ef4444; font-weight:bold;"></div>
                <div>
                    <button class="btn btn-sm btn-green" onclick="DataManager.exportSQLResult()">ğŸ“¥ å¯¼å‡ºç»“æœ Excel</button>
                    <button class="btn btn-primary" onclick="DataManager.runSQL()"><i class="ti ti-player-play"></i> æ‰§è¡ŒæŸ¥è¯¢ (Run)</button>
                </div>
            </div>

            <!-- ç»“æœè¡¨æ ¼å®¹å™¨ -->
            <div class="table-wrap" style="flex:1; overflow:auto; border:1px solid #e2e8f0; border-radius:4px; box-shadow:none;">
                <table id="dm-sql-table" style="font-size:12px; width:100%;">
                    <thead><tr><th>æŸ¥è¯¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="dm-cloud-area" style="display:none; padding:15px; flex-direction:column; height:100%;">
            <div class="info-bar">
                <i class="ti ti-cloud"></i> <strong>æˆ‘çš„äº‘ç«¯æ•°æ®ç®¡ç†ï¼š</strong> 
                æ­¤å¤„åˆ—å‡ºæ‚¨ä¸Šä¼ åˆ°äº‘ç«¯çš„æ‰€æœ‰å¤‡ä»½ï¼ˆåŒ…æ‹¬è‡ªåŠ¨ä¿å­˜å’Œæ‰‹åŠ¨å¤‡ä»½ï¼‰ã€‚æ‚¨å¯ä»¥åˆ é™¤æ—§çš„å­˜æ¡£ä»¥é‡Šæ”¾ç©ºé—´ã€‚
                <br><span style="color:red; font-size:11px;">* æ³¨æ„ï¼šåˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚</span>
            </div>
            <div id="dm-cloud-summary" style="background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; padding:10px; font-size:12px; color:#475569; margin:10px 0;">
                ğŸ“Œ äº‘ç«¯æ‘˜è¦å°†åœ¨æ­¤æ˜¾ç¤º
            </div>
            <div style="display:flex; gap:12px; align-items:center; font-size:12px; color:#475569; margin-bottom:8px;">
                <label><input type="checkbox" id="cloud-filter-current" checked onchange="DataManager.renderCloudBackups()"> ä»…å½“å‰é¡¹ç›®</label>
                <label><input type="checkbox" id="cloud-filter-snapshots" checked onchange="DataManager.renderCloudBackups()"> æ˜¾ç¤ºå¿«ç…§</label>
            </div>
            <div class="table-wrap" style="flex:1; overflow-y:auto;">
                <table class="comparison-table" id="dm-cloud-table">
                    <thead>
                        <tr>
                            <th>å­˜æ¡£ Key (é¡¹ç›®å)</th>
                            <th>ä¸Šä¼ æ—¶é—´</th>
                            <th>æ•°æ®å¤§å°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="dm-history-area" style="display:none; padding:15px; flex-direction:column; height:100%;">
            <div style="background:#f0fdf4; border:1px solid #86efac; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px 0; color:#166534;"><i class="ti ti-file-import"></i> ä¸Šä¼ å†å²è€ƒè¯•æ•°æ® (ç”¨äºè¿›é€€æ­¥åˆ†æ)</h4>
                <div style="font-size:12px; color:#15803d; line-height:1.6; margin-bottom:10px;">
                    <strong>ğŸ“‚ æ™ºèƒ½è§£æè§„åˆ™ï¼š</strong><br>
                    1. <strong>å¤šæ ¡è¯†åˆ«ï¼š</strong> ç³»ç»Ÿå°†è¯»å– Excel çš„ <span style="background:white; padding:0 4px; border:1px dashed #ccc;">Sheetåç§°</span> ä½œä¸ºå­¦æ ¡åç§°ã€‚<br>
                    2. <strong>åŒ¹é…é”®å€¼ï¼š</strong> å¯¹æ¯”åˆ†æå°†ä¸¥æ ¼åŸºäº <span style="background:white; padding:0 4px; border:1px dashed #ccc;">[ç­çº§] + [å§“å]</span> è¿›è¡Œé”šå®šã€‚<br>
                    3. <strong>åŒ¿åå¤„ç†ï¼š</strong> è‹¥è¡¨æ ¼ä¸­ç¼ºå°‘å§“ååˆ—ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ‡è®°ä¸ºâ€œæ— åæ°_åºå·â€ï¼Œä»…ä½œæ ¡å†…äººæ•°ç»Ÿè®¡ï¼Œä¸å‚ä¸ä¸ªäººè¿›é€€æ­¥ã€‚<br>
                    4. <strong>å•æ ¡æ¨¡å¼ï¼š</strong> è‹¥ä»…æ£€æµ‹åˆ°ä¸€ä¸ªå­¦æ ¡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨éšè—â€œå…¨é•‡æ’åâ€åˆ—ï¼Œè½¬ä¸ºæ ¡å†…æ·±åº¦å¯¹æ¯”ã€‚
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="document.getElementById('dm-history-file').click()">
                        <i class="ti ti-upload"></i> ç‚¹å‡»ä¸Šä¼ å†å² Excel
                    </button>
                    <input type="file" id="dm-history-file" accept=".xlsx,.xls" hidden onchange="DataManager.handleHistoryUpload(this)">
                    <span id="dm-history-status" style="align-self:center; font-size:12px; color:#666;">æš‚æœªä¸Šä¼ </span>
                </div>
            </div>

            <div class="sub-header">ğŸ“Š å†å²å¯¹æ¯”æ•°æ®é¢„è§ˆ</div>
            <div class="table-wrap" style="flex:1; overflow-y:auto;">
                <table id="dm-history-preview-table" style="font-size:12px;">
                    <thead>
                        <tr>
                            <th>å­¦æ ¡ (Sheetå)</th>
                            <th>ç­çº§</th>
                            <th>å§“å</th>
                            <th>ä¸Šæ¬¡æ€»åˆ†</th>
                            <th>ä¸Šæ¬¡æ ¡æ’</th>
                            <th>ä¸Šæ¬¡é•‡æ’</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">è¯·ä¸Šä¼ æ–‡ä»¶é¢„è§ˆæ•°æ®</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
     
        <!-- åˆ†é¡µæ§ä»¶ (ä»…åœ¨å­¦ç”Ÿ/æ•™å¸ˆ Tab æ˜¾ç¤º) -->
        <div id="dm-pagination" style="padding-top:10px; text-align:right; font-size:12px; color:#666; display:flex; justify-content:flex-end; gap:10px; align-items:center;">
            <button class="btn btn-sm btn-gray" onclick="DataManager.changePage(-1)">ä¸Šä¸€é¡µ</button>
            <span id="dm-page-info">1 / 1</span>
            <button class="btn btn-sm btn-gray" onclick="DataManager.changePage(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>
</div>

<!-- ================== æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–å·¥å…· ================== -->
<script>
    // å…¨å±€æ€§èƒ½ç›‘æ§å·¥å…·
    window.PerformanceMonitor = {
        // è·å–é¡µé¢æ€§èƒ½æ•°æ®
        getMetrics: function() {
            if (!window.performance || !performance.timing) {
                return { error: "æµè§ˆå™¨ä¸æ”¯æŒæ€§èƒ½API" };
            }
            
            const t = performance.timing;
            const metrics = {
                DNSè§£æ: t.domainLookupEnd - t.domainLookupStart,
                TCPè¿æ¥: t.connectEnd - t.connectStart,
                è¯·æ±‚å“åº”: t.responseEnd - t.requestStart,
                DOMè§£æ: t.domComplete - t.domLoading,
                é¡µé¢å®Œå…¨åŠ è½½: t.loadEventEnd - t.navigationStart,
                ç™½å±æ—¶é—´: t.responseStart - t.navigationStart,
                é¦–å±æ—¶é—´: t.domContentLoadedEventEnd - t.navigationStart
            };
            
            return metrics;
        },
        
        // æ‰“å°æ€§èƒ½æŠ¥å‘Š
        report: function() {
            const metrics = this.getMetrics();
            console.group('ğŸ“Š ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š');
            for (let key in metrics) {
                if (typeof metrics[key] === 'number') {
                    console.log(`${key}: ${metrics[key]}ms`);
                }
            }
            console.groupEnd();
            
            // æ£€æŸ¥å†…å­˜ä½¿ç”¨(ä»…Chrome)
            if (performance.memory) {
                const memory = performance.memory;
                console.log(`ğŸ’¾ å†…å­˜ä½¿ç”¨: ${(memory.usedJSHeapSize / 1048576).toFixed(2)}MB / ${(memory.jsHeapSizeLimit / 1048576).toFixed(2)}MB`);
            }
            
            return metrics;
        },
        
        // ä¼˜åŒ–å»ºè®®
        getSuggestions: function() {
            const metrics = this.getMetrics();
            const suggestions = [];
            
            if (metrics['é¡µé¢å®Œå…¨åŠ è½½'] > 5000) {
                suggestions.push('âš ï¸ é¡µé¢åŠ è½½æ—¶é—´è¶…è¿‡5ç§’ï¼Œå»ºè®®ä¼˜åŒ–ç½‘ç»œæˆ–å‡å°‘å¤–éƒ¨èµ„æº');
            }
            if (metrics['DOMè§£æ'] > 2000) {
                suggestions.push('âš ï¸ DOMè§£æè¾ƒæ…¢ï¼Œè€ƒè™‘å‡å°‘DOMèŠ‚ç‚¹æˆ–å»¶è¿ŸåŠ è½½éå…³é”®å†…å®¹');
            }
            if (performance.memory && performance.memory.usedJSHeapSize > 100 * 1048576) {
                suggestions.push('âš ï¸ å†…å­˜å ç”¨è¾ƒé«˜(>100MB)ï¼Œå»ºè®®å®šæœŸåˆ·æ–°é¡µé¢');
            }
            
            if (suggestions.length === 0) {
                suggestions.push('âœ… ç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œæ— éœ€ä¼˜åŒ–');
            }
            
            return suggestions;
        }
    };
    
    // å†…å­˜æ¸…ç†å·¥å…·
    window.MemoryCleaner = {
        clean: function() {
            console.log('ğŸ§¹ å¼€å§‹æ¸…ç†å†…å­˜...');
            
            // æ¸…ç†å¤§å‹å›¾è¡¨å®ä¾‹
            if (window.Chart && Chart.instances) {
                Object.values(Chart.instances).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                console.log('âœ… å·²æ¸…ç†å›¾è¡¨å®ä¾‹');
            }
            
            console.log('ğŸ’¡ å»ºè®®: åˆ·æ–°é¡µé¢ä»¥å®Œå…¨é‡Šæ”¾å†…å­˜');
            
            if (confirm('æ˜¯å¦åˆ·æ–°é¡µé¢ä»¥å®Œå…¨æ¸…ç†å†…å­˜?')) {
                location.reload();
            }
        }
    };
    
    // å¼€å‘æ¨¡å¼è‡ªåŠ¨æ€§èƒ½æ£€æµ‹
    if (localStorage.getItem('DEV_MODE') === 'true') {
        window.addEventListener('load', () => {
            setTimeout(() => {
                PerformanceMonitor.report();
                PerformanceMonitor.getSuggestions().forEach(s => console.log(s));
            }, 1000);
        });
    }
</script>

</body>
</html>
